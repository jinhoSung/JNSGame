<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ÌÜµÌï© ÎßàÏä§ÌÑ∞ (Ïò§Î™© Î£∞ ÌçºÌéôÌä∏)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Gowun+Batang:wght@700&display=swap');

        /* Í∏∞Î≥∏ Î≥ÄÏàò (Î¶¨Ïñº Ïö∞Îìú Ïò§ÌÅ¨) */
        :root {
            --bg: #2d241b; --panel: #3e3226; --text: #e8dcc5; --accent: #e6b8a2; --border: #5c4b3a;
            --font-main: 'Gowun Batang', serif;
        }

        /* --- ÌÖåÎßàÎ≥Ñ Ïò§Î≤ÑÎùºÏù¥Îìú --- */
        body.theme-oak { --bg: #2d241b; --panel: #3e3226; --text: #e8dcc5; --accent: #e6b8a2; }
        body.theme-walnut { --bg: #1a120b; --panel: #2c1e16; --text: #d7ccc8; --accent: #a98467; }
        body.theme-chamjuk { --bg: #2b1b17; --panel: #3e2723; --text: #ffccbc; --accent: #ffab91; }
        body.theme-ebony { --bg: #0f0f0f; --panel: #1a1a1a; --text: #ccc; --accent: #9e9e9e; }
        
        body.theme-modern { --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0; --accent: #3b82f6; --font-main: 'Noto Sans KR', sans-serif; }
        body.theme-minimal { --bg: #f5f5f5; --panel: #ffffff; --text: #333; --accent: #333; --font-main: 'Noto Sans KR', sans-serif; }
        body.theme-classic { --bg: #fdf6e3; --panel: #eee8d5; --text: #657b83; --accent: #b58900; }
        body.theme-forest { --bg: #1b2e1b; --panel: #243b24; --text: #d4eac8; --accent: #8bc34a; --font-main: 'Noto Sans KR', sans-serif; }
        body.theme-ocean { --bg: #0d1b2a; --panel: #1b263b; --text: #e0e1dd; --accent: #00b4d8; --font-main: 'Noto Sans KR', sans-serif; }
        body.theme-mono { --bg: #111; --panel: #222; --text: #ccc; --accent: #fff; --font-main: 'Noto Sans KR', sans-serif; }
        body.theme-retro { --bg: #2b2b2b; --panel: #3c3f41; --text: #a9b7c6; --accent: #cc7832; --font-main: 'Courier New', monospace; }

        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; }

        header { height: 50px; background: var(--panel); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 20; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .logo { font-weight: 900; font-size: 18px; color: var(--accent); display: flex; align-items: center; gap: 6px; }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        
        .status-badge { font-size: 13px; font-weight: bold; padding: 4px 12px; border-radius: 20px; background: rgba(0,0,0,0.3); color: var(--text); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 5px; }
        .status-badge.active { background: var(--accent); color: #000; font-weight: 800; border-color: transparent; box-shadow: 0 0 10px var(--accent); }

        .vol-wrapper { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .vol-icon { font-size: 14px; cursor: pointer; }
        input[type=range] { -webkit-appearance: none; width: 60px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--accent); cursor: pointer; }

        .icon-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: var(--text); font-family: var(--font-main); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
        .icon-btn:hover:not(:disabled) { background: rgba(255,255,255,0.1); border-color: var(--accent); color: var(--accent); }
        .icon-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .new-game-btn { border-color: #22c55e; color: #22c55e; }
        .new-game-btn:hover { background: rgba(34, 197, 94, 0.1); border-color: #4ade80; color: #4ade80; }
        .exit-btn:hover { border-color: #ef4444; color: #ef4444; }

        .layout { flex: 1; display: flex; position: relative; }
        aside { width: 260px; background: var(--panel); border-right: 1px solid rgba(255,255,255,0.05); padding: 20px; display: flex; flex-direction: column; gap: 16px; z-index: 10; transition: 0.3s; }
        .card { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .card.active { border-color: var(--accent); background: rgba(255,255,255,0.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .p-label { font-size: 14px; font-weight: bold; opacity: 0.8; }
        .p-score { font-size: 24px; font-weight: 800; color: var(--accent); }
        .caps-area { display: flex; flex-wrap: wrap; gap: 4px; min-height: 24px; }
        .cap-item { width: 24px; height: 24px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #e6d0a7, #bfa075); border: 1px solid rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; box-shadow: 1px 1px 2px rgba(0,0,0,0.4); color: #333; }

        .board-container { flex: 1; background: #111; display: flex; align-items: center; justify-content: center; position: relative; padding: 10px; }
        canvas { box-shadow: 0 30px 60px rgba(0,0,0,0.7), 0 10px 20px rgba(0,0,0,0.5); border-radius: 4px; cursor: pointer; max-width: 100%; max-height: 100%; transition: opacity 0.3s; }

        .overlay { position: absolute; inset: 0; background: rgba(10, 10, 12, 0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; padding: 20px; overflow-y: auto; backdrop-filter: blur(10px); }
        .overlay.hidden { opacity: 0; pointer-events: none; }
        .menu-title { font-size: 32px; font-weight: 900; color: var(--accent); margin-bottom: 30px; text-align: center; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .section { margin-bottom: 24px; width: 100%; max-width: 500px; }
        .section-title { font-size: 14px; font-weight: bold; margin-bottom: 10px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .grid-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .opt-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text); padding: 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.2s; font-family: var(--font-main); }
        .opt-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        .opt-btn.selected { background: var(--accent); color: #1a1510; border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }
        
        .big-btn-row { display: flex; gap: 15px; width: 100%; max-width: 600px; margin-top: 20px; }
        .big-btn { flex: 1; padding: 25px; background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: var(--text); font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .big-btn:hover { border-color: var(--accent); transform: translateY(-3px); }
        .big-btn span { font-size: 12px; opacity: 0.6; font-weight: normal; }
        .wood-btn { position: relative; overflow: hidden; }
        .wood-btn::before { content:''; position: absolute; inset: 0; background-size: cover; opacity: 0.3; z-index: 0; }
        .wood-btn span { position: relative; z-index: 1; }
        .toast { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: var(--accent); color: #000; padding: 12px 24px; border-radius: 50px; font-size: 18px; font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .spinner { width: 12px; height: 12px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .layout { flex-direction: column; }
            aside { width: 100%; height: auto; flex-direction: row; padding: 10px; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); }
            .card { flex: 1; padding: 10px; border-radius: 8px; }
            .p-score { font-size: 18px; }
            .grid-options { grid-template-columns: repeat(3, 1fr); }
            .vol-wrapper { display: none; }
        }
    </style>
</head>
<body class="theme-oak">

<header>
    <div class="logo"><span>üèØ</span> REAL JANGGI</div>
    <div id="turn-badge" class="status-badge">ÎåÄÍ∏∞ Ï§ë</div>
    <div class="header-controls">
        <button id="undo-btn" class="icon-btn undo-btn" onclick="undoGame()" title="Î¨¥Î•¥Í∏∞ (ÏµúÎåÄ 3Ìöå)">
            ‚Ü©Ô∏è Î¨¥Î•¥Í∏∞ (<span id="undo-cnt">3</span>)
        </button>
        <button class="icon-btn new-game-btn" onclick="restartGame()" title="ÌòÑÏû¨ ÏÑ§Ï†ïÏúºÎ°ú Îã§Ïãú ÏãúÏûë">
            üîÑ ÏÉà Í≤åÏûÑ
        </button>
        <div class="vol-wrapper">
            <span class="vol-icon" onclick="toggleMute()">üîä</span>
            <input type="range" id="vol-slider" min="0" max="100" value="70" oninput="AudioSys.setVol(this.value)">
        </div>
        <button class="icon-btn exit-btn" onclick="goHome()">ÎÇòÍ∞ÄÍ∏∞</button>
    </div>
</header>

<div id="main-menu" class="overlay">
    <div class="menu-title">Í≤åÏûÑ ÏÑ§Ï†ï</div>
    <div class="section">
        <div class="section-title">üå≤ ÎÇòÎ¨¥ Ïû¨Ïßà</div>
        <div class="grid-options" style="grid-template-columns: repeat(4, 1fr);">
            <button class="opt-btn wood-btn" onclick="setTheme('oak', this)" style="background:#8b6b4e; color:#fff;">Ïò§ÌÅ¨</button>
            <button class="opt-btn wood-btn" onclick="setTheme('walnut', this)" style="background:#5d4037; color:#fff;">ÏõîÎÑõ</button>
            <button class="opt-btn wood-btn" onclick="setTheme('chamjuk', this)" style="background:#8d4d42; color:#fff;">Ï∞∏Ï£Ω</button>
            <button class="opt-btn wood-btn" onclick="setTheme('ebony', this)" style="background:#212121; color:#fff;">ÌùëÎã®</button>
        </div>
    </div>
    <div class="section">
        <div class="section-title">üé® Í∑∏ÎûòÌîΩ ÌÖåÎßà</div>
        <div class="grid-options" style="grid-template-columns: repeat(4, 1fr);">
            <button class="opt-btn" onclick="setTheme('modern', this)">Î™®Îçò</button>
            <button class="opt-btn" onclick="setTheme('minimal', this)">ÎØ∏ÎãàÎ©Ä</button>
            <button class="opt-btn" onclick="setTheme('classic', this)">ÌÅ¥ÎûòÏãù</button>
            <button class="opt-btn" onclick="setTheme('forest', this)">Ìè¨Î†àÏä§Ìä∏</button>
            <button class="opt-btn" onclick="setTheme('ocean', this)">Ïò§ÏÖò</button>
            <button class="opt-btn" onclick="setTheme('mono', this)">Î™®ÎÖ∏</button>
            <button class="opt-btn" onclick="setTheme('retro', this)">Î†àÌä∏Î°ú</button>
        </div>
    </div>
    <div class="section">
        <div class="section-title">üî• ÎÇúÏù¥ÎèÑ</div>
        <div class="grid-options" style="grid-template-columns: repeat(5, 1fr);">
            <button class="opt-btn" data-v="easy" onclick="setDiff('easy', this)">ÌïòÏàò</button>
            <button class="opt-btn" data-v="normal" onclick="setDiff('normal', this)">Ï§ëÏàò</button>
            <button class="opt-btn" data-v="hard" onclick="setDiff('hard', this)">Í≥†Ïàò</button>
            <button class="opt-btn" data-v="veryhard" onclick="setDiff('veryhard', this)">Ï¥àÍ≥†Ïàò</button>
            <button class="opt-btn selected" data-v="god" onclick="setDiff('god', this)">Ïã†ÏùòÌïúÏàò</button>
        </div>
    </div>
    <div class="big-btn-row">
        <button class="big-btn" onclick="openJanggiSetup()">Ïû•Í∏∞ <span>Korean Chess</span></button>
        <button class="big-btn" onclick="startGame('baduk')">Î∞îÎëë <span>Baduk / Go</span></button>
        <button class="big-btn" onclick="startGame('omok')" style="background: linear-gradient(145deg, #166534, #14532d);">Ïò§Î™© <span>Omok (5-in-row)</span></button>
    </div>
</div>

<div id="janggi-setup" class="overlay hidden">
    <div class="menu-title">ÏÉÅÏ∞®Î¶º ÏÑ†ÌÉù (ÎÇò: Ï¥à)</div>
    <div class="section">
        <div class="grid-options" style="grid-template-columns: 1fr 1fr;">
            <button class="big-btn" style="height:100px; font-size:16px;" onclick="startJanggi('gwima')">Í∑ÄÎßà (ÌëúÏ§Ä)<span>Ïôº:ÎßàÏÉÅ / Ïò§:ÏÉÅÎßà</span></button>
            <button class="big-btn" style="height:100px; font-size:16px;" onclick="startJanggi('wonang')">ÏõêÏïôÎßà<span>Ïôº:ÏÉÅÎßà / Ïò§:ÎßàÏÉÅ</span></button>
            <button class="big-btn" style="height:100px; font-size:16px;" onclick="startJanggi('yanggwima')">ÏñëÍ∑ÄÎßà<span>Ïôº:ÎßàÏÉÅ / Ïò§:ÎßàÏÉÅ</span></button>
            <button class="big-btn" style="height:100px; font-size:16px;" onclick="startJanggi('yanggwisang')">ÏñëÍ∑ÄÏÉÅ<span>Ïôº:ÏÉÅÎßà / Ïò§:ÏÉÅÎßà</span></button>
        </div>
    </div>
    <button class="opt-btn" style="width:100px; margin-top:20px;" onclick="goHome()">Ï∑®ÏÜå</button>
</div>

<div class="layout">
    <aside>
        <div id="card-ai" class="card">
            <div class="card-header"><span class="p-label">AI (Computer)</span><span id="score-ai" class="p-score">0</span></div>
            <div id="caps-ai" class="caps-area"></div>
        </div>
        <div id="card-user" class="card">
            <div class="card-header"><span class="p-label">Player (You)</span><span id="score-user" class="p-score">0</span></div>
            <div id="caps-user" class="caps-area"></div>
        </div>
    </aside>
    <div class="board-container" id="board-wrap">
        <canvas id="gameCanvas"></canvas>
        <div id="toast" class="toast">Î©îÏãúÏßÄ</div>
    </div>
</div>

<script>
    const THEMES={oak:{bgType:'wood',base:'#deb887',grain:'rgba(139,69,19,0.15)',line:'#3e2723',janggi:{choC:'#1d4ed8',hanC:'#b91c1c',style:'real'},baduk:{style:'real'}},walnut:{bgType:'wood',base:'#6d4c41',grain:'rgba(0,0,0,0.3)',line:'#d7ccc8',janggi:{choC:'#4fc3f7',hanC:'#ff8a80',style:'real'},baduk:{style:'real'}},chamjuk:{bgType:'wood',base:'#8d6e63',grain:'rgba(62,39,35,0.2)',line:'#3e2723',janggi:{choC:'#29b6f6',hanC:'#ef5350',style:'real'},baduk:{style:'real'}},ebony:{bgType:'wood',base:'#212121',grain:'rgba(0,0,0,0.6)',line:'#9e9e9e',janggi:{choC:'#90caf9',hanC:'#ef9a9a',style:'real'},baduk:{style:'real'}},modern:{bgType:'solid',base:'#1e293b',line:'#475569',janggi:{choC:'#60a5fa',hanC:'#f87171',style:'flat',pieceBg:'#334155',shape:'circle'},baduk:{style:'flat',b:'#000',w:'#fff'}},minimal:{bgType:'solid',base:'#f0f0f0',line:'#aaa',janggi:{choC:'#000',hanC:'#d32f2f',pieceBg:'#fff',shape:'circle'},baduk:{style:'flat',b:'#222',w:'#fff'}},classic:{bgType:'paper',base:'#eaddcf',line:'#5d4037',janggi:{choC:'#268bd2',hanC:'#dc322f',pieceBg:'#fdf6e3',shape:'octagon'},baduk:{style:'real'}},forest:{bgType:'solid',base:'#385c38',line:'#8fbc8f',janggi:{choC:'#81d4fa',hanC:'#ffab91',pieceBg:'#2e4a2e',shape:'circle'},baduk:{style:'flat',b:'#111',w:'#fff'}},ocean:{bgType:'solid',base:'#415a77',line:'#778da9',janggi:{choC:'#90e0ef',hanC:'#ffadad',pieceBg:'#1b263b',shape:'circle'},baduk:{style:'flat',b:'#000',w:'#fff'}},mono:{bgType:'solid',base:'#333',line:'#666',janggi:{choC:'#fff',hanC:'#aaa',style:'flat',pieceBg:'#222',shape:'octagon'},baduk:{style:'flat',b:'#000',w:'#fff',s:'#555'}},retro:{bgType:'solid',base:'#3c3f41',line:'#808080',janggi:{choC:'#6a8759',hanC:'#cc7832',pieceBg:'#2b2b2b',shape:'square'},baduk:{style:'flat',b:'#000',w:'#aaa'}}};

    let game=null, currentTheme='oak', currentDiff='god', currentMode='';
    let lastJanggiSetup = 'gwima';
    const canvas=document.getElementById('gameCanvas'), ctx=canvas.getContext('2d'), wrap=document.getElementById('board-wrap');
    let dpr=window.devicePixelRatio||1, loopId=null, woodPattern=null;

    const AudioSys={ctx:null,vol:0.7,muted:false,init(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext)()},setVol(v){this.vol=v/100},play(t,s=1.0){if(this.muted||!this.ctx)return;if(this.ctx.state==='suspended')this.ctx.resume();const n=this.ctx.currentTime,g=this.ctx.createGain();const fv=this.vol*s;if(t==='move'){const o=this.ctx.createOscillator();o.type='triangle';o.frequency.setValueAtTime(250,n);o.frequency.exponentialRampToValueAtTime(50,n+.15);g.gain.setValueAtTime(fv*.6,n);g.gain.linearRampToValueAtTime(0,n+.15);o.connect(g);g.connect(this.ctx.destination);o.start(n);o.stop(n+.15)}else if(t==='capture'){const o1=this.ctx.createOscillator();o1.type='square';o1.frequency.setValueAtTime(150,n);o1.frequency.exponentialRampToValueAtTime(40,n+.2);const o2=this.ctx.createOscillator();o2.type='sawtooth';o2.frequency.setValueAtTime(500,n);o2.frequency.exponentialRampToValueAtTime(100,n+.1);g.gain.setValueAtTime(fv*.8,n);g.gain.linearRampToValueAtTime(0,n+.2);o1.connect(g);o2.connect(g);g.connect(this.ctx.destination);o1.start(n);o1.stop(n+.2);o2.start(n);o2.stop(n+.2)}else if(t==='check'){const o=this.ctx.createOscillator();o.type='sawtooth';o.frequency.setValueAtTime(400,n);o.frequency.linearRampToValueAtTime(200,n+.3);g.gain.setValueAtTime(fv*.7,n);g.gain.linearRampToValueAtTime(0,n+.3);o.connect(g);g.connect(this.ctx.destination);o.start(n);o.stop(n+.3)}else if(t==='win'){const o=this.ctx.createOscillator();o.type='sine';o.frequency.setValueAtTime(523.25,n);o.frequency.linearRampToValueAtTime(1046.5,n+.5);g.gain.setValueAtTime(fv*.5,n);g.gain.linearRampToValueAtTime(0,n+.5);o.connect(g);g.connect(this.ctx.destination);o.start(n);o.stop(n+.5)}}};
    class Particles{constructor(){this.p=[]}spawn(x,y,c){for(let i=0;i<12;i++)this.p.push({x,y,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6,l:1,c})}up(){for(let i=this.p.length-1;i>=0;i--){this.p[i].x+=this.p[i].vx;this.p[i].y+=this.p[i].vy;this.p[i].l-=.04;if(this.p[i].l<=0)this.p.splice(i,1)}}draw(c){this.p.forEach(k=>{c.globalAlpha=k.l;c.fillStyle=k.c;c.beginPath();c.arc(k.x,k.y,3,0,Math.PI*2);c.fill()});c.globalAlpha=1}}
    const particles = new Particles();

    // AI Worker - Omok Logic Updated
    const workerCode = `
    const ZOBRIST = Array.from({length:90}, () => Array.from({length:14}, () => Math.floor(Math.random() * 2147483647)));
    const P_MAP = {'cho_cha':0, 'cho_po':1, 'cho_ma':2, 'cho_sang':3, 'cho_sa':4, 'cho_jol':5, 'cho_king':6, 'han_cha':7, 'han_po':8, 'han_ma':9, 'han_sang':10, 'han_sa':11, 'han_jol':12, 'han_king':13};
    self.onmessage = function(e) {
        const { type, pieces, diff, history, board, turn } = e.data;
        if (type === 'JANGGI') {
            const ai = new JanggiAI(pieces, diff, history);
            self.postMessage(ai.getBestMove());
        } else if (type === 'OMOK') {
            const ai = new OmokAI(board, diff, turn);
            self.postMessage(ai.getBestMove());
        }
    };
    class JanggiAI {
        constructor(p, d, h) {
            this.pieces = p; this.diff = d; this.history = h; this.turn = 'han';
            this.grid = Array.from({length:10}, () => Array(9).fill(null));
            for(const pc of p) { this.grid[pc.y][pc.x] = pc; }
            this.tt = new Map();
        }
        getBestMove() {
            let d = 2, r = 0; 
            if(this.diff==='god'){d=4; r=0;} else if(this.diff==='veryhard'){d=3; r=0;} else if(this.diff==='hard'){d=3; r=10;} else if(this.diff==='normal'){d=2; r=30;} else {d=1; r=100;}
            const res = this.minimax(d, -Infinity, Infinity, true, r);
            if (res.score <= -90000) return null; // Resign
            return res.move;
        }
        get(x, y) { if(x<0||x>8||y<0||y>9) return null; return this.grid[y][x]; }
        score(t) { const s={king:10000,cha:13,po:7,ma:5,sang:3,sa:3,jol:2}; return s[t]||0; }
        evaluate() {
            let sc = 0;
            this.pieces.forEach(p => {
                let v = this.score(p.t);
                if (this.diff !== 'easy') {
                    if(p.t==='po'&&p.x===4) v+=1.5; if(p.t==='ma'&&p.x===4&&(p.y===4||p.y===5)) v+=1.0; if(p.t==='jol'&&p.x===4) v+=0.5;
                    if(p.t==='cha' && this.att(p.x, p.y, p.f)) v-=15; 
                }
                if (p.f === 'han') sc += v; else sc -= v;
            });
            return sc;
        }
        att(x, y, f) {
            const dx=[0,0,1,-1], dy=[1,-1,0,0];
            for(let i=0;i<4;i++){
                let nx=x+dx[i], ny=y+dy[i];
                while(nx>=0&&nx<9&&ny>=0&&ny<10){
                    const t=this.grid[ny][nx];
                    if(t){ if(t.f!==f && (t.t==='cha'||t.t==='king'||(t.t==='jol'&&Math.abs(nx-x)+Math.abs(ny-y)===1))) return true; break; }
                    nx+=dx[i]; ny+=dy[i];
                }
            }
            return false;
        }
        minimax(d, a, b, im, rn) {
            if (d===0) return this.diff==='god'?this.qui(a,b,im):{score:this.evaluate()};
            const f = im?'han':'cho';
            const myPieces = this.pieces.filter(p => p.f === f);
            let bm=null, bs=im?-Infinity:Infinity, am=[];
            for(let p of myPieces) {
                const ms = this.getLegalMoves(p); 
                for(let m of ms) am.push({p, x:m.x, y:m.y});
            }
            if(!am.length) return { score: im ? -100000 : 100000 };
            am.sort((x,y)=>{
                const tx=this.get(x.x,x.y), ty=this.get(y.x,y.y);
                return (ty?(this.score(ty.t)):0)-(tx?(this.score(tx.t)):0);
            });
            for(let m of am) {
                const bk = this.sim(m);
                const vo = this.minimax(d - 1, a, b, !im, rn);
                let v = vo.score;
                this.restore(bk);
                if(d===1 && rn>0) v += (Math.random()-0.5)*rn;
                if (im) { if (v > bs) { bs=v; bm=m; } a = Math.max(a, v); } else { if (v < bs) { bs=v; bm=m; } b = Math.min(b, v); }
                if (b <= a) break;
            }
            return { score: bs, move: bm };
        }
        qui(a, b, im) {
            const sp = this.evaluate();
            if (im) { if (sp >= b) return {score:b}; if (sp > a) a = sp; } else { if (sp <= a) return {score:a}; if (sp < b) b = sp; }
            const f = im?'han':'cho';
            const my = this.pieces.filter(p=>p.f===f);
            for(let p of my) {
                const moves = this.getLegalMoves(p);
                for(let m of moves) {
                    if(this.get(m.x, m.y)) { 
                        const bk = this.sim({p, x:m.x, y:m.y});
                        const v = this.qui(a, b, !im).score;
                        this.restore(bk);
                        if (im) { if (v > a) a = v; if (v >= b) return {score:b}; } else { if (v < b) b = v; if (v <= a) return {score:a}; }
                    }
                }
            }
            return { score: im ? a : b };
        }
        sim(m){
            const{p,x,y}=m, ox=p.x, oy=p.y; const t = this.get(x,y); let c = null, ti = -1;
            if(t) { c = t; ti = this.pieces.indexOf(t); this.pieces.splice(ti, 1); }
            this.grid[oy][ox] = null; this.grid[y][x] = p; p.x=x; p.y=y;
            return {p,ox,oy,c,ti};
        }
        restore(b){
            const{p,ox,oy,c,ti}=b; this.grid[p.y][p.x] = null; p.x=ox; p.y=oy; this.grid[oy][ox] = p;
            if(c) { this.pieces.splice(ti, 0, c); this.grid[c.y][c.x] = c; }
        }
        getLegalMoves(p) { return this.raw(p).filter(m=>{ const b=this.sim({p,x:m.x,y:m.y}); const s=!this.chk(p.f); this.restore(b); return s; }); }
        chk(f) {
            const k = this.pieces.find(p=>p.f===f && p.t==='king'); if(!k) return true;
            const es = this.pieces.filter(p=>p.f!==f);
            for(let e of es) if(this.raw(e).some(m=>m.x===k.x && m.y===k.y)) return true;
            return false;
        }
        raw(p) {
            let m=[]; const g=(x,y)=>this.get(x,y);
            const inp=(x,y)=>{if(x<3||x>5)return false;return p.f==='han'?(y>=0&&y<=2):(y>=7&&y<=9)};
            const isc=(x,y)=>(x===4&&(y===1||y===8));
            const sc=(dx,dy,l=10,j=false)=>{
                let nx=p.x, ny=p.y, jp=false;
                for(let i=0;i<l;i++){
                    nx+=dx; ny+=dy; if(nx<0||nx>8||ny<0||ny>9)break;
                    const t=g(nx,ny);
                    if(j){if(!jp){if(t){if(t.t==='po')break;jp=true}}else{if(t){if(t.f!==p.f&&t.t!=='po')m.push({x:nx,y:ny,capture:true});break}m.push({x:nx,y:ny})}}
                    else{if(t){if(t.f!==p.f)m.push({x:nx,y:ny,capture:true});break}m.push({x:nx,y:ny})}
                }
            };
            if(p.t==='cha')[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>sc(d[0],d[1]));
            if(p.t==='po')[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>sc(d[0],d[1],10,true));
            if(p.t==='jol'){const dy=p.f==='cho'?-1:1;[[0,dy],[1,0],[-1,0]].forEach(d=>sc(d[0],d[1],1));if(inp(p.x,p.y))[[1,dy],[-1,dy]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inp(nx,ny)&&(isc(p.x,p.y)||isc(nx,ny)))sc(d[0],d[1],1)})}
            if(p.t==='ma'||p.t==='sang'){const r=p.t==='ma'?[[1,-2,0,-1],[-1,-2,0,-1],[1,2,0,1],[-1,2,0,1],[2,-1,1,0],[2,1,1,0],[-2,-1,-1,0],[-2,1,-1,0]]:[[2,-3,0,-1,1,-2],[-2,-3,0,-1,-1,-2],[2,3,0,1,1,2],[-2,3,0,1,-1,2],[3,-2,1,0,2,-1],[3,2,1,0,2,1],[-3,-2,-1,0,-2,-1],[-3,2,-1,0,-2,1]];r.forEach(v=>{if(!g(p.x+v[2],p.y+v[3])&&(p.t==='ma'||!g(p.x+v[4],p.y+v[5]))){const tx=p.x+v[0],ty=p.y+v[1];if(tx>=0&&tx<9&&ty>=0&&ty<10){const t=g(tx,ty);if(!t||t.f!==p.f)m.push({x:tx,y:ty,capture:!!t})}}});}
            if(p.t==='king'||p.t==='sa'){[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inp(nx,ny)){const t=g(nx,ny);if(!t||t.f!==p.f)m.push({x:nx,y:ny,capture:!!t})}});[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inp(nx,ny)&&(isc(p.x,p.y)||isc(nx,ny))){const t=g(nx,ny);if(!t||t.f!==p.f)m.push({x:nx,y:ny,capture:!!t})}})}
            if(p.t==='po'&&inp(p.x,p.y)){[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1],nnx=p.x+d[0]*2,nny=p.y+d[1]*2;if(inp(nx,ny)&&isc(nx,ny)){const s=g(nx,ny);if(s&&s.t!=='po'&&inp(nnx,nny)){const t=g(nnx,nny);if(!t)m.push({x:nnx,y:nny});else if(t.f!==p.f&&t.t!=='po')m.push({x:nnx,y:nny,capture:true})}}})}
            if(p.t==='cha'&&inp(p.x,p.y)){[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inp(nx,ny)&&(isc(p.x,p.y)||isc(nx,ny))){const t=g(nx,ny);if(!t||t.f!==p.f)m.push({x:nx,y:ny,capture:!!t});if(!t&&isc(p.x,p.y)){const nnx=p.x+d[0]*2,nny=p.y+d[1]*2;if(inp(nnx,nny)){const t2=g(nnx,nny);if(!t2||t2.f!==p.f)m.push({x:nnx,y:nny,capture:!!t2})}}}})}
            return m;
        }
    }

    class OmokAI {
        constructor(board, diff, turn) {
            this.board = board; this.diff = diff; this.turn = turn;
            this.cols = 15; this.rows = 15;
        }
        getBestMove() {
            let moves = [];
            for(let y=0;y<15;y++) for(let x=0;x<15;x++) if(this.board[y][x]===0) moves.push({x,y});
            if(moves.length === 0) return null;

            moves.sort((a,b) => {
                const da = Math.abs(a.x-7)+Math.abs(a.y-7);
                const db = Math.abs(b.x-7)+Math.abs(b.y-7);
                return da - db;
            });

            // 1. Emergency Block (Must do)
            for(let m of moves) {
                // Win now
                this.board[m.y][m.x] = 2; if(this.checkWin(2)) { this.board[m.y][m.x]=0; return m; } this.board[m.y][m.x] = 0;
            }
            for(let m of moves) {
                // Block Opponent 5
                this.board[m.y][m.x] = 1; if(this.checkWin(1)) { this.board[m.y][m.x]=0; return m; } this.board[m.y][m.x] = 0;
            }
            // Block Open 4 / Open 3
            for(let m of moves) {
                 this.board[m.y][m.x] = 1; // Assume opponent
                 let s = this.evalSide(1);
                 this.board[m.y][m.x] = 0;
                 if(s >= 5000000) return m; // Must block threat
            }

            let bestScore = -Infinity;
            let bestMove = moves[0];
            const depth = (this.diff==='god'||this.diff==='veryhard') ? 3 : 2;

            for(let m of moves.slice(0, 30)) { 
                this.board[m.y][m.x] = 2; 
                let score = this.minimax(depth-1, -Infinity, Infinity, false);
                this.board[m.y][m.x] = 0;
                if(score > bestScore) { bestScore = score; bestMove = m; }
            }
            return bestMove;
        }
        
        checkWin(c){
            const dirs=[[1,0],[0,1],[1,1],[1,-1]];
            for(let y=0;y<15;y++) for(let x=0;x<15;x++) {
                if(this.board[y][x]!==c) continue;
                for(let d of dirs){
                    let cnt=1;
                    for(let i=1;i<5;i++){const nx=x+d[0]*i,ny=y+d[1]*i;if(nx<0||nx>=15||ny<0||ny>=15||this.board[ny][nx]!==c)break;cnt++}
                    if(cnt>=5)return true;
                }
            }
            return false;
        }

        minimax(depth, alpha, beta, isMax) {
            if(depth===0) return this.evaluate();
            
            let moves = [];
            for(let y=0;y<15;y++) for(let x=0;x<15;x++) if(this.board[y][x]===0) {
                 let hasNeighbor = false;
                 for(let dy=-1; dy<=1; dy++) for(let dx=-1; dx<=1; dx++) {
                    if(dx===0&&dy===0) continue;
                    let nx=x+dx, ny=y+dy;
                    if(nx>=0 && nx<15 && ny>=0 && ny<15 && this.board[ny][nx]!==0) { hasNeighbor=true; break; }
                 }
                 if(hasNeighbor) moves.push({x,y});
             }
            if(moves.length===0) return this.evaluate();

            if(isMax) {
                let maxEval = -Infinity;
                for(let m of moves.slice(0, 8)) { 
                    this.board[m.y][m.x] = 2;
                    let evalVal = this.minimax(depth-1, alpha, beta, false);
                    this.board[m.y][m.x] = 0;
                    maxEval = Math.max(maxEval, evalVal);
                    alpha = Math.max(alpha, evalVal);
                    if(beta <= alpha) break;
                }
                return maxEval;
            } else {
                let minEval = Infinity;
                for(let m of moves.slice(0, 8)) {
                    this.board[m.y][m.x] = 1;
                    let evalVal = this.minimax(depth-1, alpha, beta, true);
                    this.board[m.y][m.x] = 0;
                    minEval = Math.min(minEval, evalVal);
                    beta = Math.min(beta, evalVal);
                    if(beta <= alpha) break;
                }
                return minEval;
            }
        }

        evaluate() {
            let score = 0;
            score += this.evalSide(2) * 1.0;
            score -= this.evalSide(1) * 100.0; // Defense Priority
            return score;
        }
        evalSide(c) {
            let s = 0;
            const dirs=[[1,0],[0,1],[1,1],[1,-1]];
            for(let y=0;y<15;y++) for(let x=0;x<15;x++) {
                if(this.board[y][x]!==c) continue;
                for(let d of dirs) {
                    let cnt=1, open=0;
                    if(x-d[0]>=0 && y-d[1]>=0 && x-d[0]<15 && y-d[1]<15 && this.board[y-d[1]][x-d[0]]===0) open++;
                    for(let k=1; k<5; k++) {
                        const nx=x+d[0]*k, ny=y+d[1]*k;
                        if(nx<0||ny<0||nx>=15||ny>=15) break;
                        if(this.board[ny][nx]===c) cnt++;
                        else { if(this.board[ny][nx]===0) open++; break; }
                    }
                    if(cnt>=5) s+=100000000;
                    else if(cnt===4) {
                        if(open===2) s+=50000000; 
                        else if(open===1) s+=5000000;
                    }
                    else if(cnt===3) {
                        if(open===2) s+=500000; 
                        else if(open===1) s+=1000;
                    }
                    else if(cnt===2 && open===2) s+=500;
                }
            }
            return s;
        }
    }
    `;

    // --- Î©îÏù∏ Ïª®Ìä∏Î°§Îü¨ ---
    let worker=null;
    function initWorker() {
        const blob=new Blob([workerCode],{type:'application/javascript'});
        if(worker)worker.terminate();
        worker=new Worker(URL.createObjectURL(blob));
        worker.onmessage=e=>{
            if(game) {
                if(e.data) game.execute(e.data.p || null, e.data.x, e.data.y); // Janggi: p,x,y / Omok: x,y
                else game.endGame(true);
            }
        };
    }
    
    function createWoodPattern(tm) {
        if(tm.bgType !== 'wood') return null;
        const s = 512; const c = document.createElement('canvas'); c.width=s; c.height=s; const x = c.getContext('2d');
        x.fillStyle = tm.base; x.fillRect(0,0,s,s);
        x.lineWidth = 2; x.strokeStyle = tm.grain;
        for(let i=0; i<15; i++) { x.beginPath(); x.moveTo(0, Math.random()*s); x.bezierCurveTo(s/3, Math.random()*s, s*2/3, Math.random()*s, s, Math.random()*s); x.stroke(); }
        return ctx.createPattern(c, 'repeat');
    }

    function setTheme(t, b) {
        currentTheme = t; document.body.className = `theme-${t}`;
        document.querySelectorAll('.opt-btn').forEach(k=>{if(!k.hasAttribute('data-v'))k.classList.remove('selected')});
        if(b) b.classList.add('selected');
        woodPattern = createWoodPattern(THEMES[t]);
        if(game) resize();
    }
    setTheme('oak', document.querySelector('.opt-btn'));
    document.querySelector('.opt-btn[data-v="god"]').classList.add('selected');

    function setDiff(v,b){currentDiff=v;document.querySelectorAll('.opt-btn').forEach(k=>{if(k.hasAttribute('data-v'))k.classList.remove('selected')});b.classList.add('selected')}
    
    function restartGame() {
        if (currentMode) startGame(currentMode);
    }
    
    function startGame(m){
        currentMode = m;
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('janggi-setup').classList.add('hidden');
        resetUI();
        AudioSys.init();
        
        if (m === 'omok') {
             initWorker();
             game = new OmokGame(currentDiff);
        } else if (m === 'baduk') {
             game = new BadukGame(currentDiff);
        } else if (m === 'janggi') {
             openJanggiSetup();
             return;
        }
        
        resize(); if(loopId)cancelAnimationFrame(loopId); loop();
    }
    function openJanggiSetup(){document.getElementById('main-menu').classList.add('hidden');document.getElementById('janggi-setup').classList.remove('hidden')}
    function startJanggi(s){
        currentMode = 'janggi';
        lastJanggiSetup = s;
        document.getElementById('janggi-setup').classList.add('hidden');
        resetUI();
        initWorker();
        game=new JanggiGame(currentDiff,s);
        resize(); if(loopId)cancelAnimationFrame(loopId); loop();
    }
    function resetUI(){document.getElementById('caps-ai').innerHTML='';document.getElementById('caps-user').innerHTML='';document.getElementById('score-ai').innerText='0';document.getElementById('score-user').innerText='0';document.getElementById('turn-badge').innerText='ÎåÄÍ∏∞ Ï§ë';document.getElementById('turn-badge').className='status-badge'}
    function goHome(){document.getElementById('main-menu').classList.remove('hidden');document.getElementById('janggi-setup').classList.add('hidden');game=null}
    function toast(m){const e=document.getElementById('toast');e.innerText=m;e.className='toast show';setTimeout(()=>e.classList.remove('show'),2000)}
    function resize(){if(!game)return;const w=wrap.clientWidth,h=wrap.clientHeight,pad=30;const sz=Math.floor(Math.min((w-pad)/(game.cols+1),(h-pad)/(game.rows+1)));game.cs=sz;game.mg=Math.floor(sz*.8);const bw=game.mg*2+(game.cols-1)*sz,bh=game.mg*2+(game.rows-1)*sz;canvas.style.width=bw+'px';canvas.style.height=bh+'px';canvas.width=bw*dpr;canvas.height=bh*dpr;ctx.setTransform(1,0,0,1,0,0);ctx.scale(dpr,dpr);game.draw()}
    window.addEventListener('resize',()=>requestAnimationFrame(resize));
    function loop(){if(game){game.draw();particles.up();particles.draw(ctx)}loopId=requestAnimationFrame(loop)}
    
    function undoGame() { if(game && game.undo) game.undo(); }
    function toggleMute() {
        AudioSys.muted = !AudioSys.muted;
        document.querySelector('.vol-icon').innerText = AudioSys.muted ? 'üîá' : 'üîä';
        toast(AudioSys.muted ? "ÏÜåÎ¶¨ ÎÅî" : "ÏÜåÎ¶¨ Ïº¨");
    }

    class OmokGame {
        constructor(d){
            this.diff=d; this.cols=15; this.rows=15; 
            this.board=Array.from({length:15},()=>Array(15).fill(0));
            this.turn=1; this.lastMove=null; this.history=[]; 
            this.undoCount=3; this.canUndo=false; this.gameOver=false;
            this.updateUI(); canvas.onclick=e=>this.onClick(e);
        }
        draw(){
            ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);const tm=THEMES[currentTheme];const{cs,mg}=this;
            if(woodPattern && tm.bgType==='wood') ctx.fillStyle=woodPattern; else ctx.fillStyle=tm.base;
            ctx.fillRect(0,0,canvas.width/dpr,canvas.height/dpr);
            ctx.strokeStyle=tm.line; ctx.lineWidth=1;for(let i=0;i<15;i++){ctx.beginPath();ctx.moveTo(mg+i*cs,mg);ctx.lineTo(mg+i*cs,mg+14*cs);ctx.stroke();ctx.beginPath();ctx.moveTo(mg,mg+i*cs);ctx.lineTo(mg+14*cs,mg+i*cs);ctx.stroke()}
            [3,7,11].forEach(x=>[3,7,11].forEach(y=>{ctx.beginPath();ctx.arc(mg+x*cs,mg+y*cs,3,0,Math.PI*2);ctx.fillStyle=tm.line;ctx.fill()}));
            if(this.lastMove){const{x,y}=this.lastMove;ctx.beginPath();ctx.arc(mg+x*cs,mg+y*cs,cs*.5,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,0.4)';ctx.fill()}
            const bt=tm.baduk;
            for(let y=0;y<15;y++)for(let x=0;x<15;x++)if(this.board[y][x]){
                const cx=mg+x*cs,cy=mg+y*cs; ctx.beginPath(); ctx.arc(cx,cy,cs/2-1,0,Math.PI*2);
                const c=this.board[y][x];
                if(bt.style==='real'){const g=ctx.createRadialGradient(cx-3,cy-3,2,cx,cy,12);if(c===1){g.addColorStop(0,'#555');g.addColorStop(1,'#000')}else{g.addColorStop(0,'#fff');g.addColorStop(1,'#ddd')}ctx.fillStyle=g}
                else{ctx.fillStyle=c===1?bt.b:bt.w;if(bt.s){ctx.strokeStyle=bt.s;ctx.stroke()}}
                ctx.fill()
            }
        }
        onClick(e){if(this.turn!==1 || this.gameOver)return;const r=canvas.getBoundingClientRect(),x=Math.round(((e.clientX-r.left)*(canvas.width/dpr/r.width)-this.mg)/this.cs),y=Math.round(((e.clientY-r.top)*(canvas.height/dpr/r.height)-this.mg)/this.cs);if(x>=0&&x<15&&y>=0&&y<15)this.place(x,y,1)}
        place(x,y,c){
            if(this.board[y][x]!==0)return;
            const prevBoard = this.board.map(r=>[...r]);
            this.history.push({ board: prevBoard, lastMove: this.lastMove, turn: this.turn });
            this.board[y][x]=c; this.lastMove={x,y}; AudioSys.play('move');
            particles.spawn(this.mg+x*this.cs,this.mg+y*this.cs,c===1?THEMES[currentTheme].baduk.b:THEMES[currentTheme].baduk.w);
            if(this.checkWin(x,y,c)){this.endGame(c===1); return;}
            this.canUndo=true;
            this.turn=c===1?2:1; this.updateUI();
            if(this.turn===2) {
                 worker.postMessage({type:'OMOK', board:this.board, diff:this.diff, turn:2});
            }
        }
        execute(p, x, y) { this.place(x, y, 2); }
        undo(){
            if(this.undoCount<=0){toast("Î¨¥Î•¥Í∏∞ ÌöüÏàò Ï¥àÍ≥º!");return}
            if(!this.canUndo){toast("Ïó∞ÏÜç Î¨¥Î•¥Í∏∞ Î∂àÍ∞Ä!");return}
            if(this.turn===2)return;
            if(this.history.length<2)return;
            for(let i=0;i<2;i++){ const s=this.history.pop(); this.board=s.board; this.lastMove=s.lastMove; this.turn=s.turn; }
            this.turn=1; this.undoCount--; this.canUndo=false; this.gameOver=false;
            this.updateUI();this.draw();toast(`Î¨¥Î•¥Í∏∞ ÏôÑÎ£å (${this.undoCount})`);
        }
        checkWin(x,y,c){
            const dirs=[[1,0],[0,1],[1,1],[1,-1]];
            for(let d of dirs){
                let cnt=1;
                for(let i=1;i<5;i++){const nx=x+d[0]*i,ny=y+d[1]*i;if(nx<0||nx>=15||ny<0||ny>=15||this.board[ny][nx]!==c)break;cnt++}
                for(let i=1;i<5;i++){const nx=x-d[0]*i,ny=y-d[1]*i;if(nx<0||nx>=15||ny<0||ny>=15||this.board[ny][nx]!==c)break;cnt++}
                if(cnt>=5)return true;
            }
            return false;
        }
        updateUI(){const st=document.getElementById('turn-badge'),cai=document.getElementById('card-ai'),cuser=document.getElementById('card-user');
            if(this.gameOver) { st.innerText = "Í≤åÏûÑ Ï¢ÖÎ£å"; st.className = "status-badge"; return; }
            if(this.turn===1){st.innerText="ÎÇòÏùò Ï∞®Î°Ä";st.className="status-badge active";cuser.classList.add('active');cai.classList.remove('active')}else{st.innerText="AI ÏÉùÍ∞Å Ï§ë...";st.className="status-badge";cuser.classList.remove('active');cai.classList.add('active')}document.getElementById('score-user').innerText="-";document.getElementById('score-ai').innerText="-";document.getElementById('undo-cnt').innerText=this.undoCount;document.getElementById('undo-btn').disabled = !this.canUndo || this.undoCount <= 0;}
        endGame(win) {
            this.gameOver = true;
            AudioSys.play('win');
            toast(win?"ÏäπÎ¶¨!":"Ìå®Î∞∞", win?"success":"normal");
            this.updateUI();
            setTimeout(()=>alert(win?"ÏäπÎ¶¨!":"Ìå®Î∞∞"), 200);
        }
    }

    class JanggiGame {
        constructor(d,s){this.diff=d;this.setupType=s;this.cols=9;this.rows=10;this.pieces=[];this.turn='cho';this.selected=null;this.moves=[];this.lastMove=null;this.history=[];this.stateHistory=new Map();
            this.undoCount = 3; // Î¨¥Î•¥Í∏∞ ÌöüÏàò Ï†úÌïú
            this.canUndo = false; // Ïó∞ÏÜç Î¨¥Î•¥Í∏∞ Î∞©ÏßÄ
            this.gameOver = false;
            this.setup();this.updateUI();canvas.onclick=e=>this.onClick(e)
        }
        setup(){
            const add=(t,x,y,f)=>this.pieces.push({t,x,y,f,id:Math.random()});
            add('cha',0,0,'han');add('cha',8,0,'han');add('cha',0,9,'cho');add('cha',8,9,'cho');
            add('po',1,2,'han');add('po',7,2,'han');add('po',1,7,'cho');add('po',7,7,'cho');
            [0,2,4,6,8].forEach(x=>{add('jol',x,3,'han');add('jol',x,6,'cho')});
            add('king',4,1,'han');add('king',4,8,'cho');add('sa',3,0,'han');add('sa',5,0,'han');add('sa',3,9,'cho');add('sa',5,9,'cho');
            const sets=['gwima','wonang','yanggwima','yanggwisang'];
            const aiSet=sets[Math.floor(Math.random()*4)];
            this.placeMS(aiSet,'han',0); this.placeMS(this.setupType,'cho',9);
            this.recState();
        }
        placeMS(t,f,y){const add=(k,x)=>this.pieces.push({t:k,x,y,f,id:Math.random()});let l,r;if(t==='gwima'){l=['ma','sang'];r=['sang','ma']}else if(t==='wonang'){l=['sang','ma'];r=['ma','sang']}else if(t==='yanggwima'){l=['ma','sang'];r=['ma','sang']}else{l=['sang','ma'];r=['sang','ma']}add(l[0],1);add(l[1],2);add(r[0],6);add(r[1],7)}
        getHash(){return this.pieces.map(p=>`${p.f[0]}${p.t[0]}${p.x}${p.y}`).sort().join('')}
        recState(){const h=this.getHash();this.stateHistory.set(h,(this.stateHistory.get(h)||0)+1)}
        draw(){
            ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);
            const tm=THEMES[currentTheme]; const jtm=tm.janggi; const{cs,mg}=this;
            if(woodPattern) ctx.fillStyle=woodPattern; else ctx.fillStyle=tm.base;
            ctx.fillRect(0,0,canvas.width/dpr,canvas.height/dpr);
            ctx.strokeStyle=tm.line;ctx.lineWidth=1.5;
            for(let i=0;i<9;i++){ctx.beginPath();ctx.moveTo(mg+i*cs,mg);ctx.lineTo(mg+i*cs,mg+9*cs);ctx.stroke()}
            for(let i=0;i<10;i++){ctx.beginPath();ctx.moveTo(mg,mg+i*cs);ctx.lineTo(mg+8*cs,mg+i*cs);ctx.stroke()}
            const pal=(r,c)=>{ctx.beginPath();ctx.moveTo(mg+c*cs,mg+r*cs);ctx.lineTo(mg+(c+2)*cs,mg+(r+2)*cs);ctx.stroke();ctx.beginPath();ctx.moveTo(mg+(c+2)*cs,mg+r*cs);ctx.lineTo(mg+c*cs,mg+(r+2)*cs);ctx.stroke()};pal(0,3);pal(7,3);
            if(this.lastMove){const{fx,fy,tx,ty}=this.lastMove;ctx.fillStyle=currentTheme==='mono'?'rgba(0,0,0,0.1)':'rgba(255,255,255,0.2)';ctx.fillRect(mg+fx*cs-cs/2,mg+fy*cs-cs/2,cs,cs);ctx.fillRect(mg+tx*cs-cs/2,mg+ty*cs-cs/2,cs,cs)}
            this.moves.forEach(m=>{const mx=mg+m.x*cs,my=mg+m.y*cs;if(m.capture){ctx.strokeStyle=currentTheme==='mono'?'#000':'#ef4444';ctx.lineWidth=3;ctx.beginPath();ctx.arc(mx,my,cs*.4,0,Math.PI*2);ctx.stroke()}else{ctx.fillStyle=currentTheme==='mono'?'rgba(0,0,0,0.2)':'rgba(16,185,129,0.7)';ctx.beginPath();ctx.arc(mx,my,cs*.15,0,Math.PI*2);ctx.fill()}});
            this.pieces.forEach(p=>{
                const cx=mg+p.x*cs, cy=mg+p.y*cs;let r=cs*0.4;if(p.t==='king')r*=1.15;if(['sa','jol'].includes(p.t))r*=.85;
                ctx.beginPath();
                if(jtm.shape==='octagon'&&p.t!=='jol'&&p.t!=='sa'){for(let i=0;i<8;i++){const a=(i*45+22.5)*Math.PI/180;const px=cx+r*Math.cos(a),py=cy+r*Math.sin(a);if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py)}ctx.closePath()}
                else if(jtm.shape==='square') ctx.rect(cx-r,cy-r,r*2,r*2);
                else ctx.arc(cx,cy,r,0,Math.PI*2);
                if(jtm.style==='real'){const g=ctx.createRadialGradient(cx-r*0.3,cy-r*0.3,r*0.1,cx,cy,r);g.addColorStop(0,'#f2e6d5');g.addColorStop(1,'#d8c29d');ctx.fillStyle=g}
                else ctx.fillStyle=jtm.pieceBg;
                ctx.shadowColor='rgba(0,0,0,0.5)';ctx.shadowBlur=6;ctx.shadowOffsetY=4;
                if(currentTheme==='mono'){ctx.fillStyle='#fff';ctx.shadowColor='transparent'}
                ctx.fill();ctx.shadowBlur=0;ctx.shadowOffsetY=0;
                if(currentTheme==='mono'){ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.stroke()}
                else if(jtm.shape==='octagon'){ctx.strokeStyle=p.f==='cho'?'#1d4ed8':'#b91c1c';ctx.lineWidth=2;ctx.stroke()}
                if(this.selected===p){ctx.strokeStyle='#10b981';ctx.lineWidth=3;ctx.stroke()}
                const col=p.f==='cho'?jtm.choC:jtm.hanC; ctx.fillStyle=col; 
                ctx.font=`700 ${r*1.1}px ${getComputedStyle(document.body).fontFamily}`; ctx.textAlign='center'; ctx.textBaseline='middle';
                const map={king:p.f==='cho'?'Ê•ö':'Êº¢',cha:'Ëªä',po:'ÂåÖ',ma:'È¶¨',sang:'Ë±°',sa:'Â£´',jol:p.f==='cho'?'Âçí':'ÂÖµ'};
                ctx.fillText(map[p.t],cx,cy+r*0.1);
            });
        }
        onClick(e){if(this.turn!=='cho' || this.gameOver)return;const r=canvas.getBoundingClientRect(),x=Math.round(((e.clientX-r.left)*(canvas.width/dpr/r.width)-this.mg)/this.cs),y=Math.round(((e.clientY-r.top)*(canvas.height/dpr/r.height)-this.mg)/this.cs);if(x<0||x>8||y<0||y>9)return;const p=this.pieces.find(pp=>pp.x===x&&pp.y===y);if(p&&p.f==='cho'){this.selected=p;this.moves=this.getLegalMoves(p,true);return}if(this.selected){const m=this.moves.find(mv=>mv.x===x&&mv.y===y);if(m)this.execute(this.selected,x,y);else{this.selected=null;this.moves=[]}}}
        execute(p,x,y){
            const rp=this.pieces.find(k=>k.x===p.x&&k.y===p.y&&k.t===p.t&&k.f===p.f); if(!rp)return;
            const ti=this.pieces.findIndex(t=>t.x===x&&t.y===y),cap=ti!==-1?this.pieces[ti]:null;
            
            this.history.push({ fx:rp.x, fy:rp.y, tx:x, ty:y, cap: cap ? {...cap} : null, id: rp.id, turn: this.turn });
            let capScore = 0;
            if(cap){
                const s={king:10000,cha:13,po:7,ma:5,sang:3,sa:3,jol:2}; capScore = s[cap.t] || 2;
                this.pieces.splice(ti,1);this.addCap(cap);
                const volScale = 0.8 + (capScore / 13) * 0.7; 
                AudioSys.play('capture', volScale);
                particles.spawn(this.mg+x*this.cs,this.mg+y*this.cs,currentTheme==='modern'?'#ef4444':'#8b4513')
            }else AudioSys.play('move');
            
            this.lastMove={fx:rp.x,fy:rp.y,tx:x,ty:y};rp.x=x;rp.y=y;this.recState();this.selected=null;this.moves=[];
            this.canUndo=true;
            
            if(cap&&cap.t==='king'){this.endGame(true);return}
            this.turn=this.turn==='cho'?'han':'cho';this.updateUI();
            if(this.isCheck(this.turn)){
                AudioSys.play('check'); toast("Ïû•Íµ∞!");
                if(this.isCheckmate(this.turn)){setTimeout(()=>this.endGame(this.turn!=='cho'),200);return}
            }else if(this.isCheckmate(this.turn)){setTimeout(()=>this.endGame(this.turn!=='cho'),200);return}
            if(this.turn==='han')worker.postMessage({type:'JANGGI',pieces:this.pieces,diff:this.diff,history:this.history});
        }
        
        undo() {
            if(this.undoCount <= 0) { toast("Î¨¥Î•¥Í∏∞ ÌöüÏàò Ï¥àÍ≥º!"); return; }
            if(!this.canUndo) { toast("Ïó∞ÏÜç Î¨¥Î•¥Í∏∞ Î∂àÍ∞Ä!"); return; }
            if(this.turn === 'han') { toast("AIÍ∞Ä ÎëêÎäî Ï§ëÏûÖÎãàÎã§."); return; }
            if(this.history.length < 2) return;
            for(let i=0; i<2; i++) {
                const m = this.history.pop();
                const p = this.pieces.find(pc => pc.id === m.id);
                if(p) { p.x = m.fx; p.y = m.fy; }
                if(m.cap) {
                    this.pieces.push(m.cap);
                    const area = document.getElementById(m.turn==='cho'?'caps-user':'caps-ai');
                    if(area.lastChild) area.removeChild(area.lastChild);
                }
            }
            this.turn = 'cho'; this.undoCount--; this.canUndo = false;
            this.lastMove = this.history.length > 0 ? this.history[this.history.length-1] : null;
            this.gameOver = false;
            this.updateUI(); this.draw(); toast(`Î¨¥Î•¥Í∏∞ ÏôÑÎ£å (ÎÇ®ÏùÄ ÌöüÏàò: ${this.undoCount})`);
        }

        // [Î∞òÎ≥µÏàò Î£∞] Í≥µÍ≤©Ïûê(Ïû•Íµ∞)Îäî Í∏àÏßÄ, ÏàòÎπÑÏûêÎäî ÌóàÏö©
        getLegalMoves(p, checkRep=false) {
            return this.getRawMoves(p).filter(m => {
                const b = this.sim({p, x:m.x, y:m.y});
                const s = !this.isCheck(p.f);
                if (s && checkRep) {
                    const h = this.getHash();
                    // 3Ìöå Î∞òÎ≥µ Î∞úÏÉù Ïãú
                    if ((this.stateHistory.get(h) || 0) >= 2) {
                        // ÎÇ¥Í∞Ä Í≥µÍ≤©(Ïû•Íµ∞)ÌïòÎäî ÏûÖÏû•Ïù¥ÎùºÎ©¥ Í∏àÏßÄ. ÏàòÎπÑ(Î©çÍµ∞)Îäî ÌóàÏö©.
                        if (this.isCheck(p.f === 'cho' ? 'han' : 'cho')) {
                            this.res(b); return false;
                        }
                    }
                }
                this.res(b); return s;
            });
        }

        isCheck(f){const k=this.pieces.find(p=>p.f===f&&p.t==='king');if(!k)return true;const es=this.pieces.filter(p=>p.f!==f);for(let e of es)if(this.getRawMoves(e).some(m=>m.x===k.x&&m.y===k.y))return true;return false}
        isCheckmate(f){return!this.pieces.filter(p=>p.f===f).some(p=>this.getLegalMoves(p).length>0)}
        getRawMoves(p){let m=[];const g=(x,y)=>this.pieces.find(t=>t.x===x&&t.y===y),inp=(x,y)=>{if(x<3||x>5)return false;return p.f==='han'?(y>=0&&y<=2):(y>=7&&y<=9)},isc=(x,y)=>(x===4&&(y===1||y===8));const sc=(dx,dy,l=10,j=false)=>{let nx=p.x,ny=p.y,jp=false;for(let i=0;i<l;i++){nx+=dx;ny+=dy;if(nx<0||nx>8||ny<0||ny>9)break;const t=g(nx,ny);if(j){if(!jp){if(t){if(t.t==='po')break;jp=true}}else{if(t){if(t.f!==p.f&&t.t!=='po')m.push({x:nx,y:ny,capture:true});break}m.push({x:nx,y:ny})}}else{if(t){if(t.f!==p.f)m.push({x:nx,y:ny,capture:true});break}m.push({x:nx,y:ny})}}};if(p.t==='cha')[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>sc(d[0],d[1]));if(p.t==='po')[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>sc(d[0],d[1],10,true));if(p.t==='jol'){const dy=p.f==='cho'?-1:1;[[0,dy],[1,0],[-1,0]].forEach(d=>sc(d[0],d[1],1));if(inp(p.x,p.y))[[1,dy],[-1,dy]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inp(nx,ny)&&(isc(p.x,p.y)||isc(nx,ny)))sc(d[0],d[1],1)})}if(p.t==='ma'||p.t==='sang'){const r=p.t==='ma'?[[1,-2,0,-1],[-1,-2,0,-1],[1,2,0,1],[-1,2,0,1],[2,-1,1,0],[2,1,1,0],[-2,-1,-1,0],[-2,1,-1,0]]:[[2,-3,0,-1,1,-2],[-2,-3,0,-1,-1,-2],[2,3,0,1,1,2],[-2,3,0,1,-1,2],[3,-2,1,0,2,-1],[3,2,1,0,2,1],[-3,-2,-1,0,-2,-1],[-3,2,-1,0,-2,1]];r.forEach(v=>{if(!g(p.x+v[2],p.y+v[3])&&(p.t==='ma'||!g(p.x+v[4],p.y+v[5]))){const tx=p.x+v[0],ty=p.y+v[1];if(tx>=0&&tx<9&&ty>=0&&ty<10){const t=g(tx,ty);if(!t||t.f!==p.f)m.push({x:tx,y:ty,capture:!!t})}}})}if(p.t==='king'||p.t==='sa'){[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inp(nx,ny)){const t=g(nx,ny);if(!t||t.f!==p.f)m.push({x:nx,y:ny,capture:!!t})}});[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inp(nx,ny)&&(isc(p.x,p.y)||isc(nx,ny))){const t=g(nx,ny);if(!t||t.f!==p.f)m.push({x:nx,y:ny,capture:!!t})}})}if(p.t==='po'&&inp(p.x,p.y)){[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1],nnx=p.x+d[0]*2,nny=p.y+d[1]*2;if(inp(nx,ny)&&isc(nx,ny)){const s=g(nx,ny);if(s&&s.t!=='po'&&inp(nnx,nny)){const t=g(nnx,nny);if(!t)m.push({x:nnx,y:nny});else if(t.f!==p.f&&t.t!=='po')m.push({x:nnx,y:nny,capture:true})}}})}
        if(p.t==='cha'&&inp(p.x,p.y)){[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inp(nx,ny)&&(isc(p.x,p.y)||isc(nx,ny))){const t=g(nx,ny);if(!t||t.f!==p.f)m.push({x:nx,y:ny,capture:!!t});if(!t&&isc(p.x,p.y)){const nnx=p.x+d[0]*2,nny=p.y+d[1]*2;if(inp(nnx,nny)){const t2=g(nnx,nny);if(!t2||t2.f!==p.f)m.push({x:nnx,y:nny,capture:!!t2})}}}})}return m}
        sim(m){const{p,x,y}=m,ox=p.x,oy=p.y,ti=this.pieces.findIndex(t=>t.x===x&&t.y===y),c=ti!==-1?this.pieces[ti]:null;p.x=x;p.y=y;if(c)this.pieces.splice(ti,1);return{p,ox,oy,c,ti}}
        res(b){const{p,ox,oy,c,ti}=b;p.x=ox;p.y=oy;if(c)this.pieces.splice(ti,0,c)}
        updateUI(){const st=document.getElementById('turn-badge'),cai=document.getElementById('card-ai'),cuser=document.getElementById('card-user');if(this.turn==='cho'){st.innerText="ÎÇòÏùò Ï∞®Î°Ä";st.className="status-badge active";cuser.classList.add('active');cai.classList.remove('active')}else{st.innerText="AI ÏÉùÍ∞Å Ï§ë...";st.className="status-badge";cuser.classList.remove('active');cai.classList.add('active')}let sc=0,sh=1.5;const s={king:0,cha:13,po:7,ma:5,sang:3,sa:3,jol:2};this.pieces.forEach(p=>p.f==='cho'?sc+=s[p.t]:sh+=s[p.t]);document.getElementById('score-user').innerText=sc;document.getElementById('score-ai').innerText=sh;document.getElementById('undo-cnt').innerText=this.undoCount;document.getElementById('undo-btn').disabled = !this.canUndo || this.undoCount <= 0;}
        addCap(p){const el=document.createElement('div');el.className=`cap-item`;const tm=THEMES[currentTheme].janggi;el.style.background=tm.style==='real'?'radial-gradient(circle at 30% 30%, #e6d0a7, #bfa075)':tm.pieceBg;el.style.color=p.f==='cho'?tm.choC:tm.hanC;if(currentTheme==='mono'){el.style.background='#fff';el.style.color='#000';el.style.border='1px solid #000'}const map={king:'Áéã',cha:'Ëªä',po:'ÂåÖ',ma:'È¶¨',sang:'Ë±°',sa:'Â£´',jol:'Âçí'};el.innerText=map[p.t]||p.t[0];document.getElementById(this.turn==='cho'?'caps-user':'caps-ai').appendChild(el)}
        endGame(w){AudioSys.play('win');toast(w?"ÏäπÎ¶¨!":"Ìå®Î∞∞");setTimeout(()=>alert(w?"ÏäπÎ¶¨!":"Ìå®Î∞∞"),300)}
    }

    class BadukGame {
        constructor(d){this.diff=d;this.cols=19;this.rows=19;this.board=Array.from({length:19},()=>Array(19).fill(0));this.turn=1;this.caps={1:0,2:0};this.lastMove=null;this.koBan=null;this.history=[];
            this.undoCount=3; this.canUndo=false;
            this.updateUI();canvas.onclick=e=>this.onClick(e)
        }
        draw(){
            ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);const tm=THEMES[currentTheme];const{cs,mg}=this;
            if(woodPattern && tm.bgType==='wood') ctx.fillStyle=woodPattern; else ctx.fillStyle=tm.base;
            ctx.fillRect(0,0,canvas.width/dpr,canvas.height/dpr);
            ctx.strokeStyle=tm.line; ctx.lineWidth=1;for(let i=0;i<19;i++){ctx.beginPath();ctx.moveTo(mg+i*cs,mg);ctx.lineTo(mg+i*cs,mg+18*cs);ctx.stroke();ctx.beginPath();ctx.moveTo(mg,mg+i*cs);ctx.lineTo(mg+18*cs,mg+i*cs);ctx.stroke()}
            [3,9,15].forEach(x=>[3,9,15].forEach(y=>{ctx.beginPath();ctx.arc(mg+x*cs,mg+y*cs,3,0,Math.PI*2);ctx.fillStyle=tm.line;ctx.fill()}));
            if(this.lastMove){const{x,y}=this.lastMove;ctx.beginPath();ctx.arc(mg+x*cs,mg+y*cs,cs*.5,0,Math.PI*2);ctx.fillStyle=currentTheme==='mono'?'rgba(0,0,0,0.2)':'rgba(255,255,255,0.4)';ctx.fill()}
            const bt=tm.baduk;
            for(let y=0;y<19;y++)for(let x=0;x<19;x++)if(this.board[y][x]){
                const cx=mg+x*cs,cy=mg+y*cs; ctx.beginPath(); ctx.arc(cx,cy,cs/2-1,0,Math.PI*2);
                const c=this.board[y][x];
                if(bt.style==='real'){const g=ctx.createRadialGradient(cx-3,cy-3,2,cx,cy,12);if(c===1){g.addColorStop(0,'#555');g.addColorStop(1,'#000')}else{g.addColorStop(0,'#fff');g.addColorStop(1,'#ddd')}ctx.fillStyle=g}
                else{ctx.fillStyle=c===1?bt.b:bt.w;if(bt.s){ctx.strokeStyle=bt.s;ctx.stroke()}}
                ctx.fill()
            }
        }
        onClick(e){if(this.turn!==1)return;const r=canvas.getBoundingClientRect(),x=Math.round(((e.clientX-r.left)*(canvas.width/dpr/r.width)-this.mg)/this.cs),y=Math.round(((e.clientY-r.top)*(canvas.height/dpr/r.height)-this.mg)/this.cs);if(x>=0&&x<19&&y>=0&&y<19)this.place(x,y,1)}
        place(x,y,c){
            if(this.board[y][x]!==0)return;
            if(this.koBan&&this.koBan.x===x&&this.koBan.y===y){toast("Ìå®(Ko)!");return}
            
            const prevBoard = this.board.map(r=>[...r]);
            this.history.push({ board: prevBoard, lastMove: this.lastMove, caps: {...this.caps}, koBan: this.koBan, turn: this.turn });

            this.board[y][x]=c; const opp=c===1?2:1; let cp=[],ct=0;
            [[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=x+d[0],ny=y+d[1];if(nx>=0&&nx<19&&ny>=0&&ny<19&&this.board[ny][nx]===opp){if(!this.hasLib(nx,ny,opp))cp.push(...this.getGrp(nx,ny,opp))}});
            if(cp.length===0&&!this.hasLib(x,y,c)){this.board[y][x]=0;this.history.pop();return} // ÏûêÏ∂©Ïàò Î°§Î∞±
            
            this.lastMove={x,y};AudioSys.play('move');particles.spawn(this.mg+x*this.cs,this.mg+y*this.cs,c===1?THEMES[currentTheme].baduk.b:THEMES[currentTheme].baduk.w);
            if(cp.length>0){
                cp.forEach(p=>this.board[p.y][p.x]=0);this.caps[c]+=cp.length;
                // Dynamic Volume based on captured stones count (1 stone = 0.8, 5 stones = 1.2)
                const volScale = 0.8 + (cp.length / 10);
                AudioSys.play('capture', volScale);
                toast(cp.length+"Ï†ê ÌöçÎìù!");if(cp.length===1&&this.cntLib(x,y,c)===1)this.koBan={x:cp[0].x,y:cp[0].y};else this.koBan=null
            }else this.koBan=null;
            
            this.canUndo = true; // Allow undo
            this.turn=opp;this.updateUI();this.draw();
            if(this.turn===2)setTimeout(()=>this.aiMove(),100)
        }

        undo() {
            if(this.undoCount <= 0) { toast("Î¨¥Î•¥Í∏∞ ÌöüÏàò Ï¥àÍ≥º!"); return; }
            if(!this.canUndo) { toast("Ïó∞ÏÜç Î¨¥Î•¥Í∏∞ Î∂àÍ∞Ä!"); return; }
            if(this.turn === 'han') { toast("AIÍ∞Ä ÎëêÎäî Ï§ëÏûÖÎãàÎã§."); return; }
            if(this.history.length < 2) return;
            for(let i=0; i<2; i++) {
                const m = this.history.pop();
                const p = this.pieces && this.pieces.find(pc => pc.id === m.id); // For Janggi only, Baduk handled differently
                this.board = m.board; // Restore board state
                this.lastMove = m.lastMove;
                this.caps = m.caps;
                this.koBan = m.koBan;
            }
            this.turn = 1; this.undoCount--; this.canUndo = false;
            this.lastMove = this.history.length > 0 ? this.history[this.history.length-1] : null;
            this.gameOver = false;
            this.updateUI(); this.draw(); toast(`Î¨¥Î•¥Í∏∞ ÏôÑÎ£å (ÎÇ®ÏùÄ ÌöüÏàò: ${this.undoCount})`);
        }

        hasLib(x,y,c,v=new Set()){const k=x+','+y;if(v.has(k))return false;v.add(k);const ds=[[1,0],[-1,0],[0,1],[0,-1]];for(let d of ds){const nx=x+d[0],ny=y+d[1];if(nx<0||nx>=19||ny<0||ny>=19)continue;if(this.board[ny][nx]===0)return true;if(this.board[ny][nx]===c&&this.hasLib(nx,ny,c,v))return true}return false}
        cntLib(x,y,c){let l=0;[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=x+d[0],ny=y+d[1];if(nx>=0&&nx<19&&ny>=0&&ny<19&&this.board[ny][nx]===0)l++});return l}
        getGrp(x,y,c){let q=[{x,y}],g=[{x,y}],v=new Set([x+','+y]);while(q.length){const p=q.shift();[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(nx>=0&&nx<19&&ny>=0&&ny<19&&this.board[ny][nx]===c&&!v.has(nx+','+ny)){v.add(nx+','+ny);g.push({x:nx,y:ny});q.push({x:nx,y:ny})}})}return g}
        aiMove(){let m=[];for(let y=0;y<19;y++)for(let x=0;x<19;x++)if(this.board[y][x]===0)m.push({x,y});if(!m.length)return;if(this.diff==='god'||this.diff==='veryhard'){let best=-Infinity,bm=null;const cands=m.filter(p=>{if(this.diff==='veryhard')return true;for(let dy=-2;dy<=2;dy++)for(let dx=-2;dx<=2;dx++){const nx=p.x+dx,ny=p.y+dy;if(nx>=0&&nx<19&&ny>=0&&ny<19&&this.board[ny][nx]!==0)return true}return Math.random()<0.05});if(cands.length===0)cands.push(m[Math.floor(Math.random()*m.length)]);cands.forEach(p=>{this.board[p.y][p.x]=2;let s=Math.random();let cp=0;[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(nx>=0&&nx<19&&ny>=0&&ny<19&&this.board[ny][nx]===1&&!this.hasLib(nx,ny,1))cp++});s+=cp*50;if(!this.hasLib(p.x,p.y,2))s-=1000;s+=this.cntLib(p.x,p.y,2)*2;this.board[p.y][p.x]=0;if(s>best){best=s;bm=p}});if(bm)this.place(bm.x,bm.y,2);else this.place(m[0].x,m[0].y,2)}else{let best=null,max=-Infinity;m.forEach(p=>{if(this.koBan&&this.koBan.x===p.x&&this.koBan.y===p.y)return;let s=Math.random()*2;if(this.lastMove){const d=Math.abs(p.x-this.lastMove.x)+Math.abs(p.y-this.lastMove.y);if(d===1)s+=5;if(d<=2)s+=2}const dc=Math.abs(p.x-9)+Math.abs(p.y-9);s+=(20-dc)*.3;if(s>max){max=s;best=p}});if(best)this.place(best.x,best.y,2)}}
        updateUI(){const st=document.getElementById('turn-badge'),cai=document.getElementById('card-ai'),cuser=document.getElementById('card-user');if(this.turn===1){st.innerText="ÎÇòÏùò Ï∞®Î°Ä";st.className="status-badge active";cuser.classList.add('active');cai.classList.remove('active')}else{st.innerText="AI ÏÉùÍ∞Å Ï§ë...";st.className="status-badge";cuser.classList.remove('active');cai.classList.add('active')}document.getElementById('score-user').innerText=this.caps[1];document.getElementById('score-ai').innerText=this.caps[2];document.getElementById('undo-cnt').innerText=this.undoCount;document.getElementById('undo-btn').disabled = !this.canUndo || this.undoCount <= 0;}
    }
</script>
</body>
</html>
