<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ïû•Í∏∞ & Î∞îÎëë ÎßàÏä§ÌÑ∞ (Í≥µÏàòÎ∞∏Îü∞Ïä§ AI)</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #f59e0b; --text: #e2e8f0; }
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Pretendard', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header { height: 56px; background: var(--panel); border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 20; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .logo { font-weight: 900; font-size: 20px; color: var(--accent); letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        
        /* ÌÑ¥ ÌëúÏãúÍ∏∞ Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω */
        .status-pill { font-size: 13px; font-weight: 700; padding: 6px 14px; border-radius: 99px; background: #334155; color: #94a3b8; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .status-pill.active { background: #2563eb; color: white; box-shadow: 0 0 15px rgba(37, 99, 235, 0.5); }
        .status-pill.ai-turn { background: #dc2626; color: white; box-shadow: 0 0 15px rgba(220, 38, 38, 0.5); }
        .spinner { width: 12px; height: 12px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .layout { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        aside { width: 280px; background: #1e293b; border-right: 1px solid #334155; padding: 24px; display: flex; flex-direction: column; gap: 20px; z-index: 10; }
        .player-card { background: #0f172a; border-radius: 16px; padding: 20px; border: 1px solid #334155; position: relative; overflow: hidden; transition: all 0.3s; }
        .player-card.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3); transform: translateY(-2px); }
        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .p-name { font-size: 14px; font-weight: bold; color: #94a3b8; }
        .p-score { font-size: 28px; font-weight: 800; color: #fff; font-variant-numeric: tabular-nums; }
        .captures { display: flex; flex-wrap: wrap; gap: 6px; min-height: 30px; }
        .piece-icon { width: 28px; height: 28px; border-radius: 50%; background: #e2e8f0; border: 2px solid rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; box-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .piece-icon.red { color: #b91c1c; border-color: #b91c1c; background: #fee2e2; }
        .piece-icon.blue { color: #1d4ed8; border-color: #1d4ed8; background: #dbeafe; }

        @media (max-width: 800px) {
            .layout { flex-direction: column; }
            aside { width: 100%; height: auto; flex-direction: row; padding: 12px; border-right: none; border-bottom: 1px solid #334155; }
            .player-card { flex: 1; padding: 12px; border-radius: 12px; }
            .p-score { font-size: 20px; }
            .piece-icon { width: 20px; height: 20px; font-size: 10px; }
        }

        .board-area { flex: 1; background: #020617; display: flex; align-items: center; justify-content: center; position: relative; }
        canvas { background-color: #d97706; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border-radius: 6px; cursor: pointer; }

        .overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        .overlay.hidden { opacity: 0; pointer-events: none; }
        .menu-title { font-size: 40px; font-weight: 900; color: var(--accent); margin-bottom: 40px; letter-spacing: -1px; text-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 500px; padding: 0 20px; }
        .menu-btn { background: #1e293b; border: 1px solid #334155; padding: 30px; border-radius: 20px; color: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .menu-btn:hover { border-color: var(--accent); transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3); }
        .menu-btn.janggi { background: linear-gradient(145deg, #1e293b, #0f172a); }
        .menu-btn.baduk { background: linear-gradient(145deg, #334155, #1e293b); }

        .toast { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: rgba(220, 38, 38, 0.9); color: white; padding: 15px 30px; border-radius: 99px; font-size: 20px; font-weight: bold; opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; z-index: 50; box-shadow: 0 10px 25px -5px rgba(220, 38, 38, 0.5); border: 2px solid rgba(255,255,255,0.2); }
        .toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .toast.success { background: #16a34a; box-shadow: 0 10px 25px -5px rgba(22, 163, 74, 0.5); }
    </style>
</head>
<body>

<header>
    <div class="logo"><span>üß†</span> AI BOARD PRO</div>
    <div id="status-pill" class="status-pill">Í≤åÏûÑ ÎåÄÍ∏∞ Ï§ë</div>
    <button onclick="goHome()" style="background:transparent; border:1px solid #475569; color:#94a3b8; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px;">ÎÇòÍ∞ÄÍ∏∞</button>
</header>

<div id="main-menu" class="overlay">
    <div class="menu-title">Í≤åÏûÑ ÏÑ†ÌÉù</div>
    <div class="btn-grid">
        <button class="menu-btn janggi" onclick="startGame('janggi')">
            <h3 style="margin:0;font-size:24px">Ïû•Í∏∞</h3><p style="margin:0;font-size:12px;opacity:0.7">ÏàòÎπÑ ÏïåÍ≥†Î¶¨Ï¶ò Í∞ïÌôî</p>
        </button>
        <button class="menu-btn baduk" onclick="startGame('baduk')">
            <h3 style="margin:0;font-size:24px">Î∞îÎëë</h3><p style="margin:0;font-size:12px;opacity:0.7">Ï†ÑÌà¨Ìòï AI</p>
        </button>
    </div>
</div>

<div class="layout">
    <aside>
        <div id="card-ai" class="player-card">
            <div class="card-top"><span class="p-name" style="color:#f87171">AI (Ìïú/Î∞±)</span><span id="score-ai" class="p-score">0</span></div>
            <div id="caps-ai" class="captures"></div>
        </div>
        <div id="card-user" class="player-card">
            <div class="card-top"><span class="p-name" style="color:#60a5fa">ÎÇò (Ï¥à/Ìùë)</span><span id="score-user" class="p-score">0</span></div>
            <div id="caps-user" class="captures"></div>
        </div>
    </aside>
    <div class="board-area" id="board-wrap">
        <canvas id="gameCanvas"></canvas>
        <div id="toast" class="toast">Î©îÏãúÏßÄ</div>
    </div>
</div>

<script>
    // --- Ïú†Ìã∏Î¶¨Ìã∞ ---
    const AudioSys = {
        ctx: null,
        init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
        play(type) {
            if(!this.ctx) this.init(); if(this.ctx.state === 'suspended') this.ctx.resume();
            const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            if(type==='move'){ osc.type='triangle'; osc.frequency.setValueAtTime(200,t); osc.frequency.exponentialRampToValueAtTime(50,t+0.1); gain.gain.setValueAtTime(0.3,t); gain.gain.linearRampToValueAtTime(0,t+0.1); }
            else if(type==='capture'){ osc.type='square'; osc.frequency.setValueAtTime(150,t); osc.frequency.exponentialRampToValueAtTime(40,t+0.15); gain.gain.setValueAtTime(0.4,t); gain.gain.linearRampToValueAtTime(0,t+0.15); }
            else if(type==='win'){ osc.type='sine'; osc.frequency.setValueAtTime(440,t); osc.frequency.linearRampToValueAtTime(880,t+0.3); gain.gain.setValueAtTime(0.2,t); gain.gain.linearRampToValueAtTime(0,t+0.5); }
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(t); osc.stop(t+0.5);
        }
    };
    class ParticleSystem {
        constructor(){this.p=[]} spawn(x,y,c){for(let i=0;i<12;i++)this.p.push({x,y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:1,c});}
        update(){for(let i=this.p.length-1;i>=0;i--){let k=this.p[i];k.x+=k.vx;k.y+=k.vy;k.life-=0.05;if(k.life<=0)this.p.splice(i,1);}}
        draw(c){this.p.forEach(k=>{c.globalAlpha=k.life;c.fillStyle=k.c;c.beginPath();c.arc(k.x,k.y,3,0,Math.PI*2);c.fill();});c.globalAlpha=1;}
    }

    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d'); const wrap = document.getElementById('board-wrap');
    let game = null; let particles = new ParticleSystem(); let dpr = window.devicePixelRatio || 1; let loopId = null;

    function startGame(mode) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('caps-ai').innerHTML=''; document.getElementById('caps-user').innerHTML='';
        AudioSys.init();
        if(mode==='janggi') game = new JanggiGame(); else game = new BadukGame();
        resize(); if(loopId) cancelAnimationFrame(loopId); loop();
    }
    function goHome(){ document.getElementById('main-menu').classList.remove('hidden'); game=null; }
    function toast(msg, type='normal'){ const e=document.getElementById('toast');e.innerText=msg;e.className=`toast show ${type}`;setTimeout(()=>e.classList.remove('show'),2000); }
    function resize(){ if(!game)return; const w=wrap.clientWidth, h=wrap.clientHeight, pad=30; const sz=Math.floor(Math.min((w-pad)/(game.cols+1), (h-pad)/(game.rows+1))); game.cs=sz; game.mg=Math.floor(sz*0.8); const bw=game.mg*2+(game.cols-1)*sz, bh=game.mg*2+(game.rows-1)*sz; canvas.style.width=bw+'px'; canvas.style.height=bh+'px'; canvas.width=bw*dpr; canvas.height=bh*dpr; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); }
    window.addEventListener('resize', ()=>requestAnimationFrame(resize));
    function loop(){ if(game){game.draw();particles.update();particles.draw(ctx);} loopId=requestAnimationFrame(loop); }

    // ==========================================
    //  Ïû•Í∏∞ (Í∞ïÌôîÎêú ÏàòÎπÑÌòï AI ÌÉëÏû¨)
    // ==========================================
    class JanggiGame {
        constructor() {
            this.cols=9; this.rows=10; this.pieces=[]; this.turn='cho';
            this.selected=null; this.moves=[]; this.lastMove=null; this.history=[];
            this.setup(); this.updateUI();
            canvas.onclick=e=>this.onClick(e);
        }
        setup() {
            const map=['cha','ma','sang','sa','','sa','sang','ma','cha']; const add=(t,x,y,f)=>this.pieces.push({t,x,y,f,id:Math.random()});
            map.forEach((t,x)=>t&&add(t,x,0,'han')); add('king',4,1,'han'); add('po',1,2,'han'); add('po',7,2,'han'); [0,2,4,6,8].forEach(x=>add('jol',x,3,'han'));
            map.forEach((t,x)=>t&&add(t,x,9,'cho')); add('king',4,8,'cho'); add('po',1,7,'cho'); add('po',7,7,'cho'); [0,2,4,6,8].forEach(x=>add('jol',x,6,'cho'));
        }
        
        // --- Î†åÎçîÎßÅ ---
        draw() {
            ctx.clearRect(0,0,canvas.width/dpr, canvas.height/dpr); const {cs,mg}=this;
            ctx.strokeStyle='#5d4037'; ctx.lineWidth=1.5;
            for(let i=0;i<9;i++){ctx.beginPath();ctx.moveTo(mg+i*cs,mg);ctx.lineTo(mg+i*cs,mg+9*cs);ctx.stroke();}
            for(let i=0;i<10;i++){ctx.beginPath();ctx.moveTo(mg,mg+i*cs);ctx.lineTo(mg+8*cs,mg+i*cs);ctx.stroke();}
            const pal=(r,c)=>{ctx.beginPath();ctx.moveTo(mg+c*cs,mg+r*cs);ctx.lineTo(mg+(c+2)*cs,mg+(r+2)*cs);ctx.stroke();ctx.beginPath();ctx.moveTo(mg+(c+2)*cs,mg+r*cs);ctx.lineTo(mg+c*cs,mg+(r+2)*cs);ctx.stroke();}; pal(0,3); pal(7,3);
            if(this.lastMove){ const {fx,fy,tx,ty}=this.lastMove; ctx.fillStyle='rgba(255,255,255,0.2)'; ctx.fillRect(mg+fx*cs-cs/2,mg+fy*cs-cs/2,cs,cs); ctx.fillRect(mg+tx*cs-cs/2,mg+ty*cs-cs/2,cs,cs); }
            this.moves.forEach(m=>{ const mx=mg+m.x*cs,my=mg+m.y*cs; if(m.capture){ctx.strokeStyle='#ef4444';ctx.lineWidth=3;ctx.beginPath();ctx.arc(mx,my,cs*0.4,0,Math.PI*2);ctx.stroke();}else{ctx.fillStyle='rgba(16,185,129,0.6)';ctx.beginPath();ctx.arc(mx,my,cs*0.15,0,Math.PI*2);ctx.fill();} });
            this.pieces.forEach(p=>{
                const cx=mg+p.x*cs, cy=mg+p.y*cs; let r=cs*0.4; if(p.t==='king')r*=1.15; if(['sa','jol'].includes(p.t))r*=0.85;
                ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle='#eaddcf';ctx.shadowColor='rgba(0,0,0,0.3)';ctx.shadowBlur=4;ctx.shadowOffsetY=3;ctx.fill();ctx.shadowBlur=0;ctx.shadowOffsetY=0;
                const col=p.f==='cho'?'#1d4ed8':'#b91c1c'; ctx.lineWidth=this.selected===p?3:2; ctx.strokeStyle=this.selected===p?'#10b981':col; ctx.stroke();
                ctx.fillStyle=col; ctx.font=`700 ${r*1.1}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; const map={king:p.f==='cho'?'Ê•ö':'Êº¢',cha:'Ëªä',po:'ÂåÖ',ma:'È¶¨',sang:'Ë±°',sa:'Â£´',jol:p.f==='cho'?'Âçí':'ÂÖµ'}; ctx.fillText(map[p.t],cx,cy+r*0.1);
            });
        }

        onClick(e) {
            if(this.turn!=='cho') return;
            const r=canvas.getBoundingClientRect(); const x=Math.round(((e.clientX-r.left)*(canvas.width/dpr/r.width)-this.mg)/this.cs); const y=Math.round(((e.clientY-r.top)*(canvas.height/dpr/r.height)-this.mg)/this.cs);
            if(x<0||x>8||y<0||y>9) return;
            const p=this.pieces.find(pp=>pp.x===x&&pp.y===y);
            if(p&&p.f==='cho'){ this.selected=p; this.moves=this.getLegalMoves(p); return; }
            if(this.selected){ const m=this.moves.find(mv=>mv.x===x&&mv.y===y); if(m)this.execute(this.selected,x,y); else{this.selected=null;this.moves=[];} }
        }

        execute(p,x,y) {
            const ti=this.pieces.findIndex(t=>t.x===x&&t.y===y); const cap=ti!==-1?this.pieces[ti]:null;
            if(cap){ this.pieces.splice(ti,1); this.addCap(cap); AudioSys.play('capture'); particles.spawn(this.mg+x*this.cs,this.mg+y*this.cs,'#ef4444'); } else AudioSys.play('move');
            this.lastMove={fx:p.x,fy:p.y,tx:x,ty:y}; this.history.push(this.lastMove); p.x=x; p.y=y;
            this.selected=null; this.moves=[];
            if(cap&&cap.t==='king'){ this.endGame(true); return; }
            this.turn=this.turn==='cho'?'han':'cho'; this.updateUI();
            
            // Ïô∏ÌÜµÏàò Ï≤¥ÌÅ¨
            if(this.isCheck(this.turn)){
                toast("Ïû•Íµ∞!", "normal");
                if(this.isCheckmate(this.turn)){ setTimeout(()=>this.endGame(this.turn!=='cho'),200); return; }
            } else if (this.isCheckmate(this.turn)) { // Ïä§ÌÖåÏùºÎ©îÏù¥Ìä∏ (Ïù¥ÎèôÎ∂àÍ∞Ä)
                 setTimeout(()=>this.endGame(this.turn!=='cho'),200); return;
            }

            if(this.turn==='han') setTimeout(()=>this.aiTurn(), 100);
        }

        // --- üß† AI ÌïµÏã¨ Î°úÏßÅ (Minimax + ÏàòÏùΩÍ∏∞) ---
        aiTurn() {
            // 1. Ï°±Î≥¥ (Opening Book)
            const h=this.history.length;
            if(h===1) { this.execAI(7,0,6,2); return; } // Îßà ÏßÑÏ∂ú
            if(h===3) { this.execAI(7,2,4,2); return; } // Î©¥Ìè¨
            if(h===5) { this.execAI(0,3,1,3); return; } // Ï°∏ Ïì∏Í∏∞

            // 2. ÏàòÏùΩÍ∏∞ (Minimax with Alpha-Beta)
            // Î∏åÎùºÏö∞Ï†Ä ÏÑ±Îä•ÏùÑ Í≥†Î†§Ìï¥ depthÎäî 2 (ÎÇòÏùòÏàò -> Ï†ÅÏùòÏàò -> ÌåêÎã®)
            const depth = 2;
            const best = this.minimax(depth, -Infinity, Infinity, true);
            
            if(best.move) {
                this.execute(best.move.p, best.move.x, best.move.y);
            } else {
                this.endGame(true); // Í∏∞Í∂å
            }
        }

        execAI(fx,fy,tx,ty) {
            const p=this.pieces.find(pp=>pp.x===fx&&pp.y===fy&&pp.f==='han');
            if(p) this.execute(p,tx,ty);
        }

        // Minimax ÏïåÍ≥†Î¶¨Ï¶ò
        minimax(depth, alpha, beta, isMax) {
            if (depth === 0) return { score: this.evalBoard() };

            const faction = isMax ? 'han' : 'cho';
            const myPieces = this.pieces.filter(p => p.f === faction);
            let bestMove = null;
            let bestScore = isMax ? -Infinity : Infinity;

            // Î™®Îì† Í∏∞Î¨ºÏùò Î™®Îì† Ìï©Î≤ïÏ†Å Ïù¥Îèô ÏÉùÏÑ±
            let allMoves = [];
            for(let p of myPieces) {
                const moves = this.getLegalMoves(p);
                for(let m of moves) allMoves.push({p, x:m.x, y:m.y});
            }

            if(allMoves.length === 0) {
                return { score: isMax ? -100000 : 100000 }; // Ïô∏ÌÜµÏàò Ï†êÏàò
            }

            // Move Ordering (ÏµúÏ†ÅÌôî): Ïû°Îäî ÏàòÎ•º Î®ºÏ†Ä Í≥ÑÏÇ∞
            allMoves.sort((a,b) => {
                const ta = this.pieces.find(t=>t.x===a.x && t.y===a.y);
                const tb = this.pieces.find(t=>t.x===b.x && t.y===b.y);
                const sa = ta ? (ta.t==='king'?900:10) : 0;
                const sb = tb ? (tb.t==='king'?900:10) : 0;
                return sb - sa;
            });

            for(let move of allMoves) {
                const backup = this.sim(move); // Í∞ÄÏÉÅ Ïù¥Îèô
                
                // Ïû¨Í∑Ä Ìò∏Ï∂ú
                const val = this.minimax(depth - 1, alpha, beta, !isMax).score;
                
                this.restore(backup); // ÏõêÎ≥µ

                if (isMax) {
                    if (val > bestScore) { bestScore = val; bestMove = move; }
                    alpha = Math.max(alpha, val);
                } else {
                    if (val < bestScore) { bestScore = val; bestMove = move; }
                    beta = Math.min(beta, val);
                }
                if (beta <= alpha) break; // Í∞ÄÏßÄÏπòÍ∏∞
            }
            return { score: bestScore, move: bestMove };
        }

        // ÌèâÍ∞Ä Ìï®Ïàò (Í≥µÏàò Î∞∏Îü∞Ïä§)
        evalBoard() {
            const s = {king:1000, cha:13, po:7, ma:5, sang:3, sa:3, jol:2};
            let score = 0;
            
            this.pieces.forEach(p => {
                let val = s[p.t];
                
                // 1. ÏúÑÏπò Í∞ÄÏÇ∞Ï†ê (Ï§ëÏïô Ï†úÏñ¥)
                if (p.t==='po' && p.x===4) val += 1; // Î©¥Ìè¨
                if (p.t==='ma' && p.x===4 && p.y===4) val += 1; // Ï§ëÏïôÎßà
                
                // 2. ÏúÑÌòë Î∞õÎäî Ï†êÏàò Í∞êÏÇ∞ (ÏàòÎπÑÏ†Å ÏöîÏÜå)
                // ÌòÑÏû¨ ÏÉÅÌÉúÏóêÏÑú Ïù¥ Í∏∞Î¨ºÏù¥ Ï†ÅÏóêÍ≤å Í≥µÍ≤©Î∞õÍ≥† ÏûàÎäîÏßÄ Í∞ÑÎã® Ï≤¥ÌÅ¨
                // (ÏôÑÎ≤ΩÌïú ÏàòÏùΩÍ∏∞Îäî minimaxÍ∞Ä ÌïòÏßÄÎßå, Ï†ïÏ†Å ÌèâÍ∞ÄÏóêÏÑúÎèÑ ÏúÑÌóòÎèÑ Î∞òÏòÅ)
                // ÏÑ±Îä•ÏÉÅ ÏÉùÎûµÌïòÍ±∞ÎÇò, ÏïÑÏ£º Í∞ÑÎã®ÌûàÎßå Ï≤¥ÌÅ¨ Í∞ÄÎä•. 
                // Ïó¨Í∏∞ÏÑúÎäî MinimaxÍ∞Ä Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Í∏∞Î≥∏ Ï†êÏàòÎßå Í≥ÑÏÇ∞Ìï©ÎãàÎã§.

                if (p.f === 'han') score += val; else score -= val;
            });
            return score;
        }

        // --- Î£∞ & Ïù¥Îèô Î°úÏßÅ ---
        getLegalMoves(p) {
            return this.getRawMoves(p).filter(m => {
                const b=this.sim({p,x:m.x,y:m.y});
                const safe=!this.isCheck(p.f);
                this.restore(b);
                return safe;
            });
        }
        isCheck(f) {
            const k=this.pieces.find(p=>p.f===f&&p.t==='king'); if(!k)return true;
            const ens=this.pieces.filter(p=>p.f!==f);
            for(const e of ens) if(this.getRawMoves(e).some(m=>m.x===k.x&&m.y===k.y)) return true;
            return false;
        }
        isCheckmate(f) { return !this.pieces.filter(p=>p.f===f).some(p=>this.getLegalMoves(p).length>0); }

        getRawMoves(p) {
            let m=[]; const get=(x,y)=>this.pieces.find(t=>t.x===x&&t.y===y);
            const inP=(x,y)=>{if(x<3||x>5)return false; return p.f==='han'?(y>=0&&y<=2):(y>=7&&y<=9);};
            const scan=(dx,dy,lim=10,j=false)=>{
                let nx=p.x,ny=p.y,jp=false;
                for(let i=0;i<lim;i++){
                    nx+=dx;ny+=dy; if(nx<0||nx>8||ny<0||ny>9)break; const t=get(nx,ny);
                    if(j){ if(!jp){if(t){if(t.t==='po')break;jp=true;}} else{if(t){if(t.f!==p.f&&t.t!=='po')m.push({x:nx,y:ny,capture:true});break;}m.push({x:nx,y:ny});} }
                    else{ if(t){if(t.f!==p.f)m.push({x:nx,y:ny,capture:true});break;}m.push({x:nx,y:ny}); }
                }
            };
            if(p.t==='cha')[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>scan(d[0],d[1]));
            if(p.t==='po')[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>scan(d[0],d[1],10,true));
            if(p.t==='jol'){ const dy=p.f==='cho'?-1:1; [[0,dy],[1,0],[-1,0]].forEach(d=>scan(d[0],d[1],1)); if(inP(p.x,p.y))[[1,dy],[-1,dy]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inP(nx,ny)&&(p.x===4||nx===4))scan(d[0],d[1],1);}); }
            if(p.t==='ma'||p.t==='sang'){
                const r=p.t==='ma'?[[1,-2,0,-1],[-1,-2,0,-1],[1,2,0,1],[-1,2,0,1],[2,-1,1,0],[2,1,1,0],[-2,-1,-1,0],[-2,1,-1,0]]:[[2,-3,0,-1,1,-2],[-2,-3,0,-1,-1,-2],[2,3,0,1,1,2],[-2,3,0,1,-1,2],[3,-2,1,0,2,-1],[3,2,1,0,2,1],[-3,-2,-1,0,-2,-1],[-3,2,-1,0,-2,1]];
                r.forEach(v=>{if(!get(p.x+v[2],p.y+v[3])&&(p.t==='ma'||!get(p.x+v[4],p.y+v[5]))){const tx=p.x+v[0],ty=p.y+v[1];if(tx>=0&&tx<9&&ty>=0&&ty<10){const t=get(tx,ty);if(!t||t.f!==p.f)m.push({x:tx,y:ty,capture:!!t});}}});
            }
            if(p.t==='king'||p.t==='sa'){
                [[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inP(nx,ny)){const t=get(nx,ny);if(!t||t.f!==p.f)m.push({x:nx,y:ny,capture:!!t});}});
                [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{const nx=p.x+d[0],ny=p.y+d[1];if(inP(nx,ny)&&(p.x===4||nx===4)){const t=get(nx,ny);if(!t||t.f!==p.f)m.push({x:nx,y:ny,capture:!!t});}});
            }
            if(p.t==='po'&&inP(p.x,p.y)){
                [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{
                    const nx=p.x+d[0],ny=p.y+d[1]; const nnx=p.x+d[0]*2,nny=p.y+d[1]*2;
                    if(inP(nx,ny)&&nx===4){ const s=get(nx,ny); if(s&&s.t!=='po'&&inP(nnx,nny)){ const t=get(nnx,nny); if(!t)m.push({x:nnx,y:nny}); else if(t.f!==p.f&&t.t!=='po')m.push({x:nnx,y:nny,capture:true}); }}
                });
            }
            return m;
        }
        sim(m){const{p,x,y}=m;const ox=p.x,oy=p.y;const ti=this.pieces.findIndex(t=>t.x===x&&t.y===y);const c=ti!==-1?this.pieces[ti]:null;p.x=x;p.y=y;if(c)this.pieces.splice(ti,1);return{p,ox,oy,c,ti};}
        restore(b){const{p,ox,oy,c,ti}=b;p.x=ox;p.y=oy;if(c)this.pieces.splice(ti,0,c);}
        
        updateUI() {
            const st=document.getElementById('status-pill');
            if(this.turn==='cho'){ st.innerHTML='ÎÇòÏùò Ï∞®Î°Ä'; st.className='status-pill active'; document.getElementById('card-user').classList.add('active'); document.getElementById('card-ai').classList.remove('active'); }
            else{ st.innerHTML='<span class="spinner"></span> AI ÏÉùÍ∞Å Ï§ë...'; st.className='status-pill ai-turn'; document.getElementById('card-user').classList.remove('active'); document.getElementById('card-ai').classList.add('active'); }
            let sc=0, sh=1.5; const s={king:0, cha:13, po:7, ma:5, sang:3, sa:3, jol:2};
            this.pieces.forEach(p=>p.f==='cho'?sc+=s[p.t]:sh+=s[p.t]); document.getElementById('score-user').innerText=sc; document.getElementById('score-ai').innerText=sh;
        }
        addCap(p) {
            const el=document.createElement('div'); el.className=`piece-icon ${p.f==='cho'?'blue':'red'}`; const map={king:'Áéã',cha:'Ëªä',po:'ÂåÖ',ma:'È¶¨',sang:'Ë±°',sa:'Â£´',jol:'Âçí'}; el.innerText=map[p.t]||p.t[0]; document.getElementById(this.turn==='cho'?'caps-user':'caps-ai').appendChild(el);
        }
        endGame(win) { AudioSys.play('win'); toast(win?"ÏäπÎ¶¨!":"Ìå®Î∞∞", win?"success":"normal"); setTimeout(()=>alert(win?"ÏäπÎ¶¨!":"Ìå®Î∞∞"), 300); }
    }

    // ==========================================
    //  Î∞îÎëë (Í∏∞Ï°¥ Ïú†ÏßÄ)
    // ==========================================
    class BadukGame {
        constructor(){this.cols=19;this.rows=19;this.board=Array.from({length:19},()=>Array(19).fill(0));this.turn=1;this.caps={1:0,2:0};this.lastMove=null;this.updateUI();canvas.onclick=e=>this.onClick(e);}
        draw(){
            ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);const{cs,mg}=this;ctx.strokeStyle='#000';ctx.lineWidth=1;
            for(let i=0;i<19;i++){ctx.beginPath();ctx.moveTo(mg+i*cs,mg);ctx.lineTo(mg+i*cs,mg+18*cs);ctx.stroke();ctx.beginPath();ctx.moveTo(mg,mg+i*cs);ctx.lineTo(mg+18*cs,mg+i*cs);ctx.stroke();}
            [3,9,15].forEach(x=>[3,9,15].forEach(y=>{ctx.beginPath();ctx.arc(mg+x*cs,mg+y*cs,2.5,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();}));
            if(this.lastMove){const{x,y}=this.lastMove;ctx.beginPath();ctx.arc(mg+x*cs,mg+y*cs,cs*0.5,0,Math.PI*2);ctx.fillStyle='rgba(255,0,0,0.3)';ctx.fill();}
            for(let y=0;y<19;y++)for(let x=0;x<19;x++)if(this.board[y][x]){const cx=mg+x*cs,cy=mg+y*cs;ctx.beginPath();ctx.arc(cx,cy,cs/2-1,0,Math.PI*2);const c=this.board[y][x],g=ctx.createRadialGradient(cx-2,cy-2,1,cx,cy,10);if(c===1){g.addColorStop(0,'#444');g.addColorStop(1,'#000');}else{g.addColorStop(0,'#fff');g.addColorStop(1,'#ddd');}ctx.fillStyle=g;ctx.fill();}
        }
        onClick(e){if(this.turn!==1)return;const r=canvas.getBoundingClientRect(),x=Math.round(((e.clientX-r.left)*(canvas.width/dpr/r.width)-this.mg)/this.cs),y=Math.round(((e.clientY-r.top)*(canvas.height/dpr/r.height)-this.mg)/this.cs);if(x>=0&&x<19&&y>=0&&y<19&&this.board[y][x]===0)this.place(x,y,1);}
        place(x,y,c){
            this.board[y][x]=c;this.lastMove={x,y};AudioSys.play('move');particles.spawn(this.mg+x*this.cs,this.mg+y*this.cs,c===1?'#000':'#fff');
            const opp=c===1?2:1;let cap=0;[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=x+d[0],ny=y+d[1];if(nx>=0&&nx<19&&ny>=0&&ny<19&&this.board[ny][nx]===opp)if(!this.hasLib(nx,ny,opp))cap+=this.remove(nx,ny,opp);});
            if(cap>0){this.caps[c]+=cap;AudioSys.play('capture');toast(cap+"Ï†ê ÌöçÎìù!", "success");}else if(!this.hasLib(x,y,c))this.remove(x,y,c);
            this.turn=opp;this.updateUI();this.draw();if(this.turn===2)setTimeout(()=>this.aiMove(),100);
        }
        hasLib(x,y,c,v=new Set()){const k=x+','+y;if(v.has(k))return false;v.add(k);const ds=[[1,0],[-1,0],[0,1],[0,-1]];for(let d of ds){const nx=x+d[0],ny=y+d[1];if(nx<0||nx>=19||ny<0||ny>=19)continue;if(this.board[ny][nx]===0)return true;if(this.board[ny][nx]===c&&this.hasLib(nx,ny,c,v))return true;}return false;}
        remove(x,y,c){const q=[[x,y]];this.board[y][x]=0;let cnt=1;while(q.length){const[cx,cy]=q.shift();[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=cx+d[0],ny=cy+d[1];if(nx>=0&&nx<19&&ny>=0&&ny<19&&this.board[ny][nx]===c){this.board[ny][nx]=0;cnt++;q.push([nx,ny]);}});}return cnt;}
        aiMove(){let m=[];for(let y=0;y<19;y++)for(let x=0;x<19;x++)if(this.board[y][x]===0)m.push({x,y});if(!m.length)return;let best=null,max=-Infinity;m.forEach(p=>{let s=Math.random()*2;if(this.lastMove){const d=Math.abs(p.x-this.lastMove.x)+Math.abs(p.y-this.lastMove.y);if(d===1)s+=5;if(d<=2)s+=2;}const dc=Math.abs(p.x-9)+Math.abs(p.y-9);s+=(20-dc)*0.3;if(s>max){max=s;best=p;}});this.place(best.x,best.y,2);}
        updateUI(){const st=document.getElementById('status-pill');const cAi=document.getElementById('card-ai');const cUser=document.getElementById('card-user');if(this.turn===1){st.innerText="ÎÇòÏùò Ï∞®Î°Ä";st.className="status-pill active";cUser.classList.add('active');cAi.classList.remove('active');}else{st.innerText="AI ÏÉùÍ∞Å Ï§ë";st.className="status-pill ai-turn";cUser.classList.remove('active');cAi.classList.add('active');}document.getElementById('score-user').innerText=this.caps[1];document.getElementById('score-ai').innerText=this.caps[2];}
    }
</script>
</body>
</html>
