<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Drone Evolution</title>
    <style>
        body {
            background-color: #222;
            color: white;
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        canvas {
            background-color: #333;
            border: 2px solid #555;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .controls {
            margin-top: 15px;
            background: #444;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .stat-box {
            text-align: center;
        }
        .highlight {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2em;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1em;
        }
        button:hover { background-color: #45a049; }
    </style>
</head>
<body>

    <h1>ğŸš€ AI Drone Evolution</h1>
    <canvas id="gameCanvas" width="800" height="500"></canvas>

    <div class="controls">
        <div class="stat-box">
            ì„¸ëŒ€(Generation): <span id="genCount" class="highlight">1</span>
        </div>
        <div class="stat-box">
            ìƒì¡´: <span id="aliveCount">0</span> / <span id="totalCount">0</span>
        </div>
        <div class="stat-box">
            ìµœê³  ì ìˆ˜: <span id="bestScore">0</span>
        </div>
        <div style="border-left: 1px solid #666; padding-left: 20px;">
            <label for="speedSlider">í•™ìŠµ ì†ë„:</label>
            <input type="range" id="speedSlider" min="1" max="10" value="1">
            <span id="speedDisplay">x1</span>
        </div>
        <button onclick="resetSimulation()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
    </div>

    <script>
        // --- 1. AI ë‘ë‡Œ (Neural Network) ---
        class NeuralNetwork {
            constructor(brain = null) {
                if (brain) {
                    // ë¶€ëª¨ì˜ ë‡Œë¥¼ ë³µì‚¬ (ê¹Šì€ ë³µì‚¬)
                    this.weights = brain.weights.map(w => w); 
                    this.bias = brain.bias;
                } else {
                    // ìƒˆë¡œìš´ ë‡Œ ìƒì„± (ëœë¤ ê°€ì¤‘ì¹˜)
                    // ì…ë ¥: 4ê°œ (yìœ„ì¹˜, yì†ë„, ì¥ì• ë¬¼ ê±°ë¦¬, ì¥ì• ë¬¼ êµ¬ë© y)
                    // ì¶œë ¥: 1ê°œ (ì í”„í•  í™•ë¥ )
                    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ë‹¨ì¸µ í¼ì…‰íŠ¸ë¡  êµ¬ì¡° ì‚¬ìš© (ì…ë ¥ 4ê°œ -> ì¶œë ¥ 1ê°œ)
                    this.weights = Array(4).fill(0).map(() => Math.random() * 2 - 1);
                    this.bias = Math.random() * 2 - 1;
                }
            }

            predict(inputs) {
                // ì…ë ¥ê°’ * ê°€ì¤‘ì¹˜ + í¸í–¥
                let sum = this.bias;
                for (let i = 0; i < this.weights.length; i++) {
                    sum += inputs[i] * this.weights[i];
                }
                // í™œì„±í™” í•¨ìˆ˜ (Sigmoid): ê²°ê³¼ë¥¼ 0~1 ì‚¬ì´ë¡œ ë³€í™˜
                return 1 / (1 + Math.exp(-sum));
            }

            mutate(rate) {
                // ëŒì—°ë³€ì´: ê°€ë”ì”© ê°€ì¤‘ì¹˜ë¥¼ ëœë¤í•˜ê²Œ ë³€ê²½
                this.weights = this.weights.map(w => {
                    if (Math.random() < rate) {
                        return w + (Math.random() * 0.4 - 0.2); // ì¡°ê¸ˆ ìˆ˜ì •
                    }
                    return w;
                });
                if (Math.random() < rate) {
                    this.bias += (Math.random() * 0.4 - 0.2);
                }
            }
        }

        // --- 2. ë¹„í–‰ê¸° (Drone) ê°ì²´ ---
        class Drone {
            constructor(brain = null) {
                this.y = canvas.height / 2;
                this.x = 100;
                this.velocity = 0;
                this.gravity = 0.6;
                this.lift = -10; // ì í”„ í˜
                this.brain = new NeuralNetwork(brain);
                
                this.alive = true;
                this.score = 0;
                this.fitness = 0;
            }

            update(pipes) {
                if (!this.alive) return;

                this.score++;
                
                // ë¬¼ë¦¬ ì ìš©
                this.velocity += this.gravity;
                this.y += this.velocity;

                // AIì˜ ìƒê° (Think)
                // ê°€ì¥ ê°€ê¹Œìš´ ì¥ì• ë¬¼ ì°¾ê¸°
                let closestPipe = null;
                let closestDist = Infinity;
                
                for (let pipe of pipes) {
                    let d = (pipe.x + pipe.width) - this.x;
                    if (d > 0 && d < closestDist) {
                        closestPipe = pipe;
                        closestDist = d;
                    }
                }

                if (closestPipe) {
                    // AIì—ê²Œ ì¤„ ì…ë ¥ ë°ì´í„° ì •ê·œí™” (0~1 ì‚¬ì´ ê°’ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ë©´ í•™ìŠµì´ ì˜ ë¨)
                    let inputs = [
                        this.y / canvas.height,             // ë‚´ ë†’ì´
                        this.velocity / 10,                 // ë‚´ ì†ë„
                        closestDist / canvas.width,         // ì¥ì• ë¬¼ ê±°ë¦¬
                        closestPipe.top / canvas.height     // êµ¬ë©ì˜ ì‹œì‘ ë†’ì´
                    ];

                    let output = this.brain.predict(inputs);
                    if (output > 0.5) {
                        this.jump();
                    }
                }

                // ì¶©ëŒ ê²€ì‚¬
                // 1. ë°”ë‹¥ì´ë‚˜ ì²œì¥ì— ë‹¿ìŒ
                if (this.y > canvas.height || this.y < 0) {
                    this.alive = false;
                }

                // 2. íŒŒì´í”„ì— ë‹¿ìŒ
                if (closestPipe) {
                    if (
                        this.x + 10 > closestPipe.x && 
                        this.x - 10 < closestPipe.x + closestPipe.width
                    ) {
                        // íŒŒì´í”„ êµ¬ë© ì˜ì—­ì´ ì•„ë‹ˆë©´ ì¶©ëŒ
                        if (this.y - 10 < closestPipe.top || this.y + 10 > closestPipe.bottom) {
                            this.alive = false;
                        }
                    }
                }
            }

            jump() {
                this.velocity = this.lift;
            }

            draw(ctx) {
                if (!this.alive) return;
                
                ctx.save();
                ctx.translate(this.x, this.y);
                
                // ìµœê³  ì ìˆ˜ ë“œë¡ ì€ íŠ¹ë³„í•œ ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                if (this === bestDrone) {
                    ctx.fillStyle = "#FF5722"; // ì£¼í™©ìƒ‰ (ë¦¬ë”)
                    ctx.globalAlpha = 1.0;
                    ctx.scale(1.2, 1.2);
                } else {
                    ctx.fillStyle = "rgba(255, 255, 255, 0.5)"; // ë°˜íˆ¬ëª… í°ìƒ‰
                }

                // ë“œë¡  ëª¨ì–‘ (ì‚¼ê°í˜•)
                ctx.beginPath();
                ctx.moveTo(10, 0);
                ctx.lineTo(-10, 7);
                ctx.lineTo(-10, -7);
                ctx.fill();
                ctx.restore();
            }
        }

        // --- 3. ê²Œì„ ê´€ë¦¬ (ì‹œìŠ¤í…œ) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let drones = [];
        const TOTAL_DRONES = 100; // í•œ ì„¸ëŒ€ë‹¹ ë“œë¡  ìˆ˜
        let pipes = [];
        let frameCount = 0;
        let generation = 1;
        let bestScore = 0;
        let speedMultiplier = 1;
        let bestDrone = null;

        // ì´ˆê¸°í™”
        function init() {
            drones = [];
            for (let i = 0; i < TOTAL_DRONES; i++) {
                drones.push(new Drone());
            }
            pipes = [];
            frameCount = 0;
            loop();
        }

        // ë‹¤ìŒ ì„¸ëŒ€ ìƒì„± (ì§„í™”)
        function nextGeneration() {
            generation++;
            document.getElementById('genCount').innerText = generation;

            // 1. ì í•©ë„ ê³„ì‚° (ì˜¤ë˜ ì‚´ìˆ˜ë¡ ë†’ì€ ì ìˆ˜)
            // ì§€ìˆ˜ í•¨ìˆ˜ë¥¼ ì¨ì„œ ì ìˆ˜ ì°¨ì´ë¥¼ ë²Œë¦¼ (ì˜í•œ ë†ˆì„ í™•ì‹¤íˆ ìš°ëŒ€)
            let sumFitness = 0;
            for (let drone of drones) {
                // ê±°ë¦¬ê°€ ë©€ìˆ˜ë¡ ì ìˆ˜ê°€ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ë†’ì•„ì§
                drone.fitness = Math.pow(drone.score, 2); 
                sumFitness += drone.fitness;
            }

            // 2. ìƒˆë¡œìš´ ë“œë¡  ìƒì„±
            let newDrones = [];
            for (let i = 0; i < TOTAL_DRONES; i++) {
                // ë£°ë › íœ  ì„ íƒ: ì ìˆ˜ê°€ ë†’ì€ ë¶€ëª¨ê°€ ì„ íƒë  í™•ë¥ ì´ ë†’ìŒ
                let parent = selectParent(sumFitness);
                let child = new Drone(parent.brain); // ë¶€ëª¨ì˜ ë‡Œë¥¼ ë¬¼ë ¤ë°›ìŒ
                child.brain.mutate(0.1); // 10% í™•ë¥ ë¡œ ëŒì—°ë³€ì´ ë°œìƒ
                newDrones.push(child);
            }
            
            drones = newDrones;
            pipes = [];
            frameCount = 0;
        }

        function selectParent(sumFitness) {
            let r = Math.random() * sumFitness;
            let index = 0;
            while (r > 0 && index < drones.length) {
                r -= drones[index].fitness;
                index++;
            }
            index--;
            if (index < 0) index = 0;
            return drones[index];
        }

        // íŒŒì´í”„ ìƒì„±
        function addPipe() {
            let gapHeight = 120; // êµ¬ë© í¬ê¸°
            let minTop = 50;
            let maxTop = canvas.height - minTop - gapHeight;
            let top = Math.random() * (maxTop - minTop) + minTop;

            pipes.push({
                x: canvas.width,
                width: 50,
                top: top,
                bottom: top + gapHeight
            });
        }

        // ê²Œì„ ë£¨í”„
        function update() {
            // íŒŒì´í”„ ê´€ë¦¬
            if (frameCount % 100 === 0) {
                addPipe();
            }
            frameCount++;

            // íŒŒì´í”„ ì´ë™
            for (let i = pipes.length - 1; i >= 0; i--) {
                pipes[i].x -= 3; // ì†ë„
                if (pipes[i].x + pipes[i].width < 0) {
                    pipes.splice(i, 1);
                }
            }

            // ë“œë¡  ì—…ë°ì´íŠ¸
            let aliveCount = 0;
            let currentBestScore = 0;
            bestDrone = null;

            for (let drone of drones) {
                drone.update(pipes);
                if (drone.alive) {
                    aliveCount++;
                    if (drone.score > currentBestScore) {
                        currentBestScore = drone.score;
                        bestDrone = drone;
                    }
                }
            }

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('aliveCount').innerText = aliveCount;
            document.getElementById('totalCount').innerText = TOTAL_DRONES;
            if (currentBestScore > bestScore) {
                bestScore = currentBestScore;
                document.getElementById('bestScore').innerText = bestScore;
            }

            // ì „ë©¸í–ˆìœ¼ë©´ ë‹¤ìŒ ì„¸ëŒ€ë¡œ
            if (aliveCount === 0) {
                nextGeneration();
            }
        }

        function draw() {
            // ë°°ê²½ ì§€ìš°ê¸°
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // íŒŒì´í”„ ê·¸ë¦¬ê¸°
            ctx.fillStyle = '#888';
            for (let pipe of pipes) {
                ctx.fillRect(pipe.x, 0, pipe.width, pipe.top); // ìœ„ìª½ íŒŒì´í”„
                ctx.fillRect(pipe.x, pipe.bottom, pipe.width, canvas.height - pipe.bottom); // ì•„ë˜ìª½ íŒŒì´í”„
            }

            // ë“œë¡  ê·¸ë¦¬ê¸°
            for (let drone of drones) {
                drone.draw(ctx);
            }
        }

        function loop() {
            // ì†ë„ ë°°ìˆ˜ë§Œí¼ ë°˜ë³µ ì‹¤í–‰ (ë¹¨ë¦¬ê°ê¸° ê¸°ëŠ¥)
            for(let i=0; i<speedMultiplier; i++) {
                update();
            }
            draw();
            requestAnimationFrame(loop);
        }

        // --- ì»¨íŠ¸ë¡¤ ---
        document.getElementById('speedSlider').addEventListener('input', (e) => {
            speedMultiplier = parseInt(e.target.value);
            document.getElementById('speedDisplay').innerText = 'x' + speedMultiplier;
        });

        function resetSimulation() {
            generation = 1;
            bestScore = 0;
            document.getElementById('genCount').innerText = 1;
            document.getElementById('bestScore').innerText = 0;
            init();
        }

        // ì‹œì‘
        init();

    </script>
</body>
</html>
