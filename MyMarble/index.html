<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î∏åÎ£®ÎßàÎ∏î Í∑∏ÎûúÎìú - ÎπåÎî© ÏóêÎîîÏÖò</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap');

        :root {
            --board-size: min(96vw, 92vh);
            --square-font: clamp(0.4rem, 1vw, 0.6rem);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #cbd5e1;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            touch-action: manipulation;
        }

        .game-font { font-family: 'Black Han Sans', sans-serif; }

        /* Î≥¥Îìú Î†àÏù¥ÏïÑÏõÉ */
        .board-grid {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            gap: 1px;
            width: var(--board-size);
            height: var(--board-size);
            background-color: #334155;
            padding: clamp(4px, 1vw, 8px);
            border-radius: clamp(10px, 2vw, 20px);
            position: relative;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .square {
            background-color: white;
            border-radius: 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            font-size: var(--square-font);
            position: relative;
            padding: 2px 1px;
            text-align: center;
            word-break: keep-all;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.1);
            min-width: 0;
            min-height: 0;
            overflow: hidden;
        }

        .square.corner { background-color: #fef3c7; font-weight: bold; }
        .square.city { border-top: clamp(2px, 0.6vw, 6px) solid #ddd; }
        
        .flag-img { width: clamp(14px, 3vw, 24px); height: auto; border-radius: 1px; }

        .center-panel {
            grid-area: 2 / 2 / 11 / 11;
            background-color: #f1f5f9;
            display: flex;
            flex-direction: column;
            padding: clamp(6px, 1.5vw, 12px);
            gap: 10px;
            overflow: hidden;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            position: relative;
        }

        /* ÌîåÎ†àÏù¥Ïñ¥ Îßê */
        .piece {
            width: clamp(20px, 4.5vw, 32px);
            height: clamp(20px, 4.5vw, 32px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1rem, 2.5vw, 1.8rem);
            position: absolute;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            border: 2px solid white;
        }

        .piece.moving { transform: scale(1.4) translateY(-20%); z-index: 60; }

        /* ÌÑ¥ ÌëúÏãú Ìö®Í≥º */
        @keyframes turn-glow {
            0%, 100% { border-color: #6366f1; box-shadow: 0 0 5px rgba(99, 102, 241, 0.5); }
            50% { border-color: #818cf8; box-shadow: 0 0 15px rgba(129, 140, 248, 0.8); }
        }
        .turn-anim { animation: turn-glow 1.5s infinite; border-width: 4px !important; }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-4px, 4px); }
            50% { transform: translate(4px, -4px); }
        }
        .shake-effect { animation: shake 0.4s ease-in-out; }

        /* Ï£ºÏÇ¨ÏúÑ Î∞è Ïù¥Î≤§Ìä∏ Ïò§Î≤ÑÎ†àÏù¥ */
        .dice-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; 
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 100;
            pointer-events: none;
            width: 100%;
        }

        .dice-box-container { display: flex; gap: 15px; }
        .dice-box {
            width: clamp(45px, 11vw, 75px);
            height: clamp(45px, 11vw, 75px);
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.8rem, 5.5vw, 3rem);
            font-weight: 800;
            color: #334155;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 4px solid #6366f1;
        }

        .event-info-box {
            background: rgba(255, 255, 255, 0.98);
            padding: 12px 24px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            border: 3px solid #6366f1;
        }

        .log-container::-webkit-scrollbar { width: 4px; }
        .log-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .p-bg-1 { background-color: #ff0000; }
        .p-bg-2 { background-color: #0066ff; }
        .p-bg-3 { background-color: #00cc44; }
        .p-bg-4 { background-color: #ffcc00; }
        .p-bg-5 { background-color: #aa00ff; }
        .p-bg-6 { background-color: #ff0099; }
    </style>
</head>
<body>

    <!-- Î°úÎπÑ -->
    <div id="lobby" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 md:p-12 max-w-md w-full shadow-2xl text-center border-t-8 border-indigo-600">
            <h1 class="text-4xl md:text-5xl game-font text-indigo-600 mb-4 tracking-tighter">BLUE MARBLE</h1>
            <p class="text-slate-400 mb-8 font-medium tracking-widest uppercase text-xs">Building & Upgrade Edition</p>
            <div class="grid grid-cols-3 gap-3 mb-8">
                <button onclick="startGame(2)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">2Î™Ö</button>
                <button onclick="startGame(3)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">3Î™Ö</button>
                <button onclick="startGame(4)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">4Î™Ö</button>
                <button onclick="startGame(5)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">5Î™Ö</button>
                <button onclick="startGame(6)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">6Î™Ö</button>
            </div>
        </div>
    </div>

    <!-- Í≤åÏûÑ Ìåê -->
    <div id="game-board-container">
        <div id="game-board" class="board-grid opacity-0 transition-opacity duration-500">
            <div class="center-panel shadow-inner">
                
                <div id="dice-overlay" class="dice-overlay">
                    <div id="event-emoji" class="text-7xl md:text-9xl drop-shadow-2xl"></div>
                    <div id="event-msg" class="event-info-box hidden">
                        <div class="text-lg md:text-2xl font-black text-indigo-600 mb-1" id="event-title"></div>
                        <div class="text-xs md:text-sm font-medium text-slate-600" id="event-desc"></div>
                    </div>
                    <div class="dice-box-container" id="dice-container">
                        <div id="dice-1" class="dice-box">?</div>
                        <div id="dice-2" class="dice-box">?</div>
                    </div>
                </div>

                <div class="flex items-center justify-between border-b pb-2">
                    <h2 class="text-sm md:text-2xl game-font text-slate-300">BUILDING TOUR</h2>
                    <div class="flex items-center gap-3">
                        <button id="roll-btn" onclick="game.rollDice()" class="px-6 py-2 md:px-10 md:py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-lg active:scale-95 disabled:opacity-50 text-xs md:text-base">Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Í∏∞</button>
                    </div>
                </div>

                <!-- ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ù (60% Í≥µÍ∞Ñ Ï∞®ÏßÄ) -->
                <div id="player-list" class="grid grid-cols-2 gap-2 flex-[6] overflow-hidden content-start"></div>

                <!-- ÌûàÏä§ÌÜ†Î¶¨ (40% Í≥µÍ∞Ñ Ï∞®ÏßÄ) -->
                <div class="bg-slate-900 text-white p-3 rounded-xl shadow-2xl flex flex-col flex-[4] overflow-hidden border border-slate-700">
                    <div class="text-[9px] md:text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-widest border-b border-slate-800 pb-1 flex justify-between items-center">
                        <span>History</span>
                        <span id="turn-display" class="text-indigo-400 font-bold animate-pulse">P1 TURN</span>
                    </div>
                    <div id="game-log" class="log-container overflow-y-auto flex-1 text-[10px] md:text-[12px] space-y-1.5 flex flex-col-reverse mt-1 pr-1">
                        <div class="text-indigo-300">Í±¥Î¨ºÏùÑ ÏßÄÏñ¥ ÏµúÍ≥†Ïùò Í∞ëÎ∂ÄÍ∞Ä ÎêòÏñ¥Î≥¥ÏÑ∏Ïöî!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Î™®Îã¨ (ÌÜµÌï© Íµ¨Îß§/Í±¥ÏÑ§) -->
    <div id="modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[110] hidden backdrop-blur-md">
        <div class="bg-white p-8 md:p-10 rounded-3xl max-w-sm w-full shadow-2xl text-center border-b-8 border-indigo-600 mx-4">
            <div id="modal-flag-container" class="mb-4 transform scale-110"></div>
            <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-1">ÎèÑÏãú Íµ¨Îß§</h2>
            <p id="modal-desc" class="text-sm md:text-base text-gray-500 mb-8 whitespace-pre-line leading-relaxed"></p>
            <div class="flex gap-3">
                <button onclick="game.cancelAction()" class="flex-1 py-3 md:py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl">Ï∑®ÏÜå</button>
                <button id="confirm-btn" onclick="game.confirmAction()" class="flex-1 py-3 md:py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl">Íµ¨Îß§/Í±¥ÏÑ§</button>
            </div>
        </div>
    </div>

    <script>
        // --- ÏÇ¨Ïö¥Îìú ÏóîÏßÑ ---
        class SoundManager {
            constructor() { try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
            play(freq, type, duration, vol = 0.1) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            }
            playDice() { this.play(150, 'triangle', 0.2, 0.2); }
            playMove() { this.play(600, 'sine', 0.1, 0.08); }
            playMoney() { this.play(880, 'sine', 0.1, 0.1); setTimeout(() => this.play(1320, 'sine', 0.2, 0.1), 50); }
            playAlert() { this.play(200, 'square', 0.3, 0.05); setTimeout(() => this.play(150, 'square', 0.3, 0.05), 100); }
            playSpecial() { if(!this.ctx) return; let now = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.5); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5); osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.5); }
        }

        // --- Î≥¥Îìú Îç∞Ïù¥ÌÑ∞ ---
        const boardData = [
            { id: 0, name: "START", type: "corner", emoji: "üèÅ", color: "#fef3c7" },
            { id: 1, name: "ÌÉÄÏù¥Î≤†Ïù¥", type: "city", price: 50000, rent: 20000, color: "#f87171", code: "tw" },
            { id: 2, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 3, name: "Î≤†Ïù¥Ïßï", type: "city", price: 80000, rent: 40000, color: "#f87171", code: "cn" },
            { id: 4, name: "ÎßàÎãêÎùº", type: "city", price: 80000, rent: 40000, color: "#f87171", code: "ph" },
            { id: 5, name: "Ï†úÏ£ºÎèÑ", type: "city", price: 200000, rent: 150000, color: "#ec4899", code: "kr" },
            { id: 6, name: "Ïã±Í∞ÄÌè¨Î•¥", type: "city", price: 100000, rent: 60000, color: "#f87171", code: "sg" },
            { id: 7, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 8, name: "Ïπ¥Ïù¥Î°ú", type: "city", price: 120000, rent: 80000, color: "#f87171", code: "eg" },
            { id: 9, name: "Ïù¥Ïä§ÌÉÑÎ∂à", type: "city", price: 120000, rent: 80000, color: "#f87171", code: "tr" },
            { id: 10, name: "Î¨¥Ïù∏ÎèÑ", type: "corner", emoji: "üå¥", color: "#fef3c7" },
            { id: 11, name: "ÏïÑÌÖåÎÑ§", type: "city", price: 140000, rent: 100000, color: "#fbbf24", code: "gr" },
            { id: 12, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 13, name: "ÏΩîÌéúÌïòÍ≤ê", type: "city", price: 160000, rent: 120000, color: "#fbbf24", code: "dk" },
            { id: 14, name: "Ïä§ÌÜ°ÌôÄÎ¶Ñ", type: "city", price: 160000, rent: 120000, color: "#fbbf24", code: "se" },
            { id: 15, name: "ÏΩ©ÏΩîÎìú", type: "city", price: 250000, rent: 200000, color: "#ec4899", emoji: "‚úàÔ∏è" },
            { id: 16, name: "Ï∑®Î¶¨Ìûà", type: "city", price: 180000, rent: 140000, color: "#fbbf24", code: "ch" },
            { id: 17, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 18, name: "Î≤†Î•ºÎ¶∞", type: "city", price: 200000, rent: 160000, color: "#fbbf24", code: "de" },
            { id: 19, name: "Ïò§ÌÉÄÏôÄ", type: "city", price: 200000, rent: 160000, color: "#fbbf24", code: "ca" },
            { id: 20, name: "ÏÇ¨ÌöåÎ≥µÏßÄ", type: "corner", emoji: "üè¶", color: "#fef3c7" },
            { id: 21, name: "Î∂ÄÏóêÎÖ∏Ïä§", type: "city", price: 220000, rent: 180000, color: "#4ade80", code: "ar" },
            { id: 22, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 23, name: "ÏÉÅÌååÏö∏Î£®", type: "city", price: 240000, rent: 200000, color: "#4ade80", code: "br" },
            { id: 24, name: "ÏãúÎìúÎãà", type: "city", price: 240000, rent: 200000, color: "#4ade80", code: "au" },
            { id: 25, name: "Î∂ÄÏÇ∞", type: "city", price: 300000, rent: 250000, color: "#ec4899", code: "kr" },
            { id: 26, name: "ÌïòÏôÄÏù¥", type: "city", price: 260000, rent: 220000, color: "#4ade80", code: "us" },
            { id: 27, name: "Î¶¨Ïä§Î≥∏", type: "city", price: 260000, rent: 220000, color: "#4ade80", code: "pt" },
            { id: 28, name: "ÌÄ∏Ï¶àÌò∏", type: "city", price: 300000, rent: 250000, color: "#ec4899", emoji: "üö¢" },
            { id: 29, name: "ÎßàÎìúÎ¶¨Îìú", type: "city", price: 280000, rent: 240000, color: "#4ade80", code: "es" },
            { id: 30, name: "Ïö∞Ï£ºÏó¨Ìñâ", type: "corner", emoji: "üöÄ", color: "#fef3c7" },
            { id: 31, name: "ÎèÑÏøÑ", type: "city", price: 300000, rent: 260000, color: "#60a5fa", code: "jp" },
            { id: 32, name: "ÌååÎ¶¨", type: "city", price: 320000, rent: 280000, color: "#60a5fa", code: "fr" },
            { id: 33, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 34, name: "Î°úÎßà", type: "city", price: 320000, rent: 280000, color: "#60a5fa", code: "it" },
            { id: 35, name: "Ïª¨ÎüºÎπÑÏïÑ", type: "city", price: 450000, rent: 350000, color: "#ec4899", emoji: "üöÄ" },
            { id: 36, name: "Îü∞Îçò", type: "city", price: 350000, rent: 300000, color: "#60a5fa", code: "gb" },
            { id: 37, name: "Îâ¥Ïöï", type: "city", price: 350000, rent: 300000, color: "#60a5fa", code: "us" },
            { id: 38, name: "ÏÑ∏Í∏à", type: "tax", emoji: "üí∏", color: "#fef3c7" },
            { id: 39, name: "ÏÑúÏö∏", type: "city", price: 500000, rent: 450000, color: "#60a5fa", code: "kr" }
        ];

        function generateGridPositions() {
            let pos = [];
            for(let i=11; i>=1; i--) pos.push([11, i]); 
            for(let i=10; i>=1; i--) pos.push([i, 1]);  
            for(let i=2; i<=11; i++) pos.push([1, i]);  
            for(let i=2; i<=10; i++) pos.push([i, 11]); 
            return pos;
        }
        const gridPositions = generateGridPositions();

        // --- Î©îÏù∏ Í≤åÏûÑ Î°úÏßÅ ---
        class GrandBlueMarble {
            constructor(playerCount) {
                this.sound = new SoundManager();
                const icons = ['üöó', '‚úàÔ∏è', 'üö¢', 'üöÅ', 'üö≤', 'üöÄ'];
                const names = ['P1', 'P2', 'P3', 'P4', 'P5', 'P6'];
                this.players = Array.from({length: playerCount}, (_, i) => ({
                    id: i + 1, pos: 0, money: 2000000, name: names[i], icon: icons[i],
                    isBankrupt: false, doubleCount: 0, islandTurns: 0, isIslandIn: false, hasEscapeCard: false
                }));
                this.currentPlayerIndex = 0;
                this.isRolling = false;
                this.lastWasDouble = false;
                this.properties = Array(boardData.length).fill(null); // ÏÜåÏú†Ï£º ID Ï†ÄÏû•
                this.propertyLevels = Array(boardData.length).fill(0); // 0: ÎπàÎïÖ, 1: ÎåÄÏßÄ, 2: Î≥ÑÏû•, 3: ÎπåÎî©, 4: Ìò∏ÌÖî
                this.initUI();
                this.initBoard();
                window.addEventListener('resize', () => this.updatePiecePositions());
            }

            initUI() {
                const pList = document.getElementById('player-list'); pList.innerHTML = '';
                this.players.forEach(p => {
                    const card = document.createElement('div');
                    card.id = `card-p${p.id}`; card.className = `bg-white p-2 rounded-xl shadow-sm border-l-[8px] border-slate-200 flex flex-col transition-all duration-300 relative overflow-hidden`;
                    card.style.borderLeftColor = this.getPlayerColor(p.id);
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[12px] md:text-[15px] font-black flex items-center gap-1.5"><span class="text-3xl md:text-4xl">${p.icon}</span> ${p.name}</span>
                            <div class="flex flex-col items-end gap-1">
                                <span id="turn-p${p.id}" class="text-[7px] font-black px-1.5 py-0.5 rounded-full bg-indigo-600 text-white hidden uppercase">ACT</span>
                                <span id="island-p${p.id}" class="text-[7px] font-black px-1.5 py-0.5 rounded-full bg-orange-500 text-white hidden uppercase tracking-tighter">ISLE</span>
                            </div>
                        </div>
                        <div class="text-[13px] md:text-[15px] font-black text-slate-800 px-1 border-t pt-1">‚Ç© <span id="money-p${p.id}">${p.money.toLocaleString()}</span></div>
                        <div id="owned-p${p.id}" class="flex flex-wrap gap-1 mt-1 px-1 min-h-[12px]"></div>
                    `;
                    pList.appendChild(card);
                    const piece = document.createElement('div');
                    piece.id = `p${p.id}`; piece.className = `piece p-bg-${p.id}`; piece.innerText = p.icon;
                    document.getElementById('game-board').appendChild(piece);
                });
                this.updateStatus();
            }

            initBoard() {
                const board = document.getElementById('game-board');
                boardData.forEach((data, index) => {
                    const div = document.createElement('div'); div.className = `square ${data.type}`; div.id = `square-${index}`;
                    const pos = gridPositions[index]; div.style.gridRow = pos[0]; div.style.gridColumn = pos[1];
                    if (data.type === 'city') {
                        div.style.borderTopColor = data.color;
                        let content = `<div class="text-[0.4rem] text-gray-400 font-bold">‚Ç©${(data.price/10000)}Îßå</div>`;
                        if (data.code) content += `<img src="https://flagcdn.com/w40/${data.code}.png" class="flag-img" onerror="this.style.display='none'">`;
                        else if (data.emoji) content += `<div class="text-xl my-0.5">${data.emoji}</div>`;
                        content += `<div class="font-bold text-[0.55rem] text-slate-700 leading-none">${data.name}</div><div id="owner-${index}" class="mt-auto min-h-[14px] flex items-center justify-center"></div>`;
                        div.innerHTML = content;
                    } else {
                        div.style.backgroundColor = data.color;
                        div.innerHTML = `<div class="text-2xl mb-1">${data.emoji || ''}</div><div class="font-bold text-[0.65rem] text-slate-800">${data.name}</div>`;
                    }
                    board.appendChild(div);
                });
                setTimeout(() => this.updatePiecePositions(), 100);
            }

            getPlayerColor(id) { return ['#ff0000', '#0066ff', '#00cc44', '#ffcc00', '#aa00ff', '#ff0099'][id - 1]; }

            updatePiecePositions(isSpecial = false) {
                const groups = {}; this.players.forEach(p => { if(!groups[p.pos]) groups[p.pos] = []; groups[p.pos].push(p); });
                Object.keys(groups).forEach(pos => {
                    const players = groups[pos]; const square = document.getElementById(`square-${pos}`);
                    if(!square) return;
                    players.forEach((p, i) => {
                        const piece = document.getElementById(`p${p.id}`); if (p.isBankrupt) { piece.style.display = 'none'; return; }
                        const offsetMap = [[0, 0], [10, 10], [-10, -10], [10, -10], [-10, 10], [0, -15]];
                        const offset = offsetMap[i] || [0, 0];
                        piece.style.top = `${square.offsetTop + square.offsetHeight/2 - piece.offsetHeight/2 + offset[1]}px`;
                        piece.style.left = `${square.offsetLeft + square.offsetWidth/2 - piece.offsetWidth/2 + offset[0]}px`;
                    });
                });
            }

            updateStatus() {
                this.players.forEach(p => {
                    document.getElementById(`money-p${p.id}`).innerText = p.money.toLocaleString();
                    const card = document.getElementById(`card-p${p.id}`);
                    if (this.currentPlayerIndex === p.id - 1) {
                        card.classList.add('turn-anim'); document.getElementById(`turn-p${p.id}`).classList.remove('hidden');
                        document.getElementById('turn-display').innerText = `${p.name} TURN`;
                    } else {
                        card.classList.remove('turn-anim'); document.getElementById(`turn-p${p.id}`).classList.add('hidden');
                    }
                    p.isIslandIn ? document.getElementById(`island-p${p.id}`).classList.remove('hidden') : document.getElementById(`island-p${p.id}`).classList.add('hidden');
                    if (p.isBankrupt) card.classList.add('grayscale', 'opacity-40');
                    const owned = boardData.filter((_, idx) => this.properties[idx] === p.id);
                    document.getElementById(`owned-p${p.id}`).innerHTML = owned.map(c => `<span class="text-[7px] px-1.5 py-0.5 rounded text-white font-black shadow-sm" style="background-color: ${c.color}">${c.name}</span>`).join('');
                });
            }

            log(msg, colorClass = "text-slate-400") {
                const logBox = document.getElementById('game-log'); const div = document.createElement('div');
                div.className = `leading-relaxed border-l-2 pl-2 border-slate-700 ${colorClass}`;
                div.innerHTML = msg; logBox.prepend(div);
            }

            resetOverlayUI() {
                document.getElementById('event-emoji').innerText = '';
                document.getElementById('event-msg').classList.add('hidden');
                document.getElementById('dice-container').style.display = 'flex';
            }

            showEventOverlay(emoji, title, desc, duration = 2000) {
                this.resetOverlayUI();
                const overlay = document.getElementById('dice-overlay');
                document.getElementById('event-emoji').innerText = emoji;
                document.getElementById('event-title').innerText = title;
                document.getElementById('event-desc').innerText = desc;
                document.getElementById('dice-container').style.display = 'none';
                document.getElementById('event-msg').classList.remove('hidden');
                overlay.style.display = 'flex';
                setTimeout(() => { overlay.style.display = 'none'; this.resetOverlayUI(); }, duration);
            }

            rollDice() {
                if (this.isRolling) return; this.isRolling = true;
                const overlay = document.getElementById('dice-overlay');
                const d1El = document.getElementById('dice-1'); const d2El = document.getElementById('dice-2');
                const player = this.players[this.currentPlayerIndex];
                document.getElementById('roll-btn').disabled = true;
                this.resetOverlayUI(); overlay.style.display = 'flex';

                const interval = setInterval(() => {
                    d1El.innerText = Math.floor(Math.random() * 6) + 1;
                    d2El.innerText = Math.floor(Math.random() * 6) + 1;
                    this.sound.playDice();
                }, 100);

                setTimeout(() => {
                    clearInterval(interval);
                    const d1 = Math.floor(Math.random() * 6) + 1; const d2 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2; const isDouble = (d1 === d2);
                    d1El.innerText = d1; d2El.innerText = d2;
                    
                    setTimeout(async () => {
                        overlay.style.display = 'none';
                        this.log(`üé≤ Í≤∞Í≥º: <b>${d1} + ${d2} = ${total}</b>`, "text-white");
                        
                        if (player.isIslandIn) {
                            if (isDouble) { this.log(`‚ú® ÎçîÎ∏îÎ°ú Î¨¥Ïù∏ÎèÑ ÌÉàÏ∂ú!`, "text-green-400 font-bold"); player.isIslandIn = false; player.islandTurns = 0; }
                            else {
                                player.islandTurns++;
                                if (player.islandTurns >= 3) { this.log(`‚åõ 3ÌÑ¥ Í≤ΩÍ≥ºÎ°ú ÏÑùÎ∞©!`, "text-indigo-300"); player.isIslandIn = false; player.islandTurns = 0; }
                                else { this.log(`üîí Î¨¥Ïù∏ÎèÑ ÎåÄÍ∏∞ (${player.islandTurns}/3)`, "text-orange-400"); this.endTurn(); return; }
                            }
                        }

                        if (isDouble && !player.isIslandIn) {
                            player.doubleCount++;
                            if (player.doubleCount === 3) { this.log(`‚ö†Ô∏è 3Ïó∞ÏÜç ÎçîÎ∏î! Î¨¥Ïù∏ÎèÑ ÏïïÏÜ°`, "text-red-500 font-bold"); this.handleIslandArrive(); return; }
                            this.lastWasDouble = true;
                        } else { player.doubleCount = 0; this.lastWasDouble = false; }

                        await this.movePlayer(total);
                    }, 800);
                }, 1200);
            }

            handleIslandArrive() {
                const p = this.players[this.currentPlayerIndex]; this.sound.playAlert();
                p.pos = 10; p.isIslandIn = true; p.islandTurns = 0; p.doubleCount = 0;
                this.updatePiecePositions(true); this.showEventOverlay("üå¥", "Î¨¥Ïù∏ÎèÑ ÏàòÍ∞ê", "ÎçîÎ∏î ÎòêÎäî 3ÌÑ¥ ÎåÄÍ∏∞"); this.endTurn(true);
            }

            async movePlayer(steps) {
                const p = this.players[this.currentPlayerIndex]; const piece = document.getElementById(`p${p.id}`);
                for(let i = 0; i < steps; i++) {
                    p.pos = (p.pos + 1) % boardData.length; this.sound.playMove(); piece.classList.add('moving');
                    this.updatePiecePositions(); if (p.pos === 0) { p.money += 200000; this.sound.playMoney(); this.log(`üí∞ ÏõîÍ∏â ÏàòÎ†π`, "text-yellow-400 font-bold"); }
                    await new Promise(r => setTimeout(r, 250)); piece.classList.remove('moving');
                }
                this.handleSquare(p.pos);
            }

            handleSquare(pos) {
                const s = boardData[pos]; const p = this.players[this.currentPlayerIndex];
                this.log(`üìç <b>${p.name}</b> ‚Üí <b>${s.name}</b>`, "text-slate-300 text-[10px]");
                
                if (s.type === 'city') {
                    const ownerId = this.properties[pos];
                    if (ownerId === null) { this.showModal(s, 'buy'); return; }
                    else if (ownerId === p.id) { 
                        if (this.propertyLevels[pos] < 4) { this.showModal(s, 'upgrade'); return; }
                        else { this.log("ÏµúÍ≥† Îì±Í∏â Ìò∏ÌÖî ÏÜåÏú† Ï§ë!", "text-green-300"); }
                    }
                    else { this.payRent(p, this.players[ownerId - 1], pos); }
                } 
                else if (s.type === 'tax') { p.money -= 200000; this.sound.playAlert(); this.log(`üí∏ ÏÑ∏Í∏à ÎÇ©Î∂Ä: ‚Ç©20Îßå`, "text-red-400"); }
                else if (s.type === 'chance') this.handleGoldenKey();
                else if (s.name === "Î¨¥Ïù∏ÎèÑ") { this.handleIslandArrive(); return; }
                else if (s.name === "Ïö∞Ï£ºÏó¨Ìñâ") { this.sound.playSpecial(); this.showEventOverlay("üöÄ", "Ïö∞Ï£ºÏó¨Ìñâ", "Îã§Ïùå ÌÑ¥Ïóê Ï∂úÎ∞úÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§."); }
                else if (s.name === "ÏÇ¨ÌöåÎ≥µÏßÄ") { p.money += 150000; this.sound.playMoney(); this.showEventOverlay("üè¶", "ÏÇ¨ÌöåÎ≥µÏßÄÍ∏∞Í∏à", "‚Ç©150,000 ÏàòÎ†π!"); }
                
                this.checkPostAction();
            }

            handleGoldenKey() {
                const p = this.players[this.currentPlayerIndex]; const r = Math.random();
                if (r < 0.2) { p.hasEscapeCard = true; this.showEventOverlay("üé´", "Î¨¥Ïù∏ÎèÑ ÌÉàÏ∂úÍ∂å", "Ï¶âÏãú ÏÇ¨Ïö© Í∞ÄÎä•!"); }
                else if (r < 0.5) { p.money += 100000; this.sound.playMoney(); this.showEventOverlay("üíé", "Î≥¥ÎÑàÏä§", "‚Ç©100,000!"); }
                else { p.money -= 50000; this.sound.playAlert(); this.showEventOverlay("üí©", "Î≤åÍ∏à", "‚Ç©50,000!"); }
            }

            checkPostAction() {
                if (this.lastWasDouble) { 
                    this.log(`‚ú® ÎçîÎ∏î Ï∞¨Ïä§! Ìïú Î≤à Îçî`, "text-indigo-300 font-bold text-[11px]"); 
                    this.isRolling = false; document.getElementById('roll-btn').disabled = false; this.updateStatus(); 
                }
                else this.endTurn();
            }

            // Î™®Îã¨ ÌëúÏãú (Íµ¨Îß§/Í±¥ÏÑ§ Î∂ÑÍ∏∞)
            showModal(s, mode) {
                const modal = document.getElementById('modal'); const flag = document.getElementById('modal-flag-container');
                const title = document.getElementById('modal-title'); const desc = document.getElementById('modal-desc');
                
                if(s.code) flag.innerHTML = `<img src="https://flagcdn.com/w160/${s.code}.png" class="mx-auto rounded-xl shadow-lg border-4 border-white max-w-[100px]">`;
                else flag.innerHTML = `<span class="text-7xl">${s.emoji}</span>`;

                if (mode === 'buy') {
                    title.innerText = `${s.name} Íµ¨Îß§`;
                    desc.innerHTML = `ÎåÄÏßÄ Í∞ÄÍ≤©: <b>‚Ç©${s.price.toLocaleString()}</b>\nÏù¥Í≥≥ÏùÑ Íµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
                } else {
                    const level = this.propertyLevels[boardData.indexOf(s)];
                    const buildNames = ["", "Î≥ÑÏû•", "ÎπåÎî©", "Ìò∏ÌÖî"];
                    const buildEmojis = ["", "üè°", "üè¢", "üè®"];
                    const nextBuild = buildNames[level];
                    const nextPrice = s.price * 0.8;
                    title.innerText = `${s.name} ${nextBuild} Í±¥ÏÑ§`;
                    desc.innerHTML = `${buildEmojis[level]} Í±¥ÏÑ§ ÎπÑÏö©: <b>‚Ç©${nextPrice.toLocaleString()}</b>\nÍ±¥Î¨ºÏùÑ ÏßìÍ≥† ÌÜµÌñâÎ£åÎ•º Ïò¨Î¶¨ÏãúÍ≤†ÏäµÎãàÍπå?`;
                }
                modal.classList.remove('hidden');
            }

            confirmAction() {
                const p = this.players[this.currentPlayerIndex]; const pos = p.pos; const s = boardData[pos];
                const level = this.propertyLevels[pos];
                
                if (this.properties[pos] === null) { // ÏµúÏ¥à Íµ¨Îß§
                    if (p.money >= s.price) {
                        p.money -= s.price; this.sound.playMoney(); this.properties[pos] = p.id; this.propertyLevels[pos] = 1;
                        this.updateBoardOwnerDisplay(pos);
                        this.log(`üè† ${s.name} ÎåÄÏßÄ Îß§ÏûÖ!`, "text-indigo-300 font-bold"); this.closeModal(); this.checkPostAction();
                    } else { alert("ÏûîÏï° Î∂ÄÏ°±!"); this.cancelAction(); }
                } else { // ÏóÖÍ∑∏Î†àÏù¥Îìú
                    const upgradePrice = s.price * 0.8;
                    if (p.money >= upgradePrice) {
                        p.money -= upgradePrice; this.sound.playMoney(); this.propertyLevels[pos]++;
                        this.updateBoardOwnerDisplay(pos);
                        this.log(`üè¢ ${s.name}Ïóê Í±¥Î¨ºÏùÑ Ïò¨Î†∏ÏäµÎãàÎã§!`, "text-green-300 font-bold"); this.closeModal(); this.checkPostAction();
                    } else { alert("Í±¥ÏÑ§ ÎπÑÏö© Î∂ÄÏ°±!"); this.cancelAction(); }
                }
            }

            updateBoardOwnerDisplay(pos) {
                const p = this.players[this.properties[pos] - 1];
                const level = this.propertyLevels[pos];
                const emojis = ["", "", "üè°", "üè¢", "üè®"];
                const buildingEmoji = emojis[level] || "";
                document.getElementById(`owner-${pos}`).innerHTML = `
                    <span class="text-[0.45rem] md:text-[0.52rem] font-black whitespace-nowrap" style="color:${this.getPlayerColor(p.id)}">
                        ${p.name} ${p.icon} ${buildingEmoji}
                    </span>
                `;
            }

            cancelAction() { this.closeModal(); this.checkPostAction(); }
            closeModal() { document.getElementById('modal').classList.add('hidden'); }

            payRent(p, owner, pos) {
                if (owner.isBankrupt) return;
                const s = boardData[pos];
                const level = this.propertyLevels[pos];
                const multipliers = [1, 1, 3, 8, 20]; // Îì±Í∏âÎ≥Ñ ÌÜµÌñâÎ£å Î∞∞Ïàò
                const finalRent = s.rent * multipliers[level - 1];
                
                p.money -= finalRent; owner.money += finalRent;
                this.sound.playAlert(); document.getElementById('game-board').classList.add('shake-effect');
                setTimeout(() => document.getElementById('game-board').classList.remove('shake-effect'), 400);
                this.log(`üîî ${p.name} ‚Üí ${owner.name} ÌÜµÌñâÎ£å ‚Ç©${finalRent.toLocaleString()} ÏßÄÎ∂à`, "text-orange-400 font-bold");
                if (p.money < 0) this.bankrupt(p);
            }

            bankrupt(p) {
                p.isBankrupt = true; this.sound.playAlert();
                this.log(`üö´ ${p.name}ÎãòÏù¥ ÌååÏÇ∞ÌñàÏäµÎãàÎã§!`, "text-red-500 font-black");
                this.properties.forEach((id, idx) => { if (id === p.id) { this.properties[idx] = null; this.propertyLevels[idx] = 0; document.getElementById(`owner-${idx}`).innerText = ''; } });
                this.updatePiecePositions();
            }

            endTurn(force = false) {
                this.updateStatus();
                if (!this.lastWasDouble || force) {
                    let next = (this.currentPlayerIndex + 1) % this.players.length;
                    if (this.players.filter(p => !p.isBankrupt).length <= 1) { 
                        alert(`üèÜ Ï∂ïÌïòÌï©ÎãàÎã§! ÏµúÏ¢Ö Ïö∞Ïäπ: ${this.players.find(p => !p.isBankrupt).name}`); location.reload(); return; 
                    }
                    while (this.players[next].isBankrupt) next = (next + 1) % this.players.length;
                    this.currentPlayerIndex = next; this.players[this.currentPlayerIndex].doubleCount = 0;
                }
                this.isRolling = false; this.lastWasDouble = false; document.getElementById('roll-btn').disabled = false; this.updateStatus();
            }
        }

        function startGame(count) {
            document.getElementById('lobby').classList.add('hidden'); document.getElementById('game-board').classList.remove('opacity-0');
            window.game = new GrandBlueMarble(count);
        }
    </script>
</body>
</html>
