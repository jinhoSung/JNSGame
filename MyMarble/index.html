<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¸Œë£¨ë§ˆë¸” ê·¸ëœë“œ - êµ­ê¸° ì—ë””ì…˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #cbd5e1;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .game-font { font-family: 'Black Han Sans', sans-serif; }

        /* 11x11 ë³´ë“œ ë ˆì´ì•„ì›ƒ */
        .board-grid {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            gap: 2px;
            width: 98vw;
            max-width: 880px;
            aspect-ratio: 1 / 1;
            background-color: #334155;
            padding: 8px;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.5);
        }

        .square {
            background-color: white;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            font-size: 0.55rem;
            position: relative;
            padding: 4px 2px;
            text-align: center;
            word-break: keep-all;
            box-shadow: inset 0 0 4px rgba(0,0,0,0.1);
        }

        .square.corner { background-color: #fef3c7; font-weight: bold; font-size: 0.65rem; }
        .square.city { border-top: 6px solid #ddd; }
        
        /* êµ­ê¸° ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .flag-img {
            width: 26px;
            height: auto;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            margin: 2px 0;
        }

        /* ì¤‘ì•™ íŒ¨ë„ ì˜ì—­ */
        .center-panel {
            grid-area: 2 / 2 / 11 / 11;
            background-color: #f1f5f9;
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 8px;
            overflow: hidden;
            border-radius: 12px;
            border: 3px solid #e2e8f0;
            position: relative;
        }

        /* í”Œë ˆì´ì–´ ë§ */
        .piece {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            position: absolute;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50;
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            border: 3px solid white;
        }

        /* í˜„ì¬ í„´ í”Œë ˆì´ì–´ ê°•ì¡° íš¨ê³¼ */
        .active-player-card {
            border-width: 4px !important;
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.6);
            z-index: 10;
        }

        @keyframes turn-glow {
            0% { border-color: #6366f1; box-shadow: 0 0 5px #6366f1; }
            50% { border-color: #818cf8; box-shadow: 0 0 20px #818cf8; }
            100% { border-color: #6366f1; box-shadow: 0 0 5px #6366f1; }
        }
        .turn-anim { animation: turn-glow 1.5s infinite; }

        /* ì£¼ì‚¬ìœ„ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes dice-roll {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translate(-50%, -60%) rotate(90deg) scale(1.2); }
            40% { transform: translate(-50%, -40%) rotate(180deg) scale(1); }
            60% { transform: translate(-50%, -55%) rotate(270deg) scale(1.1); }
            80% { transform: translate(-50%, -45%) rotate(360deg) scale(1); }
            100% { transform: translate(-50%, -50%) rotate(720deg) scale(1); opacity: 1; }
        }

        .dice-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; 
            gap: 20px;
            z-index: 100;
        }

        .dice-box {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 800;
            color: #334155;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border: 4px solid #6366f1;
            animation: dice-roll 0.8s ease-out forwards;
        }

        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }

        /* í”Œë ˆì´ì–´ ìƒ‰ìƒ */
        .p-bg-1 { background-color: #ff0000; }
        .p-bg-2 { background-color: #0066ff; }
        .p-bg-3 { background-color: #00cc44; }
        .p-bg-4 { background-color: #ffcc00; }
        .p-bg-5 { background-color: #aa00ff; }
        .p-bg-6 { background-color: #ff0099; }
    </style>
</head>
<body>

    <!-- ì´ˆê¸° ì„¤ì • í™”ë©´ -->
    <div id="lobby" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-10 max-w-md w-full shadow-2xl text-center border-t-8 border-indigo-600">
            <h1 class="text-5xl game-font text-indigo-600 mb-2">BLUE MARBLE</h1>
            <p class="text-slate-400 mb-8 font-medium tracking-widest uppercase text-xs">Grand National Edition</p>
            <div class="grid grid-cols-3 gap-4 mb-8">
                <button onclick="startGame(2)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">2ëª…</button>
                <button onclick="startGame(3)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">3ëª…</button>
                <button onclick="startGame(4)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">4ëª…</button>
                <button onclick="startGame(5)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">5ëª…</button>
                <button onclick="startGame(6)" class="p-4 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-xl shadow-sm">6ëª…</button>
            </div>
        </div>
    </div>

    <!-- ê²Œì„ ë³´ë“œ -->
    <div id="game-board" class="board-grid opacity-0 transition-opacity duration-500">
        
        <!-- ì¤‘ì•™ íŒ¨ë„ -->
        <div class="center-panel shadow-inner">
            <!-- ì£¼ì‚¬ìœ„ ì• ë‹ˆë©”ì´ì…˜ ì˜¤ë²„ë ˆì´ -->
            <div id="dice-overlay" class="dice-overlay">
                <div id="dice-1" class="dice-box">?</div>
                <div id="dice-2" class="dice-box">?</div>
            </div>

            <div class="flex items-center justify-between border-b pb-2 mb-1">
                <h2 class="text-2xl game-font text-slate-300 tracking-tighter">WORLD TOUR</h2>
                <div class="flex items-center gap-4">
                    <div id="dice-summary" class="text-sm font-bold text-indigo-600 bg-white px-3 py-1 rounded-full shadow-sm border border-indigo-100 italic">DOUBLE CHANCE!</div>
                    <button id="roll-btn" onclick="game.rollDice()" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-lg active:scale-95 disabled:opacity-50">ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°</button>
                </div>
            </div>

            <!-- í”Œë ˆì´ì–´ ëª©ë¡ (ë¹„ìœ¨ 6, ìŠ¤í¬ë¡¤ ì œê±°) -->
            <div id="player-list" class="grid grid-cols-2 gap-2 overflow-hidden flex-[6]">
                <!-- í”Œë ˆì´ì–´ ì¹´ë“œê°€ ìƒì„±ë¨ -->
            </div>

            <!-- ë¼ì´ë¸Œ ë¡œê·¸ (ë¹„ìœ¨ 4) -->
            <div class="bg-slate-900 text-white p-3 rounded-xl shadow-2xl flex flex-col flex-[4] overflow-hidden border border-slate-700">
                <div class="text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-widest border-b border-slate-800 pb-1 flex justify-between items-center">
                    <span>Game History</span>
                    <span id="turn-display" class="text-indigo-400 font-black animate-pulse">P1 Turn</span>
                </div>
                <div id="game-log" class="log-container overflow-y-auto flex-1 text-[11px] space-y-2 flex flex-col-reverse mt-1 pr-2">
                    <div class="text-indigo-400 font-bold">í™˜ì˜í•©ë‹ˆë‹¤! ì£¼ì‚¬ìœ„ 2ê°œë¥¼ ë˜ì ¸ ì´ë™í•˜ì„¸ìš”.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div id="modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[110] hidden backdrop-blur-md">
        <div class="bg-white p-10 rounded-3xl max-w-sm w-full shadow-2xl text-center border-b-8 border-indigo-600">
            <div id="modal-flag-container" class="mb-6 transform scale-125"></div>
            <h2 id="modal-title" class="text-3xl font-bold mb-2">ë„ì‹œ êµ¬ë§¤</h2>
            <p id="modal-desc" class="text-base text-gray-500 mb-8 whitespace-pre-line leading-relaxed"></p>
            <div class="flex gap-4">
                <button onclick="game.cancelAction()" class="flex-1 py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl hover:bg-slate-200 transition">ì·¨ì†Œ</button>
                <button id="confirm-btn" onclick="game.confirmAction()" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl hover:bg-indigo-700 transition">êµ¬ë§¤í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        const boardData = [
            { id: 0, name: "START", type: "corner", emoji: "ğŸ", color: "#fef3c7" },
            { id: 1, name: "íƒ€ì´ë² ì´", type: "city", price: 50000, rent: 20000, color: "#f87171", code: "tw" },
            { id: 2, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 3, name: "ë² ì´ì§•", type: "city", price: 80000, rent: 40000, color: "#f87171", code: "cn" },
            { id: 4, name: "ë§ˆë‹ë¼", type: "city", price: 80000, rent: 40000, color: "#f87171", code: "ph" },
            { id: 5, name: "ì œì£¼ë„", type: "city", price: 200000, rent: 150000, color: "#ec4899", code: "kr" },
            { id: 6, name: "ì‹±ê°€í¬ë¥´", type: "city", price: 100000, rent: 60000, color: "#f87171", code: "sg" },
            { id: 7, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 8, name: "ì¹´ì´ë¡œ", type: "city", price: 120000, rent: 80000, color: "#f87171", code: "eg" },
            { id: 9, name: "ì´ìŠ¤íƒ„ë¶ˆ", type: "city", price: 120000, rent: 80000, color: "#f87171", code: "tr" },
            { id: 10, name: "ë¬´ì¸ë„", type: "corner", emoji: "ğŸŒ´", color: "#fef3c7" },
            { id: 11, name: "ì•„í…Œë„¤", type: "city", price: 140000, rent: 100000, color: "#fbbf24", code: "gr" },
            { id: 12, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 13, name: "ì½”íœí•˜ê²", type: "city", price: 160000, rent: 120000, color: "#fbbf24", code: "dk" },
            { id: 14, name: "ìŠ¤í†¡í™€ë¦„", type: "city", price: 160000, rent: 120000, color: "#fbbf24", code: "se" },
            { id: 15, name: "ì½©ì½”ë“œ", type: "city", price: 250000, rent: 200000, color: "#ec4899", emoji: "âœˆï¸" },
            { id: 16, name: "ì·¨ë¦¬íˆ", type: "city", price: 180000, rent: 140000, color: "#fbbf24", code: "ch" },
            { id: 17, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 18, name: "ë² ë¥¼ë¦°", type: "city", price: 200000, rent: 160000, color: "#fbbf24", code: "de" },
            { id: 19, name: "ì˜¤íƒ€ì™€", type: "city", price: 200000, rent: 160000, color: "#fbbf24", code: "ca" },
            { id: 20, name: "ì‚¬íšŒë³µì§€", type: "corner", emoji: "ğŸ¦", color: "#fef3c7" },
            { id: 21, name: "ë¶€ì—ë…¸ìŠ¤", type: "city", price: 220000, rent: 180000, color: "#4ade80", code: "ar" },
            { id: 22, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 23, name: "ìƒíŒŒìš¸ë£¨", type: "city", price: 240000, rent: 200000, color: "#4ade80", code: "br" },
            { id: 24, name: "ì‹œë“œë‹ˆ", type: "city", price: 240000, rent: 200000, color: "#4ade80", code: "au" },
            { id: 25, name: "ë¶€ì‚°", type: "city", price: 300000, rent: 250000, color: "#ec4899", code: "kr" },
            { id: 26, name: "í•˜ì™€ì´", type: "city", price: 260000, rent: 220000, color: "#4ade80", code: "us" },
            { id: 27, name: "ë¦¬ìŠ¤ë³¸", type: "city", price: 260000, rent: 220000, color: "#4ade80", code: "pt" },
            { id: 28, name: "í€¸ì¦ˆí˜¸", type: "city", price: 300000, rent: 250000, color: "#ec4899", emoji: "ğŸš¢" },
            { id: 29, name: "ë§ˆë“œë¦¬ë“œ", type: "city", price: 280000, rent: 240000, color: "#4ade80", code: "es" },
            { id: 30, name: "ìš°ì£¼ì—¬í–‰", type: "corner", emoji: "ğŸš€", color: "#fef3c7" },
            { id: 31, name: "ë„ì¿„", type: "city", price: 300000, rent: 260000, color: "#60a5fa", code: "jp" },
            { id: 32, name: "íŒŒë¦¬", type: "city", price: 320000, rent: 280000, color: "#60a5fa", code: "fr" },
            { id: 33, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 34, name: "ë¡œë§ˆ", type: "city", price: 320000, rent: 280000, color: "#60a5fa", code: "it" },
            { id: 35, name: "ì»¬ëŸ¼ë¹„ì•„", type: "city", price: 450000, rent: 350000, color: "#ec4899", emoji: "ğŸš€" },
            { id: 36, name: "ëŸ°ë˜", type: "city", price: 350000, rent: 300000, color: "#60a5fa", code: "gb" },
            { id: 37, name: "ë‰´ìš•", type: "city", price: 350000, rent: 300000, color: "#60a5fa", code: "us" },
            { id: 38, name: "ì„¸ê¸ˆ", type: "tax", emoji: "ğŸ’¸", color: "#fef3c7" },
            { id: 39, name: "ì„œìš¸", type: "city", price: 500000, rent: 450000, color: "#60a5fa", code: "kr" }
        ];

        function generateGridPositions() {
            let pos = [];
            for(let i=11; i>=1; i--) pos.push([11, i]); 
            for(let i=10; i>=1; i--) pos.push([i, 1]);  
            for(let i=2; i<=11; i++) pos.push([1, i]);  
            for(let i=2; i<=10; i++) pos.push([i, 11]); 
            return pos;
        }
        const gridPositions = generateGridPositions();

        class GrandBlueMarble {
            constructor(playerCount) {
                const icons = ['ğŸš—', 'âœˆï¸', 'ğŸš¢', 'ğŸš', 'ğŸš²', 'ğŸš€'];
                const names = ['P1', 'P2', 'P3', 'P4', 'P5', 'P6'];
                
                this.players = Array.from({length: playerCount}, (_, i) => ({
                    id: i + 1,
                    pos: 0,
                    money: 2000000,
                    name: names[i],
                    icon: icons[i],
                    isBankrupt: false,
                    doubleCount: 0 
                }));

                this.currentPlayerIndex = 0;
                this.isRolling = false;
                this.lastWasDouble = false; 
                this.properties = Array(boardData.length).fill(null);
                
                this.initUI();
                this.initBoard();
            }

            initUI() {
                const pList = document.getElementById('player-list');
                pList.innerHTML = '';
                this.players.forEach(p => {
                    const card = document.createElement('div');
                    card.id = `card-p${p.id}`;
                    card.className = `bg-white p-2 rounded-2xl shadow-sm border-l-8 border-slate-200 flex flex-col gap-1 transition-all duration-300 relative`;
                    card.style.borderLeftColor = this.getPlayerColor(p.id);
                    card.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-black flex items-center gap-2">
                                <span class="text-3xl">${p.icon}</span> ${p.name}
                            </span>
                            <span id="turn-p${p.id}" class="text-[7px] font-black px-1.5 py-0.5 rounded-full bg-indigo-600 text-white hidden">TURN NOW</span>
                        </div>
                        <div class="text-[11px] font-bold text-slate-800">â‚© <span id="money-p${p.id}">${p.money.toLocaleString()}</span></div>
                        <div id="owned-p${p.id}" class="flex flex-wrap gap-1 mt-0.5 min-h-[12px]"></div>
                    `;
                    pList.appendChild(card);

                    const piece = document.createElement('div');
                    piece.id = `p${p.id}`;
                    piece.className = `piece p-bg-${p.id}`;
                    piece.innerText = p.icon;
                    document.getElementById('game-board').appendChild(piece);
                });
                this.updateStatus();
            }

            initBoard() {
                const board = document.getElementById('game-board');
                boardData.forEach((data, index) => {
                    const div = document.createElement('div');
                    div.className = `square ${data.type}`;
                    div.id = `square-${index}`;
                    
                    const pos = gridPositions[index];
                    div.style.gridRow = pos[0];
                    div.style.gridColumn = pos[1];

                    if (data.type === 'city') {
                        div.style.borderTopColor = data.color;
                        let innerHTML = `<div class="text-[0.45rem] text-gray-400 font-bold">â‚©${data.price.toLocaleString()}</div>`;
                        
                        if (data.code) {
                            innerHTML += `<img src="https://flagcdn.com/w40/${data.code}.png" class="flag-img" onerror="this.style.display='none'">`;
                        } else if (data.emoji) {
                            innerHTML += `<div class="text-xl my-0.5">${data.emoji}</div>`;
                        }
                        
                        innerHTML += `
                            <div class="font-bold text-[0.58rem] text-slate-700">${data.name}</div>
                            <div id="owner-${index}" class="mt-auto flex flex-col items-center gap-0.5"></div>
                        `;
                        div.innerHTML = innerHTML;
                    } else {
                        div.style.backgroundColor = data.color;
                        div.innerHTML = `
                            <div class="text-2xl mb-1">${data.emoji || ''}</div>
                            <div class="font-bold text-[0.7rem] text-slate-800">${data.name}</div>
                        `;
                    }
                    board.appendChild(div);
                });
                this.updatePiecePositions();
            }

            getPlayerColor(id) {
                return ['#ff0000', '#0066ff', '#00cc44', '#ffcc00', '#aa00ff', '#ff0099'][id - 1];
            }

            updatePiecePositions() {
                const posGroups = {};
                this.players.forEach(p => {
                    if(!posGroups[p.pos]) posGroups[p.pos] = [];
                    posGroups[p.pos].push(p);
                });

                Object.keys(posGroups).forEach(pos => {
                    const playersAtPos = posGroups[pos];
                    const square = document.getElementById(`square-${pos}`);
                    playersAtPos.forEach((p, i) => {
                        const piece = document.getElementById(`p${p.id}`);
                        if (p.isBankrupt) { piece.style.display = 'none'; return; }
                        const offsetMap = [[0, 0], [10, 10], [-10, -10], [10, -10], [-10, 10], [0, -14]];
                        const offset = offsetMap[i] || [0, 0];
                        piece.style.top = `${square.offsetTop + square.offsetHeight/2 - 16 + offset[1]}px`;
                        piece.style.left = `${square.offsetLeft + square.offsetWidth/2 - 16 + offset[0]}px`;
                    });
                });
            }

            updateStatus() {
                this.players.forEach(p => {
                    const moneyEl = document.getElementById(`money-p${p.id}`);
                    const card = document.getElementById(`card-p${p.id}`);
                    const turnTag = document.getElementById(`turn-p${p.id}`);
                    const ownedContainer = document.getElementById(`owned-p${p.id}`);
                    
                    if (moneyEl) moneyEl.innerText = p.money.toLocaleString();
                    
                    if (this.currentPlayerIndex === p.id - 1) {
                        card.classList.add('active-player-card', 'turn-anim');
                        turnTag.classList.remove('hidden');
                        document.getElementById('turn-display').innerText = `${p.name} TURN`;
                    } else {
                        card.classList.remove('active-player-card', 'turn-anim');
                        turnTag.classList.add('hidden');
                    }

                    if (p.isBankrupt) card.classList.add('grayscale', 'opacity-40');

                    const ownedCities = boardData.filter((_, idx) => this.properties[idx] === p.id);
                    ownedContainer.innerHTML = ownedCities.map(city => `
                        <span class="text-[7px] px-1.5 py-0.5 rounded-full text-white font-black shadow-sm" style="background-color: ${city.color}">
                            ${city.name}
                        </span>
                    `).join('');
                    
                    if(ownedCities.length === 0) {
                        ownedContainer.innerHTML = `<span class="text-[7px] text-slate-300 italic px-1">ì†Œìœ  ì§€ì—­ ì—†ìŒ</span>`;
                    }
                });
            }

            log(msg, colorClass = "text-slate-400") {
                const logBox = document.getElementById('game-log');
                const div = document.createElement('div');
                div.className = `leading-relaxed border-l-2 pl-2 border-slate-700 ${colorClass}`;
                div.innerHTML = msg;
                logBox.prepend(div);
            }

            rollDice() {
                if (this.isRolling) return;
                this.isRolling = true;
                
                const btn = document.getElementById('roll-btn');
                const overlay = document.getElementById('dice-overlay');
                const d1El = document.getElementById('dice-1');
                const d2El = document.getElementById('dice-2');
                
                btn.disabled = true;
                overlay.style.display = 'flex';
                
                const interval = setInterval(() => {
                    d1El.innerText = Math.floor(Math.random() * 6) + 1;
                    d2El.innerText = Math.floor(Math.random() * 6) + 1;
                }, 100);

                setTimeout(() => {
                    clearInterval(interval);
                    const d1 = Math.floor(Math.random() * 6) + 1;
                    const d2 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2;
                    const isDouble = (d1 === d2);
                    
                    d1El.innerText = d1;
                    d2El.innerText = d2;
                    
                    const player = this.players[this.currentPlayerIndex];

                    setTimeout(async () => {
                        overlay.style.display = 'none';
                        this.log(`ğŸ² ê²°ê³¼: <b>${d1} + ${d2} = ${total}</b> ${isDouble ? '<span class="text-indigo-400">[ë”ë¸”!]</span>' : ''}`, "text-white font-bold");
                        
                        if (isDouble) {
                            player.doubleCount++;
                            if (player.doubleCount === 3) {
                                this.log(`âš ï¸ <b>3ì—°ì† ë”ë¸”!</b> ê³¼ì†ìœ¼ë¡œ ë¬´ì¸ë„ì— ê°‡í™ë‹ˆë‹¤.`, "text-red-500 font-black");
                                player.pos = 10; 
                                player.doubleCount = 0;
                                this.updatePiecePositions();
                                this.endTurn(true); 
                                return;
                            }
                            this.lastWasDouble = true;
                        } else {
                            player.doubleCount = 0;
                            this.lastWasDouble = false;
                        }

                        await this.movePlayer(total);
                    }, 1000);
                }, 1500);
            }

            async movePlayer(steps) {
                const player = this.players[this.currentPlayerIndex];
                for(let i = 0; i < steps; i++) {
                    player.pos = (player.pos + 1) % boardData.length;
                    if (player.pos === 0) {
                        player.money += 200000;
                        this.log(`ğŸ’° <b>${player.name}</b>ë‹˜ì´ ì¶œë°œì§€ë¥¼ í†µê³¼í•˜ì—¬ <b>â‚©200,000</b>ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.`, "text-yellow-400");
                    }
                    this.updatePiecePositions();
                    await new Promise(r => setTimeout(r, 120));
                }
                this.handleSquare(player.pos);
            }

            handleSquare(pos) {
                const square = boardData[pos];
                const player = this.players[this.currentPlayerIndex];
                this.log(`ğŸƒ <b>${player.name}</b> â†’ <b>${square.name}</b>`, "text-slate-300");

                if (square.type === 'city') {
                    const ownerId = this.properties[pos];
                    if (ownerId === null) {
                        this.showModal(square);
                        return;
                    } else if (ownerId !== player.id) {
                        this.payRent(player, this.players[ownerId - 1], square);
                    }
                } else if (square.type === 'tax') {
                    const tax = 200000;
                    player.money -= tax;
                    this.log(`ğŸ’¸ ì„¸ê¸ˆ â‚©${tax.toLocaleString()} ë‚©ë¶€`, "text-red-400 font-bold");
                } else if (square.type === 'chance') {
                    const bonus = 100000;
                    player.money += bonus;
                    this.log(`ğŸ í™©ê¸ˆì—´ì‡  ë³´ë„ˆìŠ¤ â‚©${bonus.toLocaleString()}`, "text-green-400 font-bold");
                }
                
                this.checkPostAction();
            }

            checkPostAction() {
                if (this.lastWasDouble) {
                    this.log(`âœ¨ <b>ë”ë¸”!</b> í•œ ë²ˆ ë” ë˜ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ${this.players[this.currentPlayerIndex].doubleCount}íšŒ ì—°ì†)`, "text-indigo-300 font-bold");
                    this.isRolling = false;
                    document.getElementById('roll-btn').disabled = false;
                    this.updateStatus();
                } else {
                    this.endTurn();
                }
            }

            showModal(square) {
                const modal = document.getElementById('modal');
                const flagContainer = document.getElementById('modal-flag-container');
                
                if(square.code) {
                    flagContainer.innerHTML = `<img src="https://flagcdn.com/w160/${square.code}.png" class="mx-auto rounded-xl shadow-2xl border-4 border-white max-w-[140px]">`;
                } else if (square.emoji) {
                    flagContainer.innerHTML = `<span class="text-7xl drop-shadow-lg">${square.emoji}</span>`;
                }
                
                document.getElementById('modal-title').innerText = `${square.name} ë§¤ì…`;
                document.getElementById('modal-desc').innerHTML = `ì´ ì§€ì—­ì˜ ë§¤ë§¤ê°€ëŠ” <b>â‚©${square.price.toLocaleString()}</b>ì›ì…ë‹ˆë‹¤.\nêµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                modal.classList.remove('hidden');
            }

            confirmAction() {
                const player = this.players[this.currentPlayerIndex];
                const square = boardData[player.pos];
                if (player.money >= square.price) {
                    player.money -= square.price;
                    this.properties[player.pos] = player.id;
                    const ownerTag = document.getElementById(`owner-${player.pos}`);
                    
                    // ë³´ë“œ ìœ„ ì†Œìœ ì£¼ í‘œì‹œ ê°•í™” (ì´ëª¨ì§€ ì¶”ê°€)
                    ownerTag.innerHTML = `
                        <span class="text-lg">${player.icon}</span>
                        <span class="text-[0.4rem] font-black uppercase tracking-tighter" style="color: ${this.getPlayerColor(player.id)}">OWNER: ${player.name}</span>
                    `;
                    
                    this.log(`ğŸ  <b>${player.name}</b>ë‹˜ì´ <b>${square.name}</b>ì„ ë§¤ì…í–ˆìŠµë‹ˆë‹¤.`, "text-indigo-300 font-bold");
                    this.closeModal();
                    this.checkPostAction(); 
                } else {
                    alert("ì”ì•¡ ë¶€ì¡±!");
                    this.cancelAction();
                }
            }

            cancelAction() { 
                this.closeModal(); 
                this.checkPostAction(); 
            }

            closeModal() { document.getElementById('modal').classList.add('hidden'); }

            payRent(player, owner, square) {
                if (owner.isBankrupt) return;
                player.money -= square.rent;
                owner.money += square.rent;
                this.log(`ğŸ”” <b>${player.name}</b> â†’ <b>${owner.name}</b> í†µí–‰ë£Œ â‚©${square.rent.toLocaleString()}`, "text-orange-400 font-bold");
                if (player.money < 0) this.bankrupt(player);
            }

            bankrupt(player) {
                player.isBankrupt = true;
                this.log(`ğŸš« <b>${player.name}</b> íŒŒì‚°!`, "text-red-500 font-black");
                this.properties.forEach((id, idx) => {
                    if (id === player.id) {
                        this.properties[idx] = null;
                        document.getElementById(`owner-${idx}`).innerText = '';
                    }
                });
                this.updatePiecePositions();
            }

            endTurn(forceNext = false) {
                this.updateStatus();
                
                if (!this.lastWasDouble || forceNext) {
                    let next = (this.currentPlayerIndex + 1) % this.players.length;
                    
                    if (this.players.filter(p => !p.isBankrupt).length <= 1) {
                        const winner = this.players.find(p => !p.isBankrupt);
                        alert(`ğŸ† ìµœì¢… ìš°ìŠ¹ìëŠ” ${winner.name}ë‹˜ì…ë‹ˆë‹¤!`);
                        location.reload();
                        return;
                    }

                    while (this.players[next].isBankrupt) {
                        next = (next + 1) % this.players.length;
                    }
                    this.currentPlayerIndex = next;
                    this.players[this.currentPlayerIndex].doubleCount = 0; 
                }

                this.isRolling = false;
                this.lastWasDouble = false;
                document.getElementById('roll-btn').disabled = false;
                this.updateStatus();
            }
        }

        function startGame(count) {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game-board').classList.remove('opacity-0');
            window.game = new GrandBlueMarble(count);
        }
    </script>
</body>
</html>
