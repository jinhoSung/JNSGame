<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¸Œë£¨ë§ˆë¸” ê·¸ëœë“œ - ë©€í‹°í”Œë ˆì´ì–´ & ì‹±ê¸€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap');

        :root {
            --board-size: min(96vw, 85vh);
            --square-font: clamp(0.35rem, 0.9vw, 0.6rem);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #cbd5e1;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            touch-action: manipulation;
        }

        .game-font { font-family: 'Black Han Sans', sans-serif; }

        .board-grid {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            gap: 1px;
            width: var(--board-size);
            height: var(--board-size);
            background-color: #334155;
            padding: clamp(2px, 0.5vw, 8px);
            border-radius: clamp(8px, 1.5vw, 20px);
            position: relative;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .square {
            background-color: white;
            border-radius: 2px;
            display: flex;
            flex-direction: column; 
            font-size: var(--square-font);
            position: relative;
            padding: 0; 
            text-align: center;
            word-break: keep-all;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.1);
            min-width: 0; min-height: 0;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, z-index 0.2s;
        }
        .square:hover { transform: scale(1.05); z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .square.can-move-to { border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; animation: pulse 1s infinite; }

        .cell-header { flex: 2.8; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 1px solid rgba(0,0,0,0.05); position: relative; font-weight: bold; color: #334155; line-height: 1.1; overflow: hidden; padding: 1px 0; }
        .cell-buildings { flex: 2.2; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5px; background-color: rgba(255,255,255,0.5); flex-wrap: wrap; align-content: center; transform: scale(1.1); transform-origin: center; overflow: hidden; }
        .cell-owner { flex: 2; width: 100%; display: flex; align-items: center; justify-content: center; z-index: 5; overflow: hidden; }
        .cell-spacer { flex: 3; width: 100%; } 
        
        .cell-users { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-wrap: wrap; align-items: center; justify-content: center;
            padding: 2px; gap: 1px; z-index: 10; pointer-events: none; 
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .square.corner { background-color: #fef3c7; }
        .square.city .cell-header { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); } 
        
        .flag-img { width: clamp(8px, 2.2vw, 16px); height: auto; border-radius: 1px; margin-right: 1px; display: inline-block; vertical-align: middle; }
        
        .center-panel {
            grid-area: 2 / 2 / 11 / 11;
            background-color: #f1f5f9;
            display: flex; flex-direction: column;
            padding: clamp(4px, 1.2vw, 10px); gap: 6px;
            overflow: hidden; border-radius: 8px; border: 2px solid #e2e8f0; position: relative;
        }

        .piece {
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: clamp(0.5rem, 1.5vw, 1rem); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            aspect-ratio: 1 / 1; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .active-piece { transform: scale(1.15); z-index: 50; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 2px solid white; filter: grayscale(0%); opacity: 1; }
        .inactive-piece { transform: scale(0.65); z-index: 10; opacity: 0.6; filter: grayscale(70%); border: 1px solid rgba(255,255,255,0.5); box-shadow: none; }
        .piece.moving { transform: scale(1.3) translateY(-15%); z-index: 60; opacity: 1; filter: none; }

        .top-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 200; }
        .top-controls-left { position: absolute; top: 10px; left: 10px; display: flex; gap: 8px; z-index: 200; }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.95); border: 1px solid #cbd5e1; padding: 6px 12px;
            border-radius: 8px; font-size: 0.75rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; display: flex; align-items: center; gap: 4px;
        }
        .control-btn:hover { background: white; transform: scale(1.05); }

        .dice-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; flex-direction: column; align-items: center; gap: 15px;
            z-index: 100; pointer-events: none; width: 100%;
        }
        .dice-box-container { display: flex; gap: 15px; }
        .dice-box {
            width: clamp(45px, 11vw, 75px); height: clamp(45px, 11vw, 75px);
            background: white; border-radius: 12px; display: flex; align-items: center;
            justify-content: center; font-size: clamp(1.8rem, 5.5vw, 3rem);
            font-weight: 800; color: #334155; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 4px solid #6366f1; animation: dice-pop 0.3s ease-out forwards;
        }
        @keyframes dice-pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .event-info-box {
            background: rgba(255, 255, 255, 0.98); padding: 20px 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
            border: 4px solid #facc15; animation: dice-pop 0.4s ease-out forwards; pointer-events: auto;
        }
        
        .log-container::-webkit-scrollbar { width: 3px; }
        .log-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .p-bg-1 { background-color: #ff0000; } .p-bg-2 { background-color: #0066ff; } .p-bg-3 { background-color: #00cc44; }
        .p-bg-4 { background-color: #ffcc00; } .p-bg-5 { background-color: #aa00ff; } .p-bg-6 { background-color: #ff0099; }
        
        .player-card-content { font-size: clamp(0.6rem, 1.5vw, 0.8rem); }
        .player-money { font-size: clamp(0.65rem, 1.6vw, 0.9rem); }
        .player-badge { font-size: 0.55rem; padding: 1px 3px; }

        #loading-screen {
            position: fixed; inset: 0; background: #334155; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
            transition: opacity 0.5s;
        }

        .timer-warning {
            color: #ef4444 !important;
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none;
        }
        .toast {
            background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: toast-in 0.3s ease-out, toast-out 0.3s ease-in 2.7s forwards;
        }
        @keyframes toast-in { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out { from { opacity: 1; } to { opacity: 0; } }

        .chat-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95); border-top: 1px solid #cbd5e1;
            padding: 8px; display: flex; gap: 4px; z-index: 100;
            max-height: 150px; flex-direction: column;
        }
        .chat-messages {
            flex: 1; overflow-y: auto; font-size: 0.7rem; margin-bottom: 4px;
            display: flex; flex-direction: column; gap: 2px; height: 80px;
        }
        .chat-input-row { display: flex; gap: 4px; }
        .chat-msg { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; word-break: break-all; }
        .chat-msg.system { background: transparent; color: #64748b; font-style: italic; text-align: center; font-size: 0.65rem;}
    </style>
</head>
<body>

    <!-- ì´ˆê¸° ë¡œë”© í™”ë©´ -->
    <div id="loading-screen">
        <div class="text-4xl mb-4">ğŸ²</div>
        <div class="font-bold text-xl">ê²Œì„ ë¦¬ì†ŒìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="text-xs text-slate-400 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
    <div id="toast-container"></div>

    <div class="top-controls-left" style="display: none;">
        <button id="info-btn" class="control-btn bg-blue-50 text-blue-600 border-blue-200" onclick="showGameInfo()">â„¹ï¸ ê²Œì„ì„¤ëª…</button>
        <button id="quit-btn" class="control-btn bg-red-50 text-red-600 border-red-200" onclick="quitGame()">ğŸ  ë¡œë¹„</button>
    </div>

    <div class="top-controls" style="display: none;">
        <button id="speed-btn" class="control-btn" onclick="toggleGlobalSpeed()">â© x1</button>
        <button id="fullscreen-btn" class="control-btn" onclick="toggleFullScreen()">ğŸ–¥ï¸</button>
    </div>

    <!-- ë¡œë¹„ -->
    <div id="lobby-container" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4 hidden">
        <div id="network-lobby" class="bg-white rounded-3xl p-6 w-full max-w-lg shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl md:text-3xl font-black text-indigo-600 tracking-tighter uppercase">Blue Marble</h1>
                <div class="flex gap-2">
                    <button onclick="openModal('local-setup-modal'); updateLocalPlayerInputs();" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg font-bold text-xs shadow transition">ğŸ® ì‹±ê¸€/ë¡œì»¬</button>
                    <button onclick="openModal('create-room-modal')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg font-bold text-xs shadow transition">+ ë°© ë§Œë“¤ê¸°</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-500 mb-1 block">ë‚´ ë‹‰ë„¤ì„</label>
                <input type="text" id="my-nickname" class="w-full p-2.5 rounded-xl border-2 border-slate-200 text-sm font-bold focus:border-indigo-500 outline-none placeholder-gray-300" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" autocomplete="off">
            </div>

            <div class="flex-1 overflow-y-auto space-y-3 p-1" id="room-list">
                <div class="text-center text-gray-400 py-10">ë¡œë”©ì¤‘...</div>
            </div>
            <div class="mt-4 pt-4 border-t text-center text-xs text-gray-400">Lobby System Powered by Firebase</div>
        </div>

        <!-- ëŒ€ê¸°ì‹¤ -->
        <div id="room-waiting" class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl text-center hidden">
            <h2 id="room-title-display" class="text-2xl font-black text-slate-800 mb-2">Room Title</h2>
            <div class="text-sm text-gray-500 mb-6">ê²Œì„ ì‹œì‘ì„ ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤...</div>
            <div id="waiting-user-list" class="space-y-2 mb-8 text-left max-h-[40vh] overflow-y-auto"></div>
            
            <div class="flex gap-3">
                <button onclick="leaveRoom()" class="flex-1 py-3 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300">ë‚˜ê°€ê¸°</button>
                <button id="host-start-btn" onclick="hostStartGame()" class="flex-[2] py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-xl hover:bg-indigo-700 hidden">ê²Œì„ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <!-- ë¡œì»¬ ê²Œì„ ì„¤ì • ëª¨ë‹¬ -->
    <div id="local-setup-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[150] hidden backdrop-blur-sm px-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-slate-800">ì‹±ê¸€/ë¡œì»¬ ê²Œì„ ì„¤ì •</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-600">ğŸ™‹â€â™‚ï¸ ì‚¬ëŒ í”Œë ˆì´ì–´</label>
                    <select id="human-count" onchange="updateCpuOptions(); updateLocalPlayerInputs();" class="w-full p-2.5 rounded-xl border-2 border-slate-200 font-bold outline-none">
                        <option value="1">1ëª… (ì†”ë¡œ)</option>
                        <option value="2" selected>2ëª…</option>
                        <option value="3">3ëª…</option>
                        <option value="4">4ëª…</option>
                        <option value="5">5ëª…</option>
                        <option value="6">6ëª…</option>
                    </select>
                </div>
                
                <!-- ë™ì  ì´ë¦„ ì…ë ¥ì¹¸ -->
                <div id="local-player-names" class="space-y-2 max-h-[200px] overflow-y-auto"></div>

                <div>
                    <label class="text-xs font-bold text-slate-600">ğŸ¤– ì»´í“¨í„°(CPU)</label>
                    <select id="cpu-count" class="w-full p-2.5 rounded-xl border-2 border-slate-200 font-bold outline-none"></select>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeModal('local-setup-modal')" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl">ì·¨ì†Œ</button>
                <button onclick="checkAndStart()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">ì‹œì‘</button>
            </div>
        </div>
    </div>

    <!-- ë°© ë§Œë“¤ê¸° ëª¨ë‹¬ -->
    <div id="create-room-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[150] hidden backdrop-blur-sm px-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-xs shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-slate-800">ìƒˆë¡œìš´ ë°© ë§Œë“¤ê¸°</h3>
            <form onsubmit="event.preventDefault(); window.createRoom();" class="space-y-3">
                <input id="new-room-name" type="text" placeholder="ë°© ì œëª©" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold focus:border-indigo-500 outline-none" required autocomplete="off">
                <input id="new-room-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì„ íƒ)" autocomplete="new-password" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold focus:border-indigo-500 outline-none">
                <div class="flex items-center justify-between px-1">
                    <span class="text-sm font-bold text-slate-600">ìµœëŒ€ ì¸ì›</span>
                    <select id="new-room-max" class="p-2 border-2 border-slate-200 rounded-lg font-bold">
                        <option value="2">2ëª…</option>
                        <option value="3">3ëª…</option>
                        <option value="4" selected>4ëª…</option>
                        <option value="5">5ëª…</option>
                        <option value="6">6ëª…</option>
                    </select>
                </div>
                <!-- CPU ì¶”ê°€ ì˜µì…˜ -->
                <div class="flex items-center justify-between px-1">
                    <span class="text-sm font-bold text-slate-600">CPU ì¸ì›</span>
                    <select id="new-room-cpu" class="p-2 border-2 border-slate-200 rounded-lg font-bold">
                        <option value="0">ì—†ìŒ</option>
                        <option value="1">1ëª…</option>
                        <option value="2">2ëª…</option>
                        <option value="3">3ëª…</option>
                        <option value="4">4ëª…</option>
                    </select>
                </div>
                <div class="flex gap-2 mt-6">
                    <button type="button" onclick="closeModal('create-room-modal')" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl">ì·¨ì†Œ</button>
                    <button type="submit" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">ìƒì„±</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ê²Œì„ íŒ -->
    <div id="game-board-container" class="hidden">
        <div id="game-board" class="board-grid opacity-0 transition-opacity duration-500">
             <!-- Javascriptê°€ ë‚´ìš©ì„ ì±„ì›€ -->
        </div>
    </div>

    <!-- ëª¨ë‹¬ ë“± ê²Œì„ ê´€ë ¨ UI ìš”ì†Œë“¤ -->
    <div id="modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[110] hidden backdrop-blur-md px-4">
        <div class="bg-white p-6 rounded-2xl max-w-xs w-full shadow-2xl text-center border-b-8 border-indigo-600">
            <div id="modal-flag-container" class="mb-3 transform scale-100"></div>
            <h2 id="modal-title" class="text-xl font-bold mb-1">êµ¬ë§¤</h2>
            <p id="modal-desc" class="text-xs text-gray-500 mb-6 whitespace-pre-line leading-relaxed"></p>
            <div class="flex gap-2">
                <button onclick="window.game.cancelAction()" class="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl text-sm">ì·¨ì†Œ</button>
                <button id="confirm-btn" onclick="window.game.confirmAction()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-xl text-sm">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ì¸ìˆ˜ ëª¨ë‹¬ -->
    <div id="acquire-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[115] hidden backdrop-blur-md px-4">
        <div class="bg-white p-6 rounded-2xl max-w-xs w-full shadow-2xl text-center border-t-8 border-yellow-500">
            <div class="text-4xl mb-2">ğŸ™ï¸</div>
            <h2 class="text-xl font-bold mb-1 text-slate-800">ë„ì‹œ ì¸ìˆ˜</h2>
            <p id="acquire-desc" class="text-xs text-gray-500 mb-6 whitespace-pre-line leading-relaxed"></p>
            <div class="flex gap-2">
                <button onclick="window.game.cancelAcquire()" class="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl text-sm">ì·¨ì†Œ</button>
                <button onclick="window.game.confirmAcquire()" class="flex-1 py-3 bg-yellow-500 text-white font-bold rounded-xl shadow-xl text-sm hover:bg-yellow-600">ì¸ìˆ˜í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="build-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[110] hidden backdrop-blur-md px-4">
        <div class="bg-white p-5 rounded-2xl w-full max-w-xs shadow-2xl border-b-8 border-indigo-600">
            <h2 class="text-xl font-bold mb-1 text-center text-slate-800">ê±´ë¬¼ ê±´ì„¤</h2>
            <p class="text-[10px] text-gray-500 mb-4 text-center">ê±´ë¬¼ì„ ì„ íƒí•˜ì„¸ìš” (ì¤‘ë³µ ê±´ì„¤ ê°€ëŠ¥)</p>
            <div class="flex flex-col gap-2" id="build-options"></div>
            <button onclick="window.game.closeBuildModal()" class="w-full mt-3 py-3 bg-slate-100 text-slate-500 font-bold rounded-xl hover:bg-slate-200 text-sm">ê±´ì„¤ ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="choice-modal" class="fixed inset-0 bg-black/85 flex items-center justify-center z-[150] hidden backdrop-blur-md px-4">
        <div class="bg-white p-6 rounded-3xl max-w-xs w-full shadow-2xl text-center border-t-8 border-green-500">
            <div id="choice-emoji" class="text-5xl mb-2">ğŸ«</div>
            <h2 id="choice-title" class="text-xl font-black text-slate-800 mb-2">ì¹´ë“œ ì‚¬ìš©</h2>
            <p id="choice-desc" class="text-sm text-gray-600 mb-6 font-medium leading-relaxed"></p>
            <div class="flex gap-3">
                <button id="choice-no-btn" class="flex-1 py-3 bg-gray-200 text-gray-600 font-bold rounded-xl text-sm hover:bg-gray-300">ì•„ë‹ˆì˜¤</button>
                <button id="choice-yes-btn" class="flex-1 py-3 bg-green-600 text-white font-bold rounded-xl shadow-xl hover:bg-green-700 text-sm">ì‚¬ìš©í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="game-info-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[200] hidden backdrop-blur-sm p-4" onclick="closeGameInfo()">
        <div class="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col shadow-2xl border-t-8 border-indigo-500 overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h2 class="text-2xl font-black text-slate-800">ê²Œì„ ê·œì¹™</h2>
                <button onclick="closeGameInfo()" class="text-2xl text-slate-400 hover:text-slate-600">Ã—</button>
            </div>
            <div class="p-6 overflow-y-auto text-sm text-slate-600 leading-relaxed space-y-4">
               <div><h3 class="font-bold text-indigo-600 text-lg mb-1">ğŸš© ìŠ¹ë¦¬ ì¡°ê±´</h3><p>ìƒëŒ€ íŒŒì‚° ë˜ëŠ” 30ë¼ìš´ë“œ ì¢…ë£Œ í›„ ìì‚° 1ìœ„.</p></div>
               <div><h3 class="font-bold text-indigo-600 text-lg mb-1">ğŸ² ì§„í–‰</h3><p>ì£¼ì‚¬ìœ„ ì´ë™. ë”ë¸” ì‹œ ì¬í–‰ë™(íŠ¹ìˆ˜ ì´ë™ ì‹œ í„´ ì¢…ë£Œ). <span class="text-red-500">ë©€í‹°í”Œë ˆì´ ì‹œ ë‚´ í„´ì—ë§Œ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span> ì œí•œì‹œê°„ 15ì´ˆ ì´ˆê³¼ ì‹œ ìë™ ì§„í–‰.</p></div>
               <div><h3 class="font-bold text-indigo-600 text-lg mb-1">ğŸš€ íŠ¹ìˆ˜ ê·œì¹™</h3>
                   <ul class="list-disc pl-5">
                       <li>ìš°ì£¼ì—¬í–‰: ìš”ê¸ˆ ì§€ë¶ˆ í›„ í„´ ì¢…ë£Œ, ë‹¤ìŒ í„´ ì›í•˜ëŠ” ê³³ ì´ë™.</li>
                       <li>ë¬´ì¸ë„: 3í„´ ëŒ€ê¸°. íƒˆì¶œê¶Œ/ë”ë¸”ë¡œ íƒˆì¶œ.</li>
                       <li><strong>ì¸ìˆ˜:</strong> ìƒëŒ€ë°© ë•… ë„ì°© ì‹œ í†µí–‰ë£Œ ì§€ë¶ˆ í›„, ê±´ì„¤ë¹„ìš© 2ë°°ë¡œ ì¸ìˆ˜ ê°€ëŠ¥.</li>
                   </ul>
               </div>
            </div>
            <div class="p-4 border-t bg-slate-50"><button onclick="closeGameInfo()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">ë‹«ê¸°</button></div>
        </div>
    </div>

    <div id="game-over-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[200] hidden backdrop-blur-xl px-4">
        <div class="bg-white p-6 rounded-2xl max-w-xs w-full shadow-2xl text-center border-t-8 border-yellow-400">
            <div class="text-5xl mb-3">ğŸ†</div>
            <h2 class="text-2xl font-black text-slate-800 mb-1">GAME OVER</h2>
            <p id="winner-name" class="text-lg font-bold text-indigo-600 mb-4"></p>
            <div id="ranking-list" class="text-left space-y-1.5 mb-6 bg-slate-50 p-3 rounded-xl text-xs"></div>
            <button onclick="quitGame()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-xl hover:bg-indigo-700 text-sm">ë¡œë¹„ë¡œ ì´ë™</button>
        </div>
    </div>

    <div id="property-card" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[120] hidden backdrop-blur-sm px-4" onclick="closePropertyCardGlobal()">
        <div class="bg-white rounded-2xl w-full max-w-xs overflow-hidden shadow-2xl border-t-8" id="prop-card-border" onclick="event.stopPropagation()">
            <div class="bg-slate-50 p-4 text-center border-b">
                <div id="prop-flag" class="mb-1"></div>
                <h3 id="prop-name" class="text-xl font-bold text-slate-800 tracking-tighter">ë„ì‹œì´ë¦„</h3>
                <p id="prop-tag" class="text-[9px] font-bold text-indigo-500 uppercase tracking-widest mt-0.5"></p>
            </div>
            <div class="p-4 space-y-3">
                <div id="price-info">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">íˆ¬ì ë° ê±´ì„¤ ë¹„ìš©</p>
                    <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-[10px]">
                        <div class="text-slate-500 font-bold">ëŒ€ì§€ ë§¤ì…</div><div class="text-right font-bold text-indigo-600" id="cost-land">â‚©0</div>
                        <div id="building-costs-ui" class="flex flex-col gap-0.5 col-span-2 mt-0.5">
                            <div class="flex justify-between text-slate-700"><span>ğŸ¡ ë³„ì¥</span><span class="font-bold" id="cost-villa">â‚©0</span></div>
                            <div class="flex justify-between text-slate-700"><span>ğŸ¢ ë¹Œë”©</span><span class="font-bold" id="cost-build">â‚©0</span></div>
                            <div class="flex justify-between text-slate-700"><span>ğŸ¨ í˜¸í…”</span><span class="font-bold" id="cost-hotel">â‚©0</span></div>
                        </div>
                    </div>
                </div>
                <div id="rent-info-area" class="border-t pt-2">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">ë‹¨ê³„ë³„ í†µí–‰ë£Œ (ëˆ„ì )</p>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex justify-between"><span>ëŒ€ì§€ ì „ìš©</span><span class="font-bold" id="rent-1">â‚©0</span></div>
                        <div id="rent-details-ui" class="flex flex-col gap-0.5">
                            <div class="flex justify-between text-blue-600"><span>+ ë³„ì¥</span><span class="font-bold" id="rent-2">â‚©0</span></div>
                            <div class="flex justify-between text-green-600"><span>+ ë¹Œë”©</span><span class="font-bold" id="rent-3">â‚©0</span></div>
                            <div class="flex justify-between text-red-600 font-bold italic"><span>+ í˜¸í…”</span><span id="rent-4">â‚©0</span></div>
                        </div>
                    </div>
                </div>
                <button onclick="closePropertyCardGlobal()" class="w-full py-2.5 bg-slate-800 text-white font-bold rounded-xl mt-2 hover:bg-slate-700 transition tracking-tighter text-xs">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Javascript -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc, arrayUnion, arrayRemove, setDoc, query, orderBy, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getDatabase, ref, onDisconnect, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDP7mDxvaSOJOthbLD22AzVq5SsgSRQE44",
            authDomain: "mymarble-2afb1.firebaseapp.com",
            projectId: "mymarble-2afb1",
            storageBucket: "mymarble-2afb1.firebasestorage.app",
            messagingSenderId: "373463759566",
            appId: "1:373463759566:web:9d9fa31a1404f9bd3f6e9f",
            measurementId: "G-G65TCE21PM",
            databaseURL: "https://mymarble-2afb1-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        
        const GAME_NAMESPACE = 'blue-marble-online-v5'; 

        let currentUser = null;
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let unsubscribeLobby = null; // ë¡œë¹„ ë¦¬ìŠ¤ë„ˆ ì¶”ì 
        let rtdbPresenceRef = null; 
        let isLocalGame = false;
        let heartbeatInterval = null; 

        window.game = null;

        // UI Helpers
        window.showToast = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            if(type === 'error') el.style.background = 'rgba(239, 68, 68, 0.9)';
            else if(type === 'success') el.style.background = 'rgba(34, 197, 94, 0.9)';
            el.innerHTML = msg;
            container.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        };

        // ì´ˆê¸° ë¡œë”© ì œê±°
        setTimeout(() => {
            const loading = document.getElementById('loading-screen');
            if(loading) loading.style.display = 'none';
        }, 2000);

        signInAnonymously(auth).catch((error) => console.error("Auth Error:", error));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log("Logged in as:", user.uid);
                
                const savedNick = localStorage.getItem('gbm_nickname');
                const nickInput = document.getElementById('my-nickname');
                if (nickInput) {
                    nickInput.value = savedNick || `Player ${user.uid.slice(0,4)}`;
                }

                const savedRoomId = localStorage.getItem('gbm_current_room_id');
                if (savedRoomId) {
                    await attemptReconnect(savedRoomId);
                } else {
                    initLobby(); 
                }
            } else {
                currentUser = null;
            }
        });

        // ì¬ì ‘ì† ì‹œë„
        async function attemptReconnect(roomId) {
            const roomRef = doc(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms', roomId);
            try {
                const docSnap = await getDoc(roomRef);
                if (docSnap.exists()) {
                    const room = docSnap.data();
                    const amIIn = room.players.some(p => p.uid === currentUser.uid);
                    
                    if (amIIn) {
                        console.log("Reconnecting to room:", roomId);
                        enterWaitingRoom(roomId); 
                    } else {
                        localStorage.removeItem('gbm_current_room_id');
                        initLobby();
                    }
                } else {
                    localStorage.removeItem('gbm_current_room_id');
                    initLobby();
                }
            } catch (e) {
                console.error("Reconnect failed:", e);
                initLobby();
            }
        }

        function initLobby() {
            if (!currentUser) return;
            
            document.getElementById('lobby-container').classList.remove('hidden');
            document.getElementById('network-lobby').classList.remove('hidden');
            document.getElementById('room-waiting').classList.add('hidden');
            document.getElementById('game-board-container').classList.add('hidden');

            if(currentRoomId) return;

            // ì¤‘ë³µ ë¦¬ìŠ¤ë„ˆ ë°©ì§€
            if (unsubscribeLobby) {
                unsubscribeLobby();
                unsubscribeLobby = null;
            }

            const roomsRef = collection(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms');
            
            unsubscribeLobby = onSnapshot(query(roomsRef, orderBy('createdAt', 'desc')), (snapshot) => {
                if (currentRoomId) return; 

                const list = document.getElementById('room-list');
                if(!list) return;
                list.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const room = doc.data();
                    const isPrivate = room.password && room.password.length > 0;
                    const playerCount = room.players ? room.players.length : 0;
                    
                    const item = document.createElement('div');
                    item.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center hover:border-indigo-400 transition cursor-pointer";
                    item.innerHTML = `
                        <div>
                            <div class="flex items-center gap-2">
                                ${isPrivate ? '<span class="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold">ğŸ”’ ë¹„ê³µê°œ</span>' : '<span class="text-xs bg-green-100 text-green-600 px-1.5 py-0.5 rounded font-bold">ğŸ“¢ ê³µê°œ</span>'}
                                <h3 class="font-bold text-slate-800">${room.name}</h3>
                            </div>
                            <div class="text-xs text-slate-500 mt-1">ë°©ì¥: ${room.hostName} | CPU: ${room.cpuCount || 0}ëª…</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold ${playerCount >= room.maxPlayers ? 'text-red-500' : 'text-indigo-600'}">${playerCount}/${room.maxPlayers}ëª…</span>
                            <button class="px-4 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 disabled:opacity-50" 
                                ${playerCount >= room.maxPlayers || room.status === 'playing' ? 'disabled' : ''}>
                                ${room.status === 'playing' ? 'ê²Œì„ì¤‘' : 'ì…ì¥'}
                            </button>
                        </div>
                    `;
                    
                    if (playerCount < room.maxPlayers && room.status !== 'playing') {
                        item.onclick = () => window.tryJoinRoom(doc.id, room);
                    }
                    list.appendChild(item);
                });

                if (snapshot.empty) {
                    list.innerHTML = `<div class="text-center text-gray-400 py-10">ê°œì„¤ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>`;
                }
            }, (error) => {
                // ...
            });
        }

        // --- Heartbeat Logic ---
        function startHeartbeatLoop() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(async () => {
                if (!currentRoomId || !currentUser) return;
                const roomRef = doc(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms', currentRoomId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(roomRef);
                        if (!sfDoc.exists()) return; // ë°©ì´ ì—†ìŒ

                        const data = sfDoc.data();
                        
                        // 1. ë‚´ lastActive ê°±ì‹ 
                        let myUpdated = false;
                        const newPlayers = data.players.map(p => {
                            if (p.uid === currentUser.uid) {
                                myUpdated = true;
                                return { ...p, lastActive: Date.now() };
                            }
                            return p;
                        });
                        
                        // ë‚´ê°€ ë°©ì— ì—†ë‹¤ë©´(ê°•í‡´ë¨) ì¤‘ë‹¨
                        if (!myUpdated) return;

                        // 2. (ë°©ì¥ë§Œ) íƒ€ì„ì•„ì›ƒëœ ìœ ë ¹ í”Œë ˆì´ì–´ ì œê±°
                        if (data.hostId === currentUser.uid) {
                            const now = Date.now();
                            const TIMEOUT = 60000; // 60ì´ˆ
                            const activePlayers = newPlayers.filter(p => {
                                if (p.isCpu || !p.lastActive) return true; // CPUë‚˜ ë§‰ ë“¤ì–´ì˜¨ ì‚¬ëŒì€ ì˜ˆì™¸
                                return (now - p.lastActive) < TIMEOUT;
                            });

                            if (activePlayers.length !== newPlayers.length) {
                                if (activePlayers.length === 0) {
                                    transaction.delete(roomRef); 
                                } else {
                                    transaction.update(roomRef, { players: activePlayers });
                                }
                            } else {
                                transaction.update(roomRef, { players: newPlayers });
                            }
                        } else {
                            transaction.update(roomRef, { players: newPlayers });
                        }
                    });
                } catch (e) {
                    console.log("Heartbeat error (ignore):", e);
                }
            }, 5000); 
        }

        function stopHeartbeatLoop() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // Attach global functions to window
        window.createRoom = async () => {
            if (!currentUser) return alert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");

            const name = document.getElementById('new-room-name').value;
            const password = document.getElementById('new-room-pw').value;
            const max = parseInt(document.getElementById('new-room-max').value);
            const cpu = parseInt(document.getElementById('new-room-cpu').value);
            
            const myNick = document.getElementById('my-nickname').value || "Guest";
            localStorage.setItem('gbm_nickname', myNick);

            if (!name) return alert("ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                const roomData = {
                    name,
                    password,
                    maxPlayers: max,
                    cpuCount: cpu,
                    hostId: currentUser.uid,
                    hostName: myNick,
                    players: [{ uid: currentUser.uid, name: myNick, ready: true, lastActive: Date.now() }], 
                    status: 'waiting',
                    createdAt: Date.now(),
                    gameState: null
                };
                
                const docRef = await addDoc(collection(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms'), roomData);
                localStorage.setItem('gbm_current_room_id', docRef.id);
                enterWaitingRoom(docRef.id);
                window.closeModal('create-room-modal');
            } catch (e) {
                console.error("Error creating room:", e);
                alert("ë°© ìƒì„± ì‹¤íŒ¨: " + e.message);
            }
        };

        window.tryJoinRoom = (roomId, room) => {
            if (!currentUser) return alert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.");
            
            if (room.password) {
                const input = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (input !== room.password) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
            joinRoom(roomId);
        };

        async function joinRoom(roomId) {
            if (!currentUser) return;
            const myNick = document.getElementById('my-nickname').value || "Guest";
            localStorage.setItem('gbm_nickname', myNick);

            const roomRef = doc(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms', roomId);

            try {
                // arrayUnion ëŒ€ì‹  transactionìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì¶”ê°€ ê¶Œì¥í•˜ì§€ë§Œ ì—¬ê¸°ì„  ê°„ë‹¨íˆ
                const snap = await getDoc(roomRef);
                if(snap.exists()) {
                    const data = snap.data();
                    if (!data.players.some(p => p.uid === currentUser.uid)) {
                        await updateDoc(roomRef, {
                            players: arrayUnion({ uid: currentUser.uid, name: myNick, ready: false, lastActive: Date.now() })
                        });
                    }
                }
                localStorage.setItem('gbm_current_room_id', roomId);
                enterWaitingRoom(roomId);
            } catch (e) {
                console.error(e);
                alert("ì…ì¥ ì‹¤íŒ¨");
            }
        }

        function enterWaitingRoom(roomId) {
            currentRoomId = roomId;
            isLocalGame = false;
            
            localStorage.setItem('gbm_current_room_id', roomId);

            document.getElementById('network-lobby').classList.add('hidden');
            document.getElementById('room-waiting').classList.remove('hidden');
            document.getElementById('lobby-container').classList.remove('hidden');

            startHeartbeatLoop();

            // RTDB Presence Setup
            rtdbPresenceRef = ref(rtdb, `room_presence/${roomId}/${currentUser.uid}`);
            set(rtdbPresenceRef, {
                name: document.getElementById('my-nickname').value || "Guest",
                online: true,
                timestamp: Date.now()
            });
            onDisconnect(rtdbPresenceRef).remove(); 
            
            const roomRef = doc(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms', roomId);

            unsubscribeRoom = onSnapshot(roomRef, (docSnap) => {
                if (!docSnap.exists()) {
                    if(currentRoomId) { 
                         alert("ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                         window.leaveRoom(true); 
                    }
                    return;
                }

                const room = docSnap.data();
                
                if (!room.players.some(p => p.uid === currentUser.uid)) {
                    alert("ë°©ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
                    window.leaveRoom(true);
                    return;
                }

                renderWaitingRoom(room);

                if (room.status === 'playing') {
                    if (!window.game) {
                        startGameFromLobby(room);
                    } else {
                        if (room.gameState && room.gameState.lastActionId !== window.game.lastActionId) {
                            window.game.syncState(room.gameState);
                        }
                    }
                } else if (room.status === 'waiting') {
                    if (window.game) {
                         resetToLobbyUI();
                         document.getElementById('network-lobby').classList.add('hidden');
                         document.getElementById('room-waiting').classList.remove('hidden');
                    }
                }
            }, (error) => {
                console.error("Room Listener Error:", error);
            });
        }

        function renderWaitingRoom(room) {
            document.getElementById('room-title-display').innerText = `${room.name} (${room.cpuCount || 0} CPU)`;
            const userList = document.getElementById('waiting-user-list');
            userList.innerHTML = '';

            const isHost = room.hostId === currentUser.uid;
            const startBtn = document.getElementById('host-start-btn');
            
            let readyCount = 0;
            room.players.forEach(p => {
                const el = document.createElement('div');
                el.className = "flex justify-between items-center bg-slate-50 p-3 rounded-lg border-b border-gray-100";
                
                const isMe = p.uid === currentUser.uid;
                const isP_Host = p.uid === room.hostId;

                let btnHtml = '';
                if (isMe && !isP_Host) {
                    btnHtml = `<button onclick="window.toggleReady('${room.id}', ${p.ready})" class="ml-2 px-3 py-1 text-xs rounded-lg font-bold ${p.ready ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'} hover:opacity-80 transition">${p.ready ? 'ì¤€ë¹„ì·¨ì†Œ' : 'ì¤€ë¹„í•˜ê¸°'}</button>`;
                }

                el.innerHTML = `
                    <div class="font-bold flex items-center gap-2">
                        <span class="text-xl">${isP_Host ? 'ğŸ‘‘' : 'ğŸ‘¤'}</span>
                        <div class="flex flex-col">
                            <span class="text-slate-800">${p.name} ${isMe ? '(ë‚˜)' : ''}</span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="${p.ready ? 'text-green-600' : 'text-gray-400'} font-bold text-sm bg-white px-2 py-1 rounded border border-gray-100 shadow-sm">
                            ${p.ready ? 'READY' : 'WAITING'}
                        </div>
                        ${btnHtml}
                    </div>
                `;
                userList.appendChild(el);
                if (p.ready) readyCount++;
            });

            if (isHost) {
                startBtn.classList.remove('hidden');
                const totalPlayers = room.players.length; 
                const canStart = readyCount >= totalPlayers && (totalPlayers + (room.cpuCount || 0)) >= 2;
                
                startBtn.disabled = !canStart;
                startBtn.innerText = canStart ? "ê²Œì„ ì‹œì‘" : "ëª¨ë‘ ì¤€ë¹„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤";
                if(canStart) startBtn.classList.add('animate-pulse');
                else startBtn.classList.remove('animate-pulse');
            } else {
                startBtn.classList.add('hidden');
            }
        }

        window.toggleReady = async (roomId, currentStatus) => {
            if (!currentRoomId) return;
            const roomRef = doc(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms', currentRoomId);
            
            const snap = await getDoc(roomRef);
            if (snap.exists()) {
                const data = snap.data();
                const newPlayers = data.players.map(p => {
                    if (p.uid === currentUser.uid) return { ...p, ready: !currentStatus };
                    return p;
                });
                await updateDoc(roomRef, { players: newPlayers });
            }
        };

        window.leaveRoom = async (forced = false) => {
            const roomIdToLeave = currentRoomId;
            localStorage.removeItem('gbm_current_room_id');
            localStorage.removeItem('gbm_save'); 
            currentRoomId = null; 

            stopHeartbeatLoop();

            if (rtdbPresenceRef) {
                remove(rtdbPresenceRef);
                rtdbPresenceRef = null;
            }

            if (unsubscribeRoom) { unsubscribeRoom(); unsubscribeRoom = null; }

            if (!forced && roomIdToLeave && currentUser && !isLocalGame) {
                try {
                    const roomRef = doc(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms', roomIdToLeave);
                    const docSnap = await getDoc(roomRef);
                    if (docSnap.exists()) {
                        const room = docSnap.data();
                        const myPlayer = room.players.find(p => p.uid === currentUser.uid);
                        
                        if (myPlayer) {
                            const remainingPlayers = room.players.filter(p => p.uid !== currentUser.uid);
                            
                            if (remainingPlayers.length === 0) {
                                await deleteDoc(roomRef);
                            } else {
                                let updates = { players: remainingPlayers };
                                if (room.hostId === currentUser.uid) {
                                    updates.hostId = remainingPlayers[0].uid;
                                    updates.hostName = remainingPlayers[0].name;
                                }
                                await updateDoc(roomRef, updates);
                            }
                        }
                    }
                } catch (e) { console.error(e); }
            }
            resetToLobbyUI();
            if(!isLocalGame) initLobby(); 
        };

        window.hostStartGame = async () => {
            if (!currentRoomId || !currentUser) return;
            const roomRef = doc(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms', currentRoomId);
            await updateDoc(roomRef, { status: 'playing' });
        };

        function startGameFromLobby(roomData) {
            document.getElementById('room-waiting').classList.add('hidden');
            document.getElementById('lobby-container').classList.add('hidden'); 
            document.getElementById('game-board-container').classList.remove('hidden');
            document.getElementById('game-board').classList.remove('opacity-0');
            document.querySelector('.top-controls').style.display = 'flex'; 
            document.querySelector('.top-controls-left').style.display = 'flex';

            const playerConfig = [];
            roomData.players.forEach(p => {
                playerConfig.push({ name: p.name, isCpu: false, uid: p.uid });
            });
            const cpuCount = roomData.cpuCount || 0;
            for(let i=0; i<cpuCount; i++) {
                playerConfig.push({ name: `CPU ${i+1}`, isCpu: true, uid: `cpu_bot_${i}_${Date.now()}` });
            }

            if(window.game) window.game = null;
            window.game = new GrandBlueMarble(playerConfig, 0, null, true, roomData.hostId === currentUser.uid); 
        }

        window.checkAndStart = () => {
            const human = parseInt(document.getElementById('human-count').value);
            const cpu = parseInt(document.getElementById('cpu-count').value);
            
            const playerConfig = [];
            for (let i = 1; i <= human; i++) {
                const nameInput = document.getElementById(`human-name-${i}`);
                const name = nameInput ? nameInput.value : `Player ${i}`;
                playerConfig.push({ name: name, isCpu: false, uid: 'local_human_'+i });
            }
            for (let i = 1; i <= cpu; i++) {
                playerConfig.push({ name: `CPU ${i}`, isCpu: true, uid: 'local_cpu_'+i });
            }

            document.getElementById('local-setup-modal').classList.add('hidden');
            document.getElementById('lobby-container').classList.add('hidden'); 
            document.getElementById('game-board-container').classList.remove('hidden');
            document.getElementById('game-board').classList.remove('opacity-0');
            document.querySelector('.top-controls').style.display = 'flex'; 
            document.querySelector('.top-controls-left').style.display = 'flex';
            
            isLocalGame = true;
            currentRoomId = null; 
            window.game = new GrandBlueMarble(playerConfig, 0, null, false, true); 
        };
        
        function resetToLobbyUI() {
            // Hide Game Elements
            document.getElementById('game-board-container').classList.add('hidden');
            document.getElementById('game-over-modal').classList.add('hidden');
            document.getElementById('room-waiting').classList.add('hidden');
            
            // Hide all possible modals
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('acquire-modal').classList.add('hidden');
            document.getElementById('build-modal').classList.add('hidden');
            document.getElementById('choice-modal').classList.add('hidden');
            document.getElementById('game-info-modal').classList.add('hidden');
            document.getElementById('property-card').classList.add('hidden');

            document.querySelector('.top-controls').style.display = 'none';
            document.querySelector('.top-controls-left').style.display = 'none';
            
            // Show Lobby Elements
            document.getElementById('lobby-container').classList.remove('hidden');
            document.getElementById('network-lobby').classList.remove('hidden');

            // Reset State
            currentRoomId = null;
            isLocalGame = false;
            window.game = null;
        }

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.updateCpuOptions = () => {
            const humanSelect = document.getElementById('human-count');
            const cpuSelect = document.getElementById('cpu-count');
            const humanCount = parseInt(humanSelect.value);
            const maxCpu = 6 - humanCount;
            const currentCpu = parseInt(cpuSelect.value);
            cpuSelect.innerHTML = '';
            for(let i=0; i<=maxCpu; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = i === 0 ? 'ì—†ìŒ' : `${i}ëŒ€`;
                if(i === currentCpu || (i===maxCpu && currentCpu > maxCpu)) opt.selected = true;
                cpuSelect.appendChild(opt);
            }
        };
        window.updateLocalPlayerInputs = () => {
            const humanCount = parseInt(document.getElementById('human-count').value);
            const container = document.getElementById('local-player-names');
            container.innerHTML = '';
            for (let i = 1; i <= humanCount; i++) {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2";
                div.innerHTML = `<span class="text-xs font-bold text-slate-500 w-16">Player ${i}</span><input type="text" id="human-name-${i}" value="Player ${i}" class="flex-1 p-2 rounded-lg border border-slate-300 text-sm font-bold">`;
                container.appendChild(div);
            }
        };

        window.quitGame = async () => {
            if(!confirm("ì •ë§ ì¢…ë£Œí•˜ê³  ë¡œë¹„ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            try {
                // Stop internals
                if(window.game) {
                    if (typeof window.game.stopTurnTimer === 'function') window.game.stopTurnTimer();
                    window.game = null;
                }
                
                localStorage.removeItem('gbm_save');
                stopHeartbeatLoop(); 

                if (currentRoomId && typeof window.leaveRoom === 'function' && !isLocalGame) { 
                    await window.leaveRoom(false); 
                    // leaveRoom calls resetToLobbyUI and initLobby internally usually, but let's be safe
                } else {
                    resetToLobbyUI();
                    if(currentUser) initLobby();
                }
            } catch (e) {
                console.error("Quit Error:", e);
                // Fallback force reset
                resetToLobbyUI();
                if(currentUser) initLobby();
            }
        };

        window.resumeGame = () => {
            const savedData = JSON.parse(localStorage.getItem('gbm_save'));
            if(savedData) {
                document.getElementById('lobby-container').classList.add('hidden'); 
                document.getElementById('game-board-container').classList.remove('hidden');
                document.getElementById('game-board').classList.remove('opacity-0');
                document.querySelector('.top-controls').style.display = 'flex'; 
                document.querySelector('.top-controls-left').style.display = 'flex';
                window.game = new GrandBlueMarble(0, 0, savedData); 
            }
        };
        window.showGameInfo = () => document.getElementById('game-info-modal').classList.remove('hidden');
        window.closeGameInfo = () => document.getElementById('game-info-modal').classList.add('hidden');
        window.toggleGlobalSpeed = () => { if (window.game) window.game.toggleSpeed(); };
        window.closePropertyCardGlobal = () => { if (window.game) window.game.closePropertyCard(); };
        window.toggleFullScreen = () => {
             if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>console.log(e));
             else if (document.exitFullscreen) document.exitFullscreen();
        };

        // --- GAME LOGIC ---
        const getPlayerColor = (id) => ['#ff0000', '#0066ff', '#00cc44', '#ffcc00', '#aa00ff', '#ff0099'][id - 1];

        class SoundManager {
            constructor() { try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
            play(freq, type, duration, vol = 0.1) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            }
            playDice() { this.play(150, 'triangle', 0.2, 0.2); }
            playMove() { this.play(600, 'sine', 0.1, 0.08); }
            playMoney() { this.play(880, 'sine', 0.1, 0.1); setTimeout(() => this.play(1320, 'sine', 0.2, 0.1), 50); }
            playAlert() { this.play(200, 'square', 0.3, 0.05); setTimeout(() => this.play(150, 'square', 0.3, 0.05), 100); }
            playSpecial() { if(!this.ctx) return; let now = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.5); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5); osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.5); }
        }

        const boardData = [
            { id: 0, name: "START", type: "corner", emoji: "ğŸ", color: "#fef3c7" },
            { id: 1, name: "íƒ€ì´ë² ì´", type: "city", price: 50000, rent: 4000, color: "#f87171", code: "tw" },
            { id: 2, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 3, name: "ë² ì´ì§•", type: "city", price: 80000, rent: 6000, color: "#f87171", code: "cn" },
            { id: 4, name: "ë§ˆë‹ë¼", type: "city", price: 80000, rent: 6000, color: "#f87171", code: "ph" },
            { id: 5, name: "ì œì£¼ë„", type: "city", price: 200000, rent: 300000, color: "#ec4899", code: "kr", isSpecial: true },
            { id: 6, name: "ì‹±ê°€í¬ë¥´", type: "city", price: 100000, rent: 8000, color: "#f87171", code: "sg" },
            { id: 7, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 8, name: "ì¹´ì´ë¡œ", type: "city", price: 120000, rent: 10000, color: "#f87171", code: "eg" },
            { id: 9, name: "ì´ìŠ¤íƒ„ë¶ˆ", type: "city", price: 120000, rent: 10000, color: "#f87171", code: "tr" },
            { id: 10, name: "ë¬´ì¸ë„", type: "corner", emoji: "ğŸŒ´", color: "#fef3c7" },
            { id: 11, name: "ì•„í…Œë„¤", type: "city", price: 140000, rent: 12000, color: "#fbbf24", code: "gr" },
            { id: 12, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 13, name: "ì½”íœí•˜ê²", type: "city", price: 160000, rent: 14000, color: "#fbbf24", code: "dk" },
            { id: 14, name: "ìŠ¤í†¡í™€ë¦„", type: "city", price: 160000, rent: 14000, color: "#fbbf24", code: "se" },
            { id: 15, name: "ì½©ì½”ë“œ", type: "city", price: 250000, rent: 300000, color: "#ec4899", emoji: "âœˆï¸", isSpecial: true },
            { id: 16, name: "ì·¨ë¦¬íˆ", type: "city", price: 180000, rent: 16000, color: "#fbbf24", code: "ch" },
            { id: 17, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 18, name: "ë² ë¥¼ë¦°", type: "city", price: 200000, rent: 18000, color: "#fbbf24", code: "de" },
            { id: 19, name: "ì˜¤íƒ€ì™€", type: "city", price: 200000, rent: 18000, color: "#fbbf24", code: "ca" },
            { id: 20, name: "ì‚¬íšŒë³µì§€", type: "corner", emoji: "ğŸ¦", color: "#fef3c7" },
            { id: 21, name: "ë¶€ì—ë…¸ìŠ¤", type: "city", price: 220000, rent: 20000, color: "#4ade80", code: "ar" },
            { id: 22, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 23, name: "ìƒíŒŒìš¸ë£¨", type: "city", price: 240000, rent: 24000, color: "#4ade80", code: "br" },
            { id: 24, name: "ì‹œë“œë‹ˆ", type: "city", price: 240000, rent: 24000, color: "#4ade80", code: "au" },
            { id: 25, name: "ë¶€ì‚°", type: "city", price: 500000, rent: 600000, color: "#ec4899", code: "kr", isSpecial: true },
            { id: 26, name: "í•˜ì™€ì´", type: "city", price: 260000, rent: 24000, color: "#4ade80", code: "us" },
            { id: 27, name: "ë¦¬ìŠ¤ë³¸", type: "city", price: 260000, rent: 24000, color: "#4ade80", code: "pt" },
            { id: 28, name: "í€¸ì¦ˆí˜¸", type: "city", price: 300000, rent: 250000, color: "#ec4899", emoji: "ğŸš¢", isSpecial: true },
            { id: 29, name: "ë§ˆë“œë¦¬ë“œ", type: "city", price: 280000, rent: 26000, color: "#4ade80", code: "es" },
            { id: 30, name: "ìš°ì£¼ì—¬í–‰", type: "corner", emoji: "ğŸš€", color: "#fef3c7" },
            { id: 31, name: "ë„ì¿„", type: "city", price: 300000, rent: 30000, color: "#60a5fa", code: "jp" },
            { id: 32, name: "íŒŒë¦¬", type: "city", price: 320000, rent: 30000, color: "#60a5fa", code: "fr" },
            { id: 33, name: "í™©ê¸ˆì—´ì‡ ", type: "chance", emoji: "ğŸ”‘", color: "#fef3c7" },
            { id: 34, name: "ë¡œë§ˆ", type: "city", price: 320000, rent: 30000, color: "#60a5fa", code: "it" },
            { id: 35, name: "ì»¬ëŸ¼ë¹„ì•„", type: "city", price: 450000, rent: 400000, color: "#ec4899", emoji: "ğŸš€", isSpecial: true },
            { id: 36, name: "ëŸ°ë˜", type: "city", price: 350000, rent: 35000, color: "#60a5fa", code: "gb" },
            { id: 37, name: "ë‰´ìš•", type: "city", price: 350000, rent: 35000, color: "#60a5fa", code: "us" },
            { id: 38, name: "ì„¸ê¸ˆ", type: "tax", emoji: "ğŸ’¸", color: "#fef3c7" },
            { id: 39, name: "ì„œìš¸", type: "city", price: 1000000, rent: 2000000, color: "#60a5fa", code: "kr", isSpecial: true }
        ];

        function generateGridPositions() {
            let pos = [];
            for(let i=11; i>=1; i--) pos.push([11, i]); 
            for(let i=10; i>=1; i--) pos.push([i, 1]);  
            for(let i=2; i<=11; i++) pos.push([1, i]);  
            for(let i=2; i<=10; i++) pos.push([i, 11]); 
            return pos;
        }
        const gridPositions = generateGridPositions();

        class GrandBlueMarble {
            constructor(playerConfig, dummy = null, savedData = null, isMultiplayer = false, isHost = false) {
                this.sound = new SoundManager();
                this.isMultiplayer = isMultiplayer;
                this.isHost = isHost;
                const icons = ['ğŸš—', 'âœˆï¸', 'ğŸš¢', 'ğŸš', 'ğŸš²', 'ğŸš€'];
                
                this.players = [];
                
                if (savedData) {
                    this.players = savedData.players;
                    this.currentPlayerIndex = savedData.currentPlayerIndex;
                    this.socialFund = savedData.socialFund;
                    this.properties = savedData.properties;
                    this.buildings = savedData.buildings;
                    this.round = savedData.round;
                    this.gameSpeed = savedData.gameSpeed || 1;
                } else {
                    if (Array.isArray(playerConfig)) {
                         playerConfig.forEach((cfg, i) => {
                            this.players.push({
                                id: i + 1,
                                isCpu: cfg.isCpu,
                                uid: cfg.uid || null,
                                pos: 0, money: 3000000,
                                name: cfg.name,
                                icon: icons[i % icons.length],
                                isBankrupt: false, doubleCount: 0, islandTurns: 0, isIslandIn: false, 
                                hasEscapeCard: false, freePassCount: 0, isSpaceTravelReady: false, isFreeSpaceTravel: false
                            });
                        });
                    }
                    this.currentPlayerIndex = 0;
                    this.socialFund = 0; 
                    this.properties = Array(boardData.length).fill(null);
                    this.buildings = Array(boardData.length).fill(null).map(() => ({ villa: false, building: false, hotel: false }));
                    this.gameSpeed = 1; 
                    this.round = 1; 
                }
                
                this.maxRounds = 30;
                this.isRolling = false; 
                this.lastWasDouble = false;
                this.lastActionId = 0;

                this.turnTimer = null;
                this.timeLeft = 15;

                // ìˆœì„œ ì¬ì •ë¹„: ë©”ì„œë“œê°€ ì •ì˜ëœ í›„ í˜¸ì¶œë˜ë„ë¡
                this.initUI();
                this.initBoard();
                
                window.addEventListener('resize', () => this.updatePiecePositions());
                
                if (savedData) {
                    this.properties.forEach((ownerId, idx) => {
                        if (ownerId !== null) this.updateBoardOwnerDisplay(idx);
                    });
                }

                setTimeout(() => {
                    this.updateStatus();
                    this.startTurn();
                }, 200);
            }

            // *** Missing Methods Added Here ***
            
            toggleSpeed() {
                this.gameSpeed = this.gameSpeed === 1 ? 2.5 : 1;
                document.getElementById('speed-btn').innerText = this.gameSpeed === 1 ? 'â© x1' : 'â© x2.5';
                this.log(`â© ì†ë„ ë³€ê²½: x${this.gameSpeed}`);
            }

            save() {
                if (this.isMultiplayer) return;
                const data = {
                    players: this.players,
                    currentPlayerIndex: this.currentPlayerIndex,
                    socialFund: this.socialFund,
                    properties: this.properties,
                    buildings: this.buildings,
                    round: this.round,
                    gameSpeed: this.gameSpeed
                };
                localStorage.setItem('gbm_save', JSON.stringify(data));
            }

            getConstructionCost(price, type) {
                if (type === 'villa') return Math.floor(price * 0.5);
                if (type === 'building') return Math.floor(price * 0.3);
                if (type === 'hotel') return price;
                return 0;
            }

            getRentPrice(price, baseRent, buildings, isSpecial) {
                if (isSpecial) return baseRent; // Special cities usually have fixed high rent
                let rent = baseRent;
                if (buildings.villa) rent += Math.floor(price * 0.5); // Simplified rent rules for stability
                if (buildings.building) rent += Math.floor(price * 0.9);
                if (buildings.hotel) rent += Math.floor(price * 1.5);
                return rent;
            }

            calculateTotalAssets(p) {
                let total = p.money;
                this.properties.forEach((ownerId, idx) => {
                    if (ownerId === p.id) {
                        const s = boardData[idx];
                        total += s.price;
                        const b = this.buildings[idx];
                        if (b.villa) total += this.getConstructionCost(s.price, 'villa');
                        if (b.building) total += this.getConstructionCost(s.price, 'building');
                        if (b.hotel) total += this.getConstructionCost(s.price, 'hotel');
                    }
                });
                return total;
            }

            solveInsolvency(p, cost) {
                if (p.money >= cost) return true;
                
                // Auto-sell logic to keep game moving without complex UI for selling
                let assets = this.calculateTotalAssets(p);
                if (assets < cost) return false; // Absolutely bankrupt

                // Sell properties until money >= cost
                // Naive approach: sell from cheapest
                while (p.money < cost) {
                    // Find a property
                    let targetIdx = -1;
                    let minVal = Infinity;

                    this.properties.forEach((ownerId, idx) => {
                        if (ownerId === p.id) {
                            const s = boardData[idx];
                            // Quick valuation
                            if (s.price < minVal) {
                                minVal = s.price;
                                targetIdx = idx;
                            }
                        }
                    });

                    if (targetIdx === -1) break; // Should not happen if assets >= cost

                    // Sell it
                    const s = boardData[targetIdx];
                    const b = this.buildings[targetIdx];
                    let sellValue = Math.floor(s.price * 0.5);
                    if (b.villa) sellValue += Math.floor(this.getConstructionCost(s.price, 'villa') * 0.5);
                    if (b.building) sellValue += Math.floor(this.getConstructionCost(s.price, 'building') * 0.5);
                    if (b.hotel) sellValue += Math.floor(this.getConstructionCost(s.price, 'hotel') * 0.5);

                    this.properties[targetIdx] = null;
                    this.buildings[targetIdx] = { villa: false, building: false, hotel: false };
                    this.updateBoardOwnerDisplay(targetIdx);
                    p.money += sellValue;
                    this.log(`ğŸ’¸ ìê¸ˆ ë§ˆë ¨ì„ ìœ„í•´ ${s.name} ë§¤ê° (+${sellValue})`, "text-red-400");
                }

                return p.money >= cost;
            }

            showChoiceModal(emoji, title, desc, onYes, onNo) {
                const modal = document.getElementById('choice-modal');
                document.getElementById('choice-emoji').innerText = emoji;
                document.getElementById('choice-title').innerText = title;
                document.getElementById('choice-desc').innerText = desc;
                
                const yesBtn = document.getElementById('choice-yes-btn');
                const noBtn = document.getElementById('choice-no-btn');

                yesBtn.onclick = () => {
                    modal.classList.add('hidden');
                    onYes();
                };
                noBtn.onclick = () => {
                    modal.classList.add('hidden');
                    onNo();
                };

                modal.classList.remove('hidden');
            }

            showPropertyCard(index) {
                const s = boardData[index];
                const border = document.getElementById('prop-card-border');
                const card = document.getElementById('property-card');
                
                border.style.borderColor = s.color || '#cbd5e1';
                document.getElementById('prop-flag').innerHTML = s.code ? `<img src="https://flagcdn.com/w80/${s.code}.png" class="mx-auto rounded border-2 border-white shadow-sm w-12">` : `<span class="text-3xl">${s.emoji||'ğŸ™ï¸'}</span>`;
                document.getElementById('prop-name').innerText = s.name;
                document.getElementById('prop-tag').innerText = s.type === 'city' ? (s.isSpecial ? "SPECIAL CITY" : "CITY") : "LOCATION";
                
                // Costs
                if (s.type === 'city' || s.isSpecial) {
                    document.getElementById('price-info').classList.remove('hidden');
                    document.getElementById('rent-info-area').classList.remove('hidden');
                    
                    document.getElementById('cost-land').innerText = `â‚©${s.price.toLocaleString()}`;
                    
                    const cVilla = this.getConstructionCost(s.price, 'villa');
                    const cBuild = this.getConstructionCost(s.price, 'building');
                    const cHotel = this.getConstructionCost(s.price, 'hotel');
                    
                    document.getElementById('cost-villa').innerText = `â‚©${cVilla.toLocaleString()}`;
                    document.getElementById('cost-build').innerText = `â‚©${cBuild.toLocaleString()}`;
                    document.getElementById('cost-hotel').innerText = `â‚©${cHotel.toLocaleString()}`;
                    
                    document.getElementById('rent-1').innerText = `â‚©${s.rent.toLocaleString()}`;
                    
                    // Simulating accumulated rents
                    document.getElementById('rent-2').innerText = `â‚©${(s.rent + Math.floor(s.price*0.5)).toLocaleString()}`;
                    document.getElementById('rent-3').innerText = `â‚©${(s.rent + Math.floor(s.price*0.5) + Math.floor(s.price*0.9)).toLocaleString()}`;
                    document.getElementById('rent-4').innerText = `â‚©${(s.rent + Math.floor(s.price*0.5) + Math.floor(s.price*0.9) + Math.floor(s.price*1.5)).toLocaleString()}`;
                } else {
                    document.getElementById('price-info').classList.add('hidden');
                    document.getElementById('rent-info-area').classList.add('hidden');
                }

                card.classList.remove('hidden');
            }

            closePropertyCard() {
                document.getElementById('property-card').classList.add('hidden');
            }

            stopTurnTimer() {
                if (this.turnTimer) {
                    clearInterval(this.turnTimer);
                    this.turnTimer = null;
                }
                const timerDisplay = document.getElementById('turn-timer-display');
                if(timerDisplay) timerDisplay.classList.add('hidden');
            }

            // *** End of Added Methods ***

            initUI() {
                const pList = document.getElementById('player-list'); if(!pList) return;
                pList.innerHTML = '';
                this.players.forEach(p => {
                    const card = document.createElement('div');
                    card.id = `card-p${p.id}`; 
                    card.className = `bg-white p-1 rounded-lg shadow-sm border-l-[4px] border-slate-200 flex flex-col transition-all duration-300 relative overflow-hidden`;
                    card.style.borderLeftColor = getPlayerColor(p.id);
                    
                    const cpuBadge = p.isCpu ? `<span class="bg-gray-800 text-white text-[7px] px-1 rounded ml-1">CPU</span>` : '';
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-0.5">
                            <span class="player-card-content font-black flex items-center gap-1"><span class="text-xl">${p.icon}</span> ${p.name}${cpuBadge}</span>
                            <div class="flex flex-col items-end gap-0.5">
                                <span id="turn-p${p.id}" class="player-badge font-black rounded-full bg-indigo-600 text-white hidden uppercase">ACT</span>
                                <span id="island-p${p.id}" class="player-badge font-black rounded-full bg-orange-500 text-white hidden uppercase">ISLE</span>
                                <span id="space-p${p.id}" class="player-badge font-black rounded-full bg-blue-500 text-white hidden uppercase">SPACE</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline px-0.5 border-t pt-0.5">
                            <div class="player-money font-black text-slate-800">â‚© <span id="money-p${p.id}">${p.money.toLocaleString()}</span></div>
                            <div class="text-[7px] text-slate-400 font-bold">ìì‚°: <span id="asset-p${p.id}">0</span></div>
                        </div>
                        <div class="flex gap-0.5 mt-0.5 px-0.5">
                           <span id="badge-escape-${p.id}" class="hidden player-badge bg-slate-600 text-white rounded">ğŸ”‘íƒˆì¶œ</span>
                           <span id="badge-freepass-${p.id}" class="hidden player-badge bg-purple-600 text-white rounded">ğŸ«ìš°ëŒ€(<span id="count-freepass-${p.id}">0</span>)</span>
                        </div>
                        <div id="owned-p${p.id}" class="flex flex-wrap gap-0.5 mt-0.5 px-0.5 min-h-[8px]"></div>
                    `;
                    pList.appendChild(card);
                });
            }
            
            initBoard() {
                const board = document.getElementById('game-board');
                board.innerHTML = `<div class="center-panel shadow-inner relative">
                    <div id="dice-overlay" class="dice-overlay">
                        <div id="event-emoji" class="text-7xl md:text-9xl drop-shadow-2xl"></div>
                        <div id="event-msg" class="event-info-box hidden">
                            <div class="text-lg md:text-2xl font-black text-indigo-600 mb-1" id="event-title"></div>
                            <div class="text-xs md:text-sm font-medium text-slate-600" id="event-desc"></div>
                        </div>
                        <div class="dice-box-container" id="dice-container">
                            <div id="dice-1" class="dice-box">?</div>
                            <div id="dice-2" class="dice-box">?</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between border-b pb-1 mb-1">
                        <div class="flex flex-col">
                            <h2 id="top-title" class="text-[0.6rem] md:text-xl game-font text-slate-300">WORLD TOUR</h2>
                            <div id="social-fund-display" class="text-[0.5rem] md:text-[10px] text-green-600 font-bold whitespace-nowrap">ì‚¬íšŒë³µì§€: â‚©0</div>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="flex items-center gap-1">
                                <div id="turn-timer-display" class="text-[0.6rem] font-bold text-indigo-500 bg-white px-1.5 py-0.5 rounded shadow-sm hidden">â° 15s</div>
                                <div id="round-display" class="text-[0.5rem] font-bold text-slate-500 mb-0.5">R 1/30</div>
                            </div>
                            <button id="roll-btn" onclick="window.game && window.game.rollDice()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition shadow-lg active:scale-95 disabled:opacity-50 text-[0.6rem] md:text-base disabled:cursor-not-allowed whitespace-nowrap">ì£¼ì‚¬ìœ„</button>
                        </div>
                    </div>
                    <div id="player-list" class="grid grid-cols-2 gap-1.5 flex-[6] overflow-y-auto content-start pr-0.5"></div>
                    <div class="bg-slate-900 text-white p-2 rounded-lg shadow-2xl flex flex-col flex-[3] overflow-hidden border border-slate-700 min-h-0">
                        <div class="text-[8px] font-bold text-slate-500 mb-0.5 uppercase tracking-widest border-b border-slate-800 pb-0.5 flex justify-between items-center">
                            <span>Log</span>
                            <span id="turn-display" class="text-indigo-400 font-bold animate-pulse uppercase">P1</span>
                        </div>
                        <div id="game-log" class="log-container overflow-y-auto flex-1 text-[8px] space-y-1 flex flex-col-reverse mt-0.5 pr-0.5 font-medium">
                            <div class="text-indigo-300 italic">ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.</div>
                        </div>
                    </div>

                    <!-- ì±„íŒ… UI -->
                    <div id="game-chat" class="chat-overlay">
                        <div id="chat-messages" class="chat-messages"></div>
                        <div class="chat-input-row">
                            <input type="text" id="chat-input" class="flex-1 p-1 text-xs border rounded outline-none" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.key==='Enter') window.sendChat()">
                            <button onclick="window.sendChat()" class="px-2 py-1 bg-indigo-500 text-white text-xs rounded">ì „ì†¡</button>
                        </div>
                    </div>
                </div>`;
                
                boardData.forEach((data, index) => {
                    const div = document.createElement('div'); 
                    div.className = `square ${data.isSpecial ? 'special-city' : data.type}`; 
                    div.id = `square-${index}`;
                    const pos = gridPositions[index]; div.style.gridRow = pos[0]; div.style.gridColumn = pos[1];
                    div.onclick = (e) => {
                        const p = this.players[this.currentPlayerIndex];
                        if (p.isCpu) return; 
                        if (p.isSpaceTravelReady) this.chooseSpaceDestination(index);
                        else this.showPropertyCard(index);
                    };

                    if (data.type === 'city') {
                        const header = document.createElement('div');
                        header.className = 'cell-header';
                        header.style.backgroundColor = data.color;
                        if(data.color === '#ec4899') header.style.color = 'white'; 
                        let nameHtml = `<div class="flex flex-col items-center justify-center w-full leading-none">`;
                        nameHtml += `<div class="flex items-center justify-center gap-0.5">`;
                        if (data.code) nameHtml += `<img src="https://flagcdn.com/w40/${data.code}.png" class="flag-img" onerror="this.style.display='none'"> `;
                        else if (data.emoji) nameHtml += `<span>${data.emoji}</span> `;
                        nameHtml += `<span>${data.name}</span></div>`;
                        nameHtml += `<div class="text-[0.65em] font-medium mt-0.5 opacity-80">â‚©${data.price/10000}ë§Œ</div>`;
                        nameHtml += `</div>`;
                        header.innerHTML = nameHtml;

                        const buildings = document.createElement('div');
                        buildings.id = `build-${index}`;
                        buildings.className = 'cell-buildings';

                        const owner = document.createElement('div');
                        owner.id = `owner-${index}`;
                        owner.className = 'cell-owner';

                        const spacer = document.createElement('div');
                        spacer.className = 'cell-spacer';

                        const users = document.createElement('div');
                        users.id = `users-${index}`;
                        users.className = 'cell-users';

                        div.appendChild(header);
                        div.appendChild(buildings);
                        div.appendChild(owner);
                        div.appendChild(spacer);
                        div.appendChild(users);
                    } else {
                        div.style.backgroundColor = data.color;
                        div.style.justifyContent = 'space-between'; 
                        const topContent = document.createElement('div');
                        topContent.style.flex = '4';
                        topContent.style.display = 'flex';
                        topContent.style.flexDirection = 'column';
                        topContent.style.alignItems = 'center';
                        topContent.style.justifyContent = 'center';
                        topContent.innerHTML = `<div class="text-2xl mb-1">${data.emoji || ''}</div><div class="font-bold text-[0.65rem] text-slate-800">${data.name}</div>`;
                        const users = document.createElement('div');
                        users.id = `users-${index}`;
                        users.className = 'cell-users';
                        users.style.background = 'none'; 
                        div.appendChild(topContent);
                        div.appendChild(users);
                    }
                    board.appendChild(div);
                });
                
                // player-listë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ìœ„í•´ initUI í˜¸ì¶œ
                this.initUI();
                setTimeout(() => this.updatePiecePositions(), 100);
            }

            // *** í•„ìˆ˜ UI ë©”ì„œë“œ ë³µêµ¬ (ìì‚° ê³„ì‚°, ë§ ì´ë™ ë“±) ***
            updatePiecePositions(isSpecial = false) {
                this.players.forEach(p => {
                    let piece = document.getElementById(`p${p.id}`);
                    if (!piece) {
                        piece = document.createElement('div');
                        piece.id = `p${p.id}`; 
                        piece.className = `piece p-bg-${p.id}`; 
                        piece.innerText = p.icon;
                    }
                    if (p.isBankrupt) { 
                        if(piece) piece.style.display = 'none'; 
                        return; 
                    }
                    const userContainer = document.getElementById(`users-${p.pos}`);
                    if (userContainer) {
                        userContainer.appendChild(piece);
                        const count = userContainer.childElementCount;
                        Array.from(userContainer.children).forEach(child => {
                            child.style.width = count > 4 ? '30%' : (count > 1 ? '45%' : '80%');
                            child.style.fontSize = count > 4 ? '0.5rem' : (count > 1 ? '0.8rem' : '1.2rem');
                        });
                    }
                });
            }

            updateStatus() {
                const fundEl = document.getElementById('social-fund-display');
                if (fundEl) fundEl.innerText = `ì‚¬íšŒë³µì§€: â‚©${this.socialFund.toLocaleString()}`;
                
                const roundEl = document.getElementById('round-display');
                if(roundEl) roundEl.innerText = `R ${this.round}/30`;

                this.players.forEach(p => {
                    const mEl = document.getElementById(`money-p${p.id}`); if(mEl) mEl.innerText = p.money.toLocaleString();
                    const aEl = document.getElementById(`asset-p${p.id}`); if(aEl) aEl.innerText = this.calculateTotalAssets(p).toLocaleString();
                    const card = document.getElementById(`card-p${p.id}`); if (!card) return;

                    const escapeBadge = document.getElementById(`badge-escape-${p.id}`);
                    if(escapeBadge) p.hasEscapeCard ? escapeBadge.classList.remove('hidden') : escapeBadge.classList.add('hidden');
                    const freeBadge = document.getElementById(`badge-freepass-${p.id}`);
                    const freeCount = document.getElementById(`count-freepass-${p.id}`);
                    if(freeBadge && freeCount) {
                        if(p.freePassCount > 0) {
                            freeBadge.classList.remove('hidden');
                            freeCount.innerText = p.freePassCount;
                        } else {
                            freeBadge.classList.add('hidden');
                        }
                    }

                    const piece = document.getElementById(`p${p.id}`);
                    
                    if (this.currentPlayerIndex === p.id - 1) {
                        card.classList.add('turn-anim'); 
                        const actTag = document.getElementById(`turn-p${p.id}`);
                        if (actTag) actTag.classList.remove('hidden');
                        const turnDisplay = document.getElementById('turn-display');
                        if (turnDisplay) turnDisplay.innerText = `${p.name}`;
                        if (piece) { piece.classList.remove('inactive-piece'); piece.classList.add('active-piece'); }
                    } else {
                        card.classList.remove('turn-anim');
                        const actTag = document.getElementById(`turn-p${p.id}`);
                        if (actTag) actTag.classList.add('hidden');
                        if (piece) { piece.classList.remove('active-piece'); piece.classList.add('inactive-piece'); }
                    }
                    
                    const islandTag = document.getElementById(`island-p${p.id}`);
                    if (islandTag) p.isIslandIn ? islandTag.classList.remove('hidden') : islandTag.classList.add('hidden');
                    const spaceTag = document.getElementById(`space-p${p.id}`);
                    if (spaceTag) p.isSpaceTravelReady ? spaceTag.classList.remove('hidden') : spaceTag.classList.add('hidden');
                    if (p.isBankrupt) card.classList.add('grayscale', 'opacity-40');
                    const ownedContainer = document.getElementById(`owned-p${p.id}`);
                    if (ownedContainer) {
                        const owned = boardData.filter((_, idx) => this.properties[idx] === p.id);
                        ownedContainer.innerHTML = owned.map(c => `<span class="text-[7px] px-1 py-0.5 rounded text-white font-black shadow-sm" style="background-color: ${c.color}">${c.name}</span>`).join('');
                    }
                });
            }

            log(msg, colorClass = "text-slate-400") {
                const logBox = document.getElementById('game-log'); const div = document.createElement('div');
                div.className = `leading-relaxed border-l-2 pl-2 border-slate-700 ${colorClass}`;
                div.innerHTML = msg; logBox.prepend(div);
            }

            resetOverlayUI() {
                const e = document.getElementById('event-emoji'); const m = document.getElementById('event-msg'); const d = document.getElementById('dice-container');
                if(e) e.innerText = ''; if(m) m.classList.add('hidden'); if(d) d.style.display = 'flex';
            }

            showEventOverlay(emoji, title, desc, duration = 2000) {
                this.resetOverlayUI(); const overlay = document.getElementById('dice-overlay');
                document.getElementById('event-emoji').innerText = emoji; document.getElementById('event-title').innerText = title; document.getElementById('event-desc').innerText = desc;
                document.getElementById('dice-container').style.display = 'none'; document.getElementById('event-msg').classList.remove('hidden'); overlay.style.display = 'flex';
                const adjustedDuration = duration / this.gameSpeed;
                setTimeout(() => { overlay.style.display = 'none'; this.resetOverlayUI(); }, adjustedDuration);
            }

            // *** ì¶”ê°€ëœ ì¸ìˆ˜ ê¸°ëŠ¥ ê´€ë ¨ ë©”ì„œë“œ ***
            showAcquireModal(s, ownerId, cost) {
                // ë©€í‹°í”Œë ˆì´ì–´ë©´ ë‚´ í„´ì¸ì§€ í™•ì¸
                if (this.isMultiplayer && this.players[this.currentPlayerIndex].uid !== currentUser.uid) return;

                const modal = document.getElementById('acquire-modal');
                document.getElementById('acquire-desc').innerHTML = `<b>${s.name}</b>ì„(ë¥¼) ì¸ìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì¸ìˆ˜ ë¹„ìš©: <b class="text-red-500">â‚©${cost.toLocaleString()}</b>`;
                
                // ì¸ìˆ˜ ëŒ€ìƒ ì •ë³´ ì„ì‹œ ì €ì¥
                this.pendingAcquire = { s, ownerId, cost };
                modal.classList.remove('hidden');
                this.startTurnTimer(); // ê²°ì • ì‹œê°„ íƒ€ì´ë¨¸ ì¬ê°œ
            }

            confirmAcquire() {
                if (!this.pendingAcquire) return;
                const { s, ownerId, cost } = this.pendingAcquire;
                const p = this.players[this.currentPlayerIndex];
                const owner = this.players[ownerId - 1];

                if (p.money >= cost) {
                    p.money -= cost;
                    owner.money += cost; // ì£¼ì¸ì—ê²Œ ëˆ ì§€ë¶ˆ
                    this.sound.playMoney();
                    
                    const pos = boardData.indexOf(s);
                    this.properties[pos] = p.id; // ì†Œìœ ê¶Œ ì´ì „
                    // ê±´ë¬¼ì€ ìœ ì§€ë¨
                    
                    this.updateBoardOwnerDisplay(pos);
                    this.log(`ğŸ™ï¸ <b>${s.name}</b> ì¸ìˆ˜ ì„±ê³µ!`, "text-yellow-600 font-bold");
                    window.showToast(`${p.name}ë‹˜ì´ ${s.name}ì„(ë¥¼) ì¸ìˆ˜í–ˆìŠµë‹ˆë‹¤!`, 'success');
                } else {
                    window.showToast("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.", 'error');
                }
                
                document.getElementById('acquire-modal').classList.add('hidden');
                this.pendingAcquire = null;
                this.checkPostAction();
            }

            cancelAcquire() {
                document.getElementById('acquire-modal').classList.add('hidden');
                this.pendingAcquire = null;
                this.checkPostAction();
            }

            startTurnTimer() {
                this.stopTurnTimer();
                this.timeLeft = 15;
                const timerDisplay = document.getElementById('turn-timer-display');
                if(timerDisplay) {
                    timerDisplay.classList.remove('hidden');
                    timerDisplay.innerText = `â° ${this.timeLeft}s`;
                    timerDisplay.classList.remove('timer-warning');
                }

                this.turnTimer = setInterval(() => {
                    this.timeLeft--;
                    if(timerDisplay) {
                        timerDisplay.innerText = `â° ${this.timeLeft}s`;
                        if(this.timeLeft <= 5) timerDisplay.classList.add('timer-warning');
                    }

                    if (this.timeLeft <= 0) {
                        this.stopTurnTimer();
                        this.handleTurnTimeout();
                    }
                }, 1000);
            }

            handleTurnTimeout() {
                const p = this.players[this.currentPlayerIndex];
                const isMyControl = (!this.isMultiplayer && !p.isCpu) || (this.isMultiplayer && p.uid === currentUser.uid) || (p.isCpu && (!this.isMultiplayer || this.isHost));
                
                if (!isMyControl) return;

                if (document.getElementById('modal').classList.contains('hidden') && 
                    document.getElementById('build-modal').classList.contains('hidden') &&
                    document.getElementById('acquire-modal').classList.contains('hidden')) {
                     this.rollDice();
                } else {
                    if (!document.getElementById('modal').classList.contains('hidden')) {
                         this.confirmAction(); 
                    } else if (!document.getElementById('build-modal').classList.contains('hidden')) {
                         this.closeBuildModal();
                    } else if (!document.getElementById('acquire-modal').classList.contains('hidden')) {
                         this.cancelAcquire(); // ì¸ìˆ˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì·¨ì†Œ
                    }
                }
            }

            startTurn() {
                const p = this.players[this.currentPlayerIndex];
                const survivors = this.players.filter(pl => !pl.isBankrupt);
                if (survivors.length <= 1) { this.gameOver(survivors[0]); return; }
                if (this.round > this.maxRounds) {
                    const winner = [...this.players].sort((a,b) => this.calculateTotalAssets(b) - this.calculateTotalAssets(a))[0];
                    this.gameOver(winner, true);
                    return;
                }
                const btn = document.getElementById('roll-btn');
                
                if (this.isMultiplayer) {
                    if (p.isCpu) {
                         if (this.isHost) {
                             btn.disabled = true;
                             btn.innerText = `${p.name} (CPU) Thinking...`;
                             setTimeout(() => { this.rollDice(); }, 1000 / this.gameSpeed);
                         } else {
                             btn.disabled = true;
                             btn.innerText = `${p.name} (CPU) ì§„í–‰ ì¤‘...`;
                         }
                         return;
                    } else if (p.uid !== currentUser.uid) {
                        btn.disabled = true;
                        btn.innerText = `${p.name} ë‹˜ì˜ í„´`;
                        return;
                    }
                }

                if (p.isCpu) {
                    btn.disabled = true;
                    btn.innerText = `${p.name} (CPU)`;
                    setTimeout(() => { this.rollDice(); }, 1000 / this.gameSpeed);
                } else {
                    btn.disabled = false;
                    btn.innerText = p.isSpaceTravelReady ? "ëª©ì ì§€ ì„ íƒ" : "ì£¼ì‚¬ìœ„";
                    this.startTurnTimer();
                }
                
                if (!this.isMultiplayer) this.save();
                else this.syncToFirebase(); 
            }

            async syncToFirebase() {
                if (!currentRoomId || !this.isMultiplayer) return;
                const p = this.players[this.currentPlayerIndex];
                const canUpdate = (p.uid === currentUser.uid) || (p.isCpu && this.isHost);
                if (!canUpdate) return;

                const roomRef = doc(db, 'artifacts', GAME_NAMESPACE, 'public', 'data', 'rooms', currentRoomId);
                const gameState = {
                    players: this.players,
                    currentPlayerIndex: this.currentPlayerIndex,
                    socialFund: this.socialFund,
                    properties: this.properties,
                    buildings: this.buildings,
                    round: this.round,
                    lastActionId: Date.now()
                };
                await updateDoc(roomRef, { gameState: gameState });
            }
            
            syncState(newState) {
                if (this.isRolling) return; 
                this.lastActionId = newState.lastActionId;
                this.players = newState.players;
                this.currentPlayerIndex = newState.currentPlayerIndex;
                this.socialFund = newState.socialFund;
                this.properties = newState.properties;
                this.buildings = newState.buildings;
                this.round = newState.round;
                
                this.initUI();
                this.properties.forEach((ownerId, idx) => {
                    if (ownerId !== null) this.updateBoardOwnerDisplay(idx);
                });
                this.updatePiecePositions();
                this.updateStatus();
                
                const p = this.players[this.currentPlayerIndex];
                const btn = document.getElementById('roll-btn');
                if (this.isMultiplayer) {
                    if (p.isCpu) {
                         if (this.isHost) {
                             this.startTurn(); 
                         } else {
                             btn.disabled = true;
                             btn.innerText = `${p.name} (CPU) ì§„í–‰ ì¤‘...`;
                         }
                    } else if (p.uid !== currentUser.uid) {
                        btn.disabled = true;
                        btn.innerText = `${p.name} ë‹˜ì˜ í„´`;
                    } else if (p.uid === currentUser.uid) {
                        btn.disabled = false;
                        btn.innerText = p.isSpaceTravelReady ? "ëª©ì ì§€ ì„ íƒ" : "ì£¼ì‚¬ìœ„";
                        this.startTurnTimer();
                    }
                }
            }

            rollDice() {
                this.stopTurnTimer(); 
                if (this.isRolling) return; 
                this.isRolling = true;
                const player = this.players[this.currentPlayerIndex];
                
                if (this.isMultiplayer) {
                    if (player.isCpu && !this.isHost) return;
                    if (!player.isCpu && player.uid !== currentUser.uid) return;
                }

                if (player.isSpaceTravelReady) { 
                    if (player.isCpu) {
                        const targets = [0, 39, 5, 25, 3]; 
                        let dest = targets[Math.floor(Math.random() * targets.length)];
                        if (Math.random() < 0.5) dest = Math.floor(Math.random() * 40);
                        this.showEventOverlay("ğŸ›¸", "ìš°ì£¼ ì´ë™ (CPU)", `${player.name} ì´ë™ ì¤‘...`);
                        setTimeout(() => this.chooseSpaceDestination(dest), 1000 / this.gameSpeed);
                    } else {
                        this.showEventOverlay("ğŸ›¸", "ìš°ì£¼ ì´ë™", "ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”"); 
                    }
                    return; 
                }
                
                if (player.isIslandIn && player.hasEscapeCard) {
                     if (player.isCpu) {
                         this.log(`ğŸ« CPU íƒˆì¶œê¶Œ ì‚¬ìš©`, "text-green-400 font-bold");
                         player.hasEscapeCard = false; player.isIslandIn = false; player.islandTurns = 0;
                         this.lastWasDouble = false; 
                     } else {
                         if (this.isMultiplayer && player.uid !== currentUser.uid) return;
                         this.showChoiceModal("ğŸ“»", "ë¬´ì¸ë„ íƒˆì¶œ", "íƒˆì¶œê¶Œì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 
                            () => { 
                                this.log(`ğŸ« íƒˆì¶œê¶Œ ì‚¬ìš©`, "text-green-400 font-bold");
                                player.hasEscapeCard = false; player.isIslandIn = false; player.islandTurns = 0;
                                this.lastWasDouble = false; 
                                this._performRoll(player);
                            },
                            () => { this._performRoll(player); }
                         );
                         return; 
                     }
                }
                this._performRoll(player);
            }

            _performRoll(player) {
                const overlay = document.getElementById('dice-overlay'); const d1El = document.getElementById('dice-1'); const d2El = document.getElementById('dice-2');
                document.getElementById('roll-btn').disabled = true; this.resetOverlayUI(); overlay.style.display = 'flex';
                const interval = setInterval(() => { d1El.innerText = Math.floor(Math.random() * 6) + 1; d2El.innerText = Math.floor(Math.random() * 6) + 1; this.sound.playDice(); }, 100);
                setTimeout(() => {
                    clearInterval(interval);
                    const d1 = Math.floor(Math.random() * 6) + 1; const d2 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2; const isDouble = (d1 === d2);
                    d1El.innerText = d1; d2El.innerText = d2;
                    setTimeout(async () => {
                        overlay.style.display = 'none'; this.log(`ğŸ² ê²°ê³¼: <b>${d1}+${d2}=${total}</b>`, "text-white");
                        if (player.isIslandIn) {
                            if (isDouble) { 
                                this.log(`âœ¨ ë”ë¸” íƒˆì¶œ!`, "text-green-400 font-bold"); 
                                player.isIslandIn = false; player.islandTurns = 0; 
                                this.lastWasDouble = false; 
                            }
                            else {
                                player.islandTurns++;
                                if (player.islandTurns >= 3) { this.log(`âŒ› ì„ë°©`, "text-indigo-300"); player.isIslandIn = false; player.islandTurns = 0; }
                                else { this.log(`ğŸ”’ ëŒ€ê¸° (${player.islandTurns}/3)`, "text-orange-400"); this.endTurn(); return; }
                            }
                        }
                        if (isDouble && !player.isIslandIn) {
                            player.doubleCount++;
                            if (player.doubleCount === 3) { this.log(`âš ï¸ 3ì—°ì† ë”ë¸”!`, "text-red-500 font-bold"); this.handleIslandArrive(); return; }
                            this.lastWasDouble = true;
                        } else { 
                            if (!player.isIslandIn) this.lastWasDouble = false; 
                        }
                        await this.movePlayer(total);
                    }, 800 / this.gameSpeed);
                }, 1200 / this.gameSpeed);
            }

            async movePlayer(steps) {
                const p = this.players[this.currentPlayerIndex]; 
                const piece = document.getElementById(`p${p.id}`);
                for(let i = 0; i < steps; i++) {
                    p.pos = (p.pos + 1) % boardData.length; 
                    this.sound.playMove(); 
                    if(piece) piece.classList.add('moving');
                    this.updatePiecePositions(); 
                    if (p.pos === 0) { p.money += 200000; this.sound.playMoney(); this.log(`ğŸ’° ì›”ê¸‰ ìˆ˜ë ¹`, "text-yellow-400 font-bold"); }
                    await new Promise(r => setTimeout(r, 250 / this.gameSpeed)); 
                    if(piece) piece.classList.remove('moving');
                }
                this.handleSquare(p.pos);
            }

            handleSquare(pos) {
                const s = boardData[pos]; const p = this.players[this.currentPlayerIndex];
                this.log(`ğŸ“ <b>${p.name}</b> â†’ <b>${s.name}</b>`, "text-slate-300 text-[10px]");
                
                if (s.type === 'city') {
                    const ownerId = this.properties[pos];
                    if (ownerId === null) { 
                        if (p.isCpu) this.cpuDecideBuy(s);
                        else {
                            if (!this.isMultiplayer || p.uid === currentUser.uid) {
                                 this.showModal(s, 'buy');
                                 this.startTurnTimer(); 
                            } else {
                                 this.checkPostAction();
                            }
                        }
                    }
                    else if (ownerId === p.id) { 
                        if (!s.isSpecial) { 
                            if (p.isCpu) this.cpuDecideBuild(s);
                            else {
                                if (!this.isMultiplayer || p.uid === currentUser.uid) {
                                     this.showConstructionModal(s);
                                     this.startTurnTimer(); 
                                } else {
                                     this.checkPostAction();
                                }
                            }
                        } else {
                            this.checkPostAction();
                        }
                    }
                    else { 
                        // ì¸ìˆ˜ ë¡œì§
                        if (!p.isCpu && (!this.isMultiplayer || p.uid === currentUser.uid)) {
                            const rent = this.getRentPrice(s.price, s.rent, this.buildings[pos], s.isSpecial);
                            let currentValue = s.price;
                            const b = this.buildings[pos];
                            if(b.villa) currentValue += this.getConstructionCost(s.price, 'villa');
                            if(b.building) currentValue += this.getConstructionCost(s.price, 'building');
                            if(b.hotel) currentValue += this.getConstructionCost(s.price, 'hotel');
                            
                            const acquireCost = currentValue * 2;
                            this.payRent(p, this.players[ownerId - 1], pos);
                            
                            if (!p.isBankrupt && p.money >= acquireCost && !s.isSpecial) {
                                this.showAcquireModal(s, ownerId, acquireCost);
                                return;
                            }
                        } else {
                            this.payRent(p, this.players[ownerId - 1], pos);
                        }
                    }
                } else {
                    if (s.type === 'tax') { 
                        if (this.solveInsolvency(p, 150000)) {
                            p.money -= 150000; this.socialFund += 150000;
                            this.sound.playAlert(); 
                            this.log(`ğŸ’¸ ì„¸ê¸ˆ â‚©15ë§Œ ë‚©ë¶€`, "text-red-400");
                        } else { this.bankrupt(p); }
                        this.checkPostAction();
                    }
                    else if (s.type === 'chance') this.handleGoldenKey();
                    else if (s.name === "ë¬´ì¸ë„") { this.handleIslandArrive(); }
                    else if (s.name === "ìš°ì£¼ì—¬í–‰") { 
                        this.sound.playSpecial(); 
                        const colOwner = this.properties[35]; 
                        const fee = 200000;
                        let actualFee = fee;
                        if (p.isFreeSpaceTravel) {
                            actualFee = 0;
                            this.log(`ğŸš€ ìš°ì£¼ì—¬í–‰ ë¬´ë£Œ ì´ˆëŒ€ê¶Œ ì‚¬ìš©!`, "text-green-400 font-bold");
                            p.isFreeSpaceTravel = false; 
                        }
    
                        if (actualFee === 0 || this.solveInsolvency(p, actualFee)) {
                            if (actualFee > 0) {
                                p.money -= actualFee;
                                if (colOwner && colOwner !== p.id) {
                                    this.players[colOwner-1].money += actualFee;
                                    this.log(`ğŸš€ ì…”í‹€ë¹„ ì§€ë¶ˆ`, "text-orange-300");
                                } else {
                                    this.log(`ğŸš€ ì…”í‹€ë¹„ ì§€ë¶ˆ`, "text-orange-300");
                                }
                            }
                            p.isSpaceTravelReady = true; 
                            this.lastWasDouble = false; 
                            if(p.isCpu) this.showEventOverlay("ğŸš€", "ìš°ì£¼ì—¬í–‰ (CPU)", "ë‹¤ìŒ í„´ ì¶œë°œ");
                            else this.showEventOverlay("ğŸš€", "ìš°ì£¼ì—¬í–‰ ì¤€ë¹„ë¨", "ë‹¤ìŒ í„´ì— ì¶œë°œí•©ë‹ˆë‹¤");
                        } else {
                            const payment = p.money; p.money = 0;
                            if (colOwner && colOwner !== p.id) { this.players[colOwner-1].money += payment; }
                            this.bankrupt(p);
                        }
                        this.endTurn(true); 
                    }
                    else if (s.name === "ì‚¬íšŒë³µì§€") { 
                        this.sound.playMoney(); 
                        if (this.socialFund > 0) {
                            p.money += this.socialFund; 
                            this.showEventOverlay("ğŸ¦", "ì‚¬íšŒë³µì§€ê¸°ê¸ˆ", `â‚©${this.socialFund.toLocaleString()} ìˆ˜ë ¹!`);
                            this.log(`ğŸ¦ ë³µì§€ê¸°ê¸ˆ ìˆ˜ë ¹!`, "text-green-400 font-bold");
                            this.socialFund = 0;
                        } else {
                            this.showEventOverlay("ğŸ¦", "ì‚¬íšŒë³µì§€ê¸°ê¸ˆ", "ì ë¦½ê¸ˆ ì—†ìŒ");
                        }
                        this.checkPostAction();
                    } else {
                        this.checkPostAction();
                    }
                }
            }

            cpuDecideBuy(s) {
                const p = this.players[this.currentPlayerIndex];
                if (p.money >= s.price) {
                    setTimeout(() => { this.confirmAction(); }, 800 / this.gameSpeed);
                } else {
                    this.log(`ğŸ’¸ (CPU) ìê¸ˆ ë¶€ì¡±`, "text-gray-400");
                    this.checkPostAction();
                }
            }

            cpuDecideBuild(s) {
                const p = this.players[this.currentPlayerIndex];
                const b = this.buildings[boardData.indexOf(s)];
                let type = null;
                if (!b.hotel && p.money >= this.getConstructionCost(s.price, 'hotel')) type = 'hotel';
                else if (!b.building && p.money >= this.getConstructionCost(s.price, 'building')) type = 'building';
                else if (!b.villa && p.money >= this.getConstructionCost(s.price, 'villa')) type = 'villa';

                if (type) {
                    setTimeout(() => { this.confirmConstruction(s, type, this.getConstructionCost(s.price, type)); }, 800 / this.gameSpeed);
                } else {
                    this.log(`ğŸ—ï¸ (CPU) ê±´ì„¤ ì™„ë£Œ`, "text-gray-400");
                    this.checkPostAction();
                }
            }

            applyBuildingFee(name, costVilla, costBuild, costHotel) {
                const p = this.players[this.currentPlayerIndex];
                let totalFee = 0;
                this.properties.forEach((ownerId, idx) => {
                    if(ownerId === p.id) {
                        const b = this.buildings[idx];
                        if(b.villa) totalFee += costVilla;
                        if(b.building) totalFee += costBuild;
                        if(b.hotel) totalFee += costHotel;
                    }
                });

                if(totalFee > 0) {
                    if(this.solveInsolvency(p, totalFee)) {
                        p.money -= totalFee;
                        this.log(`ğŸ’¸ ${name}: â‚©${totalFee.toLocaleString()}`, "text-red-400");
                    } else { p.money = 0; this.bankrupt(p); }
                } else {
                    this.log(`ğŸ’¸ ${name}: ëŒ€ìƒ ì—†ìŒ`, "text-slate-400");
                }
                this.checkPostAction();
            }

            handleBirthday() {
                const p = this.players[this.currentPlayerIndex];
                let totalGift = 0;
                this.players.forEach(target => {
                    if(target.id !== p.id && !target.isBankrupt) {
                        if(this.solveInsolvency(target, 10000)) {
                            target.money -= 10000;
                            totalGift += 10000;
                        } else { 
                            totalGift += target.money; target.money = 0; this.bankrupt(target); 
                        }
                    }
                });
                p.money += totalGift;
                this.log(`ğŸ‚ ìƒì¼ ì¶•í•˜!`, "text-green-400 font-bold");
                this.checkPostAction();
            }

            teleportPlayer(targetPos) {
                const p = this.players[this.currentPlayerIndex];
                if (targetPos < p.pos && targetPos !== 10) { 
                    p.money += 200000;
                    this.sound.playMoney();
                    this.log(`ğŸ’° ì›”ê¸‰ ìˆ˜ë ¹`, "text-yellow-400 font-bold");
                }
                p.pos = targetPos;
                this.lastWasDouble = false; 
                this.updatePiecePositions();
                this.handleSquare(targetPos);
            }

            handleGoldenKey() {
                const p = this.players[this.currentPlayerIndex]; 
                const cards = [
                    { emoji: "ğŸ§¾", title: "ì¢…í•©ì†Œë“ì„¸", desc: "ê±´ë¬¼ë³„ ì„¸ê¸ˆ", action: () => this.applyBuildingFee("ì¢…í•©ì†Œë“ì„¸", 30000, 100000, 150000), manualTurnEnd: true },
                    { emoji: "ğŸ› ï¸", title: "ê±´ë¬¼ìˆ˜ë¦¬ë¹„", desc: "ê±´ë¬¼ë³„ ìˆ˜ë¦¬ë¹„", action: () => this.applyBuildingFee("ê±´ë¬¼ìˆ˜ë¦¬ë¹„", 30000, 60000, 100000), manualTurnEnd: true },
                    { emoji: "ğŸ‘®", title: "ë°©ë²”ë¹„", desc: "ê±´ë¬¼ë³„ ë°©ë²”ë¹„", action: () => this.applyBuildingFee("ë°©ë²”ë¹„", 10000, 30000, 50000), manualTurnEnd: true },
                    { emoji: "ğŸ“»", title: "ë¬´ì¸ë„ íƒˆì¶œê¶Œ", desc: "íƒˆì¶œê¶Œ íšë“", action: () => { p.hasEscapeCard = true; this.log("ğŸ“» íƒˆì¶œê¶Œ íšë“", "text-green-400"); }, manualTurnEnd: false },
                    { emoji: "ğŸ«", title: "ìš°ëŒ€ê¶Œ", desc: "ìš°ëŒ€ê¶Œ íšë“", action: () => { p.freePassCount++; this.log("ğŸ« ìš°ëŒ€ê¶Œ íšë“", "text-green-400"); }, manualTurnEnd: false },
                    { emoji: "ğŸ”™", title: "ë’¤ë¡œ 2ì¹¸", desc: "ë’¤ë¡œ ì´ë™", action: async () => { p.pos = (p.pos - 2 + 40) % 40; this.updatePiecePositions(); this.handleSquare(p.pos); }, manualTurnEnd: true },
                    { emoji: "ğŸ”™", title: "ë’¤ë¡œ 3ì¹¸", desc: "ë’¤ë¡œ ì´ë™", action: async () => { p.pos = (p.pos - 3 + 40) % 40; this.updatePiecePositions(); this.handleSquare(p.pos); }, manualTurnEnd: true },
                    { emoji: "âœˆï¸", title: "ì œì£¼ë„ ì—¬í–‰", desc: "ì œì£¼ë„ë¡œ ì´ë™", action: () => this.teleportPlayer(5), manualTurnEnd: true },
                    { emoji: "ğŸš†", title: "ë¶€ì‚° ì—¬í–‰", desc: "ë¶€ì‚°ìœ¼ë¡œ ì´ë™", action: () => this.teleportPlayer(25), manualTurnEnd: true },
                    { emoji: "ğŸšŒ", title: "ì„œìš¸ ì—¬í–‰", desc: "ì„œìš¸ë¡œ ì´ë™", action: () => this.teleportPlayer(39), manualTurnEnd: true },
                    { emoji: "ğŸŒ´", title: "í­í’ìš°", desc: "ë¬´ì¸ë„ë¡œ ì´ë™", action: () => { this.handleIslandArrive(); }, manualTurnEnd: true },
                    { emoji: "ğŸ¦", title: "ì‚¬íšŒë³µì§€ê¸°ê¸ˆ", desc: "ê¸°ê¸ˆ ì ‘ìˆ˜ì²˜ ì´ë™", action: () => this.teleportPlayer(20), manualTurnEnd: true },
                    { emoji: "ğŸŒ", title: "ì„¸ê³„ì¼ì£¼", desc: "ì¶œë°œì§€ë¡œ ì´ë™", action: () => { 
                        if(this.socialFund > 0) { p.money += this.socialFund; this.log(`ğŸ¦ ê¸°ê¸ˆ ìˆ˜ë ¹!`, "text-green-400"); this.socialFund = 0; }
                        this.teleportPlayer(0); 
                    }, manualTurnEnd: true },
                    { emoji: "ğŸš€", title: "ìš°ì£¼ì—¬í–‰ ì´ˆëŒ€", desc: "ìš°ì£¼ì—¬í–‰ ì´ë™ (ë¬´ë£Œ)", action: () => { 
                        p.isFreeSpaceTravel = true; 
                        this.teleportPlayer(30); 
                    }, manualTurnEnd: true },
                    { emoji: "ğŸš¢", title: "ìœ ëŒì„  ì—¬í–‰", desc: "í€¸ì¦ˆí˜¸ -> ë² ì´ì§•", action: () => { 
                        const qOwner = this.properties[28];
                        if(qOwner && qOwner !== p.id) {
                            if(this.solveInsolvency(p, 200000)) { p.money -= 200000; this.players[qOwner-1].money += 200000; this.log("ğŸš¢ ì´ìš©ë£Œ ì§€ë¶ˆ", "text-orange-300"); }
                            else { p.money=0; this.players[qOwner-1].money += p.money; this.bankrupt(p); this.checkPostAction(); return; } 
                        }
                        this.teleportPlayer(3);
                    }, manualTurnEnd: true },
                    { emoji: "ğŸ›«", title: "í•­ê³µ ì—¬í–‰", desc: "ì½©ì½”ë“œ -> íƒ€ì´ë² ì´", action: () => { 
                        const cOwner = this.properties[15];
                        if(cOwner && cOwner !== p.id) {
                             if(this.solveInsolvency(p, 200000)) { p.money -= 200000; this.players[cOwner-1].money += 200000; this.log("ğŸ›« ì´ìš©ë£Œ ì§€ë¶ˆ", "text-orange-300"); }
                             else { p.money=0; this.players[cOwner-1].money += p.money; this.bankrupt(p); this.checkPostAction(); return; }
                        }
                        this.teleportPlayer(1);
                    }, manualTurnEnd: true },
                    { emoji: "ğŸ›£ï¸", title: "ê³ ì†ë„ë¡œ", desc: "ì¶œë°œì§€ë¡œ ì´ë™", action: () => this.teleportPlayer(0), manualTurnEnd: true },
                    { emoji: "ğŸ•Šï¸", title: "ë…¸ë²¨í‰í™”ìƒ", desc: "30ë§Œ ìˆ˜ë ¹", action: () => { p.money += 300000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "ğŸ’°", title: "ë³µê¶Œ ë‹¹ì²¨", desc: "20ë§Œ ìˆ˜ë ¹", action: () => { p.money += 200000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "ğŸï¸", title: "ìë™ì°¨ ê²½ì£¼", desc: "10ë§Œ ìˆ˜ë ¹", action: () => { p.money += 100000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "ğŸ“", title: "ì¥í•™ê¸ˆ", desc: "10ë§Œ ìˆ˜ë ¹", action: () => { p.money += 100000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "ğŸ‘´", title: "ì—°ê¸ˆ", desc: "5ë§Œ ìˆ˜ë ¹", action: () => { p.money += 50000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "âœˆï¸", title: "í•´ì™¸ ìœ í•™", desc: "10ë§Œ ì§€ë¶ˆ", action: () => { if(this.solveInsolvency(p, 100000)) p.money -= 100000; else { p.money=0; this.bankrupt(p); } }, manualTurnEnd: false },
                    { emoji: "ğŸ¥", title: "ë³‘ì›ë¹„", desc: "5ë§Œ ì§€ë¶ˆ", action: () => { if(this.solveInsolvency(p, 50000)) p.money -= 50000; else { p.money=0; this.bankrupt(p); } }, manualTurnEnd: false },
                    { emoji: "ğŸš¨", title: "ê³¼ì† ìš´ì „", desc: "5ë§Œ ì§€ë¶ˆ", action: () => { if(this.solveInsolvency(p, 50000)) p.money -= 50000; else { p.money=0; this.bankrupt(p); } }, manualTurnEnd: false },
                    { emoji: "ğŸ‚", title: "ìƒì¼ ì¶•í•˜", desc: "ì „ì›ì—ê²Œ 1ë§Œì”© ë°›ê¸°", action: () => this.handleBirthday(), manualTurnEnd: true },
                    { emoji: "ğŸ“‰", title: "ë°˜ì•¡ ëŒ€ë§¤ì¶œ", desc: "ê°€ì¥ ë¹„ì‹¼ ë•… ë°˜ê°’ ì²˜ë¶„", action: () => {
                            let ownedProps = [];
                            this.properties.forEach((ownerId, idx) => {
                                if (ownerId === p.id) {
                                    const s = boardData[idx];
                                    let value = s.price;
                                    const b = this.buildings[idx];
                                    if (b.villa) value += this.getConstructionCost(s.price, 'villa');
                                    if (b.building) value += this.getConstructionCost(s.price, 'building');
                                    if (b.hotel) value += this.getConstructionCost(s.price, 'hotel');
                                    ownedProps.push({ idx: idx, name: s.name, value: value });
                                }
                            });
                            if (ownedProps.length > 0) {
                                ownedProps.sort((a, b) => b.value - a.value);
                                const target = ownedProps[0];
                                const sellPrice = Math.floor(target.value * 0.5);
                                p.money += sellPrice;
                                this.properties[target.idx] = null;
                                this.buildings[target.idx] = { villa: false, building: false, hotel: false };
                                this.updateBoardOwnerDisplay(target.idx);
                                this.log(`ğŸ“‰ ${target.name} ì²˜ë¶„`, "text-red-400 font-bold");
                            } else {
                                this.log(`ğŸ“‰ ë§¤ê°í•  ë¶€ë™ì‚° ì—†ìŒ`, "text-slate-400");
                            }
                        }, manualTurnEnd: false 
                    }
                ];

                const card = cards[Math.floor(Math.random() * cards.length)];
                this.showEventOverlay(card.emoji, card.title, card.desc, 4000); 
                const actionDelay = 4000 / this.gameSpeed;
                setTimeout(() => {
                    card.action();
                    this.log(`ğŸ”‘ í™©ê¸ˆì—´ì‡ : ${card.title}`, "text-yellow-300");
                    if (!card.manualTurnEnd) {
                        this.checkPostAction();
                    }
                }, actionDelay);
            }

            checkPostAction() {
                if (this.lastWasDouble) { 
                    this.log(`âœ¨ ë”ë¸”! í•œ ë²ˆ ë”`, "text-indigo-300 font-bold"); 
                    this.isRolling = false; this.updateStatus(); this.startTurn(); 
                }
                else this.endTurn();
            }

            showModal(s, mode) {
                const modal = document.getElementById('modal'); 
                const confirmBtn = document.getElementById('confirm-btn');
                
                // ë©€í‹°í”Œë ˆì´ì–´ë©´ ë‚´ í„´ì¸ì§€ í™•ì¸
                if (this.isMultiplayer && this.players[this.currentPlayerIndex].uid !== currentUser.uid) return;

                document.getElementById('modal-flag-container').innerHTML = s.code ? `<img src="https://flagcdn.com/w160/${s.code}.png" class="mx-auto rounded-xl shadow-lg border-4 border-white max-w-[100px]">` : `<span class="text-7xl">${s.emoji}</span>`;
                document.getElementById('modal-title').innerText = `${s.name} êµ¬ë§¤`;
                document.getElementById('modal-desc').innerHTML = `ëŒ€ì§€ ë§¤ì…ë¹„: <b>â‚©${s.price.toLocaleString()}</b>\nêµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                
                if (this.players[this.currentPlayerIndex].money < s.price) {
                    confirmBtn.disabled = true; confirmBtn.innerText = "ìê¸ˆ ë¶€ì¡±";
                    confirmBtn.classList.add('bg-gray-400'); confirmBtn.classList.remove('bg-indigo-600');
                } else {
                    confirmBtn.disabled = false; confirmBtn.innerText = "í™•ì¸";
                    confirmBtn.classList.remove('bg-gray-400'); confirmBtn.classList.add('bg-indigo-600');
                    confirmBtn.onclick = () => this.confirmAction();
                }
                modal.classList.remove('hidden');
            }

            confirmAction() {
                const p = this.players[this.currentPlayerIndex]; const pos = p.pos; const s = boardData[pos];
                if (p.money >= s.price) {
                    p.money -= s.price; this.sound.playMoney(); this.properties[pos] = p.id; 
                    this.updateBoardOwnerDisplay(pos); this.log(`ğŸ  ëŒ€ì§€ ë§¤ì…!`, "text-indigo-300 font-bold"); 
                    this.closeModal(); this.checkPostAction();
                } 
            }
            
            closeModal() { document.getElementById('modal').classList.add('hidden'); }

            showConstructionModal(s) {
                if (this.isMultiplayer && this.players[this.currentPlayerIndex].uid !== currentUser.uid) return;

                const modal = document.getElementById('build-modal');
                const optionsContainer = document.getElementById('build-options');
                optionsContainer.innerHTML = '';
                
                const p = this.players[this.currentPlayerIndex];
                const b = this.buildings[boardData.indexOf(s)];
                
                const types = [
                    { id: 'villa', name: 'ğŸ¡ ë³„ì¥', cost: this.getConstructionCost(s.price, 'villa') },
                    { id: 'building', name: 'ğŸ¢ ë¹Œë”©', cost: this.getConstructionCost(s.price, 'building') },
                    { id: 'hotel', name: 'ğŸ¨ í˜¸í…”', cost: this.getConstructionCost(s.price, 'hotel') }
                ];

                types.forEach(t => {
                    if (!b[t.id]) {
                        const btn = document.createElement('button');
                        btn.className = `w-full py-2.5 px-3 rounded-xl flex justify-between items-center transition shadow-sm mb-2 text-xs ${p.money >= t.cost ? 'bg-white border-2 border-indigo-100 hover:border-indigo-500 text-slate-700' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`;
                        btn.innerHTML = `<span class="font-bold">${t.name}</span> <span class="font-mono">â‚©${t.cost.toLocaleString()}</span>`;
                        
                        if (p.money >= t.cost) {
                            btn.onclick = () => this.confirmConstruction(s, t.id, t.cost);
                        } else {
                            btn.innerHTML += ` <span class="text-[9px] text-red-500 font-bold">(ë¶€ì¡±)</span>`;
                        }
                        optionsContainer.appendChild(btn);
                    }
                });
                modal.classList.remove('hidden');
            }
            
            closeBuildModal() { document.getElementById('build-modal').classList.add('hidden'); this.checkPostAction(); }

            confirmConstruction(s, type, cost) {
                const p = this.players[this.currentPlayerIndex]; const pos = p.pos;
                if (p.money >= cost) {
                    p.money -= cost; this.sound.playMoney(); 
                    this.buildings[pos][type] = true;
                    this.updateBoardOwnerDisplay(pos); 
                    const names = { villa: "ë³„ì¥", building: "ë¹Œë”©", hotel: "í˜¸í…”" };
                    this.log(`ğŸ—ï¸ ${s.name}ì— ${names[type]} ê±´ì„¤!`, "text-green-400 font-bold");
                    document.getElementById('build-modal').classList.add('hidden');
                    this.checkPostAction();
                }
            }

            updateBoardOwnerDisplay(pos) {
                const ownerId = this.properties[pos];
                const buildingContainer = document.getElementById(`build-${pos}`);
                const ownerContainer = document.getElementById(`owner-${pos}`);

                if (ownerId === null) {
                    if (buildingContainer) buildingContainer.innerHTML = '';
                    if (ownerContainer) ownerContainer.innerHTML = '';
                    return;
                }

                const p = this.players[ownerId - 1]; 
                const b = this.buildings[pos];
                
                if (buildingContainer) {
                    let html = '';
                    if(b.villa) html += 'ğŸ¡';
                    if(b.building) html += 'ğŸ¢';
                    if(b.hotel) html += 'ğŸ¨';
                    buildingContainer.innerHTML = `<span class="text-[0.6rem] tracking-tighter">${html}</span>`;
                }

                if (ownerContainer) {
                    ownerContainer.innerHTML = `<span class="text-[0.6rem] font-black transform scale-125 drop-shadow-md flex items-center justify-center gap-0.5 w-full" style="color:${getPlayerColor(p.id)}">${p.icon} ${p.name}</span>`;
                }
            }
            
            cancelAction() { this.closeModal(); this.checkPostAction(); }

            payRent(p, owner, pos) {
                if (owner.isBankrupt) return;
                const s = boardData[pos]; 
                const finalRent = this.getRentPrice(s.price, s.rent, this.buildings[pos], s.isSpecial);
                
                if(p.freePassCount > 0) {
                     if (p.isCpu) {
                         p.freePassCount--;
                         this.log(`ğŸ« CPU ìš°ëŒ€ê¶Œ ì‚¬ìš©!`, "text-green-400 font-bold");
                         this.checkPostAction();
                     } else {
                         this.showChoiceModal("ğŸ«", "ìš°ëŒ€ê¶Œ ì‚¬ìš©", "í†µí–‰ë£Œë¥¼ ë©´ì œë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?",
                             () => { // Yes
                                 p.freePassCount--;
                                 this.log(`ğŸ« ìš°ëŒ€ê¶Œ ì‚¬ìš©!`, "text-green-400 font-bold");
                                 this.checkPostAction();
                             },
                             () => { // No
                                 this._processPayment(p, owner, finalRent);
                             }
                         );
                     }
                     return;
                }
                
                this._processPayment(p, owner, finalRent);
            }

            _processPayment(p, owner, finalRent) {
                if (this.solveInsolvency(p, finalRent)) {
                    p.money -= finalRent; owner.money += finalRent;
                    this.sound.playAlert(); document.getElementById('game-board').classList.add('shake-effect');
                    setTimeout(() => document.getElementById('game-board').classList.remove('shake-effect'), 400);
                    this.log(`ğŸ”” â‚©${finalRent.toLocaleString()} ì§€ë¶ˆ`, "text-orange-400 font-bold");
                } else {
                    const payment = p.money; p.money = 0;
                    owner.money += payment;
                    this.bankrupt(p);
                }
                this.checkPostAction();
            }

            bankrupt(p) {
                p.isBankrupt = true; this.sound.playAlert();
                this.log(`ğŸš« <b>${p.name}</b> íŒŒì‚°!`, "text-red-500 font-black");
                this.properties.forEach((id, idx) => { 
                    if (id === p.id) { 
                        this.properties[idx] = null; 
                        this.buildings[idx] = { villa: false, building: false, hotel: false };
                        this.updateBoardOwnerDisplay(idx); 
                    } 
                });
                this.updatePiecePositions();
            }

            async chooseSpaceDestination(index) {
                const p = this.players[this.currentPlayerIndex];
                
                // ë©€í‹°í”Œë ˆì´ì–´ ê¶Œí•œ ì²´í¬
                if (this.isMultiplayer && p.uid !== currentUser.uid) return;

                p.isSpaceTravelReady = false; const oldPos = p.pos; p.pos = index;
                this.sound.playSpecial(); this.log(`ğŸš€ ìš°ì£¼ ì´ë™ ì™„ë£Œ`, "text-blue-400 font-bold");
                if (index < oldPos) { p.money += 200000; this.log("ğŸ’° ì›”ê¸‰ ìˆ˜ë ¹", "text-yellow-400"); }
                
                this.lastWasDouble = false; 
                
                this.updatePiecePositions(true); setTimeout(() => this.handleSquare(index), 700 / this.gameSpeed);
            }
            
            handleIslandArrive() {
                const p = this.players[this.currentPlayerIndex]; this.sound.playAlert();
                p.pos = 10; p.isIslandIn = true; p.islandTurns = 0; p.doubleCount = 0;
                this.lastWasDouble = false; 
                this.updatePiecePositions(true); this.showEventOverlay("ğŸŒ´", "ë¬´ì¸ë„", "3í„´ ëŒ€ê¸°"); this.endTurn(true);
            }

            gameOver(winner, isTurnLimit = false) {
                const modal = document.getElementById('game-over-modal');
                const title = document.getElementById('winner-name');
                const list = document.getElementById('ranking-list');
                
                modal.classList.remove('hidden');
                title.innerText = isTurnLimit ? `30R ì¢…ë£Œ! ìš°ìŠ¹: ${winner.name}` : `ìµœì¢… ìš°ìŠ¹: ${winner.name}`;
                
                const rank = [...this.players].sort((a,b) => {
                    if (a.isBankrupt && !b.isBankrupt) return 1;
                    if (!a.isBankrupt && b.isBankrupt) return -1;
                    return this.calculateTotalAssets(b) - this.calculateTotalAssets(a);
                });

                list.innerHTML = rank.map((p, i) => `
                    <div class="flex justify-between items-center ${i===0 ? 'font-bold text-indigo-700' : 'text-slate-600'}">
                        <span>${i+1}ìœ„ ${p.name} ${p.isBankrupt ? '(íŒŒì‚°)' : ''}</span>
                        <span>â‚©${this.calculateTotalAssets(p).toLocaleString()}</span>
                    </div>
                `).join('');
                
                localStorage.removeItem('gbm_save');
                // ë°© ì¢…ë£Œ ì²˜ë¦¬ (ë¡œì»¬ì´ ì•„ë‹ë•Œ)
                if (this.isMultiplayer && currentRoomId && currentUser) {
                     // ê²Œì„ ì˜¤ë²„ ìƒíƒœë¥¼ ë°©ì— ê¸°ë¡
                     // ë°©ì¥ì€ ë°© ìƒíƒœë¥¼ waitingìœ¼ë¡œ ëŒë¦¬ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìŒ. 
                     // ì—¬ê¸°ì„  quitGame ë²„íŠ¼ì„ í†µí•´ ë‚˜ê°€ë„ë¡ ìœ ë„.
                }
            }
            
            endTurn(force = false) {
                this.updateStatus();
                if (!this.lastWasDouble || force) {
                    let next = (this.currentPlayerIndex + 1) % this.players.length;
                    while (this.players[next].isBankrupt) next = (next + 1) % this.players.length;
                    if (next < this.currentPlayerIndex) {
                        this.round++;
                        this.log(`ğŸ”” Round ${this.round}`, "text-blue-300 font-bold");
                    }
                    this.currentPlayerIndex = next;
                    this.players[this.currentPlayerIndex].doubleCount = 0;
                }
                this.isRolling = false; this.lastWasDouble = false; this.updateStatus();
                this.startTurn();
                const tt = document.getElementById('top-title'); 
                if(tt) tt.innerText = this.players[this.currentPlayerIndex].isSpaceTravelReady ? "SPACE TRAVEL MODE" : "WORLD TOUR";
            }
        }
    </script>
</body>
</html>
