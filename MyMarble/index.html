<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î∏åÎ£®ÎßàÎ∏î Í∑∏ÎûúÎìú - ÏûêÏú† Í±¥ÏÑ§ ÏóêÎîîÏÖò</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap');

        :root {
            --board-size: min(90vw, 85vh);
            --square-font: clamp(0.38rem, 1vw, 0.6rem);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #cbd5e1;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            touch-action: manipulation;
        }

        .game-font { font-family: 'Black Han Sans', sans-serif; }

        .board-grid {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            gap: 1px;
            width: var(--board-size);
            height: var(--board-size);
            background-color: #334155;
            padding: clamp(4px, 1vw, 8px);
            border-radius: clamp(10px, 2vw, 20px);
            position: relative;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .square {
            background-color: white;
            border-radius: 2px;
            display: flex;
            flex-direction: column; 
            font-size: var(--square-font);
            position: relative;
            padding: 0; 
            text-align: center;
            word-break: keep-all;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.1);
            min-width: 0; min-height: 0;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, z-index 0.2s;
        }
        .square:hover { transform: scale(1.05); z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .square.can-move-to { border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; animation: pulse 1s infinite; }

        /* ÎÇ¥Î∂Ä Î†àÏù¥ÏïÑÏõÉ ÎπÑÏú® ÏàòÏ†ï: Í±¥Î¨º/ÏÜåÏú†Ï£º Í≥µÍ∞Ñ ÌôïÎåÄ */
        .cell-header { flex: 2; width: 100%; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid rgba(0,0,0,0.05); position: relative; font-weight: bold; color: #334155; }
        .cell-buildings { flex: 2.5; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5px; background-color: rgba(255,255,255,0.5); flex-wrap: wrap; align-content: center; transform: scale(1.1); transform-origin: center; } /* ÌÅ¨Í∏∞ ÌôïÎåÄ */
        .cell-owner { flex: 2; width: 100%; display: flex; align-items: center; justify-content: center; z-index: 5; }
        .cell-spacer { flex: 3.5; width: 100%; } /* Îπà Í≥µÍ∞Ñ Ï∂ïÏÜå */
        
        .cell-users { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            padding: 4px;
            gap: 2px;
            z-index: 10;
            pointer-events: none; 
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .square.corner { background-color: #fef3c7; }
        .square.city .cell-header { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); } 
        
        .flag-img { width: clamp(12px, 2.5vw, 20px); height: auto; border-radius: 1px; margin-right: 2px; display: inline-block; vertical-align: middle; }
        
        .center-panel {
            grid-area: 2 / 2 / 11 / 11;
            background-color: #f1f5f9;
            display: flex;
            flex-direction: column;
            padding: clamp(6px, 1.5vw, 12px);
            gap: 10px;
            overflow: hidden;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            position: relative;
        }

        .piece {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(0.6rem, 1.5vw, 1rem); 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            aspect-ratio: 1 / 1; 
            color: white; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .active-piece {
            transform: scale(1.15);
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border: 2px solid white;
            filter: grayscale(0%);
            opacity: 1;
        }

        .inactive-piece {
            transform: scale(0.65);
            z-index: 10;
            opacity: 0.6; 
            filter: grayscale(70%);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: none;
        }
        
        .piece.moving { transform: scale(1.3) translateY(-15%); z-index: 60; opacity: 1; filter: none; }

        @keyframes turn-glow {
            0%, 100% { border-color: #6366f1; box-shadow: 0 0 5px rgba(99, 102, 241, 0.5); }
            50% { border-color: #818cf8; box-shadow: 0 0 15px rgba(129, 140, 248, 0.8); }
        }
        .turn-anim { animation: turn-glow 1.5s infinite; border-width: 4px !important; }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-4px, 4px); }
            50% { transform: translate(4px, -4px); }
            75% { transform: translate(-4px, -4px); }
        }
        .shake-effect { animation: shake 0.4s ease-in-out; }

        .dice-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; flex-direction: column; align-items: center; gap: 15px;
            z-index: 100; pointer-events: none; width: 100%;
        }

        .dice-box-container { display: flex; gap: 15px; }
        .dice-box {
            width: clamp(45px, 11vw, 75px); height: clamp(45px, 11vw, 75px);
            background: white; border-radius: 12px; display: flex; align-items: center;
            justify-content: center; font-size: clamp(1.8rem, 5.5vw, 3rem);
            font-weight: 800; color: #334155; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 4px solid #6366f1; animation: dice-pop 0.3s ease-out forwards;
        }

        @keyframes dice-pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .event-info-box {
            background: rgba(255, 255, 255, 0.98); padding: 12px 24px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
            border: 3px solid #6366f1; animation: dice-pop 0.4s ease-out forwards;
        }

        .log-container::-webkit-scrollbar { width: 4px; }
        .log-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .p-bg-1 { background-color: #ff0000; }
        .p-bg-2 { background-color: #0066ff; }
        .p-bg-3 { background-color: #00cc44; }
        .p-bg-4 { background-color: #ffcc00; }
        .p-bg-5 { background-color: #aa00ff; }
        .p-bg-6 { background-color: #ff0099; }

        /* Ïö∞Ï∏° ÏÉÅÎã® Ïª®Ìä∏Î°§ Î≤ÑÌäº */
        .top-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 200;
        }
        .control-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #cbd5e1;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .control-btn:hover { background: white; transform: scale(1.05); }
    </style>
</head>
<body>

    <!-- Ïö∞Ï∏° ÏÉÅÎã® Ïª®Ìä∏Î°§ -->
    <div class="top-controls">
        <button id="speed-btn" class="control-btn" onclick="game.toggleSpeed()">‚è© x1</button>
        <button id="fullscreen-btn" class="control-btn" onclick="toggleFullScreen()">üñ•Ô∏è</button>
    </div>

    <!-- Î°úÎπÑ -->
    <div id="lobby" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 md:p-12 max-w-md w-full shadow-2xl text-center border-t-8 border-indigo-600">
            <h1 class="text-4xl md:text-5xl game-font text-indigo-600 mb-4 tracking-tighter text-nowrap uppercase">Blue Marble</h1>
            <p class="text-slate-400 mb-8 font-medium tracking-widest uppercase text-xs">CPU Battle Edition</p>
            
            <div class="flex flex-col gap-6 mb-8 w-full max-w-xs mx-auto">
                <div class="space-y-2 text-left">
                    <label class="text-sm font-bold text-slate-600">üôã‚Äç‚ôÇÔ∏è ÏÇ¨Îûå ÌîåÎ†àÏù¥Ïñ¥</label>
                    <select id="human-count" class="w-full p-3 rounded-xl border-2 border-slate-200 text-lg font-bold outline-none focus:border-indigo-500">
                        <option value="1">1Î™Ö (ÏÜîÎ°ú)</option>
                        <option value="2" selected>2Î™Ö</option>
                        <option value="3">3Î™Ö</option>
                        <option value="4">4Î™Ö</option>
                    </select>
                </div>
                <div class="space-y-2 text-left">
                    <label class="text-sm font-bold text-slate-600">ü§ñ Ïª¥Ìì®ÌÑ∞(CPU)</label>
                    <select id="cpu-count" class="w-full p-3 rounded-xl border-2 border-slate-200 text-lg font-bold outline-none focus:border-indigo-500">
                        <option value="0">ÏóÜÏùå</option>
                        <option value="1">1ÎåÄ</option>
                        <option value="2" selected>2ÎåÄ</option>
                        <option value="3">3ÎåÄ</option>
                        <option value="4">4ÎåÄ</option>
                        <option value="5">5ÎåÄ</option>
                    </select>
                </div>
            </div>

            <button onclick="checkAndStart()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-2xl text-xl shadow-xl transition transform active:scale-95">Í≤åÏûÑ ÏãúÏûë</button>
            <p id="lobby-msg" class="text-red-500 text-sm mt-4 min-h-[20px]"></p>
        </div>
    </div>

    <!-- Í≤åÏûÑ Ìåê -->
    <div id="game-board-container">
        <div id="game-board" class="board-grid opacity-0 transition-opacity duration-500">
            <div class="center-panel shadow-inner">
                
                <div id="dice-overlay" class="dice-overlay">
                    <div id="event-emoji" class="text-7xl md:text-9xl drop-shadow-2xl"></div>
                    <div id="event-msg" class="event-info-box hidden">
                        <div class="text-lg md:text-2xl font-black text-indigo-600 mb-1" id="event-title"></div>
                        <div class="text-xs md:text-sm font-medium text-slate-600" id="event-desc"></div>
                    </div>
                    <div class="dice-box-container" id="dice-container">
                        <div id="dice-1" class="dice-box">?</div>
                        <div id="dice-2" class="dice-box">?</div>
                    </div>
                </div>

                <div class="flex items-center justify-between border-b pb-2">
                    <div class="flex flex-col">
                        <h2 id="top-title" class="text-xs md:text-xl game-font text-slate-300">WORLD TOUR</h2>
                        <div id="social-fund-display" class="text-[9px] md:text-[10px] text-green-600 font-bold">ÏÇ¨ÌöåÎ≥µÏßÄÍ∏∞Í∏à: ‚Ç©0</div>
                    </div>
                    <button id="roll-btn" onclick="game.rollDice()" class="px-5 py-1.5 md:px-8 md:py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-lg active:scale-95 disabled:opacity-50 text-[11px] md:text-base disabled:cursor-not-allowed">Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Í∏∞</button>
                </div>

                <div id="player-list" class="grid grid-cols-2 gap-2 flex-[6] overflow-hidden content-start"></div>

                <div class="bg-slate-900 text-white p-3 rounded-xl shadow-2xl flex flex-col flex-[4] overflow-hidden border border-slate-700">
                    <div class="text-[9px] md:text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-widest border-b border-slate-800 pb-1 flex justify-between items-center">
                        <span>History</span>
                        <span id="turn-display" class="text-indigo-400 font-bold animate-pulse uppercase">P1 TURN</span>
                    </div>
                    <div id="game-log" class="log-container overflow-y-auto flex-1 text-[10px] md:text-[12px] space-y-1.5 flex flex-col-reverse mt-1 pr-1">
                        <div class="text-indigo-300 italic">Í≤åÏûÑÏùÑ ÏãúÏûëÌï©ÎãàÎã§.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Íµ¨Îß§ Î™®Îã¨ (ÎåÄÏßÄ Íµ¨Îß§) -->
    <div id="modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[110] hidden backdrop-blur-md">
        <div class="bg-white p-8 md:p-10 rounded-3xl max-w-sm w-full shadow-2xl text-center border-b-8 border-indigo-600 mx-4">
            <div id="modal-flag-container" class="mb-4 transform scale-110"></div>
            <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-2">Íµ¨Îß§</h2>
            <p id="modal-desc" class="text-sm md:text-base text-gray-500 mb-8 whitespace-pre-line leading-relaxed"></p>
            <div class="flex gap-3">
                <button onclick="game.cancelAction()" class="flex-1 py-3 md:py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl">Ï∑®ÏÜå</button>
                <button id="confirm-btn" onclick="game.confirmAction()" class="flex-1 py-3 md:py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <!-- Í±¥ÏÑ§ ÏÑ†ÌÉù Î™®Îã¨ (ÎÇ¥ ÎïÖ ÎèÑÏ∞© Ïãú) -->
    <div id="build-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[110] hidden backdrop-blur-md">
        <div class="bg-white p-6 md:p-8 rounded-3xl w-full max-w-sm shadow-2xl border-b-8 border-indigo-600 mx-4">
            <h2 class="text-2xl font-bold mb-1 text-center text-slate-800">Í±¥Î¨º Í±¥ÏÑ§</h2>
            <p class="text-xs text-gray-500 mb-6 text-center">Í±¥Î¨ºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî (Ï§ëÎ≥µ Í±¥ÏÑ§ Í∞ÄÎä•)</p>
            <div class="flex flex-col gap-3" id="build-options">
                <!-- ÏòµÏÖò Î≤ÑÌäºÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê® -->
            </div>
            <button onclick="game.closeBuildModal()" class="w-full mt-4 py-3 bg-slate-100 text-slate-500 font-bold rounded-xl hover:bg-slate-200">Í±¥ÏÑ§ Ï∑®ÏÜå</button>
        </div>
    </div>

    <!-- Î∂ÄÎèôÏÇ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ïπ¥Îìú -->
    <div id="property-card" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[120] hidden backdrop-blur-sm" onclick="game.closePropertyCard()">
        <div class="bg-white rounded-3xl w-full max-w-[320px] overflow-hidden shadow-2xl border-t-8" id="prop-card-border" onclick="event.stopPropagation()">
            <div class="bg-slate-50 p-6 text-center border-b">
                <div id="prop-flag" class="mb-2"></div>
                <h3 id="prop-name" class="text-2xl font-bold text-slate-800 tracking-tighter">ÎèÑÏãúÏù¥Î¶Ñ</h3>
                <p id="prop-tag" class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mt-1"></p>
            </div>
            <div class="p-6 space-y-4">
                <div id="price-info">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Ìà¨Ïûê Î∞è Í±¥ÏÑ§ ÎπÑÏö©</p>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1.5 text-xs">
                        <div class="text-slate-500 font-bold">ÎåÄÏßÄ Îß§ÏûÖ</div><div class="text-right font-bold text-indigo-600" id="cost-land">‚Ç©0</div>
                        <div id="building-costs-ui" class="flex flex-col gap-1 col-span-2 mt-1">
                            <div class="flex justify-between text-slate-700"><span>üè° Î≥ÑÏû• Í±¥ÏÑ§</span><span class="font-bold" id="cost-villa">‚Ç©0</span></div>
                            <div class="flex justify-between text-slate-700"><span>üè¢ ÎπåÎî© Í±¥ÏÑ§</span><span class="font-bold" id="cost-build">‚Ç©0</span></div>
                            <div class="flex justify-between text-slate-700"><span>üè® Ìò∏ÌÖî Í±¥ÏÑ§</span><span class="font-bold" id="cost-hotel">‚Ç©0</span></div>
                        </div>
                    </div>
                </div>
                <div id="rent-info-area" class="border-t pt-4">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Îã®Í≥ÑÎ≥Ñ ÌÜµÌñâÎ£å (ÎàÑÏ†Å)</p>
                    <div class="space-y-1.5 text-xs">
                        <div class="flex justify-between"><span>ÎåÄÏßÄ Ï†ÑÏö©</span><span class="font-bold" id="rent-1">‚Ç©0</span></div>
                        <div id="rent-details-ui" class="flex flex-col gap-1">
                            <div class="flex justify-between text-blue-600"><span>+ Î≥ÑÏû•</span><span class="font-bold" id="rent-2">‚Ç©0</span></div>
                            <div class="flex justify-between text-green-600"><span>+ ÎπåÎî©</span><span class="font-bold" id="rent-3">‚Ç©0</span></div>
                            <div class="flex justify-between text-red-600 font-bold italic"><span>+ Ìò∏ÌÖî</span><span id="rent-4">‚Ç©0</span></div>
                        </div>
                    </div>
                </div>
                <button onclick="game.closePropertyCard()" class="w-full py-3 bg-slate-800 text-white font-bold rounded-xl mt-2 hover:bg-slate-700 transition tracking-tighter">Îã´Í∏∞</button>
            </div>
        </div>
    </div>

    <script>
        class SoundManager {
            constructor() { try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
            play(freq, type, duration, vol = 0.1) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            }
            playDice() { this.play(150, 'triangle', 0.2, 0.2); }
            playMove() { this.play(600, 'sine', 0.1, 0.08); }
            playMoney() { this.play(880, 'sine', 0.1, 0.1); setTimeout(() => this.play(1320, 'sine', 0.2, 0.1), 50); }
            playAlert() { this.play(200, 'square', 0.3, 0.05); setTimeout(() => this.play(150, 'square', 0.3, 0.05), 100); }
            playSpecial() { if(!this.ctx) return; let now = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.5); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5); osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.5); }
        }

        const boardData = [
            { id: 0, name: "START", type: "corner", emoji: "üèÅ", color: "#fef3c7" },
            { id: 1, name: "ÌÉÄÏù¥Î≤†Ïù¥", type: "city", price: 50000, rent: 4000, color: "#f87171", code: "tw" },
            { id: 2, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 3, name: "Î≤†Ïù¥Ïßï", type: "city", price: 80000, rent: 6000, color: "#f87171", code: "cn" },
            { id: 4, name: "ÎßàÎãêÎùº", type: "city", price: 80000, rent: 6000, color: "#f87171", code: "ph" },
            { id: 5, name: "Ï†úÏ£ºÎèÑ", type: "city", price: 200000, rent: 300000, color: "#ec4899", code: "kr", isSpecial: true },
            { id: 6, name: "Ïã±Í∞ÄÌè¨Î•¥", type: "city", price: 100000, rent: 8000, color: "#f87171", code: "sg" },
            { id: 7, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 8, name: "Ïπ¥Ïù¥Î°ú", type: "city", price: 120000, rent: 10000, color: "#f87171", code: "eg" },
            { id: 9, name: "Ïù¥Ïä§ÌÉÑÎ∂à", type: "city", price: 120000, rent: 10000, color: "#f87171", code: "tr" },
            { id: 10, name: "Î¨¥Ïù∏ÎèÑ", type: "corner", emoji: "üå¥", color: "#fef3c7" },
            { id: 11, name: "ÏïÑÌÖåÎÑ§", type: "city", price: 140000, rent: 12000, color: "#fbbf24", code: "gr" },
            { id: 12, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 13, name: "ÏΩîÌéúÌïòÍ≤ê", type: "city", price: 160000, rent: 14000, color: "#fbbf24", code: "dk" },
            { id: 14, name: "Ïä§ÌÜ°ÌôÄÎ¶Ñ", type: "city", price: 160000, rent: 14000, color: "#fbbf24", code: "se" },
            { id: 15, name: "ÏΩ©ÏΩîÎìú", type: "city", price: 250000, rent: 300000, color: "#ec4899", emoji: "‚úàÔ∏è", isSpecial: true },
            { id: 16, name: "Ï∑®Î¶¨Ìûà", type: "city", price: 180000, rent: 16000, color: "#fbbf24", code: "ch" },
            { id: 17, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 18, name: "Î≤†Î•ºÎ¶∞", type: "city", price: 200000, rent: 18000, color: "#fbbf24", code: "de" },
            { id: 19, name: "Ïò§ÌÉÄÏôÄ", type: "city", price: 200000, rent: 18000, color: "#fbbf24", code: "ca" },
            { id: 20, name: "ÏÇ¨ÌöåÎ≥µÏßÄ", type: "corner", emoji: "üè¶", color: "#fef3c7" },
            { id: 21, name: "Î∂ÄÏóêÎÖ∏Ïä§", type: "city", price: 220000, rent: 20000, color: "#4ade80", code: "ar" },
            { id: 22, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 23, name: "ÏÉÅÌååÏö∏Î£®", type: "city", price: 240000, rent: 24000, color: "#4ade80", code: "br" },
            { id: 24, name: "ÏãúÎìúÎãà", type: "city", price: 240000, rent: 24000, color: "#4ade80", code: "au" },
            { id: 25, name: "Î∂ÄÏÇ∞", type: "city", price: 500000, rent: 600000, color: "#ec4899", code: "kr", isSpecial: true },
            { id: 26, name: "ÌïòÏôÄÏù¥", type: "city", price: 260000, rent: 24000, color: "#4ade80", code: "us" },
            { id: 27, name: "Î¶¨Ïä§Î≥∏", type: "city", price: 260000, rent: 24000, color: "#4ade80", code: "pt" },
            { id: 28, name: "ÌÄ∏Ï¶àÌò∏", type: "city", price: 300000, rent: 250000, color: "#ec4899", emoji: "üö¢", isSpecial: true },
            { id: 29, name: "ÎßàÎìúÎ¶¨Îìú", type: "city", price: 280000, rent: 26000, color: "#4ade80", code: "es" },
            { id: 30, name: "Ïö∞Ï£ºÏó¨Ìñâ", type: "corner", emoji: "üöÄ", color: "#fef3c7" },
            { id: 31, name: "ÎèÑÏøÑ", type: "city", price: 300000, rent: 30000, color: "#60a5fa", code: "jp" },
            { id: 32, name: "ÌååÎ¶¨", type: "city", price: 320000, rent: 30000, color: "#60a5fa", code: "fr" },
            { id: 33, name: "Ìô©Í∏àÏó¥Ïá†", type: "chance", emoji: "üîë", color: "#fef3c7" },
            { id: 34, name: "Î°úÎßà", type: "city", price: 320000, rent: 30000, color: "#60a5fa", code: "it" },
            { id: 35, name: "Ïª¨ÎüºÎπÑÏïÑ", type: "city", price: 450000, rent: 400000, color: "#ec4899", emoji: "üöÄ", isSpecial: true },
            { id: 36, name: "Îü∞Îçò", type: "city", price: 350000, rent: 35000, color: "#60a5fa", code: "gb" },
            { id: 37, name: "Îâ¥Ïöï", type: "city", price: 350000, rent: 35000, color: "#60a5fa", code: "us" },
            { id: 38, name: "ÏÑ∏Í∏à", type: "tax", emoji: "üí∏", color: "#fef3c7" },
            { id: 39, name: "ÏÑúÏö∏", type: "city", price: 1000000, rent: 2000000, color: "#60a5fa", code: "kr", isSpecial: true }
        ];

        function generateGridPositions() {
            let pos = [];
            for(let i=11; i>=1; i--) pos.push([11, i]); 
            for(let i=10; i>=1; i--) pos.push([i, 1]);  
            for(let i=2; i<=11; i++) pos.push([1, i]);  
            for(let i=2; i<=10; i++) pos.push([i, 11]); 
            return pos;
        }
        const gridPositions = generateGridPositions();

        class GrandBlueMarble {
            constructor(humanCount, cpuCount) {
                this.sound = new SoundManager();
                const icons = ['üöó', '‚úàÔ∏è', 'üö¢', 'üöÅ', 'üö≤', 'üöÄ'];
                const names = ['P1', 'P2', 'P3', 'P4', 'P5', 'P6'];
                
                this.players = [];
                let pId = 1;
                
                for(let i=0; i<humanCount; i++) {
                    this.players.push({
                        id: pId, 
                        isCpu: false,
                        pos: 0, money: 3000000, 
                        name: names[i], 
                        icon: icons[i],
                        isBankrupt: false, doubleCount: 0, islandTurns: 0, isIslandIn: false, 
                        hasEscapeCard: false, freePassCount: 0, isSpaceTravelReady: false
                    });
                    pId++;
                }

                for(let i=0; i<cpuCount; i++) {
                    let iconIdx = (humanCount + i) % icons.length;
                    
                    this.players.push({
                        id: pId, 
                        isCpu: true,
                        pos: 0, money: 3000000, 
                        name: `CPU${i+1}`, 
                        icon: icons[iconIdx],
                        isBankrupt: false, doubleCount: 0, islandTurns: 0, isIslandIn: false, 
                        hasEscapeCard: false, freePassCount: 0, isSpaceTravelReady: false
                    });
                    pId++;
                }

                this.currentPlayerIndex = 0; this.isRolling = false; this.lastWasDouble = false;
                this.socialFund = 0; 
                this.properties = Array(boardData.length).fill(null);
                this.buildings = Array(boardData.length).fill(null).map(() => ({ villa: false, building: false, hotel: false }));
                this.gameSpeed = 1; // 1, 2, 3
                
                this.initUI();
                this.initBoard();
                window.addEventListener('resize', () => this.updatePiecePositions());
                
                setTimeout(() => {
                    this.updateStatus();
                    this.startTurn();
                }, 200);
            }

            toggleSpeed() {
                this.gameSpeed = this.gameSpeed >= 3 ? 1 : this.gameSpeed + 1;
                document.getElementById('speed-btn').innerText = `‚è© x${this.gameSpeed}`;
            }

            // --- Í≤ΩÏ†ú Î∞∏Îü∞Ïä§ Í≥µÏãù ---
            getConstructionCost(landPrice, type) {
                if (type === 'villa') return Math.floor(landPrice * 0.5);
                if (type === 'building') return Math.floor(landPrice * 1.0);
                if (type === 'hotel') return Math.floor(landPrice * 1.5);
                return 0;
            }

            getRentPrice(landPrice, baseRent, buildings, isSpecial) {
                if (isSpecial) return baseRent; 
                
                let rent = baseRent; 
                if (buildings.villa) rent += baseRent; 
                if (buildings.building) rent += baseRent * 2; 
                if (buildings.hotel) rent += baseRent * 3; 
                
                return Math.floor(rent);
            }
            
            calculateTotalAssets(player) {
                let assets = player.money;
                this.properties.forEach((ownerId, index) => {
                    if (ownerId === player.id) {
                        const s = boardData[index];
                        let value = s.price; 
                        const b = this.buildings[index];
                        if (b.villa) value += this.getConstructionCost(s.price, 'villa');
                        if (b.building) value += this.getConstructionCost(s.price, 'building');
                        if (b.hotel) value += this.getConstructionCost(s.price, 'hotel');
                        assets += Math.floor(value * 0.5); 
                    }
                });
                return Math.floor(assets);
            }

            solveInsolvency(player, amount) {
                if (player.money >= amount) return true;
                
                let ownedProps = [];
                this.properties.forEach((ownerId, idx) => {
                    if (ownerId === player.id) {
                        const s = boardData[idx];
                        let value = s.price;
                        const b = this.buildings[idx];
                        if (b.villa) value += this.getConstructionCost(s.price, 'villa');
                        if (b.building) value += this.getConstructionCost(s.price, 'building');
                        if (b.hotel) value += this.getConstructionCost(s.price, 'hotel');
                        ownedProps.push({ idx: idx, name: s.name, value: Math.floor(value * 0.5) });
                    }
                });
                
                ownedProps.sort((a, b) => a.value - b.value); 
                
                while (player.money < amount && ownedProps.length > 0) {
                    const prop = ownedProps.shift();
                    player.money += prop.value;
                    this.properties[prop.idx] = null;
                    this.buildings[prop.idx] = { villa: false, building: false, hotel: false };
                    this.updateBoardOwnerDisplay(prop.idx); 
                    this.log(`üí∏ ÏûêÍ∏à Î∂ÄÏ°±! <b>${prop.name}</b> Ï≤òÎ∂Ñ (+‚Ç©${prop.value.toLocaleString()})`, "text-red-400 font-bold");
                }
                
                return player.money >= amount;
            }

            initUI() {
                const pList = document.getElementById('player-list'); if(!pList) return;
                pList.innerHTML = '';
                this.players.forEach(p => {
                    const card = document.createElement('div');
                    card.id = `card-p${p.id}`; card.className = `bg-white p-2 rounded-xl shadow-sm border-l-[8px] border-slate-200 flex flex-col transition-all duration-300 relative overflow-hidden`;
                    card.style.borderLeftColor = this.getPlayerColor(p.id);
                    
                    const cpuBadge = p.isCpu ? `<span class="bg-gray-800 text-white text-[9px] px-1 rounded ml-1">CPU</span>` : '';

                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-0.5">
                            <span class="text-[12px] md:text-[15px] font-black flex items-center gap-1.5"><span class="text-3xl md:text-4xl">${p.icon}</span> ${p.name}${cpuBadge}</span>
                            <div class="flex flex-col items-end gap-1">
                                <span id="turn-p${p.id}" class="text-[7px] font-black px-1.5 py-0.5 rounded-full bg-indigo-600 text-white hidden uppercase">ACT</span>
                                <span id="island-p${p.id}" class="text-[7px] font-black px-1.5 py-0.5 rounded-full bg-orange-500 text-white hidden uppercase">ISLE</span>
                                <span id="space-p${p.id}" class="text-[7px] font-black px-1.5 py-0.5 rounded-full bg-blue-500 text-white hidden uppercase">SPACE</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline px-1 border-t pt-1">
                            <div class="text-[13px] md:text-[15px] font-black text-slate-800">‚Ç© <span id="money-p${p.id}">${p.money.toLocaleString()}</span></div>
                            <div class="text-[9px] text-slate-400 font-bold">ÏûêÏÇ∞: <span id="asset-p${p.id}">0</span></div>
                        </div>
                        <div class="flex gap-1 mt-1 px-1">
                           <span id="badge-escape-${p.id}" class="hidden text-[8px] bg-slate-600 text-white px-1 rounded">üîëÌÉàÏ∂ú</span>
                           <span id="badge-freepass-${p.id}" class="hidden text-[8px] bg-purple-600 text-white px-1 rounded">üé´Ïö∞ÎåÄ(<span id="count-freepass-${p.id}">0</span>)</span>
                        </div>
                        <div id="owned-p${p.id}" class="flex flex-wrap gap-0.5 mt-1 px-1 min-h-[12px]"></div>
                    `;
                    pList.appendChild(card);
                });
                this.updateStatus();
            }

            initBoard() {
                const board = document.getElementById('game-board');
                boardData.forEach((data, index) => {
                    const div = document.createElement('div'); 
                    div.className = `square ${data.isSpecial ? 'special-city' : data.type}`; 
                    div.id = `square-${index}`;
                    const pos = gridPositions[index]; div.style.gridRow = pos[0]; div.style.gridColumn = pos[1];
                    div.onclick = (e) => {
                        const p = this.players[this.currentPlayerIndex];
                        if (p.isCpu) return; 

                        if (p.isSpaceTravelReady) this.chooseSpaceDestination(index);
                        else this.showPropertyCard(index);
                    };

                    if (data.type === 'city') {
                        const header = document.createElement('div');
                        header.className = 'cell-header';
                        header.style.backgroundColor = data.color;
                        if(data.color === '#ec4899') header.style.color = 'white'; 
                        
                        let nameHtml = `<span>${data.name}</span>`;
                        if (data.code) nameHtml = `<img src="https://flagcdn.com/w40/${data.code}.png" class="flag-img" onerror="this.style.display='none'"> ` + nameHtml;
                        else if (data.emoji) nameHtml = `<span style="margin-right:2px">${data.emoji}</span> ` + nameHtml;
                        
                        nameHtml += `<div class="absolute top-[1px] right-[1px] text-[0.35rem] opacity-70">‚Ç©${data.price/10000}Îßå</div>`;
                        header.innerHTML = nameHtml;

                        const buildings = document.createElement('div');
                        buildings.id = `build-${index}`;
                        buildings.className = 'cell-buildings';

                        const owner = document.createElement('div');
                        owner.id = `owner-${index}`;
                        owner.className = 'cell-owner';

                        const spacer = document.createElement('div');
                        spacer.className = 'cell-spacer';

                        const users = document.createElement('div');
                        users.id = `users-${index}`;
                        users.className = 'cell-users';

                        div.appendChild(header);
                        div.appendChild(buildings);
                        div.appendChild(owner);
                        div.appendChild(spacer);
                        div.appendChild(users);

                    } else {
                        div.style.backgroundColor = data.color;
                        div.style.justifyContent = 'space-between'; 

                        const topContent = document.createElement('div');
                        topContent.style.flex = '4';
                        topContent.style.display = 'flex';
                        topContent.style.flexDirection = 'column';
                        topContent.style.alignItems = 'center';
                        topContent.style.justifyContent = 'center';
                        topContent.innerHTML = `<div class="text-2xl mb-1">${data.emoji || ''}</div><div class="font-bold text-[0.65rem] text-slate-800">${data.name}</div>`;
                        
                        const users = document.createElement('div');
                        users.id = `users-${index}`;
                        users.className = 'cell-users';
                        users.style.background = 'none'; 

                        div.appendChild(topContent);
                        div.appendChild(users);
                    }
                    board.appendChild(div);
                });
                setTimeout(() => this.updatePiecePositions(), 100);
            }

            showPropertyCard(index) {
                const s = boardData[index]; if (s.type !== 'city') return;
                const cardModal = document.getElementById('property-card');
                const border = document.getElementById('prop-card-border');
                const flag = document.getElementById('prop-flag');
                
                if(!cardModal || !border || !flag) return;

                border.style.borderColor = s.color;
                if(s.code) flag.innerHTML = `<img src="https://flagcdn.com/w160/${s.code}.png" class="mx-auto rounded-lg shadow-md max-w-[80px]">`;
                else flag.innerHTML = `<span class="text-6xl">${s.emoji}</span>`;
                
                document.getElementById('prop-name').innerText = s.name;
                document.getElementById('prop-tag').innerText = s.isSpecial ? "Special Area" : "Standard City";

                const land = s.price;
                if (s.isSpecial) {
                    document.getElementById('price-info').classList.add('hidden');
                    document.getElementById('rent-details-ui').classList.add('hidden');
                    document.getElementById('cost-land').innerText = `‚Ç©${land.toLocaleString()}`;
                    document.getElementById('rent-1').innerText = `‚Ç©${s.rent.toLocaleString()}`;
                } else {
                    document.getElementById('price-info').classList.remove('hidden');
                    document.getElementById('rent-details-ui').classList.remove('hidden');
                    document.getElementById('cost-land').innerText = `‚Ç©${land.toLocaleString()}`;
                    
                    document.getElementById('cost-villa').innerText = `‚Ç©${this.getConstructionCost(land, 'villa').toLocaleString()}`;
                    document.getElementById('cost-build').innerText = `‚Ç©${this.getConstructionCost(land, 'building').toLocaleString()}`;
                    document.getElementById('cost-hotel').innerText = `‚Ç©${this.getConstructionCost(land, 'hotel').toLocaleString()}`;
                    
                    const rent = s.rent;
                    document.getElementById('rent-1').innerText = `‚Ç©${rent.toLocaleString()}`;
                    document.getElementById('rent-2').innerText = `+ ‚Ç©${rent.toLocaleString()}`; 
                    document.getElementById('rent-3').innerText = `+ ‚Ç©${(rent*2).toLocaleString()}`; 
                    document.getElementById('rent-4').innerText = `+ ‚Ç©${(rent*3).toLocaleString()}`; 
                }
                cardModal.classList.remove('hidden');
            }

            closePropertyCard() { document.getElementById('property-card').classList.add('hidden'); }

            getPlayerColor(id) { return ['#ff0000', '#0066ff', '#00cc44', '#ffcc00', '#aa00ff', '#ff0099'][id - 1]; }

            updatePiecePositions(isSpecial = false) {
                const groups = {}; 
                this.players.forEach(p => { 
                    if(!groups[p.pos]) groups[p.pos] = []; 
                    groups[p.pos].push(p); 
                });

                this.players.forEach(p => {
                    let piece = document.getElementById(`p${p.id}`);
                    if (!piece) {
                        piece = document.createElement('div');
                        piece.id = `p${p.id}`; 
                        piece.className = `piece p-bg-${p.id}`; 
                        piece.innerText = p.icon;
                    }

                    if (p.isBankrupt) { 
                        if(piece) piece.style.display = 'none'; 
                        return; 
                    }
                    
                    const userContainer = document.getElementById(`users-${p.pos}`);
                    if (userContainer) {
                        userContainer.appendChild(piece);
                        const count = userContainer.childElementCount;
                        Array.from(userContainer.children).forEach(child => {
                            child.style.width = count > 4 ? '30%' : (count > 1 ? '45%' : '80%');
                            child.style.fontSize = count > 4 ? '0.5rem' : (count > 1 ? '0.8rem' : '1.2rem');
                        });
                    }
                });
            }

            updateStatus() {
                const fundEl = document.getElementById('social-fund-display');
                if (fundEl) fundEl.innerText = `ÏÇ¨ÌöåÎ≥µÏßÄÍ∏∞Í∏à: ‚Ç©${this.socialFund.toLocaleString()}`;

                this.players.forEach(p => {
                    const mEl = document.getElementById(`money-p${p.id}`); if(mEl) mEl.innerText = p.money.toLocaleString();
                    const aEl = document.getElementById(`asset-p${p.id}`); if(aEl) aEl.innerText = this.calculateTotalAssets(p).toLocaleString();
                    const card = document.getElementById(`card-p${p.id}`); if (!card) return;

                    const escapeBadge = document.getElementById(`badge-escape-${p.id}`);
                    if(escapeBadge) p.hasEscapeCard ? escapeBadge.classList.remove('hidden') : escapeBadge.classList.add('hidden');
                    const freeBadge = document.getElementById(`badge-freepass-${p.id}`);
                    const freeCount = document.getElementById(`count-freepass-${p.id}`);
                    if(freeBadge && freeCount) {
                        if(p.freePassCount > 0) {
                            freeBadge.classList.remove('hidden');
                            freeCount.innerText = p.freePassCount;
                        } else {
                            freeBadge.classList.add('hidden');
                        }
                    }

                    const piece = document.getElementById(`p${p.id}`);
                    
                    if (this.currentPlayerIndex === p.id - 1) {
                        card.classList.add('turn-anim'); 
                        const actTag = document.getElementById(`turn-p${p.id}`);
                        if (actTag) actTag.classList.remove('hidden');
                        const turnDisplay = document.getElementById('turn-display');
                        if (turnDisplay) turnDisplay.innerText = `${p.name} TURN`;
                        
                        if (piece) {
                            piece.classList.remove('inactive-piece');
                            piece.classList.add('active-piece');
                        }
                    } else {
                        card.classList.remove('turn-anim');
                        const actTag = document.getElementById(`turn-p${p.id}`);
                        if (actTag) actTag.classList.add('hidden');
                        
                        if (piece) {
                            piece.classList.remove('active-piece');
                            piece.classList.add('inactive-piece');
                        }
                    }
                    
                    const islandTag = document.getElementById(`island-p${p.id}`);
                    if (islandTag) p.isIslandIn ? islandTag.classList.remove('hidden') : islandTag.classList.add('hidden');
                    const spaceTag = document.getElementById(`space-p${p.id}`);
                    if (spaceTag) p.isSpaceTravelReady ? spaceTag.classList.remove('hidden') : spaceTag.classList.add('hidden');
                    if (p.isBankrupt) card.classList.add('grayscale', 'opacity-40');
                    const ownedContainer = document.getElementById(`owned-p${p.id}`);
                    if (ownedContainer) {
                        const owned = boardData.filter((_, idx) => this.properties[idx] === p.id);
                        ownedContainer.innerHTML = owned.map(c => `<span class="text-[7px] px-1.5 py-0.5 rounded text-white font-black shadow-sm" style="background-color: ${c.color}">${c.name}</span>`).join('');
                    }
                });
            }

            log(msg, colorClass = "text-slate-400") {
                const logBox = document.getElementById('game-log'); const div = document.createElement('div');
                div.className = `leading-relaxed border-l-2 pl-2 border-slate-700 ${colorClass}`;
                div.innerHTML = msg; logBox.prepend(div);
            }

            resetOverlayUI() {
                const e = document.getElementById('event-emoji'); const m = document.getElementById('event-msg'); const d = document.getElementById('dice-container');
                if(e) e.innerText = ''; if(m) m.classList.add('hidden'); if(d) d.style.display = 'flex';
            }

            showEventOverlay(emoji, title, desc, duration = 2000) {
                this.resetOverlayUI(); const overlay = document.getElementById('dice-overlay');
                document.getElementById('event-emoji').innerText = emoji; document.getElementById('event-title').innerText = title; document.getElementById('event-desc').innerText = desc;
                document.getElementById('dice-container').style.display = 'none'; document.getElementById('event-msg').classList.remove('hidden'); overlay.style.display = 'flex';
                
                // Î∞∞ÏÜç Ï†ÅÏö©: Ïò§Î≤ÑÎ†àÏù¥ ÏßÄÏÜç ÏãúÍ∞Ñ Îã®Ï∂ï
                const adjustedDuration = duration / this.gameSpeed;
                setTimeout(() => { overlay.style.display = 'none'; this.resetOverlayUI(); }, adjustedDuration);
            }

            startTurn() {
                const p = this.players[this.currentPlayerIndex];
                const btn = document.getElementById('roll-btn');
                
                if (p.isCpu) {
                    btn.disabled = true;
                    btn.innerText = `${p.name} (CPU) ÏßÑÌñâ Ï§ë...`;
                    setTimeout(() => { this.rollDice(); }, 1000 / this.gameSpeed);
                } else {
                    btn.disabled = false;
                    btn.innerText = "Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Í∏∞";
                }
            }

            rollDice() {
                if (this.isRolling) return; 
                this.isRolling = true;
                
                const player = this.players[this.currentPlayerIndex];
                
                if (player.isSpaceTravelReady) { 
                    if (player.isCpu) {
                        const targets = [0, 39, 5, 25, 3]; 
                        let dest = targets[Math.floor(Math.random() * targets.length)];
                        if (Math.random() < 0.5) dest = Math.floor(Math.random() * 40);
                        
                        this.showEventOverlay("üõ∏", "Ïö∞Ï£º Ïù¥Îèô (CPU)", `${player.name} Ïù¥Îèô Ï§ë...`);
                        setTimeout(() => this.chooseSpaceDestination(dest), 1000 / this.gameSpeed);
                    } else {
                        this.showEventOverlay("üõ∏", "Ïö∞Ï£º Ïù¥Îèô Î™®Îìú", "Î≥¥ÎìúÌåêÏóêÏÑú Ïù¥ÎèôÌï† Î™©Ï†ÅÏßÄÎ•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî!"); 
                    }
                    return; 
                }

                const overlay = document.getElementById('dice-overlay'); const d1El = document.getElementById('dice-1'); const d2El = document.getElementById('dice-2');
                document.getElementById('roll-btn').disabled = true; this.resetOverlayUI(); overlay.style.display = 'flex';
                
                const interval = setInterval(() => { d1El.innerText = Math.floor(Math.random() * 6) + 1; d2El.innerText = Math.floor(Math.random() * 6) + 1; this.sound.playDice(); }, 100);
                
                // Î∞∞ÏÜç Ï†ÅÏö©: Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Îäî ÏãúÍ∞Ñ Îã®Ï∂ï
                setTimeout(() => {
                    clearInterval(interval);
                    const d1 = Math.floor(Math.random() * 6) + 1; const d2 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2; const isDouble = (d1 === d2);
                    d1El.innerText = d1; d2El.innerText = d2;
                    setTimeout(async () => {
                        overlay.style.display = 'none'; this.log(`üé≤ Í≤∞Í≥º: <b>${d1} + ${d2} = ${total}</b>`, "text-white");
                        
                        if (player.isIslandIn) {
                            if (player.hasEscapeCard) {
                                this.log(`üé´ Î¨¥Ïù∏ÎèÑ ÌÉàÏ∂úÍ∂å ÏÇ¨Ïö©!`, "text-green-400 font-bold");
                                player.hasEscapeCard = false;
                                player.isIslandIn = false; player.islandTurns = 0;
                            }
                            else if (isDouble) { this.log(`‚ú® ÎçîÎ∏îÎ°ú Î¨¥Ïù∏ÎèÑ ÌÉàÏ∂ú!`, "text-green-400 font-bold"); player.isIslandIn = false; player.islandTurns = 0; }
                            else {
                                player.islandTurns++;
                                if (player.islandTurns >= 3) { this.log(`‚åõ 3ÌÑ¥ Í≤ΩÍ≥º ÏÑùÎ∞©`, "text-indigo-300"); player.isIslandIn = false; player.islandTurns = 0; }
                                else { this.log(`üîí Î¨¥Ïù∏ÎèÑ ÎåÄÍ∏∞ (${player.islandTurns}/3)`, "text-orange-400"); this.endTurn(); return; }
                            }
                        }

                        if (isDouble && !player.isIslandIn) {
                            player.doubleCount++;
                            if (player.doubleCount === 3) { this.log(`‚ö†Ô∏è 3Ïó∞ÏÜç ÎçîÎ∏î! Î¨¥Ïù∏ÎèÑ ÏïïÏÜ°`, "text-red-500 font-bold"); this.handleIslandArrive(); return; }
                            this.lastWasDouble = true;
                        } else { player.doubleCount = 0; this.lastWasDouble = false; }
                        await this.movePlayer(total);
                    }, 800 / this.gameSpeed);
                }, 1200 / this.gameSpeed);
            }

            async chooseSpaceDestination(index) {
                const p = this.players[this.currentPlayerIndex]; p.isSpaceTravelReady = false; const oldPos = p.pos; p.pos = index;
                this.sound.playSpecial(); this.log(`üöÄ Î™©Ï†ÅÏßÄÎ°ú Ïö∞Ï£º Ïù¥Îèô!`, "text-blue-400 font-bold");
                if (index < oldPos) { p.money += 200000; this.log("üí∞ Ï∂úÎ∞úÏßÄ ÌÜµÍ≥º ÏõîÍ∏â ÏàòÎ†π", "text-yellow-400"); }
                this.updatePiecePositions(true); setTimeout(() => this.handleSquare(index), 700 / this.gameSpeed);
            }

            handleIslandArrive() {
                const p = this.players[this.currentPlayerIndex]; this.sound.playAlert();
                p.pos = 10; p.isIslandIn = true; p.islandTurns = 0; p.doubleCount = 0;
                this.updatePiecePositions(true); this.showEventOverlay("üå¥", "Î¨¥Ïù∏ÎèÑ ÏàòÍ∞ê", "ÎçîÎ∏î ÎòêÎäî 3ÌÑ¥ ÎåÄÍ∏∞"); this.endTurn(true);
            }

            async movePlayer(steps) {
                const p = this.players[this.currentPlayerIndex]; 
                const piece = document.getElementById(`p${p.id}`);
                for(let i = 0; i < steps; i++) {
                    p.pos = (p.pos + 1) % boardData.length; 
                    this.sound.playMove(); 
                    if(piece) piece.classList.add('moving');
                    this.updatePiecePositions(); 
                    if (p.pos === 0) { p.money += 200000; this.sound.playMoney(); this.log(`üí∞ ÏõîÍ∏â ÏàòÎ†π`, "text-yellow-400 font-bold"); }
                    
                    // Î∞∞ÏÜç Ï†ÅÏö©: Ïù¥Îèô ÎîúÎ†àÏù¥ Îã®Ï∂ï
                    await new Promise(r => setTimeout(r, 250 / this.gameSpeed)); 
                    
                    if(piece) piece.classList.remove('moving');
                }
                this.handleSquare(p.pos);
            }

            handleSquare(pos) {
                const s = boardData[pos]; const p = this.players[this.currentPlayerIndex];
                this.log(`üìç <b>${p.name}</b> ‚Üí <b>${s.name}</b>`, "text-slate-300 text-[10px]");
                
                if (s.type === 'city') {
                    const ownerId = this.properties[pos];
                    if (ownerId === null) { 
                        if (p.isCpu) this.cpuDecideBuy(s);
                        else this.showModal(s, 'buy'); 
                    }
                    else if (ownerId === p.id) { 
                        if (!s.isSpecial) { 
                            if (p.isCpu) this.cpuDecideBuild(s);
                            else this.showConstructionModal(s); 
                        } else {
                            this.checkPostAction();
                        }
                    }
                    else { this.payRent(p, this.players[ownerId - 1], pos); }
                } 
                else if (s.type === 'tax') { 
                    if (this.solveInsolvency(p, 150000)) {
                        p.money -= 150000; this.socialFund += 150000;
                        this.sound.playAlert(); 
                        this.log(`üí∏ ÏÑ∏Í∏à ‚Ç©15Îßå ÎÇ©Î∂Ä (Í∏∞Í∏à Ï†ÅÎ¶Ω)`, "text-red-400");
                    } else { this.bankrupt(p); }
                    this.checkPostAction();
                }
                else if (s.type === 'chance') this.handleGoldenKey();
                else if (s.name === "Î¨¥Ïù∏ÎèÑ") { this.handleIslandArrive(); }
                else if (s.name === "Ïö∞Ï£ºÏó¨Ìñâ") { 
                    this.sound.playSpecial(); 
                    const colOwner = this.properties[35]; // Ïª¨ÎüºÎπÑÏïÑÌò∏ Ï£ºÏù∏
                    
                    const fee = 200000;
                    if (this.solveInsolvency(p, fee)) {
                        p.money -= fee;
                        if (colOwner && colOwner !== p.id) {
                            this.players[colOwner-1].money += fee;
                            this.log(`üöÄ ÏÖîÌãÄÎπÑ ‚Ç©20Îßå (Ï£ºÏù∏ÏóêÍ≤å ÏßÄÎ∂à)`, "text-orange-300");
                        } else {
                            this.log(`üöÄ ÏÖîÌãÄÎπÑ ‚Ç©20Îßå (ÏùÄÌñâ ÏßÄÎ∂à)`, "text-orange-300");
                        }
                        
                        p.isSpaceTravelReady = true; 
                        if(p.isCpu) {
                            this.showEventOverlay("üöÄ", "Ïö∞Ï£ºÏó¨Ìñâ (CPU)", "Îã§Ïùå ÌÑ¥ ÏûêÎèô Ïù¥Îèô");
                        } else {
                            this.showEventOverlay("üöÄ", "Ïö∞Ï£ºÏó¨Ìñâ", "Îã§Ïùå ÌÑ¥ Ïñ¥ÎîîÎì† ÌÅ¥Î¶≠ÌïòÏó¨ Ïù¥Îèô!");
                        }
                    } else {
                        // ÌååÏÇ∞ Ïãú Ï†Ñ Ïû¨ÏÇ∞ ÏßÄÎ∂à ÌõÑ ÌååÏÇ∞
                        const payment = p.money;
                        p.money = 0;
                        if (colOwner && colOwner !== p.id) {
                            this.players[colOwner-1].money += payment;
                        }
                        this.bankrupt(p);
                    }
                    this.checkPostAction();
                }
                else if (s.name === "ÏÇ¨ÌöåÎ≥µÏßÄ") { 
                    this.sound.playMoney(); 
                    if (this.socialFund > 0) {
                        p.money += this.socialFund; 
                        this.showEventOverlay("üè¶", "ÏÇ¨ÌöåÎ≥µÏßÄÍ∏∞Í∏à", `Ï†ÅÎ¶ΩÍ∏à ‚Ç©${this.socialFund.toLocaleString()} ÏàòÎ†π!`);
                        this.log(`üè¶ Î≥µÏßÄÍ∏∞Í∏à ‚Ç©${this.socialFund.toLocaleString()} Ï†ÑÏï° ÏàòÎ†π!`, "text-green-400 font-bold");
                        this.socialFund = 0;
                    } else {
                        this.showEventOverlay("üè¶", "ÏÇ¨ÌöåÎ≥µÏßÄÍ∏∞Í∏à", "Ï†ÅÎ¶ΩÎêú Í∏∞Í∏àÏù¥ ÏóÜÏäµÎãàÎã§.");
                        this.log(`üè¶ Ï†ÅÎ¶ΩÎêú Î≥µÏßÄÍ∏∞Í∏àÏù¥ ÏóÜÏäµÎãàÎã§.`, "text-slate-400");
                    }
                    this.checkPostAction();
                } else {
                    this.checkPostAction();
                }
            }

            cpuDecideBuy(s) {
                const p = this.players[this.currentPlayerIndex];
                if (p.money >= s.price) {
                    setTimeout(() => { this.confirmAction(); }, 800 / this.gameSpeed);
                } else {
                    this.log(`üí∏ (CPU) ÏûêÍ∏à Î∂ÄÏ°±ÏúºÎ°ú Ìè¨Í∏∞`, "text-gray-400");
                    this.checkPostAction();
                }
            }

            cpuDecideBuild(s) {
                const p = this.players[this.currentPlayerIndex];
                const b = this.buildings[boardData.indexOf(s)];
                
                // ÏóÜÎäî Í±¥Î¨º ÌïòÎÇòÎßå ÏßìÍ∏∞ (ÎûúÎç§ÌïòÍ≤å Ìò∏ÌÖî Ïö∞ÏÑ†)
                let type = null;
                if (!b.hotel && p.money >= this.getConstructionCost(s.price, 'hotel')) type = 'hotel';
                else if (!b.building && p.money >= this.getConstructionCost(s.price, 'building')) type = 'building';
                else if (!b.villa && p.money >= this.getConstructionCost(s.price, 'villa')) type = 'villa';

                if (type) {
                    setTimeout(() => { this.confirmConstruction(s, type, this.getConstructionCost(s.price, type)); }, 800 / this.gameSpeed);
                } else {
                    this.log(`üèóÔ∏è (CPU) Í±¥ÏÑ§ ÎπÑÏö© Î∂ÄÏ°±/ÏôÑÎ£å`, "text-gray-400");
                    this.checkPostAction();
                }
            }

            applyBuildingFee(name, costVilla, costBuild, costHotel) {
                const p = this.players[this.currentPlayerIndex];
                let totalFee = 0;
                this.properties.forEach((ownerId, idx) => {
                    if(ownerId === p.id) {
                        const b = this.buildings[idx];
                        if(b.villa) totalFee += costVilla;
                        if(b.building) totalFee += costBuild;
                        if(b.hotel) totalFee += costHotel;
                    }
                });

                if(totalFee > 0) {
                    if(this.solveInsolvency(p, totalFee)) {
                        p.money -= totalFee;
                        this.log(`üí∏ ${name}: ‚Ç©${totalFee.toLocaleString()} ÎÇ©Î∂Ä`, "text-red-400");
                    } else { 
                        // ÌååÏÇ∞ Ïãú ÎÇ®ÏùÄ Îèà ÏßÄÎ∂à
                        p.money = 0; // solveInsolvencyÏóêÏÑú Îã§ ÌåîÏïòÏúºÎØÄÎ°ú
                        this.bankrupt(p); 
                    }
                } else {
                    this.log(`üí∏ ${name}: ÎÇ©Î∂ÄÌï† Í±¥Î¨ºÏù¥ ÏóÜÏäµÎãàÎã§.`, "text-slate-400");
                }
                this.checkPostAction();
            }

            handleBirthday() {
                const p = this.players[this.currentPlayerIndex];
                let totalGift = 0;
                this.players.forEach(target => {
                    if(target.id !== p.id && !target.isBankrupt) {
                        if(this.solveInsolvency(target, 10000)) {
                            target.money -= 10000;
                            totalGift += 10000;
                        } else { 
                            // ÏÉÅÎåÄÍ∞Ä ÌååÏÇ∞
                            totalGift += target.money;
                            target.money = 0;
                            this.bankrupt(target); 
                        }
                    }
                });
                p.money += totalGift;
                this.log(`üéÇ ÏÉùÏùº Ï∂ïÌïò! Ï¥ù ‚Ç©${totalGift.toLocaleString()} ÏàòÎ†π`, "text-green-400 font-bold");
                this.checkPostAction();
            }

            teleportPlayer(targetPos) {
                const p = this.players[this.currentPlayerIndex];
                if (targetPos < p.pos && targetPos !== 10) { // Î¨¥Ïù∏ÎèÑ Ï†úÏô∏ÌïòÍ≥† ÏõîÍ∏â ÏàòÎ†π
                    p.money += 200000;
                    this.sound.playMoney();
                    this.log(`üí∞ Ï∂úÎ∞úÏßÄ Í≤ΩÏú† ÏõîÍ∏â ÏàòÎ†π`, "text-yellow-400 font-bold");
                }
                
                p.pos = targetPos;
                this.updatePiecePositions();
                this.handleSquare(targetPos);
            }

            handleGoldenKey() {
                const p = this.players[this.currentPlayerIndex]; 
                
                const cards = [
                    { emoji: "üßæ", title: "Ï¢ÖÌï©ÏÜåÎìùÏÑ∏", desc: "Í±¥Î¨ºÎ≥Ñ ÏÑ∏Í∏à ÎÇ©Î∂Ä", action: () => this.applyBuildingFee("Ï¢ÖÌï©ÏÜåÎìùÏÑ∏", 30000, 100000, 150000), manualTurnEnd: true },
                    { emoji: "üõ†Ô∏è", title: "Í±¥Î¨ºÏàòÎ¶¨ÎπÑ", desc: "Í±¥Î¨ºÎ≥Ñ ÏàòÎ¶¨ÎπÑ ÎÇ©Î∂Ä", action: () => this.applyBuildingFee("Í±¥Î¨ºÏàòÎ¶¨ÎπÑ", 30000, 60000, 100000), manualTurnEnd: true },
                    { emoji: "üëÆ", title: "Î∞©Î≤îÎπÑ", desc: "Í±¥Î¨ºÎ≥Ñ Î∞©Î≤îÎπÑ ÎÇ©Î∂Ä", action: () => this.applyBuildingFee("Î∞©Î≤îÎπÑ", 10000, 30000, 50000), manualTurnEnd: true },
                    { emoji: "üìª", title: "Î¨¥Ïù∏ÎèÑ ÌÉàÏ∂úÍ∂å", desc: "Î¨¥Ïù∏ÎèÑ ÌÉàÏ∂úÏö© (Î≥¥Í¥Ä)", action: () => { p.hasEscapeCard = true; this.log("üìª Î¨¥Ïù∏ÎèÑ ÌÉàÏ∂úÍ∂å ÌöçÎìù!", "text-green-400"); }, manualTurnEnd: false },
                    { emoji: "üé´", title: "Ïö∞ÎåÄÍ∂å", desc: "ÌÜµÌñâÎ£å 1Ìöå Î©¥Ï†ú (Î≥¥Í¥Ä)", action: () => { p.freePassCount++; this.log("üé´ Ïö∞ÎåÄÍ∂å ÌöçÎìù! ÌÜµÌñâÎ£å 1Ìöå Î©¥Ï†ú", "text-green-400"); }, manualTurnEnd: false },
                    { emoji: "üîô", title: "Îí§Î°ú 2Ïπ∏", desc: "Îí§Î°ú 2Ïπ∏ Ïù¥Îèô", action: async () => { p.pos = (p.pos - 2 + 40) % 40; this.updatePiecePositions(); this.handleSquare(p.pos); }, manualTurnEnd: true },
                    { emoji: "üîô", title: "Îí§Î°ú 3Ïπ∏", desc: "Îí§Î°ú 3Ïπ∏ Ïù¥Îèô", action: async () => { p.pos = (p.pos - 3 + 40) % 40; this.updatePiecePositions(); this.handleSquare(p.pos); }, manualTurnEnd: true },
                    { emoji: "‚úàÔ∏è", title: "Ï†úÏ£ºÎèÑ Ïó¨Ìñâ", desc: "Ï†úÏ£ºÎèÑÎ°ú Ïù¥Îèô", action: () => this.teleportPlayer(5), manualTurnEnd: true },
                    { emoji: "üöÜ", title: "Î∂ÄÏÇ∞ Ïó¨Ìñâ", desc: "Î∂ÄÏÇ∞ÏúºÎ°ú Ïù¥Îèô", action: () => this.teleportPlayer(25), manualTurnEnd: true },
                    { emoji: "üöå", title: "ÏÑúÏö∏ Ïó¨Ìñâ", desc: "ÏÑúÏö∏Î°ú Ïù¥Îèô", action: () => this.teleportPlayer(39), manualTurnEnd: true },
                    { emoji: "üå¥", title: "Ìè≠ÌíçÏö∞", desc: "Î¨¥Ïù∏ÎèÑÎ°ú Ï°∞ÎÇú", action: () => { this.handleIslandArrive(); }, manualTurnEnd: true },
                    { emoji: "üè¶", title: "ÏÇ¨ÌöåÎ≥µÏßÄÍ∏∞Í∏à", desc: "Ï†ëÏàòÏ≤òÎ°ú Ïù¥Îèô", action: () => this.teleportPlayer(20), manualTurnEnd: true },
                    { emoji: "üåè", title: "ÏÑ∏Í≥ÑÏùºÏ£º", desc: "Ï∂úÎ∞úÏßÄÎ°ú Ïù¥Îèô (ÏõîÍ∏â+Í∏∞Í∏à)", action: () => { 
                        if(this.socialFund > 0) { p.money += this.socialFund; this.log(`üè¶ Î≥µÏßÄÍ∏∞Í∏à ÏàòÎ†π!`, "text-green-400"); this.socialFund = 0; }
                        this.teleportPlayer(0); 
                    }, manualTurnEnd: true },
                    { emoji: "üöÄ", title: "Ïö∞Ï£ºÏó¨Ìñâ Ï¥àÎåÄ", desc: "Ïö∞Ï£ºÏó¨Ìñâ Ïπ∏ÏúºÎ°ú Ïù¥Îèô", action: () => { this.teleportPlayer(30); }, manualTurnEnd: true },
                    { emoji: "üö¢", title: "Ïú†ÎûåÏÑ† Ïó¨Ìñâ", desc: "ÌÄ∏Ï¶àÌò∏ ÌÉÄÍ≥† Î≤†Ïù¥ÏßïÏúºÎ°ú", action: () => { 
                        const qOwner = this.properties[28];
                        if(qOwner && qOwner !== p.id) {
                            if(this.solveInsolvency(p, 200000)) { p.money -= 200000; this.players[qOwner-1].money += 200000; this.log("üö¢ ÌÄ∏Ï¶àÌò∏ Ïù¥Ïö©Î£å 20Îßå ÏßÄÎ∂à", "text-orange-300"); }
                            else { p.money=0; this.players[qOwner-1].money += p.money; this.bankrupt(p); this.checkPostAction(); return; } 
                        }
                        this.teleportPlayer(3);
                    }, manualTurnEnd: true },
                    { emoji: "üõ´", title: "Ìï≠Í≥µ Ïó¨Ìñâ", desc: "ÏΩ©ÏΩîÎìú ÌÉÄÍ≥† ÌÉÄÏù¥Î≤†Ïù¥Î°ú", action: () => { 
                        const cOwner = this.properties[15];
                        if(cOwner && cOwner !== p.id) {
                             if(this.solveInsolvency(p, 200000)) { p.money -= 200000; this.players[cOwner-1].money += 200000; this.log("üõ´ ÏΩ©ÏΩîÎìú Ïù¥Ïö©Î£å 20Îßå ÏßÄÎ∂à", "text-orange-300"); }
                             else { p.money=0; this.players[cOwner-1].money += p.money; this.bankrupt(p); this.checkPostAction(); return; }
                        }
                        this.teleportPlayer(1);
                    }, manualTurnEnd: true },
                    { emoji: "üõ£Ô∏è", title: "Í≥†ÏÜçÎèÑÎ°ú", desc: "Ï∂úÎ∞úÏßÄÎ°ú Ïù¥Îèô", action: () => this.teleportPlayer(0), manualTurnEnd: true },
                    { emoji: "üïäÔ∏è", title: "ÎÖ∏Î≤®ÌèâÌôîÏÉÅ", desc: "ÏÉÅÍ∏à 30Îßå ÏàòÎ†π", action: () => { p.money += 300000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "üí∞", title: "Î≥µÍ∂å ÎãπÏ≤®", desc: "ÎãπÏ≤®Í∏à 20Îßå ÏàòÎ†π", action: () => { p.money += 200000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "üèéÔ∏è", title: "ÏûêÎèôÏ∞® Í≤ΩÏ£º", desc: "Ïö∞Ïäπ ÏÉÅÍ∏à 10Îßå ÏàòÎ†π", action: () => { p.money += 100000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "üéì", title: "Ïû•ÌïôÍ∏à", desc: "10Îßå ÏàòÎ†π", action: () => { p.money += 100000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "üë¥", title: "Ïó∞Í∏à", desc: "5Îßå ÏàòÎ†π", action: () => { p.money += 50000; this.sound.playMoney(); }, manualTurnEnd: false },
                    { emoji: "‚úàÔ∏è", title: "Ìï¥Ïô∏ Ïú†Ìïô", desc: "ÌïôÎπÑ 10Îßå ÏßÄÎ∂à", action: () => { if(this.solveInsolvency(p, 100000)) p.money -= 100000; else { p.money=0; this.bankrupt(p); } }, manualTurnEnd: false },
                    { emoji: "üè•", title: "Î≥ëÏõêÎπÑ", desc: "ÏπòÎ£åÎπÑ 5Îßå ÏßÄÎ∂à", action: () => { if(this.solveInsolvency(p, 50000)) p.money -= 50000; else { p.money=0; this.bankrupt(p); } }, manualTurnEnd: false },
                    { emoji: "üö®", title: "Í≥ºÏÜç Ïö¥Ï†Ñ", desc: "Î≤åÍ∏à 5Îßå ÏßÄÎ∂à", action: () => { if(this.solveInsolvency(p, 50000)) p.money -= 50000; else { p.money=0; this.bankrupt(p); } }, manualTurnEnd: false },
                    { emoji: "üéÇ", title: "ÏÉùÏùº Ï∂ïÌïò", desc: "Ï†ÑÏõêÏóêÍ≤å 1ÎßåÏõêÏî© Î∞õÍ∏∞", action: () => this.handleBirthday(), manualTurnEnd: true },
                    { emoji: "üìâ", title: "Î∞òÏï° ÎåÄÎß§Ï∂ú", desc: "Í∞ÄÏû• ÎπÑÏãº ÎïÖ Î∞òÍ∞í Ï≤òÎ∂Ñ", action: () => {
                            let ownedProps = [];
                            this.properties.forEach((ownerId, idx) => {
                                if (ownerId === p.id) {
                                    const s = boardData[idx];
                                    let value = s.price;
                                    const b = this.buildings[idx];
                                    if (b.villa) value += this.getConstructionCost(s.price, 'villa');
                                    if (b.building) value += this.getConstructionCost(s.price, 'building');
                                    if (b.hotel) value += this.getConstructionCost(s.price, 'hotel');
                                    ownedProps.push({ idx: idx, name: s.name, value: value });
                                }
                            });
                            if (ownedProps.length > 0) {
                                ownedProps.sort((a, b) => b.value - a.value);
                                const target = ownedProps[0];
                                const sellPrice = Math.floor(target.value * 0.5);
                                p.money += sellPrice;
                                this.properties[target.idx] = null;
                                this.buildings[target.idx] = { villa: false, building: false, hotel: false };
                                this.updateBoardOwnerDisplay(target.idx);
                                this.log(`üìâ ${target.name} Î∞òÍ∞í Ï≤òÎ∂Ñ (+‚Ç©${sellPrice.toLocaleString()})`, "text-red-400 font-bold");
                            } else {
                                this.log(`üìâ Îß§Í∞ÅÌï† Î∂ÄÎèôÏÇ∞Ïù¥ ÏóÜÏäµÎãàÎã§.`, "text-slate-400");
                            }
                        }, manualTurnEnd: false 
                    }
                ];

                const card = cards[Math.floor(Math.random() * cards.length)];
                this.showEventOverlay(card.emoji, card.title, card.desc); 
                card.action();
                this.log(`üîë Ìô©Í∏àÏó¥Ïá†: ${card.title}`, "text-yellow-300");
                
                if (!card.manualTurnEnd) {
                    this.checkPostAction();
                }
            }

            checkPostAction() {
                if (this.lastWasDouble) { this.log(`‚ú® ÎçîÎ∏î Ï∞¨Ïä§! Ìïú Î≤à Îçî`, "text-indigo-300 font-bold"); this.isRolling = false; this.updateStatus(); this.startTurn(); }
                else this.endTurn();
            }

            showModal(s, mode) {
                const modal = document.getElementById('modal'); const flag = document.getElementById('modal-flag-container');
                const title = document.getElementById('modal-title'); const desc = document.getElementById('modal-desc');
                const confirmBtn = document.getElementById('confirm-btn');
                
                if(s.code) flag.innerHTML = `<img src="https://flagcdn.com/w160/${s.code}.png" class="mx-auto rounded-xl shadow-lg border-4 border-white max-w-[100px]">`;
                else flag.innerHTML = `<span class="text-7xl">${s.emoji}</span>`;
                
                title.innerText = `${s.name} Íµ¨Îß§`; 
                desc.innerHTML = `ÎåÄÏßÄ Îß§ÏûÖÎπÑ: <b>‚Ç©${s.price.toLocaleString()}</b>\nÍµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
                
                if (this.players[this.currentPlayerIndex].money < s.price) {
                    confirmBtn.disabled = true; confirmBtn.innerText = "ÏûêÍ∏à Î∂ÄÏ°±";
                    confirmBtn.classList.add('bg-gray-400'); confirmBtn.classList.remove('bg-indigo-600');
                } else {
                    confirmBtn.disabled = false; confirmBtn.innerText = "ÌôïÏù∏";
                    confirmBtn.classList.remove('bg-gray-400'); confirmBtn.classList.add('bg-indigo-600');
                    confirmBtn.onclick = () => this.confirmAction();
                }

                modal.classList.remove('hidden');
            }

            showConstructionModal(s) {
                const modal = document.getElementById('build-modal');
                const optionsContainer = document.getElementById('build-options');
                optionsContainer.innerHTML = '';
                
                const p = this.players[this.currentPlayerIndex];
                const b = this.buildings[boardData.indexOf(s)];
                
                const types = [
                    { id: 'villa', name: 'üè° Î≥ÑÏû•', cost: this.getConstructionCost(s.price, 'villa') },
                    { id: 'building', name: 'üè¢ ÎπåÎî©', cost: this.getConstructionCost(s.price, 'building') },
                    { id: 'hotel', name: 'üè® Ìò∏ÌÖî', cost: this.getConstructionCost(s.price, 'hotel') }
                ];

                types.forEach(t => {
                    if (!b[t.id]) {
                        const btn = document.createElement('button');
                        btn.className = `w-full py-3 px-4 rounded-xl flex justify-between items-center transition shadow-sm ${p.money >= t.cost ? 'bg-white border-2 border-indigo-100 hover:border-indigo-500 text-slate-700' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`;
                        btn.innerHTML = `<span class="font-bold">${t.name}</span> <span class="text-sm">‚Ç©${t.cost.toLocaleString()}</span>`;
                        
                        if (p.money >= t.cost) {
                            btn.onclick = () => this.confirmConstruction(s, t.id, t.cost);
                        } else {
                            btn.innerHTML += ` <span class="text-[10px] text-red-500 font-bold">(Î∂ÄÏ°±)</span>`;
                        }
                        optionsContainer.appendChild(btn);
                    }
                });

                modal.classList.remove('hidden');
            }

            closeBuildModal() {
                document.getElementById('build-modal').classList.add('hidden');
                this.checkPostAction();
            }

            confirmAction() {
                const p = this.players[this.currentPlayerIndex]; const pos = p.pos; const s = boardData[pos];
                if (p.money >= s.price) {
                    p.money -= s.price; this.sound.playMoney(); this.properties[pos] = p.id; 
                    this.updateBoardOwnerDisplay(pos); this.log(`üè† ÎåÄÏßÄ Îß§ÏûÖ!`, "text-indigo-300 font-bold"); this.closeModal(); this.checkPostAction();
                } 
            }

            confirmConstruction(s, type, cost) {
                const p = this.players[this.currentPlayerIndex]; const pos = p.pos;
                if (p.money >= cost) {
                    p.money -= cost; this.sound.playMoney(); 
                    this.buildings[pos][type] = true;
                    this.updateBoardOwnerDisplay(pos); 
                    const names = { villa: "Î≥ÑÏû•", building: "ÎπåÎî©", hotel: "Ìò∏ÌÖî" };
                    this.log(`üèóÔ∏è ${s.name}Ïóê ${names[type]} Í±¥ÏÑ§!`, "text-green-400 font-bold");
                    document.getElementById('build-modal').classList.add('hidden');
                    this.checkPostAction();
                }
            }

            updateBoardOwnerDisplay(pos) {
                const ownerId = this.properties[pos];
                const buildingContainer = document.getElementById(`build-${pos}`);
                const ownerContainer = document.getElementById(`owner-${pos}`);

                if (ownerId === null) {
                    if (buildingContainer) buildingContainer.innerHTML = '';
                    if (ownerContainer) ownerContainer.innerHTML = '';
                    return;
                }

                const p = this.players[ownerId - 1]; 
                const b = this.buildings[pos];
                
                if (buildingContainer) {
                    let html = '';
                    if(b.villa) html += 'üè°';
                    if(b.building) html += 'üè¢';
                    if(b.hotel) html += 'üè®';
                    buildingContainer.innerHTML = `<span class="text-xs tracking-tighter">${html}</span>`;
                }

                if (ownerContainer) {
                    ownerContainer.innerHTML = `<span class="text-[0.65rem] font-black transform scale-125 drop-shadow-md flex items-center justify-center gap-0.5 w-full" style="color:${this.getPlayerColor(p.id)}">${p.icon} ${p.name}</span>`;
                }
            }

            cancelAction() { this.closeModal(); this.checkPostAction(); }
            closeModal() { document.getElementById('modal').classList.add('hidden'); }

            payRent(p, owner, pos) {
                if (owner.isBankrupt) return;
                const s = boardData[pos]; 
                const finalRent = this.getRentPrice(s.price, s.rent, this.buildings[pos], s.isSpecial);
                
                if(p.freePassCount > 0) {
                    p.freePassCount--;
                    this.log(`üé´ Ïö∞ÎåÄÍ∂å ÏÇ¨Ïö©! ÌÜµÌñâÎ£å Î©¥Ï†ú`, "text-green-400 font-bold");
                    this.checkPostAction(); 
                    return;
                }
                
                if (this.solveInsolvency(p, finalRent)) {
                    p.money -= finalRent; owner.money += finalRent;
                    this.sound.playAlert(); document.getElementById('game-board').classList.add('shake-effect');
                    setTimeout(() => document.getElementById('game-board').classList.remove('shake-effect'), 400);
                    this.log(`üîî ‚Ç©${finalRent.toLocaleString()} ÏßÄÎ∂à`, "text-orange-400 font-bold");
                } else {
                    const payment = p.money;
                    p.money = 0;
                    owner.money += payment;
                    this.bankrupt(p);
                }
                this.checkPostAction();
            }

            bankrupt(p) {
                p.isBankrupt = true; this.sound.playAlert();
                this.log(`üö´ <b>${p.name}</b> ÌååÏÇ∞!`, "text-red-500 font-black");
                this.properties.forEach((id, idx) => { 
                    if (id === p.id) { 
                        this.properties[idx] = null; 
                        this.buildings[idx] = { villa: false, building: false, hotel: false };
                        this.updateBoardOwnerDisplay(idx); 
                    } 
                });
                this.updatePiecePositions();
            }

            endTurn(force = false) {
                this.updateStatus();
                if (!this.lastWasDouble || force) {
                    let next = (this.currentPlayerIndex + 1) % this.players.length;
                    if (this.players.filter(p => !p.isBankrupt).length <= 1) { alert(`üèÜ ÏµúÏ¢Ö Ïö∞Ïäπ: ${this.players.find(p => !p.isBankrupt).name}`); location.reload(); return; }
                    while (this.players[next].isBankrupt) next = (next + 1) % this.players.length;
                    this.currentPlayerIndex = next; this.players[this.currentPlayerIndex].doubleCount = 0;
                }
                this.isRolling = false; this.lastWasDouble = false; this.updateStatus();
                this.startTurn();
                const tt = document.getElementById('top-title'); if(tt) tt.innerText = this.players[this.currentPlayerIndex].isSpaceTravelReady ? "SPACE TRAVEL MODE" : "WORLD TOUR";
            }
        }

        function checkAndStart() {
            const human = parseInt(document.getElementById('human-count').value);
            const cpu = parseInt(document.getElementById('cpu-count').value);
            const total = human + cpu;
            
            if (total < 2 || total > 6) {
                document.getElementById('lobby-msg').innerText = `Ï¥ù ÌîåÎ†àÏù¥Ïñ¥Îäî 2Î™Ö Ïù¥ÏÉÅ 6Î™Ö Ïù¥ÌïòÏó¨Ïïº Ìï©ÎãàÎã§. (ÌòÑÏû¨: ${total}Î™Ö)`;
                return;
            }
            
            document.getElementById('lobby').classList.add('hidden'); 
            document.getElementById('game-board').classList.remove('opacity-0');
            window.game = new GrandBlueMarble(human, cpu);
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
    </script>
</body>
</html>
