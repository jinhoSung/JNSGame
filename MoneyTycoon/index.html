import React, { useState, useEffect, useCallback, useRef } from 'react';
import { 
  Coins, 
  TrendingUp, 
  TrendingDown,
  Briefcase, 
  Building2, 
  Zap, 
  MousePointer2, 
  ArrowUpCircle,
  Trophy,
  Activity,
  LineChart,
  Wallet,
  Landmark,
  Microscope,
  Calculator,
  Rocket,
  Globe,
  Gem
} from 'lucide-react';

// --- ê²Œì„ ë°ì´í„° ë° ìƒìˆ˜ ì„¤ì • ---

// ì´ˆê¸° ë¹„ì¦ˆë‹ˆìŠ¤ ëª©ë¡ (ì½˜í…ì¸  ëŒ€í­ ì¶”ê°€)
const INITIAL_BUSINESSES = [
  { id: 1, name: 'í¸ì˜ì  ì•Œë°”', baseCost: 15, baseIncome: 3, count: 0, icon: 'store' },
  { id: 2, name: 'ë…¸ì ìƒ ìš´ì˜', baseCost: 100, baseIncome: 15, count: 0, icon: 'shop' },
  { id: 3, name: 'ì¤‘ì†Œê¸°ì—… ìš´ì˜', baseCost: 1100, baseIncome: 90, count: 0, icon: 'chart' },
  { id: 4, name: 'í”„ëœì°¨ì´ì¦ˆ', baseCost: 12000, baseIncome: 450, count: 0, icon: 'building' },
  { id: 5, name: 'ë°°ë‹¬ ì•± ìŠ¤íƒ€íŠ¸ì—…', baseCost: 130000, baseIncome: 2200, count: 0, icon: 'scooter' }, // New
  { id: 6, name: 'IT ë²¤ì²˜ê¸°ì—…', baseCost: 850000, baseIncome: 9500, count: 0, icon: 'rocket' },
  { id: 7, name: 'ê¸€ë¡œë²Œ ì€í–‰', baseCost: 5000000, baseIncome: 45000, count: 0, icon: 'bank' },
  { id: 8, name: 'ì—ë„ˆì§€ ë°œì „ì†Œ', baseCost: 45000000, baseIncome: 250000, count: 0, icon: 'zap' }, // New
  { id: 9, name: 'ë¯¼ê°„ ìš°ì£¼ í•­ê³µì‚¬', baseCost: 350000000, baseIncome: 1500000, count: 0, icon: 'space' }, // New
  { id: 10, name: 'í™”ì„± ì‹ë¯¼ì§€', baseCost: 5000000000, baseIncome: 12000000, count: 0, icon: 'mars' }, // New (End Game)
];

// ì´ˆê¸° íˆ¬ì ìì‚° ëª©ë¡ (ë‹¤ì–‘ì„± ì¶”ê°€)
const INITIAL_INVESTMENTS = [
  { 
    id: 'coin', 
    name: 'ë„ì§€ì™• ì½”ì¸', 
    price: 30, 
    owned: 0, 
    avgPrice: 0, 
    volatility: 0.20, // ë³€ë™ì„± ìƒí–¥
    type: 'high_risk',
    desc: 'ë§¤ìš° ìœ„í—˜í•˜ì§€ë§Œ ëŒ€ë°• ê°€ëŠ¥ì„±',
    history: [30, 30, 30, 30, 30] 
  },
  { 
    id: 'nft', 
    name: 'í¬ê·€ NFT ì•„íŠ¸', 
    price: 1500, 
    owned: 0, 
    avgPrice: 0, 
    volatility: 0.25, // ê·¹ì‹¬í•œ ë³€ë™ì„±
    type: 'high_risk',
    desc: 'ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë””ì§€í„¸ ìì‚°',
    history: [1500, 1500, 1500, 1500, 1500] 
  },
  { 
    id: 'bio_stock', 
    name: 'ë°”ì´ì˜¤ ì£¼ì‹', 
    price: 5500, 
    owned: 0, 
    avgPrice: 0, 
    volatility: 0.12, // ë†’ì€ ë³€ë™ì„±
    type: 'medium_risk',
    desc: 'ì„ìƒ ê²°ê³¼ì— ë”°ë¼ ë“±ë½í­ í¼',
    history: [5500, 5500, 5500, 5500, 5500]
  },
  { 
    id: 'stock', 
    name: 'ì‚¼ì†¡ì „ì', 
    price: 8000, 
    owned: 0, 
    avgPrice: 0, 
    volatility: 0.05, 
    type: 'medium_risk',
    desc: 'ì•ˆì •ì ì¸ ìš°ëŸ‰ì£¼ (ë°°ë‹¹ê¸ˆ ëŒ€ìƒ)',
    history: [8000, 8000, 8000, 8000, 8000]
  },
  { 
    id: 'gold', 
    name: 'ìˆœê¸ˆ ê³¨ë“œë°”', 
    price: 350000, 
    owned: 0, 
    avgPrice: 0, 
    volatility: 0.015, // ë§¤ìš° ë‚®ì€ ë³€ë™ì„±
    type: 'low_risk',
    desc: 'ë¶ˆí™©ì—ë„ ê°•í•œ ìµœê³ ì˜ ì•ˆì „ìì‚°',
    history: [350000, 350000, 350000, 350000, 350000]
  },
  { 
    id: 'real_estate', 
    name: 'ê°•ë‚¨ ì•„íŒŒíŠ¸', 
    price: 1500000, 
    owned: 0, 
    avgPrice: 0, 
    volatility: 0.02, 
    type: 'low_risk',
    desc: 'ë³€ë™ì´ ì ì€ ë¶€ë™ì‚° (ë°°ë‹¹ê¸ˆ ëŒ€ìƒ)',
    history: [1500000, 1500000, 1500000, 1500000, 1500000]
  },
];

// ì—…ê·¸ë ˆì´ë“œ(ì—°êµ¬) ëª©ë¡
const INITIAL_UPGRADES = [
  { 
    id: 'click_boost', 
    name: 'ë‚˜ë…¸ í´ë¦­ ê°•í™”', 
    type: 'click', 
    level: 0, 
    maxLevel: 50, 
    baseCost: 500, 
    costScale: 2.5, 
    descTemplate: 'í´ë¦­ ìˆ˜ìµ +{val}% (í˜„ì¬: {curr}ë°°)',
    getEffect: (lvl) => 1 + (lvl * 1) 
  },
  { 
    id: 'biz_boost', 
    name: 'ì‚¬ì—… ìë™í™” AI', 
    type: 'business', 
    level: 0, 
    maxLevel: 50, 
    baseCost: 2000, 
    costScale: 2.2, 
    descTemplate: 'ëª¨ë“  ì‚¬ì—… ìˆ˜ìµ +{val}% (í˜„ì¬: +{curr}%)',
    getEffect: (lvl) => 1 + (lvl * 0.2) 
  },
  { 
    id: 'div_boost', 
    name: 'ë°°ë‹¹ê¸ˆ íˆ¬ì ì „ëµ', 
    type: 'dividend', 
    level: 0, 
    maxLevel: 20, 
    baseCost: 50000, 
    costScale: 3.0, 
    descTemplate: 'ì£¼ì‹/ë¶€ë™ì‚° ê°€ì¹˜ì˜ {val}% ì´ˆë‹¹ ìˆ˜ìµ (í˜„ì¬: {curr}%)',
    getEffect: (lvl) => lvl * 0.002 
  },
  { 
    id: 'market_boost', 
    name: 'ì‹œì¥ ì˜ˆì¸¡ ëª¨ë¸', 
    type: 'market', 
    level: 0, 
    maxLevel: 10, 
    baseCost: 100000, 
    costScale: 4.0, 
    descTemplate: 'í˜¸í™©ê¸° ë³´ë„ˆìŠ¤ ë°°ìœ¨ +{val} (í˜„ì¬: x{curr})',
    getEffect: (lvl) => 2.0 + (lvl * 0.5) 
  },
  { 
    id: 'cost_cut', 
    name: 'ë¡œë¹„ìŠ¤íŠ¸ ê³ ìš©', 
    type: 'discount', 
    level: 0, 
    maxLevel: 10, 
    baseCost: 500000, 
    costScale: 5.0, 
    descTemplate: 'ì‚¬ì—… ì¸ìˆ˜ ë¹„ìš© {val}% í• ì¸ (í˜„ì¬: -{curr}%)',
    getEffect: (lvl) => Math.max(0.1, 1.0 - (lvl * 0.05)) 
  }
];

// ì‹œì¥ ì´ë²¤íŠ¸ íƒ€ì…
const MARKET_EVENTS = [
  { id: 'normal', name: 'í‰ì˜¨í•œ ì‹œì¥', multiplier: 1.0, priceBias: 0, color: 'text-gray-400', desc: 'ê²½ì œê°€ ì•ˆì •ì ì…ë‹ˆë‹¤.' },
  { id: 'bull', name: 'ê²½ì œ í˜¸í™©', multiplier: 2.0, priceBias: 0.03, color: 'text-green-400', desc: 'ìˆ˜ìµ í­ë°œ & ì£¼ê°€ ìƒìŠ¹ì¥!' },
  { id: 'bear', name: 'ê²½ì œ ë¶ˆí™©', multiplier: 0.5, priceBias: -0.03, color: 'text-red-400', desc: 'ìˆ˜ìµ ë°˜í† ë§‰ & ì£¼ê°€ í•˜ë½ì¥...' },
];

export default function App() {
  const [money, setMoney] = useState(0);
  const [totalEarned, setTotalEarned] = useState(0);
  const [businesses, setBusinesses] = useState(INITIAL_BUSINESSES);
  const [investments, setInvestments] = useState(INITIAL_INVESTMENTS);
  const [upgrades, setUpgrades] = useState(INITIAL_UPGRADES);
  const [marketStatus, setMarketStatus] = useState(MARKET_EVENTS[0]);
  const [timeLeftForEvent, setTimeLeftForEvent] = useState(30);
  const [activeTab, setActiveTab] = useState('business');
  
  const [tradeAmount, setTradeAmount] = useState(1); 
  
  const formatMoney = (amount) => Math.floor(amount).toLocaleString('ko-KR');

  const getUpgradeCost = useCallback((upgrade) => {
    return Math.floor(upgrade.baseCost * Math.pow(upgrade.costScale, upgrade.level));
  }, []);

  const calculateCost = useCallback((baseCost, count) => {
    const discountUpgrade = upgrades.find(u => u.type === 'discount');
    const discountMultiplier = discountUpgrade ? discountUpgrade.getEffect(discountUpgrade.level) : 1.0;
    return Math.floor(baseCost * Math.pow(1.15, count) * discountMultiplier);
  }, [upgrades]);

  const calculateIncomePerSecond = useCallback(() => {
    let businessIncome = businesses.reduce((acc, bus) => acc + (bus.baseIncome * bus.count), 0);
    
    const bizUpgrade = upgrades.find(u => u.type === 'business');
    if (bizUpgrade) businessIncome *= bizUpgrade.getEffect(bizUpgrade.level);

    const divUpgrade = upgrades.find(u => u.type === 'dividend');
    let dividendIncome = 0;
    if (divUpgrade && divUpgrade.level > 0) {
      const dividendRate = divUpgrade.getEffect(divUpgrade.level);
      // ë°°ë‹¹ê¸ˆ ëŒ€ìƒ: ì£¼ì‹, ë¶€ë™ì‚°, ê¸ˆ (ì•ˆì „ìì‚° í¬í•¨)
      const dividendAssets = ['stock', 'real_estate', 'gold', 'bio_stock'];
      let assetValue = 0;
      investments.forEach(inv => {
        if (dividendAssets.includes(inv.id)) {
          assetValue += inv.price * inv.owned;
        }
      });
      dividendIncome = assetValue * dividendRate;
    }

    let currentMarketMult = marketStatus.multiplier;
    if (marketStatus.id === 'bull') {
      const marketUpgrade = upgrades.find(u => u.type === 'market');
      if (marketUpgrade) currentMarketMult = marketUpgrade.getEffect(marketUpgrade.level);
    }

    return (businessIncome + dividendIncome) * currentMarketMult;
  }, [businesses, upgrades, marketStatus, investments]);

  useEffect(() => {
    const timer = setInterval(() => {
      const income = calculateIncomePerSecond();
      if (income > 0) {
        setMoney(prev => prev + income);
        setTotalEarned(prev => prev + income);
      }
    }, 1000);
    return () => clearInterval(timer);
  }, [calculateIncomePerSecond]);

  useEffect(() => {
    const priceTimer = setInterval(() => {
      setInvestments(prevInvestments => {
        return prevInvestments.map(item => {
          const randomFactor = (Math.random() - 0.5) * 2; 
          const marketBias = marketStatus.priceBias;
          const changePercent = (randomFactor * item.volatility) + marketBias;
          
          let newPrice = Math.round(item.price * (1 + changePercent));
          if (newPrice < 1) newPrice = 1;

          const newHistory = [...item.history.slice(1), newPrice];
          return { ...item, price: newPrice, history: newHistory };
        });
      });
    }, 1500);
    return () => clearInterval(priceTimer);
  }, [marketStatus]);

  useEffect(() => {
    const eventTimer = setInterval(() => {
      setTimeLeftForEvent(prev => {
        if (prev <= 1) {
          const random = Math.random();
          let newEvent;
          if (random < 0.6) newEvent = MARKET_EVENTS[0];
          else if (random < 0.85) newEvent = MARKET_EVENTS[1];
          else newEvent = MARKET_EVENTS[2];
          setMarketStatus(newEvent);
          return 30;
        }
        return prev - 1;
      });
    }, 1000);
    return () => clearInterval(eventTimer);
  }, []);

  const handleManualClick = () => {
    const baseClick = 1;
    const clickUpgrade = upgrades.find(u => u.type === 'click');
    const clickMult = clickUpgrade ? clickUpgrade.getEffect(clickUpgrade.level) : 1;
    const passiveBonus = calculateIncomePerSecond() * 0.01; 
    
    const clickValue = (baseClick + passiveBonus) * clickMult;
    setMoney(prev => prev + clickValue);
    setTotalEarned(prev => prev + clickValue);
  };

  const buyBusiness = (id) => {
    const idx = businesses.findIndex(b => b.id === id);
    const cost = calculateCost(businesses[idx].baseCost, businesses[idx].count);
    if (money >= cost) {
      setMoney(prev => prev - cost);
      const newBus = [...businesses];
      newBus[idx].count += 1;
      setBusinesses(newBus);
    }
  };

  const buyUpgrade = (id) => {
    const idx = upgrades.findIndex(u => u.id === id);
    const upgrade = upgrades[idx];
    const cost = getUpgradeCost(upgrade);

    if (money >= cost && upgrade.level < upgrade.maxLevel) {
      setMoney(prev => prev - cost);
      const newUps = [...upgrades];
      newUps[idx].level += 1;
      setUpgrades(newUps);
    }
  };

  const buyInvestment = (id) => {
    const idx = investments.findIndex(i => i.id === id);
    const item = investments[idx];
    
    let amountToBuy = 0;
    if (tradeAmount === 'MAX') {
      amountToBuy = Math.floor(money / item.price);
    } else {
      amountToBuy = tradeAmount;
    }

    if (amountToBuy <= 0) return;

    const cost = item.price * amountToBuy;

    if (money >= cost) {
      setMoney(prev => prev - cost);
      setInvestments(prev => {
        const newInv = [...prev];
        const totalValue = (newInv[idx].avgPrice * newInv[idx].owned) + cost;
        const totalCount = newInv[idx].owned + amountToBuy;
        newInv[idx].owned = totalCount;
        newInv[idx].avgPrice = totalValue / totalCount;
        return newInv;
      });
    }
  };

  const sellInvestment = (id) => {
    const idx = investments.findIndex(i => i.id === id);
    const item = investments[idx];

    let amountToSell = 0;
    if (tradeAmount === 'MAX') {
      amountToSell = item.owned;
    } else {
      amountToSell = Math.min(item.owned, tradeAmount);
    }

    if (amountToSell <= 0) return;

    const revenue = item.price * amountToSell;
    setMoney(prev => prev + revenue);
    setInvestments(prev => {
      const newInv = [...prev];
      newInv[idx].owned -= amountToSell;
      if (newInv[idx].owned === 0) newInv[idx].avgPrice = 0;
      return newInv;
    });
  };

  const getProgressColor = () => {
    if (marketStatus.id === 'bull') return 'bg-green-500';
    if (marketStatus.id === 'bear') return 'bg-red-500';
    return 'bg-blue-500';
  };

  const getUpgradeDesc = (upgrade) => {
    let val, curr;
    if (upgrade.type === 'click') {
      val = 100; curr = upgrade.getEffect(upgrade.level);
    } else if (upgrade.type === 'business') {
      val = 20; curr = Math.round((upgrade.getEffect(upgrade.level) - 1) * 100);
    } else if (upgrade.type === 'dividend') {
      val = 0.2; curr = (upgrade.getEffect(upgrade.level) * 100).toFixed(1);
    } else if (upgrade.type === 'market') {
      val = 0.5; curr = upgrade.getEffect(upgrade.level).toFixed(1);
    } else if (upgrade.type === 'discount') {
      val = 5; curr = Math.round((1 - upgrade.getEffect(upgrade.level)) * 100);
    }
    return upgrade.descTemplate.replace('{val}', val).replace('{curr}', curr);
  };

  return (
    <div className="min-h-screen bg-slate-900 text-slate-100 font-sans selection:bg-indigo-500 selection:text-white p-4 md:p-8 flex flex-col md:flex-row gap-6">
      
      {/* ì™¼ìª½ íŒ¨ë„ */}
      <div className="w-full md:w-[400px] flex flex-col gap-6 shrink-0">
        <div className="bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-700">
          <div className="flex items-center gap-3 mb-2">
            <Coins className="text-yellow-400 w-8 h-8" />
            <h1 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-200">
              ë¨¸ë‹ˆ íƒ€ì´ì¿¤
            </h1>
          </div>
          <div className="mt-4">
            <p className="text-slate-400 text-sm">ë³´ìœ  í˜„ê¸ˆ</p>
            <p className="text-4xl font-mono font-bold text-white mt-1 break-all">
              â‚© {formatMoney(money)}
            </p>
          </div>
          <div className="mt-4 flex items-center gap-2 text-emerald-400 bg-emerald-400/10 w-fit px-3 py-1 rounded-full">
            <TrendingUp size={18} />
            <span className="font-bold">+{formatMoney(calculateIncomePerSecond())} / ì´ˆ (í†µí•©)</span>
          </div>
        </div>

        {/* ì‹œì¥ í˜„í™© */}
        <div className="bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-700 relative overflow-hidden">
          <div className="flex justify-between items-center mb-2 relative z-10">
            <h2 className="text-lg font-semibold flex items-center gap-2">
              <Activity size={20} /> ì‹œì¥ ê²½ì œ ë‰´ìŠ¤
            </h2>
            <span className="text-xs text-slate-400">{timeLeftForEvent}ì´ˆ í›„ ë³€ë™</span>
          </div>
          <div className="relative z-10">
            <p className={`text-xl font-bold ${marketStatus.color}`}>
              {marketStatus.name}
            </p>
            <div className="flex items-center gap-2 text-sm text-slate-400 mt-1">
              <span>{marketStatus.desc}</span>
              {marketStatus.id === 'bull' && (
                <span className="text-green-400 font-bold bg-green-400/10 px-2 rounded">
                  x{upgrades.find(u => u.type === 'market').getEffect(upgrades.find(u => u.type === 'market').level).toFixed(1)} íš¨ê³¼
                </span>
              )}
            </div>
          </div>
          <div className="absolute bottom-0 left-0 h-1 w-full bg-slate-700">
            <div 
              className={`h-full transition-all duration-1000 ease-linear ${getProgressColor()}`} 
              style={{ width: `${(timeLeftForEvent / 30) * 100}%` }}
            />
          </div>
        </div>

        {/* ë…¸ë™ ë²„íŠ¼ */}
        <div className="flex-1 bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-700 flex flex-col items-center justify-center min-h-[200px] relative overflow-hidden group">
          <button 
            onClick={handleManualClick}
            className="relative z-10 bg-indigo-600 hover:bg-indigo-500 active:scale-95 transition-all w-48 h-48 rounded-full shadow-[0_0_40px_rgba(79,70,229,0.3)] flex flex-col items-center justify-center gap-2 group-hover:shadow-[0_0_60px_rgba(79,70,229,0.5)] border-4 border-indigo-400/30"
          >
            <MousePointer2 size={48} className="text-white mb-2" />
            <span className="font-bold text-lg">ë…¸ë™í•˜ê¸°</span>
          </button>
          <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/20 to-transparent pointer-events-none"></div>
          <p className="mt-6 text-slate-400 text-sm text-center">
            í´ë¦­í•˜ì—¬ ì‹œë“œë¨¸ë‹ˆë¥¼ ëª¨ìœ¼ì„¸ìš”.
          </p>
        </div>
      </div>

      {/* ì˜¤ë¥¸ìª½ íŒ¨ë„ */}
      <div className="flex-1 bg-slate-800 rounded-2xl shadow-lg border border-slate-700 flex flex-col overflow-hidden min-h-[600px]">
        {/* íƒ­ í—¤ë” */}
        <div className="flex border-b border-slate-700">
          <button 
            onClick={() => setActiveTab('business')}
            className={`flex-1 py-4 font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'business' ? 'bg-slate-700 text-white' : 'text-slate-400 hover:bg-slate-750'}`}
          >
            <Briefcase size={18} /> ì‚¬ì—… ìš´ì˜
          </button>
          <button 
            onClick={() => setActiveTab('investment')}
            className={`flex-1 py-4 font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'investment' ? 'bg-slate-700 text-white' : 'text-slate-400 hover:bg-slate-750'}`}
          >
            <LineChart size={18} /> íˆ¬ì ê±°ë˜ì†Œ
          </button>
          <button 
            onClick={() => setActiveTab('upgrade')}
            className={`flex-1 py-4 font-bold flex items-center justify-center gap-2 transition-colors ${activeTab === 'upgrade' ? 'bg-slate-700 text-white' : 'text-slate-400 hover:bg-slate-750'}`}
          >
            <Microscope size={18} /> ì—°êµ¬ì†Œ
          </button>
        </div>

        {/* íƒ­ ì»¨í…ì¸  */}
        <div className="flex-1 p-6 overflow-y-auto custom-scrollbar bg-slate-800">
          
          {/* 1. ì‚¬ì—… íƒ­ */}
          {activeTab === 'business' && (
            <div className="space-y-3">
              <h3 className="text-lg font-bold text-slate-300 mb-4">ìë™ ìˆ˜ìµì› ë§¤ì…</h3>
              {businesses.map((biz) => {
                const currentCost = calculateCost(biz.baseCost, biz.count);
                const canAfford = money >= currentCost;
                return (
                  <button
                    key={biz.id}
                    onClick={() => buyBusiness(biz.id)}
                    disabled={!canAfford}
                    className={`w-full flex items-center justify-between p-4 rounded-xl border transition-all ${
                      canAfford 
                        ? 'bg-slate-700 border-slate-600 hover:bg-slate-650' 
                        : 'bg-slate-800/50 border-slate-700 opacity-60 cursor-not-allowed'
                    }`}
                  >
                    <div className="flex items-center gap-4 text-left">
                      <div className={`p-3 rounded-lg ${canAfford ? 'bg-blue-500/20 text-blue-400' : 'bg-slate-600/20 text-slate-500'}`}>
                        {biz.icon === 'store' && <Building2 size={24} />}
                        {biz.icon === 'shop' && <Briefcase size={24} />}
                        {biz.icon === 'chart' && <TrendingUp size={24} />}
                        {biz.icon === 'building' && <Landmark size={24} />}
                        {biz.icon === 'scooter' && <Briefcase size={24} />}
                        {biz.icon === 'rocket' && <Zap size={24} />}
                        {biz.icon === 'bank' && <Coins size={24} />}
                        {biz.icon === 'zap' && <Zap size={24} />}
                        {biz.icon === 'space' && <Rocket size={24} />}
                        {biz.icon === 'mars' && <Globe size={24} />}
                      </div>
                      <div>
                        <h3 className="font-bold text-slate-200">{biz.name}</h3>
                        <div className="text-xs text-slate-400">ë³´ìœ : <span className="text-white">{biz.count}</span></div>
                        <div className="text-xs text-emerald-400">+{formatMoney(biz.baseIncome)}/ì´ˆ</div>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className={`font-mono font-bold ${canAfford ? 'text-yellow-400' : 'text-slate-500'}`}>
                        â‚© {formatMoney(currentCost)}
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          )}

          {/* 2. íˆ¬ì íƒ­ */}
          {activeTab === 'investment' && (
            <div className="space-y-4">
              <div className="bg-slate-700/50 p-2 rounded-lg border border-slate-600 flex items-center justify-between gap-2">
                <span className="text-sm text-slate-300 font-bold px-2 flex items-center gap-2">
                  <Calculator size={16} /> ê±°ë˜ ìˆ˜ëŸ‰
                </span>
                <div className="flex gap-1 flex-1 justify-end">
                  {[1, 10, 100, 'MAX'].map((amt) => (
                    <button
                      key={amt}
                      onClick={() => setTradeAmount(amt)}
                      className={`px-3 py-1.5 rounded-md text-sm font-bold transition-all ${
                        tradeAmount === amt 
                        ? 'bg-indigo-500 text-white shadow-lg scale-105' 
                        : 'bg-slate-600 text-slate-400 hover:bg-slate-500'
                      }`}
                    >
                      {amt === 'MAX' ? 'MAX' : `x${amt}`}
                    </button>
                  ))}
                </div>
              </div>

              <div className="bg-slate-700/50 p-4 rounded-lg border border-slate-600 text-sm text-slate-300">
                <p>ğŸ’¡ <strong>íˆ¬ì íŒ:</strong> ë°°ë‹¬ì•±, ì—ë„ˆì§€ ë“± ìƒˆë¡œìš´ ì‚¬ì—…ìœ¼ë¡œ ëˆì„ ë²Œê³  <strong>NFT, ë°”ì´ì˜¤ ì£¼ì‹</strong> ë“± ë‹¤ì–‘í•œ ìì‚°ì— íˆ¬ìí•´ë³´ì„¸ìš”.</p>
              </div>

              {investments.map((item) => {
                let profitRate = 0;
                let profitColor = 'text-slate-400';
                if (item.owned > 0) {
                  profitRate = ((item.price - item.avgPrice) / item.avgPrice) * 100;
                  if (profitRate > 0) profitColor = 'text-red-400';
                  else if (profitRate < 0) profitColor = 'text-blue-400';
                }

                const isPriceUp = item.history[item.history.length - 1] > item.history[item.history.length - 2];

                let buyCostDisplay = 0;
                let sellCountDisplay = 0;
                let canBuy = false;
                let canSell = false;

                if (tradeAmount === 'MAX') {
                  const maxCanBuy = Math.floor(money / item.price);
                  buyCostDisplay = maxCanBuy * item.price;
                  canBuy = maxCanBuy > 0;
                  sellCountDisplay = item.owned;
                  canSell = item.owned > 0;
                } else {
                  buyCostDisplay = item.price * tradeAmount;
                  canBuy = money >= buyCostDisplay;
                  sellCountDisplay = Math.min(item.owned, tradeAmount);
                  canSell = sellCountDisplay > 0;
                }

                return (
                  <div key={item.id} className="bg-slate-700 rounded-xl p-5 border border-slate-600 shadow-md">
                    <div className="flex justify-between items-start mb-4">
                      <div className="flex items-center gap-3">
                        <div className={`p-2 rounded-lg ${item.type === 'high_risk' ? 'bg-orange-500/20 text-orange-400' : item.type === 'low_risk' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'}`}>
                          {item.id === 'coin' && <Coins size={24} />}
                          {item.id === 'nft' && <Gem size={24} />}
                          {item.id === 'bio_stock' && <Activity size={24} />}
                          {item.id === 'stock' && <TrendingUp size={24} />}
                          {item.id === 'gold' && <Wallet size={24} />}
                          {item.id === 'real_estate' && <Building2 size={24} />}
                        </div>
                        <div>
                          <h3 className="font-bold text-lg text-slate-100">{item.name}</h3>
                          <p className="text-xs text-slate-400">{item.desc}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className={`text-2xl font-mono font-bold flex items-center justify-end gap-2 ${isPriceUp ? 'text-red-400' : 'text-blue-400'}`}>
                           {isPriceUp ? <TrendingUp size={20} /> : <TrendingDown size={20} />}
                           â‚© {formatMoney(item.price)}
                        </div>
                        <div className="text-xs text-slate-400 mt-1">
                          í˜„ì¬ê°€ (ì‹¤ì‹œê°„)
                        </div>
                      </div>
                    </div>

                    <div className="bg-slate-800/80 rounded-lg p-3 mb-4 flex justify-between items-center text-sm">
                      <div>
                        <span className="text-slate-400">ë³´ìœ ëŸ‰: </span>
                        <span className="text-white font-bold ml-1">{formatMoney(item.owned)} ì£¼/ê°œ</span>
                      </div>
                      <div>
                         <span className="text-slate-400">í‰ë‹¨ê°€: </span>
                         <span className="text-slate-200 ml-1">â‚© {formatMoney(item.avgPrice)}</span>
                      </div>
                      <div>
                         <span className="text-slate-400">ìˆ˜ìµë¥ : </span>
                         <span className={`font-bold ml-1 ${profitColor}`}>{profitRate.toFixed(2)}%</span>
                      </div>
                    </div>

                    <div className="flex gap-2">
                      <button 
                        onClick={() => buyInvestment(item.id)}
                        className={`flex-1 py-3 rounded-lg font-bold text-sm transition-colors flex flex-col items-center justify-center gap-0.5 ${canBuy ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/50' : 'bg-slate-600 text-slate-400 cursor-not-allowed'}`}
                        disabled={!canBuy}
                      >
                        <span>{tradeAmount === 'MAX' ? 'ìµœëŒ€ ë§¤ìˆ˜' : `ë§¤ìˆ˜ (${tradeAmount}ê°œ)`}</span>
                        <span className="text-xs font-mono opacity-80">
                           -{formatMoney(buyCostDisplay)}
                        </span>
                      </button>
                      <button 
                        onClick={() => sellInvestment(item.id)}
                        className={`flex-1 py-3 rounded-lg font-bold text-sm transition-colors flex flex-col items-center justify-center gap-0.5 ${canSell ? 'bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 border border-blue-500/50' : 'bg-slate-600 text-slate-400 cursor-not-allowed'}`}
                        disabled={!canSell}
                      >
                        <span>{tradeAmount === 'MAX' ? 'ì „ëŸ‰ ë§¤ë„' : `ë§¤ë„ (${tradeAmount}ê°œ)`}</span>
                        <span className="text-xs font-mono opacity-80">
                           +{formatMoney(item.price * sellCountDisplay)}
                        </span>
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* 3. ì—°êµ¬ íƒ­ */}
          {activeTab === 'upgrade' && (
            <div className="space-y-3">
              <h3 className="text-lg font-bold text-slate-300 mb-4">ê²½ì œí•™ ì—°êµ¬ì†Œ</h3>
              {upgrades.map((upgrade) => {
                const currentCost = getUpgradeCost(upgrade);
                const isMaxed = upgrade.level >= upgrade.maxLevel;
                const canBuy = !isMaxed && money >= currentCost;

                return (
                  <button
                    key={upgrade.id}
                    onClick={() => buyUpgrade(upgrade.id)}
                    disabled={!canBuy}
                    className={`w-full flex items-center justify-between p-3 rounded-xl border transition-all ${
                      isMaxed
                        ? 'bg-green-900/10 border-green-800 opacity-80'
                        : canBuy
                        ? 'bg-slate-700 border-slate-600 hover:bg-slate-650'
                        : 'bg-slate-800/50 border-slate-700 opacity-60'
                    }`}
                  >
                    <div className="flex items-center gap-3 text-left">
                      <div className={`p-2 rounded-lg ${isMaxed ? 'bg-green-500/20 text-green-400' : 'bg-purple-500/20 text-purple-400'}`}>
                         {isMaxed ? <Trophy size={20} /> : <Microscope size={20} />}
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <h3 className={`font-bold text-sm ${isMaxed ? 'text-green-400' : 'text-slate-200'}`}>
                            {upgrade.name}
                          </h3>
                          <span className="text-xs px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">
                            Lv.{upgrade.level} / {upgrade.maxLevel}
                          </span>
                        </div>
                        <p className="text-xs text-slate-400 mt-1">
                          {getUpgradeDesc(upgrade)}
                        </p>
                      </div>
                    </div>
                    <div className="text-right min-w-[80px]">
                      {isMaxed ? (
                        <span className="text-xs font-bold text-green-500">ì—°êµ¬ ì™„ë£Œ</span>
                      ) : (
                        <span className={`text-sm font-mono font-bold ${canBuy ? 'text-yellow-400' : 'text-slate-500'}`}>
                          â‚© {formatMoney(currentCost)}
                        </span>
                      )}
                    </div>
                  </button>
                );
              })}
            </div>
          )}
        </div>
      </div>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: rgba(30, 41, 59, 0.5);
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(71, 85, 105, 0.8);
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: rgba(100, 116, 139, 1);
        }
      `}</style>
    </div>
  );
}
