<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunar Lander: Director's Cut</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0; padding: 0; background-color: #000; color: white;
            width: 100vw; height: 100vh; overflow: hidden;
            font-family: 'Courier New', monospace;
            user-select: none; -webkit-user-select: none; touch-action: none;
        }

        canvas { display: block; width: 100%; height: 100%; }

        #danger-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 50px red; opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 50;
        }

        #ui-layer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 800px; height: 600px; pointer-events: none; transform-origin: center;
        }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100; display: none; pointer-events: auto;
        }

        .modal-box {
            background: #1a1a1a; border: 2px solid #fff; padding: 25px;
            width: 90%; max-width: 500px; text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.1);
        }

        .modal-title {
            font-family: 'Press Start 2P', cursive; color: #ffff00;
            font-size: 1.4rem; margin-bottom: 25px; line-height: 1.4; text-shadow: 2px 2px 0 #000;
        }

        .modal-text {
            font-size: 14px; line-height: 1.6; color: #ccc; margin-bottom: 25px; white-space: pre-line;
        }

        .btn {
            background: #333; color: white; border: 2px solid #fff; padding: 12px 20px;
            font-family: 'Press Start 2P', cursive; font-size: 12px; cursor: pointer;
            margin: 8px; box-shadow: 4px 4px 0 #000; touch-action: manipulation;
            transition: transform 0.1s;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }
        .btn-green { background: #1a5c1a; border-color: #4f4; color: #4f4; }
        .btn-red { background: #661a1a; border-color: #f44; color: #f44; }
        .btn-gold { background: #665200; border-color: #fd0; color: #fd0; }

        #fullscreen-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.5); color: white;
            padding: 8px; border-radius: 4px; cursor: pointer; z-index: 200; pointer-events: auto;
            display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;
        }

        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; align-items: flex-start;
            font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px black;
        }
        .hud-group { display: flex; flex-direction: column; gap: 5px; }
        .hud-right { text-align: right; }
        .hud-center { display: flex; gap: 10px; }

        .icon-btn {
            pointer-events: auto; cursor: pointer; width: 36px; height: 36px;
            border: 2px solid white; background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center; transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .icon-btn svg { fill: white; }

        #fuel-wrapper {
            width: 120px; height: 10px; border: 1px solid #fff; background: rgba(0,0,0,0.5);
            margin-top: 2px; position: relative;
        }
        #fuel-bar { height: 100%; background: #0f0; width: 100%; transition: width 0.1s; }
        
        #credits-display {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            font-family: 'Press Start 2P', cursive; font-size: 12px; color: #ffd700;
            text-shadow: 2px 2px 0 #000;
        }

        /* Í≤©ÎÇ©Í≥† Ïä§ÌÉÄÏùº */
        .shop-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .shop-tab { 
            flex: 1; padding: 10px; background: #222; border: 1px solid #555; color: #888; 
            font-family: 'Press Start 2P'; font-size: 10px; cursor: pointer; transition: 0.2s;
        }
        .shop-tab:hover { background: #333; }
        .shop-tab.active { background: #444; color: #fff; border-color: #fff; border-bottom: none; }

        .ship-card, .upgrade-card, .item-card {
            border: 1px solid #444; background: #222; padding: 15px; margin: 10px 0;
            display: flex; flex-direction: column; gap: 8px;
            cursor: pointer; transition: background 0.2s; position: relative;
        }
        .ship-card:hover, .upgrade-card:hover, .item-card:hover { background: #333; }
        .ship-card.selected { border: 2px solid #0f0; background: #1a331a; }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .card-name { font-weight: bold; color: #fff; font-size: 12px; font-family: 'Press Start 2P'; }
        .card-cost { font-family: 'Press Start 2P'; font-size: 10px; color: #fd0; }
        .card-desc { font-size: 10px; color: #888; text-align: left; }
        .card-level { font-size: 10px; color: #0af; text-align: left; margin-top: 5px; }
        
        .stat-row { display: flex; align-items: center; gap: 10px; font-size: 10px; color: #aaa; }
        .stat-label { width: 60px; text-align: right; }
        .stat-bar-bg { flex: 1; height: 6px; background: #444; border-radius: 3px; overflow: hidden; }
        .stat-bar-fill { height: 100%; background: #0af; }

        #mobile-controls {
            position: fixed; bottom: 20px; left: 0; width: 100%; height: 140px;
            pointer-events: none; display: none; z-index: 90; padding: 0 20px; box-sizing: border-box;
        }
        .touch-pad { position: absolute; bottom: 10px; pointer-events: auto; display: flex; gap: 20px; }
        .touch-pad.left { left: 30px; } .touch-pad.right { right: 30px; }
        .control-btn {
            width: 70px; height: 70px; background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 50%;
            color: rgba(255, 255, 255, 0.8); font-size: 28px;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .control-btn.active { background: rgba(255, 255, 255, 0.5); transform: scale(0.95); }
        .btn-thrust { width: 90px; height: 90px; border-color: rgba(255, 80, 80, 0.5); background: rgba(255, 50, 50, 0.2); }
        .btn-thrust.active { background: rgba(255, 50, 50, 0.6); }

        #level-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 15px 0; justify-content: center; }
        .level-btn {
            aspect-ratio: 1; background: #333; border: 1px solid #666; color: #fff;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 16px;
        }
        .level-btn.cleared { border-color: #0f0; color: #0f0; }
        .level-btn.locked { background: #111; color: #444; cursor: default; }

        #pagination-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 10px; }
        .page-btn { background: none; border: none; color: white; font-size: 24px; padding: 10px; cursor: pointer; }

        .lang-btn {
            padding: 5px 10px; font-size: 10px; cursor: pointer; background: #444; color: #fff; border: 1px solid #888;
        }
        .lang-btn.active { background: #0f0; color: #000; border-color: #0f0; }

        .safe { color: #0f0; } .warn { color: #ff0; } .danger { color: #f00; }

        @media (max-width: 600px) {
            #ui-layer { width: 100%; height: 100%; }
            .modal-box { padding: 15px; width: 95%; }
            .control-btn { width: 60px; height: 60px; font-size: 20px; }
            .btn-thrust { width: 80px; height: 80px; }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>
    <div id="danger-overlay"></div>

    <button id="fullscreen-btn" onclick="toggleFullScreen()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
    </button>

    <div id="ui-layer">
        <div id="hud">
            <div class="hud-group">
                <div><span id="ui-lv-label">LV</span>.<span id="ui-level" style="color:#0f0">1</span> <span id="ui-planet" style="color:#aaa">MOON</span></div>
                <div><div style="font-size:10px; color:#ccc; margin-bottom:2px;"><span id="ui-fuel-label">FUEL</span> <span id="ui-fuel">100</span></div><div id="fuel-wrapper"><div id="fuel-bar"></div></div></div>
            </div>
            
            <div class="hud-center">
                <div class="icon-btn" id="sound-btn" onclick="toggleSound()"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></div>
                <div class="icon-btn" id="pause-btn" onclick="togglePause()"><svg width="14" height="14" viewBox="0 0 14 14"><rect x="2" y="1" width="4" height="12"/><rect x="8" y="1" width="4" height="12"/></svg></div>
                <div class="icon-btn" onclick="openSettings()">‚öôÔ∏è</div>
            </div>

            <div class="hud-group hud-right">
                <div><span id="ui-score-label">SCORE</span> <span id="ui-score" style="color:#fd0">0</span></div>
                <div style="font-size:10px; color:#888;">HI <span id="ui-highscore">0</span></div>
                <div>ALT <span id="ui-alt">0</span></div>
                <div>V.SPD <span id="ui-vspeed">0</span></div>
                <div>H.SPD <span id="ui-hspeed">0</span></div>
                <div>WIND <span id="ui-wind">0</span></div>
            </div>
        </div>
        <div id="countdown-overlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-family:'Press Start 2P'; font-size:60px; color:white; display:none;">3</div>
    </div>

    <div id="mobile-controls">
        <div class="touch-pad left">
            <div class="control-btn" id="btn-left">‚óÄ</div>
            <div class="control-btn" id="btn-right">‚ñ∂</div>
        </div>
        <div class="touch-pad right">
            <div class="control-btn btn-thrust" id="btn-thrust">üî•</div>
        </div>
    </div>

    <!-- Î©îÎâ¥ ÌôîÎ©¥ -->
    <div id="screen-level-select" class="modal" style="display: flex;">
        <div class="modal-box">
            <div class="modal-title" id="txt-mission-control">MISSION CONTROL</div>
            <div style="color:#fd0; font-family:'Press Start 2P'; font-size:12px; margin-bottom:15px;">CREDITS: <span id="menu-credits">0</span></div>
            
            <button class="btn btn-gold" id="btn-hangar" onclick="openHangar()">üöÄ HANGAR</button>
            <button class="btn" id="btn-settings" onclick="openSettings()">‚öôÔ∏è SETTINGS</button>
            
            <div style="border-top:1px solid #444; margin:15px 0;"></div>
            
            <div id="page-theme-name" style="font-size:12px; color:#888; margin-bottom:5px;"></div>
            <div id="level-grid"></div>
            <div id="pagination-controls">
                <button class="page-btn" id="btn-prev" onclick="changeMenuPage(-1)">‚óÄ</button>
                <span id="page-indicator" style="font-size: 14px; color: #aaa;">P1</span>
                <button class="page-btn" id="btn-next" onclick="changeMenuPage(1)">‚ñ∂</button>
            </div>
        </div>
    </div>

    <!-- Í≤©ÎÇ©Í≥† (ÏÉÅÏ†ê) -->
    <div id="screen-hangar" class="modal">
        <div class="modal-box">
            <div class="modal-title" id="txt-hangar">HANGAR</div>
            <div style="color:#fd0; font-family:'Press Start 2P'; font-size:12px; margin-bottom:15px;">CREDITS: <span id="hangar-credits">0</span></div>
            
            <div class="shop-tabs">
                <div class="shop-tab active" onclick="switchShopTab('ships')" id="tab-ships">SHIPS</div>
                <div class="shop-tab" onclick="switchShopTab('upgrades')" id="tab-upgrades">UPGRADES</div>
                <div class="shop-tab" onclick="switchShopTab('items')" id="tab-items">ITEMS</div>
            </div>

            <div id="shop-content" style="max-height:300px; overflow-y:auto;">
                <!-- JSÎ°ú ÏÉùÏÑ±Îê® -->
            </div>
            <button class="btn btn-red" id="btn-back-hangar" onclick="closeHangar()" style="margin-top:20px;">BACK</button>
        </div>
    </div>

    <!-- ÏÑ§Ï†ï ÌôîÎ©¥ -->
    <div id="screen-settings" class="modal">
        <div class="modal-box">
            <div class="modal-title" id="txt-settings">SETTINGS</div>
            <div style="margin-bottom: 20px;">
                <div style="margin-bottom: 10px; color: #aaa;" id="txt-language">LANGUAGE</div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="lang-btn" onclick="setLanguage('ko')" id="lang-ko">ÌïúÍµ≠Ïñ¥</button>
                    <button class="lang-btn" onclick="setLanguage('en')" id="lang-en">ENGLISH</button>
                    <button class="lang-btn" onclick="setLanguage('ja')" id="lang-ja">Êó•Êú¨Ë™û</button>
                </div>
            </div>
            <button class="btn btn-red" id="btn-close-settings" onclick="closeSettings()">CLOSE</button>
        </div>
    </div>

    <div id="screen-tutorial" class="modal">
        <div class="modal-box">
            <div class="modal-title" id="tut-title">TUTORIAL</div>
            <div class="modal-text" id="tut-text">...</div>
            <button class="btn btn-green" id="btn-launch" onclick="closeTutorial()">LAUNCH</button>
        </div>
    </div>

    <div id="screen-pause" class="modal">
        <div class="modal-box">
            <div class="modal-title" id="txt-paused">PAUSED</div>
            <button class="btn" id="btn-resume" onclick="togglePause()">RESUME</button>
            <button class="btn" id="btn-retry" onclick="restartCurrentLevel()">RETRY</button>
            <button class="btn btn-red" id="btn-exit" onclick="goToLevelSelect()">EXIT</button>
        </div>
    </div>

    <div id="screen-result" class="modal">
        <div class="modal-box">
            <div class="modal-title" id="res-title">RESULT</div>
            <div class="modal-text" id="res-text">...</div>
            <div id="res-buttons"></div>
        </div>
    </div>

    <script>
        // --- TRANSLATIONS ---
        const TEXTS = {
            en: {
                mission_control: "MISSION CONTROL", hangar: "HANGAR", settings: "SETTINGS",
                back: "BACK", close: "CLOSE", launch: "LAUNCH", paused: "PAUSED",
                resume: "RESUME", retry: "RETRY", exit: "EXIT", language: "LANGUAGE",
                fuel: "FUEL", score: "SCORE", lv: "LV",
                next_mission: "NEXT MISSION", menu: "MENU",
                mission_success: "MISSION SUCCESS", mission_failed: "MISSION FAILED",
                crashed_terrain: "CRASHED INTO TERRAIN", hit_obstacle: "HIT OBSTACLE",
                landing_success: "LANDING SUCCESS", perfect: "PERFECT", good: "GOOD", hard: "HARD",
                too_fast: "TOO FAST", bad_angle: "BAD ANGLE", h_speed: "HORIZONTAL SPEED",
                all_completed: "ALL MISSIONS COMPLETED!",
                ship_equip: "EQUIP", ship_equipped: "EQUIPPED", ship_buy: "BUY", ship_select: "SELECT",
                stat_thrust: "THRUST", stat_fuel: "FUEL", stat_turn: "TURN",
                tab_ships: "SHIPS", tab_upgrades: "UPGRADES", tab_items: "ITEMS",
                upgrade_max: "MAX LEVEL", item_owned: "OWNED", buy: "BUY",
                upg_fuel_name: "FUEL TANK", upg_fuel_desc: "Max Fuel +10%",
                upg_eff_name: "EFFICIENT ENGINE", upg_eff_desc: "Fuel Consumption -10%",
                upg_land_name: "LANDING GEAR", upg_land_desc: "Safe Impact Speed +10%",
                item_fuel_name: "RESERVE TANK", item_fuel_desc: "Start with +50 Fuel",
                item_shield_name: "FORCE FIELD", item_shield_desc: "Ignore 1 Crash",
                ignition: "IGNITION",
                planet_moon: "THE MOON", planet_mars: "MARS", planet_earth: "EARTH", planet_ice: "ICE PLANET", planet_volcanic: "VOLCANIC",
                ship_std_name: "MK-1 STANDARD", ship_std_desc: "Balanced performance.",
                ship_scout_name: "MK-2 SCOUT", ship_scout_desc: "High agility, low fuel.",
                ship_heavy_name: "MK-3 HEAVY", ship_heavy_desc: "Huge fuel, slow turn.",
                ship_ufo_name: "ALIEN POD", ship_ufo_desc: "Superior technology.",
                tut_1_title: "FLIGHT SCHOOL", tut_1_text: "Use thrust to slow descent.\nKeep angle flat for landing.",
                tut_2_title: "FUEL CELLS", tut_2_text: "Collect yellow cells to\nrefuel and gain credits.",
                tut_5_title: "WIND WARNING", tut_5_text: "Strong winds detected.\nLean into the wind.",
                tut_11_title: "HOSTILES", tut_11_text: "Avoid red drones.\nThey will destroy you."
            },
            ko: {
                mission_control: "ÏûÑÎ¨¥ ÌÜµÏ†úÏã§", hangar: "Í≤©ÎÇ©Í≥† (ÏÉÅÏ†ê)", settings: "ÏÑ§Ï†ï",
                back: "Îí§Î°ú", close: "Îã´Í∏∞", launch: "Î∞úÏÇ¨", paused: "ÏùºÏãú Ï†ïÏßÄ",
                resume: "Í≥ÑÏÜçÌïòÍ∏∞", retry: "Ïû¨ÏãúÎèÑ", exit: "ÎÇòÍ∞ÄÍ∏∞", language: "Ïñ∏Ïñ¥ (LANGUAGE)",
                fuel: "Ïó∞Î£å", score: "Ï†êÏàò", lv: "Î†àÎ≤®",
                next_mission: "Îã§Ïùå ÏûÑÎ¨¥", menu: "Î©îÎâ¥",
                mission_success: "ÏûÑÎ¨¥ ÏÑ±Í≥µ", mission_failed: "ÏûÑÎ¨¥ Ïã§Ìå®",
                crashed_terrain: "ÏßÄÌòï Ï∂©Îèå!", hit_obstacle: "Ïû•Ïï†Î¨º Ï∂©Îèå!",
                landing_success: "Ï∞©Î•ô ÏÑ±Í≥µ", perfect: "ÏôÑÎ≤ΩÌï®", good: "Ï¢ãÏùå", hard: "Í±∞Ïπ®",
                too_fast: "ÏÜçÎèÑ Í≥ºÎã§", bad_angle: "Í∞ÅÎèÑ Î∂àÎüâ", h_speed: "ÏàòÌèâ ÏÜçÎèÑ Í≥ºÎã§",
                all_completed: "Î™®Îì† ÏûÑÎ¨¥ ÏôÑÏàò!",
                ship_equip: "Ïû•Ï∞©", ship_equipped: "Ïû•Ï∞©Îê®", ship_buy: "Íµ¨Îß§", ship_select: "ÏÑ†ÌÉù",
                stat_thrust: "Ï∂îÎ†•", stat_fuel: "Ïó∞Î£å", stat_turn: "ÌöåÏ†Ñ",
                tab_ships: "Í∏∞Ï≤¥", tab_upgrades: "ÏóÖÍ∑∏Î†àÏù¥Îìú", tab_items: "ÏïÑÏù¥ÌÖú",
                upgrade_max: "ÏµúÍ≥† Î†àÎ≤®", item_owned: "Î≥¥Ïú†Ï§ë", buy: "Íµ¨Îß§",
                upg_fuel_name: "Ïó∞Î£å ÌÉ±ÌÅ¨", upg_fuel_desc: "ÏµúÎåÄ Ïó∞Î£å +10%",
                upg_eff_name: "Í≥†Ìö®Ïú® ÏóîÏßÑ", upg_eff_desc: "Ïó∞Î£å ÏÜåÎ™® -10%",
                upg_land_name: "ÎûúÎî© Í∏∞Ïñ¥", upg_land_desc: "Ï∂©Í≤© Ìù°Ïàò +10%",
                item_fuel_name: "ÎπÑÏÉÅ Ïó∞Î£åÌÜµ", item_fuel_desc: "ÏãúÏûë Ïãú Ïó∞Î£å +50",
                item_shield_name: "Ìè¨Ïä§ ÌïÑÎìú", item_shield_desc: "1Ìöå Ï∂©Îèå Î∞©ÏßÄ",
                ignition: "Î∞úÏÇ¨!",
                planet_moon: "Îã¨", planet_mars: "ÌôîÏÑ±", planet_earth: "ÏßÄÍµ¨", planet_ice: "ÏñºÏùå ÌñâÏÑ±", planet_volcanic: "Ïö©Ïïî ÌñâÏÑ±",
                ship_std_name: "MK-1 ÌëúÏ§ÄÌòï", ship_std_desc: "Í∑†Ìòï Ïû°Ìûå ÏÑ±Îä•",
                ship_scout_name: "MK-2 Ï†ïÏ∞∞Í∏∞", ship_scout_desc: "Í≥†Í∏∞Îèô, Ï†ÄÏó∞Î£å",
                ship_heavy_name: "MK-3 ÏàòÏÜ°Í∏∞", ship_heavy_desc: "ÎåÄÏö©Îüâ Ïó∞Î£å, ÎëîÌï®",
                ship_ufo_name: "ÏóêÏùºÎ¶¨Ïñ∏ Ìè¨Îìú", ship_ufo_desc: "Ïö∞ÏõîÌïú Ïô∏Í≥Ñ Í∏∞Ïà†",
                tut_1_title: "ÎπÑÌñâ ÌõàÎ†®", tut_1_text: "Ï∂îÎ†•ÏúºÎ°ú ÌïòÍ∞ï ÏÜçÎèÑÎ•º Ï§ÑÏù¥ÏÑ∏Ïöî.\nÏ∞©Î•ô Ïãú ÏàòÌèâÏùÑ Ïú†ÏßÄÌïòÏÑ∏Ïöî.",
                tut_2_title: "Ïó∞Î£å Ï†ÑÏßÄ", tut_2_text: "ÎÖ∏ÎûÄ Ïó∞Î£åÌÜµÏùÑ ÌöçÎìùÌïòÎ©¥\nÏó∞Î£åÏôÄ ÌÅ¨Î†àÎîßÏùÑ ÏñªÏäµÎãàÎã§.",
                tut_5_title: "Í∞ïÌíç Í≤ΩÎ≥¥", tut_5_text: "Í∞ïÌïú Î∞îÎûåÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§.\nÎ∞îÎûå Î∞òÎåÄ Î∞©Ìñ•ÏúºÎ°ú Í∏∞Ïö∏Ïù¥ÏÑ∏Ïöî.",
                tut_11_title: "Ï†ÅÎåÄÏ†Å ÎåÄÏÉÅ", tut_11_text: "Î∂âÏùÄ ÎìúÎ°†ÏùÑ ÌîºÌïòÏÑ∏Ïöî.\nÎ∂ÄÎî™ÌûàÎ©¥ ÌååÍ¥¥Îê©ÎãàÎã§."
            },
            ja: {
                mission_control: "„Éü„ÉÉ„Ç∑„Éß„É≥ÁÆ°ÁêÜ", hangar: "Ê†ºÁ¥çÂ∫´ („Ç∑„Éß„ÉÉ„Éó)", settings: "Ë®≠ÂÆö",
                back: "Êàª„Çã", close: "Èñâ„Åò„Çã", launch: "Áô∫Â∞Ñ", paused: "‰∏ÄÊôÇÂÅúÊ≠¢",
                resume: "ÂÜçÈñã", retry: "„É™„Éà„É©„Ç§", exit: "ÁµÇ‰∫Ü", language: "Ë®ÄË™û (LANGUAGE)",
                fuel: "ÁáÉÊñô", score: "„Çπ„Ç≥„Ç¢", lv: "LV",
                next_mission: "Ê¨°„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥", menu: "„É°„Éã„É•„Éº",
                mission_success: "„Éü„ÉÉ„Ç∑„Éß„É≥ÊàêÂäü", mission_failed: "„Éü„ÉÉ„Ç∑„Éß„É≥Â§±Êïó",
                crashed_terrain: "Âú∞ÂΩ¢„Å´Ë°ùÁ™Å!", hit_obstacle: "ÈöúÂÆ≥Áâ©„Å´Ë°ùÁ™Å!",
                landing_success: "ÁùÄÈô∏ÊàêÂäü", perfect: "ÂÆåÁíß", good: "ËâØÂ•Ω", hard: "ÁùÄÂú∞Ë°ùÊíÉ",
                too_fast: "ÈÄüÂ∫¶Ë∂ÖÈÅé", bad_angle: "ËßíÂ∫¶‰∏çËâØ", h_speed: "Ê∞¥Âπ≥ÈÄüÂ∫¶Ë∂ÖÈÅé",
                all_completed: "ÂÖ®„Éü„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü!",
                ship_equip: "Ë£ÖÂÇô", ship_equipped: "Ë£ÖÂÇô‰∏≠", ship_buy: "Ë≥ºÂÖ•", ship_select: "ÈÅ∏Êäû",
                stat_thrust: "Êé®Âäõ", stat_fuel: "ÁáÉÊñô", stat_turn: "ÂõûËª¢",
                tab_ships: "Ê©ü‰Ωì", tab_upgrades: "Âº∑Âåñ", tab_items: "„Ç¢„Ç§„ÉÜ„É†",
                upgrade_max: "ÊúÄÂ§ß„É¨„Éô„É´", item_owned: "ÊâÄÊåÅÊ∏à„Åø", buy: "Ë≥ºÂÖ•",
                upg_fuel_name: "ÁáÉÊñô„Çø„É≥„ÇØ", upg_fuel_desc: "ÊúÄÂ§ßÁáÉÊñô +10%",
                upg_eff_name: "È´òÂäπÁéá„Ç®„É≥„Ç∏„É≥", upg_eff_desc: "ÁáÉÊñôÊ∂àË≤ª -10%",
                upg_land_name: "„É©„É≥„Éá„Ç£„É≥„Ç∞„ÇÆ„Ç¢", upg_land_desc: "Ë°ùÊíÉÂê∏Âèé +10%",
                item_fuel_name: "‰∫àÂÇô„Çø„É≥„ÇØ", item_fuel_desc: "ÈñãÂßãÊôÇÁáÉÊñô +50",
                item_shield_name: "„Éï„Ç©„Éº„Çπ„Éï„Ç£„Éº„É´„Éâ", item_shield_desc: "1ÂõûË°ùÁ™ÅÁÑ°Âäπ",
                ignition: "Áô∫Â∞Ñ!",
                planet_moon: "Êúà", planet_mars: "ÁÅ´Êòü", planet_earth: "Âú∞ÁêÉ", planet_ice: "Ê∞∑„ÅÆÊÉëÊòü", planet_volcanic: "ÁÅ´Â±±ÊÉëÊòü",
                ship_std_name: "MK-1 Ê®ôÊ∫ñÂûã", ship_std_desc: "„Éê„É©„É≥„ÇπÂûã",
                ship_scout_name: "MK-2 ÂÅµÂØüÊ©ü", ship_scout_desc: "È´òÊ©üÂãï„ÄÅ‰ΩéÁáÉË≤ª",
                ship_heavy_name: "MK-3 Ëº∏ÈÄÅÊ©ü", ship_heavy_desc: "Â§ßÂÆπÈáèÁáÉÊñô„ÄÅÈàçÈáç",
                ship_ufo_name: "„Ç®„Ç§„É™„Ç¢„É≥„Éù„ÉÉ„Éâ", ship_ufo_desc: "ÂÑ™„Çå„Åü„Ç®„Ç§„É™„Ç¢„É≥ÊäÄË°ì",
                tut_1_title: "È£õË°åË®ìÁ∑¥", tut_1_text: "Êé®Âäõ„ÅßÈôç‰∏ãÈÄüÂ∫¶„ÇíËêΩ„Å®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nÁùÄÈô∏ÊôÇ„ÅØÊ∞¥Âπ≥„Çí‰øù„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                tut_2_title: "ÁáÉÊñôÈõªÊ±†", tut_2_text: "ÈªÑËâ≤„ÅÑÁáÉÊñô„Çø„É≥„ÇØ„ÇíÈõÜ„ÇÅ„Çã„Å®\nÁáÉÊñô„Å®„ÇØ„É¨„Ç∏„ÉÉ„Éà„ÇíÁç≤Âæó„Åó„Åæ„Åô„ÄÇ",
                tut_5_title: "Âº∑È¢®Ë≠¶Â†±", tut_5_text: "Âº∑È¢®„ÇíÊ§úÁü•„Åó„Åæ„Åó„Åü„ÄÇ\nÈ¢®„Å´ÈÄÜ„Çâ„Å£„Å¶ÂÇæ„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                tut_11_title: "ÊïµÂØæÁöÑÂ≠òÂú®", tut_11_text: "Ëµ§„ÅÑ„Éâ„É≠„Éº„É≥„ÇíÈÅø„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nË°ùÁ™Å„Åô„Çã„Å®Á†¥Â£ä„Åï„Çå„Åæ„Åô„ÄÇ"
            }
        };

        let currentLang = localStorage.getItem('lunar_lang') || 'ko';

        function t(key) {
            return TEXTS[currentLang][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lunar_lang', lang);
            updateTexts();
            updateMenuUI();
        }

        function updateTexts() {
            document.getElementById('txt-mission-control').innerText = t('mission_control');
            document.getElementById('btn-hangar').innerText = "üöÄ " + t('hangar');
            document.getElementById('btn-settings').innerText = "‚öôÔ∏è " + t('settings');
            document.getElementById('txt-hangar').innerText = t('hangar');
            document.getElementById('btn-back-hangar').innerText = t('back');
            document.getElementById('txt-settings').innerText = t('settings');
            document.getElementById('txt-language').innerText = t('language');
            document.getElementById('btn-close-settings').innerText = t('close');
            document.getElementById('btn-launch').innerText = t('launch');
            document.getElementById('txt-paused').innerText = t('paused');
            document.getElementById('btn-resume').innerText = t('resume');
            document.getElementById('btn-retry').innerText = t('retry');
            document.getElementById('btn-exit').innerText = t('exit');
            
            document.getElementById('ui-fuel-label').innerText = t('fuel');
            document.getElementById('ui-score-label').innerText = t('score');
            document.getElementById('ui-lv-label').innerText = t('lv');
            
            document.getElementById('tab-ships').innerText = t('tab_ships');
            document.getElementById('tab-upgrades').innerText = t('tab_upgrades');
            document.getElementById('tab-items').innerText = t('tab_items');

            ['ko', 'en', 'ja'].forEach(l => {
                document.getElementById('lang-' + l).className = 'lang-btn' + (currentLang === l ? ' active' : '');
            });
        }

        // --- SHIP DATA ---
        // Added visual stats range (0-10 scale for bars)
        const SHIPS = [
            { id: 0, nameKey: "ship_std_name", descKey: "ship_std_desc", cost: 0, fuelMult: 1.0, thrust: 0.12, rot: 0.035, stats: {t:5, f:5, r:5} },
            { id: 1, nameKey: "ship_scout_name", descKey: "ship_scout_desc", cost: 2000, fuelMult: 0.7, thrust: 0.15, rot: 0.06, stats: {t:8, f:3, r:9} },
            { id: 2, nameKey: "ship_heavy_name", descKey: "ship_heavy_desc", cost: 5000, fuelMult: 1.5, thrust: 0.10, rot: 0.025, stats: {t:4, f:9, r:2} },
            { id: 3, nameKey: "ship_ufo_name", descKey: "ship_ufo_desc", cost: 10000, fuelMult: 1.2, thrust: 0.18, rot: 0.05, stats: {t:9, f:7, r:7} }
        ];

        const UPGRADE_DATA = {
            fuel: { key: 'upg_fuel', cost: [1000, 2500, 5000], max: 3 },
            efficiency: { key: 'upg_eff', cost: [1500, 3000, 6000], max: 3 },
            landing: { key: 'upg_land', cost: [2000, 4000, 8000], max: 3 }
        };

        const ITEM_DATA = {
            extraFuel: { key: 'item_fuel', cost: 500 },
            shield: { key: 'item_shield', cost: 800 }
        };

        // --- AUDIO ENGINE ---
        class AudioController {
            constructor() {
                this.ctx = null;
                this.enabled = localStorage.getItem('lunar_sound') !== 'false';
                this.masterGain = null;
                this.thrustSource = null;
                this.thrustGain = null;
                this.lastFuelWarning = 0;
            }
            init() {
                if (this.ctx) return;
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = this.enabled ? 0.3 : 0;
                this.masterGain.connect(this.ctx.destination);
            }
            toggle() {
                this.enabled = !this.enabled;
                localStorage.setItem('lunar_sound', this.enabled);
                if(this.ctx) {
                    this.masterGain.gain.value = this.enabled ? 0.3 : 0;
                    if(this.ctx.state === 'suspended') this.ctx.resume();
                }
                return this.enabled;
            }
            playTone(f, t, d, v=0.3) {
                if (!this.enabled || !this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = t; o.frequency.value = f;
                g.gain.setValueAtTime(v, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + d);
                o.connect(g); g.connect(this.masterGain);
                o.start(); o.stop(this.ctx.currentTime + d);
            }
            startThrust() {
                if (!this.enabled || !this.ctx || this.thrustSource) return;
                const buf = this.ctx.createBuffer(1, this.ctx.sampleRate, this.ctx.sampleRate);
                const d = buf.getChannelData(0);
                for(let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
                this.thrustSource = this.ctx.createBufferSource();
                this.thrustSource.buffer = buf;
                this.thrustSource.loop = true;
                this.thrustGain = this.ctx.createGain();
                const f = this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=600;
                this.thrustSource.connect(f); f.connect(this.thrustGain); this.thrustGain.connect(this.masterGain);
                this.thrustGain.gain.setValueAtTime(0, this.ctx.currentTime);
                this.thrustGain.gain.linearRampToValueAtTime(0.6, this.ctx.currentTime+0.1);
                this.thrustSource.start();
            }
            stopThrust() {
                if (this.thrustSource) {
                    this.thrustGain.gain.linearRampToValueAtTime(0, this.ctx.currentTime+0.2);
                    this.thrustSource.stop(this.ctx.currentTime+0.2);
                    this.thrustSource = null;
                }
            }
            playExplosion() { this.stopThrust(); this.playTone(80, 'sawtooth', 0.8, 0.8); }
            playWin() { this.stopThrust(); this.playTone(523, 'sine', 0.1); setTimeout(()=>this.playTone(659, 'sine', 0.1),150); setTimeout(()=>this.playTone(784, 'sine', 0.4),300); }
            playClick() { this.playTone(1200, 'sine', 0.05, 0.1); }
            playCollect() { this.playTone(2000, 'sine', 0.1, 0.2); }
            playLowFuel() {
                if (!this.enabled || !this.ctx) return;
                const now = this.ctx.currentTime;
                if (now - this.lastFuelWarning > 1.0) {
                    this.playTone(880, 'square', 0.1, 0.1);
                    this.lastFuelWarning = now;
                }
            }
            playFail() {
                this.stopThrust();
                this.playTone(150, 'sawtooth', 0.3);
                setTimeout(() => this.playTone(100, 'sawtooth', 0.6), 300);
            }
        }

        const audio = new AudioController();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiLayer = document.getElementById('ui-layer');

        const LOGICAL_W = 800, LOGICAL_H = 600;
        const LEVELS_PER_PAGE = 10, MAX_LEVEL = 50;
        const LANDER_SIZE = 20;

        // Game State
        let currentLevel = 1;
        let maxUnlocked = parseInt(localStorage.getItem('lunar_max_level')) || 1;
        let credits = parseInt(localStorage.getItem('lunar_credits')) || 0;
        let highScore = parseInt(localStorage.getItem('lunar_high_score')) || 0;
        let ownedShips = JSON.parse(localStorage.getItem('lunar_owned_ships')) || [0];
        let currentShipId = parseInt(localStorage.getItem('lunar_current_ship')) || 0;
        
        let playerUpgrades = JSON.parse(localStorage.getItem('lunar_upgrades')) || { fuel: 0, efficiency: 0, landing: 0 };
        let playerItems = JSON.parse(localStorage.getItem('lunar_items')) || { extraFuel: 0, shield: 0 };
        
        let menuPage = 0;
        let activeShopTab = 'ships';
        let gameState = 'menu';
        let keys = {};
        let isMobile = false;
        
        let lastTime = 0, accumulator = 0, STEP = 1000/60;
        let gameScale = 1, gameOffsetX = 0, gameOffsetY = 0;
        let shakeIntensity = 0;
        let currentScore = 0;
        let maxFuel = 100;

        // Entities
        let terrainPoints = [], landingPad = {x:0, w:0, y:0};
        let particles = [], obstacles = [], debris = [], thrustParticles = [], collectibles = [];
        let levelConfig = { groundColor: '#aaa', bgColor: '#000' };
        // shield: active shield state
        const lander = { x:0, y:0, vx:0, vy:0, angle:0, fuel:0, visible:true, thrusting:false, shield: false };

        const uiScreens = {
            menu: document.getElementById('screen-level-select'),
            hangar: document.getElementById('screen-hangar'),
            settings: document.getElementById('screen-settings'),
            tutorial: document.getElementById('screen-tutorial'),
            pause: document.getElementById('screen-pause'),
            result: document.getElementById('screen-result')
        };

        const THEMES = ["planet_moon", "planet_mars", "planet_earth", "planet_ice", "planet_volcanic"];
        const TUTORIALS = {
            1: { titleKey: "tut_1_title", textKey: "tut_1_text" },
            2: { titleKey: "tut_2_title", textKey: "tut_2_text" },
            5: { titleKey: "tut_5_title", textKey: "tut_5_text" },
            11: { titleKey: "tut_11_title", textKey: "tut_11_text" }
        };

        function init() {
            isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            if(isMobile) document.getElementById('mobile-controls').style.display='block';
            window.addEventListener('resize', resizeGame);
            resizeGame();
            
            menuPage = Math.floor((maxUnlocked-1)/LEVELS_PER_PAGE);
            updateMenuUI();
            updateTexts(); 
            
            ['click','touchstart','keydown'].forEach(e => window.addEventListener(e, ()=>audio.init(), {once:true}));
            updateSoundIcon(audio.enabled);

            setupMobileControls();
            document.addEventListener('keydown', handleKey);
            document.addEventListener('keyup', e => keys[e.code] = false);
            
            requestAnimationFrame(loop);
        }

        function resizeGame() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const sx = canvas.width / LOGICAL_W;
            const sy = canvas.height / LOGICAL_H;
            gameScale = Math.min(sx, sy);
            gameOffsetX = (canvas.width - LOGICAL_W*gameScale)/2;
            gameOffsetY = (canvas.height - LOGICAL_H*gameScale)/2;
            uiLayer.style.width = `${LOGICAL_W*gameScale}px`;
            uiLayer.style.height = `${LOGICAL_H*gameScale}px`;
        }

        function loop(timestamp) {
            if(!lastTime) lastTime = timestamp;
            let dt = timestamp - lastTime;
            lastTime = timestamp;
            if(dt > 100) accumulator = 0; else accumulator += dt;
            
            while(accumulator >= STEP) {
                update();
                accumulator -= STEP;
            }
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            if(shakeIntensity > 0) shakeIntensity *= 0.9;
            if(shakeIntensity < 0.5) shakeIntensity = 0;

            if(gameState === 'playing') {
                updateGame();
                updateParticles();
            } else if(gameState === 'result' || gameState === 'countdown') {
                if(debris.length) updateDebris();
                updateParticles();
                if(gameState !== 'playing') audio.stopThrust();
            } else {
                audio.stopThrust();
            }
        }

        function updateGame() {
            const shipStats = SHIPS[currentShipId];
            
            if(keys['ArrowLeft']) lander.angle -= shipStats.rot;
            if(keys['ArrowRight']) lander.angle += shipStats.rot;
            
            if(keys['ArrowUp'] && lander.fuel > 0) {
                if(!lander.thrusting) { lander.thrusting = true; audio.startThrust(); }
                lander.vx += Math.sin(lander.angle) * shipStats.thrust;
                lander.vy -= Math.cos(lander.angle) * shipStats.thrust;
                
                // Fuel Efficiency Upgrade
                const effLevel = playerUpgrades.efficiency || 0;
                const burnRate = 0.3 * (1 - effLevel * 0.1); // -10% per level
                lander.fuel -= burnRate;
                
                for(let i=0; i<2; i++) {
                    const a = lander.angle + Math.PI + (Math.random()-0.5)*0.5;
                    const s = Math.random()*3+2;
                    thrustParticles.push({
                        x: lander.x - Math.sin(lander.angle)*10, y: lander.y + Math.cos(lander.angle)*10,
                        vx: lander.vx + Math.sin(a)*s, vy: lander.vy - Math.cos(a)*s,
                        life: 1.0, color: i===0?'#fff':'#fa0'
                    });
                }
            } else {
                if(lander.thrusting) { lander.thrusting = false; audio.stopThrust(); }
            }

            const g = (levelConfig && levelConfig.gravity) ? levelConfig.gravity : 0.05;
            const w = (levelConfig && levelConfig.wind) ? levelConfig.wind : 0;

            lander.vy += g * 0.9;
            lander.vx += w;
            lander.x += lander.vx; lander.y += lander.vy;

            if(lander.x < 0) lander.x = LOGICAL_W;
            if(lander.x > LOGICAL_W) lander.x = 0;
            if(lander.y < 0) { lander.y = 0; lander.vy = 0; }

            obstacles.forEach(o => {
                o.x += o.speed;
                o.y += Math.sin(Date.now()/500 + o.phase) * 0.5;
                if(o.x < 0 || o.x > LOGICAL_W) o.speed *= -1;
                
                if(Math.hypot(lander.x - o.x, lander.y - o.y) < o.r + 10) {
                    if(lander.shield) {
                        lander.shield = false; // Consume shield
                        // Bounce effect
                        lander.vx *= -1.5; lander.vy *= -1.5;
                        audio.playClick(); // Shield sound placeholder
                        shakeIntensity = 10;
                    } else {
                        crash(t("hit_obstacle"));
                    }
                }
            });

            for(let i=collectibles.length-1; i>=0; i--) {
                const c = collectibles[i];
                c.a += 0.05;
                if(Math.hypot(lander.x - c.x, lander.y - c.y) < 25) {
                    collectibles.splice(i,1);
                    lander.fuel = Math.min(maxFuel, lander.fuel + 20);
                    currentScore += 100;
                    audio.playCollect();
                }
            }

            const bottomY = lander.y + 10;
            const idx = Math.floor(lander.x / (LOGICAL_W/(terrainPoints.length-1)));
            if(idx >= 0 && idx < terrainPoints.length-1) {
                const p1 = terrainPoints[idx], p2 = terrainPoints[idx+1];
                const groundY = p1.y + (lander.x - p1.x) * (p2.y - p1.y) / (p2.x - p1.x);
                
                const onPad = lander.x > landingPad.x && lander.x < landingPad.x + landingPad.w;
                const collisionY = onPad ? landingPad.y : groundY;

                if(bottomY >= collisionY) {
                    lander.y = collisionY - 10;
                    if(onPad) checkLanding();
                    else {
                        if(lander.shield) {
                            lander.shield = false; 
                            lander.vy = -Math.abs(lander.vy) * 0.5; // Bounce up
                            audio.playClick();
                        } else {
                            crash(t("crashed_terrain"));
                        }
                    }
                }
            }

            const dist = landingPad.y - lander.y;
            document.getElementById('danger-overlay').style.opacity = (dist < 150 && lander.vy > 4) ? 0.5 : 0;
            
            updateHUD();
        }

        function checkLanding() {
            const vSpeed = Math.abs(lander.vy);
            const hSpeed = Math.abs(lander.vx);
            const angle = Math.abs(lander.angle);
            
            // Landing Gear Upgrade
            const landLevel = playerUpgrades.landing || 0;
            const bonusTol = landLevel * 0.5; // +0.5 speed tolerance per level
            
            const limitV = 3.5 + bonusTol;
            const limitH = 2.5 + bonusTol;

            if(vSpeed < limitV && hSpeed < limitH && angle < 0.35) {
                let grade = t("good");
                let bonus = 100;
                if(vSpeed < 1.5 && hSpeed < 1.0 && angle < 0.1) { grade=t("perfect"); bonus=500; }
                else if(vSpeed > 2.5) { grade=t("hard"); bonus=10; }
                
                const fuelBonus = Math.floor(lander.fuel);
                const levelScore = 500 + fuelBonus + bonus;
                currentScore += levelScore;
                credits += levelScore;
                localStorage.setItem('lunar_credits', credits);
                
                if(currentScore > highScore) {
                    highScore = currentScore;
                    localStorage.setItem('lunar_high_score', highScore);
                }
                
                if(currentLevel === maxUnlocked && currentLevel < MAX_LEVEL) {
                    maxUnlocked++;
                    localStorage.setItem('lunar_max_level', maxUnlocked);
                }

                endGame(true, `${grade}!\nSCORE: +${levelScore}`);
            } else {
                let reason = t("too_fast");
                if(angle >= 0.35) reason = t("bad_angle");
                else if(hSpeed >= limitH) reason = t("h_speed");
                crash(reason);
            }
        }

        function crash(reason) {
            shakeIntensity = 20;
            audio.playExplosion();
            for(let i=0; i<20; i++) debris.push({x:lander.x, y:lander.y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:1, c:Math.random()<0.5?'orange':'white'});
            endGame(false, reason);
        }

        function updateHUD() {
            const fBar = document.getElementById('fuel-bar');
            const pct = (lander.fuel / maxFuel) * 100;
            fBar.style.width = `${pct}%`;
            
            if (pct < 30) {
                fBar.style.backgroundColor = 'red';
                if(gameState === 'playing') audio.playLowFuel();
            } else {
                fBar.style.backgroundColor = pct < 60 ? 'yellow' : '#0f0';
            }
            
            const fEl = document.getElementById('ui-fuel');
            if(fEl) fEl.innerText = Math.floor(lander.fuel);

            document.getElementById('ui-score').innerText = currentScore;
            document.getElementById('ui-alt').innerText = Math.max(0, Math.floor(landingPad.y - lander.y));
            
            const vEl = document.getElementById('ui-vspeed');
            vEl.innerText = Math.abs(lander.vy).toFixed(1);
            vEl.className = Math.abs(lander.vy) > 3.5 ? 'danger' : 'safe';

            const hEl = document.getElementById('ui-hspeed');
            if(hEl) {
                hEl.innerText = Math.abs(lander.vx).toFixed(1);
                hEl.className = Math.abs(lander.vx) > 2.5 ? 'danger' : 'safe';
            }

            const wEl = document.getElementById('ui-wind');
            if(wEl) {
                const w = (levelConfig && levelConfig.wind) ? levelConfig.wind : 0;
                if(Math.abs(w) > 0.001) {
                    wEl.innerText = (w > 0 ? ">> " : "<< ") + Math.abs(w*1000).toFixed(0);
                    wEl.className = 'warn';
                } else {
                    wEl.innerText = "0";
                    wEl.className = 'safe';
                }
            }
        }

        function draw() {
            const bgColor = (levelConfig && levelConfig.bgColor) ? levelConfig.bgColor : '#050505';
            ctx.fillStyle = bgColor;
            ctx.fillRect(0,0,canvas.width, canvas.height);
            
            drawParallax();

            ctx.save();
            let sx = (Math.random()-0.5)*shakeIntensity, sy = (Math.random()-0.5)*shakeIntensity;
            ctx.translate(gameOffsetX + sx, gameOffsetY + sy);
            ctx.scale(gameScale, gameScale);
            
            ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.strokeRect(0,0,LOGICAL_W, LOGICAL_H);

            if(lander.thrusting) {
                const g = ctx.createRadialGradient(lander.x, lander.y, 10, lander.x, lander.y, 120);
                g.addColorStop(0, "rgba(255,200,100,0.3)"); g.addColorStop(1, "rgba(0,0,0,0)");
                ctx.fillStyle = g; ctx.globalCompositeOperation = 'lighter';
                ctx.fillRect(0,0,LOGICAL_W, LOGICAL_H);
                ctx.globalCompositeOperation = 'source-over';
            }

            if(terrainPoints.length > 0) {
                const tGrad = ctx.createLinearGradient(0,0,0,LOGICAL_H);
                const groundCol = (levelConfig && levelConfig.groundColor) ? levelConfig.groundColor : '#aaa';
                tGrad.addColorStop(0, groundCol); 
                tGrad.addColorStop(1, 'black');
                
                ctx.fillStyle = tGrad; 
                ctx.beginPath();
                ctx.moveTo(terrainPoints[0].x, terrainPoints[0].y);
                for(let i=1; i<terrainPoints.length; i++) ctx.lineTo(terrainPoints[i].x, terrainPoints[i].y);
                ctx.lineTo(LOGICAL_W, LOGICAL_H); ctx.lineTo(0, LOGICAL_H); ctx.fill();
                
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.beginPath();
                ctx.moveTo(terrainPoints[0].x, terrainPoints[0].y);
                for(let i=1; i<terrainPoints.length; i++) ctx.lineTo(terrainPoints[i].x, terrainPoints[i].y);
                ctx.stroke();
            }
            
            ctx.fillStyle = '#ff0'; ctx.fillRect(landingPad.x, landingPad.y, landingPad.w, 4);
            if(Date.now()%1000 < 500) {
                ctx.fillStyle = '#0f0';
                ctx.fillRect(landingPad.x, landingPad.y-5, 2, 5);
                ctx.fillRect(landingPad.x+landingPad.w-2, landingPad.y-5, 2, 5);
            }

            collectibles.forEach(c => {
                ctx.save(); ctx.translate(c.x, c.y); ctx.rotate(c.a);
                ctx.fillStyle = '#fd0'; ctx.fillRect(-6, -6, 12, 12);
                ctx.fillStyle = '#000'; ctx.font='8px monospace'; ctx.fillText('$', -3, 3);
                ctx.restore();
            });

            obstacles.forEach(o => {
                ctx.fillStyle = '#f00'; ctx.beginPath(); ctx.arc(o.x, o.y, o.r, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth=1; ctx.stroke();
            });

            thrustParticles.forEach(p => {
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                ctx.beginPath(); ctx.arc(p.x, p.y, Math.random()*3+1, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            });

            if(lander.visible) drawShip(currentShipId);

            debris.forEach(p => {
                ctx.fillStyle = p.c; ctx.globalAlpha = p.life;
                ctx.fillRect(p.x, p.y, 3, 3); ctx.globalAlpha = 1;
            });

            // Shield Visual
            if(lander.visible && lander.shield) {
                ctx.strokeStyle = 'cyan';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(lander.x, lander.y, 25, 0, Math.PI*2);
                ctx.stroke();
            }

            if(lander.visible && lander.y < landingPad.y - 50) {
                ctx.strokeStyle = 'rgba(0,255,0,0.2)'; ctx.setLineDash([5, 5]);
                ctx.beginPath(); ctx.moveTo(lander.x, lander.y); ctx.lineTo(lander.x, landingPad.y); ctx.stroke();
                ctx.setLineDash([]);
            }

            ctx.restore();
        }

        function drawShip(id) {
            ctx.save(); ctx.translate(lander.x, lander.y); ctx.rotate(lander.angle);
            ctx.strokeStyle = '#aaa'; ctx.lineWidth = 2; ctx.fillStyle = '#eee';
            
            if(id === 0) {
                ctx.beginPath(); ctx.moveTo(-10,-10); ctx.lineTo(10,-10); ctx.lineTo(12,8); ctx.lineTo(-12,8); ctx.fill(); ctx.stroke();
                ctx.fillStyle='#3cf'; ctx.fillRect(-6,-6,12,6);
                ctx.beginPath(); ctx.moveTo(-10,8); ctx.lineTo(-14,18); ctx.moveTo(10,8); ctx.lineTo(14,18); ctx.stroke();
            } else if (id === 1) {
                ctx.beginPath(); ctx.moveTo(0,-15); ctx.lineTo(10,10); ctx.lineTo(-10,10); ctx.closePath(); ctx.fill(); ctx.stroke();
                ctx.fillStyle='#3cf'; ctx.beginPath(); ctx.arc(0,0,4,0,Math.PI*2); ctx.fill();
            } else if (id === 2) {
                ctx.fillRect(-14,-12,28,24); ctx.strokeRect(-14,-12,28,24);
                ctx.fillStyle='#3cf'; ctx.fillRect(-10,-5,20,6);
                ctx.beginPath(); ctx.moveTo(-14,12); ctx.lineTo(-18,20); ctx.moveTo(14,12); ctx.lineTo(18,20); ctx.stroke();
            } else {
                ctx.beginPath(); ctx.ellipse(0, 0, 16, 8, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                ctx.fillStyle='rgba(50,255,255,0.5)'; ctx.beginPath(); ctx.arc(0,-3,8,Math.PI,0); ctx.fill(); ctx.stroke();
            }
            ctx.restore();
        }

        function drawParallax() {
            particles.forEach(p => {
                if(gameState === 'playing') {
                    let moveX = lander.vx * p.z * 0.1; 
                    let moveY = lander.vy * p.z * 0.1;
                    p.x -= moveX; p.y -= moveY;
                    if(p.x < 0) p.x += canvas.width; if(p.x > canvas.width) p.x -= canvas.width;
                    if(p.y < 0) p.y += canvas.height; if(p.y > canvas.height) p.y -= canvas.height;
                }
                ctx.globalAlpha = p.z * 0.8;
                ctx.fillStyle = p.c; 
                ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            });
        }

        // --- LEVEL GENERATION ---
        function startLevel(lvl) {
            currentLevel = lvl;
            const progress = (lvl-1)/MAX_LEVEL;
            levelConfig = {
                gravity: 0.035 + (0.05 * progress),
                wind: (lvl>=5 ? (lvl-4)*0.002 * (lvl%2==0?1:-1) : 0),
                groundColor: ['#aaa', '#c44', '#282', '#acf', '#622'][Math.floor((lvl-1)/10)%5],
                bgColor: ['#000', '#100', '#001', '#012', '#210'][Math.floor((lvl-1)/10)%5]
            };
            
            // Apply Ship Stats & Upgrades
            const stats = SHIPS[currentShipId];
            
            // Fuel Tank Upgrade
            const fuelLevel = playerUpgrades.fuel || 0;
            const fuelBonus = 1.0 + (fuelLevel * 0.1); // +10% per level
            
            maxFuel = Math.max(80, 130 - (progress * 50)) * stats.fuelMult * fuelBonus;
            lander.fuel = maxFuel;
            
            // Apply Items
            if(playerItems.extraFuel > 0) {
                lander.fuel += 50;
                maxFuel += 50; // visual fix
                playerItems.extraFuel--;
            }
            if(playerItems.shield > 0) {
                lander.shield = true;
                playerItems.shield--;
            } else {
                lander.shield = false;
            }
            updateStorage();

            lander.x = LOGICAL_W/2; lander.y = 50; lander.vx=0; lander.vy=0; lander.angle=0; lander.visible=true; lander.thrusting=false;
            debris = []; thrustParticles = [];
            
            terrainPoints = [];
            const seg = 30, wid = LOGICAL_W/seg;
            const padIdx = Math.floor(Math.random()*(seg-6))+3;
            landingPad.w = Math.max(30, 60 - progress*30);
            landingPad.x = padIdx * wid; landingPad.y = 500 + (Math.random()*50-25);
            
            let ch = 400;
            for(let i=0; i<=seg; i++) {
                let x = i*wid, y;
                if(x >= landingPad.x - wid && x <= landingPad.x + landingPad.w + wid) {
                    y = (x >= landingPad.x && x <= landingPad.x+landingPad.w) ? landingPad.y : landingPad.y+10;
                } else {
                    ch += (Math.random()-0.5)*70; ch = Math.max(200, Math.min(580, ch)); y=ch;
                }
                terrainPoints.push({x,y});
            }

            particles = [];
            for(let i=0; i<80; i++) particles.push({
                x:Math.random()*canvas.width, y:Math.random()*canvas.height, 
                s:Math.random()*2, z:Math.random(), c:'white'
            });

            obstacles = [];
            if(lvl >= 11) {
                const cnt = Math.floor((lvl-1)/10);
                for(let i=0; i<cnt; i++) obstacles.push({
                    x:Math.random()*LOGICAL_W, y:150+Math.random()*300, r:10, speed:(1+lvl*0.02)*(Math.random()<0.5?1:-1), phase:Math.random()
                });
            }

            collectibles = [];
            if(lvl >= 2) {
                const cnt = 1 + Math.floor((lvl-2)/10);
                for(let i=0; i<cnt; i++) collectibles.push({ x:Math.random()*(LOGICAL_W-100)+50, y:Math.random()*300+100, a:0 });
            }

            document.getElementById('danger-overlay').style.opacity = 0;
            updateMenuUI();
            showScreen(null);
            
            if(TUTORIALS[lvl]) {
                const t = TUTORIALS[lvl];
                document.getElementById('tut-title').innerText = t(t.titleKey);
                document.getElementById('tut-text').innerText = t(t.textKey);
                showScreen('tutorial');
            } else {
                startCountdown();
            }
        }

        // --- UI FUNCTIONS ---
        function showScreen(name) {
            Object.values(uiScreens).forEach(e => e.style.display = 'none');
            if(uiScreens[name]) uiScreens[name].style.display = 'flex';
        }
        function updateMenuUI() {
            document.getElementById('ui-level').innerText = currentLevel;
            document.getElementById('ui-planet').innerText = t(THEMES[Math.min(menuPage,4)]);
            document.getElementById('menu-credits').innerText = credits;
            document.getElementById('hangar-credits').innerText = credits;
            document.getElementById('ui-highscore').innerText = highScore;
            
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            const start = menuPage*LEVELS_PER_PAGE+1;
            const end = Math.min(start+LEVELS_PER_PAGE-1, MAX_LEVEL);
            document.getElementById('page-theme-name').innerText = t(THEMES[Math.min(menuPage,4)]) + " SECTOR";
            document.getElementById('page-indicator').innerText = "P"+(menuPage+1);
            
            for(let i=start; i<=end; i++) {
                const b = document.createElement('div');
                b.className = 'level-btn ' + (i>maxUnlocked?'locked':(i<maxUnlocked?'cleared':''));
                b.innerText = i;
                if(i<=maxUnlocked) b.onclick = () => { audio.playClick(); startLevel(i); };
                grid.appendChild(b);
            }
            
            const prev = document.getElementById('btn-prev'), next = document.getElementById('btn-next');
            prev.style.opacity = menuPage>0?1:0.3;
            next.innerText = (menuPage < Math.ceil(MAX_LEVEL/LEVELS_PER_PAGE)-1 && maxUnlocked >= (menuPage+1)*LEVELS_PER_PAGE+1) ? "‚ñ∂" : "üîí";
            next.style.opacity = next.innerText==="‚ñ∂"?1:0.3;
        }

        function switchShopTab(tabName) {
            audio.playClick();
            activeShopTab = tabName;
            
            document.querySelectorAll('.shop-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            renderShopContent();
        }

        function renderShopContent() {
            const list = document.getElementById('shop-content');
            list.innerHTML = '';

            if (activeShopTab === 'ships') {
                SHIPS.forEach(s => {
                    const owned = ownedShips.includes(s.id);
                    const isSelected = currentShipId === s.id;
                    const el = document.createElement('div');
                    el.className = 'ship-card ' + (isSelected ? 'selected' : '');
                    
                    const makeBar = (val, color) => `<div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${val*10}%; background:${color};"></div></div>`;
                    
                    el.innerHTML = `
                        <div class="card-header">
                            <div class="card-name">${t(s.nameKey)}</div>
                            <div class="card-cost">${owned ? (isSelected ? t("ship_equipped") : t("ship_select")) : s.cost+" CR"}</div>
                        </div>
                        <div class="ship-info" style="width:100%;">
                            <div class="stat-row"><div class="stat-label">${t("stat_thrust")}</div>${makeBar(s.stats.t, '#f80')}</div>
                            <div class="stat-row"><div class="stat-label">${t("stat_fuel")}</div>${makeBar(s.stats.f, '#0f0')}</div>
                            <div class="stat-row"><div class="stat-label">${t("stat_turn")}</div>${makeBar(s.stats.r, '#0af')}</div>
                            <div class="card-desc" style="margin-top:5px;">${t(s.descKey)}</div>
                        </div>
                    `;
                    el.onclick = () => {
                        if(owned) {
                            currentShipId = s.id;
                            localStorage.setItem('lunar_current_ship', currentShipId);
                            renderShopContent();
                            audio.playClick();
                        } else if(credits >= s.cost) {
                            credits -= s.cost;
                            ownedShips.push(s.id);
                            updateStorage();
                            audio.playWin(); 
                            renderShopContent();
                        } else {
                            audio.playFail(); 
                        }
                    };
                    list.appendChild(el);
                });
            } else if (activeShopTab === 'upgrades') {
                for (const [key, data] of Object.entries(UPGRADE_DATA)) {
                    const level = playerUpgrades[key] || 0;
                    const isMax = level >= data.max;
                    const cost = data.cost[level];
                    const name = t(data.key + '_name');
                    const desc = t(data.key + '_desc');

                    const el = document.createElement('div');
                    el.className = 'upgrade-card';
                    el.innerHTML = `
                        <div class="upgrade-info" style="width:100%;">
                            <div class="card-header">
                                <div class="card-name">${name}</div>
                                <div class="card-cost">${isMax ? t("upgrade_max") : cost + " CR"}</div>
                            </div>
                            <div class="card-desc">${desc}</div>
                            <div class="card-level">LV ${level} / ${data.max}</div>
                        </div>
                    `;
                    el.onclick = () => {
                        if (isMax) return;
                        if (credits >= cost) {
                            credits -= cost;
                            playerUpgrades[key] = level + 1;
                            updateStorage();
                            audio.playWin();
                            renderShopContent();
                        } else {
                            audio.playFail();
                        }
                    };
                    list.appendChild(el);
                }
            } else if (activeShopTab === 'items') {
                for (const [key, data] of Object.entries(ITEM_DATA)) {
                    const count = playerItems[key] || 0;
                    const name = t(data.key + '_name');
                    const desc = t(data.key + '_desc');
                    const cost = data.cost;
                    
                    const el = document.createElement('div');
                    el.className = 'item-card';
                    el.innerHTML = `
                        <div class="upgrade-info" style="width:100%;">
                            <div class="card-header">
                                <div class="card-name">${name}</div>
                                <div class="card-cost">${cost} CR</div>
                            </div>
                            <div class="card-desc">${desc}</div>
                            <div class="card-level">${t("item_owned")}: ${count}</div>
                        </div>
                    `;
                    el.onclick = () => {
                        if (count >= 1) return; // Limit 1 for simplicity
                        if (credits >= cost) {
                            credits -= cost;
                            playerItems[key] = count + 1;
                            updateStorage();
                            audio.playWin();
                            renderShopContent();
                        } else {
                            audio.playFail();
                        }
                    };
                    list.appendChild(el);
                }
            }
            updateMenuUI(); // Refresh credits
        }

        function openHangar() {
            audio.playClick();
            switchShopTab('ships'); // Default tab
            showScreen('hangar');
        }

        function updateStorage() {
            localStorage.setItem('lunar_credits', credits);
            localStorage.setItem('lunar_owned_ships', JSON.stringify(ownedShips));
            localStorage.setItem('lunar_upgrades', JSON.stringify(playerUpgrades));
            localStorage.setItem('lunar_items', JSON.stringify(playerItems));
        }

        function openSettings() {
            audio.playClick();
            showScreen('settings');
        }

        function closeSettings() {
            audio.playClick();
            showScreen('menu');
        }
        
        function closeHangar() { audio.playClick(); updateMenuUI(); showScreen('menu'); }
        function goToLevelSelect() { audio.playClick(); gameState='menu'; updateMenuUI(); showScreen('menu'); }
        function changeMenuPage(d) { audio.playClick(); if(d<0 && menuPage>0) menuPage--; if(d>0 && document.getElementById('btn-next').innerText==="‚ñ∂") menuPage++; updateMenuUI(); }
        function togglePause() { audio.playClick(); gameState = gameState==='playing'?'paused':'playing'; showScreen(gameState==='paused'?'pause':null); }
        
        function toggleSound() { 
            const enabled = audio.toggle();
            updateSoundIcon(enabled);
        }

        function updateSoundIcon(enabled) {
            const btn = document.getElementById('sound-btn');
            btn.style.opacity = enabled ? 1 : 0.5;
        }

        function closeTutorial() { audio.playClick(); showScreen(null); startCountdown(); }
        function restartCurrentLevel() { audio.playClick(); startLevel(currentLevel); }
        
        function startCountdown() {
            gameState = 'countdown';
            let n = 3;
            const el = document.getElementById('countdown-overlay');
            el.style.display = 'block'; el.innerText = n;
            const iv = setInterval(()=>{
                if(gameState!=='countdown'){ clearInterval(iv); return; }
                n--;
                if(n>0) { el.innerText = n; audio.playClick(); }
                else { el.innerText = t("ignition"); audio.playWin(); clearInterval(iv); setTimeout(()=>{el.style.display='none'; gameState='playing';},500); }
            }, 800);
        }

        function endGame(success, msg) {
            gameState='result';
            const titleEl = document.getElementById('res-title'), b = document.getElementById('res-buttons');
            titleEl.innerText = success ? t("mission_success") : t("mission_failed");
            titleEl.style.color = success ? "#0f0" : "#f00";
            document.getElementById('res-text').innerText = msg;
            b.innerHTML = '';
            
            const btn = (txt, cls, fn) => {
                const e = document.createElement('button'); e.className='btn '+cls; e.innerText=txt; e.onclick=fn; b.appendChild(e);
            };
            
            if(success && currentLevel < MAX_LEVEL) btn(t("next_mission"), 'btn-green', ()=>{ audio.playClick(); startLevel(currentLevel+1); });
            btn(t("retry"), '', ()=>{ audio.playClick(); startLevel(currentLevel); });
            btn(t("menu"), 'btn-red', goToLevelSelect);
            
            showScreen('result');
        }

        function handleKey(e) {
            audio.init();
            if(gameState === 'tutorial' && (e.code==='Enter'||e.code==='Space')) closeTutorial();
            if(e.code==='KeyP' || e.code==='Escape') togglePause();
            keys[e.code] = true;
        }

        function updateParticles() {
            for(let i=thrustParticles.length-1; i>=0; i--) {
                const p = thrustParticles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                if(p.life<=0) thrustParticles.splice(i,1);
            }
        }
        function updateDebris() {
            for(let i=debris.length-1; i>=0; i--) {
                const p = debris[i];
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life-=0.02;
                if(p.life<=0) debris.splice(i,1);
            }
        }

        function setupMobileControls() {
            const bind = (id, code) => {
                const el = document.getElementById(id);
                const h = (s) => (e) => { e.preventDefault(); audio.init(); keys[code]=s; s?el.classList.add('active'):el.classList.remove('active'); };
                el.addEventListener('touchstart', h(true), {passive:false});
                el.addEventListener('touchend', h(false));
            };
            bind('btn-left','ArrowLeft'); bind('btn-right','ArrowRight'); bind('btn-thrust','ArrowUp');
        }

        init();
    </script>
</body>
</html>
