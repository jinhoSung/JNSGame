<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinite Climber : Final Complete</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0; padding: 0;
            background-color: #1a1a2e;
            overflow: hidden;
            font-family: 'Black Han Sans', sans-serif;
            touch-action: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #game-container {
            position: relative; width: 100vw; height: 100vh; overflow: hidden;
        }

        canvas { display: block; }

        /* UI Î†àÏù¥Ïñ¥ */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 10;
        }

        /* ÏÉÅÎã® Î∞î */
        .top-bar {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 20px; pointer-events: auto;
            z-index: 60; position: relative;
        }

        .gold-display {
            background: rgba(0, 0, 0, 0.6);
            color: #FFD700; padding: 8px 15px; border-radius: 20px;
            font-size: 20px; border: 2px solid #FFD700;
            display: flex; align-items: center; gap: 5px;
            box-shadow: 0 4px 0 #b8860b;
        }

        .btn-group { display: flex; gap: 10px; }

        .icon-btn {
            font-size: 24px; background: rgba(255, 255, 255, 0.2);
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.3);
            transition: transform 0.1s; color: white;
            text-shadow: 0 1px 2px black;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }

        /* Ï†êÏàòÌåê */
        .score-board {
            text-align: center; margin-top: -60px;
            color: white; text-shadow: 0 4px 0 rgba(0,0,0,0.5);
            pointer-events: none;
        }
        #score { font-size: 70px; margin: 0; background: -webkit-linear-gradient(#fff, #ddd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #best-score { font-size: 20px; color: #ffd700; margin-top: 5px; }
        #biome-name { font-size: 18px; color: #00d2ff; margin-top: 5px; opacity: 0.8; letter-spacing: 2px; }

        /* Ï≤¥Î†• Í≤åÏù¥ÏßÄ */
        .stamina-wrapper {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            width: 60%; max-width: 300px; height: 20px;
            background: rgba(0, 0, 0, 0.5); border-radius: 12px; padding: 3px;
            backdrop-filter: blur(5px);
        }
        #stamina-bar {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #00f260, #0575e6);
            border-radius: 10px; transition: width 0.1s linear, background 0.3s;
        }

        /* Ïª®Ìä∏Î°§ */
        .controls { display: flex; width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: auto; z-index: 5; }
        .control-btn { flex: 1; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 60px; font-size: 20px; color: rgba(255,255,255,0.4); transition: background 0.05s; cursor: pointer; }
        .btn-left { border-right: 1px solid rgba(255,255,255,0.05); }
        .control-btn:active { background: rgba(255,255,255,0.05); }
        .btn-icon { font-size: 40px; margin-bottom: 10px; display: block; opacity: 0.8; }

        /* Í≥µÌÜµ ÌåùÏóÖ */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(16, 16, 30, 0.95); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; z-index: 20; pointer-events: auto;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .screen.active { opacity: 1; visibility: visible; }

        /* ÏÉÅÏ†ê ÌôîÎ©¥ */
        #shop-screen { justify-content: flex-start; padding-top: 50px; z-index: 100 !important; }

        h1 { font-size: 3rem; margin: 0 0 20px 0; background: linear-gradient(to right, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .btn-main {
            margin-top: 15px; padding: 12px 35px; font-size: 22px;
            font-family: 'Black Han Sans', sans-serif;
            background: linear-gradient(to bottom, #FF4500, #CC3700);
            color: white; border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 6px 0 #8B2500; transition: transform 0.1s;
        }
        .btn-main:active { transform: translateY(6px); box-shadow: none; }
        .btn-green { background: linear-gradient(to bottom, #2ecc71, #27ae60); box-shadow: 0 6px 0 #219150; }
        .btn-green:active { box-shadow: none; }
        .btn-sub { background: #555; box-shadow: 0 6px 0 #333; font-size: 18px; padding: 10px 30px; margin-top: 10px; }
        .btn-sub:active { box-shadow: none; }

        /* ÏÉÅÏ†ê Ïä§ÌÉÄÏùº */
        .shop-tabs { display: flex; gap: 20px; margin-bottom: 20px; }
        .shop-tab { font-size: 20px; color: #aaa; cursor: pointer; border-bottom: 2px solid transparent; padding-bottom: 5px; }
        .shop-tab.active { color: #fff; border-bottom: 2px solid #FFD700; font-weight: bold; }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 90%; max-width: 500px; height: 50vh; overflow-y: auto; padding: 10px; }
        .shop-item { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; align-items: center; border: 2px solid transparent; position: relative; }
        .shop-item.owned { border-color: #2ecc71; }
        .shop-item.equipped { border-color: #FFD700; background: rgba(255, 215, 0, 0.1); }
        .item-name { font-size: 18px; margin-bottom: 5px; }
        .item-stats { font-size: 12px; color: #aaa; margin-bottom: 10px; text-align: center; }
        .item-price { font-size: 16px; color: #FFD700; font-weight: bold; }
        .btn-buy { padding: 5px 15px; border-radius: 20px; border: none; cursor: pointer; font-family: inherit; margin-top: 5px; }

        /* Îû≠ÌÇπ Ïä§ÌÉÄÏùº */
        #ranking-loading { font-size: 20px; color: #00d2ff; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .ranking-list { width: 90%; max-width: 400px; height: 50vh; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 10px; margin: 20px 0; padding: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 18px; }
        .rank-item:nth-child(1) { color: #FFD700; }
        .rank-input-area { display: none; flex-direction: column; align-items: center; width: 100%; }
        #rank-name-input { padding: 10px; font-size: 20px; border-radius: 5px; border: none; margin-bottom: 10px; text-align: center; width: 200px; font-family: inherit; }
        .retry-area { display: none; flex-direction: column; align-items: center; }
        .rank-msg { font-size: 1.2rem; color: #aaa; margin-bottom: 10px; }
        .rank-msg.highlight { color: #00d2ff; font-size: 1.5rem; animation: bounce 0.5s infinite alternate; }

        /* Í∏∞ÌÉÄ Ìö®Í≥º */
        #notification { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #combo-text { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 50px; color: #FFD700; text-shadow: 0 0 10px orange; pointer-events: none; z-index: 15; transition: transform 0.1s; }
        .tutorial-hand { position: absolute; bottom: 150px; font-size: 60px; animation: bounce 0.8s infinite alternate; pointer-events: none; z-index: 100; display: none; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="combo-text">COMBO!</div>
    <div id="notification">Î©îÏãúÏßÄ</div>
    
    <div id="tutorial-hand-left" class="tutorial-hand" style="left: 25%;">üëÜ</div>
    <div id="tutorial-hand-right" class="tutorial-hand" style="left: 75%;">üëÜ</div>

    <div class="ui-layer">
        <div class="top-bar">
            <div class="gold-display"><span>ü™ô</span> <span id="ui-gold">0</span></div>
            <div class="btn-group">
                <div class="icon-btn" onclick="openShop(event)">üõí</div>
                <div class="icon-btn" onclick="openLeaderboard(event)">üèÜ</div>
                <div class="icon-btn" id="sound-btn" onclick="toggleSound(event)">üîä</div>
                <div class="icon-btn" onclick="togglePause(event)">‚è∏Ô∏è</div>
            </div>
        </div>

        <div class="stamina-wrapper"><div id="stamina-bar"></div></div>
        <div class="score-board">
            <h2 id="score">0</h2>
            <div id="best-score">BEST: 0</div>
            <div id="biome-name">CITY</div>
        </div>
        
        <div class="controls">
            <div class="control-btn btn-left" id="btn-turn"><div><span class="btn-icon">‚Ü©Ô∏è</span><span>Î∞©Ìñ• Ï†ÑÌôò</span></div></div>
            <div class="control-btn btn-right" id="btn-climb"><div><span class="btn-icon">‚¨ÜÔ∏è</span><span>Ïò§Î•¥Í∏∞</span></div></div>
        </div>
    </div>

    <!-- Î©îÎâ¥ ÌôîÎ©¥ -->
    <div id="menu-screen" class="screen active">
        <h1>INFINITE<br>CLIMBER</h1>
        <div class="info-text">PC: Z (Ïò§Î•¥Í∏∞), X (Ï†ÑÌôò) / Î∞©Ìñ•ÌÇ§</div>
        <button class="btn-main" onclick="startGame()">START</button>
        <button class="btn-main btn-green" onclick="openShop(event)">SHOP</button>
        <button class="btn-main btn-sub" onclick="openLeaderboard(event)">RANKING</button>
    </div>

    <!-- ÏÉÅÏ†ê ÌôîÎ©¥ -->
    <div id="shop-screen" class="screen">
        <div class="top-bar" style="width: 100%; box-sizing: border-box;">
            <div class="gold-display">ü™ô <span id="shop-gold">0</span></div>
            <div class="icon-btn" onclick="closeShop(event)">‚úñÔ∏è</div>
        </div>
        <h1>ITEM SHOP</h1>
        <div class="shop-tabs">
            <div class="shop-tab active" onclick="switchShopTab('char')">CHARACTERS</div>
            <div class="shop-tab" onclick="switchShopTab('pet')">PETS</div>
        </div>
        <div class="shop-grid" id="shop-grid"></div>
    </div>

    <!-- Î¶¨ÎçîÎ≥¥Îìú ÌôîÎ©¥ -->
    <div id="leaderboard-screen" class="screen">
        <h1>TOP 50</h1>
        <div id="ranking-loading">Loading...</div>
        <div class="ranking-list" id="ranking-list"></div>
        <button class="btn-main" onclick="closeLeaderboard(event)">CLOSE</button>
    </div>

    <!-- ÏùºÏãúÏ†ïÏßÄ ÌôîÎ©¥ -->
    <div id="pause-screen" class="screen">
        <h1>PAUSED</h1>
        <button class="btn-main" onclick="togglePause(event)">RESUME</button>
    </div>

    <!-- Í≤åÏûÑÏò§Î≤Ñ ÌôîÎ©¥ -->
    <div id="gameover-screen" class="screen">
        <h1 style="color: #ff4757;">GAME OVER</h1>
        <p style="font-size: 1.5rem;">SCORE: <span id="final-score">0</span></p>
        <p style="font-size: 1.2rem; color: #FFD700; margin-bottom: 10px;">+ <span id="earned-gold">0</span> GOLD</p>
        
        <div id="checking-rank-msg" style="color: #00d2ff; margin: 20px;">Îû≠ÌÇπ ÌôïÏù∏ Ï§ë...</div>

        <!-- Îû≠ÌÇπ Îì±Î°ù ÏòÅÏó≠ (50ÏúÑ Ïïà) -->
        <div id="rank-register-area" class="rank-input-area">
            <div class="rank-msg highlight">Ï∂ïÌïòÌï©ÎãàÎã§! TOP 50 ÏßÑÏûÖ!</div>
            <input type="text" id="rank-name-input" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†• (ÏµúÎåÄ 8Ïûê)" maxlength="8">
            <button class="btn-main" onclick="submitScore()">Îì±Î°ùÌïòÍ∏∞</button>
            <button class="btn-main btn-sub" onclick="startGame()">RETRY</button>
        </div>

        <!-- Ïû¨ÏãúÎèÑ ÏòÅÏó≠ (ÏàúÏúÑ Î∞ñ or Îì±Î°ù ÌõÑ) -->
        <div id="retry-area" class="retry-area">
            <div class="rank-msg" id="out-of-rank-msg">ÏàúÏúÑ Î∞ñÏûÖÎãàÎã§</div>
            <button class="btn-main" onclick="startGame()">RETRY</button>
            <button class="btn-main btn-green" onclick="openShop(event)">SHOP</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // --- ÏÉÅÏàò Ï†ïÏùò ---
    const STAIR_WIDTH = 100;
    const STAIR_HEIGHT = 60;
    const STAIR_DEPTH = 40;
    const PLAYER_SIZE = 60;

    // --- ÏïÑÏù¥ÌÖú Îç∞Ïù¥ÌÑ∞ ---
    const CHARACTERS = {
        'default': { name: 'ÌöåÏÇ¨Ïõê', price: 0, stats: { maxStamina: 0, recovery: 0, goldMult: 0 }, desc: 'ÌèâÎ≤îÌïòÎã§.' },
        'ninja': { name: 'ÎãåÏûê', price: 500, stats: { maxStamina: 0, recovery: 2, goldMult: 0 }, desc: 'ÌöåÎ≥µÎ†• +2' },
        'robot': { name: 'Î°úÎ¥á', price: 1000, stats: { maxStamina: 20, recovery: 0, goldMult: 0 }, desc: 'ÏµúÎåÄÏ≤¥Î†• +20' },
        'wizard': { name: 'ÎßàÎ≤ïÏÇ¨', price: 1200, stats: { maxStamina: -10, recovery: 1, goldMult: 0.5 }, desc: 'Í≥®Îìú +50% / ÌöåÎ≥µ +1' },
        'viking': { name: 'Î∞îÏù¥ÌÇπ', price: 1500, stats: { maxStamina: 30, recovery: -1, goldMult: 0 }, desc: 'Ï≤¥Î†• +30 / ÌöåÎ≥µ -1' },
        'rich': { name: 'ÎßåÏàòÎ•¥', price: 2000, stats: { maxStamina: -10, recovery: 0, goldMult: 1 }, desc: 'Í≥®Îìú +100% / Ï≤¥Î†• -10' },
        'alien': { name: 'Ïô∏Í≥ÑÏù∏', price: 2500, stats: { maxStamina: 10, recovery: 3, goldMult: 0 }, desc: 'ÌöåÎ≥µÎ†• +3 / Ï≤¥Î†• +10' }
    };
    const PETS = {
        'none': { name: 'ÏóÜÏùå', price: 0, stats: { maxStamina: 0, recovery: 0, goldMult: 0 }, desc: '' },
        'slime': { name: 'Ïä¨ÎùºÏûÑ', price: 300, stats: { maxStamina: 5, recovery: 0, goldMult: 0 }, desc: 'ÏµúÎåÄÏ≤¥Î†• +5' },
        'cat': { name: 'Í≥†ÏñëÏù¥', price: 500, stats: { maxStamina: 0, recovery: 0, goldMult: 0.2 }, desc: 'Í≥®Îìú +20%' },
        'dog': { name: 'Í∞ïÏïÑÏßÄ', price: 600, stats: { maxStamina: 5, recovery: 0.5, goldMult: 0 }, desc: 'Ï≤¥Î†•+5 / ÌöåÎ≥µ+0.5' },
        'ghost': { name: 'Ïú†Î†π', price: 800, stats: { maxStamina: 0, recovery: 1, goldMult: 0 }, desc: 'ÌöåÎ≥µÎ†• +1' },
        'pig': { name: 'Ìô©Í∏àÎèºÏßÄ', price: 1500, stats: { maxStamina: 0, recovery: 0, goldMult: 0.5 }, desc: 'Í≥®Îìú +50%' },
        'dragon': { name: 'ÎìúÎûòÍ≥§', price: 3000, stats: { maxStamina: 10, recovery: 1, goldMult: 0.2 }, desc: 'All Stat Up' }
    };

    // --- Î∞îÏù¥Ïò¥ Îç∞Ïù¥ÌÑ∞ ---
    const BIOMES = {
        CITY: { name: 'CITY', start: 0, top: '#a8e6cf', side: '#56ab91', bgTop: '#1a1a2e', bgBot: '#16213e', particle: 'STAR' },
        SNOW: { name: 'FROZEN', start: 50, top: '#dff9fb', side: '#c7ecee', bgTop: '#7ed6df', bgBot: '#22a6b3', particle: 'SNOW' },
        VOLCANO: { name: 'INFERNO', start: 100, top: '#30336b', side: '#130f40', bgTop: '#eb4d4b', bgBot: '#5333ed', particle: 'EMBER' },
        SPACE: { name: 'GALAXY', start: 150, top: '#00d2ff', side: '#3a0ca3', bgTop: '#000000', bgBot: '#2c003e', particle: 'HYPER' }
    };

    function getBiome(currentScore) {
        if (currentScore >= 150) return BIOMES.SPACE;
        if (currentScore >= 100) return BIOMES.VOLCANO;
        if (currentScore >= 50) return BIOMES.SNOW;
        return BIOMES.CITY;
    }

    // --- Î≥ÄÏàò ÏÑ†Ïñ∏ ---
    let gameState = 'MENU';
    let isPaused = false;
    let isSoundOn = true;
    let score = 0;
    let combo = 0;
    let stamina = 100;
    let isGameLoopRunning = false;
    let currentBiome = 'CITY';
    let tutorialStep = 0;
    let lastInputTime = 0;
    let lastTouchTime = 0;
    let isKeyDown = false;
    window.isTypingName = false;

    // RPG ÏöîÏÜå Î≥ÄÏàò
    let earnedGoldInGame = 0;
    let maxStamina = 100;
    let staminaDrainRate = 0.5; 
    let staminaRecov = 3; 
    let goldMult = 1;
    let bestScore = parseInt(localStorage.getItem('infiniteClimberGodBest')) || 0;

    let UserData = {
        gold: 0,
        ownedChars: ['default'],
        ownedPets: ['none'],
        equipChar: 'default',
        equipPet: 'none'
    };

    let particles = [];
    let bgParticles = [];
    let stairs = [];
    let player = { x: 0, y: 0, index: 0, direction: 1, animY: 0, scaleY: 1 };
    let pet = { x: 0, y: 0, yOffset: 0 };
    let trail = [];
    let camera = { x: 0, y: 0, shake: 0 };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });

    // --- Firebase & Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ ---
    const firebaseConfig = {
        apiKey: "AIzaSyBUGN1Zlpk-Avfu-5s4G6qQrSfMaq_QXhw",
        authDomain: "distancegame-f4bba.firebaseapp.com",
        projectId: "distancegame-f4bba",
        storageBucket: "distancegame-f4bba.firebasestorage.app",
        messagingSenderId: "180425278674",
        appId: "1:180425278674:web:af07ce51992cb622fc990b"
    };

    const FB = {
        app: null, auth: null, db: null, user: null, isInitialized: false,
        collectionName: 'scores_infinite_climber',

        init: async function() {
            try {
                this.app = initializeApp(firebaseConfig);
                this.auth = getAuth(this.app);
                this.db = getFirestore(this.app);
                await signInAnonymously(this.auth);
                onAuthStateChanged(this.auth, async (user) => {
                    this.user = user;
                    this.isInitialized = true;
                    if(user) await this.loadUserData();
                });
            } catch (e) { console.error("FB Error", e); }
        },

        // Ïú†Ï†Ä Îç∞Ïù¥ÌÑ∞ (Í≥®Îìú/ÏïÑÏù¥ÌÖú)
        loadUserData: async function() {
            const localData = JSON.parse(localStorage.getItem('ic_user_data'));
            if (localData) {
                UserData = { ...UserData, ...localData };
                updateGoldUI();
            }
            if (this.user && this.db) {
                try {
                    const docRef = doc(this.db, "users_infinite_climber", this.user.uid);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const serverData = docSnap.data();
                        if (serverData.gold > UserData.gold) {
                            UserData = { ...UserData, ...serverData };
                            this.saveLocal();
                            updateGoldUI();
                        }
                    }
                } catch(e) {}
            }
        },
        saveUserData: async function() {
            this.saveLocal();
            if (this.user && this.db) {
                try {
                    await setDoc(doc(this.db, "users_infinite_climber", this.user.uid), UserData);
                } catch(e) {}
            }
        },
        saveLocal: function() {
            localStorage.setItem('ic_user_data', JSON.stringify(UserData));
        },

        // Îû≠ÌÇπ
        saveScore: async function(name, score) {
            if (!this.db || !this.user) return false;
            try {
                const colRef = collection(this.db, this.collectionName);
                await addDoc(colRef, { name, score, userId: this.user.uid, timestamp: Date.now() });
                return true;
            } catch (e) { return false; }
        },
        getTopScores: async function(limitCount = 50) {
            if (!this.db) return [];
            try {
                const colRef = collection(this.db, this.collectionName);
                const q = query(colRef, orderBy("score", "desc"), limit(limitCount));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => doc.data());
            } catch (e) { return []; }
        },
        checkIfRanked: async function(myScore) {
            if (!this.isInitialized) return false;
            const top50 = await this.getTopScores(50);
            if (top50.length < 50) return true;
            const lastScore = top50[top50.length - 1].score;
            return myScore > lastScore;
        }
    };
    FB.init();

    // --- UI Ìï®ÏàòÎì§ ---
    const updateGoldUI = () => {
        document.getElementById('ui-gold').innerText = UserData.gold;
        document.getElementById('shop-gold').innerText = UserData.gold;
    };
    const showNoti = (msg) => {
        const n = document.getElementById('notification');
        n.innerText = msg; n.style.opacity = 1;
        setTimeout(() => n.style.opacity = 0, 1500);
    };

    // ÏÉÅÏ†ê Î°úÏßÅ
    let currentShopTab = 'char';
    window.openShop = (e) => {
        if(e) e.stopPropagation();
        // Í≤åÏûÑ Ï§ëÏù¥Î©¥ ÏûêÎèôÏúºÎ°ú ÏùºÏãúÏ†ïÏßÄ (PAUSED ÌôîÎ©¥ ÏóÜÏù¥ Î°úÏßÅÎßå Ï†ïÏßÄ)
        if (gameState === 'PLAYING') {
            isPaused = true;
        }
        document.getElementById('shop-screen').classList.add('active');
        renderShop();
    };
    window.closeShop = (e) => {
        if(e) e.stopPropagation();
        document.getElementById('shop-screen').classList.remove('active');
        // Ï∞Ω Îã´ÏúºÎ©¥ Í≤åÏûÑ Ïû¨Í∞ú
        if (gameState === 'PLAYING') {
            isPaused = false;
        }
    }
    window.switchShopTab = (tab) => {
        currentShopTab = tab;
        document.querySelectorAll('.shop-tab').forEach(el => el.classList.remove('active'));
        document.querySelector(`.shop-tab[onclick="switchShopTab('${tab}')"]`).classList.add('active');
        renderShop();
    };
    const renderShop = () => {
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = '';
        const items = currentShopTab === 'char' ? CHARACTERS : PETS;
        const ownedList = currentShopTab === 'char' ? UserData.ownedChars : UserData.ownedPets;
        const equipped = currentShopTab === 'char' ? UserData.equipChar : UserData.equipPet;

        for (const [id, data] of Object.entries(items)) {
            const isOwned = ownedList.includes(id);
            const isEquipped = equipped === id;
            const div = document.createElement('div');
            div.className = `shop-item ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`;
            
            // ÎØ∏Î¶¨Î≥¥Í∏∞ Ï∫îÎ≤ÑÏä§
            const cvs = document.createElement('canvas');
            cvs.width = 60; cvs.height = 60;
            const cctx = cvs.getContext('2d');
            cctx.translate(30, 50);
            cctx.scale(1.5, 1.5);
            if(currentShopTab === 'char') drawCharacterSprite(cctx, id, 0, 0, 1, 1);
            else drawPetSprite(cctx, id, 0, 0, 0);
            
            let btnHtml = '';
            if (isEquipped) btnHtml = `<button class="btn-buy" disabled>Ïû•Ï∞© Ï§ë</button>`;
            else if (isOwned) btnHtml = `<button class="btn-buy" onclick="equipItem('${id}')" style="background:#2ecc71; color:white;">Ïû•Ï∞©</button>`;
            else btnHtml = `<button class="btn-buy" onclick="buyItem('${id}')" style="background:#FF4500; color:white;">${data.price} G</button>`;

            div.innerHTML = `<div class="item-name">${data.name}</div><div class="item-stats">${data.desc || 'Îä•Î†• ÏóÜÏùå'}</div>${btnHtml}`;
            div.prepend(cvs);
            grid.appendChild(div);
        }
    };
    window.buyItem = (id) => {
        const items = currentShopTab === 'char' ? CHARACTERS : PETS;
        const item = items[id];
        if (UserData.gold >= item.price) {
            UserData.gold -= item.price;
            if (currentShopTab === 'char') UserData.ownedChars.push(id);
            else UserData.ownedPets.push(id);
            Sound.play('coin'); showNoti("Íµ¨Îß§ ÏôÑÎ£å!");
            FB.saveUserData(); updateGoldUI(); renderShop();
        } else { showNoti("Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!"); }
    };
    window.equipItem = (id) => {
        if (currentShopTab === 'char') UserData.equipChar = id;
        else UserData.equipPet = id;
        FB.saveUserData(); renderShop(); showNoti("Ïû•Ï∞© ÏôÑÎ£å!");
    };

    // Îû≠ÌÇπ Î°úÏßÅ UI
    window.openLeaderboard = async function(e) {
        if(e) e.stopPropagation();
        // Í≤åÏûÑ Ï§ëÏù¥Î©¥ ÏûêÎèôÏúºÎ°ú ÏùºÏãúÏ†ïÏßÄ (PAUSED ÌôîÎ©¥ ÏóÜÏù¥ Î°úÏßÅÎßå Ï†ïÏßÄ)
        if (gameState === 'PLAYING') {
            isPaused = true;
        }
        document.getElementById('leaderboard-screen').classList.add('active');
        document.getElementById('ranking-loading').style.display = 'block';
        document.getElementById('ranking-list').innerHTML = '';
        const scores = await FB.getTopScores(50);
        document.getElementById('ranking-loading').style.display = 'none';
        const listEl = document.getElementById('ranking-list');
        if (scores.length === 0) { listEl.innerHTML = '<div style="text-align:center; padding:20px;">Í∏∞Î°ù ÏóÜÏùå</div>'; return; }
        listEl.innerHTML = scores.map((item, i) => `
            <div class="rank-item">
                <div style="width: 50px;">${i+1}.</div>
                <div style="flex:1;">${item.name}</div>
                <div style="width: 80px; text-align: right;">${item.score}</div>
            </div>`).join('');
    };
    window.closeLeaderboard = (e) => {
        if(e) e.stopPropagation();
        document.getElementById('leaderboard-screen').classList.remove('active');
        // Ï∞Ω Îã´ÏúºÎ©¥ Í≤åÏûÑ Ïû¨Í∞ú
        if (gameState === 'PLAYING') {
            isPaused = false;
        }
    }

    window.submitScore = async function() {
        const input = document.getElementById('rank-name-input');
        const name = input.value.trim();
        if (!name) return alert("Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
        
        const btn = document.querySelector('#rank-register-area button');
        btn.disabled = true; btn.innerText = "Ï†ÄÏû• Ï§ë...";

        const success = await FB.saveScore(name, score);
        if (success) {
            document.getElementById('rank-register-area').style.display = 'none';
            document.getElementById('retry-area').style.display = 'flex';
            document.getElementById('out-of-rank-msg').innerText = "Îì±Î°ù ÏôÑÎ£å!";
            document.getElementById('out-of-rank-msg').style.display = 'block';
        } else {
            alert("Ï†ÄÏû• Ïã§Ìå®");
            btn.disabled = false; btn.innerText = "Îì±Î°ùÌïòÍ∏∞";
        }
    };

    window.handleGameOverLogic = async function(finalScore) {
        const checkMsg = document.getElementById('checking-rank-msg');
        const registerArea = document.getElementById('rank-register-area');
        const retryArea = document.getElementById('retry-area');
        const outMsg = document.getElementById('out-of-rank-msg');

        checkMsg.style.display = 'block'; checkMsg.innerText = "Îû≠ÌÇπ ÌôïÏù∏ Ï§ë...";
        registerArea.style.display = 'none'; retryArea.style.display = 'none'; outMsg.style.display = 'block';
        document.getElementById('rank-name-input').value = '';
        document.querySelector('#rank-register-area button').disabled = false;
        document.querySelector('#rank-register-area button').innerText = "Îì±Î°ùÌïòÍ∏∞";

        const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("TIMEOUT")), 3000));

        try {
            const isRanked = await Promise.race([FB.checkIfRanked(finalScore), timeoutPromise]);
            checkMsg.style.display = 'none';
            if (isRanked) {
                registerArea.style.display = 'flex';
                setTimeout(() => { document.getElementById('rank-name-input')?.focus(); }, 100);
            } else {
                outMsg.innerText = "ÏàúÏúÑ Î∞ñÏûÖÎãàÎã§ (Top 50)";
                retryArea.style.display = 'flex';
            }
        } catch (e) {
            checkMsg.style.display = 'block';
            checkMsg.innerText = e.message === "TIMEOUT" ? "ÏÑúÎ≤Ñ ÏùëÎãµ ÏßÄÏó∞" : "Îû≠ÌÇπ ÏÑúÎ≤Ñ Ïó∞Í≤∞ Î∂àÍ∞Ä";
            retryArea.style.display = 'flex'; outMsg.style.display = 'none';
        }
    };

    // --- Í≤åÏûÑ Î°úÏßÅ ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    const Sound = {
        init: function() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); },
        play: function(type) {
            if (!isSoundOn || !audioCtx) return;
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if (type === 'step') {
                osc.type = 'square'; osc.frequency.setValueAtTime(300 + Math.min(combo, 50)*10, now);
                osc.frequency.exponentialRampToValueAtTime(600, now+0.08); gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now+0.08); osc.start(now); osc.stop(now+0.08);
            } else if (type === 'coin') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(1000, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.15);
                osc.start(now); osc.stop(now+0.15);
            } else if (type === 'perfect') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now+0.1); gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now+0.2); osc.start(now); osc.stop(now+0.2);
            } else if (type === 'gameover') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(50, now+0.5); gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now+0.5); osc.start(now); osc.stop(now+0.5);
            }
        }
    };

    function triggerHaptic(d) { if(navigator.vibrate) navigator.vibrate(d); }

    window.startGame = () => {
        Sound.init();
        const cStat = CHARACTERS[UserData.equipChar].stats;
        const pStat = PETS[UserData.equipPet].stats;
        maxStamina = 100 + cStat.maxStamina + pStat.maxStamina;
        staminaRecov = 3 + cStat.recovery + pStat.recovery; 
        goldMult = 1 + cStat.goldMult + pStat.goldMult;

        stamina = maxStamina;
        score = 0; combo = 0; earnedGoldInGame = 0;
        staminaDrainRate = 0.5;
        isPaused = false;
        
        stairs = []; particles = []; trail = [];
        player = { x: 0, y: 0, index: 0, direction: 1, animY: 0, scaleY: 1 };
        pet = { x: 0, y: 0, yOffset: 0 };
        camera.y = -200;
        
        stairs.push({ x: 0, y: 0, direction: 1, colorTop: '#fff', colorSide: '#ccc', hasCoin: false, coinRotate: 0 });
        for(let i=0; i<30; i++) createStair(stairs[stairs.length-1]);
        
        gameState = 'PLAYING';
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        updateTutorialUI();
        if(!isGameLoopRunning) { isGameLoopRunning = true; gameLoop(); }
    };

    function createStair(prev) {
        let dir = prev.direction;
        let turnProb = 0.2 + (Math.min(score, 100)/100)*0.3;
        if(stairs.length > 2 && Math.random() < turnProb) dir *= -1;
        
        const biome = getBiome(score);
        const hasCoin = Math.random() < 0.15; 
        stairs.push({
            x: prev.x + dir * STAIR_WIDTH * 0.8,
            y: prev.y - STAIR_HEIGHT,
            direction: dir,
            colorTop: biome.top, colorSide: biome.side,
            hasCoin: hasCoin, coinRotate: 0
        });
    }

    function handleInput(action) {
        if (gameState !== 'PLAYING' || isPaused) return;
        Sound.init();
        const now = Date.now();
        const delta = now - lastInputTime;
        lastInputTime = now;

        const curr = stairs[player.index];
        const next = stairs[player.index + 1];
        const reqDir = next.x > curr.x ? 1 : -1;
        
        let success = false;
        if (action === 'climb' && player.direction === reqDir) success = true;
        else if (action === 'turn' && player.direction !== reqDir) { player.direction *= -1; success = true; }

        if (success) {
            triggerHaptic(10);
            if(tutorialStep < 3) { tutorialStep++; updateTutorialUI(); }
            
            let isPerfect = false;
            if(score > 1 && delta < 200 && delta > 50) {
                isPerfect = true;
                showFloatingText(player.x, player.y - 120, "PERFECT!", "#00d2ff");
                Sound.play('perfect');
                score += 2;
            }

            if(combo > 5) {
                trail.push({x: player.x, y: player.y, direction: player.direction, alpha: 0.6});
                if(trail.length > 5) trail.shift();
            }

            player.index++;
            player.x = next.x; player.y = next.y;
            
            if(next.hasCoin) {
                const amount = Math.floor(3 * goldMult);
                earnedGoldInGame += amount;
                score += 3;
                next.hasCoin = false;
                Sound.play('coin');
                showFloatingText(player.x, player.y - 80, `+${amount} G`, "#FFD700");
            } else if(!isPerfect) score++;

            combo++;
            stamina = Math.min(maxStamina, stamina + staminaRecov + (combo > 10 ? 2 : 0));
            staminaDrainRate = 0.5 + (score * 0.002);
            
            if(!isPerfect) Sound.play('step');
            player.scaleY = 0.6; player.animY = -10;
            createParticles(player.x, player.y, next.colorTop);
            
            const newBiome = getBiome(score);
            if(newBiome.name !== currentBiome) {
                currentBiome = newBiome.name;
                document.getElementById('biome-name').innerText = newBiome.name;
                showFloatingText(player.x, player.y - 150, newBiome.name + " ZONE!", "#fff");
            }

            createStair(stairs[stairs.length-1]);
            if(stairs.length > 80) { stairs.shift(); player.index--; }
            if(combo % 10 === 0) showComboText(combo);

        } else {
            gameOver();
        }
    }

    function gameOver() {
        if(gameState === 'GAMEOVER') return; // Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
        gameState = 'GAMEOVER';
        triggerHaptic(200); camera.shake = 20; Sound.play('gameover');
        
        UserData.gold += earnedGoldInGame;
        FB.saveUserData();
        updateGoldUI();

        if (score > bestScore) {
            bestScore = score;
            localStorage.setItem('infiniteClimberGodBest', bestScore);
            document.getElementById('best-score').innerText = `BEST: ${bestScore}`;
        }
        document.getElementById('final-score').innerText = score;
        document.getElementById('earned-gold').innerText = earnedGoldInGame;
        
        document.getElementById('gameover-screen').classList.add('active');
        window.handleGameOverLogic(score);
    }

    function update() {
        if(isPaused) return;

        if(gameState === 'PLAYING') {
            stamina -= staminaDrainRate;
            if(stamina <= 0) { 
                stamina = 0; 
                gameOver(); 
                return; // Ï§ëÏöî: Í≤åÏûÑ Ïò§Î≤Ñ Ïãú Ï¶âÏãú Î¶¨ÌÑ¥
            }
            player.scaleY += (1 - player.scaleY) * 0.2;
            player.animY *= 0.8;
            const tPetX = player.x + (player.direction === 1 ? -40 : 40);
            const tPetY = player.y - 20;
            pet.x += (tPetX - pet.x) * 0.05; pet.y += (tPetY - pet.y) * 0.05;
        }
        
        const tY = player.y - canvas.height * 0.7;
        const tX = player.x - canvas.width / 2;
        camera.y += (tY - camera.y) * 0.1;
        camera.x += (tX - camera.x) * 0.1;
        
        if(camera.shake > 0) { camera.shake *= 0.9; if(camera.shake < 0.5) camera.shake = 0; }

        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            if(p.isText) { p.y += p.vy; p.life -= 0.02; }
            else { p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.05; }
            if(p.life <= 0) particles.splice(i, 1);
        }
        const biome = getBiome(score);
        bgParticles.forEach(p => {
            if(biome.particle === 'SNOW') { p.y += p.speed; p.x += Math.sin(p.y*0.01)*0.5; }
            else if(biome.particle === 'EMBER') { p.y -= p.speed; }
            else if(biome.particle === 'HYPER') { p.y += p.speed * 5; }
            else { p.y += p.speed * 0.5; }
            if(p.y > canvas.height) p.y = 0; if(p.y < 0) p.y = canvas.height;
        });
        
        for(let i=trail.length-1; i>=0; i--) { trail[i].alpha -= 0.05; if(trail[i].alpha <= 0) trail.splice(i,1); }
        stairs.forEach(s => { if(s.hasCoin) s.coinRotate += 0.1; });

        document.getElementById('score').innerText = score;
        const bar = document.getElementById('stamina-bar');
        bar.style.width = `${(stamina/maxStamina)*100}%`;
        bar.style.background = stamina < 30 ? '#ff4757' : 'linear-gradient(90deg, #00f260, #0575e6)';
    }

    function draw() {
        if(canvas.width !== window.innerWidth) { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initBackgroundParticles(); }
        const biome = getBiome(score);
        const grad = ctx.createLinearGradient(0,0,0,canvas.height);
        grad.addColorStop(0, biome.bgTop); grad.addColorStop(1, biome.bgBot);
        ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width, canvas.height);

        ctx.fillStyle = biome.particle === 'EMBER' ? '#ff4757' : '#fff';
        bgParticles.forEach(p => {
            ctx.globalAlpha = p.alpha * (biome.particle === 'HYPER' ? 0.5 : 0.8);
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        });
        ctx.globalAlpha = 1;

        ctx.save();
        let shakeX = (Math.random()-0.5)*camera.shake;
        let shakeY = (Math.random()-0.5)*camera.shake;
        ctx.translate(-camera.x + shakeX, -camera.y + shakeY);

        stairs.forEach(s => {
            if(s.y > camera.y + canvas.height + 100 || s.y < camera.y - 100) return;
            ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(s.x, s.y+STAIR_DEPTH+10, STAIR_WIDTH/2, 10, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = s.colorSide; ctx.fillRect(s.x-STAIR_WIDTH/2, s.y, STAIR_WIDTH, STAIR_HEIGHT+STAIR_DEPTH);
            ctx.fillStyle = s.colorTop; ctx.fillRect(s.x-STAIR_WIDTH/2, s.y, STAIR_WIDTH, STAIR_HEIGHT);
            ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillRect(s.x-STAIR_WIDTH/2, s.y, STAIR_WIDTH, 4);
            if(s.hasCoin) {
                const scale = Math.abs(Math.cos(s.coinRotate));
                ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.ellipse(s.x, s.y-30, 15*scale, 15, 0, 0, Math.PI*2); ctx.fill();
            }
        });

        trail.forEach(t => {
            ctx.save(); ctx.globalAlpha = t.alpha;
            drawCharacterSprite(ctx, UserData.equipChar, t.x, t.y, t.direction, 1, true);
            ctx.restore();
        });

        drawPetSprite(ctx, UserData.equipPet, pet.x, pet.y, Date.now());
        drawCharacterSprite(ctx, UserData.equipChar, player.x, player.y + player.animY, player.direction, player.scaleY, false);

        particles.forEach(p => {
            if(p.isText) {
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.font = "bold 30px 'Black Han Sans'"; ctx.fillText(p.text, p.x, p.y);
            } else {
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
            }
        });
        ctx.globalAlpha = 1;
        ctx.restore();
    }

    function drawCharacterSprite(ctx, type, x, y, dir, scaleY, isGhost) {
        ctx.save(); ctx.translate(x, y + STAIR_HEIGHT/2);
        if(dir === -1) ctx.scale(-1, 1);
        ctx.scale(1, scaleY);
        
        if(isGhost) {
            ctx.fillStyle = '#fff';
            ctx.fillRect(-15, -45, 30, 25);
            ctx.beginPath(); ctx.arc(0, -55, 10, 0, Math.PI*2); ctx.fill();
        } else {
            const isRobot = type === 'robot'; const isNinja = type === 'ninja'; const isRich = type === 'rich';
            const isWizard = type === 'wizard'; const isViking = type === 'viking'; const isAlien = type === 'alien';

            if (isWizard) ctx.fillStyle = '#8e44ad';
            else if (isViking) ctx.fillStyle = '#795548';
            else if (isAlien) ctx.fillStyle = '#2ecc71';
            else if (isNinja) ctx.fillStyle = '#333';
            else if (isRich) ctx.fillStyle = '#FFD700';
            else ctx.fillStyle = '#ff4757';
            ctx.beginPath(); ctx.moveTo(-10, -35); ctx.lineTo(-25, -5); ctx.lineTo(0, -5); ctx.fill();

            if (isWizard) ctx.fillStyle = '#2c3e50';
            else if (isViking) ctx.fillStyle = '#a1887f';
            else if (isAlien) ctx.fillStyle = '#95a5a6';
            else if (isRobot) ctx.fillStyle = '#95a5a6';
            else if (isRich) ctx.fillStyle = '#fff';
            else ctx.fillStyle = '#2f3542';
            ctx.fillRect(-15, -40, 30, 25);
            if(isRich) { ctx.fillStyle = 'red'; ctx.fillRect(-2, -38, 4, 15); }

            if (isAlien) ctx.fillStyle = '#2ecc71';
            else if (isRobot) ctx.fillStyle = '#7f8c8d';
            else ctx.fillStyle = '#ffccaa'; 
            ctx.fillRect(-15, -60, 30, 25);

            if (isWizard) { ctx.fillStyle = '#8e44ad'; ctx.beginPath(); ctx.moveTo(-20, -60); ctx.lineTo(20, -60); ctx.lineTo(0, -90); ctx.fill(); }
            if (isViking) { ctx.fillStyle = '#95a5a6'; ctx.fillRect(-16, -65, 32, 10); ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.moveTo(-16, -60); ctx.lineTo(-25, -75); ctx.lineTo(-10, -60); ctx.fill(); ctx.beginPath(); ctx.moveTo(16, -60); ctx.lineTo(25, -75); ctx.lineTo(10, -60); ctx.fill(); }
            if (isAlien) { ctx.fillStyle = 'black'; ctx.beginPath(); ctx.ellipse(-5, -50, 4, 6, -0.2, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(8, -50, 4, 6, 0.2, 0, Math.PI*2); ctx.fill(); }
            else if (isNinja) { ctx.fillStyle = '#2c3e50'; ctx.fillRect(-15, -60, 30, 12); ctx.fillRect(-15, -40, 30, 12); }
            else if (isRobot) { ctx.fillStyle = '#e74c3c'; ctx.fillRect(-10, -55, 20, 5); }
            else if (isRich) { ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, -65, 16, 0, Math.PI, true); ctx.fill(); }
            else { ctx.fillStyle = 'black'; ctx.fillRect(5, -50, 4, 4); }

            ctx.fillStyle = (isRobot || isAlien) ? '#95a5a6' : 'black'; ctx.fillRect(-10, -15, 8, 20); ctx.fillRect(2, -15, 8, 20);
            if (isWizard) ctx.fillStyle = '#2c3e50';
            else if (isViking) ctx.fillStyle = '#a1887f';
            else if (isAlien) ctx.fillStyle = '#95a5a6';
            else if (isRobot) ctx.fillStyle = '#95a5a6';
            else if (isRich) ctx.fillStyle = '#fff';
            else ctx.fillStyle = '#2f3542';
            ctx.fillRect(5, -35, 10, 8);

            if(stamina < 30) { ctx.fillStyle = '#00a8ff'; ctx.beginPath(); ctx.arc(-20, -60, 4, 0, Math.PI*2); ctx.fill(); }
        }
        ctx.restore();
    }

    function drawPetSprite(ctx, type, x, y, time) {
        if(type === 'none') return;
        const floatY = Math.sin(time * 0.005) * 5;
        ctx.save(); ctx.translate(x, y + floatY + STAIR_HEIGHT/2 - 40);
        if (type === 'slime') {
            ctx.fillStyle = '#2ecc71'; ctx.beginPath(); ctx.arc(0, 0, 10, Math.PI, 0); ctx.fill(); ctx.fillRect(-10, 0, 20, 10);
            ctx.fillStyle = 'black'; ctx.fillRect(-4, 0, 2, 2); ctx.fillRect(4, 0, 2, 2);
        } else if (type === 'ghost') {
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(-4, -2, 2, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(4, -2, 2, 0, Math.PI*2); ctx.fill();
        } else if (type === 'pig') {
            ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.ellipse(0, 0, 14, 10, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#e67e22'; ctx.fillRect(-12, -8, 6, 6); ctx.fillRect(6, -8, 6, 6);
            ctx.fillStyle = 'pink'; ctx.beginPath(); ctx.ellipse(0, 2, 4, 3, 0, 0, Math.PI*2); ctx.fill();
        } else if (type === 'cat') {
            ctx.fillStyle = '#ecf0f1'; ctx.beginPath(); ctx.ellipse(0, 0, 12, 10, 0, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.moveTo(-8, -6); ctx.lineTo(-12, -14); ctx.lineTo(-4, -8); ctx.fill(); 
            ctx.beginPath(); ctx.moveTo(8, -6); ctx.lineTo(12, -14); ctx.lineTo(4, -8); ctx.fill(); 
            ctx.fillStyle = 'pink'; ctx.beginPath(); ctx.ellipse(0, 1, 2, 1.5, 0, 0, Math.PI*2); ctx.fill();
        } else if (type === 'dog') {
            ctx.fillStyle = '#d35400'; ctx.beginPath(); ctx.ellipse(0, 0, 12, 10, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#a04000'; ctx.beginPath(); ctx.ellipse(-10, -2, 4, 6, 0.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(10, -2, 4, 6, -0.5, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black'; ctx.beginPath(); ctx.ellipse(0, 1, 3, 2, 0, 0, Math.PI*2); ctx.fill();
        } else if (type === 'dragon') {
            ctx.fillStyle = '#e74c3c'; ctx.beginPath(); ctx.ellipse(0, 0, 14, 10, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#c0392b'; ctx.beginPath(); ctx.moveTo(-8, -2); ctx.lineTo(-18, -12); ctx.lineTo(-8, -8); ctx.fill();
            ctx.beginPath(); ctx.moveTo(8, -2); ctx.lineTo(18, -12); ctx.lineTo(8, -8); ctx.fill();
            ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.moveTo(-4, -8); ctx.lineTo(-6, -14); ctx.lineTo(-2, -8); ctx.fill();
            ctx.beginPath(); ctx.moveTo(4, -8); ctx.lineTo(6, -14); ctx.lineTo(2, -8); ctx.fill();
        }
        ctx.restore();
    }

    function gameLoop() {
        if (gameState === 'PLAYING' || gameState === 'GAMEOVER') { update(); draw(); requestAnimationFrame(gameLoop); }
        else {
            const biome = getBiome(score);
            bgParticles.forEach(p => { p.y += p.speed; if (p.y > canvas.height) p.y = 0; });
            draw(); requestAnimationFrame(gameLoop);
        }
    }

    // Ìó¨Ìçº
    function createParticles(x, y, color) { for(let i=0; i<8; i++) particles.push({x, y, vx:(Math.random()-0.5)*10, vy:(Math.random()-1)*10, life:1.0, color, size:Math.random()*6+2}); }
    function showFloatingText(x, y, text, color) { particles.push({x, y, vx:0, vy:-2, life:1.5, text, color, isText:true}); }
    function showComboText(val) { const t = document.getElementById('combo-text'); t.innerText=val+" COMBO!"; t.style.transform='translate(-50%,-50%) scale(1.5)'; t.style.opacity=1; setTimeout(()=>t.style.transform='translate(-50%,-50%) scale(0)',500); }
    function updateTutorialUI() {
        const left=document.getElementById('tutorial-hand-left'), right=document.getElementById('tutorial-hand-right');
        left.style.display='none'; right.style.display='none';
        if(tutorialStep >= 3 || gameState !== 'PLAYING') return;
        const cur=stairs[player.index], nxt=stairs[player.index+1];
        if(!nxt) return;
        const reqDir = nxt.x > cur.x ? 1 : -1;
        if(player.direction === reqDir) right.style.display='block'; else left.style.display='block';
    }
    function initBackgroundParticles() { bgParticles=[]; for(let i=0;i<60;i++) bgParticles.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, size:Math.random()*3+1, speed:Math.random()+0.5, alpha:Math.random()}); }

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    document.getElementById('rank-name-input').addEventListener('focus', ()=>window.isTypingName=true);
    document.getElementById('rank-name-input').addEventListener('blur', ()=>window.isTypingName=false);
    window.togglePause = (e) => { 
        if(e) e.stopPropagation();
        if(gameState==='PLAYING') { isPaused=!isPaused; document.getElementById('pause-screen').classList.toggle('active', isPaused); } 
    };
    window.toggleSound = (e) => { 
        if(e) e.stopPropagation();
        isSoundOn=!isSoundOn; document.getElementById('sound-btn').innerText=isSoundOn?"üîä":"üîá"; 
    };
    
    // Î≤ÑÌäº Îì±Î°ù
    function regBtn(id, action) {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e)=>{ e.preventDefault(); e.stopPropagation(); lastTouchTime=Date.now(); handleInput(action); }, {passive:false});
        el.addEventListener('mousedown', (e)=>{ e.preventDefault(); if(Date.now()-lastTouchTime<500)return; handleInput(action); });
    }
    regBtn('btn-turn', 'turn'); regBtn('btn-climb', 'climb');
    document.addEventListener('keydown', (e)=>{
        if(e.code==='Escape') window.togglePause();
        if(window.isTypingName) return;
        if(gameState!=='PLAYING' || isPaused || isKeyDown) return;
        if(e.code==='ArrowRight'||e.code==='KeyZ') { isKeyDown=true; handleInput('climb'); }
        if(e.code==='ArrowLeft'||e.code==='KeyX') { isKeyDown=true; handleInput('turn'); }
    });
    document.addEventListener('keyup', ()=>isKeyDown=false);

    window.onload = () => { resize(); if(!isGameLoopRunning) { isGameLoopRunning=true; gameLoop(); } };
    window.addEventListener('resize', resize);

    // --- resize Ìï®Ïàò Ï∂îÍ∞Ä (ReferenceError Ìï¥Í≤∞) ---
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        initBackgroundParticles();
        if(gameState === 'MENU') draw();
    }

</script>
</body>
</html>
