<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>심플 스도쿠 v1.0 (Simple Sudoku v1.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; touch-action: manipulation; }
        .cell-content { pointer-events: none; }
        .no-select { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* --- Animations --- */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
        .animate-pop {
            animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50 !important;
            position: relative;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }
        /* 오답 시 강제 붉은 배경 적용 */
        .animate-shake {
            animation: shake 0.4s ease-in-out;
            background-color: #fee2e2 !important; /* Red-100 */
            color: #dc2626 !important; /* Red-600 */
            z-index: 50 !important;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Ripple Effect */
        @keyframes ripple-anim {
            0% { transform: translate(-50%, -50%) scale(0.2); opacity: 0.6; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }
        .click-ripple {
            position: fixed;
            width: 30px;
            height: 30px;
            background: rgba(59, 130, 246, 0.4); 
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            animation: ripple-anim 0.6s ease-out forwards;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="transition-colors duration-300 min-h-screen flex flex-col items-center py-6 px-2 overflow-x-hidden">

    <!-- App Container -->
    <div id="app" class="w-full max-w-lg flex flex-col gap-4 relative z-10">
        <!-- Header -->
        <div class="flex justify-between items-center">
            <h1 id="game-title" class="text-3xl font-bold">심플 스도쿠 v1.0</h1>
            <div class="flex gap-2">
                <button id="btn-fullscreen" class="p-2 rounded-lg transition-all" title="전체 화면">
                    <i data-lucide="maximize" class="w-6 h-6"></i>
                </button>
                <button id="btn-scoreboard" class="p-2 rounded-lg transition-all" title="기록 보기">
                    <i data-lucide="trophy" class="w-6 h-6"></i>
                </button>
                <button id="btn-settings" class="p-2 rounded-lg transition-all" title="설정 / 테마">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-panel" class="hidden w-full p-4 rounded-xl shadow-lg border mb-2 animate-fade-in bg-white/95 backdrop-blur z-20">
            <div class="flex justify-between items-center mb-4 pb-2 border-b">
                <span class="font-bold text-lg">설정</span>
                <button id="btn-close-settings" class="p-1 hover:bg-black/10 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex flex-col gap-3 mb-6">
                <!-- Sound Toggle -->
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i data-lucide="volume-2" class="w-5 h-5 text-slate-500"></i>
                        <span class="font-medium">사운드 효과</span>
                    </div>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="toggle-sound" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 checked:left-6"/>
                        <label for="toggle-sound" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                    </div>
                </div>
                <!-- Effect Toggle -->
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-5 h-5 text-slate-500"></i>
                        <span class="font-medium">시각 이펙트</span>
                    </div>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="toggle-effect" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 checked:left-6"/>
                        <label for="toggle-effect" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                    </div>
                </div>
                <!-- Initial BG Toggle -->
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i data-lucide="paint-bucket" class="w-5 h-5 text-slate-500"></i>
                        <span class="font-medium">초기 숫자 배경</span>
                    </div>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="toggle-bg" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 checked:left-6"/>
                        <label for="toggle-bg" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                    </div>
                </div>
            </div>

            <div class="mb-2 font-bold text-sm text-slate-500">테마 선택</div>
            <div id="theme-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
        </div>

        <!-- Controls -->
        <div class="flex justify-between items-center gap-2">
            <div class="flex bg-black/5 p-1 rounded-lg" id="grid-size-controls">
                <button data-size="9" class="flex items-center gap-1 px-3 py-1.5 rounded-md text-sm font-bold transition-all">
                    <i data-lucide="grid-3x3" class="w-4 h-4"></i> 9x9
                </button>
                <button data-size="16" class="flex items-center gap-1 px-3 py-1.5 rounded-md text-sm font-bold transition-all">
                    <i data-lucide="grid-2x2" class="w-4 h-4"></i> 16x16
                </button>
            </div>
            <div id="timer-display" class="flex items-center gap-2 font-mono text-lg px-3 py-1 rounded-lg shadow-sm border">
                <i data-lucide="timer" class="w-5 h-5"></i>
                <span>0:00</span>
            </div>
        </div>

        <div id="difficulty-controls" class="flex flex-wrap gap-2 justify-center"></div>

        <!-- Board -->
        <div id="board-container" class="w-full aspect-square relative rounded-xl shadow-2xl overflow-hidden border-4 transition-colors duration-300 bg-white">
            <div id="game-board" class="w-full h-full grid gap-0"></div>
        </div>

        <!-- Footer -->
        <div class="w-full max-w-lg">
            <div class="flex justify-end mb-2">
                <div id="mistake-display" class="flex items-center gap-1 font-bold text-sm px-3 py-1 rounded-full border transition-all">
                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    <span>실수: <span id="mistake-count">0</span>/3</span>
                </div>
            </div>
            <!-- Numpad Grid -->
            <div id="numpad" class="mb-4 transition-all"></div>
            
            <div class="grid grid-cols-2 gap-4 mt-2">
                <button id="btn-note" class="py-3 rounded-xl font-bold shadow-sm transition-all flex items-center justify-center gap-2 border-b-4 active:border-b-0 active:translate-y-1">
                    <i data-lucide="pencil" class="w-5 h-5"></i>
                    <span id="note-text">메모 OFF</span>
                </button>
                <button id="btn-new-game" class="py-3 rounded-xl font-bold shadow-sm border-b-4 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i> 새 게임
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-scoreboard" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in">
        <div id="modal-scoreboard-content" class="rounded-2xl p-6 max-w-md w-full shadow-2xl transform scale-100 transition-colors bg-white max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-yellow-100 rounded-lg"><i data-lucide="crown" class="w-6 h-6 text-yellow-600"></i></div>
                    <h2 class="text-2xl font-bold">명예의 전당</h2>
                </div>
                <button id="btn-close-scoreboard" class="p-2 hover:bg-black/5 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-bold mb-3 flex items-center gap-2"><i data-lucide="grid-3x3" class="w-4 h-4"></i> 9x9 퍼즐</h3>
                    <div class="bg-gray-50 rounded-xl overflow-hidden border">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 text-gray-600 font-medium"><tr><th class="py-3 px-4 text-left">난이도</th><th class="py-3 px-4 text-center">최고 기록</th><th class="py-3 px-4 text-right">클리어</th></tr></thead>
                            <tbody id="score-list-9" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-3 flex items-center gap-2"><i data-lucide="grid-2x2" class="w-4 h-4"></i> 16x16 퍼즐</h3>
                    <div class="bg-gray-50 rounded-xl overflow-hidden border">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 text-gray-600 font-medium"><tr><th class="py-3 px-4 text-left">난이도</th><th class="py-3 px-4 text-center">최고 기록</th><th class="py-3 px-4 text-right">클리어</th></tr></thead>
                            <tbody id="score-list-16" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-win" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
        <div id="modal-win-content" class="rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl transform scale-100 transition-colors">
            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pop"><i data-lucide="trophy" class="w-10 h-10 text-yellow-600"></i></div>
            <h2 class="text-3xl font-bold mb-2">축하합니다!</h2>
            <p class="mb-6 opacity-80"><span class="font-bold" id="win-size">9x9</span> 퍼즐 완성!<br/><span class="font-bold" id="win-diff">초급</span> 난이도<br/>소요 시간: <span class="font-mono font-bold text-blue-500" id="win-time">0:00</span></p>
            <button id="btn-win-restart" class="w-full py-3 rounded-xl font-bold transition-colors text-white">새 게임 시작하기</button>
        </div>
    </div>

    <div id="modal-fail" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
        <div id="modal-fail-content" class="rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl transition-colors">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-shake"><i data-lucide="alert-circle" class="w-10 h-10 text-red-600"></i></div>
            <h2 class="text-2xl font-bold mb-2">게임 오버</h2>
            <p class="mb-6 opacity-80">실수가 3번을 초과했습니다.<br/>다시 도전해보세요!</p>
            <button id="btn-fail-restart" class="w-full py-3 rounded-xl font-bold transition-colors text-white">다시 시작</button>
        </div>
    </div>

    <script>
        const BLANK = 0;
        const STORAGE_KEY_GAME = 'sudoku_gamestate_html_v11';
        const STORAGE_KEY_SETTINGS = 'sudoku_settings_html_v11';
        const STORAGE_KEY_SCORES = 'sudoku_scores_html_v11';

        const THEMES = {
            Classic: { name: '클래식', bg: 'bg-slate-50', textMain: 'text-slate-800', textSub: 'text-slate-500', boardBg: 'bg-slate-800', boardBorder: 'border-slate-800', cellInitial: 'bg-slate-100 text-slate-900', cellSelected: 'bg-blue-500 text-white', cellSame: 'bg-blue-200 text-slate-900', cellError: 'bg-red-100 text-red-600', cellNormal: 'bg-white text-blue-600', cellNote: 'text-slate-500', btnPrimary: 'bg-blue-600 hover:bg-blue-500 text-white border-blue-800', btnActive: 'bg-slate-700 text-white border-slate-900', btnInactive: 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50', numPad: 'bg-white text-slate-700 hover:bg-blue-50 hover:text-blue-600 border-slate-200', eraseBtn: 'bg-red-50 text-red-500 hover:bg-red-100 border-red-200', borderLight: 'border-slate-300', borderHeavy: 'border-slate-800' },
            Dark: { name: '다크', bg: 'bg-slate-900', textMain: 'text-slate-100', textSub: 'text-slate-400', boardBg: 'bg-black', boardBorder: 'border-black', cellInitial: 'bg-slate-800 text-slate-300', cellSelected: 'bg-indigo-600 text-white', cellSame: 'bg-slate-700 text-white', cellError: 'bg-red-900 text-red-200', cellNormal: 'bg-slate-900 text-indigo-300', cellNote: 'text-slate-500', btnPrimary: 'bg-indigo-600 hover:bg-indigo-500 text-white border-indigo-800', btnActive: 'bg-indigo-500 text-white border-indigo-700', btnInactive: 'bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700', numPad: 'bg-slate-800 text-slate-200 hover:bg-indigo-900 hover:text-indigo-200 border-slate-700', eraseBtn: 'bg-red-900/30 text-red-400 hover:bg-red-900/50 border-red-900', borderLight: 'border-slate-700', borderHeavy: 'border-black' },
            Nature: { name: '자연', bg: 'bg-stone-100', textMain: 'text-stone-800', textSub: 'text-stone-500', boardBg: 'bg-stone-800', boardBorder: 'border-stone-800', cellInitial: 'bg-stone-200 text-stone-900', cellSelected: 'bg-emerald-600 text-white', cellSame: 'bg-emerald-200 text-stone-900', cellError: 'bg-orange-100 text-orange-700', cellNormal: 'bg-white text-emerald-700', cellNote: 'text-stone-500', btnPrimary: 'bg-emerald-600 hover:bg-emerald-500 text-white border-emerald-800', btnActive: 'bg-stone-600 text-white border-stone-800', btnInactive: 'bg-white text-stone-600 border-stone-300 hover:bg-stone-50', numPad: 'bg-white text-stone-700 hover:bg-emerald-50 hover:text-emerald-700 border-stone-300', eraseBtn: 'bg-orange-50 text-orange-600 hover:bg-orange-100 border-orange-200', borderLight: 'border-stone-300', borderHeavy: 'border-stone-800' },
            Pink: { name: '핑크', bg: 'bg-rose-50', textMain: 'text-rose-900', textSub: 'text-rose-500', boardBg: 'bg-rose-900', boardBorder: 'border-rose-900', cellInitial: 'bg-rose-100 text-rose-900', cellSelected: 'bg-pink-500 text-white', cellSame: 'bg-pink-200 text-rose-900', cellError: 'bg-red-100 text-red-600', cellNormal: 'bg-white text-pink-600', cellNote: 'text-rose-400', btnPrimary: 'bg-pink-500 hover:bg-pink-400 text-white border-pink-700', btnActive: 'bg-rose-600 text-white border-rose-800', btnInactive: 'bg-white text-rose-500 border-rose-200 hover:bg-rose-50', numPad: 'bg-white text-rose-700 hover:bg-pink-50 hover:text-pink-600 border-rose-200', eraseBtn: 'bg-red-50 text-red-500 hover:bg-red-100 border-red-200', borderLight: 'border-rose-200', borderHeavy: 'border-rose-900' },
            Ocean: { name: '오션', bg: 'bg-cyan-50', textMain: 'text-cyan-900', textSub: 'text-cyan-600', boardBg: 'bg-cyan-900', boardBorder: 'border-cyan-900', cellInitial: 'bg-cyan-100 text-cyan-900', cellSelected: 'bg-cyan-600 text-white', cellSame: 'bg-cyan-200 text-cyan-900', cellError: 'bg-red-100 text-red-600', cellNormal: 'bg-white text-cyan-700', cellNote: 'text-cyan-500', btnPrimary: 'bg-cyan-600 hover:bg-cyan-500 text-white border-cyan-800', btnActive: 'bg-cyan-700 text-white border-cyan-900', btnInactive: 'bg-white text-cyan-600 border-cyan-200 hover:bg-cyan-100', numPad: 'bg-white text-cyan-800 hover:bg-cyan-50 hover:text-cyan-600 border-cyan-200', eraseBtn: 'bg-red-50 text-red-500 hover:bg-red-100 border-red-200', borderLight: 'border-cyan-200', borderHeavy: 'border-cyan-900' },
            Lavender: { name: '라벤더', bg: 'bg-violet-50', textMain: 'text-violet-900', textSub: 'text-violet-500', boardBg: 'bg-violet-900', boardBorder: 'border-violet-900', cellInitial: 'bg-violet-100 text-violet-900', cellSelected: 'bg-violet-500 text-white', cellSame: 'bg-violet-200 text-violet-900', cellError: 'bg-red-100 text-red-600', cellNormal: 'bg-white text-violet-600', cellNote: 'text-violet-400', btnPrimary: 'bg-violet-500 hover:bg-violet-400 text-white border-violet-700', btnActive: 'bg-violet-600 text-white border-violet-800', btnInactive: 'bg-white text-violet-500 border-violet-200 hover:bg-violet-50', numPad: 'bg-white text-violet-700 hover:bg-violet-50 hover:text-violet-600 border-violet-200', eraseBtn: 'bg-red-50 text-red-500 hover:bg-red-100 border-red-200', borderLight: 'border-violet-200', borderHeavy: 'border-violet-900' },
            Mint: { name: '민트', bg: 'bg-teal-50', textMain: 'text-teal-900', textSub: 'text-teal-600', boardBg: 'bg-teal-900', boardBorder: 'border-teal-900', cellInitial: 'bg-teal-100 text-teal-900', cellSelected: 'bg-teal-500 text-white', cellSame: 'bg-teal-200 text-teal-900', cellError: 'bg-red-100 text-red-600', cellNormal: 'bg-white text-teal-600', cellNote: 'text-teal-400', btnPrimary: 'bg-teal-500 hover:bg-teal-400 text-white border-teal-700', btnActive: 'bg-teal-600 text-white border-teal-800', btnInactive: 'bg-white text-teal-500 border-teal-200 hover:bg-teal-50', numPad: 'bg-white text-teal-700 hover:bg-teal-50 hover:text-teal-600 border-teal-200', eraseBtn: 'bg-red-50 text-red-500 hover:bg-red-100 border-red-200', borderLight: 'border-teal-200', borderHeavy: 'border-teal-900' },
            Sunset: { name: '선셋', bg: 'bg-orange-50', textMain: 'text-orange-900', textSub: 'text-orange-600', boardBg: 'bg-orange-900', boardBorder: 'border-orange-900', cellInitial: 'bg-orange-100 text-orange-900', cellSelected: 'bg-orange-500 text-white', cellSame: 'bg-orange-200 text-orange-900', cellError: 'bg-red-100 text-red-600', cellNormal: 'bg-white text-orange-600', cellNote: 'text-orange-400', btnPrimary: 'bg-orange-500 hover:bg-orange-400 text-white border-orange-700', btnActive: 'bg-orange-600 text-white border-orange-800', btnInactive: 'bg-white text-orange-500 border-orange-200 hover:bg-orange-50', numPad: 'bg-white text-orange-700 hover:bg-orange-50 hover:text-orange-600 border-orange-200', eraseBtn: 'bg-red-50 text-red-500 hover:bg-red-100 border-red-200', borderLight: 'border-orange-200', borderHeavy: 'border-orange-900' },
            Midnight: { name: '미드나잇', bg: 'bg-blue-950', textMain: 'text-blue-100', textSub: 'text-blue-400', boardBg: 'bg-black', boardBorder: 'border-black', cellInitial: 'bg-blue-900 text-blue-200', cellSelected: 'bg-blue-600 text-white', cellSame: 'bg-blue-800 text-white', cellError: 'bg-red-900 text-red-200', cellNormal: 'bg-blue-950 text-blue-300', cellNote: 'text-blue-500', btnPrimary: 'bg-blue-600 hover:bg-blue-500 text-white border-blue-800', btnActive: 'bg-blue-500 text-white border-blue-700', btnInactive: 'bg-blue-900 text-blue-300 border-blue-800 hover:bg-blue-800', numPad: 'bg-blue-900 text-blue-200 hover:bg-blue-800 hover:text-white border-blue-800', eraseBtn: 'bg-red-900/40 text-red-400 hover:bg-red-900/60 border-red-900', borderLight: 'border-slate-700', borderHeavy: 'border-black' },
            Cyber: { name: '사이버', bg: 'bg-zinc-950', textMain: 'text-lime-400', textSub: 'text-lime-700', boardBg: 'bg-black', boardBorder: 'border-lime-900', cellInitial: 'bg-zinc-900 text-lime-600', cellSelected: 'bg-lime-600 text-black', cellSame: 'bg-zinc-800 text-lime-400', cellError: 'bg-red-900 text-red-400', cellNormal: 'bg-black text-lime-400', cellNote: 'text-zinc-500', btnPrimary: 'bg-lime-600 hover:bg-lime-500 text-black border-lime-800', btnActive: 'bg-lime-700 text-black border-lime-900', btnInactive: 'bg-black text-lime-600 border-zinc-800 hover:bg-zinc-900', numPad: 'bg-zinc-900 text-lime-500 hover:bg-zinc-800 hover:text-lime-400 border-zinc-800', eraseBtn: 'bg-red-950 text-red-500 hover:bg-red-900 border-red-900', borderLight: 'border-lime-900/30', borderHeavy: 'border-lime-600' },
            Coffee: { name: '커피', bg: 'bg-stone-900', textMain: 'text-amber-100', textSub: 'text-amber-700', boardBg: 'bg-black', boardBorder: 'border-black', cellInitial: 'bg-stone-800 text-stone-400', cellSelected: 'bg-amber-700 text-white', cellSame: 'bg-stone-700 text-amber-100', cellError: 'bg-red-900 text-red-200', cellNormal: 'bg-stone-900 text-amber-200', cellNote: 'text-stone-600', btnPrimary: 'bg-amber-700 hover:bg-amber-600 text-white border-amber-900', btnActive: 'bg-amber-800 text-white border-amber-950', btnInactive: 'bg-stone-800 text-amber-700 border-stone-700 hover:bg-stone-700', numPad: 'bg-stone-800 text-amber-200 hover:bg-stone-700 hover:text-amber-100 border-stone-700', eraseBtn: 'bg-red-900/30 text-red-400 hover:bg-red-900/50 border-red-900', borderLight: 'border-slate-700', borderHeavy: 'border-black' },
            Vampire: { name: '뱀파이어', bg: 'bg-neutral-950', textMain: 'text-red-600', textSub: 'text-red-900', boardBg: 'bg-black', boardBorder: 'border-red-950', cellInitial: 'bg-neutral-900 text-red-800', cellSelected: 'bg-red-700 text-white', cellSame: 'bg-neutral-800 text-red-500', cellError: 'bg-red-950 text-red-400', cellNormal: 'bg-black text-red-600', cellNote: 'text-neutral-600', btnPrimary: 'bg-red-700 hover:bg-red-600 text-white border-red-900', btnActive: 'bg-red-800 text-white border-red-950', btnInactive: 'bg-black text-red-900 border-neutral-900 hover:bg-neutral-900', numPad: 'bg-neutral-900 text-red-600 hover:bg-neutral-800 hover:text-red-500 border-neutral-800', eraseBtn: 'bg-red-950 text-red-500 hover:bg-red-900 border-red-900', borderLight: 'border-red-900/30', borderHeavy: 'border-red-700' }
        };

        const state = {
            themeName: 'Classic',
            gridSize: 9,
            difficulty: 'Easy',
            board: [],
            initialBoard: [],
            solution: [],
            notes: [],
            mistakes: 0,
            timer: 0,
            isWon: false,
            isPaused: false,
            selectedCell: null,
            isNoteMode: false,
            timerInterval: null,
            soundEnabled: true,
            effectEnabled: true,
            showInitialBg: true, 
            lastEffect: { row: null, col: null, type: null }
        };

        const scores = {
            9: { Easy: { time: null, wins: 0 }, Medium: { time: null, wins: 0 }, Hard: { time: null, wins: 0 }, Expert: { time: null, wins: 0 }, Master: { time: null, wins: 0 } },
            16: { Easy: { time: null, wins: 0 }, Medium: { time: null, wins: 0 }, Hard: { time: null, wins: 0 }, Expert: { time: null, wins: 0 }, Master: { time: null, wins: 0 } }
        };

        // --- Sound System ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, type, duration) {
            if (!state.soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playSound(type) {
            switch(type) {
                case 'click': playTone(400, 'sine', 0.1); break;
                case 'input': playTone(600, 'sine', 0.1); break;
                case 'correct': 
                    playTone(800, 'sine', 0.1);
                    setTimeout(() => playTone(1200, 'sine', 0.2), 100);
                    break;
                case 'wrong':
                    playTone(150, 'sawtooth', 0.3);
                    break;
                case 'win':
                    [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                        setTimeout(() => playTone(f, 'square', 0.4), i * 150);
                    });
                    break;
                case 'delete': playTone(200, 'sine', 0.1); break;
            }
        }

        // --- Functions ---
        function formatValue(val) {
            if (val === 0) return '';
            if (val <= 9) return val.toString();
            return String.fromCharCode(65 + val - 10);
        }

        function getBaseBoard(size) {
            const boxSize = Math.sqrt(size);
            const board = Array.from({ length: size }, () => Array(size).fill(0));
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const shift = (Math.floor(r / boxSize) + (r % boxSize) * boxSize) % size;
                    board[r][c] = ((c + shift) % size) + 1;
                }
            }
            return board;
        }

        function shuffleBoard(baseBoard, size) {
            const boxSize = Math.sqrt(size);
            let board = baseBoard.map(row => [...row]);
            const nums = Array.from({ length: size }, (_, i) => i + 1);
            for (let i = nums.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [nums[i], nums[j]] = [nums[j], nums[i]];
            }
            const map = new Map();
            nums.forEach((n, i) => map.set(i + 1, n));
            board = board.map(row => row.map(n => map.get(n)));

            const shuffle = (arr) => {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            };

            for (let b = 0; b < size; b += boxSize) {
                const rows = Array.from({ length: boxSize }, (_, i) => b + i);
                const shuffledRows = shuffle([...rows]);
                const oldBoard = [...board];
                rows.forEach((oldR, i) => {
                    board[oldR] = oldBoard[shuffledRows[i]];
                });
            }

            let transposed = board[0].map((_, c) => board.map(r => r[c]));
            for (let b = 0; b < size; b += boxSize) {
                const cols = Array.from({ length: boxSize }, (_, i) => b + i);
                const shuffledCols = shuffle([...cols]);
                const oldTransposed = [...transposed];
                cols.forEach((oldC, i) => {
                    transposed[oldC] = oldTransposed[shuffledCols[i]];
                });
            }
            board = transposed[0].map((_, c) => transposed.map(r => r[c]));
            return board;
        }

        function generateBoard(difficulty, size) {
            const base = getBaseBoard(size);
            const solution = shuffleBoard(base, size);
            const playable = solution.map(row => [...row]);
            const totalCells = size * size;
            
            let clues;
            if (size === 9) {
                if (difficulty === 'Easy') clues = 45;
                else if (difficulty === 'Medium') clues = 35;
                else if (difficulty === 'Hard') clues = 30;
                else if (difficulty === 'Expert') clues = 24;
                else clues = 17;
            } else {
                if (difficulty === 'Easy') clues = 160;
                else if (difficulty === 'Medium') clues = 130;
                else if (difficulty === 'Hard') clues = 110;
                else if (difficulty === 'Expert') clues = 90;
                else clues = 70;
            }

            let attempts = totalCells - clues;
            while (attempts > 0) {
                const r = Math.floor(Math.random() * size);
                const c = Math.floor(Math.random() * size);
                if (playable[r][c] !== BLANK) {
                    playable[r][c] = BLANK;
                    attempts--;
                }
            }

            return { initial: playable, solution };
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function getDifficultyLabel(diff) {
            switch (diff) {
                case 'Easy': return '초급';
                case 'Medium': return '중급';
                case 'Hard': return '고급';
                case 'Expert': return '전문가';
                case 'Master': return '마스터';
                default: return '초급';
            }
        }

        function saveGame() {
            if (state.isWon) return;
            const serializedNotes = state.notes.map(row => row.map(set => Array.from(set)));
            const data = { ...state, notes: serializedNotes, timerInterval: null };
            localStorage.setItem(STORAGE_KEY_GAME, JSON.stringify(data));
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_GAME);
                if (!saved) return false;
                const data = JSON.parse(saved);
                data.notes = data.notes.map(row => row.map(arr => new Set(arr)));
                Object.assign(state, data);
                state.isPaused = false; 
                state.lastEffect = { row: null, col: null, type: null }; 
                return true;
            } catch (e) { return false; }
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_SETTINGS);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (THEMES[data.theme]) state.themeName = data.theme;
                    if (typeof data.soundEnabled !== 'undefined') state.soundEnabled = data.soundEnabled;
                    if (typeof data.effectEnabled !== 'undefined') state.effectEnabled = data.effectEnabled;
                    if (typeof data.showInitialBg !== 'undefined') state.showInitialBg = data.showInitialBg;
                }
            } catch(e) {}
        }

        function saveSettings() {
            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify({ 
                theme: state.themeName, 
                soundEnabled: state.soundEnabled, 
                effectEnabled: state.effectEnabled,
                showInitialBg: state.showInitialBg
            }));
        }

        function loadScores() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_SCORES);
                if (saved) {
                    const data = JSON.parse(saved);
                    for (const size in scores) {
                        if (data[size]) {
                            for (const diff in scores[size]) {
                                if (data[size][diff]) scores[size][diff] = data[size][diff];
                            }
                        }
                    }
                }
            } catch (e) {}
        }

        function saveScores() {
            localStorage.setItem(STORAGE_KEY_SCORES, JSON.stringify(scores));
        }

        function updateScore(size, difficulty, time) {
            if (!scores[size] || !scores[size][difficulty]) return;
            const current = scores[size][difficulty];
            current.wins += 1;
            if (current.time === null || time < current.time) {
                current.time = time;
            }
            saveScores();
        }

        function getCurrentTheme() {
            return THEMES[state.themeName] || THEMES.Classic;
        }

        function applyTheme() {
            const theme = getCurrentTheme();
            document.body.className = `${theme.bg} transition-colors duration-300 min-h-screen flex flex-col items-center py-6 px-2`;
            document.getElementById('game-title').className = `text-3xl font-bold ${theme.textMain}`;
            
            const btnSettings = document.getElementById('btn-settings');
            const btnScoreboard = document.getElementById('btn-scoreboard');
            const btnFullscreen = document.getElementById('btn-fullscreen');
            const settingsPanelEl = document.getElementById('settings-panel');
            const isSettingsOpen = settingsPanelEl && !settingsPanelEl.classList.contains('hidden');
            
            const btnClass = `p-2 rounded-lg transition-all ${isSettingsOpen ? theme.btnActive : 'bg-transparent hover:bg-black/5 ' + theme.textMain}`;
            if (btnSettings) btnSettings.className = btnClass;
            if (btnScoreboard) btnScoreboard.className = `p-2 rounded-lg transition-all bg-transparent hover:bg-black/5 ${theme.textMain}`;
            if (btnFullscreen) btnFullscreen.className = `p-2 rounded-lg transition-all bg-transparent hover:bg-black/5 ${theme.textMain}`;


            if (settingsPanelEl) {
                settingsPanelEl.className = `hidden w-full p-4 rounded-xl shadow-lg border mb-2 animate-in slide-in-from-top-2 ${theme.numPad}`; 
                if(isSettingsOpen) settingsPanelEl.classList.remove('hidden');
                document.getElementById('toggle-sound').checked = state.soundEnabled;
                document.getElementById('toggle-effect').checked = state.effectEnabled;
                document.getElementById('toggle-bg').checked = state.showInitialBg;
            }

            document.querySelectorAll('#grid-size-controls button').forEach(btn => {
                const size = parseInt(btn.dataset.size);
                if (state.gridSize === size) {
                    btn.className = `flex items-center gap-1 px-3 py-1.5 rounded-md text-sm font-bold transition-all ${theme.btnInactive} shadow-sm`;
                } else {
                    btn.className = `flex items-center gap-1 px-3 py-1.5 rounded-md text-sm font-bold transition-all text-slate-400 hover:text-slate-600`;
                }
            });

            document.getElementById('timer-display').className = `flex items-center gap-2 font-mono text-lg px-3 py-1 rounded-lg shadow-sm border ${theme.btnInactive}`;

            renderDifficultyButtons();
            
            document.getElementById('board-container').className = `w-full aspect-square relative rounded-xl shadow-2xl overflow-hidden border-4 transition-colors duration-300 ${theme.boardBg} ${theme.boardBorder}`;
            
            const mistakeDisplay = document.getElementById('mistake-display');
            if (state.mistakes >= 2) {
                mistakeDisplay.className = `flex items-center gap-1 font-bold text-sm px-3 py-1 rounded-full border bg-red-100 text-red-600 border-red-200 animate-pulse`;
            } else {
                mistakeDisplay.className = `flex items-center gap-1 font-bold text-sm px-3 py-1 rounded-full border ${theme.btnInactive}`;
            }

            const btnNote = document.getElementById('btn-note');
            btnNote.className = `py-3 rounded-xl font-bold shadow-sm transition-all flex items-center justify-center gap-2 border-b-4 active:border-b-0 active:translate-y-1 ${state.isNoteMode ? theme.btnActive : theme.btnInactive}`;
            const noteIcon = btnNote.querySelector('i, svg'); 
            if (noteIcon) {
                if (state.isNoteMode) {
                    noteIcon.classList.add('text-yellow-400');
                    noteIcon.classList.remove('opacity-50');
                } else {
                    noteIcon.classList.remove('text-yellow-400');
                    noteIcon.classList.add('opacity-50');
                }
            }

            const btnNewGame = document.getElementById('btn-new-game');
            btnNewGame.className = `py-3 rounded-xl font-bold shadow-sm border-b-4 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 ${theme.btnPrimary}`;

            const modalWinContent = document.getElementById('modal-win-content');
            modalWinContent.className = `rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl transform scale-100 transition-colors ${theme.bg}`;
            modalWinContent.querySelector('h2').className = `text-3xl font-bold mb-2 ${theme.textMain}`;
            modalWinContent.querySelector('p').className = `mb-6 ${theme.textSub}`;
            document.getElementById('btn-win-restart').className = `w-full py-3 rounded-xl font-bold transition-colors ${theme.btnPrimary}`;

            const modalFailContent = document.getElementById('modal-fail-content');
            modalFailContent.className = `rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl transition-colors ${theme.bg}`;
            modalFailContent.querySelector('h2').className = `text-2xl font-bold mb-2 ${theme.textMain}`;
            modalFailContent.querySelector('p').className = `mb-6 ${theme.textSub}`;
            document.getElementById('btn-fail-restart').className = `w-full py-3 rounded-xl font-bold transition-colors ${theme.btnActive}`;

            renderNumpad();
            renderBoard(); 
            if(window.lucide) lucide.createIcons();
        }

        function renderDifficultyButtons() {
            const theme = getCurrentTheme();
            const container = document.getElementById('difficulty-controls');
            container.innerHTML = '';
            ['Easy', 'Medium', 'Hard', 'Expert', 'Master'].forEach(diff => {
                const btn = document.createElement('button');
                btn.textContent = getDifficultyLabel(diff);
                btn.className = `px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold transition-all border ${state.difficulty === diff ? theme.btnPrimary : theme.btnInactive}`;
                btn.onclick = () => { 
                    playSound('click');
                    startNewGame(diff, state.gridSize); 
                };
                container.appendChild(btn);
            });
        }

        function renderNumpad() {
            const theme = getCurrentTheme();
            const container = document.getElementById('numpad');
            
            // 9x9 -> grid-cols-5 (Row1: 1-5, Row2: 6-9+Eraser) ? Or 2 rows of 5?
            // Actually standard numpad for 9x9 is usually 1-5, 6-9+E.
            // 16x16 -> grid-cols-9 (Row1: 1-9, Row2: A-G + Eraser(span 2))
            
            if (state.gridSize === 16) {
                container.className = `grid gap-2 sm:gap-3 mb-4 grid-cols-9 transition-all`;
            } else {
                container.className = `grid gap-2 sm:gap-3 mb-4 grid-cols-5 transition-all`;
            }
            container.innerHTML = '';

            const counts = {};
            for(let r=0; r<state.gridSize; r++){
                for(let c=0; c<state.gridSize; c++){
                    const val = state.board[r][c];
                    if(val !== BLANK) counts[val] = (counts[val] || 0) + 1;
                }
            }

            for (let i = 1; i <= state.gridSize; i++) {
                const btn = document.createElement('button');
                const remaining = state.gridSize - (counts[i] || 0);
                const isCompleted = remaining <= 0;
                
                const completedClass = isCompleted 
                    ? `${theme.btnPrimary} opacity-50 cursor-not-allowed pointer-events-none border-transparent` 
                    : theme.numPad;
                
                btn.className = `relative w-full h-12 sm:h-16 rounded-xl shadow-sm border-b-4 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center justify-center ${completedClass}`;
                btn.onclick = () => handleNumberInput(i);

                const numSpan = document.createElement('span');
                numSpan.className = "text-xl sm:text-3xl font-bold leading-none";
                numSpan.textContent = formatValue(i);
                btn.appendChild(numSpan);

                if (!isCompleted) {
                    const badge = document.createElement('span');
                    badge.className = "absolute top-0.5 right-1 text-[10px] sm:text-xs font-medium opacity-70 leading-none";
                    badge.textContent = remaining;
                    btn.appendChild(badge);
                }

                container.appendChild(btn);
            }

            // Eraser
            const eraseBtn = document.createElement('button');
            eraseBtn.innerHTML = '<i data-lucide="eraser" class="w-5 h-5 sm:w-8 sm:h-8"></i>';
            
            // For 16x16 with grid-cols-9:
            // Items 1-9 (9 items) -> Row 1 full.
            // Items A-G (7 items) -> Row 2 indices 0-6.
            // Eraser needs to fill remaining 2 slots (index 7, 8).
            const spanClass = state.gridSize === 16 ? 'col-span-2' : 'col-span-1';

            eraseBtn.className = `w-full h-12 sm:h-16 rounded-xl shadow-sm border-b-4 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center ${theme.eraseBtn} ${spanClass}`;
            eraseBtn.onclick = () => handleNumberInput(0);
            container.appendChild(eraseBtn);
        }
        
        function renderScoreboard() {
            ['9', '16'].forEach(size => {
                const tbody = document.getElementById(`score-list-${size}`);
                if(!tbody) return;
                tbody.innerHTML = '';
                
                const difficultyOrder = ['Easy', 'Medium', 'Hard', 'Expert', 'Master'];
                difficultyOrder.forEach(diff => {
                    const data = scores[size] && scores[size][diff] ? scores[size][diff] : { time: null, wins: 0 };
                    const tr = document.createElement('tr');
                    
                    const tdDiff = document.createElement('td');
                    tdDiff.className = "py-3 px-4 font-medium text-gray-800";
                    tdDiff.textContent = getDifficultyLabel(diff);
                    
                    const tdTime = document.createElement('td');
                    tdTime.className = "py-3 px-4 text-center font-mono text-blue-600 font-bold";
                    tdTime.textContent = data.time ? formatTime(data.time) : '-';
                    
                    const tdWins = document.createElement('td');
                    tdWins.className = "py-3 px-4 text-right font-medium text-gray-500";
                    tdWins.textContent = `${data.wins}회`;
                    
                    tr.appendChild(tdDiff);
                    tr.appendChild(tdTime);
                    tr.appendChild(tdWins);
                    tbody.appendChild(tr);
                });
            });
        }

        function renderBoard() {
            const theme = getCurrentTheme();
            const boardEl = document.getElementById('game-board');
            if (!boardEl) return;
            const size = state.gridSize;
            const boxSize = Math.sqrt(size);

            const counts = {};
            for(let r=0; r<size; r++){
                for(let c=0; c<size; c++){
                    const val = state.board[r][c];
                    if(val !== BLANK) counts[val] = (counts[val] || 0) + 1;
                }
            }
            const normalTextColor = theme.cellNormal.split(' ').find(c => c.startsWith('text-')) || 'text-blue-600';
            const initialTextClass = theme.cellInitial.split(' ').filter(c => c.startsWith('text-')).join(' ');
            const normalBgClass = theme.cellNormal.split(' ').filter(c => c.startsWith('bg-')).join(' ');

            boardEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            boardEl.style.gridTemplateRows = `repeat(${size}, 1fr)`;
            boardEl.innerHTML = '';

            const toSideColor = (cls, side) => cls.replace('border-', `border-${side}-`);

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const cell = document.createElement('div');
                    const value = state.board[r][c];
                    const isInitial = state.initialBoard[r][c] !== BLANK;
                    const isSelected = state.selectedCell && state.selectedCell[0] === r && state.selectedCell[1] === c;
                    const isSameNumber = state.selectedCell && value !== BLANK && state.board[state.selectedCell[0]][state.selectedCell[1]] === value;
                    const isError = !isInitial && value !== BLANK && value !== state.solution[r][c];
                    const isCompletedNumber = value !== BLANK && counts[value] >= size;

                    let cls = 'flex items-center justify-center cursor-pointer transition-colors duration-75 select-none relative no-select ';
                    
                    if (size === 9) cls += value !== BLANK ? "text-lg sm:text-2xl font-medium " : "";
                    else cls += value !== BLANK ? "text-xs sm:text-base font-bold " : "";

                    let borderRightColor = theme.borderLight;
                    let borderBottomColor = theme.borderLight;
                    
                    if ((c + 1) % boxSize === 0 && c !== size - 1) {
                        borderRightColor = theme.borderHeavy;
                    }
                    if ((r + 1) % boxSize === 0 && r !== size - 1) {
                        borderBottomColor = theme.borderHeavy;
                    }

                    const rightColorClass = toSideColor(borderRightColor, 'r');
                    const bottomColorClass = toSideColor(borderBottomColor, 'b');

                    let borderWidthRight = (c === size - 1) ? 'border-r-0' : 'border-r';
                    if ((c + 1) % boxSize === 0 && c !== size - 1) borderWidthRight = 'border-r-2';

                    let borderWidthBottom = (r === size - 1) ? 'border-b-0' : 'border-b';
                    if ((r + 1) % boxSize === 0 && r !== size - 1) borderWidthBottom = 'border-b-2';

                    cls += `${borderWidthRight} ${rightColorClass} ${borderWidthBottom} ${bottomColorClass} `;

                    let animationClass = '';
                    if (state.effectEnabled) {
                        if (state.lastEffect.type === 'wrong' && state.lastEffect.row === r && state.lastEffect.col === c) {
                            animationClass = ' animate-shake';
                        } else if (state.lastEffect.type === 'correct' && state.lastEffect.row === r && state.lastEffect.col === c) {
                            animationClass = ' animate-pop';
                        }
                    }

                    // Logic order for CSS classes
                    // Force Animation classes to override others via !important in CSS
                    
                    if (isSelected) {
                        cls += theme.cellSelected;
                    } else if (isError) {
                        cls += theme.cellError;
                    } else if (isSameNumber) {
                        cls += theme.cellSame;
                    } else if (isInitial) {
                        if (state.showInitialBg) {
                            if (isCompletedNumber) {
                                cls += theme.cellInitial; 
                                cls += ` !${normalTextColor}`; 
                            } else {
                                cls += theme.cellInitial;
                            }
                        } else {
                            cls += `${normalBgClass} ${initialTextClass}`;
                            if (isCompletedNumber) {
                                 cls += ` !${normalTextColor}`;
                            }
                        }
                    } else {
                        cls += theme.cellNormal;
                    }
                    
                    cls += animationClass;

                    cell.className = cls;
                    cell.onclick = () => {
                        playSound('click');
                        handleCellClick(r, c);
                    };

                    if (value !== BLANK) {
                        cell.textContent = formatValue(value);
                    } else {
                        const hasNotes = state.notes[r] && state.notes[r][c] && state.notes[r][c].size > 0;
                        if (hasNotes) {
                            const noteContainer = document.createElement('div');
                            noteContainer.className = `w-full h-full pointer-events-none p-0.5 flex flex-wrap content-start items-start leading-none justify-center ${size === 16 ? 'gap-[1px]' : 'gap-0.5'}`;
                            const sortedNotes = Array.from(state.notes[r][c]).sort((a,b)=>a-b);
                            sortedNotes.forEach(n => {
                                const sp = document.createElement('span');
                                sp.className = `${size === 16 ? 'text-[6px] sm:text-[8px]' : 'text-[8px] sm:text-[10px]'} font-bold ${theme.cellNote}`;
                                sp.textContent = formatValue(n);
                                noteContainer.appendChild(sp);
                            });
                            cell.appendChild(noteContainer);
                        }
                    }

                    boardEl.appendChild(cell);
                }
            }
        }

        function renderSettingsThemes() {
            const container = document.getElementById('theme-grid');
            if (!container) return;
            container.innerHTML = '';
            Object.keys(THEMES).forEach(key => {
                const t = THEMES[key];
                const btn = document.createElement('button');
                btn.textContent = t.name;
                const isActive = state.themeName === key;
                btn.className = `py-2 px-1 sm:px-3 rounded-lg text-xs sm:text-sm font-bold border-2 transition-all ${
                    isActive
                      ? `${t.btnPrimary} border-transparent ring-2 ring-offset-2 ring-blue-400` 
                      : `${t.bg} ${t.textMain} border-current opacity-70 hover:opacity-100`
                }`;
                btn.onclick = () => {
                    playSound('click');
                    state.themeName = key;
                    saveSettings();
                    applyTheme();
                    renderSettingsThemes(); 
                };
                container.appendChild(btn);
            });
        }

        function startNewGame(diff = state.difficulty, size = state.gridSize, shouldSave = true) {
            const { initial, solution } = generateBoard(diff, size);
            state.initialBoard = initial;
            state.board = initial.map(row => [...row]);
            state.solution = solution;
            state.notes = Array.from({ length: size }, () => Array.from({ length: size }, () => new Set()));
            state.difficulty = diff;
            state.gridSize = size;
            state.mistakes = 0;
            state.timer = 0;
            state.isWon = false;
            state.isPaused = false;
            state.selectedCell = null;
            state.isNoteMode = false;
            state.lastEffect = { row: null, col: null, type: null };

            document.getElementById('modal-win').classList.add('hidden');
            document.getElementById('modal-fail').classList.add('hidden');
            
            const noteText = document.getElementById('note-text');
            if(noteText) noteText.textContent = '메모 OFF';
            
            const mistakeCount = document.getElementById('mistake-count');
            if(mistakeCount) mistakeCount.textContent = '0';
            
            if (shouldSave) localStorage.removeItem(STORAGE_KEY_GAME);
            
            applyTheme();
            renderBoard();
        }

        function handleCellClick(r, c) {
            if (state.isWon) return;
            state.selectedCell = [r, c];
            renderBoard();
        }

        function handleNumberInput(num) {
            if (!state.selectedCell || state.isWon) return;
            const [r, c] = state.selectedCell;
            
            if (state.initialBoard[r][c] !== BLANK) return;

            if (state.isNoteMode) {
                playSound('input');
                if (num === 0) {
                    state.notes[r][c].clear();
                } else {
                    if (state.notes[r][c].has(num)) state.notes[r][c].delete(num);
                    else state.notes[r][c].add(num);
                }
                saveGame();
                renderBoard();
                return;
            }

            if (num === 0) {
                playSound('delete');
                state.board[r][c] = BLANK;
                saveGame();
                renderBoard();
                renderNumpad();
                return;
            }

            if (num !== state.solution[r][c]) {
                playSound('wrong');
                state.mistakes++;
                const mistakeCount = document.getElementById('mistake-count');
                if(mistakeCount) mistakeCount.textContent = state.mistakes;
                
                // IMPORTANT: Temporarily set the wrong number so we can see it shake!
                const prevVal = state.board[r][c];
                state.board[r][c] = num;
                state.lastEffect = { row: r, col: c, type: 'wrong' };
                renderBoard();
                
                if (state.mistakes >= 3) {
                    document.getElementById('modal-fail').classList.remove('hidden');
                }
                
                setTimeout(() => {
                    // Revert the wrong number to blank (or previous)
                    state.board[r][c] = prevVal; 
                    state.lastEffect = { row: null, col: null, type: null };
                    renderBoard();
                }, 500);

            } else {
                playSound('correct');
                state.board[r][c] = num;
                state.notes[r][c].clear();
                state.lastEffect = { row: r, col: c, type: 'correct' };
                
                let isComplete = true;
                for(let i=0; i<state.gridSize; i++){
                    for(let j=0; j<state.gridSize; j++){
                        if(state.board[i][j] !== state.solution[i][j]) {
                            isComplete = false;
                            break;
                        }
                    }
                }
                
                renderBoard(); 
                
                if (isComplete) {
                    state.isWon = true;
                    localStorage.removeItem(STORAGE_KEY_GAME);
                    
                    setTimeout(() => {
                        playSound('win');
                        if(state.effectEnabled && window.confetti) {
                            confetti({
                                particleCount: 150,
                                spread: 70,
                                origin: { y: 0.6 }
                            });
                        }
                        updateScore(state.gridSize, state.difficulty, state.timer);
                        document.getElementById('win-size').textContent = `${state.gridSize}x${state.gridSize}`;
                        document.getElementById('win-diff').textContent = getDifficultyLabel(state.difficulty);
                        document.getElementById('win-time').textContent = formatTime(state.timer);
                        document.getElementById('modal-win').classList.remove('hidden');
                    }, 500); 
                }
                
                setTimeout(() => {
                    state.lastEffect = { row: null, col: null, type: null };
                    renderBoard();
                }, 500);
            }

            saveGame();
            renderNumpad();
        }

        function moveSelection(key) {
            if (!state.selectedCell) {
                state.selectedCell = [0, 0];
                renderBoard();
                return;
            }
            const [r, c] = state.selectedCell;
            let nr = r, nc = c;
            if (key === 'ArrowUp') nr = Math.max(0, r - 1);
            if (key === 'ArrowDown') nr = Math.min(state.gridSize - 1, r + 1);
            if (key === 'ArrowLeft') nc = Math.max(0, c - 1);
            if (key === 'ArrowRight') nc = Math.min(state.gridSize - 1, c + 1);
            state.selectedCell = [nr, nc];
            renderBoard();
        }

        // --- Ripple Logic ---
        let isDragging = false;
        let lastRippleX = 0;
        let lastRippleY = 0;
        const RIPPLE_DISTANCE = 30; 

        function createRipple(x, y) {
            if (!state.effectEnabled) return;
            const ripple = document.createElement('div');
            ripple.className = 'click-ripple';
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            document.body.appendChild(ripple);
            ripple.addEventListener('animationend', () => ripple.remove());
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadScores();
            
            if (!loadGame()) {
                startNewGame('Easy', 9, false);
            }

            renderSettingsThemes();
            applyTheme(); 

            setInterval(() => {
                if (!state.isWon && !state.isPaused && !document.hidden) {
                    state.timer++;
                    const timerEl = document.querySelector('#timer-display span');
                    if(timerEl) timerEl.textContent = formatTime(state.timer);
                }
            }, 1000);

            // Global Interaction (Touch/Mouse) for Ripple
            window.addEventListener('pointerdown', (e) => {
                isDragging = true;
                createRipple(e.clientX, e.clientY);
                lastRippleX = e.clientX;
                lastRippleY = e.clientY;
            });

            window.addEventListener('pointermove', (e) => {
                if (!isDragging) return;
                const dist = Math.hypot(e.clientX - lastRippleX, e.clientY - lastRippleY);
                if (dist > RIPPLE_DISTANCE) {
                    createRipple(e.clientX, e.clientY);
                    lastRippleX = e.clientX;
                    lastRippleY = e.clientY;
                }
            });

            window.addEventListener('pointerup', () => { isDragging = false; });
            window.addEventListener('pointercancel', () => { isDragging = false; });

            window.addEventListener('keydown', (e) => {
                if (document.getElementById('modal-scoreboard') && !document.getElementById('modal-scoreboard').classList.contains('hidden')) return;
                if (document.getElementById('settings-panel') && !document.getElementById('settings-panel').classList.contains('hidden')) return;

                if (state.isWon) return;

                const key = e.key;
                const keyNum = parseInt(key);

                if (!isNaN(keyNum) && keyNum >= 1 && keyNum <= 9) {
                    handleNumberInput(keyNum);
                }
                else if (state.gridSize === 16 && /^[a-gA-G]$/.test(key)) {
                    const val = key.toUpperCase().charCodeAt(0) - 65 + 10;
                    handleNumberInput(val);
                }
                else if (key === 'Backspace' || key === 'Delete') {
                    handleNumberInput(0);
                }
                else if (key.toLowerCase() === 'n') {
                    const btnNote = document.getElementById('btn-note');
                    if(btnNote) btnNote.click();
                }
                else if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
                    e.preventDefault();
                    moveSelection(key);
                }
            });

            document.getElementById('toggle-sound').onclick = (e) => {
                state.soundEnabled = e.target.checked;
                if(state.soundEnabled) playSound('click');
                saveSettings();
            };
            document.getElementById('toggle-effect').onclick = (e) => {
                state.effectEnabled = e.target.checked;
                saveSettings();
            };
            document.getElementById('toggle-bg').onclick = (e) => {
                state.showInitialBg = e.target.checked;
                playSound('click');
                saveSettings();
                renderBoard(); // Re-render to apply change
            };

            const btnSettings = document.getElementById('btn-settings');
            if(btnSettings) {
                btnSettings.onclick = () => {
                    playSound('click');
                    const p = document.getElementById('settings-panel');
                    if(p) {
                        p.classList.toggle('hidden');
                        applyTheme(); 
                    }
                };
            }
            
            const btnCloseSettings = document.getElementById('btn-close-settings');
            if(btnCloseSettings) {
                btnCloseSettings.onclick = () => {
                    playSound('click');
                    const p = document.getElementById('settings-panel');
                    if(p) {
                        p.classList.add('hidden');
                        applyTheme();
                    }
                };
            }

            const btnScoreboard = document.getElementById('btn-scoreboard');
            if(btnScoreboard) {
                btnScoreboard.onclick = () => {
                    playSound('click');
                    renderScoreboard();
                    document.getElementById('modal-scoreboard').classList.remove('hidden');
                };
            }
            
            const btnCloseScoreboard = document.getElementById('btn-close-scoreboard');
            if(btnCloseScoreboard) {
                btnCloseScoreboard.onclick = () => {
                    playSound('click');
                    document.getElementById('modal-scoreboard').classList.add('hidden');
                };
            }
            
            const modalScoreboard = document.getElementById('modal-scoreboard');
            if(modalScoreboard) {
                modalScoreboard.onclick = (e) => {
                    if(e.target.id === 'modal-scoreboard') {
                        modalScoreboard.classList.add('hidden');
                    }
                };
            }

            // Fullscreen Toggle
            const btnFullscreen = document.getElementById('btn-fullscreen');
            if (btnFullscreen) {
                btnFullscreen.onclick = () => {
                    playSound('click');
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log(`Error attempting to enable fullscreen: ${err.message}`);
                        });
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                };
            }

            // Update fullscreen icon on change
            document.addEventListener('fullscreenchange', () => {
                const btn = document.getElementById('btn-fullscreen');
                if(!btn) return;
                
                if (document.fullscreenElement) {
                    btn.innerHTML = '<i data-lucide="minimize" class="w-6 h-6"></i>';
                } else {
                    btn.innerHTML = '<i data-lucide="maximize" class="w-6 h-6"></i>';
                }
                if(window.lucide) lucide.createIcons();
            });

            document.querySelectorAll('#grid-size-controls button').forEach(btn => {
                btn.onclick = (e) => {
                    playSound('click');
                    const size = parseInt(e.currentTarget.dataset.size);
                    if (size !== state.gridSize) startNewGame(state.difficulty, size);
                }
            });

            const btnNote = document.getElementById('btn-note');
            if(btnNote) {
                btnNote.onclick = () => {
                    playSound('click');
                    state.isNoteMode = !state.isNoteMode;
                    const noteText = document.getElementById('note-text');
                    if(noteText) noteText.textContent = state.isNoteMode ? '메모 ON' : '메모 OFF';
                    applyTheme();
                };
            }

            const btnNewGame = document.getElementById('btn-new-game');
            if(btnNewGame) btnNewGame.onclick = () => {
                playSound('click');
                startNewGame();
            };

            const btnWinRestart = document.getElementById('btn-win-restart');
            if(btnWinRestart) btnWinRestart.onclick = () => {
                playSound('click');
                startNewGame();
            };
            
            const btnFailRestart = document.getElementById('btn-fail-restart');
            if(btnFailRestart) btnFailRestart.onclick = () => {
                playSound('click');
                startNewGame();
            };

            if(window.lucide) lucide.createIcons();
        });
    </script>
</body>
</html>
