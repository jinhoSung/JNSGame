<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skeleton Knight's Awakening</title>
    <style>
        body { background-color: #1a1a1a; color: white; margin: 0; overflow: hidden; font-family: 'DungGeunMo', monospace, sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #000; }
        canvas { image-rendering: pixelated; display: block; }
        
        /* UI ì˜¤ë²„ë ˆì´ */
        .overlay { position: absolute; pointer-events: none; text-shadow: 1px 1px 0 #000; z-index: 10; }
        
        /* ìƒë‹¨ ë°” */
        #top-bar {
            top: 5px; left: 5px; right: 5px;
            display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.6); padding: 5px 10px;
            border-radius: 5px; border: 1px solid #666;
            pointer-events: auto; font-size: 12px;
        }
        .stat-group { display: flex; align-items: center; margin-right: 10px; }
        .bar-bg { width: 60px; height: 6px; background: #333; display: inline-block; margin: 0 5px; position: relative; border: 1px solid #555; }
        .bar-fill { height: 100%; display: block; }
        .hp-fill { background: #e74c3c; } .mp-fill { background: #3498db; } .exp-fill { background: #f1c40f; }
        
        .ui-btn { background: #444; color: white; border: 1px solid #fff; padding: 2px 6px; cursor: pointer; font-family: inherit; font-size: 11px; margin-left: 2px; }
        .ui-btn:hover { background: #666; }

        /* íŒ¨ë„ ê³µí†µ */
        .game-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
            background: #2c3e50; border: 3px solid gold; padding: 15px;
            display: none; text-align: center; pointer-events: auto; z-index: 50;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .panel-header { color: gold; margin-bottom: 10px; border-bottom: 2px solid gold; padding-bottom: 5px; font-size: 20px; }
        .panel-btn {
            background: #e74c3c; color: white; border: none;
            padding: 10px 20px; margin: 5px; cursor: pointer;
            font-size: 16px; border-radius: 4px; font-family: inherit; width: 100%; margin-bottom: 10px;
        }
        .panel-btn:hover { background: #c0392b; }
        .panel-btn.secondary { background: #555; }
        .panel-btn:disabled { background: #777; cursor: not-allowed; opacity: 0.6; }
        .close-btn { position: absolute; top: 5px; right: 5px; background: #c0392b; border: none; color: white; cursor: pointer; }

        /* ìƒíƒœì°½ & ì¸ë²¤í† ë¦¬ */
        .tab-menu { display: flex; justify-content: center; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; background: #333; border: 1px solid #555; color: #aaa; cursor: pointer; }
        .tab-btn.selected { background: #e67e22; border-color: gold; color: white; font-weight: bold; }
        
        .stat-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #444; font-size: 14px; }
        .stat-up-btn { background: #27ae60; width: 20px; height: 20px; padding: 0; line-height: 20px; margin-left: 5px; border: none; color: white; cursor: pointer; }
        
        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .inv-item { background: rgba(0,0,0,0.3); padding: 8px; border: 1px solid #555; text-align: left; font-size: 12px; }
        .inv-item.equipped { border-color: lime; background: rgba(0, 255, 0, 0.1); }
        .item-name { font-weight: bold; color: #fff; margin-bottom: 3px; display: block; }
        .item-desc { font-size: 11px; color: #aaa; margin-bottom: 5px; display: block; }
        .item-btn { background: #555; border: 1px solid #777; color: white; width: 100%; cursor: pointer; }

        /* ìŠ¤í‚¬ ìŠ¬ë¡¯ */
        #skill-bar { bottom: 20px; right: 20px; display: flex; gap: 8px; pointer-events: auto; }
        .skill-slot {
            width: 50px; height: 50px; background: rgba(0,0,0,0.8); border: 2px solid #888;
            position: relative; display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer; flex-direction: column;
        }
        .skill-slot.active { border-color: #3498db; box-shadow: 0 0 10px #3498db; }
        .skill-cooldown {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center;
            font-size: 12px; color: white;
        }
        .skill-key { position: absolute; top: 2px; left: 2px; font-size: 9px; color: gold; }

        /* ì¹´ì§€ë…¸ UI */
        #casino-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #casino-menu button { height: 60px; font-size: 18px; width: auto; margin: 0; }
        .game-view { display: none; }
        .game-view.active { display: block; }
        .result-msg { height: 30px; font-weight: bold; color: yellow; margin: 10px 0; }
        .bet-info { background: rgba(0,0,0,0.3); padding: 10px; margin: 10px 0; border-radius: 5px; }
        .bet-control { background: #333; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 18px; }
        .bet-control input { background: #000; border: 1px solid #fff; color: gold; font-family: inherit; font-size: 18px; width: 100px; text-align: right; padding: 5px; }
        .minigame-canvas { margin: 10px auto; background: #004400; border: 4px solid #d4af37; border-radius: 8px; box-shadow: inset 0 0 20px #000; display: block; }
        #roulette-canvas, #rps-canvas { background: #222; } #roulette-canvas { border-radius: 50%; }

        /* ê¸°íƒ€ */
        #map-canvas { border: 2px solid gold; background: #000; width: 250px; height: 250px; image-rendering: pixelated; margin: 0 auto; display: block;}
        #toast { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); padding: 10px 20px; border-radius: 20px; display: none; z-index: 9999; border: 1px solid white; font-size: 16px; font-weight: bold; }
        .damage-text { position: absolute; font-weight: bold; font-size: 14px; animation: floatUp 0.8s forwards; pointer-events: none; text-shadow: 1px 1px 0 #000; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-30px); opacity: 0; } }

        /* ëª¨ë°”ì¼ìš© */
        #mobile-controls { position: absolute; bottom: 20px; left: 20px; display: none; z-index: 90; }
        @media (max-width: 768px) { #mobile-controls { display: block; } #skill-bar { bottom: 120px; } }
        .dpad-btn { width: 45px; height: 45px; background: rgba(255,255,255,0.15); margin: 2px; display: inline-block; text-align: center; line-height: 45px; color: white; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); font-size: 18px; }
        .dpad-btn:active { background: rgba(255,255,255,0.4); }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- ìƒë‹¨ ì •ë³´ì°½ -->
    <div id="top-bar" class="overlay">
        <div style="display: flex; align-items: center;">
            <div class="stat-group"><span>Lv.<span id="ui-lvl">1</span></span><div class="bar-bg"><div id="ui-exp-bar" class="bar-fill exp-fill" style="width:0%"></div></div></div>
            <div class="stat-group"><span style="color:gold;">ğŸ’°<span id="ui-gold">0</span></span></div>
        </div>
        <div style="display: flex; align-items: center;">
            <div class="stat-group"><span style="color:#e74c3c;">HP</span><div class="bar-bg"><div id="ui-hp-bar" class="bar-fill hp-fill" style="width:100%"></div></div></div>
            <div class="stat-group"><span style="color:#3498db;">MP</span><div class="bar-bg"><div id="ui-mp-bar" class="bar-fill mp-fill" style="width:100%"></div></div></div>
        </div>
        <div>
            <button class="ui-btn" onclick="toggleMenu()">ë©”ë‰´(C)</button>
            <button class="ui-btn" onclick="toggleMap()">ì§€ë„(M)</button>
            <button class="ui-btn" onclick="saveGame()">ì €ì¥</button>
        </div>
    </div>

    <!-- ìŠ¤í‚¬ ë°” -->
    <div id="skill-bar" class="overlay">
        <div class="skill-slot" id="skill-1" onclick="toggleAutoSkill()">
            <span class="skill-key">Auto</span><span id="skill-icon-1">ğŸ’¥</span><div class="skill-cooldown" id="cd-1"></div>
        </div>
        <div class="skill-slot" id="skill-2" onclick="useSkill(2)">
            <span class="skill-key">H</span><span>â¤ï¸</span><div class="skill-cooldown" id="cd-2"></div>
        </div>
    </div>

    <!-- ë©”ë‰´ íŒ¨ë„ -->
    <div id="menu-panel" class="game-panel">
        <button class="close-btn" onclick="toggleMenu()">X</button>
        <div class="tab-menu">
            <div id="tab-btn-status" class="tab-btn selected" onclick="switchTab('status')">ëŠ¥ë ¥ì¹˜</div>
            <div id="tab-btn-inventory" class="tab-btn" onclick="switchTab('inventory')">ì¸ë²¤í† ë¦¬</div>
        </div>
        <div id="tab-status">
            <h4 style="color:gold; margin:5px 0;">ì”ì—¬ í¬ì¸íŠ¸: <span id="ui-stat-points">0</span></h4>
            <div class="stat-row"><span>í˜ (STR)</span> <div><span id="val-str">10</span> <button class="stat-up-btn" onclick="upStat('str')">+</button></div></div>
            <div class="stat-row"><span>ì²´ë ¥ (VIT)</span> <div><span id="val-vit">10</span> <button class="stat-up-btn" onclick="upStat('vit')">+</button></div></div>
            <div class="stat-row"><span>ì§€ëŠ¥ (INT)</span> <div><span id="val-int">10</span> <button class="stat-up-btn" onclick="upStat('int')">+</button></div></div>
            <hr style="border-color:#444;">
            <div class="stat-row"><span>ê³µê²©ë ¥: <span id="total-atk">0</span></span> <span>ë°©ì–´ë ¥: <span id="total-def">0</span></span></div>
        </div>
        <div id="tab-inventory" style="display:none;"><div id="inv-list" class="inv-grid"></div></div>
    </div>

    <!-- ì¹´ì§€ë…¸ íŒ¨ë„ -->
    <div id="casino-panel" class="game-panel">
        <h2 class="panel-header">ğŸ° ê³ ë¸”ë¦° ì¹´ì§€ë…¸</h2>
        <div class="bet-control">íŒëˆ: <input type="number" id="bet-input" value="100" min="10" step="10"> G</div>
        
        <div id="casino-menu">
            <button class="panel-btn" onclick="showGame('blackjack')">ğŸƒ ë¸”ë™ì­</button>
            <button class="panel-btn" onclick="showGame('roulette')">ğŸ¡ ë£°ë ›</button>
            <button class="panel-btn" onclick="showGame('slots')">ğŸ’ ìŠ¬ë¡¯ë¨¸ì‹ </button>
            <button class="panel-btn" onclick="showGame('racing')">ğŸ ê²½ë§ˆ</button>
            <button class="panel-btn" onclick="showGame('sicbo')">ğŸ² ë‹¤ì´ì‚¬ì´</button>
            <button class="panel-btn" onclick="showGame('rps')">âœŒï¸âœŠâœ‹ ê°€ìœ„ë°”ìœ„ë³´</button>
            <button class="panel-btn secondary" onclick="closePanel()" style="grid-column: span 2;">ğŸšª ë‚˜ê°€ê¸°</button>
        </div>

        <div id="game-blackjack" class="game-view">
            <h3>ë¸”ë™ì­ (ìŠ¹ë¦¬ 2ë°°)</h3>
            <canvas id="bj-canvas" class="minigame-canvas" width="300" height="200"></canvas>
            <div id="bj-result" class="result-msg"></div>
            <div id="bj-actions" style="display:none;">
                <button class="panel-btn" style="width:45%;display:inline-block;" onclick="bjHit()">íˆíŠ¸</button>
                <button class="panel-btn" style="width:45%;display:inline-block;" onclick="bjStand()">ìŠ¤íƒ ë“œ</button>
            </div>
            <div id="bj-controls">
                <button class="panel-btn" onclick="startBlackjack()">ê²Œì„ ì‹œì‘</button>
                <button class="panel-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>

        <div id="game-roulette" class="game-view">
            <h3>ë¦¬ì–¼ ë£°ë ›</h3>
            <canvas id="roulette-canvas" class="minigame-canvas" width="300" height="300"></canvas>
            <div id="roulette-result" class="result-msg"></div>
            <div id="roulette-btns">
                <button class="panel-btn" style="width:30%;display:inline-block;" onclick="startRoulette('odd')">í™€ìˆ˜(x2)</button>
                <button class="panel-btn" style="width:30%;display:inline-block;" onclick="startRoulette('even')">ì§ìˆ˜(x2)</button>
                <button class="panel-btn" style="width:30%;display:inline-block;" onclick="startRoulette('lucky7')">7(x10)</button>
            </div>
            <button class="panel-btn secondary" onclick="backToMenu()" style="margin-top:10px;">ë’¤ë¡œê°€ê¸°</button>
        </div>

        <div id="game-slots" class="game-view">
            <h3>ìŠ¬ë¡¯ë¨¸ì‹  (ì­íŒŸ x50)</h3>
            <canvas id="slot-canvas" class="minigame-canvas" width="300" height="150"></canvas>
            <div id="slot-result" class="result-msg"></div>
            <button class="panel-btn" id="slot-spin-btn" onclick="spinSlots()">ëŒë¦¬ê¸°</button>
            <button class="panel-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
        </div>

        <div id="game-racing" class="game-view">
            <h3>í•´ê³¨ ê²½ë§ˆ (ìš°ìŠ¹ x4)</h3>
            <canvas id="race-canvas" class="minigame-canvas" width="350" height="200"></canvas>
            <div id="race-result" class="result-msg"></div>
            <div id="race-btns">
                <button class="panel-btn" style="width:20%;display:inline-block;" onclick="startRace(1)">1</button>
                <button class="panel-btn" style="width:20%;display:inline-block;" onclick="startRace(2)">2</button>
                <button class="panel-btn" style="width:20%;display:inline-block;" onclick="startRace(3)">3</button>
                <button class="panel-btn" style="width:20%;display:inline-block;" onclick="startRace(4)">4</button>
            </div>
            <button class="panel-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
        </div>

        <div id="game-sicbo" class="game-view">
            <h3>ë‹¤ì´ì‚¬ì´ (x2)</h3>
            <canvas id="sicbo-canvas" class="minigame-canvas" width="300" height="200"></canvas>
            <div id="sicbo-result" class="result-msg"></div>
            <div id="sicbo-btns">
                <button class="panel-btn" style="width:40%;display:inline-block;" onclick="playSicBo('small')">ì†Œ (4-10)</button>
                <button class="panel-btn" style="width:40%;display:inline-block;" onclick="playSicBo('big')">ëŒ€ (11-17)</button>
            </div>
            <button class="panel-btn secondary" onclick="backToMenu()" style="margin-top:10px;">ë’¤ë¡œê°€ê¸°</button>
        </div>

        <div id="game-rps" class="game-view">
            <h3>ê°€ìœ„ë°”ìœ„ë³´</h3>
            <canvas id="rps-canvas" class="minigame-canvas" width="300" height="250"></canvas>
            <div id="rps-result" class="result-msg"></div>
            <div id="rps-btns">
                <button class="panel-btn" style="width:30%;display:inline-block;" onclick="playRPS('scissors')">âœŒï¸</button>
                <button class="panel-btn" style="width:30%;display:inline-block;" onclick="playRPS('rock')">âœŠ</button>
                <button class="panel-btn" style="width:30%;display:inline-block;" onclick="playRPS('paper')">âœ‹</button>
            </div>
            <div id="rps-bonus-btn" style="display:none;"><button class="panel-btn" onclick="spinRpsWheel()">ë£°ë › ëŒë¦¬ê¸°!</button></div>
            <button class="panel-btn secondary" onclick="backToMenu()" style="margin-top:10px;">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </div>

    <!-- ìƒì  íŒ¨ë„ -->
    <div id="shop-panel" class="game-panel">
        <h2 class="panel-header">âš’ï¸ ëŒ€ì¥ê°„</h2>
        <div id="shop-list" class="inv-grid"></div>
        <button class="ui-btn" style="margin-top:20px; padding: 5px 20px; font-size: 14px;" onclick="closePanel()">ë‚˜ê°€ê¸°</button>
    </div>

    <!-- ì—¬ê´€ íŒ¨ë„ -->
    <div id="inn-panel" class="game-panel">
        <h2 class="panel-header">ğŸ¨ ë‹¬ë¹› ì—¬ê´€</h2>
        <p>ìˆ™ë°•ë¹„: 50G (HP/í”¼ë¡œë„ íšŒë³µ)</p>
        <button class="panel-btn" onclick="sleepAtInn()">ì ìê¸°</button>
        <button class="panel-btn secondary" onclick="closePanel()">ë‚˜ê°€ê¸°</button>
    </div>

    <!-- ì§€ë„ íŒ¨ë„ -->
    <div id="map-panel" class="game-panel">
        <h2 class="panel-header">ì›”ë“œ ë§µ</h2>
        <canvas id="map-canvas"></canvas>
        <button class="ui-btn" style="padding: 5px 20px; font-size: 14px;" onclick="toggleMap()">ë‹«ê¸°</button>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div id="toast">ì•Œë¦¼</div>

    <div id="start-screen" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100; text-align:center; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 style="color:#e74c3c;">ğŸ’€ í•´ê³¨ì˜ ê°ì„±</h1>
        <p style="color:#ccc;">ì¹´ì§€ë…¸ì—ì„œ ìê¸ˆì„ ë§ˆë ¨í•˜ê³ , ì¥ë¹„ë¥¼ ë§ì¶° ë§ˆì™•ì„ ì²˜ë‹¨í•˜ì„¸ìš”!</p>
        <button class="big-btn" onclick="startGameFlow()">ê²Œì„ ì‹œì‘</button>
    </div>

    <div id="damage-container" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:90;"></div>
    <div id="ending-screen" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; text-align:center; padding-top:20%;">
        <h1 style="color:gold;">ğŸ‘‘ ìŠ¹ë¦¬!</h1><button class="big-btn" onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
    
    <div id="mobile-controls">
        <div style="text-align:center;">
            <div class="dpad-btn" onpointerdown="startMove(0,-1)" onpointerup="stopMove()" onpointerleave="stopMove()">â–²</div><br>
            <div class="dpad-btn" onpointerdown="startMove(-1,0)" onpointerup="stopMove()" onpointerleave="stopMove()">â—€</div>
            <div class="dpad-btn" onpointerdown="startMove(0,1)" onpointerup="stopMove()" onpointerleave="stopMove()">â–¼</div>
            <div class="dpad-btn" onpointerdown="startMove(1,0)" onpointerup="stopMove()" onpointerleave="stopMove()">â–¶</div>
        </div>
        <div style="position:absolute; bottom:10px; right:-100px;">
            <div class="action-container"><div id="action-btn">A</div></div>
        </div>
    </div>
</div>

<script>
    // === 1. ì„¤ì • ë° ìƒìˆ˜ ===
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const TILE_SIZE = 40;
    const MAP_SIZE = 512;
    const TILE = { GRASS:0, WATER:1, MOUNTAIN:2, VILLAGE:3, ROAD:4, WALL:5, GATE:6, SHOP:7, CASINO:8, BOSS:9, BOSS_WALL:10, INN:11, SCARECROW:12 };
    const STATE = { MENU: 'menu', EXPLORE: 'explore', DIALOG: 'dialog', MINIGAME: 'minigame', MAP: 'map' };
    
    let currentState = STATE.MENU;
    let camera = { x: 0, y: 0 };
    let mapData = [];
    let enemies = [];
    let particles = [];
    let gatesOpen = false;
    let autoSkill = false;
    let moveTimer = null;
    let boss = null;

    const player = {
        x: 256, y: 256,
        lvl: 1, exp: 0, maxExp: 100,
        gold: 1000,
        str: 10, vit: 10, int: 10, statPoints: 0,
        hp: 100, maxHp: 100,
        mp: 50, maxMp: 50, energy: 100, maxEnergy: 100,
        atk: 0, def: 0,
        equip: { weapon: null, armor: null },
        inventory: [],
        sprite: 'ğŸ’€'
    };

    const skills = {
        smash: { name: "ê°•íƒ€", cost: 10, dmgMult: 2.5, cd: 3000, last: 0 },
        heal: { name: "íšŒë³µ", cost: 20, heal: 30, cd: 5000, last: 0 }
    };

    const itemDB = {
        w1: { name: "ë…¹ìŠ¨ ê²€", type: "weapon", atk: 10, cost: 500, desc: "ì˜¤ë˜ëœ ê²€" },
        w2: { name: "ë¼ˆ ë¶„ì‡„ê¸°", type: "weapon", atk: 30, cost: 2000, desc: "ë‘”ê¸°" },
        w3: { name: "ìš©ì‚¬ì˜ ê²€", type: "weapon", atk: 60, cost: 8000, desc: "ì „ì„¤ ê²€" },
        a1: { name: "ê°€ì£½ ê°‘ì˜·", type: "armor", def: 5, cost: 500, desc: "ê°€ì£½" },
        a2: { name: "ì²  ê°‘ì˜·", type: "armor", def: 15, cost: 2500, desc: "ì² " },
        a3: { name: "ë“œë˜ê³¤ ì•„ë¨¸", type: "armor", def: 40, cost: 10000, desc: "ì „ì„¤ ê°‘ì˜·" },
        p1: { name: "ì²´ë ¥ í¬ì…˜", type: "use", heal: 50, cost: 50, desc: "HP 50 íšŒë³µ" },
        p2: { name: "ë§ˆë‚˜ í¬ì…˜", type: "use", mp: 30, cost: 50, desc: "MP 30 íšŒë³µ" }
    };

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if(typeof updateCamera === 'function') updateCamera();
        if(typeof draw === 'function') draw();
    }
    window.addEventListener('resize', resizeCanvas);

    function init() {
        generateMap();
        resizeCanvas();
        calcStats();
        updateUI();
        requestAnimationFrame(gameLoop);
    }

    function generateMap() {
        for(let y=0; y<MAP_SIZE; y++) mapData.push(new Array(MAP_SIZE).fill(TILE.GRASS));
        for(let i=0; i<400; i++) createBlob(TILE.MOUNTAIN, 10, 25);
        for(let i=0; i<200; i++) createBlob(TILE.WATER, 5, 15);
        for(let i=0; i<50; i++) createBlob(TILE.GRASS, 20, 40);

        const cx = MAP_SIZE/2, cy = MAP_SIZE/2;
        drawRect(cx-15, cy-15, 30, 30, TILE.VILLAGE);
        drawRectBorder(cx-16, cy-16, 32, 32, TILE.WALL);
        mapData[cy-16][cx] = TILE.GATE; mapData[cy+16][cx] = TILE.GATE;
        mapData[cy][cx-16] = TILE.GATE; mapData[cy][cx+16] = TILE.GATE;

        mapData[cy-5][cx] = TILE.SHOP;
        mapData[cy+5][cx] = TILE.INN;
        mapData[cy][cx-8] = TILE.CASINO;
        mapData[cy+2][cx+5] = TILE.SCARECROW;

        createRoad(cx, cy-16, 0, -1, 200);
        createRoad(cx, cy+16, 0, 1, 200);
        createRoad(cx-16, cy, -1, 0, 200);
        createRoad(cx+16, cy, 1, 0, 200);

        drawRect(10, 10, 20, 20, TILE.BOSS_FLOOR);
        drawRectBorder(10, 10, 20, 20, TILE.BOSS_WALL);
        mapData[30][20] = TILE.BOSS_FLOOR;
        boss = {x:20, y:20, type:'boss', name:'ë§ˆì™•', hp:2000, maxHp:2000, atk:100, exp:0, sprite:'ğŸ‘¿'};
        enemies.push(boss);

        spawnZoneEnemies(cx, cy);
    }

    function createRoad(sx, sy, dx, dy, len) {
        for(let i=1; i<len; i++) {
            let x = sx + dx*i, y = sy + dy*i;
            if(x>0 && x<MAP_SIZE && y>0 && y<MAP_SIZE) {
                for(let ty=y-2; ty<=y+2; ty++) for(let tx=x-2; tx<=x+2; tx++) {
                    if(tx>=0 && tx<MAP_SIZE && ty>=0 && ty<MAP_SIZE) {
                        if(mapData[ty][tx] === TILE.WATER || mapData[ty][tx] === TILE.MOUNTAIN) mapData[ty][tx] = TILE.GRASS;
                    }
                }
                mapData[y][x] = TILE.ROAD;
            }
        }
    }

    function spawnZoneEnemies(cx, cy) {
        for(let i=0; i<300; i++) {
            let x = Math.floor(Math.random()*MAP_SIZE);
            let y = Math.floor(Math.random()*MAP_SIZE);
            if(mapData[y][x] !== TILE.GRASS) continue;
            let dist = Math.sqrt((x-cx)**2 + (y-cy)**2);
            if(dist < 30) continue;
            let mob = null;
            if(dist < 100) mob = {name:'ìŠ¬ë¼ì„', hp:30, atk:5, exp:10, sprite:'ğŸ’§'};
            else if(dist < 200) mob = {name:'ê³ ë¸”ë¦°', hp:80, atk:20, exp:30, sprite:'ğŸ‘º'};
            else mob = {name:'ì˜¤í¬', hp:200, atk:50, exp:80, sprite:'ğŸ—'};
            if(mob) enemies.push({x, y, ...mob, maxHp: mob.hp});
        }
    }

    function createBlob(tile, min, max) { 
        let cx = Math.floor(Math.random()*MAP_SIZE), cy = Math.floor(Math.random()*MAP_SIZE);
        let size = Math.floor(Math.random()*(max-min)+min);
        for(let y=cy-size; y<cy+size; y++) for(let x=cx-size; x<cx+size; x++) 
            if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE && Math.random()>0.3) mapData[y][x] = tile;
    }
    function drawRect(x,y,w,h,tile) { for(let j=y; j<y+h; j++) for(let i=x; i<x+w; i++) if(i>=0&&i<MAP_SIZE&&j>=0&&j<MAP_SIZE) mapData[j][i]=tile; }
    function drawRectBorder(x,y,w,h,tile) { for(let j=y; j<=y+h; j++) for(let i=x; i<=x+w; i++) if(i===x||i===x+w||j===y||j===y+h) if(i>=0&&i<MAP_SIZE&&j>=0&&j<MAP_SIZE) mapData[j][i]=tile; }

    function calcStats() {
        let addAtk = player.equip.weapon ? itemDB[player.equip.weapon].atk : 0;
        let addDef = player.equip.armor ? itemDB[player.equip.armor].def : 0;
        player.maxHp = player.vit * 10;
        player.maxMp = player.int * 5;
        player.atk = player.str * 2 + addAtk;
        player.def = Math.floor(player.vit / 2) + addDef;
    }

    function gainExp(amount) {
        player.exp += amount;
        showToast(`ê²½í—˜ì¹˜ +${amount}`);
        if(player.exp >= player.maxExp) {
            player.lvl++;
            player.exp -= player.maxExp;
            player.maxExp = Math.floor(player.maxExp * 1.2);
            player.statPoints += 3;
            player.hp = player.maxHp;
            player.mp = player.maxMp;
            showToast(`â­ ë ˆë²¨ ì—…! (Lv.${player.lvl})`);
        }
        updateUI();
    }

    setInterval(() => {
        if(player.mp < player.maxMp) { player.mp = Math.min(player.maxMp, player.mp + (player.int/5)); updateUI(); }
    }, 1000);

    function gameLoop() {
        if(!mapData.length) return;
        const now = Date.now();
        enemies.forEach(e => {
            if(e.type === 'boss' && e.hp <= 0) return;
            if(!e.lastMove) e.lastMove = 0;
            if(now - e.lastMove > 1000) { 
                let dist = Math.abs(player.x - e.x) + Math.abs(player.y - e.y);
                if(dist < 8) {
                    let dx = Math.sign(player.x - e.x), dy = Math.sign(player.y - e.y);
                    if(Math.abs(player.x - e.x) > Math.abs(player.y - e.y)) dy = 0; else dx = 0;
                    let nx = e.x + dx, ny = e.y + dy;
                    if(nx === player.x && ny === player.y) {
                        let dmg = Math.max(1, e.atk - player.def);
                        player.hp -= dmg;
                        showDamage(player.x, player.y, dmg, 'red');
                        if(player.hp <= 0) gameOver();
                    } else if (mapData[ny][nx] !== TILE.WALL && mapData[ny][nx] !== TILE.WATER) {
                        e.x = nx; e.y = ny;
                    }
                }
                e.lastMove = now;
            }
        });
        
        for(let i=particles.length-1; i>=0; i--) {
            particles[i].update(); if(particles[i].life <= 0) particles.splice(i, 1);
        }

        draw();
        updateUI();
        requestAnimationFrame(gameLoop);
    }

    function attack(targetIdx) {
        const target = enemies[targetIdx];
        if(!consumeEnergy(2)) return;

        let dmg = player.atk;
        const now = Date.now();
        if(autoSkill && player.mp >= skills.smash.cost && now - skills.smash.last > skills.smash.cd) {
            player.mp -= skills.smash.cost;
            skills.smash.last = now;
            dmg = Math.floor(dmg * skills.smash.dmgMult);
            showDamage(target.x, target.y, "ê°•íƒ€!", 'gold');
        }

        target.hp -= dmg;
        showDamage(target.x, target.y, dmg, 'white');
        
        if(target.hp <= 0) {
            gainExp(target.exp);
            player.gold += target.exp * 2;
            if(target.type === 'boss') document.getElementById('ending-screen').style.display = 'block';
            enemies.splice(targetIdx, 1);
        }
        updateUI();
    }

    function triggerSkill(slot) {
        const now = Date.now();
        if(slot === 2) { 
            if(player.mp >= skills.heal.cost && now - skills.heal.last > skills.heal.cd) {
                player.mp -= skills.heal.cost;
                player.hp = Math.min(player.maxHp, player.hp + skills.heal.heal);
                skills.heal.last = now;
                showDamage(player.x, player.y, "Heal", 'lime');
                updateUI();
            } else {
                showToast("ë§ˆë‚˜ ë¶€ì¡± ë˜ëŠ” ì¿¨íƒ€ì„!");
            }
        }
    }

    function movePlayer(dx, dy) {
        let nx = player.x + dx, ny = player.y + dy;
        let enemyIdx = enemies.findIndex(e => e.x === nx && e.y === ny);
        if(enemyIdx !== -1) { attack(enemyIdx); return; }

        if(mapData[ny][nx] === TILE.SCARECROW) {
            if(consumeEnergy(1)) { player.gold+=1; showToast("í—ˆìˆ˜ì•„ë¹„ íˆ­! (+1G)"); }
            return;
        }

        if(nx>=0 && nx<MAP_SIZE && ny>=0 && ny<MAP_SIZE) {
            let t = mapData[ny][nx];
            if(t !== TILE.WATER && t !== TILE.MOUNTAIN && t !== TILE.WALL && t !== TILE.BOSS_WALL) {
                if(t === TILE.GATE && !gatesOpen) { showToast("ë¬´ê¸°ë¥¼ ì¥ì°©í•´ì•¼ ì„±ë¬¸ì´ ì—´ë¦½ë‹ˆë‹¤."); return; }
                player.x = nx; player.y = ny;
                if(t === TILE.SHOP) openShop();
                if(t === TILE.INN) openInn();
                if(t === TILE.CASINO) openCasino();
            }
        }
        updateCamera();
    }

    function updateCamera() {
        camera.x = player.x * TILE_SIZE - window.innerWidth/2;
        camera.y = player.y * TILE_SIZE - window.innerHeight/2;
    }

    function draw() {
        if(!mapData.length) return;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);
        const viewW = Math.ceil(canvas.width / TILE_SIZE) + 2;
        const viewH = Math.ceil(canvas.height / TILE_SIZE) + 2;
        const startCol = Math.floor(camera.x / TILE_SIZE);
        const startRow = Math.floor(camera.y / TILE_SIZE);
        
        for(let y=startRow; y<startRow+viewH; y++) {
            for(let x=startCol; x<startCol+viewW; x++) {
                if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE) {
                    let c = '#222'; let t = mapData[y][x];
                    if(t===TILE.GRASS) c = '#2e8b57'; else if(t===TILE.WATER) c = '#3498db';
                    else if(t===TILE.MOUNTAIN) c = '#555'; else if(t===TILE.ROAD) c = '#8b4513';
                    else if(t===TILE.VILLAGE) c = '#d3a95d'; else if(t===TILE.GATE) c = gatesOpen?'#8b4513':'#3e2723';
                    else if(t===TILE.SHOP) c = '#e67e22'; else if(t===TILE.INN) c = '#16a085';
                    else if(t===TILE.SCARECROW) c = '#d35400';
                    else if(t===TILE.BOSS_FLOOR) c = '#440000'; else if(t===TILE.WALL||t===TILE.BOSS_WALL) c='#4a2c2a';
                    else if(t===TILE.CASINO) c='#8e44ad';
                    
                    ctx.fillStyle = c; ctx.fillRect(x*TILE_SIZE - camera.x, y*TILE_SIZE - camera.y, TILE_SIZE, TILE_SIZE);
                    if(t===TILE.SHOP) drawText('âš’ï¸', x, y);
                    if(t===TILE.INN) drawText('ğŸ¨', x, y);
                    if(t===TILE.CASINO) drawText('ğŸ°', x, y);
                    if(t===TILE.SCARECROW) drawText('ğŸ¯', x, y);
                }
            }
        }
        enemies.forEach(e => {
            if(isInView(e.x, e.y)) {
                drawText(e.sprite, e.x, e.y, 30);
                let sx = e.x*TILE_SIZE - camera.x; let sy = e.y*TILE_SIZE - camera.y;
                ctx.fillStyle='red'; ctx.fillRect(sx, sy-5, 40, 4);
                ctx.fillStyle='lime'; ctx.fillRect(sx, sy-5, 40*(e.hp/e.maxHp), 4);
            }
        });
        particles.forEach(p => p.draw(ctx, -camera.x, -camera.y));
        let px = player.x*TILE_SIZE - camera.x; let py = player.y*TILE_SIZE - camera.y;
        ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(px+20, py+35, 10, 5, 0, 0, Math.PI*2); ctx.fill();
        if(player.equip.weapon) { ctx.font='20px sans-serif'; ctx.fillText('âš”ï¸', px-10, py+25); }
        ctx.font='30px sans-serif'; ctx.fillText(player.sprite, px+5, py+30);
        if(player.equip.armor) { ctx.font='20px sans-serif'; ctx.fillText('ğŸ›¡ï¸', px+30, py+25); }
    }

    function drawText(txt, x, y, size=24) {
        let sx = x*TILE_SIZE - camera.x; let sy = y*TILE_SIZE - camera.y;
        if(sx > -TILE_SIZE && sx < canvas.width && sy > -TILE_SIZE && sy < canvas.height) {
            ctx.font = `${size}px Arial`; ctx.fillText(txt, sx+5, sy+30);
        }
    }
    function isInView(x, y) { return x*TILE_SIZE - camera.x > -TILE_SIZE && x*TILE_SIZE - camera.x < canvas.width && y*TILE_SIZE - camera.y > -TILE_SIZE && y*TILE_SIZE - camera.y < canvas.height; }

    function updateUI() {
        calcStats();
        document.getElementById('ui-lvl').innerText = player.lvl;
        document.getElementById('ui-gold').innerText = player.gold;
        document.getElementById('ui-hp-bar').style.width = `${(player.hp/player.maxHp)*100}%`;
        document.getElementById('ui-mp-bar').style.width = `${(player.mp/player.maxMp)*100}%`;
        document.getElementById('ui-exp-bar').style.width = `${(player.exp/player.maxExp)*100}%`;
        document.getElementById('ui-stat-points').innerText = player.statPoints;
        document.getElementById('val-str').innerText = player.str;
        document.getElementById('val-vit').innerText = player.vit;
        document.getElementById('val-int').innerText = player.int;
        document.getElementById('total-atk').innerText = player.atk;
        document.getElementById('total-def').innerText = player.def;
        updateCooldownUI('cd-1', skills.smash);
        updateCooldownUI('cd-2', skills.heal);
    }
    function updateCooldownUI(id, skill) {
        const el = document.getElementById(id);
        const diff = Date.now() - skill.last;
        if(diff < skill.cd) { el.style.display='flex'; el.innerText=((skill.cd-diff)/1000).toFixed(1); } else el.style.display='none';
    }

    window.toggleAutoSkill = () => { autoSkill = !autoSkill; document.getElementById('skill-1').classList.toggle('active', autoSkill); showToast(autoSkill?"ìë™ ìŠ¤í‚¬ ON":"ìë™ ìŠ¤í‚¬ OFF"); };
    window.upStat = (type) => { if(player.statPoints>0){ player.statPoints--; player[type]++; calcStats(); updateUI(); } };
    window.useSkill = (s) => triggerSkill(s);
    window.toggleMenu = () => { let p = document.getElementById('menu-panel'); p.style.display = p.style.display==='block'?'none':'block'; switchTab('status'); };
    window.switchTab = (t) => {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('selected'));
        document.getElementById('tab-btn-'+t).classList.add('selected');
        document.getElementById('tab-status').style.display=t==='status'?'block':'none';
        document.getElementById('tab-inventory').style.display=t==='inventory'?'block':'none';
        if(t==='inventory') renderInventory();
    };
    function renderInventory() {
        const l = document.getElementById('inv-list'); l.innerHTML='';
        player.inventory.forEach(id => {
            const i = itemDB[id]; const d = document.createElement('div'); d.className='inv-item';
            if(player.equip.weapon===id || player.equip.armor===id) d.classList.add('equipped');
            d.innerHTML = `<span class="item-name">${i.name}</span><span class="item-desc">${i.desc}</span><button class="item-btn" onclick="equipItem('${id}')">${(player.equip.weapon === id || player.equip.armor === id) ? 'í•´ì œ' : 'ì¥ì°©/ì‚¬ìš©'}</button>`;
            l.appendChild(d);
        });
    }
    window.equipItem = (id) => {
        const i = itemDB[id];
        if(i.type === 'use') {
            if(i.heal) player.hp = Math.min(player.maxHp, player.hp + i.heal);
            if(i.mp) player.mp = Math.min(player.maxMp, player.mp + i.mp);
            showToast(`${i.name} ì‚¬ìš©í•¨`);
            const idx = player.inventory.indexOf(id);
            if(idx > -1) player.inventory.splice(idx, 1);
        } else if(i.type==='weapon') {
            player.equip.weapon = (player.equip.weapon===id)?null:id;
            if(i.type==='weapon' && player.equip.weapon) gatesOpen=true; 
        } else if(i.type==='armor') {
            player.equip.armor = (player.equip.armor===id)?null:id;
        }
        calcStats(); updateUI(); renderInventory();
    };
    function openShop() { document.getElementById('shop-panel').style.display='block'; renderShop(); }
    function openInn() { document.getElementById('inn-panel').style.display='block'; }
    
    function openCasino() { 
        document.getElementById('casino-panel').style.display='block'; 
        backToMenu(); // ì´ì œ í•¨ìˆ˜ ì„ ì–¸ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ í˜¸ì¶œë¨
    }
    
    window.closePanel = () => document.querySelectorAll('.game-panel').forEach(e=>e.style.display='none');
    
    function renderShop() {
        const l = document.getElementById('shop-list'); l.innerHTML='';
        for(let id in itemDB) {
            const i = itemDB[id]; const d = document.createElement('div'); d.className='inv-item';
            d.innerHTML=`<span class="item-name">${i.name}</span><span class="item-desc">${i.desc}</span><button class="item-btn" style="background:#e67e22" onclick="buyItem('${id}')">${i.cost}G êµ¬ë§¤</button>`;
            l.appendChild(d);
        }
    }
    window.buyItem = (id) => {
        const i = itemDB[id];
        if(player.gold >= i.cost) {
            player.gold -= i.cost;
            player.inventory.push(id); 
            showToast("êµ¬ë§¤ ì™„ë£Œ");
            if(i.type === 'weapon') gatesOpen = true; 
            updateUI();
        } else showToast("ê³¨ë“œ ë¶€ì¡±");
    };
    window.sleepAtInn = () => {
        if(player.gold >= 50) { player.gold -= 50; player.hp = player.maxHp; player.mp = player.maxMp; player.energy = 100; showToast("íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤."); updateUI(); window.closePanel(); }
        else showToast("ê³¨ë“œ ë¶€ì¡±");
    };

    window.toggleMap = () => {
        const p = document.getElementById('map-panel');
        if(p.style.display==='block') { p.style.display='none'; return; }
        p.style.display='block';
        const mc = document.getElementById('map-canvas'); const mctx = mc.getContext('2d');
        mctx.fillStyle='#000'; mctx.fillRect(0,0,250,250);
        const step = MAP_SIZE/250;
        for(let y=0; y<250; y++) {
            for(let x=0; x<250; x++) {
                let mx = Math.floor(x*step), my = Math.floor(y*step);
                let t = mapData[my][mx], c = '#000';
                if(t===TILE.GRASS) c='#2e8b57'; else if(t===TILE.WATER) c='#3498db'; else if(t===TILE.ROAD) c='#8b4513';
                else if(t===TILE.VILLAGE) c='#d3a95d'; else if(t===TILE.BOSS_FLOOR) c='#440000';
                mctx.fillStyle=c; mctx.fillRect(x,y,1,1);
            }
        }
        mctx.fillStyle='white'; mctx.fillRect(player.x/step, player.y/step, 3, 3);
    };

    window.showToast = (msg) => { const t = document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); };
    function showDamage(x, y, dmg, color) {
        const el = document.createElement('div'); el.className='damage-text';
        el.style.left = (x*TILE_SIZE - camera.x + 10)+'px'; el.style.top = (y*TILE_SIZE - camera.y)+'px';
        el.innerText = dmg; el.style.color = color;
        document.getElementById('damage-container').appendChild(el);
        setTimeout(()=>el.remove(), 800);
    }
    function gameOver() { alert("ì‚¬ë§í–ˆìŠµë‹ˆë‹¤."); player.hp=player.maxHp; player.x=256; player.y=256; }
    window.startGameFlow = () => document.getElementById('start-screen').style.display='none';
    window.saveGame = () => { localStorage.setItem('save_v71', JSON.stringify(player)); showToast("ì €ì¥ë¨"); };
    function consumeEnergy(a) { if(player.energy >= a) { player.energy -= a; return true; } showToast("í”¼ë¡œë„ ë¶€ì¡±"); return false; }
    
    // íŒŒí‹°í´
    class Particle { constructor(x,y,c){this.x=x;this.y=y;this.color=c;this.vx=(Math.random()-0.5)*10;this.vy=(Math.random()-0.5)*10;this.life=1.0;} update(){this.x+=this.vx;this.y+=this.vy;this.life-=0.05;} draw(ctx,ox,oy){ctx.globalAlpha=this.life;ctx.fillStyle=this.color;ctx.fillRect(this.x+ox,this.y+oy,4,4);ctx.globalAlpha=1.0;} }
    function spawnParticles(x,y,c,n=10){ for(let i=0;i<n;i++) particles.push(new Particle(x*TILE_SIZE+20,y*TILE_SIZE+20,c)); }

    // === ì¹´ì§€ë…¸ ===
    function getBetAmount(){ const v = parseInt(document.getElementById('bet-input').value); return (isNaN(v) || v < 10) ? 10 : v; }
    function checkGold(a){ if(player.gold < a) { showToast("ê³¨ë“œ ë¶€ì¡±"); return false; } if(!consumeEnergy(2)) return false; player.gold -= a; updateUI(); return true; }
    
    // ì¹´ì§€ë…¸ UI ê´€ë¦¬ í•¨ìˆ˜ë“¤ (ì„ ì–¸ì‹ìœ¼ë¡œ ë³€ê²½)
    function backToMenu() { 
        document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active')); 
        document.getElementById('casino-menu').style.display = 'grid'; 
    }
    
    function showGame(gameId) {
        document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active')); 
        document.getElementById('casino-menu').style.display = 'none';
        document.getElementById('game-' + gameId).classList.add('active'); 
        document.querySelectorAll('.result-msg').forEach(el => el.innerText = '');
        if(gameId==='racing') initRaceCanvas(); 
        if(gameId==='roulette') initRoulette(); 
        if(gameId==='blackjack') initBlackjack(); 
        if(gameId==='slots') initSlots(); 
        if(gameId==='sicbo') initSicBo(); 
        if(gameId==='rps') initRPS();
    }
    
    // ë¸”ë™ì­
    const bjCanvas = document.getElementById('bj-canvas'); const bjCtx = bjCanvas.getContext('2d'); let bjState={p:[],d:[]}; let currentBet=0;
    function initBlackjack(){bjState={p:[],d:[]};drawBj();document.getElementById('bj-controls').classList.remove('hidden');document.getElementById('bj-actions').classList.add('hidden');}
    function drawBj(){ bjCtx.clearRect(0,0,300,200); bjCtx.fillStyle='#aaa'; bjCtx.textAlign='center'; bjCtx.fillText("ë”œëŸ¬",150,30); bjState.d.forEach((c,i)=>drawCard(150+(i-bjState.d.length/2)*30,50,c)); bjCtx.fillText("ë‚˜",150,150); bjState.p.forEach((c,i)=>drawCard(150+(i-bjState.p.length/2)*30,110,c)); if(bjState.p.length>0){bjCtx.fillStyle='white'; bjCtx.fillText(getSum(bjState.p),150,180); bjCtx.fillText(bjState.d.length==1?"?":getSum(bjState.d),150,20);} }
    function drawCard(x,y,v){ bjCtx.fillStyle='white'; bjCtx.fillRect(x-12,y-18,24,36); bjCtx.strokeStyle='#000'; bjCtx.strokeRect(x-12,y-18,24,36); bjCtx.fillStyle='black'; bjCtx.fillText(v,x,y+5); }
    function startBlackjack(){ currentBet=getBetAmount(); if(!checkGold(currentBet)) return; bjState={p:[rCard(),rCard()],d:[rCard()]}; drawBj(); document.getElementById('bj-controls').classList.add('hidden'); document.getElementById('bj-actions').style.display='block'; document.getElementById('bj-result').innerText=''; }
    function rCard(){return Math.floor(Math.random()*10)+2;}
    function getSum(h){return h.reduce((a,b)=>a+(b==='?'?0:b),0);}
    function bjHit(){ bjState.p.push(rCard()); drawBj(); if(getSum(bjState.p)>21) endBj(false, "ë²„ìŠ¤íŠ¸!"); }
    function bjStand(){ while(getSum(bjState.d)<17) bjState.d.push(rCard()); drawBj(); let p=getSum(bjState.p), d=getSum(bjState.d); if(d>21 || p>d) endBj(true, "ìŠ¹ë¦¬!"); else if(p==d){ player.gold+=currentBet; endBj(false, "ë¬´ìŠ¹ë¶€"); } else endBj(false, "íŒ¨ë°°"); }
    function endBj(w,m){ document.getElementById('bj-result').innerText=m; if(w){ player.gold+=currentBet*2; updateUI(); } setTimeout(()=>{ document.getElementById('bj-controls').classList.remove('hidden'); document.getElementById('bj-actions').style.display='none'; }, 1500); }

    // ë£°ë ›
    const rCanvas = document.getElementById('roulette-canvas'); const rCtx = rCanvas.getContext('2d');
    function startRoulette(t){ currentBet=getBetAmount(); if(!checkGold(currentBet)) return; let rot=0, s=0.5; 
        function loop(){ s-=0.005; rot+=s; drawWheel(rot); if(s>0) requestAnimationFrame(loop); else calcR(rot, t); } loop();
    }
    function initRoulette(){drawWheel(0);document.getElementById('roulette-btns').style.display='block';}
    function drawWheel(r){ rCtx.clearRect(0,0,300,300); rCtx.save(); rCtx.translate(150,150); rCtx.rotate(r); for(let i=0;i<12;i++){ rCtx.beginPath(); rCtx.arc(0,0,140,i*Math.PI/6,(i+1)*Math.PI/6); rCtx.lineTo(0,0); rCtx.fillStyle=i%2==0?'red':'black'; rCtx.fill(); rCtx.save(); rCtx.rotate(i*Math.PI/6+Math.PI/12); rCtx.fillStyle='white'; rCtx.fillText(i+1, 120, 5); rCtx.restore(); } rCtx.restore(); rCtx.fillStyle='gold'; rCtx.fillRect(145,0,10,20); }
    function calcR(rot, t){ let angle=rot%(Math.PI*2), ptr=(Math.PI*1.5-angle)%(Math.PI*2); if(ptr<0) ptr+=Math.PI*2; let res=Math.floor(ptr/(Math.PI/6))+1; let w=false, m=0; if(t=='odd'&&res%2!=0){w=true;m=2;} else if(t=='even'&&res%2==0){w=true;m=2;} else if(t=='lucky7'&&res==7){w=true;m=10;} document.getElementById('roulette-result').innerText = w ? `ë‹¹ì²¨! ${res}` : `ê½! ${res}`; if(w){ player.gold+=currentBet*m; updateUI(); } }

    // ìŠ¬ë¡¯
    const sCtx = document.getElementById('slot-canvas').getContext('2d'); const syms=['ğŸ’','ğŸ‹','ğŸ‡','ğŸ’','7ï¸âƒ£'];
    function spinSlots(){ currentBet=getBetAmount(); if(!checkGold(currentBet)) return; let res=[0,0,0].map(()=>Math.floor(Math.random()*5)); let t=[0,0,0], c=[0,0,0], st=null; for(let i=0;i<3;i++) t[i]=(5+i*3)*400+(275-res[i]*80)%400; 
        function ani(ts){ if(!st)st=ts; let p=ts-st, fin=0; for(let i=0;i<3;i++){ let d=1000+i*1000; if(p<d){ let e=1-Math.pow(1-p/d,3); c[i]=t[i]*e; } else { c[i]=t[i]; fin++; } } drawS(c); if(fin<3) requestAnimationFrame(ani); else checkS(res); } requestAnimationFrame(ani);
    }
    function initSlots(){drawS([0,0,0]);}
    function drawS(o){ sCtx.clearRect(0,0,300,150); sCtx.fillStyle='#333'; sCtx.fillRect(10,10,280,130); for(let i=0;i<3;i++){ sCtx.save(); sCtx.beginPath(); sCtx.rect(20+i*90,20,80,110); sCtx.clip(); for(let j=0;j<10;j++) sCtx.fillText(syms[j%5], 40+i*90, j*80+(o[i]%400)-200); sCtx.restore(); } }
    function checkS(r){ let w=0; if(r[0]==4&&r[1]==4&&r[2]==4)w=50; else if(r[0]==r[1]&&r[1]==r[2])w=10; else if(r[0]==r[1]||r[1]==r[2]||r[0]==r[2])w=2; document.getElementById('slot-result').innerText = w>0 ? `ë‹¹ì²¨! x${w}` : "ê½"; if(w>0){ player.gold+=currentBet*w; updateUI(); } }
    
    // ê²½ë§ˆ
    const rcCtx = document.getElementById('race-canvas').getContext('2d');
    function startRace(p){ currentBet=getBetAmount(); if(!checkGold(currentBet)) return; let h=[0,0,0,0], t=setInterval(()=>{ rcCtx.clearRect(0,0,350,200); let w=null; h.forEach((v,i)=>{ h[i]+=Math.random()*5; rcCtx.fillText('ğŸ', h[i], i*40+40); if(h[i]>300 && !w) w=i+1; }); if(w){ clearInterval(t); let m=document.getElementById('race-result'); if(w==p){ player.gold+=currentBet*4; m.innerText=`ìŠ¹ë¦¬! ${w}ë²ˆ`; } else m.innerText=`íŒ¨ë°°.. ${w}ë²ˆ`; updateUI(); } }, 30); }
    function initRaceCanvas(){ rcCtx.clearRect(0,0,350,200); rcCtx.fillStyle='#2e7d32'; rcCtx.fillRect(0,0,350,200); rcCtx.strokeStyle='white'; rcCtx.setLineDash([5,5]); for(let i=1;i<4;i++){rcCtx.beginPath();rcCtx.moveTo(0,i*50);rcCtx.lineTo(350,i*50);rcCtx.stroke();} rcCtx.setLineDash([]); rcCtx.fillStyle='red'; rcCtx.fillRect(320,0,5,200); for(let i=0;i<4;i++) drawHorse(10,i*50+35,i+1); document.getElementById('race-btns').style.display='block'; }
    function drawHorse(x,y,n){ rcCtx.save(); rcCtx.translate(x,y); rcCtx.scale(-1,1); rcCtx.font='30px Arial'; rcCtx.fillText('ğŸ',-15,0); rcCtx.restore(); rcCtx.fillStyle='white'; rcCtx.font='12px Arial'; rcCtx.fillText(n,x-5,y+5); }
    
    // ë‹¤ì´ì‚¬ì´
    const scCtx = document.getElementById('sicbo-canvas').getContext('2d');
    function playSicBo(p){ currentBet=getBetAmount(); if(!checkGold(currentBet)) return; let d=[0,0,0].map(()=>Math.floor(Math.random()*6)+1); scCtx.clearRect(0,0,300,200); scCtx.fillText(`ğŸ² ${d.join(' ')}`, 100, 100); let s=d.reduce((a,b)=>a+b), r=(s>=4&&s<=10)?'small':'big'; if(d[0]==d[1]&&d[1]==d[2]) r='triple'; let m=document.getElementById('sicbo-result'); if(p==r){ player.gold+=currentBet*2; m.innerText="ì ì¤‘!"; } else m.innerText="ì‹¤íŒ¨"; updateUI(); }
    function initSicBo(){ scCtx.clearRect(0,0,300,200); scCtx.beginPath(); scCtx.arc(150,100,80,0,6.28); scCtx.fillStyle='rgba(0,0,0,0.3)'; scCtx.fill(); scCtx.stroke(); drawDice(130,100,1); drawDice(170,100,2); drawDice(150,80,3); document.getElementById('sicbo-btns').style.display='block'; }
    function drawDice(x,y,n,a=0){ scCtx.save(); scCtx.translate(x,y); scCtx.rotate(a); scCtx.fillStyle='white'; scCtx.fillRect(-15,-15,30,30); scCtx.strokeRect(-15,-15,30,30); scCtx.fillStyle='black'; scCtx.font='20px Arial'; scCtx.textAlign='center'; scCtx.fillText(['âš€','âš','âš‚','âšƒ','âš„','âš…'][n-1],0,8); scCtx.restore(); }
    
    // ê°€ìœ„ë°”ìœ„ë³´
    const rpsCanvas = document.getElementById('rps-canvas');
    const rpsCtx = rpsCanvas ? rpsCanvas.getContext('2d') : null;
    function playRPS(c){ currentBet=getBetAmount(); if(!checkGold(currentBet)) return; let com=['rock','scissors','paper'][Math.floor(Math.random()*3)]; 
        rpsCtx.clearRect(0,0,300,250); rpsCtx.fillText(`YOU: ${c}  COM: ${com}`, 100, 100);
        let r='lose'; if(c==com) r='draw'; else if((c=='scissors'&&com=='paper')||(c=='rock'&&com=='scissors')||(c=='paper'&&com=='rock')) r='win';
        let m=document.getElementById('rps-result'); 
        if(r=='win'){ m.innerText="ìŠ¹ë¦¬! ë£°ë › ì°¬ìŠ¤!"; document.getElementById('rps-bonus-btn').style.display='block'; }
        else if(r=='draw'){ m.innerText="ë¬´ìŠ¹ë¶€"; player.gold+=currentBet; updateUI(); } else m.innerText="íŒ¨ë°°";
    }
    function initRPS() { if(!rpsCtx) return; drawRPS('?', '?'); document.getElementById('rps-btns').style.display='block'; document.getElementById('rps-bonus-btn').style.display='none'; document.getElementById('rps-result').innerText="ì„ íƒí•˜ì„¸ìš”"; }
    function drawRPS(p, c) { rpsCtx.clearRect(0,0,300,250); rpsCtx.fillStyle='#222'; rpsCtx.fillRect(0,0,300,250); rpsCtx.fillStyle='white'; rpsCtx.font='20px Arial'; rpsCtx.textAlign='center'; rpsCtx.fillText("YOU",75,40); rpsCtx.fillText("COM",225,40); rpsCtx.font='60px Arial'; rpsCtx.fillText(getHand(p),75,120); rpsCtx.fillText(getHand(c),225,120); rpsCtx.font='30px Arial'; rpsCtx.fillStyle='red'; rpsCtx.fillText("VS",150,120); }
    function getHand(t) { if(t=='rock')return 'âœŠ'; if(t=='scissors')return 'âœŒï¸'; if(t=='paper')return 'âœ‹'; return 'â“'; }
    function spinRpsWheel(){ document.getElementById('rps-bonus-btn').style.display='none'; let mul=[1,2,3,4,0,1][Math.floor(Math.random()*6)]; player.gold+=currentBet*mul; updateUI(); document.getElementById('rps-result').innerText = mul>0 ? `x${mul} ë‹¹ì²¨!` : "ê½!"; setTimeout(()=>document.getElementById('rps-btns').style.display='block', 2000); }
    
    // í‚¤ë³´ë“œ & í„°ì¹˜
    window.addEventListener('keydown', e => {
        if(e.key==='ArrowUp') movePlayer(0,-1); if(e.key==='ArrowDown') movePlayer(0,1);
        if(e.key==='ArrowLeft') movePlayer(-1,0); if(e.key==='ArrowRight') movePlayer(1,0);
        if(e.key==='c'||e.key==='C') toggleMenu(); if(e.key==='m'||e.key==='M') toggleMap();
        if(e.key===' ') {
            let closeIdx = -1, minD = 2;
            enemies.forEach((en, i) => {
                let d = Math.abs(en.x-player.x) + Math.abs(en.y-player.y);
                if(d < minD) { minD = d; closeIdx = i; }
            });
            if(closeIdx !== -1) attack(closeIdx);
        }
    });
    window.startMove = (dx,dy) => { movePlayer(dx,dy); moveTimer = setInterval(()=>movePlayer(dx,dy), 150); };
    window.stopMove = () => clearInterval(moveTimer);

    init();

</script>
</body>
</html>
