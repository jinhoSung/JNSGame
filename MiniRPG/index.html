<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Skeleton Knight's Revenge</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: 'DungGeunMo', monospace; /* í”½ì…€ í°íŠ¸ ëŠë‚Œ */
            overflow: hidden;
        }
        #game-ui {
            position: relative;
            width: 800px;
            height: 600px;
            border: 4px solid #555;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        canvas {
            background-color: #000;
            image-rendering: pixelated;
            display: block;
        }
        /* UI ì˜¤ë²„ë ˆì´ (ëŒ€í™”ì°½, ìŠ¤íƒ¯ì°½ ë“±) */
        .overlay {
            position: absolute;
            pointer-events: none; /* í´ë¦­ í†µê³¼ */
            text-shadow: 2px 2px 0 #000;
        }
        #stat-bar {
            top: 10px;
            left: 10px;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #888;
        }
        #dialog-box {
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #fff;
            padding: 20px;
            font-size: 18px;
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            white-space: pre-line;
        }
        /* ë¯¸ë‹ˆê²Œì„ UI (HTMLë¡œ ë„ì›€) */
        #casino-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background: #2c3e50;
            border: 4px solid gold;
            padding: 20px;
            display: none;
            text-align: center;
            pointer-events: auto;
        }
        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #c0392b; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="game-ui">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <!-- ìŠ¤íƒ¯ ì°½ -->
        <div id="stat-bar" class="overlay">
            ğŸ’€ í•´ê³¨ ê¸°ì‚¬ (Lv.1) | ğŸ’° ê³¨ë“œ: <span id="gold-display">0</span>G | ğŸ“ ìœ„ì¹˜: <span id="loc-display">ë§ˆì„</span>
        </div>

        <!-- ëŒ€í™” ì°½ -->
        <div id="dialog-box" class="overlay"></div>

        <!-- ì¹´ì§€ë…¸ ë¯¸ë‹ˆê²Œì„ íŒ¨ë„ -->
        <div id="casino-panel">
            <h2 style="color:gold;">ğŸ° ê³ ë¸”ë¦° ì¹´ì§€ë…¸ (ë¸”ë™ì­)</h2>
            <p>ë”œëŸ¬ë³´ë‹¤ ë†’ì€ ìˆ˜ë¥¼ ë½‘ìœ¼ì„¸ìš”! (21 ì´ˆê³¼ ì‹œ íŒ¨ë°°)</p>
            <div id="blackjack-game">
                <p>ë‚´ ì ìˆ˜: <span id="p-score">0</span> | ë”œëŸ¬ ì ìˆ˜: <span id="d-score">?</span></p>
                <div id="game-result" style="height:30px; font-weight:bold; color:yellow;"></div>
                <button onclick="hit()">íˆíŠ¸ (í•œì¥ ë”)</button>
                <button onclick="stand()">ìŠ¤íƒ ë“œ (ë©ˆì¶¤)</button>
                <button onclick="exitCasino()" style="background:#555;">ë‚˜ê°€ê¸°</button>
            </div>
            <div id="betting-controls">
                <p>íŒëˆ: 100G</p>
                <button onclick="startGame()">ê²Œì„ ì‹œì‘ (-100G)</button>
                <button onclick="exitCasino()" style="background:#555;">ë‚˜ê°€ê¸°</button>
            </div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const dialogBox = document.getElementById('dialog-box');
    const goldDisplay = document.getElementById('gold-display');
    const locDisplay = document.getElementById('loc-display');
    const casinoPanel = document.getElementById('casino-panel');
    const bettingControls = document.getElementById('betting-controls');
    const blackjackGame = document.getElementById('blackjack-game');

    // ==========================================
    // 1. ê²Œì„ ì„¤ì • ë° ìƒíƒœ ê´€ë¦¬
    // ==========================================
    const TILE_SIZE = 40;
    const MAP_SIZE = 512; // 512x512 ë§µ
    
    // íƒ€ì¼ íƒ€ì…
    const TILE = {
        GRASS: 0,
        WATER: 1,
        MOUNTAIN: 2,
        VILLAGE_FLOOR: 3,
        WALL: 4,
        CASINO: 9, // ë„ë°•ì¥
        DUNGEON: 8
    };

    // ê²Œì„ ìƒíƒœ
    const STATE = {
        EXPLORE: 'explore',
        DIALOG: 'dialog',
        MINIGAME: 'minigame'
    };
    let currentState = STATE.EXPLORE;

    // í”Œë ˆì´ì–´ ì •ë³´
    const player = {
        x: 256, // ë§µ ì¤‘ì•™ì—ì„œ ì‹œì‘
        y: 256,
        gold: 500,
        inventory: [],
        sprite: 'ğŸ’€' // í•´ê³¨ ìºë¦­í„°
    };

    // ì¹´ë©”ë¼ (í™”ë©´ì— ë³´ì—¬ì¤„ ë§µì˜ ì¢Œìƒë‹¨ ì¢Œí‘œ)
    let camera = { x: 0, y: 0 };

    // ==========================================
    // 2. ë§µ ìƒì„± (Procedural Generation)
    // ==========================================
    const mapData = [];

    function generateMap() {
        console.log("ê±°ëŒ€í•œ ì„¸ê³„ë¥¼ ìƒì„± ì¤‘...");
        
        // 1. ì „ì²´ë¥¼ í’€ë°­ìœ¼ë¡œ ì´ˆê¸°í™”
        for(let y=0; y<MAP_SIZE; y++) {
            const row = [];
            for(let x=0; x<MAP_SIZE; x++) {
                row.push(TILE.GRASS);
            }
            mapData.push(row);
        }

        // 2. ëœë¤ ì‚°ê³¼ í˜¸ìˆ˜ ìƒì„± (ê°„ë‹¨í•œ ì•Œê³ ë¦¬ì¦˜)
        for(let i=0; i<800; i++) {
            createBlob(TILE.MOUNTAIN, 10, 30); // ì‚°ë§¥
        }
        for(let i=0; i<400; i++) {
            createBlob(TILE.WATER, 5, 15); // í˜¸ìˆ˜
        }

        // 3. ì¤‘ì•™ ë§ˆì„ ìƒì„± (ì•ˆì „ì§€ëŒ€)
        const center = MAP_SIZE / 2;
        for(let y=center-10; y<center+10; y++) {
            for(let x=center-10; x<center+10; x++) {
                mapData[y][x] = TILE.VILLAGE_FLOOR;
            }
        }
        
        // 4. ì¹´ì§€ë…¸ ë°°ì¹˜ (ë§ˆì„ ì¤‘ì•™)
        mapData[center-5][center] = TILE.CASINO;
        mapData[center-5][center+1] = TILE.CASINO;

        console.log("ë§µ ìƒì„± ì™„ë£Œ!");
    }

    // ë©ì–´ë¦¬(Blob)ë¥¼ ë§Œë“œëŠ” í•¨ìˆ˜
    function createBlob(type, minSize, maxSize) {
        let cx = Math.floor(Math.random() * MAP_SIZE);
        let cy = Math.floor(Math.random() * MAP_SIZE);
        let size = Math.floor(Math.random() * (maxSize - minSize) + minSize);

        for(let y=cy-size; y<cy+size; y++) {
            for(let x=cx-size; x<cx+size; x++) {
                if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE) {
                    // ì›í˜•ì— ê°€ê¹ê²Œ ê¹ê¸°
                    if(Math.random() > 0.3) mapData[y][x] = type; 
                }
            }
        }
    }

    generateMap();

    // ==========================================
    // 3. ê²Œì„ ë£¨í”„ ë° ë Œë”ë§ (ì¹´ë©”ë¼ ì‹œìŠ¤í…œ)
    // ==========================================
    function updateCamera() {
        // í”Œë ˆì´ì–´ë¥¼ í™”ë©´ ì¤‘ì•™ì— ì˜¤ê²Œ í•˜ê¸° ìœ„í•œ ì¹´ë©”ë¼ ì¢Œí‘œ ê³„ì‚°
        // ì¹´ë©”ë¼X = í”Œë ˆì´ì–´X * íƒ€ì¼í¬ê¸° - í™”ë©´ë„ˆë¹„/2
        camera.x = player.x * TILE_SIZE - canvas.width / 2 + (TILE_SIZE / 2);
        camera.y = player.y * TILE_SIZE - canvas.height / 2 + (TILE_SIZE / 2);

        // ë§µ ë°–ì„ ë³´ì—¬ì£¼ì§€ ì•Šë„ë¡ ì œí•œ (Clamping)
        const maxScrollX = MAP_SIZE * TILE_SIZE - canvas.width;
        const maxScrollY = MAP_SIZE * TILE_SIZE - canvas.height;

        if (camera.x < 0) camera.x = 0;
        if (camera.y < 0) camera.y = 0;
        if (camera.x > maxScrollX) camera.x = maxScrollX;
        if (camera.y > maxScrollY) camera.y = maxScrollY;
    }

    function draw() {
        // í™”ë©´ ì§€ìš°ê¸°
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ì¹´ë©”ë¼ ê¸°ì¤€ í™”ë©´ì— ë³´ì¼ íƒ€ì¼ì˜ ë²”ìœ„ ê³„ì‚° (ìµœì í™”)
        const startCol = Math.floor(camera.x / TILE_SIZE);
        const endCol = startCol + (canvas.width / TILE_SIZE) + 1;
        const startRow = Math.floor(camera.y / TILE_SIZE);
        const endRow = startRow + (canvas.height / TILE_SIZE) + 1;

        // ì˜¤í”„ì…‹ (ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ì„ ìœ„í•´ ë¯¸ì„¸ ì¡°ì •ê°’)
        const offsetX = -camera.x + startCol * TILE_SIZE;
        const offsetY = -camera.y + startRow * TILE_SIZE;

        for (let y = startRow; y <= endRow; y++) {
            for (let x = startCol; x <= endCol; x++) {
                if (y >= 0 && y < MAP_SIZE && x >= 0 && x < MAP_SIZE) {
                    const tile = mapData[y][x];
                    
                    // íƒ€ì¼ ê·¸ë¦¬ê¸°
                    let color = '#000';
                    if (tile === TILE.GRASS) color = '#2e8b57'; // ìˆ²
                    else if (tile === TILE.WATER) color = '#3498db'; // ê°•
                    else if (tile === TILE.MOUNTAIN) color = '#555'; // ì‚°
                    else if (tile === TILE.VILLAGE_FLOOR) color = '#d3a95d'; // ë§ˆì„ ë°”ë‹¥
                    else if (tile === TILE.CASINO) color = '#8e44ad'; // ë„ë°•ì¥ (ë³´ë¼ìƒ‰)
                    
                    ctx.fillStyle = color;
                    ctx.fillRect(
                        (x - startCol) * TILE_SIZE + offsetX,
                        (y - startRow) * TILE_SIZE + offsetY,
                        TILE_SIZE, TILE_SIZE
                    );

                    // ê±´ë¬¼/ì˜¤ë¸Œì íŠ¸ í‘œì‹œ
                    if (tile === TILE.CASINO) {
                        ctx.font = '20px Arial';
                        ctx.fillText("ğŸ°", (x - startCol) * TILE_SIZE + offsetX + 8, (y - startRow) * TILE_SIZE + offsetY + 28);
                    }
                    if (tile === TILE.MOUNTAIN) {
                        ctx.fillStyle = 'rgba(0,0,0,0.3)'; // ì‚° ê·¸ë¦¼ì
                        ctx.fillRect((x - startCol) * TILE_SIZE + offsetX, (y - startRow) * TILE_SIZE + offsetY, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
        }

        // í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸° (í•­ìƒ í™”ë©´ ì¤‘ì•™ ê·¼ì²˜ì— ìœ„ì¹˜í•˜ê²Œ ë¨)
        // ì‹¤ì œ í™”ë©´ ì¢Œí‘œ = (í”Œë ˆì´ì–´ ì›”ë“œì¢Œí‘œ - ì¹´ë©”ë¼ ì›”ë“œì¢Œí‘œ)
        const playerScreenX = player.x * TILE_SIZE - camera.x;
        const playerScreenY = player.y * TILE_SIZE - camera.y;

        ctx.font = '35px Arial';
        ctx.fillText(player.sprite, playerScreenX + 2, playerScreenY + 32);

        // UI ì—…ë°ì´íŠ¸
        goldDisplay.innerText = player.gold;
    }

    // ==========================================
    // 4. ì…ë ¥ ë° ì´ë™ ì²˜ë¦¬
    // ==========================================
    window.addEventListener('keydown', (e) => {
        if (currentState !== STATE.EXPLORE) {
            if (currentState === STATE.DIALOG && e.key === ' ') closeDialog();
            return;
        }

        let nextX = player.x;
        let nextY = player.y;

        if (e.key === 'ArrowUp') nextY--;
        if (e.key === 'ArrowDown') nextY++;
        if (e.key === 'ArrowLeft') nextX--;
        if (e.key === 'ArrowRight') nextX++;

        if (e.key === ' ' || e.key === 'Spacebar') {
            checkInteraction();
            return;
        }

        // ì´ë™ ê°€ëŠ¥ í™•ì¸
        if (canMove(nextX, nextY)) {
            player.x = nextX;
            player.y = nextY;
            updateCamera();
            draw();
        }
    });

    function canMove(x, y) {
        if (x < 0 || x >= MAP_SIZE || y < 0 || y >= MAP_SIZE) return false;
        const tile = mapData[y][x];
        if (tile === TILE.WATER || tile === TILE.MOUNTAIN) return false; // ë¬¼, ì‚° ì´ë™ ë¶ˆê°€
        return true;
    }

    function checkInteraction() {
        const tile = mapData[player.y][player.x];
        
        // í˜„ì¬ ë°Ÿê³  ìˆëŠ” íƒ€ì¼ì´ ì¹´ì§€ë…¸ë¼ë©´
        if (tile === TILE.CASINO) {
            enterCasino();
        } else {
            // ì•„ë¬´ê²ƒë„ ì—†ëŠ” ê³³ì´ë©´ ë…ë°±
            showDialog("ë°”ëŒì´ ì°¨ê°‘ë‹¤... ë‚´ ë¼ˆë§ˆë””ê°€ ì‹œë ¤ì˜¨ë‹¤.\n(ì €ì£¼ë¥¼ í’€ê¸° ìœ„í•´ì„  ëˆê³¼ í˜ì´ í•„ìš”í•´)");
        }
    }

    // ==========================================
    // 5. ìŠ¤í† ë¦¬ ë° UI ì‹œìŠ¤í…œ
    // ==========================================
    function showDialog(text) {
        currentState = STATE.DIALOG;
        dialogBox.innerText = text;
        dialogBox.style.display = 'block';
    }

    function closeDialog() {
        dialogBox.style.display = 'none';
        currentState = STATE.EXPLORE;
    }

    // ì´ˆê¸° ìŠ¤í† ë¦¬ ì¶œë ¥
    setTimeout(() => {
        showDialog(" [í”„ë¡¤ë¡œê·¸]\n\në‚˜ëŠ” ì™•êµ­ì˜ ê¸°ì‚¬ë‹¨ì¥ì´ì—ˆë‹¤.\ní•˜ì§€ë§Œ 'ë¯¸ì¹´ì—˜'.. ê·¸ ìœ„ì„ ì ì¸ ë†ˆì´ ë‚˜ì—ê²Œ ëˆ„ëª…ì„ ì”Œì› ë‹¤.\nê·¸ëŠ” ì²œì‚¬ ê°™ì€ ì–¼êµ´ë¡œ ì‚¬ëŒë“¤ì„ ì†ì´ê³ , ë‚˜ë¥¼ ë”ì°í•œ í•´ê³¨ ê´´ë¬¼ë¡œ ë§Œë“¤ì—ˆë‹¤.\n\n\"ê´´ë¬¼ì´ë‹¤! ì£½ì—¬ë¼!\" ë§ˆì„ ì‚¬ëŒë“¤ì˜ ëŒíŒ”ë§¤ì§ˆ...\n\në‘ê³  ë´ë¼. í˜ì„ ê¸°ë¥´ê³  ëˆì„ ëª¨ì•„ ìµœê³ ì˜ ì¥ë¹„ë¥¼ ë§ì¶°ì„œ,\nê·¸ ê°€ì‹ì ì¸ ì–¼êµ´ì„ ë°•ì‚´ ë‚´ê³  ë‚´ ëª…ì˜ˆë¥¼ ë˜ì°¾ê² ë‹¤.");
    }, 500);

    // ==========================================
    // 6. ë¯¸ë‹ˆê²Œì„: ë¸”ë™ì­ (ë„ë°•ì¥)
    // ==========================================
    let playerScore = 0;
    let dealerScore = 0;

    function enterCasino() {
        currentState = STATE.MINIGAME;
        casinoPanel.style.display = 'block';
        blackjackGame.classList.add('hidden');
        bettingControls.classList.remove('hidden');
    }

    function exitCasino() {
        casinoPanel.style.display = 'none';
        currentState = STATE.EXPLORE;
        draw();
    }

    window.startGame = function() { // HTML ë²„íŠ¼ì—ì„œ í˜¸ì¶œí•˜ê¸° ìœ„í•´ windowì— í• ë‹¹
        if (player.gold < 100) {
            alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: 100G)");
            return;
        }
        player.gold -= 100;
        goldDisplay.innerText = player.gold;
        
        bettingControls.classList.add('hidden');
        blackjackGame.classList.remove('hidden');
        
        playerScore = Math.floor(Math.random() * 10) + 2 + Math.floor(Math.random() * 10) + 2; // 4~22
        dealerScore = Math.floor(Math.random() * 10) + 2; // ë”œëŸ¬ ì¹´ë“œ 1ì¥ ì˜¤í”ˆ
        
        updateBlackjackUI();
        document.getElementById('game-result').innerText = "";
    };

    window.hit = function() {
        const card = Math.floor(Math.random() * 10) + 2;
        playerScore += card;
        updateBlackjackUI();

        if (playerScore > 21) {
            endGame(false, "ë²„ìŠ¤íŠ¸! (21ì  ì´ˆê³¼)");
        }
    };

    window.stand = function() {
        // ë”œëŸ¬ í”Œë ˆì´ (16 ì´í•˜ë©´ ë¬´ì¡°ê±´ ë“œë¡œìš°)
        while (dealerScore < 17) {
            dealerScore += Math.floor(Math.random() * 10) + 2;
        }
        
        updateBlackjackUI();

        if (dealerScore > 21) {
            endGame(true, "ë”œëŸ¬ ë²„ìŠ¤íŠ¸! ë‹¹ì‹ ì˜ ìŠ¹ë¦¬!");
        } else if (playerScore > dealerScore) {
            endGame(true, "ìŠ¹ë¦¬! ë”œëŸ¬ë³´ë‹¤ ì ìˆ˜ê°€ ë†’ìŠµë‹ˆë‹¤.");
        } else if (playerScore === dealerScore) {
             // ë¹„ê¹€ (ëˆ ëŒë ¤ì¤Œ)
             player.gold += 100;
             endGame(false, "ë¬´ìŠ¹ë¶€! ë³¸ì „ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.");
        } else {
            endGame(false, "íŒ¨ë°°.. ë”œëŸ¬ê°€ ë” ë†’ìŠµë‹ˆë‹¤.");
        }
    };

    function updateBlackjackUI() {
        document.getElementById('p-score').innerText = playerScore;
        document.getElementById('d-score').innerText = dealerScore;
    }

    function endGame(isWin, msg) {
        document.getElementById('game-result').innerText = msg;
        if (isWin) {
            player.gold += 200; // 2ë°° íšë“
            goldDisplay.innerText = player.gold;
        }
        setTimeout(() => {
            alert(msg);
            enterCasino(); // ë‹¤ì‹œ ë©”ë‰´ë¡œ
        }, 500);
    }

    // ì´ˆê¸° ë Œë”ë§
    updateCamera();
    draw();

</script>
</body>
</html>
