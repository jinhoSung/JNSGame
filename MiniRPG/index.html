<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skeleton Knight's Revenge: Final</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            overflow: hidden;
            font-family: 'DungGeunMo', monospace, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        canvas {
            image-rendering: pixelated;
            display: block;
        }

        /* UI ê³µí†µ */
        .overlay { position: absolute; pointer-events: none; text-shadow: 2px 2px 0 #000; z-index: 10; }

        #stat-bar {
            top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px;
            border-radius: 8px; border: 2px solid #888;
            font-size: 16px; pointer-events: auto; flex-wrap: wrap;
        }
        .stat-item { margin-right: 15px; }
        .btn-group button {
            background: #444; color: white; border: 1px solid #fff;
            padding: 5px 10px; cursor: pointer; margin-left: 5px; font-family: inherit;
        }
        .btn-group button:hover { background: #666; }

        #dialog-box {
            bottom: 180px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 600px;
            background: rgba(0, 0, 0, 0.9); border: 3px solid #fff;
            padding: 20px; font-size: 18px; display: none;
            white-space: pre-line; line-height: 1.6; z-index: 20; text-align: center;
        }

        #start-screen, #ending-screen, #map-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; text-align: center;
        }
        #ending-screen, #map-screen { display: none; z-index: 200; }
        
        h1 { color: #e74c3c; font-size: 40px; margin-bottom: 10px; }
        .keys { color: #f1c40f; margin: 20px 0; font-size: 20px; line-height: 1.5; }
        
        .big-btn {
            padding: 15px 40px; font-size: 24px; background: #e74c3c;
            color: white; border: 4px solid #fff; cursor: pointer;
            font-family: inherit; margin-top: 10px; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* ì§€ë„ ìŠ¤íƒ€ì¼ */
        #map-canvas {
            border: 4px solid gold;
            background: #000;
            image-rendering: pixelated;
            margin-bottom: 20px;
        }
        .map-legend { font-size: 14px; margin-bottom: 10px; color: #ccc; }
        .legend-item { display: inline-block; margin: 0 5px; }
        .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }

        /* === íŒ¨ë„ ê³µí†µ === */
        .game-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px;
            background: #2c3e50; border: 4px solid gold;
            padding: 20px; display: none; text-align: center;
            pointer-events: auto; z-index: 50;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            max-height: 90vh; overflow-y: auto;
        }
        .panel-header { color: gold; margin-bottom: 15px; border-bottom: 2px solid gold; padding-bottom: 10px; }
        .panel-btn {
            background: #e74c3c; color: white; border: none;
            padding: 10px 20px; margin: 5px; cursor: pointer;
            font-size: 16px; border-radius: 4px; font-family: inherit; width: 100%; margin-bottom: 10px;
        }
        .panel-btn:hover { background: #c0392b; }
        .panel-btn.secondary { background: #555; }
        .panel-btn:disabled { background: #777; cursor: not-allowed; opacity: 0.6; }

        #casino-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #casino-menu button { height: 60px; font-size: 18px; width: auto; margin: 0; }

        .game-view { display: none; }
        .game-view.active { display: block; }
        .result-msg { height: 30px; font-weight: bold; color: yellow; margin: 10px 0; }
        .bet-info { background: rgba(0,0,0,0.3); padding: 10px; margin: 10px 0; border-radius: 5px; }
        .bet-control { background: #333; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 18px; }
        .bet-control input { background: #000; border: 1px solid #fff; color: gold; font-family: inherit; font-size: 18px; width: 100px; text-align: right; padding: 5px; }

        /* ë¯¸ë‹ˆê²Œì„ ìº”ë²„ìŠ¤ */
        .minigame-canvas {
            margin: 10px auto; background: #004400;
            border: 4px solid #d4af37; border-radius: 8px;
            box-shadow: inset 0 0 20px #000; display: block;
        }
        #roulette-canvas { border-radius: 50%; background: #222; }
        #slot-canvas { background: #333; }
        #race-canvas { background: #2e7d32; }
        #rps-canvas { background: #222; }

        /* ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ (ê¸°ë³¸ ìˆ¨ê¹€, ëª¨ë°”ì¼ì—ì„œë§Œ í‘œì‹œ) */
        #mobile-controls {
            position: absolute; bottom: 20px; left: 0; width: 100%; height: 160px;
            pointer-events: none; display: none; justify-content: space-between;
            padding: 0 40px; box-sizing: border-box; z-index: 900;
        }
        @media (hover: none) and (pointer: coarse), (max-width: 768px) {
            #mobile-controls { display: flex; }
        }

        .dpad-container { position: relative; width: 140px; height: 140px; pointer-events: auto; }
        .dpad-btn {
            position: absolute; width: 45px; height: 45px;
            background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px; display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: rgba(255,255,255,0.8); touch-action: none;
        }
        .dpad-btn:active, .dpad-btn.pressed { background: rgba(255, 255, 255, 0.5); }
        #btn-up { top: 0; left: 47.5px; } #btn-down { bottom: 0; left: 47.5px; }
        #btn-left { top: 47.5px; left: 0; } #btn-right { top: 47.5px; right: 0; }

        .action-container { position: relative; width: 100px; height: 140px; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        #action-btn {
            width: 80px; height: 80px; border-radius: 50%; background: rgba(231, 76, 60, 0.6);
            border: 4px solid rgba(255, 255, 255, 0.6); color: white; font-size: 24px; font-weight: bold;
            display: flex; justify-content: center; align-items: center; touch-action: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #action-btn:active { background: rgba(231, 76, 60, 0.9); transform: scale(0.95); }

        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 8px; border-radius: 4px;
        }
        .shop-item span { text-align: left; font-size: 14px; }
        .buy-btn { background: #27ae60; border: none; padding: 5px 10px; color: white; cursor: pointer; border-radius: 4px;}
        .buy-btn:disabled { background: #555; cursor: default;}

        #toast {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 100, 0, 0.9); color: white;
            padding: 10px 30px; border-radius: 20px; display: none; z-index: 999;
            font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div id="start-screen">
            <h1>ğŸ’€ í•´ê³¨ ê¸°ì‚¬ì˜ ë³µìˆ˜</h1>
            <p>1. ë…¸ê°€ë‹¤ì™€ ì¹´ì§€ë…¸ë¡œ ëˆì„ ëª¨ìœ¼ì„¸ìš”.<br>2. ì¥ë¹„ë¥¼ ì‚¬ë©´ <span style="color:gold;">ì„±ë¬¸</span>ì´ ì—´ë¦½ë‹ˆë‹¤.<br>3. ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ëª¬ìŠ¤í„°ë“¤ì´ ë‹¬ë ¤ë“­ë‹ˆë‹¤!</p>
            <div class="keys">[ì´ë™] ë°©í–¥í‚¤ / [ê³µê²©] ìŠ¤í˜ì´ìŠ¤ë°”<br>(ëª¨ë°”ì¼ì€ í„°ì¹˜ ì¡°ì‘)</div>
            <button class="big-btn" onclick="startGameFlow()">ê²Œì„ ì‹œì‘</button>
        </div>

        <div id="ending-screen">
            <h1 style="color:gold;">ğŸ‘‘ ë³µìˆ˜ ì„±ê³µ!</h1>
            <p>ë¹„ì—´í•œ ë¯¸ì¹´ì—˜ì„ ì“°ëŸ¬ëœ¨ë¦¬ê³ <br>ë‹¹ì‹ ì€ ëª…ì˜ˆë¥¼ ë˜ì°¾ì•˜ìŠµë‹ˆë‹¤.</p>
            <p>ìµœì¢… ì†Œì§€ê¸ˆ: <span id="final-gold"></span>G</p>
            <button class="big-btn" onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>

        <div id="map-screen">
            <h2 style="color:gold;">ğŸ—ºï¸ ì›”ë“œ ë§µ</h2>
            <canvas id="map-canvas" width="300" height="300"></canvas>
            <div class="map-legend">
                <span class="legend-item"><span class="dot" style="background:blue;"></span>ë§ˆì„</span>
                <span class="legend-item"><span class="dot" style="background:#8b4513;"></span>ë„ë¡œ</span>
                <span class="legend-item"><span class="dot" style="background:green;"></span>ì´ˆê¸‰</span>
                <span class="legend-item"><span class="dot" style="background:orange;"></span>ì¤‘ê¸‰</span>
                <span class="legend-item"><span class="dot" style="background:red;"></span>ê³ ê¸‰</span>
                <span class="legend-item"><span class="dot" style="background:purple;"></span>ë³´ìŠ¤</span>
            </div>
            <p style="color:#aaa; font-size:14px;">(í•˜ì–€ ì ì€ í˜„ì¬ ìœ„ì¹˜ì…ë‹ˆë‹¤)</p>
            <button class="panel-btn secondary" style="width:200px;" onclick="toggleMap()">ë‹«ê¸°</button>
        </div>

        <div id="stat-bar" class="overlay">
            <div style="display:flex;">
                <div class="stat-item">â¤ï¸ <span id="hp-display">100</span></div>
                <div class="stat-item">âš¡ <span id="energy-display">100</span></div>
                <div class="stat-item">âš”ï¸ <span id="atk-display">10</span></div>
                <div class="stat-item">ğŸ’° <span id="gold-display" style="color:gold;">0</span>G</div>
            </div>
            <div class="btn-group">
                <button onclick="toggleMap()">ğŸ—ºï¸ ì§€ë„</button>
                <button onclick="saveGame()">ğŸ’¾ ì €ì¥</button>
                <button onclick="loadGame()">ğŸ“‚ ë¡œë“œ</button>
            </div>
        </div>

        <div id="mobile-controls">
            <div class="dpad-container">
                <div class="dpad-btn" id="btn-up">â–²</div>
                <div class="dpad-btn" id="btn-left">â—€</div>
                <div class="dpad-btn" id="btn-right">â–¶</div>
                <div class="dpad-btn" id="btn-down">â–¼</div>
            </div>
            <div class="action-container"><div id="action-btn">A</div></div>
        </div>

        <div id="dialog-box" class="overlay"></div>
        <div id="toast">ì•Œë¦¼</div>

        <div id="casino-panel" class="game-panel">
            <h2 class="panel-header">ğŸ° ê³ ë¸”ë¦° ì¹´ì§€ë…¸</h2>
            <div class="bet-control">íŒëˆ: <input type="number" id="bet-input" value="100" min="10" step="10"> G</div>
            <div id="casino-menu">
                <button class="panel-btn" onclick="showGame('blackjack')">ğŸƒ ë¸”ë™ì­</button>
                <button class="panel-btn" onclick="showGame('roulette')">ğŸ¡ ë£°ë ›</button>
                <button class="panel-btn" onclick="showGame('slots')">ğŸ’ ìŠ¬ë¡¯ë¨¸ì‹ </button>
                <button class="panel-btn" onclick="showGame('racing')">ğŸ ê²½ë§ˆ</button>
                <button class="panel-btn" onclick="showGame('sicbo')">ğŸ² ë‹¤ì´ì‚¬ì´</button>
                <button class="panel-btn" onclick="showGame('rps')">âœŒï¸âœŠâœ‹ ê°€ìœ„ë°”ìœ„ë³´</button>
                <button class="panel-btn secondary" onclick="closePanel()" style="grid-column: span 2;">ğŸšª ë‚˜ê°€ê¸°</button>
            </div>
            
            <div id="game-blackjack" class="game-view">
                <h3>ë¸”ë™ì­</h3><div class="bet-info">(ìŠ¹ë¦¬ ì‹œ 2ë°°)</div>
                <canvas id="bj-canvas" class="minigame-canvas" width="300" height="200"></canvas>
                <div id="bj-result" class="result-msg"></div>
                <div id="bj-actions" class="hidden"><button class="panel-btn" style="width:auto;display:inline-block;" onclick="bjHit()">íˆíŠ¸</button><button class="panel-btn" style="width:auto;display:inline-block;" onclick="bjStand()">ìŠ¤íƒ ë“œ</button></div>
                <div id="bj-controls"><button class="panel-btn" onclick="startBlackjack()">ê²Œì„ ì‹œì‘</button><button class="panel-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button></div>
            </div>
            
            <div id="game-roulette" class="game-view">
                <h3>ë¦¬ì–¼ ë£°ë ›</h3><div class="bet-info">(í™€ì§ 2ë°° / 7 10ë°°)</div>
                <canvas id="roulette-canvas" class="minigame-canvas" width="300" height="300"></canvas>
                <div id="roulette-result" class="result-msg"></div>
                <div id="roulette-btns"><button class="panel-btn" style="width:30%;display:inline-block;" onclick="startRoulette('odd')">í™€ìˆ˜</button><button class="panel-btn" style="width:30%;display:inline-block;" onclick="startRoulette('even')">ì§ìˆ˜</button><button class="panel-btn" style="width:30%;display:inline-block;" onclick="startRoulette('lucky7')">7</button></div>
                <button class="panel-btn secondary" onclick="backToMenu()" style="margin-top:10px;">ë’¤ë¡œê°€ê¸°</button>
            </div>
            
            <div id="game-slots" class="game-view">
                <h3>ìŠ¬ë¡¯ë¨¸ì‹ </h3><div class="bet-info">(ì­íŒŸ 50ë°°)</div>
                <canvas id="slot-canvas" class="minigame-canvas" width="300" height="150"></canvas>
                <div id="slot-result" class="result-msg"></div>
                <button class="panel-btn" id="slot-spin-btn" onclick="spinSlots()">ëŒë¦¬ê¸°</button><button class="panel-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
            </div>
            
            <div id="game-racing" class="game-view">
                <h3>í•´ê³¨ ê²½ë§ˆ</h3><div class="bet-info">(ìš°ìŠ¹ 4ë°°)</div>
                <canvas id="race-canvas" class="minigame-canvas" width="350" height="200"></canvas>
                <div id="race-result" class="result-msg"></div>
                <div id="race-btns"><button class="panel-btn" style="width:20%;display:inline-block;" onclick="startRace(1)">1</button><button class="panel-btn" style="width:20%;display:inline-block;" onclick="startRace(2)">2</button><button class="panel-btn" style="width:20%;display:inline-block;" onclick="startRace(3)">3</button><button class="panel-btn" style="width:20%;display:inline-block;" onclick="startRace(4)">4</button></div>
                <button class="panel-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
            </div>
            
            <div id="game-sicbo" class="game-view">
                <h3>ë‹¤ì´ì‚¬ì´</h3><div class="bet-info">(2ë°°)</div>
                <canvas id="sicbo-canvas" class="minigame-canvas" width="300" height="200"></canvas>
                <div id="sicbo-result" class="result-msg"></div>
                <div id="sicbo-btns"><button class="panel-btn" style="width:40%;display:inline-block;" onclick="playSicBo('small')">ì†Œ</button><button class="panel-btn" style="width:40%;display:inline-block;" onclick="playSicBo('big')">ëŒ€</button></div>
                <button class="panel-btn secondary" onclick="backToMenu()" style="margin-top:10px;">ë’¤ë¡œê°€ê¸°</button>
            </div>

            <!-- 6. ê°€ìœ„ë°”ìœ„ë³´ (RPS) -->
            <div id="game-rps" class="game-view">
                <h3>ê°€ìœ„ë°”ìœ„ë³´</h3><div class="bet-info">ì´ê¸°ë©´ ë£°ë › ì°¬ìŠ¤!</div>
                <canvas id="rps-canvas" class="minigame-canvas" width="300" height="250"></canvas>
                <div id="rps-result" class="result-msg"></div>
                <div id="rps-btns">
                    <button class="panel-btn" style="width:30%;display:inline-block;" onclick="playRPS('scissors')">âœŒï¸</button>
                    <button class="panel-btn" style="width:30%;display:inline-block;" onclick="playRPS('rock')">âœŠ</button>
                    <button class="panel-btn" style="width:30%;display:inline-block;" onclick="playRPS('paper')">âœ‹</button>
                </div>
                <div id="rps-bonus-btn" style="display:none;">
                    <button class="panel-btn" onclick="spinRpsWheel()">ë£°ë › ëŒë¦¬ê¸°!</button>
                </div>
                <button class="panel-btn secondary" onclick="backToMenu()" style="margin-top:10px;">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>

        <div id="shop-panel" class="game-panel">
            <h2 class="panel-header">âš’ï¸ ëŒ€ì¥ê°„</h2>
            <p style="color:#aaa; font-size:14px; margin-bottom:10px;">(ë¬´ê¸°ë¥¼ ì‚¬ë©´ ì„±ë¬¸ì´ ì—´ë¦½ë‹ˆë‹¤)</p>
            <div id="shop-items"></div>
            <button class="panel-btn secondary" onclick="closePanel()">ë‚˜ê°€ê¸°</button>
        </div>

        <div id="inn-panel" class="game-panel">
            <h2 class="panel-header">ğŸ¨ ë‹¬ë¹› ì—¬ê´€</h2>
            <p>ìˆ™ë°•ë¹„: 50G (HP/í”¼ë¡œë„ íšŒë³µ)</p>
            <button class="panel-btn" onclick="sleepAtInn()">ì ìê¸°</button>
            <button class="panel-btn secondary" onclick="closePanel()">ë‚˜ê°€ê¸°</button>
        </div>

    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const dialogBox = document.getElementById('dialog-box');
    const goldDisplay = document.getElementById('gold-display');
    const hpDisplay = document.getElementById('hp-display');
    const energyDisplay = document.getElementById('energy-display');
    const atkDisplay = document.getElementById('atk-display');

    const TILE_SIZE = 40;
    const MAP_SIZE = 512;
    const TILE = { GRASS: 0, WATER: 1, MOUNTAIN: 2, VILLAGE: 3, WALL: 4, GATE: 5, BOSS_WALL: 6, BOSS_FLOOR: 7, SHOP: 8, CASINO: 9, ROAD: 10, INN: 11, SCARECROW: 12 };
    const STATE = { MENU: 'menu', EXPLORE: 'explore', DIALOG: 'dialog', MINIGAME: 'minigame', MAP: 'map' };
    
    let currentState = STATE.MENU;
    let camera = { x: 0, y: 0 };
    let mapData = [];
    let particles = [];
    let enemies = [];
    let boss = null;
    let gatesOpen = false;

    const player = { 
        x: 256, y: 256, gold: 500, hp: 100, maxHp: 100, energy: 100, maxEnergy: 100, atk: 10,
        sprite: 'ğŸ’€', hasSword: false, hasArmor: false
    };

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if(typeof updateCamera === 'function') updateCamera();
    }
    window.addEventListener('resize', resizeCanvas);

    function generateMap() {
        for(let y=0; y<MAP_SIZE; y++) mapData.push(new Array(MAP_SIZE).fill(TILE.GRASS));
        for(let i=0; i<600; i++) createBlob(TILE.MOUNTAIN, 10, 30);
        for(let i=0; i<300; i++) createBlob(TILE.WATER, 5, 15);
        
        const center = MAP_SIZE / 2;
        const vRad = 15;
        for(let y=center-vRad; y<=center+vRad; y++) {
            for(let x=center-vRad; x<=center+vRad; x++) {
                if(Math.sqrt((x-center)**2 + (y-center)**2) < vRad) {
                    mapData[y][x] = TILE.VILLAGE;
                }
                let dist = Math.sqrt((x-center)**2 + (y-center)**2);
                if (dist >= vRad - 1 && dist <= vRad + 1) {
                    if ((Math.abs(x-center) < 3 && y > center) || (Math.abs(x-center) < 3 && y < center) || 
                        (Math.abs(y-center) < 3 && x > center) || (Math.abs(y-center) < 3 && x < center)) {
                        mapData[y][x] = TILE.GATE;
                    } else {
                        mapData[y][x] = TILE.WALL;
                    }
                }
            }
        }

        mapData[center-5][center] = TILE.CASINO;
        mapData[center-5][center+1] = TILE.CASINO;
        mapData[center+5][center] = TILE.SHOP;
        mapData[center][center-5] = TILE.INN;
        mapData[center+2][center+5] = TILE.SCARECROW;
        
        createRoads(center, vRad);
        createBossCastle(50, 50);
        spawnEnemies(center);
    }

    function createRoads(center, vRad) {
        const paveRoad = (x, y) => {
            if(x<0||x>=MAP_SIZE||y<0||y>=MAP_SIZE) return;
            if(mapData[y][x] !== TILE.WALL && mapData[y][x] !== TILE.GATE && 
               mapData[y][x] !== TILE.VILLAGE && mapData[y][x] !== TILE.CASINO && 
               mapData[y][x] !== TILE.SHOP && mapData[y][x] !== TILE.INN && 
               mapData[y][x] !== TILE.SCARECROW) {
                mapData[y][x] = TILE.ROAD;
                for(let dy=-2; dy<=2; dy++) {
                    for(let dx=-2; dx<=2; dx++) {
                        let nx = x+dx, ny = y+dy;
                        if(nx>=0 && nx<MAP_SIZE && ny>=0 && ny<MAP_SIZE) {
                            const t = mapData[ny][nx];
                            if(t === TILE.WATER || t === TILE.MOUNTAIN) mapData[ny][nx] = TILE.GRASS;
                        }
                    }
                }
            }
        };
        const roadLen = 150;
        for(let i=vRad+1; i < roadLen; i++) {
            paveRoad(center, center-i); paveRoad(center, center+i);
            paveRoad(center+i, center); paveRoad(center-i, center);
        }
        let cx = center, cy = center, bx = 50, by = 50;
        let dist = Math.sqrt((bx-cx)**2 + (by-cy)**2);
        for(let i=0; i<dist; i++) {
            let t = i/dist; let x = Math.floor(cx + (bx-cx)*t); let y = Math.floor(cy + (by-cy)*t);
            if(Math.sqrt((x-cx)**2 + (y-cy)**2) > vRad) paveRoad(x, y);
        }
    }

    function createBlob(type, min, max) {
        let cx = Math.floor(Math.random() * MAP_SIZE), cy = Math.floor(Math.random() * MAP_SIZE);
        let size = Math.floor(Math.random() * (max - min) + min);
        for(let y=cy-size; y<cy+size; y++) {
            for(let x=cx-size; x<cx+size; x++) {
                if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE) {
                    if(Math.random() > 0.3) mapData[y][x] = type; 
                }
            }
        }
    }

    function createBossCastle(bx, by) {
        for(let y=by-5; y<=by+5; y++) {
            for(let x=bx-5; x<=bx+5; x++) {
                mapData[y][x] = TILE.BOSS_FLOOR;
                if(y===by-5 || y===by+5 || x===bx-5 || x===bx+5) mapData[y][x] = TILE.BOSS_WALL;
            }
        }
        mapData[by+5][bx] = TILE.BOSS_FLOOR;
        boss = { x: bx, y: by, hp: 1000, maxHp: 1000, atk: 50, sprite: 'ğŸ‘¿', name: 'ë¯¸ì¹´ì—˜' };
    }

    function spawnEnemies(center) {
        for(let i=0; i<150; i++) spawnMob(center, 30, 100, {hp:30, atk:5, sprite:'ğŸ¦ ', name:'ìŠ¬ë¼ì„', exp:10});
        for(let i=0; i<100; i++) spawnMob(center, 100, 200, {hp:100, atk:20, sprite:'ğŸ‘º', name:'ê³ ë¸”ë¦°', exp:30});
        for(let i=0; i<80; i++) spawnMob(center, 200, 350, {hp:250, atk:40, sprite:'ğŸ’€', name:'ì•”í‘ê¸°ì‚¬', exp:100});
    }

    function spawnMob(center, minR, maxR, stats) {
        let spawned = false;
        while(!spawned) {
            let angle = Math.random() * Math.PI * 2;
            let dist = Math.random() * (maxR - minR) + minR;
            let ex = Math.floor(center + Math.cos(angle) * dist);
            let ey = Math.floor(center + Math.sin(angle) * dist);
            if (ex>=0 && ex<MAP_SIZE && ey>=0 && ey<MAP_SIZE && mapData[ey][ex] === TILE.GRASS) {
                enemies.push({ x:ex, y:ey, ...stats, lastMove: 0 });
                spawned = true;
            }
        }
    }
    generateMap();

    // --- íŒŒí‹°í´ & ë£¨í”„ ---
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.vx = (Math.random() - 0.5) * 10; this.vy = (Math.random() - 0.5) * 10;
            this.life = 1.0;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
        draw(ctx, offsetX, offsetY) {
            ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
            ctx.fillRect(this.x + offsetX, this.y + offsetY, 4, 4); ctx.globalAlpha = 1.0;
        }
    }
    function spawnParticles(x, y, color, count=10) {
        for(let i=0; i<count; i++) particles.push(new Particle(x * TILE_SIZE + 20, y * TILE_SIZE + 20, color));
    }

    function updateCamera() {
        camera.x = player.x * TILE_SIZE - canvas.width / 2 + (TILE_SIZE / 2);
        camera.y = player.y * TILE_SIZE - canvas.height / 2 + (TILE_SIZE / 2);
    }
    function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
    
    function update() {
        if(currentState !== STATE.EXPLORE) return;
        
        for(let i=particles.length-1; i>=0; i--) {
            particles[i].update(); if(particles[i].life <= 0) particles.splice(i, 1);
        }
        
        const now = Date.now();
        enemies.forEach((e, idx) => {
            if (!e.lastMove) e.lastMove = 0;
            if (now - e.lastMove > 800) {
                const dist = Math.abs(player.x - e.x) + Math.abs(player.y - e.y);
                if (dist < 10) {
                    let dx = Math.sign(player.x - e.x);
                    let dy = Math.sign(player.y - e.y);
                    if(Math.random() > 0.5) { if (Math.abs(player.x - e.x) > Math.abs(player.y - e.y)) dy = 0; else dx = 0; }
                    let nx = e.x + dx;
                    let ny = e.y + dy;
                    if (nx === player.x && ny === player.y) { processEnemyAttack(e, idx); }
                    else if (canMoveMob(nx, ny)) { e.x = nx; e.y = ny; }
                }
                e.lastMove = now;
            }
        });
    }

    function canMoveMob(x, y) {
        if(x<0||x>=MAP_SIZE||y<0||y>=MAP_SIZE) return false;
        const t = mapData[y][x]; 
        return t === TILE.GRASS || t === TILE.ROAD || t === TILE.BOSS_FLOOR;
    }

    function processEnemyAttack(enemy, idx) {
        player.hp -= enemy.atk;
        spawnParticles(player.x, player.y, '#ffffff', 3);
        enemy.hp -= player.atk;
        spawnParticles(enemy.x, enemy.y, '#ff0000', 3);
        if (enemy.hp <= 0) {
            showToast(`${enemy.name} ì²˜ì¹˜! +${enemy.exp}G`);
            player.gold += enemy.exp;
            enemies.splice(idx, 1);
        }
        if (player.hp <= 0) {
            player.hp = 0; alert("ì‚¬ë§í–ˆìŠµë‹ˆë‹¤... ë§ˆì„ë¡œ ê·€í™˜í•©ë‹ˆë‹¤.");
            player.hp = player.maxHp; player.energy = player.maxEnergy; 
            player.x = MAP_SIZE/2; player.y = MAP_SIZE/2; player.gold = Math.floor(player.gold / 2);
        }
        updateUI();
    }

    function draw() {
        if (currentState === STATE.MENU || currentState === STATE.MAP) return;
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        const startCol = Math.floor(camera.x / TILE_SIZE);
        const startRow = Math.floor(camera.y / TILE_SIZE);
        const endCol = startCol + (canvas.width / TILE_SIZE) + 1;
        const endRow = startRow + (canvas.height / TILE_SIZE) + 1;
        const offsetX = -camera.x + startCol * TILE_SIZE;
        const offsetY = -camera.y + startRow * TILE_SIZE;

        for (let y = startRow; y <= endRow; y++) {
            for (let x = startCol; x <= endCol; x++) {
                if (y >= 0 && y < MAP_SIZE && x >= 0 && x < MAP_SIZE) {
                    const tile = mapData[y][x];
                    let color = '#2e8b57';
                    if (tile === TILE.WATER) color = '#3498db'; 
                    else if (tile === TILE.MOUNTAIN) color = '#555';
                    else if (tile === TILE.VILLAGE) color = '#d3a95d'; 
                    else if (tile === TILE.ROAD) color = '#8b4513';
                    else if (tile === TILE.WALL) color = '#5d4037';
                    else if (tile === TILE.GATE) color = gatesOpen ? '#8b4513' : '#3e2723';
                    else if (tile === TILE.CASINO) color = '#8e44ad';
                    else if (tile === TILE.SHOP) color = '#e67e22'; 
                    else if (tile === TILE.INN) color = '#16a085'; 
                    else if (tile === TILE.SCARECROW) color = '#d35400';
                    else if (tile === TILE.BOSS_FLOOR) color = '#440000';
                    else if (tile === TILE.BOSS_WALL) color = '#220000';
                    
                    ctx.fillStyle = color; 
                    ctx.fillRect((x - startCol)*TILE_SIZE + offsetX, (y - startRow)*TILE_SIZE + offsetY, TILE_SIZE+1, TILE_SIZE+1);
                    
                    if (tile === TILE.CASINO) { ctx.font = '20px Arial'; ctx.fillStyle = '#fff'; ctx.fillText("ğŸ°", (x-startCol)*TILE_SIZE+offsetX+8, (y-startRow)*TILE_SIZE+offsetY+28); }
                    if (tile === TILE.SHOP) { ctx.font = '20px Arial'; ctx.fillStyle = '#fff'; ctx.fillText("âš’ï¸", (x-startCol)*TILE_SIZE+offsetX+8, (y-startRow)*TILE_SIZE+offsetY+28); }
                    if (tile === TILE.INN) { ctx.font = '20px Arial'; ctx.fillStyle = '#fff'; ctx.fillText("ğŸ¨", (x-startCol)*TILE_SIZE+offsetX+8, (y-startRow)*TILE_SIZE+offsetY+28); }
                    if (tile === TILE.SCARECROW) { ctx.font = '20px Arial'; ctx.fillStyle = '#fff'; ctx.fillText("ğŸ¯", (x-startCol)*TILE_SIZE+offsetX+8, (y-startRow)*TILE_SIZE+offsetY+28); }
                    if (tile === TILE.GATE && !gatesOpen) { ctx.font = '20px Arial'; ctx.fillStyle = '#fff'; ctx.fillText("ğŸ”’", (x-startCol)*TILE_SIZE+offsetX+8, (y-startRow)*TILE_SIZE+offsetY+28); }
                }
            }
        }
        enemies.forEach(e => {
            const ex = e.x * TILE_SIZE - camera.x; const ey = e.y * TILE_SIZE - camera.y;
            if(ex > -TILE_SIZE && ex < canvas.width && ey > -TILE_SIZE && ey < canvas.height) {
                ctx.font = '30px Arial'; ctx.fillText(e.sprite, ex + 5, ey + 30);
                ctx.fillStyle = 'red'; ctx.fillRect(ex, ey-5, 40, 4);
                ctx.fillStyle = 'lime'; ctx.fillRect(ex, ey-5, 40 * (e.hp/30), 4);
            }
        });
        if(boss && boss.hp > 0) {
            const bx = boss.x * TILE_SIZE - camera.x; const by = boss.y * TILE_SIZE - camera.y;
            ctx.font = '60px Arial'; ctx.fillText(boss.sprite, bx - 10, by + 40);
            ctx.fillStyle = 'red'; ctx.fillRect(bx-20, by-20, 80, 8);
            ctx.fillStyle = 'lime'; ctx.fillRect(bx-20, by-20, 80 * (boss.hp/boss.maxHp), 8);
        }
        particles.forEach(p => p.draw(ctx, -camera.x, -camera.y));
        const px = player.x * TILE_SIZE - camera.x; const py = player.y * TILE_SIZE - camera.y;
        ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(px + 20, py + 35, 10, 5, 0, 0, Math.PI * 2); ctx.fill();
        if(player.hasSword) { ctx.font = '20px Arial'; ctx.fillText('ğŸ—¡ï¸', px - 10, py + 25); }
        ctx.font = '30px Arial'; ctx.fillText(player.sprite, px + 5, py + 30);
        if(player.hasArmor) { ctx.font = '20px Arial'; ctx.fillText('ğŸ›¡ï¸', px + 30, py + 25); }
    }
    resizeCanvas(); gameLoop();

    // --- ì‹œìŠ¤í…œ ë¡œì§ ---
    function startGameFlow() {
        document.getElementById('start-screen').style.display = 'none';
        currentState = STATE.EXPLORE; updateUI();
        showDialog("í”¼ë¡œë„ì— ì£¼ì˜í•˜ì„¸ìš”!\ní—ˆìˆ˜ì•„ë¹„ë¥¼ ì³ì„œ ëˆì„ ë²Œê±°ë‚˜ ì—¬ê´€ì—ì„œ ì‰¬ì„¸ìš”.");
    }
    
    function updateUI() { 
        goldDisplay.innerText = player.gold; hpDisplay.innerText = player.hp; atkDisplay.innerText = player.atk;
        energyDisplay.innerText = player.energy;
    }
    
    function handleInput(dx, dy) {
        if (currentState !== STATE.EXPLORE) return;
        const nx = player.x + dx, ny = player.y + dy;
        if(boss && boss.hp > 0 && nx === boss.x && ny === boss.y) { attackTarget(boss); return; }
        let hitIdx = enemies.findIndex(e => e.x === nx && e.y === ny);
        if(hitIdx !== -1) { attackTarget(enemies[hitIdx], hitIdx); return; }
        if(mapData[ny][nx] === TILE.SCARECROW) { hitScarecrow(); return; }
        if (canMove(nx, ny)) { player.x = nx; player.y = ny; updateCamera(); }
        else {
            if (mapData[ny][nx] === TILE.GATE && !gatesOpen) showDialog("ğŸ”’ ì ê¹€. (ë¬´ê¸° í•„ìš”)");
        }
    }

    function canMove(x, y) {
        if(x<0||x>=MAP_SIZE||y<0||y>=MAP_SIZE) return false;
        const t = mapData[y][x]; 
        if (t === TILE.BOSS_WALL) return false;
        if (t === TILE.WALL) return false;
        if (t === TILE.GATE && !gatesOpen) return false;
        return t !== TILE.WATER && t !== TILE.MOUNTAIN;
    }

    function consumeEnergy(amount) {
        if (player.energy < amount) { showToast("ğŸ’¦ ë„ˆë¬´ ì§€ì³¤ìŠµë‹ˆë‹¤! ì—¬ê´€ìœ¼ë¡œ ê°€ì„¸ìš”."); return false; }
        player.energy -= amount; updateUI(); return true;
    }
    function hitScarecrow() {
        if(!consumeEnergy(1)) return;
        player.gold += 1; spawnParticles(player.x * TILE_SIZE + 60, player.y * TILE_SIZE + 20, 'gold', 5); updateUI();
    }
    function attackTarget(target, idx) {
        if(!consumeEnergy(2)) return;
        spawnParticles(target.x, target.y, '#ff0000', 5);
        target.hp -= player.atk; 
        if(target.hp <= 0) {
            if(target === boss) {
                showDialog(`ë¯¸ì¹´ì—˜ ì²˜ë‹¨!`);
                setTimeout(() => { document.getElementById('final-gold').innerText = player.gold; document.getElementById('ending-screen').style.display = 'flex'; }, 2000);
            } else {
                showToast(`${target.name} ì²˜ì¹˜! (+${target.exp || 50}G)`); 
                enemies.splice(idx, 1); player.gold += (target.exp || 50); spawnParticles(player.x, player.y, 'gold', 10);
            }
        } else {
            player.hp -= target.atk; spawnParticles(player.x, player.y, '#ffffff', 3);
            if(player.hp <= 0) {
                player.hp = 0; alert("ì‚¬ë§... ë§ˆì„ë¡œ ê·€í™˜í•©ë‹ˆë‹¤.");
                player.hp = player.maxHp; player.energy = player.maxEnergy; player.x = MAP_SIZE/2; player.y = MAP_SIZE/2; player.gold = Math.floor(player.gold / 2);
            }
        }
        updateUI();
    }
    function checkInteraction() {
        const t = mapData[player.y][player.x];
        if (t === TILE.CASINO) openPanel('casino'); else if (t === TILE.SHOP) openPanel('shop'); 
        else if (t === TILE.INN) openPanel('inn'); else showDialog("ì•„ë¬´ê²ƒë„ ì—†ë‹¤.");
    }

    function openPanel(type) {
        if (document.getElementById('mobile-controls')) document.getElementById('mobile-controls').style.display = 'none';
        if(type === 'casino') { document.getElementById('casino-panel').style.display = 'block'; currentState = STATE.MINIGAME; backToMenu(); }
        else if(type === 'shop') { document.getElementById('shop-panel').style.display = 'block'; currentState = STATE.DIALOG; renderShop(); }
        else if(type === 'inn') { document.getElementById('inn-panel').style.display = 'block'; currentState = STATE.DIALOG; }
    }
    function closePanel() {
        document.querySelectorAll('.game-panel').forEach(el => el.style.display = 'none');
        currentState = STATE.EXPLORE;
        document.getElementById('mobile-controls').style.removeProperty('display');
    }
    window.sleepAtInn = function() {
        if(player.gold < 50) { showToast("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }
        player.gold -= 50; player.hp = player.maxHp; player.energy = player.maxEnergy; updateUI();
        showToast("í‘¹ ì¤ìŠµë‹ˆë‹¤. íšŒë³µ ì™„ë£Œ!"); closePanel();
    }

    const shopItems = [
        { id: 'w1', name: 'ë…¹ìŠ¨ ê²€ (ê³µ+10)', cost: 1000, type: 'atk', val: 10 },
        { id: 'w2', name: 'ë¼ˆ ë¶„ì‡„ê¸° (ê³µ+25)', cost: 3000, type: 'atk', val: 25 },
        { id: 'w3', name: 'ê¸°ì‚¬ì˜ ê²€ (ê³µ+50)', cost: 8000, type: 'atk', val: 50 },
        { id: 'a1', name: 'ê°€ì£½ ê°‘ì˜· (ì²´+50)', cost: 1000, type: 'hp', val: 50 },
        { id: 'a2', name: 'í‘ìš”ì„ ê°‘ì˜· (ì²´+150)', cost: 4000, type: 'hp', val: 150 },
        { id: 'a3', name: 'í™©ê¸ˆ ê°‘ì˜· (ì²´+300)', cost: 10000, type: 'hp', val: 300 },
        { id: 'p1', name: 'ì²´ë ¥ í¬ì…˜ (íšŒë³µ)', cost: 200, type: 'heal', val: 9999 }
    ];
    function renderShop() {
        const c = document.getElementById('shop-items'); c.innerHTML = '';
        shopItems.forEach(i => {
            const d = document.createElement('div'); d.className = 'shop-item';
            d.innerHTML = `<span>${i.name}</span><button class="buy-btn" onclick="buyItem('${i.id}')">${i.cost}G</button>`;
            c.appendChild(d);
        });
    }
    window.buyItem = function(id) {
        const i = shopItems.find(x => x.id === id);
        if(player.gold < i.cost) { showToast("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }
        player.gold -= i.cost;
        if(i.type === 'atk') {
            player.atk += i.val; player.hasSword = true; showToast("ê³µê²©ë ¥ ì¦ê°€!"); 
            if(!gatesOpen) { gatesOpen = true; alert("âš”ï¸ ë¬´ê¸° ì¥ì°©! ì„±ë¬¸ì´ ì—´ë¦¬ê³  ê¸¸ì´ ë“œëŸ¬ë‚©ë‹ˆë‹¤!"); } 
        }
        else if(i.type === 'hp') { player.maxHp += i.val; player.hp += i.val; player.hasArmor = true; showToast("ìµœëŒ€ ì²´ë ¥ ì¦ê°€!"); }
        else if(i.type === 'heal') { player.hp = Math.min(player.hp + i.val, player.maxHp); showToast("ì²´ë ¥ íšŒë³µ ì™„ë£Œ."); }
        updateUI(); spawnParticles(canvas.width/2/TILE_SIZE + camera.x/TILE_SIZE, canvas.height/2/TILE_SIZE + camera.y/TILE_SIZE, 'white', 20);
    }

    window.toggleMap = function() {
        const mapScreen = document.getElementById('map-screen');
        if (mapScreen.style.display === 'flex') { mapScreen.style.display = 'none'; currentState = STATE.EXPLORE; }
        else { if (currentState !== STATE.EXPLORE) return; mapScreen.style.display = 'flex'; currentState = STATE.MAP; drawMiniMap(); }
    }
    function drawMiniMap() {
        const mCanvas = document.getElementById('map-canvas'); const mCtx = mCanvas.getContext('2d');
        const scale = 300 / MAP_SIZE;
        mCtx.fillStyle = '#000'; mCtx.fillRect(0,0,300,300);
        mCtx.strokeStyle = '#8b4513'; mCtx.lineWidth = 2;
        mCtx.beginPath(); mCtx.moveTo(150, 0); mCtx.lineTo(150, 300); mCtx.stroke();
        mCtx.beginPath(); mCtx.moveTo(0, 150); mCtx.lineTo(300, 150); mCtx.stroke();
        mCtx.beginPath(); mCtx.moveTo(150, 150); mCtx.lineTo(50*scale, 50*scale); mCtx.stroke();
        mCtx.fillStyle = 'blue'; mCtx.beginPath(); mCtx.arc(150, 150, 10, 0, 6.28); mCtx.fill();
        if(boss) { mCtx.fillStyle = 'purple'; mCtx.fillRect(boss.x*scale, boss.y*scale, 8, 8); }
        mCtx.fillStyle = 'white'; mCtx.beginPath(); mCtx.arc(player.x*scale, player.y*scale, 3, 0, 6.28); mCtx.fill();
    }

    function showToast(msg) {
        const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
    window.saveGame = function() { if(currentState !== STATE.EXPLORE) return; localStorage.setItem('skeletonRPG_v14', JSON.stringify({ ...player, gatesOpen })); showToast("ì €ì¥ ì™„ë£Œ!"); };
    window.loadGame = function() {
        const s = localStorage.getItem('skeletonRPG_v14'); if(!s) { showToast("ì €ì¥ëœ íŒŒì¼ ì—†ìŒ"); return; }
        const d = JSON.parse(s); Object.assign(player, d); gatesOpen = d.gatesOpen; updateUI(); updateCamera(); showToast("ë¡œë“œ ì™„ë£Œ!");
    };
    function showDialog(t) { const d = document.getElementById('dialog-box'); d.innerText = t; d.style.display = 'block'; setTimeout(() => d.style.display='none', 2000); }

    window.addEventListener('keydown', (e) => {
        if (currentState === STATE.MENU || currentState === STATE.MINIGAME || currentState === STATE.MAP) return;
        let dx=0, dy=0;
        if (e.key === 'ArrowUp') dy=-1; if (e.key === 'ArrowDown') dy=1;
        if (e.key === 'ArrowLeft') dx=-1; if (e.key === 'ArrowRight') dx=1;
        if (dx||dy) handleInput(dx,dy);
        if (e.key === ' ') checkInteraction();
        if (e.key === 'm' || e.key === 'M') toggleMap();
    });

    let moveInterval = null;
    function setupTouchButton(id, dx, dy) {
        const btn = document.getElementById(id);
        const start = (e) => { e.preventDefault(); btn.classList.add('pressed'); handleInput(dx,dy); moveInterval=setInterval(()=>handleInput(dx,dy),150); };
        const end = (e) => { e.preventDefault(); btn.classList.remove('pressed'); clearInterval(moveInterval); };
        btn.addEventListener('touchstart', start, {passive:false}); btn.addEventListener('touchend', end, {passive:false});
    }
    setupTouchButton('btn-up',0,-1); setupTouchButton('btn-down',0,1);
    setupTouchButton('btn-left',-1,0); setupTouchButton('btn-right',1,0);
    document.getElementById('action-btn').addEventListener('touchstart', (e)=>{e.preventDefault(); checkInteraction();}, {passive:false});

    // === ì¹´ì§€ë…¸ ===
    window.backToMenu = function() { document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active')); document.getElementById('casino-menu').style.display = 'grid'; };
    window.showGame = function(gameId) {
        document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active')); document.getElementById('casino-menu').style.display = 'none';
        document.getElementById('game-' + gameId).classList.add('active'); document.querySelectorAll('.result-msg').forEach(el => el.innerText = '');
        if(gameId==='racing') initRaceCanvas(); if(gameId==='roulette') initRoulette(); if(gameId==='blackjack') initBlackjack(); if(gameId==='slots') initSlots(); if(gameId==='sicbo') initSicBo(); if(gameId==='rps') initRPS();
    };
    function getBetAmount() { const v = parseInt(document.getElementById('bet-input').value); return (isNaN(v) || v < 10) ? 10 : v; }
    function checkGold(amount) { if(player.gold < amount) { showToast("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return false; } if(!consumeEnergy(2)) return false; player.gold -= amount; updateUI(); return true; }

    const bjCtx=document.getElementById('bj-canvas').getContext('2d'); let bjState={p:[],d:[]}; let currentBet = 0;
    function initBlackjack(){bjState={p:[],d:[]};drawBj();document.getElementById('bj-controls').classList.remove('hidden');document.getElementById('bj-actions').classList.add('hidden');}
    function drawBj(){bjCtx.clearRect(0,0,300,200);bjCtx.fillStyle='#aaa';bjCtx.font='14px Arial';bjCtx.textAlign='center';bjCtx.fillText("ë”œëŸ¬",150,30);bjState.d.forEach((c,i)=>drawCard(150+(i-bjState.d.length/2)*30,50,c));bjCtx.fillText("ë‚˜",150,150);bjState.p.forEach((c,i)=>drawCard(150+(i-bjState.p.length/2)*30,110,c));if(bjState.p.length>0){bjCtx.fillStyle='white';bjCtx.fillText(getSum(bjState.p),150,180);bjCtx.fillText(bjState.d.length==1?"?":getSum(bjState.d),150,20);}}
    function drawCard(x,y,v){bjCtx.fillStyle='white';bjCtx.fillRect(x-12,y-18,24,36);bjCtx.strokeStyle='#000';bjCtx.strokeRect(x-12,y-18,24,36);bjCtx.fillStyle='black';bjCtx.font='16px Arial';bjCtx.fillText(v,x,y+5);}
    window.startBlackjack=function(){currentBet=getBetAmount();document.getElementById('bj-result').innerText="";if(!checkGold(currentBet))return;bjState.p=[rCard(),rCard()];bjState.d=[rCard()];drawBj();document.getElementById('bj-controls').classList.add('hidden');document.getElementById('bj-actions').classList.remove('hidden');};
    window.bjHit=function(){bjState.p.push(rCard());drawBj();if(getSum(bjState.p)>21)endBj(false,"ë²„ìŠ¤íŠ¸!");};
    window.bjStand=function(){while(getSum(bjState.d)<17)bjState.d.push(rCard());drawBj();let p=getSum(bjState.p),d=getSum(bjState.d);if(d>21||p>d)endBj(true,"ìŠ¹ë¦¬!");else if(p==d){player.gold+=currentBet*2;endBj(false,"ë¬´ìŠ¹ë¶€");}else endBj(false,"íŒ¨ë°°");};
    function rCard(){return Math.floor(Math.random()*10)+2;} function getSum(h){return h.reduce((a,b)=>a+(b=='?'?0:b),0);}
    function endBj(w,m){document.getElementById('bj-result').innerText=m;if(w){player.gold+=currentBet*2;updateUI();}setTimeout(()=>{document.getElementById('bj-controls').classList.remove('hidden');document.getElementById('bj-actions').classList.add('hidden');},1500);}

    const rCtx=document.getElementById('roulette-canvas').getContext('2d'); let rSpin=false;
    function initRoulette(){drawWheel(0);document.getElementById('roulette-btns').style.display='block';}
    function drawWheel(r){rCtx.clearRect(0,0,300,300);rCtx.save();rCtx.translate(150,150);rCtx.rotate(r);for(let i=0;i<12;i++){rCtx.beginPath();rCtx.arc(0,0,140,i*Math.PI/6,(i+1)*Math.PI/6);rCtx.lineTo(0,0);rCtx.fillStyle=i%2==0?'#e74c3c':'#2c3e50';rCtx.fill();rCtx.stroke();rCtx.save();rCtx.rotate(i*Math.PI/6+Math.PI/12);rCtx.translate(110,0);rCtx.rotate(Math.PI/2);rCtx.fillStyle='white';rCtx.font='20px Arial';rCtx.textAlign='center';rCtx.fillText(i+1,0,5);rCtx.restore();}rCtx.restore();rCtx.beginPath();rCtx.moveTo(150,10);rCtx.lineTo(140,-10);rCtx.lineTo(160,-10);rCtx.fillStyle='gold';rCtx.fill();}
    window.startRoulette=function(t){currentBet=getBetAmount();if(rSpin||!checkGold(currentBet))return;rSpin=true;document.getElementById('roulette-btns').style.display='none';let s=0.5,d=0.005,rot=Math.random()*6;function ani(){if(s>0){rot+=s;s-=d;if(s<0)s=0;drawWheel(rot);requestAnimationFrame(ani);}else{rSpin=false;calcR(rot,t);}}ani();}
    function calcR(r,t){let a=r%(Math.PI*2),p=(Math.PI*1.5-a)%(Math.PI*2);if(p<0)p+=Math.PI*2;let res=Math.floor(p/(Math.PI/6))+1,w=false,m=0;if(t=='odd'&&res%2!=0){w=true;m=2;}else if(t=='even'&&res%2==0){w=true;m=2;}else if(t=='lucky7'&&res==7){w=true;m=10;}let msg=document.getElementById('roulette-result');if(w){player.gold+=currentBet*m;msg.innerText=`ë‹¹ì²¨! ${res}`;msg.style.color='lime';}else{msg.innerText=`ê½! ${res}`;msg.style.color='red';}updateUI();document.getElementById('roulette-btns').style.display='block';}

    const sCtx=document.getElementById('slot-canvas').getContext('2d'); const syms=['ğŸ’','ğŸ‹','ğŸ‡','ğŸ’','7ï¸âƒ£'];
    function initSlots(){drawS([0,0,0]);}
    function drawS(o){sCtx.clearRect(0,0,300,150);sCtx.fillStyle='#111';sCtx.fillRect(10,10,280,130);for(let i=0;i<3;i++){sCtx.save();sCtx.beginPath();sCtx.rect(20+i*90,20,80,110);sCtx.clip();for(let j=0;j<10;j++){sCtx.font='40px Arial';sCtx.fillStyle='white';sCtx.textAlign='center';sCtx.textBaseline='middle';sCtx.fillText(syms[j%5],60+i*90,j*80+(o[i]%400)-200);}sCtx.restore();sCtx.strokeStyle='gold';sCtx.lineWidth=3;sCtx.strokeRect(20+i*90,20,80,110);}sCtx.strokeStyle='rgba(255,0,0,0.5)';sCtx.beginPath();sCtx.moveTo(10,75);sCtx.lineTo(290,75);sCtx.stroke();}
    window.spinSlots=function(){currentBet=getBetAmount();if(!checkGold(currentBet))return;document.getElementById('slot-spin-btn').disabled=true;let res=[Math.floor(Math.random()*5),Math.floor(Math.random()*5),Math.floor(Math.random()*5)],t=[0,0,0],c=[0,0,0],st=null;for(let i=0;i<3;i++)t[i]=(5+i*3)*400+(275-res[i]*80)%400;function ani(ts){if(!st)st=ts;let p=ts-st,d=0;for(let i=0;i<3;i++){let dur=1000+i*1000;if(p<dur){let e=1-Math.pow(1-p/dur,3);c[i]=t[i]*e;}else{c[i]=t[i];d++;}}drawS(c);if(d<3)requestAnimationFrame(ani);else{checkS(res);document.getElementById('slot-spin-btn').disabled=false;}}requestAnimationFrame(ani);}
    function checkS(r){let w=0;if(r[0]==4&&r[1]==4&&r[2]==4)w=50;else if(r[0]==r[1]&&r[1]==r[2])w=10;else if(r[0]==r[1]||r[1]==r[2]||r[0]==r[2])w=2;let m=document.getElementById('slot-result');if(w>0){player.gold+=currentBet*w;m.innerText=`ë‹¹ì²¨! +${currentBet*w}G`;m.style.color='gold';}else{m.innerText="ê½";m.style.color='#ccc';}updateUI();}

    const rcCtx=document.getElementById('race-canvas').getContext('2d');
    function initRaceCanvas(){rcCtx.clearRect(0,0,350,200);rcCtx.fillStyle='#2e7d32';rcCtx.fillRect(0,0,350,200);rcCtx.strokeStyle='white';rcCtx.setLineDash([5,5]);for(let i=1;i<4;i++){rcCtx.beginPath();rcCtx.moveTo(0,i*50);rcCtx.lineTo(350,i*50);rcCtx.stroke();}rcCtx.setLineDash([]);rcCtx.fillStyle='red';rcCtx.fillRect(320,0,5,200);for(let i=0;i<4;i++)drawHorse(10,i*50+35,i+1);document.getElementById('race-btns').style.display='block';}
    function drawHorse(x,y,n){rcCtx.save();rcCtx.translate(x,y);rcCtx.scale(-1,1);rcCtx.font='30px Arial';rcCtx.fillText('ğŸ',-15,0);rcCtx.restore();rcCtx.fillStyle='white';rcCtx.font='12px Arial';rcCtx.fillText(n,x-5,y+5);}
    window.startRace=function(p){currentBet=getBetAmount();if(!checkGold(currentBet))return;document.getElementById('race-btns').style.display='none';let h=[10,10,10,10],t=setInterval(()=>{rcCtx.fillStyle='#2e7d32';rcCtx.fillRect(0,0,350,200);rcCtx.strokeStyle='white';rcCtx.setLineDash([5,5]);for(let i=1;i<4;i++){rcCtx.beginPath();rcCtx.moveTo(0,i*50);rcCtx.lineTo(350,i*50);rcCtx.stroke();}rcCtx.setLineDash([]);rcCtx.fillStyle='red';rcCtx.fillRect(320,0,5,200);let w=null;h.forEach((v,i)=>{h[i]+=Math.random()*5;drawHorse(h[i],i*50+35+Math.sin(Date.now()/50+i)*3,i+1);if(h[i]>320&&!w)w=i+1;});if(w){clearInterval(t);let m=document.getElementById('race-result');if(w==p){player.gold+=currentBet*4;m.innerText=`ìš°ìŠ¹! ${w}ë²ˆ`;m.style.color='lime';}else{m.innerText=`íŒ¨ë°°.. ${w}ë²ˆ`;m.style.color='red';}updateUI();document.getElementById('race-btns').style.display='block';}},30);}

    const scCtx=document.getElementById('sicbo-canvas').getContext('2d');
    function initSicBo(){scCtx.clearRect(0,0,300,200);scCtx.beginPath();scCtx.arc(150,100,80,0,6.28);scCtx.fillStyle='rgba(0,0,0,0.3)';scCtx.fill();scCtx.stroke();drawDice(130,100,1);drawDice(170,100,2);drawDice(150,80,3);document.getElementById('sicbo-btns').style.display='block';}
    function drawDice(x,y,n,a=0){scCtx.save();scCtx.translate(x,y);scCtx.rotate(a);scCtx.fillStyle='white';scCtx.fillRect(-15,-15,30,30);scCtx.strokeRect(-15,-15,30,30);scCtx.fillStyle='black';scCtx.font='20px Arial';scCtx.textAlign='center';scCtx.fillText(['âš€','âš','âš‚','âšƒ','âš„','âš…'][n-1],0,8);scCtx.restore();}
    window.playSicBo=function(p){currentBet=getBetAmount();if(!checkGold(currentBet))return;document.getElementById('sicbo-btns').style.display='none';let dice=[{x:150,y:100,vx:0,vy:0},{x:150,y:100,vx:0,vy:0},{x:150,y:100,vx:0,vy:0}];dice.forEach(d=>{d.vx=(Math.random()-0.5)*20;d.vy=(Math.random()-0.5)*20;});let f=0;function loop(){scCtx.clearRect(0,0,300,200);scCtx.beginPath();scCtx.arc(150,100,80,0,6.28);scCtx.fillStyle='rgba(0,0,0,0.3)';scCtx.fill();scCtx.stroke();dice.forEach(d=>{d.x+=d.vx;d.y+=d.vy;if(Math.sqrt((d.x-150)**2+(d.y-100)**2)>70){d.vx*=-0.8;d.vy*=-0.8;d.x=150+(d.x-150)*0.9;d.y=100+(d.y-100)*0.9;}d.vx*=0.95;d.vy*=0.95;drawDice(d.x,d.y,Math.floor(Math.random()*6)+1,f/5);});f++;if(f<60)requestAnimationFrame(loop);else{let v=[0,0,0].map(()=>Math.floor(Math.random()*6)+1);scCtx.clearRect(0,0,300,200);scCtx.beginPath();scCtx.arc(150,100,80,0,6.28);scCtx.fillStyle='rgba(0,0,0,0.3)';scCtx.fill();scCtx.stroke();drawDice(120,100,v[0]);drawDice(180,100,v[1]);drawDice(150,70,v[2]);let s=v.reduce((a,b)=>a+b,0),r=(s>=4&&s<=10)?'small':'big';if(v[0]==v[1]&&v[1]==v[2])r='triple';let m=document.getElementById('sicbo-result');if(p==r){player.gold+=currentBet*2;m.innerText="ì ì¤‘!";m.style.color='lime';}else{m.innerText="ì‹¤íŒ¨";m.style.color='red';}updateUI();document.getElementById('sicbo-btns').style.display='block';}}loop();}

    // 6. ê°€ìœ„ë°”ìœ„ë³´ (RPS)
    const rpsCanvas = document.getElementById('rps-canvas');
    const rpsCtx = rpsCanvas ? rpsCanvas.getContext('2d') : null;
    function initRPS() { if(!rpsCtx) return; drawRPS('?', '?'); document.getElementById('rps-btns').style.display='block'; document.getElementById('rps-bonus-btn').style.display='none'; document.getElementById('rps-result').innerText="ì„ íƒí•˜ì„¸ìš”"; }
    function drawRPS(p, c) { rpsCtx.clearRect(0,0,300,250); rpsCtx.fillStyle='#222'; rpsCtx.fillRect(0,0,300,250); rpsCtx.fillStyle='white'; rpsCtx.font='20px Arial'; rpsCtx.textAlign='center'; rpsCtx.fillText("YOU",75,40); rpsCtx.fillText("COM",225,40); rpsCtx.font='60px Arial'; rpsCtx.fillText(getHand(p),75,120); rpsCtx.fillText(getHand(c),225,120); rpsCtx.font='30px Arial'; rpsCtx.fillStyle='red'; rpsCtx.fillText("VS",150,120); }
    function getHand(t) { if(t=='rock')return 'âœŠ'; if(t=='scissors')return 'âœŒï¸'; if(t=='paper')return 'âœ‹'; return 'â“'; }
    window.playRPS=function(c) {
        currentBet=getBetAmount(); if(!checkGold(currentBet))return; document.getElementById('rps-btns').style.display='none';
        let cnt=0, hands=['rock','scissors','paper'], anim=setInterval(()=>{drawRPS(hands[cnt%3],hands[(cnt+1)%3]);cnt++;},100);
        setTimeout(()=>{clearInterval(anim); let com=hands[Math.floor(Math.random()*3)]; drawRPS(c,com);
            let res='draw'; if(c==com) res='draw'; else if((c=='scissors'&&com=='paper')||(c=='rock'&&com=='scissors')||(c=='paper'&&com=='rock')) res='win'; else res='lose';
            let msg=document.getElementById('rps-result');
            if(res=='win'){msg.innerText="ìŠ¹ë¦¬! ë£°ë › ì°¬ìŠ¤!";msg.style.color='lime';document.getElementById('rps-bonus-btn').style.display='block';}
            else if(res=='draw'){msg.innerText="ë¬´ìŠ¹ë¶€ (ë°˜í™˜)";msg.style.color='white';player.gold+=currentBet;updateUI();setTimeout(()=>{document.getElementById('rps-btns').style.display='block';},1000);}
            else{msg.innerText="íŒ¨ë°°...";msg.style.color='red';setTimeout(()=>{document.getElementById('rps-btns').style.display='block';},1000);}
        },1000);
    };
    function drawRpsWheel(a) {
        rpsCtx.clearRect(0,0,300,250);rpsCtx.save();rpsCtx.translate(150,125);rpsCtx.rotate(a);
        const rw=['x1','x2','x3','x4','ê½','x1'], cl=['#3498db','#2ecc71','#f1c40f','#e67e22','#e74c3c','#9b59b6'];
        for(let i=0;i<6;i++){rpsCtx.beginPath();rpsCtx.moveTo(0,0);rpsCtx.arc(0,0,100,i*Math.PI/3,(i+1)*Math.PI/3);rpsCtx.fillStyle=cl[i];rpsCtx.fill();rpsCtx.stroke();
        rpsCtx.save();rpsCtx.rotate(i*Math.PI/3+Math.PI/6);rpsCtx.translate(70,0);rpsCtx.rotate(Math.PI/2);rpsCtx.fillStyle='white';rpsCtx.font='bold 20px Arial';rpsCtx.fillText(rw[i],0,5);rpsCtx.restore();}
        rpsCtx.restore();rpsCtx.beginPath();rpsCtx.moveTo(150,25);rpsCtx.lineTo(140,5);rpsCtx.lineTo(160,5);rpsCtx.fillStyle='gold';rpsCtx.fill();
    }
    window.spinRpsWheel=function(){
        document.getElementById('rps-bonus-btn').style.display='none';
        let s=0.5,dec=0.005,ang=Math.random()*6;
        function ani(){if(s>0){ang+=s;s-=dec;if(s<0)s=0;drawRpsWheel(ang);requestAnimationFrame(ani);}else{
            let a=ang%(Math.PI*2),ptr=(Math.PI*1.5-a)%(Math.PI*2); if(ptr<0)ptr+=Math.PI*2;
            let idx=Math.floor(ptr/(Math.PI/3)), mul=[1,2,3,4,0,1][idx];
            let w=currentBet*mul; player.gold+=w; updateUI();
            let msg=document.getElementById('rps-result');
            if(mul>0){msg.innerText=`ì¶•í•˜! x${mul}ë°° (+${w}G)`;msg.style.color='gold';}else{msg.innerText="ê½!";msg.style.color='gray';}
            setTimeout(initRPS,2000);
        }}ani();
    };

</script>
</body>
</html>
