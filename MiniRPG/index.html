<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skeleton Knight's Awakening</title>
    <style>
        body { background-color: #1a1a1a; color: white; margin: 0; overflow: hidden; font-family: 'DungGeunMo', monospace, sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #000; }
        canvas { image-rendering: pixelated; display: block; }
        
        /* UI ì˜¤ë²„ë ˆì´ */
        .overlay { position: absolute; pointer-events: none; text-shadow: 1px 1px 0 #000; z-index: 10; }
        
        /* ìƒë‹¨ ë°” (ì†Œí˜•í™”) */
        #top-bar {
            top: 5px; left: 5px; right: 5px;
            display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.6); padding: 5px 10px;
            border-radius: 5px; border: 1px solid #666;
            pointer-events: auto; font-size: 12px;
        }
        .stat-group { display: flex; align-items: center; margin-right: 10px; }
        .bar-bg { width: 60px; height: 6px; background: #333; display: inline-block; margin: 0 5px; position: relative; border: 1px solid #555; }
        .bar-fill { height: 100%; display: block; }
        .hp-fill { background: #e74c3c; } .mp-fill { background: #3498db; } .exp-fill { background: #f1c40f; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .ui-btn { background: #444; color: white; border: 1px solid #fff; padding: 2px 6px; cursor: pointer; font-family: inherit; font-size: 11px; margin-left: 2px; }
        .ui-btn:hover { background: #666; }

        /* íŒ¨ë„ ê³µí†µ */
        .game-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
            background: #2c3e50; border: 3px solid gold; padding: 15px;
            display: none; text-align: center; pointer-events: auto; z-index: 50;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .panel-header { color: gold; margin-bottom: 10px; border-bottom: 2px solid gold; padding-bottom: 5px; font-size: 20px; }
        .close-btn { position: absolute; top: 5px; right: 5px; background: #c0392b; border: none; color: white; cursor: pointer; }

        /* ìƒíƒœì°½ & ì¸ë²¤í† ë¦¬ */
        .tab-menu { display: flex; justify-content: center; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; background: #333; border: 1px solid #555; color: #aaa; cursor: pointer; }
        .tab-btn.selected { background: #e67e22; border-color: gold; color: white; font-weight: bold; }
        
        .stat-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #444; font-size: 14px; }
        .stat-up-btn { background: #27ae60; width: 20px; height: 20px; padding: 0; line-height: 20px; margin-left: 5px; border: none; color: white; cursor: pointer; }
        
        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .inv-item { background: rgba(0,0,0,0.3); padding: 8px; border: 1px solid #555; text-align: left; font-size: 12px; }
        .inv-item.equipped { border-color: lime; background: rgba(0, 255, 0, 0.1); }
        .item-name { font-weight: bold; color: #fff; margin-bottom: 3px; display: block; }
        .item-desc { font-size: 11px; color: #aaa; margin-bottom: 5px; display: block; }
        .item-btn { background: #555; border: 1px solid #777; color: white; width: 100%; cursor: pointer; }

        /* ìŠ¤í‚¬ ìŠ¬ë¡¯ */
        #skill-bar {
            bottom: 20px; right: 20px; display: flex; gap: 8px; pointer-events: auto;
        }
        .skill-slot {
            width: 50px; height: 50px; background: rgba(0,0,0,0.8); border: 2px solid #888;
            position: relative; display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer; flex-direction: column;
        }
        .skill-slot.active { border-color: #3498db; box-shadow: 0 0 10px #3498db; }
        .skill-cooldown {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center;
            font-size: 12px; color: white;
        }
        .skill-key { position: absolute; top: 2px; left: 2px; font-size: 9px; color: gold; }

        /* ê¸°íƒ€ */
        #map-canvas { border: 2px solid gold; background: #000; width: 250px; height: 250px; image-rendering: pixelated; margin: 0 auto; display: block;}
        #toast { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 15px; display: none; z-index: 100; border: 1px solid white; font-size: 14px; }
        .damage-text { position: absolute; font-weight: bold; font-size: 14px; animation: floatUp 0.8s forwards; pointer-events: none; text-shadow: 1px 1px 0 #000; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-30px); opacity: 0; } }

        /* ëª¨ë°”ì¼ìš© */
        #mobile-controls { position: absolute; bottom: 20px; left: 20px; display: none; z-index: 90; }
        @media (max-width: 768px) { #mobile-controls { display: block; } #skill-bar { bottom: 120px; } }
        .dpad-btn { width: 45px; height: 45px; background: rgba(255,255,255,0.15); margin: 2px; display: inline-block; text-align: center; line-height: 45px; color: white; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); font-size: 18px; }
        .dpad-btn:active { background: rgba(255,255,255,0.4); }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- ìƒë‹¨ ì •ë³´ì°½ (ì¶•ì†Œë¨) -->
    <div id="top-bar" class="overlay">
        <div style="display: flex; align-items: center;">
            <div class="stat-group">
                <span>Lv.<span id="ui-lvl">1</span></span>
                <div class="bar-bg"><div id="ui-exp-bar" class="bar-fill exp-fill" style="width:0%"></div></div>
            </div>
            <div class="stat-group">
                <span style="color:gold;">ğŸ’°<span id="ui-gold">0</span></span>
            </div>
        </div>
        <div style="display: flex; align-items: center;">
            <div class="stat-group">
                <span style="color:#e74c3c;">HP</span>
                <div class="bar-bg"><div id="ui-hp-bar" class="bar-fill hp-fill" style="width:100%"></div></div>
            </div>
            <div class="stat-group">
                <span style="color:#3498db;">MP</span>
                <div class="bar-bg"><div id="ui-mp-bar" class="bar-fill mp-fill" style="width:100%"></div></div>
            </div>
        </div>
        <div>
            <button class="ui-btn" onclick="toggleMenu()">ë©”ë‰´(C)</button>
            <button class="ui-btn" onclick="toggleMap()">ì§€ë„(M)</button>
            <button class="ui-btn" onclick="saveGame()">ì €ì¥</button>
        </div>
    </div>

    <!-- ìŠ¤í‚¬ ë°” -->
    <div id="skill-bar" class="overlay">
        <div class="skill-slot" id="skill-1" onclick="toggleAutoSkill()">
            <span class="skill-key">Auto</span>
            <span id="skill-icon-1">ğŸ’¥</span>
            <div class="skill-cooldown" id="cd-1"></div>
        </div>
        <div class="skill-slot" id="skill-2" onclick="useSkill(2)">
            <span class="skill-key">H</span>
            <span>â¤ï¸</span>
            <div class="skill-cooldown" id="cd-2"></div>
        </div>
    </div>

    <!-- ë©”ë‰´ íŒ¨ë„ (ìƒíƒœì°½/ì¸ë²¤í† ë¦¬) -->
    <div id="menu-panel" class="game-panel">
        <button class="close-btn" onclick="toggleMenu()">X</button>
        <div class="tab-menu">
            <div id="tab-btn-status" class="tab-btn selected" onclick="switchTab('status')">ëŠ¥ë ¥ì¹˜</div>
            <div id="tab-btn-inventory" class="tab-btn" onclick="switchTab('inventory')">ì¸ë²¤í† ë¦¬</div>
        </div>
        
        <!-- ìƒíƒœì°½ -->
        <div id="tab-status">
            <h4 style="color:gold; margin:5px 0;">ì”ì—¬ í¬ì¸íŠ¸: <span id="ui-stat-points">0</span></h4>
            <div class="stat-row"><span>í˜ (STR)</span> <div><span id="val-str">10</span> <button class="stat-up-btn" onclick="upStat('str')">+</button></div></div>
            <div class="stat-row"><span>ì²´ë ¥ (VIT)</span> <div><span id="val-vit">10</span> <button class="stat-up-btn" onclick="upStat('vit')">+</button></div></div>
            <div class="stat-row"><span>ì§€ëŠ¥ (INT)</span> <div><span id="val-int">10</span> <button class="stat-up-btn" onclick="upStat('int')">+</button></div></div>
            <hr style="border-color:#444;">
            <div class="stat-row"><span>ê³µê²©ë ¥: <span id="total-atk">0</span></span> <span>ë°©ì–´ë ¥: <span id="total-def">0</span></span></div>
        </div>

        <!-- ì¸ë²¤í† ë¦¬ -->
        <div id="tab-inventory" style="display:none;">
            <div id="inv-list" class="inv-grid"></div>
        </div>
    </div>

    <!-- ìƒì  íŒ¨ë„ -->
    <div id="shop-panel" class="game-panel">
        <h2 class="panel-header">ğŸ’° ë§Œë¬¼ìƒì </h2>
        <div id="shop-list" class="inv-grid"></div>
        <button class="ui-btn" style="margin-top:20px; padding: 5px 20px; font-size: 14px;" onclick="closePanel()">ë‚˜ê°€ê¸°</button>
    </div>

    <!-- ì§€ë„ íŒ¨ë„ -->
    <div id="map-panel" class="game-panel">
        <h2 class="panel-header">ì›”ë“œ ë§µ</h2>
        <canvas id="map-canvas"></canvas>
        <p style="font-size:12px; color:#aaa;">(ì´ˆë¡:ì´ˆê¸‰ / ì£¼í™©:ì¤‘ê¸‰ / ë¹¨ê°•:ê³ ê¸‰ / ë³´ë¼:ë³´ìŠ¤)</p>
        <button class="ui-btn" style="padding: 5px 20px; font-size: 14px;" onclick="toggleMap()">ë‹«ê¸°</button>
    </div>

    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="start-screen" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100; text-align:center; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 style="color:#e74c3c; margin-bottom:10px;">ğŸ’€ í•´ê³¨ì˜ ê°ì„±</h1>
        <p style="color:#ccc; font-size:14px; line-height:1.6;">
            ëª¬ìŠ¤í„°ë¥¼ ì¡ì•„ ë ˆë²¨ì—…í•˜ê³  ìŠ¤íƒ¯ì„ ì°ìœ¼ì„¸ìš”.<br>
            ìŠ¤í‚¬ì„ ë°°ìš°ê³  ì¥ë¹„ë¥¼ ë§ì¶° ë§ˆì™•ì„ ì²˜ë‹¨í•˜ì„¸ìš”.
        </p>
        <button style="padding:10px 30px; font-size:20px; background:#e74c3c; border:2px solid white; color:white; cursor:pointer; margin-top:20px;" onclick="startGameFlow()">ê²Œì„ ì‹œì‘</button>
    </div>

    <!-- ì—”ë”© í™”ë©´ -->
    <div id="ending-screen" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; text-align:center; padding-top:20%;">
        <h1 style="color:gold;">ğŸ‘‘ ë³µìˆ˜ ì„±ê³µ!</h1>
        <p>ë§ˆì™•ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì€ ì „ì„¤ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <button style="padding:10px 30px; font-size:20px; cursor:pointer;" onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <!-- í† ìŠ¤íŠ¸ & ë°ë¯¸ì§€ ì»¨í…Œì´ë„ˆ -->
    <div id="toast"></div>
    <div id="damage-container" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:90;"></div>

    <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ -->
    <div id="mobile-controls">
        <div style="text-align:center;">
            <div class="dpad-btn" onpointerdown="startMove(0,-1)" onpointerup="stopMove()" onpointerleave="stopMove()">â–²</div><br>
            <div class="dpad-btn" onpointerdown="startMove(-1,0)" onpointerup="stopMove()" onpointerleave="stopMove()">â—€</div>
            <div class="dpad-btn" onpointerdown="startMove(0,1)" onpointerup="stopMove()" onpointerleave="stopMove()">â–¼</div>
            <div class="dpad-btn" onpointerdown="startMove(1,0)" onpointerup="stopMove()" onpointerleave="stopMove()">â–¶</div>
        </div>
    </div>
</div>

<script>
    // === 1. ì„¤ì • ë° ìƒìˆ˜ ===
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const TILE_SIZE = 40;
    const MAP_SIZE = 512; // 512x512 íƒ€ì¼

    const TILE = { GRASS:0, WATER:1, MOUNTAIN:2, VILLAGE:3, ROAD:4, WALL:5, GATE:6, SHOP:7, CASINO:8, BOSS:9, BOSS_WALL:10, INN:11 };
    
    // ê²Œì„ ìƒíƒœ
    let mapData = [];
    let enemies = [];
    let camera = { x: 0, y: 0 };
    let gatesOpen = false;
    let autoSkill = false;
    let moveTimer = null;

    // í”Œë ˆì´ì–´ ê°ì²´
    const player = {
        x: 256, y: 256,
        lvl: 1, exp: 0, maxExp: 100,
        gold: 500,
        str: 10, vit: 10, int: 10, statPoints: 0,
        hp: 100, maxHp: 100,
        mp: 50, maxMp: 50,
        atk: 0, def: 0,
        equip: { weapon: null, armor: null },
        inventory: [],
        sprite: 'ğŸ’€'
    };

    // ìŠ¤í‚¬ ë°ì´í„°
    const skills = {
        smash: { name: "ê°•íƒ€", cost: 10, dmgMult: 2.5, cd: 3000, last: 0 },
        heal: { name: "íšŒë³µ", cost: 20, heal: 30, cd: 5000, last: 0 }
    };

    // ì•„ì´í…œ ë°ì´í„°
    const itemDB = {
        w1: { name: "ë…¹ìŠ¨ ê²€", type: "weapon", atk: 10, cost: 500, desc: "ì˜¤ë˜ëœ ê²€" },
        w2: { name: "ë¼ˆ ë¶„ì‡„ê¸°", type: "weapon", atk: 30, cost: 2000, desc: "ë¼ˆë¥¼ ë¶€ìˆ˜ëŠ” ë‘”ê¸°" },
        w3: { name: "ìš©ì‚¬ì˜ ê²€", type: "weapon", atk: 60, cost: 8000, desc: "ë¹›ë‚˜ëŠ” ê²€" },
        a1: { name: "ê°€ì£½ ê°‘ì˜·", type: "armor", def: 5, cost: 500, desc: "ì§ˆê¸´ ê°€ì£½" },
        a2: { name: "ì²  ê°‘ì˜·", type: "armor", def: 15, cost: 2500, desc: "ë‹¨ë‹¨í•œ ì² " },
        a3: { name: "ë“œë˜ê³¤ ì•„ë¨¸", type: "armor", def: 40, cost: 10000, desc: "ì „ì„¤ì˜ ê°‘ì˜·" },
        p1: { name: "ì²´ë ¥ í¬ì…˜", type: "use", heal: 50, cost: 50, desc: "HP 50 íšŒë³µ" },
        p2: { name: "ë§ˆë‚˜ í¬ì…˜", type: "use", mp: 30, cost: 50, desc: "MP 30 íšŒë³µ" }
    };

    // === 2. ì´ˆê¸°í™” ë° ë§µ ìƒì„± ===
    
    // í™”ë©´ ë¦¬ì‚¬ì´ì¦ˆ í•¨ìˆ˜
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // ì¹´ë©”ë¼ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•  ê²½ìš°
        if(typeof updateCamera === 'function') updateCamera();
        if(typeof draw === 'function') draw();
    }
    window.addEventListener('resize', resizeCanvas);

    function init() {
        generateMap(); // ë§µì„ ë¨¼ì € ìƒì„±
        resizeCanvas(); // ê·¸ ë‹¤ìŒ ìº”ë²„ìŠ¤ ë¦¬ì‚¬ì´ì¦ˆ (draw í˜¸ì¶œë¨)
        calcStats();
        updateUI();
        requestAnimationFrame(gameLoop);
    }

    function generateMap() {
        for(let y=0; y<MAP_SIZE; y++) mapData.push(new Array(MAP_SIZE).fill(TILE.GRASS));
        for(let i=0; i<400; i++) createBlob(TILE.MOUNTAIN, 10, 25);
        for(let i=0; i<200; i++) createBlob(TILE.WATER, 5, 15);
        for(let i=0; i<50; i++) createBlob(TILE.GRASS, 20, 40);

        const cx = MAP_SIZE/2, cy = MAP_SIZE/2;
        drawRect(cx-15, cy-15, 30, 30, TILE.VILLAGE);
        drawRectBorder(cx-16, cy-16, 32, 32, TILE.WALL);
        mapData[cy-16][cx] = TILE.GATE; mapData[cy+16][cx] = TILE.GATE;
        mapData[cy][cx-16] = TILE.GATE; mapData[cy][cx+16] = TILE.GATE;

        mapData[cy-5][cx] = TILE.SHOP;
        mapData[cy+5][cx] = TILE.INN;
        mapData[cy][cx-8] = TILE.CASINO;

        createRoad(cx, cy-16, 0, -1, 200);
        createRoad(cx, cy+16, 0, 1, 200);
        createRoad(cx-16, cy, -1, 0, 200);
        createRoad(cx+16, cy, 1, 0, 200);

        drawRect(10, 10, 20, 20, TILE.BOSS_FLOOR);
        drawRectBorder(10, 10, 20, 20, TILE.BOSS_WALL);
        mapData[30][20] = TILE.BOSS_FLOOR;
        enemies.push({x:20, y:20, type:'boss', name:'ë§ˆì™•', hp:2000, maxHp:2000, atk:100, exp:0, sprite:'ğŸ‘¿'});

        spawnZoneEnemies(cx, cy);
    }

    function createRoad(sx, sy, dx, dy, len) {
        for(let i=1; i<len; i++) {
            let x = sx + dx*i, y = sy + dy*i;
            if(x>0 && x<MAP_SIZE && y>0 && y<MAP_SIZE) {
                for(let ty=y-2; ty<=y+2; ty++) for(let tx=x-2; tx<=x+2; tx++) {
                    if(tx>=0 && tx<MAP_SIZE && ty>=0 && ty<MAP_SIZE) {
                        if(mapData[ty][tx] === TILE.WATER || mapData[ty][tx] === TILE.MOUNTAIN) mapData[ty][tx] = TILE.GRASS;
                    }
                }
                mapData[y][x] = TILE.ROAD;
            }
        }
    }

    function spawnZoneEnemies(cx, cy) {
        for(let i=0; i<300; i++) {
            let x = Math.floor(Math.random()*MAP_SIZE);
            let y = Math.floor(Math.random()*MAP_SIZE);
            if(mapData[y][x] !== TILE.GRASS) continue;
            let dist = Math.sqrt((x-cx)**2 + (y-cy)**2);
            if(dist < 30) continue;
            let mob = null;
            if(dist < 100) mob = {name:'ìŠ¬ë¼ì„', hp:30, atk:5, exp:10, sprite:'ğŸ’§'};
            else if(dist < 200) mob = {name:'ê³ ë¸”ë¦°', hp:80, atk:20, exp:30, sprite:'ğŸ‘º'};
            else mob = {name:'ì˜¤í¬', hp:200, atk:50, exp:80, sprite:'ğŸ—'};
            if(mob) enemies.push({x, y, ...mob, maxHp: mob.hp});
        }
    }

    function createBlob(tile, min, max) { 
        let cx = Math.floor(Math.random()*MAP_SIZE), cy = Math.floor(Math.random()*MAP_SIZE);
        let size = Math.floor(Math.random()*(max-min)+min);
        for(let y=cy-size; y<cy+size; y++) for(let x=cx-size; x<cx+size; x++) 
            if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE && Math.random()>0.3) mapData[y][x] = tile;
    }
    function drawRect(x,y,w,h,tile) { for(let j=y; j<y+h; j++) for(let i=x; i<x+w; i++) if(i>=0&&i<MAP_SIZE&&j>=0&&j<MAP_SIZE) mapData[j][i]=tile; }
    function drawRectBorder(x,y,w,h,tile) { for(let j=y; j<=y+h; j++) for(let i=x; i<=x+w; i++) if(i===x||i===x+w||j===y||j===y+h) if(i>=0&&i<MAP_SIZE&&j>=0&&j<MAP_SIZE) mapData[j][i]=tile; }

    // === 3. ê²Œì„ ë¡œì§ ===
    function calcStats() {
        let addAtk = player.equip.weapon ? itemDB[player.equip.weapon].atk : 0;
        let addDef = player.equip.armor ? itemDB[player.equip.armor].def : 0;
        player.maxHp = player.vit * 10;
        player.maxMp = player.int * 5;
        player.atk = player.str * 2 + addAtk;
        player.def = Math.floor(player.vit / 2) + addDef;
    }

    function gainExp(amount) {
        player.exp += amount;
        showToast(`ê²½í—˜ì¹˜ +${amount}`);
        if(player.exp >= player.maxExp) {
            player.lvl++;
            player.exp -= player.maxExp;
            player.maxExp = Math.floor(player.maxExp * 1.2);
            player.statPoints += 3;
            // ë ˆë²¨ì—… ì‹œ ì¦‰ì‹œ íšŒë³µ
            player.hp = player.maxHp;
            player.mp = player.maxMp;
            showToast(`â­ ë ˆë²¨ ì—…! (Lv.${player.lvl})`);
        }
        updateUI();
    }

    setInterval(() => {
        if(player.mp < player.maxMp) {
            player.mp = Math.min(player.maxMp, player.mp + (player.int/5));
            updateUI();
        }
    }, 1000);

    function gameLoop() {
        const now = Date.now();
        // ëª¬ìŠ¤í„° AI
        enemies.forEach(e => {
            if(e.type === 'boss' && e.hp <= 0) return;
            if(!e.lastMove) e.lastMove = 0;
            if(now - e.lastMove > 1000) { 
                let dist = Math.abs(player.x - e.x) + Math.abs(player.y - e.y);
                if(dist < 8) {
                    let dx = Math.sign(player.x - e.x), dy = Math.sign(player.y - e.y);
                    if(Math.abs(player.x - e.x) > Math.abs(player.y - e.y)) dy = 0; else dx = 0;
                    let nx = e.x + dx, ny = e.y + dy;
                    if(nx === player.x && ny === player.y) {
                        let dmg = Math.max(1, e.atk - player.def);
                        player.hp -= dmg;
                        showDamage(player.x, player.y, dmg, 'red');
                        if(player.hp <= 0) gameOver();
                    } else if (mapData[ny][nx] !== TILE.WALL && mapData[ny][nx] !== TILE.WATER) {
                        e.x = nx; e.y = ny;
                    }
                }
                e.lastMove = now;
            }
        });
        
        draw();
        updateUI(); // ì¿¨íƒ€ì„ UI ê°±ì‹ 
        requestAnimationFrame(gameLoop);
    }

    function attack(targetIdx) {
        const target = enemies[targetIdx];
        let dmg = player.atk;
        const now = Date.now();
        
        if(autoSkill && player.mp >= skills.smash.cost && now - skills.smash.last > skills.smash.cd) {
            player.mp -= skills.smash.cost;
            skills.smash.last = now;
            dmg = Math.floor(dmg * skills.smash.dmgMult);
            showDamage(target.x, target.y, "ê°•íƒ€!", 'gold');
        }

        target.hp -= dmg;
        showDamage(target.x, target.y, dmg, 'white');
        
        if(target.hp <= 0) {
            gainExp(target.exp);
            player.gold += target.exp * 2;
            if(target.type === 'boss') document.getElementById('ending-screen').style.display = 'block';
            enemies.splice(targetIdx, 1);
        }
        updateUI();
    }

    // ì´ë¦„ ë³€ê²½: useSkill -> triggerSkill (ì¬ê·€ í˜¸ì¶œ ë°©ì§€)
    function triggerSkill(slot) {
        const now = Date.now();
        if(slot === 2) { 
            if(player.mp >= skills.heal.cost && now - skills.heal.last > skills.heal.cd) {
                player.mp -= skills.heal.cost;
                player.hp = Math.min(player.maxHp, player.hp + skills.heal.heal);
                skills.heal.last = now;
                showDamage(player.x, player.y, "Heal", 'lime');
                updateUI();
            } else {
                showToast("ë§ˆë‚˜ ë¶€ì¡± ë˜ëŠ” ì¿¨íƒ€ì„!");
            }
        }
    }

    function movePlayer(dx, dy) {
        let nx = player.x + dx, ny = player.y + dy;
        let enemyIdx = enemies.findIndex(e => e.x === nx && e.y === ny);
        if(enemyIdx !== -1) { attack(enemyIdx); return; }

        if(nx>=0 && nx<MAP_SIZE && ny>=0 && ny<MAP_SIZE) {
            let t = mapData[ny][nx];
            if(t !== TILE.WATER && t !== TILE.MOUNTAIN && t !== TILE.WALL && t !== TILE.BOSS_WALL) {
                if(t === TILE.GATE && !gatesOpen) { showToast("ë¬´ê¸°ë¥¼ ì¥ì°©í•´ì•¼ ì„±ë¬¸ì´ ì—´ë¦½ë‹ˆë‹¤."); return; }
                player.x = nx; player.y = ny;
                if(t === TILE.SHOP) openShop();
                if(t === TILE.INN) { player.hp=player.maxHp; player.mp=player.maxMp; showToast("íšŒë³µ ì™„ë£Œ!"); }
            }
        }
        camera.x = player.x * TILE_SIZE - window.innerWidth/2;
        camera.y = player.y * TILE_SIZE - window.innerHeight/2;
    }

    function draw() {
        // ì•ˆì „ ì¥ì¹˜: ë§µ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê·¸ë¦¬ì§€ ì•ŠìŒ
        if(!mapData || mapData.length === 0) return;

        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        // í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ ë Œë”ë§ ë²”ìœ„ ë™ì  ê³„ì‚°
        const viewW = Math.ceil(canvas.width / TILE_SIZE) + 2;
        const viewH = Math.ceil(canvas.height / TILE_SIZE) + 2;

        const startCol = Math.floor(camera.x / TILE_SIZE);
        const startRow = Math.floor(camera.y / TILE_SIZE);
        
        for(let y=startRow; y<startRow+viewH; y++) {
            for(let x=startCol; x<startCol+viewW; x++) {
                if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE) {
                    let c = '#222';
                    let t = mapData[y][x];
                    if(t===TILE.GRASS) c = '#2e8b57'; else if(t===TILE.WATER) c = '#3498db';
                    else if(t===TILE.MOUNTAIN) c = '#555'; else if(t===TILE.ROAD) c = '#8b4513';
                    else if(t===TILE.VILLAGE) c = '#d3a95d'; else if(t===TILE.GATE) c = gatesOpen?'#8b4513':'#3e2723';
                    else if(t===TILE.SHOP) c = '#e67e22'; else if(t===TILE.INN) c = '#16a085';
                    else if(t===TILE.BOSS_FLOOR) c = '#440000'; else if(t===TILE.WALL||t===TILE.BOSS_WALL) c='#4a2c2a';
                    
                    ctx.fillStyle = c; ctx.fillRect(x*TILE_SIZE - camera.x, y*TILE_SIZE - camera.y, TILE_SIZE, TILE_SIZE);
                    if(t===TILE.SHOP) drawText('âš’ï¸', x, y);
                    if(t===TILE.INN) drawText('ğŸ¨', x, y);
                    if(t===TILE.CASINO) drawText('ğŸ°', x, y);
                }
            }
        }
        enemies.forEach(e => {
            if(isInView(e.x, e.y)) {
                drawText(e.sprite, e.x, e.y, 30);
                let sx = e.x*TILE_SIZE - camera.x; let sy = e.y*TILE_SIZE - camera.y;
                ctx.fillStyle='red'; ctx.fillRect(sx, sy-5, 40, 4);
                ctx.fillStyle='lime'; ctx.fillRect(sx, sy-5, 40*(e.hp/e.maxHp), 4);
            }
        });
        let px = player.x*TILE_SIZE - camera.x; let py = player.y*TILE_SIZE - camera.y;
        ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(px+20, py+35, 10, 5, 0, 0, Math.PI*2); ctx.fill();
        if(player.equip.weapon) { ctx.font='20px sans-serif'; ctx.fillText('âš”ï¸', px-10, py+25); }
        ctx.font='30px sans-serif'; ctx.fillText(player.sprite, px+5, py+30);
        if(player.equip.armor) { ctx.font='20px sans-serif'; ctx.fillText('ğŸ›¡ï¸', px+30, py+25); }
    }

    function drawText(txt, x, y, size=24) {
        let sx = x*TILE_SIZE - camera.x; let sy = y*TILE_SIZE - camera.y;
        if(sx > -TILE_SIZE && sx < canvas.width && sy > -TILE_SIZE && sy < canvas.height) {
            ctx.font = `${size}px Arial`; ctx.fillText(txt, sx+5, sy+30);
        }
    }
    function isInView(x, y) { return x*TILE_SIZE - camera.x > -TILE_SIZE && x*TILE_SIZE - camera.x < canvas.width && y*TILE_SIZE - camera.y > -TILE_SIZE && y*TILE_SIZE - camera.y < canvas.height; }

    // === UI ===
    function updateUI() {
        calcStats();
        document.getElementById('ui-lvl').innerText = player.lvl;
        document.getElementById('ui-gold').innerText = player.gold;
        document.getElementById('ui-hp-bar').style.width = `${(player.hp/player.maxHp)*100}%`;
        document.getElementById('ui-mp-bar').style.width = `${(player.mp/player.maxMp)*100}%`;
        document.getElementById('ui-exp-bar').style.width = `${(player.exp/player.maxExp)*100}%`;
        
        document.getElementById('ui-stat-points').innerText = player.statPoints;
        document.getElementById('val-str').innerText = player.str;
        document.getElementById('val-vit').innerText = player.vit;
        document.getElementById('val-int').innerText = player.int;
        document.getElementById('total-atk').innerText = player.atk;
        document.getElementById('total-def').innerText = player.def;

        updateCooldownUI('cd-1', skills.smash);
        updateCooldownUI('cd-2', skills.heal);
    }

    function updateCooldownUI(id, skill) {
        const el = document.getElementById(id);
        const diff = Date.now() - skill.last;
        if(diff < skill.cd) { el.style.display='flex'; el.innerText=((skill.cd-diff)/1000).toFixed(1); } else el.style.display='none';
    }

    // === ê¸°ëŠ¥ ===
    window.toggleAutoSkill = () => { autoSkill = !autoSkill; document.getElementById('skill-1').classList.toggle('active', autoSkill); showToast(autoSkill?"ìë™ ìŠ¤í‚¬ ON":"ìë™ ìŠ¤í‚¬ OFF"); };
    window.upStat = (type) => { if(player.statPoints>0){ player.statPoints--; player[type]++; calcStats(); updateUI(); } };
    
    // ìˆ˜ì •: useSkill í˜¸ì¶œ ì‹œ triggerSkill ì‚¬ìš©
    window.useSkill = (s) => triggerSkill(s);
    
    window.toggleMenu = () => { let p = document.getElementById('menu-panel'); p.style.display = p.style.display==='block'?'none':'block'; switchTab('status'); };
    window.switchTab = (t) => {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('selected'));
        document.getElementById('tab-btn-'+t).classList.add('selected');
        document.getElementById('tab-status').style.display=t==='status'?'block':'none';
        document.getElementById('tab-inventory').style.display=t==='inventory'?'block':'none';
        if(t==='inventory') renderInventory();
    };
    function renderInventory() {
        const l = document.getElementById('inv-list'); l.innerHTML='';
        player.inventory.forEach(id => {
            const i = itemDB[id]; const d = document.createElement('div'); d.className='inv-item';
            if(player.equip.weapon===id || player.equip.armor===id) d.classList.add('equipped');
            d.innerHTML = `<span class="item-name">${i.name}</span><span class="item-desc">${i.desc}</span><button class="item-btn" onclick="equipItem('${id}')">${(player.equip.weapon === id || player.equip.armor === id) ? 'í•´ì œ' : 'ì¥ì°©/ì‚¬ìš©'}</button>`;
            l.appendChild(d);
        });
    }
    window.equipItem = (id) => {
        const i = itemDB[id];
        if(i.type === 'use') {
            if(i.heal) player.hp = Math.min(player.maxHp, player.hp + i.heal);
            if(i.mp) player.mp = Math.min(player.maxMp, player.mp + i.mp);
            showToast(`${i.name} ì‚¬ìš©í•¨`);
            // ì‚¬ìš©í•œ ì•„ì´í…œ ì¸ë²¤í† ë¦¬ì—ì„œ ì œê±° (1ê°œë§Œ)
            const idx = player.inventory.indexOf(id);
            if(idx > -1) player.inventory.splice(idx, 1);
        } else if(i.type==='weapon') {
            player.equip.weapon = (player.equip.weapon===id)?null:id;
            if(i.type==='weapon' && player.equip.weapon) gatesOpen=true; 
        } else if(i.type==='armor') {
            player.equip.armor = (player.equip.armor===id)?null:id;
        }
        calcStats(); updateUI(); renderInventory();
    };
    function openShop() { document.getElementById('shop-panel').style.display='block'; renderShop(); }
    window.closePanel = () => document.querySelectorAll('.game-panel').forEach(e=>e.style.display='none');
    function renderShop() {
        const l = document.getElementById('shop-list'); l.innerHTML='';
        for(let id in itemDB) {
            const i = itemDB[id]; const d = document.createElement('div'); d.className='inv-item';
            d.innerHTML=`<span class="item-name">${i.name}</span><span class="item-desc">${i.desc}</span><button class="item-btn" style="background:#e67e22" onclick="buyItem('${id}')">${i.cost}G êµ¬ë§¤</button>`;
            l.appendChild(d);
        }
    }
    window.buyItem = (id) => {
        const i = itemDB[id];
        if(player.gold >= i.cost) {
            player.gold -= i.cost;
            player.inventory.push(id); 
            showToast("êµ¬ë§¤ ì™„ë£Œ");
            if(i.type === 'weapon') gatesOpen = true; 
            updateUI();
        } else showToast("ê³¨ë“œ ë¶€ì¡±");
    };

    window.toggleMap = () => {
        const p = document.getElementById('map-panel');
        if(p.style.display==='block') { p.style.display='none'; return; }
        p.style.display='block';
        const mc = document.getElementById('map-canvas'); const mctx = mc.getContext('2d');
        // ì¶•ì†Œ ë§µ ê·¸ë¦¬ê¸° (250x250)
        mctx.fillStyle='#000'; mctx.fillRect(0,0,250,250);
        const step = MAP_SIZE/250;
        for(let y=0; y<250; y++) {
            for(let x=0; x<250; x++) {
                let mx = Math.floor(x*step), my = Math.floor(y*step);
                let t = mapData[my][mx], c = '#000';
                if(t===TILE.GRASS) c='#2e8b57'; else if(t===TILE.WATER) c='#3498db'; else if(t===TILE.ROAD) c='#8b4513';
                else if(t===TILE.VILLAGE) c='#d3a95d'; else if(t===TILE.BOSS_FLOOR) c='#440000';
                mctx.fillStyle=c; mctx.fillRect(x,y,1,1);
            }
        }
        mctx.fillStyle='white'; mctx.fillRect(player.x/step, player.y/step, 3, 3);
    };

    window.showToast = (msg) => { const t = document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); };
    function showDamage(x, y, dmg, color) {
        const el = document.createElement('div'); el.className='damage-text';
        el.style.left = (x*TILE_SIZE - camera.x + 10)+'px'; el.style.top = (y*TILE_SIZE - camera.y)+'px';
        el.innerText = dmg; el.style.color = color;
        document.getElementById('damage-container').appendChild(el);
        setTimeout(()=>el.remove(), 800);
    }
    
    // updateCamera í•¨ìˆ˜ (ëˆ„ë½ ë³µêµ¬)
    function updateCamera() {
        camera.x = player.x * TILE_SIZE - canvas.width / 2 + (TILE_SIZE / 2);
        camera.y = player.y * TILE_SIZE - canvas.height / 2 + (TILE_SIZE / 2);
    }

    function gameOver() { alert("ì‚¬ë§í–ˆìŠµë‹ˆë‹¤."); player.hp=player.maxHp; player.x=256; player.y=256; }
    window.startGameFlow = () => document.getElementById('start-screen').style.display='none';
    window.saveGame = () => { localStorage.setItem('save_v71', JSON.stringify(player)); showToast("ì €ì¥ë¨"); };
    
    // í‚¤ë³´ë“œ & í„°ì¹˜
    window.addEventListener('keydown', e => {
        if(e.key==='ArrowUp') movePlayer(0,-1); if(e.key==='ArrowDown') movePlayer(0,1);
        if(e.key==='ArrowLeft') movePlayer(-1,0); if(e.key==='ArrowRight') movePlayer(1,0);
        if(e.key==='c'||e.key==='C') toggleMenu(); if(e.key==='m'||e.key==='M') toggleMap();
        if(e.key===' ') {
            let closeIdx = -1, minD = 2;
            enemies.forEach((en, i) => {
                let d = Math.abs(en.x-player.x) + Math.abs(en.y-player.y);
                if(d < minD) { minD = d; closeIdx = i; }
            });
            if(closeIdx !== -1) attack(closeIdx);
        }
    });
    window.startMove = (dx,dy) => { movePlayer(dx,dy); moveTimer = setInterval(()=>movePlayer(dx,dy), 150); };
    window.stopMove = () => clearInterval(moveTimer);

    init();

</script>
</body>
</html>
