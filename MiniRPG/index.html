<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skeleton Knight's Revenge</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            font-family: 'DungGeunMo', monospace, sans-serif;
            touch-action: none; /* ëª¨ë°”ì¼ í„°ì¹˜ í™•ëŒ€ ë°©ì§€ */
        }
        
        /* ì „ì²´ í™”ë©´ ì»¨í…Œì´ë„ˆ */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        canvas {
            image-rendering: pixelated;
            display: block;
        }

        /* UI ê³µí†µ ìŠ¤íƒ€ì¼ */
        .overlay {
            position: absolute;
            pointer-events: none;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
        }

        /* ìƒë‹¨ ìŠ¤íƒ¯ë°” */
        #stat-bar {
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #888;
            font-size: 18px;
            pointer-events: auto; /* ë²„íŠ¼ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
        }

        .btn-group button {
            background: #444;
            color: white;
            border: 1px solid #fff;
            padding: 5px 10px;
            cursor: pointer;
            margin-left: 5px;
            font-family: inherit;
        }
        .btn-group button:hover { background: #666; }

        /* í•˜ë‹¨ ëŒ€í™”ì°½ */
        #dialog-box {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #fff;
            padding: 20px;
            font-size: 18px;
            display: none;
            white-space: pre-line;
            line-height: 1.6;
            z-index: 20;
        }

        /* ì‹œì‘ í™”ë©´ (ë„ì›€ë§) */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }
        #start-screen h1 { color: #e74c3c; font-size: 40px; margin-bottom: 10px; }
        #start-screen .keys { color: #f1c40f; margin: 20px 0; font-size: 20px; }
        #start-btn {
            padding: 15px 40px;
            font-size: 24px;
            background: #e74c3c;
            color: white;
            border: 4px solid #fff;
            cursor: pointer;
            font-family: inherit;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ì¹´ì§€ë…¸ íŒ¨ë„ */
        #casino-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: #2c3e50;
            border: 4px solid gold;
            padding: 20px;
            display: none;
            text-align: center;
            pointer-events: auto;
            z-index: 50;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .casino-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
        }
        .hidden { display: none !important; }

        /* ì•Œë¦¼ ë©”ì‹œì§€ (ì €ì¥ ì™„ë£Œ ë“±) */
        #toast {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 100, 0, 0.9);
            color: white;
            padding: 10px 30px;
            border-radius: 20px;
            display: none;
            z-index: 999;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="start-screen">
            <h1>ğŸ’€ í•´ê³¨ ê¸°ì‚¬ì˜ ë³µìˆ˜</h1>
            <p>ëˆ„ëª…ì„ ì“°ê³  í•´ê³¨ì´ ëœ ê¸°ì‚¬ì˜ ëª¨í—˜</p>
            <div class="keys">
                [ì´ë™] ë°©í–¥í‚¤ (â†‘â†“â†â†’)<br>
                [ì¡°ì‚¬/ëŒ€í™”] ìŠ¤í˜ì´ìŠ¤ë°” (Space)
            </div>
            <button id="start-btn" onclick="startGameFlow()">ê²Œì„ ì‹œì‘</button>
        </div>

        <!-- ìŠ¤íƒ¯ ì°½ & ë©”ë‰´ -->
        <div id="stat-bar" class="overlay">
            <div>
                ğŸ’€ Lv.1 <span style="margin: 0 10px; color:#888;">|</span> 
                ğŸ’° <span id="gold-display" style="color:gold;">0</span>G
            </div>
            <div class="btn-group">
                <button onclick="saveGame()">ğŸ’¾ ì €ì¥</button>
                <button onclick="loadGame()">ğŸ“‚ ë¡œë“œ</button>
            </div>
        </div>

        <!-- ëŒ€í™” ì°½ -->
        <div id="dialog-box" class="overlay"></div>
        
        <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
        <div id="toast">ê²Œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>

        <!-- ì¹´ì§€ë…¸ ë¯¸ë‹ˆê²Œì„ íŒ¨ë„ -->
        <div id="casino-panel">
            <h2 style="color:gold;">ğŸ° ê³ ë¸”ë¦° ì¹´ì§€ë…¸</h2>
            <p style="color:#ccc; font-size:14px;">ë¸”ë™ì­: 21ì— ê°€ê¹Œìš´ ìˆ«ìë¥¼ ë§Œë“œì„¸ìš”.</p>
            <div id="blackjack-game" class="hidden">
                <div style="margin: 20px 0; font-size: 22px;">
                    ë‚˜: <span id="p-score" style="color:#4caf50;">0</span> vs ë”œëŸ¬: <span id="d-score" style="color:#e74c3c;">?</span>
                </div>
                <div id="game-result" style="height:30px; font-weight:bold; color:yellow; margin-bottom:10px;"></div>
                <button class="casino-btn" onclick="hit()">íˆíŠ¸ (ë°›ê¸°)</button>
                <button class="casino-btn" onclick="stand()">ìŠ¤íƒ ë“œ (ë©ˆì¶¤)</button>
                <button class="casino-btn" onclick="exitCasino()" style="background:#555;">ë‚˜ê°€ê¸°</button>
            </div>
            <div id="betting-controls">
                <p>íŒëˆ: 100G</p>
                <button class="casino-btn" onclick="startBlackjack()">ê²Œì„ ì‹œì‘ (-100G)</button>
                <button class="casino-btn" onclick="exitCasino()" style="background:#555;">ë‚˜ê°€ê¸°</button>
            </div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const dialogBox = document.getElementById('dialog-box');
    const goldDisplay = document.getElementById('gold-display');
    const casinoPanel = document.getElementById('casino-panel');
    const bettingControls = document.getElementById('betting-controls');
    const blackjackGame = document.getElementById('blackjack-game');
    const startScreen = document.getElementById('start-screen');
    const toast = document.getElementById('toast');

    // ==========================================
    // 1. ì‹œìŠ¤í…œ ì„¤ì • (ë³€ìˆ˜ ì„ ì–¸ ìˆœì„œ ìˆ˜ì •)
    // ==========================================
    const TILE_SIZE = 40;
    const MAP_SIZE = 512;
    
    // íƒ€ì¼ ë° ìƒíƒœ ìƒìˆ˜ ì •ì˜
    const TILE = { GRASS: 0, WATER: 1, MOUNTAIN: 2, VILLAGE: 3, CASINO: 9 };
    const STATE = { MENU: 'menu', EXPLORE: 'explore', DIALOG: 'dialog', MINIGAME: 'minigame' };
    
    // ì£¼ìš” ë³€ìˆ˜ ì´ˆê¸°í™” (í•¨ìˆ˜ ì‹¤í–‰ ì „ ë¯¸ë¦¬ ì„ ì–¸)
    let currentState = STATE.MENU;
    let camera = { x: 0, y: 0 };
    let mapData = [];

    const player = {
        x: 256, y: 256, // ë§µ ì¤‘ì•™
        gold: 500,
        sprite: 'ğŸ’€'
    };

    // í™”ë©´ í¬ê¸° ì¡°ì • (ë°˜ì‘í˜•) - ë³€ìˆ˜ ì„ ì–¸ í›„ ì •ì˜
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // ì¹´ë©”ë¼ ìœ„ì¹˜ ì¦‰ì‹œ ì¬ê³„ì‚°
        if(typeof updateCamera === 'function') updateCamera();
        if(typeof draw === 'function') draw();
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸° ì‹¤í–‰
    window.addEventListener('resize', resizeCanvas);
    

    // ==========================================
    // 2. ë§µ ìƒì„± (ëœë¤)
    // ==========================================
    function generateMap() {
        // ì „ì²´ í’€ë°­
        for(let y=0; y<MAP_SIZE; y++) {
            const row = new Array(MAP_SIZE).fill(TILE.GRASS);
            mapData.push(row);
        }

        // ì§€í˜• ìƒì„± (ì‚°, ë¬¼)
        for(let i=0; i<800; i++) createBlob(TILE.MOUNTAIN, 10, 30);
        for(let i=0; i<400; i++) createBlob(TILE.WATER, 5, 15);

        // ë§ˆì„ (ì¤‘ì•™ ì•ˆì „ì§€ëŒ€)
        const center = MAP_SIZE / 2;
        for(let y=center-10; y<center+10; y++) {
            for(let x=center-10; x<center+10; x++) {
                mapData[y][x] = TILE.VILLAGE;
            }
        }
        
        // ì¹´ì§€ë…¸ ë°°ì¹˜
        mapData[center-5][center] = TILE.CASINO;
        mapData[center-5][center+1] = TILE.CASINO;
    }

    function createBlob(type, min, max) {
        let cx = Math.floor(Math.random() * MAP_SIZE);
        let cy = Math.floor(Math.random() * MAP_SIZE);
        let size = Math.floor(Math.random() * (max - min) + min);
        for(let y=cy-size; y<cy+size; y++) {
            for(let x=cx-size; x<cx+size; x++) {
                if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE) {
                    if(Math.random() > 0.3) mapData[y][x] = type; 
                }
            }
        }
    }
    
    // ë§µ ìƒì„± ì‹¤í–‰
    generateMap(); 

    // ==========================================
    // 3. ê·¸ë˜í”½ & ì¹´ë©”ë¼
    // ==========================================
    function updateCamera() {
        camera.x = player.x * TILE_SIZE - canvas.width / 2 + (TILE_SIZE / 2);
        camera.y = player.y * TILE_SIZE - canvas.height / 2 + (TILE_SIZE / 2);

        // ë§µ ë²”ìœ„ ì œí•œ
        const maxX = MAP_SIZE * TILE_SIZE - canvas.width;
        const maxY = MAP_SIZE * TILE_SIZE - canvas.height;
        if (camera.x < 0) camera.x = 0;
        if (camera.y < 0) camera.y = 0;
        if (camera.x > maxX) camera.x = maxX;
        if (camera.y > maxY) camera.y = maxY;
    }

    function draw() {
        if (currentState === STATE.MENU) return;

        // ë°°ê²½
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ì»¬ë§(Culling): í™”ë©´ì— ë³´ì´ëŠ” íƒ€ì¼ë§Œ ë Œë”ë§
        const startCol = Math.floor(camera.x / TILE_SIZE);
        const endCol = startCol + (canvas.width / TILE_SIZE) + 1;
        const startRow = Math.floor(camera.y / TILE_SIZE);
        const endRow = startRow + (canvas.height / TILE_SIZE) + 1;

        const offsetX = -camera.x + startCol * TILE_SIZE;
        const offsetY = -camera.y + startRow * TILE_SIZE;

        for (let y = startRow; y <= endRow; y++) {
            for (let x = startCol; x <= endCol; x++) {
                if (y >= 0 && y < MAP_SIZE && x >= 0 && x < MAP_SIZE) {
                    const tile = mapData[y][x];
                    let color = '#2e8b57'; // í’€
                    if (tile === TILE.WATER) color = '#3498db';
                    else if (tile === TILE.MOUNTAIN) color = '#555';
                    else if (tile === TILE.VILLAGE) color = '#d3a95d';
                    else if (tile === TILE.CASINO) color = '#8e44ad';

                    ctx.fillStyle = color;
                    ctx.fillRect(
                        (x - startCol) * TILE_SIZE + offsetX,
                        (y - startRow) * TILE_SIZE + offsetY,
                        TILE_SIZE + 1, TILE_SIZE + 1 // +1ì€ íƒ€ì¼ ì‚¬ì´ í‹ˆ ì œê±°ìš©
                    );

                    if (tile === TILE.CASINO) {
                        ctx.font = '20px Arial';
                        ctx.fillStyle = '#fff';
                        ctx.fillText("ğŸ°", (x - startCol) * TILE_SIZE + offsetX + 8, (y - startRow) * TILE_SIZE + offsetY + 28);
                    }
                }
            }
        }

        // í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
        const px = player.x * TILE_SIZE - camera.x;
        const py = player.y * TILE_SIZE - camera.y;
        
        // ê·¸ë¦¼ì
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.beginPath();
        ctx.ellipse(px + 20, py + 35, 10, 5, 0, 0, Math.PI * 2);
        ctx.fill();

        // ìºë¦­í„°
        ctx.font = '30px Arial';
        ctx.fillText(player.sprite, px + 5, py + 30);
    }

    function updateUI() {
        goldDisplay.innerText = player.gold;
    }

    // ì´ˆê¸° ì‹¤í–‰ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
    resizeCanvas();


    // ==========================================
    // 4. ê²Œì„ ì‹œì‘ ë¡œì§
    // ==========================================
    function startGameFlow() {
        startScreen.style.display = 'none';
        currentState = STATE.EXPLORE;
        updateUI();
        resizeCanvas(); // ì‹œì‘ ì‹œ í™•ì‹¤í•˜ê²Œ ë¦¬ì‚¬ì´ì¦ˆ
        draw();
        
        // ì˜¤í”„ë‹ ë©˜íŠ¸
        setTimeout(() => {
            showDialog("ì°¨ê°€ìš´ ë°”ëŒì´ ë¶„ë‹¤...\në‚˜ëŠ” ë³µìˆ˜ë¥¼ ìœ„í•´ ë‹¤ì‹œ ì¼ì–´ì„°ë‹¤.\n(Tip: ë§ˆì„ ì¤‘ì•™ì˜ ì¹´ì§€ë…¸ì—ì„œ ìê¸ˆì„ ë§ˆë ¨í•˜ì„¸ìš”)");
        }, 500);
    }

    // ==========================================
    // 5. ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸° (Local Storage)
    // ==========================================
    window.saveGame = function() {
        if(currentState !== STATE.EXPLORE) {
            alert("íƒí—˜ ëª¨ë“œì—ì„œë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }
        const saveData = {
            gold: player.gold,
            savedAt: new Date().toLocaleString()
        };
        localStorage.setItem('skeletonRPG_v2', JSON.stringify(saveData));
        
        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        toast.style.display = 'block';
        toast.innerText = `ì €ì¥ ì™„ë£Œ! (${saveData.savedAt})`;
        setTimeout(() => { toast.style.display = 'none'; }, 2000);
    };

    window.loadGame = function() {
        const dataStr = localStorage.getItem('skeletonRPG_v2');
        if(!dataStr) {
            alert("ì €ì¥ëœ ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        const data = JSON.parse(dataStr);
        player.gold = data.gold;
        
        // ë§µì´ ëœë¤ ìƒì„±ë˜ë¯€ë¡œ, ë¡œë“œ ì‹œ ì•ˆì „í•˜ê²Œ ë§ˆì„ ì¤‘ì•™ìœ¼ë¡œ ì†Œí™˜
        player.x = MAP_SIZE / 2;
        player.y = MAP_SIZE / 2;
        
        updateUI();
        updateCamera();
        draw();
        
        alert(`ê²Œì„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\nê³¨ë“œ: ${player.gold}G\n(ì•ˆì „ì„ ìœ„í•´ ë§ˆì„ë¡œ ê·€í™˜í–ˆìŠµë‹ˆë‹¤)`);
    };

    // ==========================================
    // 6. ì…ë ¥ ì²˜ë¦¬
    // ==========================================
    window.addEventListener('keydown', (e) => {
        if (currentState === STATE.MENU) return;
        
        if (currentState === STATE.DIALOG) {
            if (e.key === ' ' || e.key === 'Spacebar' || e.key === 'Enter') closeDialog();
            return;
        }

        if (currentState === STATE.EXPLORE) {
            let dx = 0, dy = 0;
            if (e.key === 'ArrowUp') dy = -1;
            if (e.key === 'ArrowDown') dy = 1;
            if (e.key === 'ArrowLeft') dx = -1;
            if (e.key === 'ArrowRight') dx = 1;

            if (e.key === ' ' || e.key === 'Spacebar') {
                checkInteraction();
                return;
            }

            if (dx !== 0 || dy !== 0) {
                const nx = player.x + dx;
                const ny = player.y + dy;
                if (canMove(nx, ny)) {
                    player.x = nx;
                    player.y = ny;
                    updateCamera();
                    draw();
                }
            }
        }
    });

    function canMove(x, y) {
        if (x < 0 || x >= MAP_SIZE || y < 0 || y >= MAP_SIZE) return false;
        const t = mapData[y][x];
        return t !== TILE.WATER && t !== TILE.MOUNTAIN;
    }

    function checkInteraction() {
        const t = mapData[player.y][player.x];
        if (t === TILE.CASINO) enterCasino();
        else showDialog("ì•„ë¬´ê²ƒë„ ì—†ë‹¤.\n(ì´ë™: ë°©í–¥í‚¤ / ì¡°ì‚¬: ìŠ¤í˜ì´ìŠ¤ë°”)");
    }

    function showDialog(text) {
        currentState = STATE.DIALOG;
        dialogBox.innerText = text;
        dialogBox.style.display = 'block';
    }
    function closeDialog() {
        dialogBox.style.display = 'none';
        currentState = STATE.EXPLORE;
    }

    // ==========================================
    // 7. ë¯¸ë‹ˆê²Œì„ (ë¸”ë™ì­)
    // ==========================================
    let pScore = 0, dScore = 0;

    function enterCasino() {
        currentState = STATE.MINIGAME;
        casinoPanel.style.display = 'block';
        blackjackGame.classList.add('hidden');
        bettingControls.classList.remove('hidden');
    }
    window.exitCasino = function() {
        casinoPanel.style.display = 'none';
        currentState = STATE.EXPLORE;
        draw();
    };
    window.startBlackjack = function() {
        if (player.gold < 100) { alert("ëˆì´ ì—†ìŠµë‹ˆë‹¤! (100G í•„ìš”)"); return; }
        player.gold -= 100;
        updateUI();
        bettingControls.classList.add('hidden');
        blackjackGame.classList.remove('hidden');
        document.getElementById('game-result').innerText = "";
        
        pScore = getRandomCard() + getRandomCard();
        dScore = getRandomCard();
        updateBlackjackUI();
    };
    window.hit = function() {
        pScore += getRandomCard();
        updateBlackjackUI();
        if(pScore > 21) endBlackjack(false, "ë²„ìŠ¤íŠ¸! (21 ì´ˆê³¼)");
    };
    window.stand = function() {
        while(dScore < 17) dScore += getRandomCard();
        updateBlackjackUI();
        if(dScore > 21) endBlackjack(true, "ë”œëŸ¬ ë²„ìŠ¤íŠ¸! ìŠ¹ë¦¬!");
        else if(pScore > dScore) endBlackjack(true, "ìŠ¹ë¦¬!");
        else if(pScore === dScore) { player.gold += 100; endBlackjack(false, "ë¬´ìŠ¹ë¶€ (ê³¨ë“œ ë°˜í™˜)"); }
        else endBlackjack(false, "íŒ¨ë°°...");
    };
    function getRandomCard() { return Math.floor(Math.random() * 10) + 2; }
    function updateBlackjackUI() {
        document.getElementById('p-score').innerText = pScore;
        document.getElementById('d-score').innerText = dScore;
    }
    function endBlackjack(win, msg) {
        document.getElementById('game-result').innerText = msg;
        if(win) { player.gold += 200; updateUI(); }
        setTimeout(() => { 
            alert(msg); 
            enterCasino(); // ì´ˆê¸°í™”ë©´ìœ¼ë¡œ
        }, 500);
    }

    // ì´ˆê¸° í™”ë©´ ê·¸ë¦¬ê¸° (ê²€ì€ í™”ë©´ ë°©ì§€)
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

</script>
</body>
</html>
