<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skeleton Knight's Revenge</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            overflow: hidden;
            font-family: 'DungGeunMo', monospace, sans-serif;
            touch-action: none;
            user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            -webkit-user-select: none;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        canvas {
            image-rendering: pixelated;
            display: block;
        }

        /* UI ê³µí†µ */
        .overlay {
            position: absolute; pointer-events: none; text-shadow: 2px 2px 0 #000; z-index: 10;
        }

        #stat-bar {
            top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px;
            border-radius: 8px; border: 2px solid #888;
            font-size: 18px; pointer-events: auto;
        }
        .btn-group button {
            background: #444; color: white; border: 1px solid #fff;
            padding: 5px 10px; cursor: pointer; margin-left: 5px; font-family: inherit;
        }

        #dialog-box {
            bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 600px;
            background: rgba(0, 0, 0, 0.9); border: 3px solid #fff;
            padding: 20px; font-size: 18px; display: none;
            white-space: pre-line; line-height: 1.6; z-index: 20;
        }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; text-align: center;
        }
        #start-screen h1 { color: #e74c3c; font-size: 40px; margin-bottom: 10px; }
        #start-screen .keys { color: #f1c40f; margin: 20px 0; font-size: 20px; line-height: 1.5; }
        
        #start-btn {
            padding: 15px 40px; font-size: 24px; background: #e74c3c;
            color: white; border: 4px solid #fff; cursor: pointer;
            font-family: inherit; margin-top: 10px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* === ì¹´ì§€ë…¸ íŒ¨ë„ === */
        #casino-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px;
            background: #2c3e50; border: 4px solid gold;
            padding: 20px; display: none; text-align: center;
            pointer-events: auto; z-index: 50;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            max-height: 90vh; overflow-y: auto;
        }
        
        .casino-header { color: gold; margin-bottom: 15px; border-bottom: 2px solid gold; padding-bottom: 10px; }
        .casino-btn {
            background: #e74c3c; color: white; border: none;
            padding: 10px 20px; margin: 5px; cursor: pointer;
            font-size: 16px; border-radius: 4px; font-family: inherit;
        }
        .casino-btn:hover { background: #c0392b; }
        .casino-btn.secondary { background: #555; }
        .casino-btn:disabled { background: #777; cursor: not-allowed; }

        #casino-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #casino-menu button { height: 60px; font-size: 18px; }

        .game-view { display: none; }
        .game-view.active { display: block; }
        
        .result-msg { height: 30px; font-weight: bold; color: yellow; margin: 10px 0; }
        .bet-info { background: rgba(0,0,0,0.3); padding: 10px; margin: 10px 0; border-radius: 5px; }

        /* ë¯¸ë‹ˆê²Œì„ ìº”ë²„ìŠ¤ */
        .minigame-canvas {
            margin: 10px auto;
            background: #004400;
            border: 4px solid #d4af37;
            border-radius: 8px;
            box-shadow: inset 0 0 20px #000;
            display: block;
        }
        #roulette-canvas { border-radius: 50%; background: #222; }
        #slot-canvas { background: #333; }
        #race-canvas { background: #2e7d32; }

        #toast {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 100, 0, 0.9); color: white;
            padding: 10px 30px; border-radius: 20px; display: none; z-index: 999;
        }
        .hidden { display: none !important; }

        /* === ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ëŸ¬ === */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 160px;
            pointer-events: none; /* ë¹ˆ ê³µê°„ í„°ì¹˜ í†µê³¼ */
            display: none; /* PCì—ì„œëŠ” ìˆ¨ê¹€ */
            justify-content: space-between;
            padding: 0 40px;
            box-sizing: border-box;
            z-index: 900;
        }

        /* 768px ì´í•˜ ëª¨ë°”ì¼ì—ì„œë§Œ í‘œì‹œ */
        @media (max-width: 768px) {
            #mobile-controls { display: flex; }
        }

        .dpad-container {
            position: relative;
            width: 140px;
            height: 140px;
            pointer-events: auto;
        }
        
        .dpad-btn {
            position: absolute;
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: rgba(255,255,255,0.8);
            touch-action: none; /* ë¸Œë¼ìš°ì € ê¸°ë³¸ í„°ì¹˜ ë™ì‘ ë°©ì§€ */
        }
        .dpad-btn:active, .dpad-btn.pressed { background: rgba(255, 255, 255, 0.5); }

        #btn-up { top: 0; left: 47.5px; }
        #btn-down { bottom: 0; left: 47.5px; }
        #btn-left { top: 47.5px; left: 0; }
        #btn-right { top: 47.5px; right: 0; }

        .action-container {
            position: relative;
            width: 100px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }
        
        #action-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(231, 76, 60, 0.6);
            border: 4px solid rgba(255, 255, 255, 0.6);
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #action-btn:active { background: rgba(231, 76, 60, 0.9); transform: scale(0.95); }

    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="start-screen">
            <h1>ğŸ’€ í•´ê³¨ ê¸°ì‚¬ì˜ ë³µìˆ˜</h1>
            <p>ëˆ„ëª…ì„ ì“°ê³  í•´ê³¨ì´ ëœ ê¸°ì‚¬ì˜ ëª¨í—˜</p>
            <div class="keys">
                [ì´ë™] ë°©í–¥í‚¤ / [ì¡°ì‚¬] ìŠ¤í˜ì´ìŠ¤ë°”<br>
                (ëª¨ë°”ì¼ì€ í™”ë©´ í„°ì¹˜ ì¡°ì‘)
            </div>
            <button id="start-btn" onclick="startGameFlow()">ê²Œì„ ì‹œì‘</button>
        </div>

        <!-- ìŠ¤íƒ¯ ì°½ -->
        <div id="stat-bar" class="overlay">
            <div>
                ğŸ’€ Lv.1 <span style="margin: 0 10px; color:#888;">|</span> 
                ğŸ’° <span id="gold-display" style="color:gold;">0</span>G
            </div>
            <div class="btn-group">
                <button onclick="saveGame()">ğŸ’¾ ì €ì¥</button>
                <button onclick="loadGame()">ğŸ“‚ ë¡œë“œ</button>
            </div>
        </div>

        <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ -->
        <div id="mobile-controls">
            <div class="dpad-container">
                <div class="dpad-btn" id="btn-up">â–²</div>
                <div class="dpad-btn" id="btn-left">â—€</div>
                <div class="dpad-btn" id="btn-right">â–¶</div>
                <div class="dpad-btn" id="btn-down">â–¼</div>
            </div>
            <div class="action-container">
                <div id="action-btn">A</div>
            </div>
        </div>

        <!-- ëŒ€í™” ì°½ -->
        <div id="dialog-box" class="overlay"></div>
        <div id="toast">ê²Œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>

        <!-- === ì¹´ì§€ë…¸ íŒ¨ë„ === -->
        <div id="casino-panel">
            <h2 class="casino-header">ğŸ° ê³ ë¸”ë¦° ì¹´ì§€ë…¸</h2>
            
            <div id="casino-menu">
                <button class="casino-btn" onclick="showGame('blackjack')">ğŸƒ ë¸”ë™ì­</button>
                <button class="casino-btn" onclick="showGame('roulette')">ğŸ¡ ë£°ë ›</button>
                <button class="casino-btn" onclick="showGame('slots')">ğŸ’ ìŠ¬ë¡¯ë¨¸ì‹ </button>
                <button class="casino-btn" onclick="showGame('racing')">ğŸ ê²½ë§ˆ</button>
                <button class="casino-btn" onclick="showGame('sicbo')">ğŸ² ë‹¤ì´ì‚¬ì´</button>
                <button class="casino-btn secondary" onclick="exitCasino()" style="grid-column: span 2;">ğŸšª ë‚˜ê°€ê¸°</button>
            </div>

            <!-- ë¯¸ë‹ˆê²Œì„ ë·°ë“¤ -->
            <div id="game-blackjack" class="game-view">
                <h3>ë¸”ë™ì­</h3>
                <div class="bet-info">íŒëˆ: 100G (ìŠ¹ë¦¬ ì‹œ 200G)</div>
                <canvas id="bj-canvas" class="minigame-canvas" width="300" height="200"></canvas>
                <div id="bj-result" class="result-msg"></div>
                <div id="bj-actions" class="hidden">
                    <button class="casino-btn" onclick="bjHit()">íˆíŠ¸</button>
                    <button class="casino-btn" onclick="bjStand()">ìŠ¤íƒ ë“œ</button>
                </div>
                <div id="bj-controls">
                    <button class="casino-btn" onclick="startBlackjack()">ê²Œì„ ì‹œì‘ (-100G)</button>
                    <button class="casino-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
                </div>
            </div>

            <div id="game-roulette" class="game-view">
                <h3>ë¦¬ì–¼ ë£°ë ›</h3>
                <div class="bet-info">íŒëˆ: 100G</div>
                <canvas id="roulette-canvas" class="minigame-canvas" width="300" height="300"></canvas>
                <div id="roulette-result" class="result-msg"></div>
                <div id="roulette-btns">
                    <button class="casino-btn" onclick="startRoulette('odd')">í™€ìˆ˜ (x2)</button>
                    <button class="casino-btn" onclick="startRoulette('even')">ì§ìˆ˜ (x2)</button>
                    <button class="casino-btn" onclick="startRoulette('lucky7')">Lucky 7 (x10)</button>
                </div>
                <button class="casino-btn secondary" onclick="backToMenu()" style="margin-top:20px;">ë’¤ë¡œê°€ê¸°</button>
            </div>

            <div id="game-slots" class="game-view">
                <h3>ìŠ¬ë¡¯ë¨¸ì‹ </h3>
                <div class="bet-info">íŒëˆ: 50G</div>
                <canvas id="slot-canvas" class="minigame-canvas" width="300" height="150"></canvas>
                <div id="slot-result" class="result-msg"></div>
                <button class="casino-btn" id="slot-spin-btn" onclick="spinSlots()">ëŒë¦¬ê¸° (-50G)</button>
                <button class="casino-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
            </div>

            <div id="game-racing" class="game-view">
                <h3>í•´ê³¨ ê²½ë§ˆ</h3>
                <div class="bet-info">íŒëˆ: 100G (ìš°ìŠ¹ ì‹œ 400G)</div>
                <canvas id="race-canvas" class="minigame-canvas" width="350" height="200"></canvas>
                <div id="race-result" class="result-msg"></div>
                <div id="race-btns">
                    <button class="casino-btn" onclick="startRace(1)">1ë²ˆë§ˆ</button>
                    <button class="casino-btn" onclick="startRace(2)">2ë²ˆë§ˆ</button>
                    <button class="casino-btn" onclick="startRace(3)">3ë²ˆë§ˆ</button>
                    <button class="casino-btn" onclick="startRace(4)">4ë²ˆë§ˆ</button>
                </div>
                <button class="casino-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
            </div>

            <div id="game-sicbo" class="game-view">
                <h3>ë‹¤ì´ì‚¬ì´</h3>
                <div class="bet-info">íŒëˆ: 200G</div>
                <canvas id="sicbo-canvas" class="minigame-canvas" width="300" height="200"></canvas>
                <div id="sicbo-result" class="result-msg"></div>
                <div id="sicbo-btns">
                    <button class="casino-btn" onclick="playSicBo('small')">ì†Œ (4-10)</button>
                    <button class="casino-btn" onclick="playSicBo('big')">ëŒ€ (11-17)</button>
                </div>
                <button class="casino-btn secondary" onclick="backToMenu()" style="margin-top:20px;">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>
    </div>

<script>
    // --- ê¸°ë³¸ ì„¤ì • ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const dialogBox = document.getElementById('dialog-box');
    const goldDisplay = document.getElementById('gold-display');
    const casinoPanel = document.getElementById('casino-panel');
    const startScreen = document.getElementById('start-screen');
    const toast = document.getElementById('toast');

    const TILE_SIZE = 40;
    const MAP_SIZE = 512;
    const TILE = { GRASS: 0, WATER: 1, MOUNTAIN: 2, VILLAGE: 3, CASINO: 9 };
    const STATE = { MENU: 'menu', EXPLORE: 'explore', DIALOG: 'dialog', MINIGAME: 'minigame' };
    
    let currentState = STATE.MENU;
    let camera = { x: 0, y: 0 };
    let mapData = [];
    const player = { x: 256, y: 256, gold: 1000, sprite: 'ğŸ©»' };

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if(typeof updateCamera === 'function') updateCamera();
        if(typeof draw === 'function') draw();
    }
    window.addEventListener('resize', resizeCanvas);

    // --- ë§µ ìƒì„± ---
    function generateMap() {
        for(let y=0; y<MAP_SIZE; y++) mapData.push(new Array(MAP_SIZE).fill(TILE.GRASS));
        for(let i=0; i<800; i++) createBlob(TILE.MOUNTAIN, 10, 30);
        for(let i=0; i<400; i++) createBlob(TILE.WATER, 5, 15);
        const center = MAP_SIZE / 2;
        for(let y=center-10; y<center+10; y++) {
            for(let x=center-10; x<center+10; x++) mapData[y][x] = TILE.VILLAGE;
        }
        mapData[center-5][center] = TILE.CASINO;
        mapData[center-5][center+1] = TILE.CASINO;
    }
    function createBlob(type, min, max) {
        let cx = Math.floor(Math.random() * MAP_SIZE);
        let cy = Math.floor(Math.random() * MAP_SIZE);
        let size = Math.floor(Math.random() * (max - min) + min);
        for(let y=cy-size; y<cy+size; y++) {
            for(let x=cx-size; x<cx+size; x++) {
                if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE) {
                    if(Math.random() > 0.3) mapData[y][x] = type; 
                }
            }
        }
    }
    generateMap();

    // --- ê²Œì„ ë£¨í”„ ---
    function updateCamera() {
        camera.x = player.x * TILE_SIZE - canvas.width / 2 + (TILE_SIZE / 2);
        camera.y = player.y * TILE_SIZE - canvas.height / 2 + (TILE_SIZE / 2);
        const maxX = MAP_SIZE * TILE_SIZE - canvas.width;
        const maxY = MAP_SIZE * TILE_SIZE - canvas.height;
        if (camera.x < 0) camera.x = 0; if (camera.y < 0) camera.y = 0;
        if (camera.x > maxX) camera.x = maxX; if (camera.y > maxY) camera.y = maxY;
    }

    function draw() {
        if (currentState === STATE.MENU) return;
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);

        const startCol = Math.floor(camera.x / TILE_SIZE);
        const endCol = startCol + (canvas.width / TILE_SIZE) + 1;
        const startRow = Math.floor(camera.y / TILE_SIZE);
        const endRow = startRow + (canvas.height / TILE_SIZE) + 1;
        const offsetX = -camera.x + startCol * TILE_SIZE;
        const offsetY = -camera.y + startRow * TILE_SIZE;

        for (let y = startRow; y <= endRow; y++) {
            for (let x = startCol; x <= endCol; x++) {
                if (y >= 0 && y < MAP_SIZE && x >= 0 && x < MAP_SIZE) {
                    const tile = mapData[y][x];
                    let color = '#2e8b57';
                    if (tile === TILE.WATER) color = '#3498db';
                    else if (tile === TILE.MOUNTAIN) color = '#555';
                    else if (tile === TILE.VILLAGE) color = '#d3a95d';
                    else if (tile === TILE.CASINO) color = '#8e44ad';
                    
                    ctx.fillStyle = color;
                    ctx.fillRect((x - startCol)*TILE_SIZE + offsetX, (y - startRow)*TILE_SIZE + offsetY, TILE_SIZE+1, TILE_SIZE+1);
                    if (tile === TILE.CASINO) {
                        ctx.font = '20px Arial'; ctx.fillStyle = '#fff';
                        ctx.fillText("ğŸ°", (x-startCol)*TILE_SIZE+offsetX+8, (y-startRow)*TILE_SIZE+offsetY+28);
                    }
                }
            }
        }
        const px = player.x * TILE_SIZE - camera.x;
        const py = player.y * TILE_SIZE - camera.y;
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.beginPath(); ctx.ellipse(px + 20, py + 35, 10, 5, 0, 0, Math.PI * 2); ctx.fill();
        ctx.font = '30px Arial'; ctx.fillText(player.sprite, px + 5, py + 30);
    }
    resizeCanvas();

    // --- ì…ë ¥ ì‹œìŠ¤í…œ (í‚¤ë³´ë“œ & í„°ì¹˜ í†µí•©) ---
    function startGameFlow() {
        startScreen.style.display = 'none'; currentState = STATE.EXPLORE;
        updateUI(); resizeCanvas(); draw();
        setTimeout(() => showDialog("ì¹´ì§€ë…¸ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!"), 500);
    }
    function updateUI() { goldDisplay.innerText = player.gold; }

    window.saveGame = function() {
        if(currentState !== STATE.EXPLORE) { alert("íƒí—˜ ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
        localStorage.setItem('skeletonRPG_v7', JSON.stringify({ gold: player.gold }));
        toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 2000);
    };

    window.loadGame = function() {
        const str = localStorage.getItem('skeletonRPG_v7');
        if(!str) { alert("ì €ì¥ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const data = JSON.parse(str);
        player.gold = data.gold; player.x = MAP_SIZE/2; player.y = MAP_SIZE/2;
        updateUI(); updateCamera(); draw();
        alert(`ë¡œë“œ ì™„ë£Œ! ê³¨ë“œ: ${player.gold}`);
    };

    // ê³µí†µ ì´ë™ ì²˜ë¦¬ í•¨ìˆ˜
    function handleInput(dx, dy) {
        if (currentState === STATE.EXPLORE) {
            const nx = player.x + dx;
            const ny = player.y + dy;
            if (canMove(nx, ny)) {
                player.x = nx;
                player.y = ny;
                updateCamera();
                draw();
            }
        }
    }

    // ê³µí†µ ìƒí˜¸ì‘ìš© ì²˜ë¦¬ í•¨ìˆ˜
    function handleAction() {
        if (currentState === STATE.DIALOG) {
            closeDialog();
        } else if (currentState === STATE.EXPLORE) {
            checkInteraction();
        }
    }

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    window.addEventListener('keydown', (e) => {
        if (currentState === STATE.MENU || currentState === STATE.MINIGAME) return;
        
        let dx = 0, dy = 0;
        if (e.key === 'ArrowUp') dy = -1;
        if (e.key === 'ArrowDown') dy = 1;
        if (e.key === 'ArrowLeft') dx = -1;
        if (e.key === 'ArrowRight') dx = 1;

        if (dx !== 0 || dy !== 0) {
            handleInput(dx, dy);
        }

        if (e.key === ' ' || e.key === 'Enter') {
            handleAction();
        }
    });

    // --- ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤ ---
    let moveInterval = null;

    function setupTouchButton(id, dx, dy) {
        const btn = document.getElementById(id);
        
        const startMove = (e) => {
            e.preventDefault(); // ê¸°ë³¸ í„°ì¹˜ ë™ì‘(í™•ëŒ€, ìŠ¤í¬ë¡¤) ë°©ì§€
            btn.classList.add('pressed');
            handleInput(dx, dy); // ì¦‰ì‹œ ì´ë™
            if (moveInterval) clearInterval(moveInterval);
            moveInterval = setInterval(() => handleInput(dx, dy), 150); // ê¾¹ ëˆ„ë¥´ë©´ ì—°ì† ì´ë™
        };

        const endMove = (e) => {
            e.preventDefault();
            btn.classList.remove('pressed');
            if (moveInterval) clearInterval(moveInterval);
            moveInterval = null;
        };

        btn.addEventListener('touchstart', startMove, {passive: false});
        btn.addEventListener('touchend', endMove, {passive: false});
        btn.addEventListener('touchcancel', endMove, {passive: false});
        
        // ë§ˆìš°ìŠ¤ í˜¸í™˜ (í…ŒìŠ¤íŠ¸ìš©)
        btn.addEventListener('mousedown', startMove);
        btn.addEventListener('mouseup', endMove);
        btn.addEventListener('mouseleave', endMove);
    }

    setupTouchButton('btn-up', 0, -1);
    setupTouchButton('btn-down', 0, 1);
    setupTouchButton('btn-left', -1, 0);
    setupTouchButton('btn-right', 1, 0);

    // ì•¡ì…˜ ë²„íŠ¼
    const actionBtn = document.getElementById('action-btn');
    const triggerAction = (e) => {
        e.preventDefault();
        handleAction();
    };
    actionBtn.addEventListener('touchstart', triggerAction, {passive: false});
    actionBtn.addEventListener('click', triggerAction); // í´ë¦­ë„ í—ˆìš©


    function canMove(x, y) {
        if(x<0||x>=MAP_SIZE||y<0||y>=MAP_SIZE) return false;
        const t = mapData[y][x]; return t !== TILE.WATER && t !== TILE.MOUNTAIN;
    }
    function checkInteraction() {
        if (mapData[player.y][player.x] === TILE.CASINO) enterCasino();
        else showDialog("ì•„ë¬´ê²ƒë„ ì—†ë‹¤.");
    }
    function showDialog(t) { currentState = STATE.DIALOG; dialogBox.innerText = t; dialogBox.style.display = 'block'; }
    function closeDialog() { dialogBox.style.display = 'none'; currentState = STATE.EXPLORE; }

    // ==========================================
    // 5. ì¹´ì§€ë…¸ ì‹œìŠ¤í…œ (í†µí•©)
    // ==========================================
    function enterCasino() { 
        currentState = STATE.MINIGAME; 
        casinoPanel.style.display = 'block'; 
        // ì¹´ì§€ë…¸ ì§„ì… ì‹œ ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€
        document.getElementById('mobile-controls').style.display = 'none';
        backToMenu(); 
    }
    window.exitCasino = function() { 
        casinoPanel.style.display = 'none'; 
        currentState = STATE.EXPLORE; 
        // ì¹´ì§€ë…¸ ë‚˜ê°€ë©´ ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ ë‹¤ì‹œ í‘œì‹œ (ëª¨ë°”ì¼ì¼ ê²½ìš° css media queryë¡œ ìë™ ì²˜ë¦¬ë˜ì§€ë§Œ jsë¡œ ê°•ì œ display flex ë“±ì„ ì¤„ìˆ˜ë„ ìˆìŒ, ì—¬ê¸°ì„  cssì— ë§¡ê¹€)
        // ë‹¨, css media queryê°€ ì ìš©ë˜ë¯€ë¡œ style.display='none'ì„ ì§€ì›Œì¤˜ì•¼ í•¨
        document.getElementById('mobile-controls').style.removeProperty('display');
        draw(); 
    };

    window.backToMenu = function() {
        document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active'));
        document.getElementById('casino-menu').style.display = 'grid';
    };
    window.showGame = function(gameId) {
        document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active'));
        document.getElementById('casino-menu').style.display = 'none';
        document.getElementById('game-' + gameId).classList.add('active');
        document.querySelectorAll('.result-msg').forEach(el => el.innerText = '');
        
        if(gameId === 'racing') initRaceCanvas();
        if(gameId === 'roulette') initRoulette();
        if(gameId === 'blackjack') initBlackjack();
        if(gameId === 'slots') initSlots();
        if(gameId === 'sicbo') initSicBo();
    };
    function checkGold(amount) {
        if(player.gold < amount) { alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return false; }
        player.gold -= amount; updateUI(); return true;
    }

    // --- [1] ë¸”ë™ì­ (Canvas) ---
    const bjCanvas = document.getElementById('bj-canvas');
    const bjCtx = bjCanvas.getContext('2d');
    let bjState = { pHand: [], dHand: [], animating: false };

    function initBlackjack() {
        bjState = { pHand: [], dHand: [], animating: false };
        drawBjTable();
        document.getElementById('bj-controls').classList.remove('hidden');
        document.getElementById('bj-actions').classList.add('hidden');
    }

    function drawBjTable() {
        bjCtx.clearRect(0,0,300,200);
        bjCtx.fillStyle = '#aaa'; bjCtx.font = '14px Arial'; bjCtx.textAlign='center';
        bjCtx.fillText("ë”œëŸ¬", 150, 30);
        bjCtx.fillText("í”Œë ˆì´ì–´", 150, 150);
        bjState.dHand.forEach((c, i) => drawCard(150 + (i-bjState.dHand.length/2)*30, 50, c));
        bjState.pHand.forEach((c, i) => drawCard(150 + (i-bjState.pHand.length/2)*30, 110, c));
        if(bjState.pHand.length > 0) {
            bjCtx.fillStyle = '#fff';
            bjCtx.fillText(getScore(bjState.pHand), 150, 185);
            bjCtx.fillText(bjState.dHand.length === 1 ? "?" : getScore(bjState.dHand), 150, 20);
        }
    }

    function drawCard(x, y, val) {
        bjCtx.fillStyle = 'white';
        bjCtx.fillRect(x-15, y-20, 30, 40);
        bjCtx.strokeStyle = '#333';
        bjCtx.strokeRect(x-15, y-20, 30, 40);
        bjCtx.fillStyle = 'black';
        bjCtx.font = 'bold 16px Arial';
        bjCtx.fillText(val === '?' ? '?' : val, x, y+5);
    }

    function dealCardAnim(targetHand, val, cb) {
        let ax = 280, ay = 10;
        let tx = 150 + (targetHand.length * 30 - 30), ty = targetHand === bjState.pHand ? 110 : 50;
        let t = 0;
        function loop() {
            t += 0.1;
            drawBjTable();
            let cx = ax + (tx - ax) * t;
            let cy = ay + (ty - ay) * t;
            drawCard(cx, cy, val);
            if(t < 1) requestAnimationFrame(loop);
            else { targetHand.push(val); drawBjTable(); if(cb) cb(); }
        }
        loop();
    }

    window.startBlackjack = function() {
        if(!checkGold(100)) return;
        document.getElementById('bj-controls').classList.add('hidden');
        bjState.pHand = []; bjState.dHand = [];
        dealCardAnim(bjState.pHand, rCard(), () => {
            dealCardAnim(bjState.dHand, rCard(), () => {
                dealCardAnim(bjState.pHand, rCard(), () => {
                    document.getElementById('bj-actions').classList.remove('hidden');
                });
            });
        });
    };

    window.bjHit = function() {
        document.getElementById('bj-actions').classList.add('hidden');
        dealCardAnim(bjState.pHand, rCard(), () => {
            if(getScore(bjState.pHand) > 21) endBj(false, "ë²„ìŠ¤íŠ¸! (21 ì´ˆê³¼)");
            else document.getElementById('bj-actions').classList.remove('hidden');
        });
    };

    window.bjStand = function() {
        document.getElementById('bj-actions').classList.add('hidden');
        function dlLoop() {
            if(getScore(bjState.dHand) < 17) {
                dealCardAnim(bjState.dHand, rCard(), () => setTimeout(dlLoop, 500));
            } else finishBj();
        }
        dlLoop();
    };

    function rCard() { return Math.floor(Math.random()*10)+2; }
    function getScore(hand) { return hand.reduce((a,b)=>a+(b==='?'?0:b),0); }
    function finishBj() {
        let p = getScore(bjState.pHand), d = getScore(bjState.dHand);
        if(d > 21) endBj(true, "ë”œëŸ¬ ë²„ìŠ¤íŠ¸! ìŠ¹ë¦¬!");
        else if(p > d) endBj(true, "ìŠ¹ë¦¬!");
        else if(p === d) { player.gold += 100; endBj(false, "ë¬´ìŠ¹ë¶€"); }
        else endBj(false, "íŒ¨ë°°");
    }
    function endBj(win, msg) {
        document.getElementById('bj-result').innerText = msg;
        if(win) { player.gold += 200; updateUI(); }
        setTimeout(() => { 
            document.getElementById('bj-controls').classList.remove('hidden');
            document.getElementById('bj-actions').classList.add('hidden');
        }, 2000);
    }


    // --- [2] ë£°ë › (Visual Canvas) ---
    const rCanvas = document.getElementById('roulette-canvas');
    const rCtx = rCanvas.getContext('2d');
    let rSpinning = false;
    
    function initRoulette() {
        drawRouletteWheel(0);
        document.getElementById('roulette-btns').style.display = 'block';
    }

    function drawRouletteWheel(rotation) {
        rCtx.clearRect(0, 0, 300, 300);
        rCtx.save();
        rCtx.translate(150, 150);
        rCtx.rotate(rotation);
        const segments = 12; const arc = Math.PI * 2 / segments;
        for (let i = 0; i < segments; i++) {
            rCtx.beginPath(); rCtx.arc(0, 0, 140, i * arc, (i + 1) * arc); rCtx.lineTo(0, 0);
            rCtx.fillStyle = i % 2 === 0 ? '#e74c3c' : '#2c3e50';
            rCtx.fill(); rCtx.stroke();
            rCtx.save(); rCtx.rotate(i * arc + arc / 2); rCtx.translate(110, 0); rCtx.rotate(Math.PI / 2);
            rCtx.fillStyle = '#fff'; rCtx.font = 'bold 20px Arial'; rCtx.textAlign = 'center'; rCtx.fillText(i + 1, 0, 5);
            rCtx.restore();
        }
        rCtx.restore();
        rCtx.beginPath(); rCtx.moveTo(150, 10); rCtx.lineTo(140, -10); rCtx.lineTo(160, -10); rCtx.fillStyle = 'gold'; rCtx.fill();
    }

    window.startRoulette = function(type) {
        if(rSpinning) return;
        if(!checkGold(100)) return;
        rSpinning = true;
        document.getElementById('roulette-btns').style.display = 'none';
        let speed = 0.5; let deceleration = 0.005; let rotation = Math.random() * 6.28;
        function anim() {
            if (speed > 0) {
                rotation += speed; speed -= deceleration; if(speed < 0) speed = 0;
                drawRouletteWheel(rotation); requestAnimationFrame(anim);
            } else {
                rSpinning = false; calcRoulette(rotation, type);
            }
        }
        anim();
    }

    function calcRoulette(rotation, type) {
        let angle = rotation % (Math.PI * 2);
        let pointerAngle = (Math.PI * 1.5 - angle) % (Math.PI * 2);
        if(pointerAngle < 0) pointerAngle += Math.PI * 2;
        const index = Math.floor(pointerAngle / (Math.PI * 2 / 12));
        const res = index + 1;
        let win = false, multi = 0;
        if(type === 'odd' && res % 2 !== 0) { win = true; multi = 2; }
        else if(type === 'even' && res % 2 === 0) { win = true; multi = 2; }
        else if(type === 'lucky7' && res === 7) { win = true; multi = 10; }
        const msg = document.getElementById('roulette-result');
        if(win) { player.gold += 100 * multi; msg.innerText = `ë‹¹ì²¨! ${res} (+${100*multi}G)`; msg.style.color = 'lime'; }
        else { msg.innerText = `ê½! ${res}`; msg.style.color = 'red'; }
        updateUI(); document.getElementById('roulette-btns').style.display = 'block';
    }

    // --- [3] ìŠ¬ë¡¯ë¨¸ì‹  (Canvas) ---
    const sCanvas = document.getElementById('slot-canvas');
    const sCtx = sCanvas.getContext('2d');
    const syms = ['ğŸ’','ğŸ‹','ğŸ‡','ğŸ’','7ï¸âƒ£'];
    let sReels = [0, 0, 0];

    function initSlots() {
        sReels = [Math.random()*400, Math.random()*400, Math.random()*400];
        drawSlots(sReels);
    }

    function drawSlots(offsets) {
        sCtx.clearRect(0,0,300,150);
        sCtx.fillStyle = '#111'; sCtx.fillRect(10,10,280,130);
        const SYMBOL_H = 80; const CYCLE = 400;
        for(let i=0; i<3; i++) {
            sCtx.save(); sCtx.beginPath(); sCtx.rect(20 + i*90, 20, 80, 110); sCtx.clip();
            let scrollY = offsets[i] % CYCLE;
            for(let j=0; j<10; j++) {
                let symIdx = j % 5; let symbol = syms[symIdx];
                let yPos = (j * SYMBOL_H) + scrollY - 200;
                sCtx.font = '50px Arial'; sCtx.textAlign = 'center'; sCtx.textBaseline = 'middle';
                sCtx.fillText(symbol, 60 + i*90, yPos);
            }
            sCtx.restore();
            sCtx.strokeStyle = 'gold'; sCtx.lineWidth = 3; sCtx.strokeRect(20 + i*90, 20, 80, 110);
            sCtx.fillStyle = 'rgba(255,255,255,0.1)'; sCtx.fillRect(20 + i*90, 20, 80, 55);
        }
        sCtx.strokeStyle = 'rgba(255,0,0,0.7)'; sCtx.lineWidth = 2;
        sCtx.beginPath(); sCtx.moveTo(10, 75); sCtx.lineTo(290, 75); sCtx.stroke();
        sCtx.fillStyle = 'red';
        sCtx.beginPath(); sCtx.moveTo(5, 75); sCtx.lineTo(15, 70); sCtx.lineTo(15, 80); sCtx.fill();
        sCtx.beginPath(); sCtx.moveTo(295, 75); sCtx.lineTo(285, 70); sCtx.lineTo(285, 80); sCtx.fill();
    }

    window.spinSlots = function() {
        if(!checkGold(50)) return;
        document.getElementById('slot-spin-btn').disabled = true;
        document.getElementById('slot-result').innerText = "ëŒì•„ê°€ëŠ” ì¤‘...";
        const SYMBOL_H = 80; const CYCLE = 400;
        let results = [Math.floor(Math.random()*5), Math.floor(Math.random()*5), Math.floor(Math.random()*5)];
        let targetOffsets = [];
        let currentReels = [...sReels];
        for(let i=0; i<3; i++) {
            let targetIdx = results[i];
            let alignVal = (275 - targetIdx * 80) % CYCLE;
            if(alignVal < 0) alignVal += CYCLE;
            let minSpin = (5 + i * 3) * CYCLE;
            let nextTarget = currentReels[i] + minSpin;
            let currentMod = nextTarget % CYCLE;
            let diff = alignVal - currentMod;
            if(diff < 0) diff += CYCLE;
            targetOffsets[i] = nextTarget + diff;
        }
        let startTime = null;
        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            let progress = timestamp - startTime;
            let finishedCount = 0;
            for(let i=0; i<3; i++) {
                let reelDuration = 1000 + (i * 1000);
                if (progress < reelDuration) {
                    let p = progress / reelDuration;
                    let ease = 1 - Math.pow(1 - p, 3);
                    let start = currentReels[i];
                    let end = targetOffsets[i];
                    sReels[i] = start + (end - start) * ease;
                } else {
                    sReels[i] = targetOffsets[i];
                    finishedCount++;
                }
            }
            drawSlots(sReels);
            if(finishedCount < 3) requestAnimationFrame(animate);
            else { checkSlotWin(results); document.getElementById('slot-spin-btn').disabled = false; }
        }
        requestAnimationFrame(animate);
    };

    function checkSlotWin(resultIndices) {
        let r = resultIndices.map(idx => syms[idx]);
        let prize = 0;
        if(r[0]==='7ï¸âƒ£' && r[1]==='7ï¸âƒ£' && r[2]==='7ï¸âƒ£') prize=2500;
        else if(r[0]===r[1] && r[1]===r[2]) prize=500;
        else if(r[0]===r[1] || r[1]===r[2] || r[0]===r[2]) prize=100;
        const msg = document.getElementById('slot-result');
        if(prize>0) { player.gold+=prize; msg.innerText = `ì¶•í•˜í•©ë‹ˆë‹¤! ${r.join('')} (+${prize}G)`; msg.style.color='gold'; }
        else { msg.innerText = `ê½! ${r.join('')}`; msg.style.color='#ccc'; }
        updateUI();
    }


    // --- [4] ê²½ë§ˆ (Canvas) ---
    const rcCanvas = document.getElementById('race-canvas');
    const rcCtx = rcCanvas.getContext('2d');
    
    function initRaceCanvas() {
        rcCtx.clearRect(0,0,350,200);
        rcCtx.fillStyle = '#2e7d32'; rcCtx.fillRect(0,0,350,200);
        rcCtx.strokeStyle = 'white'; rcCtx.setLineDash([5, 5]);
        for(let i=1; i<4; i++) {
            rcCtx.beginPath(); rcCtx.moveTo(0, i*50); rcCtx.lineTo(350, i*50); rcCtx.stroke();
        }
        rcCtx.setLineDash([]); rcCtx.fillStyle = 'red'; rcCtx.fillRect(320, 0, 5, 200);
        for(let i=0; i<4; i++) drawHorse(10, i*50 + 35, i+1);
        document.getElementById('race-btns').style.display = 'block';
    }

    function drawHorse(x, y, num) {
        rcCtx.save(); rcCtx.translate(x, y); rcCtx.scale(-1, 1);
        rcCtx.font = '30px Arial'; rcCtx.fillText("ğŸ", -15, 0); rcCtx.restore();
        rcCtx.fillStyle = 'white'; rcCtx.font = '12px Arial'; rcCtx.fillText(num, x-5, y+5);
    }
    
    function drawDust(x, y) {
        rcCtx.fillStyle = 'rgba(200,200,200,0.5)';
        rcCtx.beginPath(); rcCtx.arc(x-20, y-5, Math.random()*5, 0, 6.28); rcCtx.fill();
    }

    window.startRace = function(pick) {
        if(!checkGold(100)) return;
        document.getElementById('race-btns').style.display = 'none';
        let horses = [{x:10, spd:0}, {x:10, spd:0}, {x:10, spd:0}, {x:10, spd:0}];
        let timer = setInterval(() => {
            rcCtx.fillStyle = '#2e7d32'; rcCtx.fillRect(0,0,350,200);
            rcCtx.strokeStyle = 'white'; rcCtx.setLineDash([5, 5]);
            for(let i=1; i<4; i++) { rcCtx.beginPath(); rcCtx.moveTo(0, i*50); rcCtx.lineTo(350, i*50); rcCtx.stroke(); }
            rcCtx.setLineDash([]); rcCtx.fillStyle = 'red'; rcCtx.fillRect(320, 0, 5, 200);
            
            let winner = null;
            horses.forEach((h, i) => {
                h.spd += (Math.random()-0.4);
                if(h.spd < 1) h.spd = 1;
                h.x += h.spd;
                let hop = Math.sin(Date.now()/50 + i) * 3;
                drawHorse(h.x, i*50 + 35 + hop, i+1);
                if(Math.random()>0.5) drawDust(h.x, i*50 + 40);
                if(h.x >= 320 && !winner) winner = i+1;
            });

            if(winner) {
                clearInterval(timer);
                const msg = document.getElementById('race-result');
                if(winner === pick) { player.gold+=400; msg.innerText="ìš°ìŠ¹! (+400G)"; msg.style.color='lime'; }
                else { msg.innerText=`íŒ¨ë°°.. ${winner}ë²ˆ ìš°ìŠ¹`; msg.style.color='red'; }
                updateUI();
                setTimeout(()=>document.getElementById('race-btns').style.display='block', 2000);
            }
        }, 30);
    };


    // --- [5] ë‹¤ì´ì‚¬ì´ (Canvas) ---
    const scCanvas = document.getElementById('sicbo-canvas');
    const scCtx = scCanvas.getContext('2d');
    
    function initSicBo() {
        scCtx.clearRect(0,0,300,200);
        scCtx.beginPath(); scCtx.arc(150, 100, 80, 0, 6.28);
        scCtx.fillStyle = 'rgba(0,0,0,0.3)'; scCtx.fill();
        scCtx.strokeStyle = '#888'; scCtx.lineWidth=5; scCtx.stroke();
        drawDice(130, 100, 1); drawDice(170, 100, 2); drawDice(150, 80, 3);
        document.getElementById('sicbo-btns').style.display = 'block';
    }

    function drawDice(x, y, num, angle=0) {
        scCtx.save(); scCtx.translate(x, y); scCtx.rotate(angle);
        scCtx.fillStyle = 'white'; scCtx.fillRect(-15,-15,30,30);
        scCtx.strokeRect(-15,-15,30,30);
        scCtx.fillStyle = 'black'; scCtx.font = '20px Arial'; scCtx.textAlign = 'center';
        scCtx.fillText(['âš€','âš','âš‚','âšƒ','âš„','âš…'][num-1], 0, 8);
        scCtx.restore();
    }

    window.playSicBo = function(pick) {
        if(!checkGold(200)) return;
        document.getElementById('sicbo-btns').style.display = 'none';
        let dice = [{x:150,y:100,vx:0,vy:0}, {x:150,y:100,vx:0,vy:0}, {x:150,y:100,vx:0,vy:0}];
        dice.forEach(d => { d.vx = (Math.random()-0.5)*20; d.vy = (Math.random()-0.5)*20; });
        let frames = 0;
        function loop() {
            scCtx.clearRect(0,0,300,200);
            scCtx.beginPath(); scCtx.arc(150, 100, 80, 0, 6.28);
            scCtx.fillStyle = 'rgba(0,0,0,0.3)'; scCtx.fill(); scCtx.stroke();
            dice.forEach(d => {
                d.x += d.vx; d.y += d.vy;
                let dist = Math.sqrt((d.x-150)**2 + (d.y-100)**2);
                if(dist > 70) {
                    d.vx *= -0.8; d.vy *= -0.8;
                    d.x = 150 + (d.x-150)*0.9; d.y = 100 + (d.y-100)*0.9;
                }
                d.vx *= 0.95; d.vy *= 0.95;
                let randomFace = Math.floor(Math.random()*6)+1;
                drawDice(d.x, d.y, randomFace, frames/5);
            });
            frames++;
            if(frames < 60) requestAnimationFrame(loop);
            else {
                let finalVals = [0,0,0].map(() => Math.floor(Math.random()*6)+1);
                scCtx.clearRect(0,0,300,200);
                scCtx.beginPath(); scCtx.arc(150, 100, 80, 0, 6.28);
                scCtx.fillStyle = 'rgba(0,0,0,0.3)'; scCtx.fill(); scCtx.stroke();
                drawDice(120, 100, finalVals[0]); drawDice(180, 100, finalVals[1]); drawDice(150, 70, finalVals[2]);
                checkSicBo(pick, finalVals);
            }
        }
        loop();
    };

    function checkSicBo(pick, vals) {
        let sum = vals.reduce((a,b)=>a+b,0);
        let res = (sum>=4 && sum<=10) ? 'small' : 'big';
        if(vals[0]===vals[1] && vals[1]===vals[2]) res = 'triple';
        const msg = document.getElementById('sicbo-result');
        if(pick===res) { player.gold+=400; msg.innerText="ì ì¤‘! (+400G)"; msg.style.color='lime'; }
        else { msg.innerText="ì‹¤íŒ¨.."; msg.style.color='red'; }
        updateUI(); document.getElementById('sicbo-btns').style.display = 'block';
    }

</script>
</body>
</html>
