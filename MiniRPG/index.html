<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skeleton Knight's Revenge: Final</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            overflow: hidden;
            font-family: 'DungGeunMo', monospace, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        canvas {
            image-rendering: pixelated;
            display: block;
        }

        /* UI ê³µí†µ */
        .overlay { position: absolute; pointer-events: none; text-shadow: 2px 2px 0 #000; z-index: 10; }

        #stat-bar {
            top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px;
            border-radius: 8px; border: 2px solid #888;
            font-size: 16px; pointer-events: auto; flex-wrap: wrap;
        }
        .stat-item { margin-right: 15px; }
        .btn-group button {
            background: #444; color: white; border: 1px solid #fff;
            padding: 5px 10px; cursor: pointer; margin-left: 5px; font-family: inherit;
        }

        #dialog-box {
            bottom: 180px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 600px;
            background: rgba(0, 0, 0, 0.9); border: 3px solid #fff;
            padding: 20px; font-size: 18px; display: none;
            white-space: pre-line; line-height: 1.6; z-index: 20; text-align: center;
        }

        #start-screen, #ending-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; text-align: center;
        }
        #ending-screen { display: none; z-index: 200; }
        
        h1 { color: #e74c3c; font-size: 40px; margin-bottom: 10px; }
        .keys { color: #f1c40f; margin: 20px 0; font-size: 20px; line-height: 1.5; }
        
        .big-btn {
            padding: 15px 40px; font-size: 24px; background: #e74c3c;
            color: white; border: 4px solid #fff; cursor: pointer;
            font-family: inherit; margin-top: 10px; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* === íŒ¨ë„ ê³µí†µ (ì¹´ì§€ë…¸, ìƒì ) === */
        .game-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px;
            background: #2c3e50; border: 4px solid gold;
            padding: 20px; display: none; text-align: center;
            pointer-events: auto; z-index: 50;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            max-height: 90vh; overflow-y: auto;
        }
        
        .panel-header { color: gold; margin-bottom: 15px; border-bottom: 2px solid gold; padding-bottom: 10px; }
        .panel-btn {
            background: #e74c3c; color: white; border: none;
            padding: 10px 20px; margin: 5px; cursor: pointer;
            font-size: 16px; border-radius: 4px; font-family: inherit; width: 100%; margin-bottom: 10px;
        }
        .panel-btn:hover { background: #c0392b; }
        .panel-btn.secondary { background: #555; }
        .panel-btn:disabled { background: #777; cursor: not-allowed; opacity: 0.6; }

        #casino-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #casino-menu button { height: 60px; font-size: 18px; width: auto; margin: 0; }

        .game-view { display: none; }
        .game-view.active { display: block; }
        
        .result-msg { height: 30px; font-weight: bold; color: yellow; margin: 10px 0; }
        .bet-info { background: rgba(0,0,0,0.3); padding: 10px; margin: 10px 0; border-radius: 5px; }

        /* ë¯¸ë‹ˆê²Œì„ ìº”ë²„ìŠ¤ */
        .minigame-canvas {
            margin: 10px auto; background: #004400;
            border: 4px solid #d4af37; border-radius: 8px;
            box-shadow: inset 0 0 20px #000; display: block;
        }
        #roulette-canvas { border-radius: 50%; background: #222; }
        #slot-canvas { background: #333; }
        #race-canvas { background: #2e7d32; }

        /* ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ */
        #mobile-controls {
            position: absolute; bottom: 20px; left: 0; width: 100%; height: 160px;
            pointer-events: none; display: none; justify-content: space-between;
            padding: 0 40px; box-sizing: border-box; z-index: 900;
        }
        @media (max-width: 768px) { #mobile-controls { display: flex; } }

        .dpad-container { position: relative; width: 140px; height: 140px; pointer-events: auto; }
        .dpad-btn {
            position: absolute; width: 45px; height: 45px;
            background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px; display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: rgba(255,255,255,0.8); touch-action: none;
        }
        .dpad-btn:active, .dpad-btn.pressed { background: rgba(255, 255, 255, 0.5); }
        #btn-up { top: 0; left: 47.5px; } #btn-down { bottom: 0; left: 47.5px; }
        #btn-left { top: 47.5px; left: 0; } #btn-right { top: 47.5px; right: 0; }

        .action-container { position: relative; width: 100px; height: 140px; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        #action-btn {
            width: 80px; height: 80px; border-radius: 50%; background: rgba(231, 76, 60, 0.6);
            border: 4px solid rgba(255, 255, 255, 0.6); color: white; font-size: 24px; font-weight: bold;
            display: flex; justify-content: center; align-items: center; touch-action: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #action-btn:active { background: rgba(231, 76, 60, 0.9); transform: scale(0.95); }

        /* ìƒì  ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ */
        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 8px; border-radius: 4px;
        }
        .shop-item span { text-align: left; }
        .buy-btn { background: #27ae60; border: none; padding: 5px 10px; color: white; cursor: pointer; }
        .buy-btn:disabled { background: #555; }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="start-screen">
            <h1>ğŸ’€ í•´ê³¨ ê¸°ì‚¬ì˜ ë³µìˆ˜</h1>
            <p>1. ì¹´ì§€ë…¸ì—ì„œ ëˆì„ ë²„ì„¸ìš”.<br>2. ìƒì ì—ì„œ ì¥ë¹„ë¥¼ ë§ì¶”ì„¸ìš”.<br>3. ë§µ êµ¬ì„ì˜ ë³´ìŠ¤ë¥¼ ì²˜ì¹˜í•˜ì„¸ìš”!</p>
            <div class="keys">
                [ì´ë™] ë°©í–¥í‚¤ / [ê³µê²©/ì¡°ì‚¬] ìŠ¤í˜ì´ìŠ¤ë°”<br>
                (ëª¨ë°”ì¼ì€ í™”ë©´ í„°ì¹˜ ì¡°ì‘)
            </div>
            <button class="big-btn" onclick="startGameFlow()">ê²Œì„ ì‹œì‘</button>
        </div>

        <!-- ì—”ë”© í™”ë©´ -->
        <div id="ending-screen">
            <h1 style="color:gold;">ğŸ‘‘ ë³µìˆ˜ ì„±ê³µ!</h1>
            <p>ë¹„ì—´í•œ ë¯¸ì¹´ì—˜ì„ ì“°ëŸ¬ëœ¨ë¦¬ê³ <br>ë‹¹ì‹ ì€ ëª…ì˜ˆë¥¼ ë˜ì°¾ì•˜ìŠµë‹ˆë‹¤.</p>
            <p>ìµœì¢… ì†Œì§€ê¸ˆ: <span id="final-gold"></span>G</p>
            <button class="big-btn" onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>

        <!-- ìŠ¤íƒ¯ ì°½ -->
        <div id="stat-bar" class="overlay">
            <div style="display:flex;">
                <div class="stat-item">â¤ï¸ HP: <span id="hp-display">100</span></div>
                <div class="stat-item">âš”ï¸ ATK: <span id="atk-display">10</span></div>
                <div class="stat-item">ğŸ’° <span id="gold-display" style="color:gold;">0</span>G</div>
            </div>
            <div class="btn-group">
                <button onclick="saveGame()">ğŸ’¾ ì €ì¥</button>
                <button onclick="loadGame()">ğŸ“‚ ë¡œë“œ</button>
            </div>
        </div>

        <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ -->
        <div id="mobile-controls">
            <div class="dpad-container">
                <div class="dpad-btn" id="btn-up">â–²</div>
                <div class="dpad-btn" id="btn-left">â—€</div>
                <div class="dpad-btn" id="btn-right">â–¶</div>
                <div class="dpad-btn" id="btn-down">â–¼</div>
            </div>
            <div class="action-container">
                <div id="action-btn">A</div>
            </div>
        </div>

        <!-- ëŒ€í™” ì°½ -->
        <div id="dialog-box" class="overlay"></div>

        <!-- === ì¹´ì§€ë…¸ íŒ¨ë„ === -->
        <div id="casino-panel" class="game-panel">
            <h2 class="panel-header">ğŸ° ê³ ë¸”ë¦° ì¹´ì§€ë…¸</h2>
            
            <div id="casino-menu">
                <button class="panel-btn" onclick="showGame('blackjack')">ğŸƒ ë¸”ë™ì­</button>
                <button class="panel-btn" onclick="showGame('roulette')">ğŸ¡ ë£°ë ›</button>
                <button class="panel-btn" onclick="showGame('slots')">ğŸ’ ìŠ¬ë¡¯ë¨¸ì‹ </button>
                <button class="panel-btn" onclick="showGame('racing')">ğŸ ê²½ë§ˆ</button>
                <button class="panel-btn" onclick="showGame('sicbo')">ğŸ² ë‹¤ì´ì‚¬ì´</button>
                <button class="panel-btn secondary" onclick="closePanel()" style="grid-column: span 2;">ğŸšª ë‚˜ê°€ê¸°</button>
            </div>

            <!-- ë¯¸ë‹ˆê²Œì„ë“¤ -->
            <div id="game-blackjack" class="game-view">
                <h3>ë¸”ë™ì­</h3>
                <div class="bet-info">íŒëˆ: 100G (ìŠ¹ë¦¬ 200G)</div>
                <canvas id="bj-canvas" class="minigame-canvas" width="300" height="200"></canvas>
                <div id="bj-result" class="result-msg"></div>
                <div id="bj-actions" class="hidden">
                    <button class="panel-btn" style="width:auto; display:inline-block;" onclick="bjHit()">íˆíŠ¸</button>
                    <button class="panel-btn" style="width:auto; display:inline-block;" onclick="bjStand()">ìŠ¤íƒ ë“œ</button>
                </div>
                <div id="bj-controls">
                    <button class="panel-btn" onclick="startBlackjack()">ê²Œì„ ì‹œì‘ (-100G)</button>
                    <button class="panel-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
                </div>
            </div>

            <div id="game-roulette" class="game-view">
                <h3>ë¦¬ì–¼ ë£°ë ›</h3>
                <div class="bet-info">íŒëˆ: 100G</div>
                <canvas id="roulette-canvas" class="minigame-canvas" width="300" height="300"></canvas>
                <div id="roulette-result" class="result-msg"></div>
                <div id="roulette-btns">
                    <button class="panel-btn" style="width:30%; display:inline-block;" onclick="startRoulette('odd')">í™€ìˆ˜</button>
                    <button class="panel-btn" style="width:30%; display:inline-block;" onclick="startRoulette('even')">ì§ìˆ˜</button>
                    <button class="panel-btn" style="width:30%; display:inline-block;" onclick="startRoulette('lucky7')">7</button>
                </div>
                <button class="panel-btn secondary" onclick="backToMenu()" style="margin-top:10px;">ë’¤ë¡œê°€ê¸°</button>
            </div>

            <div id="game-slots" class="game-view">
                <h3>ìŠ¬ë¡¯ë¨¸ì‹ </h3>
                <div class="bet-info">íŒëˆ: 50G</div>
                <canvas id="slot-canvas" class="minigame-canvas" width="300" height="150"></canvas>
                <div id="slot-result" class="result-msg"></div>
                <button class="panel-btn" id="slot-spin-btn" onclick="spinSlots()">ëŒë¦¬ê¸° (-50G)</button>
                <button class="panel-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
            </div>

            <div id="game-racing" class="game-view">
                <h3>í•´ê³¨ ê²½ë§ˆ</h3>
                <div class="bet-info">íŒëˆ: 100G (ìš°ìŠ¹ 400G)</div>
                <canvas id="race-canvas" class="minigame-canvas" width="350" height="200"></canvas>
                <div id="race-result" class="result-msg"></div>
                <div id="race-btns">
                    <button class="panel-btn" style="width:20%; display:inline-block;" onclick="startRace(1)">1</button>
                    <button class="panel-btn" style="width:20%; display:inline-block;" onclick="startRace(2)">2</button>
                    <button class="panel-btn" style="width:20%; display:inline-block;" onclick="startRace(3)">3</button>
                    <button class="panel-btn" style="width:20%; display:inline-block;" onclick="startRace(4)">4</button>
                </div>
                <button class="panel-btn secondary" onclick="backToMenu()">ë’¤ë¡œê°€ê¸°</button>
            </div>

            <div id="game-sicbo" class="game-view">
                <h3>ë‹¤ì´ì‚¬ì´</h3>
                <div class="bet-info">íŒëˆ: 200G</div>
                <canvas id="sicbo-canvas" class="minigame-canvas" width="300" height="200"></canvas>
                <div id="sicbo-result" class="result-msg"></div>
                <div id="sicbo-btns">
                    <button class="panel-btn" style="width:40%; display:inline-block;" onclick="playSicBo('small')">ì†Œ (Small)</button>
                    <button class="panel-btn" style="width:40%; display:inline-block;" onclick="playSicBo('big')">ëŒ€ (Big)</button>
                </div>
                <button class="panel-btn secondary" onclick="backToMenu()" style="margin-top:10px;">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>

        <!-- === ìƒì  íŒ¨ë„ === -->
        <div id="shop-panel" class="game-panel">
            <h2 class="panel-header">âš’ï¸ ëŒ€ì¥ê°„</h2>
            <div id="shop-items"></div>
            <button class="panel-btn secondary" onclick="closePanel()">ë‚˜ê°€ê¸°</button>
        </div>

    </div>

<script>
    // --- ì‹œìŠ¤í…œ ì„¤ì • ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const dialogBox = document.getElementById('dialog-box');
    const goldDisplay = document.getElementById('gold-display');
    const hpDisplay = document.getElementById('hp-display');
    const atkDisplay = document.getElementById('atk-display');

    const TILE_SIZE = 40;
    const MAP_SIZE = 512;
    const TILE = { GRASS: 0, WATER: 1, MOUNTAIN: 2, VILLAGE: 3, CASINO: 9, SHOP: 8, BOSS_FLOOR: 7, BOSS_WALL: 6 };
    const STATE = { MENU: 'menu', EXPLORE: 'explore', DIALOG: 'dialog', MINIGAME: 'minigame', BATTLE: 'battle' };
    
    let currentState = STATE.MENU;
    let camera = { x: 0, y: 0 };
    let mapData = [];
    let particles = [];
    let enemies = [];
    let boss = null;

    const player = { 
        x: 256, y: 256, gold: 500, hp: 100, maxHp: 100, atk: 10,
        sprite: 'ğŸ©»', hasSword: false, hasArmor: false
    };

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if(typeof updateCamera === 'function') updateCamera();
    }
    window.addEventListener('resize', resizeCanvas);

    // --- ë§µ & ëª¬ìŠ¤í„° ìƒì„± ---
    function generateMap() {
        for(let y=0; y<MAP_SIZE; y++) mapData.push(new Array(MAP_SIZE).fill(TILE.GRASS));
        for(let i=0; i<800; i++) createBlob(TILE.MOUNTAIN, 10, 30);
        for(let i=0; i<400; i++) createBlob(TILE.WATER, 5, 15);
        const center = MAP_SIZE / 2;
        for(let y=center-10; y<center+10; y++) {
            for(let x=center-10; x<center+10; x++) mapData[y][x] = TILE.VILLAGE;
        }
        mapData[center-5][center] = TILE.CASINO;
        mapData[center-5][center+1] = TILE.CASINO;
        mapData[center+5][center] = TILE.SHOP;
        createBossCastle(50, 50);
        for(let i=0; i<200; i++) {
            let ex = Math.floor(Math.random() * MAP_SIZE), ey = Math.floor(Math.random() * MAP_SIZE);
            if (ex > 240 && ex < 270 && ey > 240 && ey < 270) continue;
            if (mapData[ey][ex] === TILE.GRASS) enemies.push({ x: ex, y: ey, hp: 30, atk: 5, sprite: 'ğŸ¦ ', name: 'ìŠ¬ë¼ì„' });
        }
        for(let i=0; i<50; i++) {
            let ex = Math.floor(Math.random() * MAP_SIZE), ey = Math.floor(Math.random() * MAP_SIZE);
            if (mapData[ey][ex] === TILE.GRASS) enemies.push({ x: ex, y: ey, hp: 80, atk: 15, sprite: 'ğŸ‘º', name: 'ê³ ë¸”ë¦°' });
        }
    }

    function createBlob(type, min, max) {
        let cx = Math.floor(Math.random() * MAP_SIZE), cy = Math.floor(Math.random() * MAP_SIZE);
        let size = Math.floor(Math.random() * (max - min) + min);
        for(let y=cy-size; y<cy+size; y++) {
            for(let x=cx-size; x<cx+size; x++) {
                if(x>=0 && x<MAP_SIZE && y>=0 && y<MAP_SIZE) {
                    if(Math.random() > 0.3) mapData[y][x] = type; 
                }
            }
        }
    }

    function createBossCastle(bx, by) {
        for(let y=by-5; y<=by+5; y++) {
            for(let x=bx-5; x<=bx+5; x++) {
                mapData[y][x] = TILE.BOSS_FLOOR;
                if(y===by-5 || y===by+5 || x===bx-5 || x===bx+5) mapData[y][x] = TILE.BOSS_WALL;
            }
        }
        mapData[by+5][bx] = TILE.BOSS_FLOOR;
        boss = { x: bx, y: by, hp: 500, maxHp: 500, atk: 30, sprite: 'ğŸ‘¿', name: 'ë¯¸ì¹´ì—˜' };
    }
    generateMap();

    // --- íŒŒí‹°í´ ì‹œìŠ¤í…œ ---
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.vx = (Math.random() - 0.5) * 10; this.vy = (Math.random() - 0.5) * 10;
            this.life = 1.0;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
        draw(ctx, offsetX, offsetY) {
            ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
            ctx.fillRect(this.x + offsetX, this.y + offsetY, 4, 4); ctx.globalAlpha = 1.0;
        }
    }
    function spawnParticles(x, y, color, count=10) {
        for(let i=0; i<count; i++) particles.push(new Particle(x * TILE_SIZE + 20, y * TILE_SIZE + 20, color));
    }

    // --- ë©”ì¸ ê²Œì„ ë£¨í”„ ---
    function updateCamera() {
        camera.x = player.x * TILE_SIZE - canvas.width / 2 + (TILE_SIZE / 2);
        camera.y = player.y * TILE_SIZE - canvas.height / 2 + (TILE_SIZE / 2);
    }
    function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
    function update() {
        for(let i=particles.length-1; i>=0; i--) {
            particles[i].update(); if(particles[i].life <= 0) particles.splice(i, 1);
        }
    }
    function draw() {
        if (currentState === STATE.MENU) return;
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        const startCol = Math.floor(camera.x / TILE_SIZE);
        const endCol = startCol + (canvas.width / TILE_SIZE) + 1;
        const startRow = Math.floor(camera.y / TILE_SIZE);
        const endRow = startRow + (canvas.height / TILE_SIZE) + 1;
        const offsetX = -camera.x + startCol * TILE_SIZE;
        const offsetY = -camera.y + startRow * TILE_SIZE;

        for (let y = startRow; y <= endRow; y++) {
            for (let x = startCol; x <= endCol; x++) {
                if (y >= 0 && y < MAP_SIZE && x >= 0 && x < MAP_SIZE) {
                    const tile = mapData[y][x];
                    let color = '#2e8b57';
                    if (tile === TILE.WATER) color = '#3498db'; else if (tile === TILE.MOUNTAIN) color = '#555';
                    else if (tile === TILE.VILLAGE) color = '#d3a95d'; else if (tile === TILE.CASINO) color = '#8e44ad';
                    else if (tile === TILE.SHOP) color = '#e67e22'; else if (tile === TILE.BOSS_FLOOR) color = '#440000';
                    else if (tile === TILE.BOSS_WALL) color = '#220000';
                    ctx.fillStyle = color; ctx.fillRect((x - startCol)*TILE_SIZE + offsetX, (y - startRow)*TILE_SIZE + offsetY, TILE_SIZE+1, TILE_SIZE+1);
                    if (tile === TILE.CASINO) { ctx.font = '20px Arial'; ctx.fillStyle = '#fff'; ctx.fillText("ğŸ°", (x-startCol)*TILE_SIZE+offsetX+8, (y-startRow)*TILE_SIZE+offsetY+28); }
                    if (tile === TILE.SHOP) { ctx.font = '20px Arial'; ctx.fillStyle = '#fff'; ctx.fillText("âš’ï¸", (x-startCol)*TILE_SIZE+offsetX+8, (y-startRow)*TILE_SIZE+offsetY+28); }
                }
            }
        }
        enemies.forEach(e => {
            const ex = e.x * TILE_SIZE - camera.x; const ey = e.y * TILE_SIZE - camera.y;
            if(ex > -TILE_SIZE && ex < canvas.width && ey > -TILE_SIZE && ey < canvas.height) {
                ctx.font = '30px Arial'; ctx.fillText(e.sprite, ex + 5, ey + 30);
                ctx.fillStyle = 'red'; ctx.fillRect(ex, ey-5, 40, 4);
                ctx.fillStyle = 'lime'; ctx.fillRect(ex, ey-5, 40 * (e.hp/30), 4);
            }
        });
        if(boss && boss.hp > 0) {
            const bx = boss.x * TILE_SIZE - camera.x; const by = boss.y * TILE_SIZE - camera.y;
            ctx.font = '60px Arial'; ctx.fillText(boss.sprite, bx - 10, by + 40);
            ctx.fillStyle = 'red'; ctx.fillRect(bx-20, by-20, 80, 8);
            ctx.fillStyle = 'lime'; ctx.fillRect(bx-20, by-20, 80 * (boss.hp/boss.maxHp), 8);
        }
        particles.forEach(p => p.draw(ctx, -camera.x, -camera.y));
        const px = player.x * TILE_SIZE - camera.x; const py = player.y * TILE_SIZE - camera.y;
        ctx.font = '30px Arial'; ctx.fillText(player.sprite, px + 5, py + 30);
    }
    resizeCanvas(); gameLoop();

    // --- ì…ë ¥ ë° ë¡œì§ ---
    function startGameFlow() {
        document.getElementById('start-screen').style.display = 'none';
        currentState = STATE.EXPLORE; updateUI();
        showDialog("ì°¨ê°€ìš´ ë°”ëŒì´ ë¶„ë‹¤...\nëˆì„ ëª¨ì•„ ì¥ë¹„ë¥¼ ë§ì¶”ê³ ,\në¶ì„œìª½ ë ì„±ì— ìˆëŠ” ë¯¸ì¹´ì—˜ì„ ì²˜ë‹¨í•˜ì.");
    }
    function updateUI() { 
        goldDisplay.innerText = player.gold; hpDisplay.innerText = player.hp; atkDisplay.innerText = player.atk;
        if(player.hasArmor && player.hasSword) player.sprite = 'ğŸ‘‘ğŸ©»'; else if(player.hasArmor) player.sprite = 'ğŸ›¡ï¸ğŸ©»';
        else if(player.hasSword) player.sprite = 'âš”ï¸ğŸ©»'; else player.sprite = 'ğŸ©»';
    }
    function handleInput(dx, dy) {
        if (currentState !== STATE.EXPLORE) return;
        const nx = player.x + dx, ny = player.y + dy;
        if(boss && boss.hp > 0 && nx === boss.x && ny === boss.y) { attackTarget(boss); return; }
        let hitEnemyIdx = enemies.findIndex(e => e.x === nx && e.y === ny);
        if(hitEnemyIdx !== -1) { attackTarget(enemies[hitEnemyIdx], hitEnemyIdx); return; }
        if (canMove(nx, ny)) { player.x = nx; player.y = ny; updateCamera(); }
    }
    function attackTarget(target, idx) {
        spawnParticles(target.x, target.y, '#ff0000', 5);
        target.hp -= player.atk; showDialog(`[ì „íˆ¬] ${target.name}ì—ê²Œ ${player.atk}ì˜ í”¼í•´!`);
        if(target.hp <= 0) {
            if(target === boss) {
                showDialog(`ë¯¸ì¹´ì—˜ì„ ì“°ëŸ¬ëœ¨ë ¸ë‹¤! ë³µìˆ˜ ì„±ê³µ!`);
                setTimeout(() => { document.getElementById('final-gold').innerText = player.gold; document.getElementById('ending-screen').style.display = 'flex'; }, 2000);
            } else {
                showDialog(`${target.name} ì²˜ì¹˜! (+ê³¨ë“œ)`); enemies.splice(idx, 1); player.gold += 50; spawnParticles(player.x, player.y, 'gold', 10);
            }
        } else {
            player.hp -= target.atk; spawnParticles(player.x, player.y, '#ffffff', 3);
            if(player.hp <= 0) {
                player.hp = 0; alert("ì‚¬ë§í–ˆìŠµë‹ˆë‹¤... ë§ˆì„ì—ì„œ ë¶€í™œí•©ë‹ˆë‹¤.");
                player.hp = player.maxHp; player.x = MAP_SIZE/2; player.y = MAP_SIZE/2; player.gold = Math.floor(player.gold / 2);
            }
        }
        updateUI();
    }
    function checkInteraction() {
        const t = mapData[player.y][player.x];
        if (t === TILE.CASINO) openPanel('casino'); else if (t === TILE.SHOP) openPanel('shop'); else showDialog("ì•„ë¬´ê²ƒë„ ì—†ë‹¤.");
    }
    function canMove(x, y) {
        if(x<0||x>=MAP_SIZE||y<0||y>=MAP_SIZE) return false;
        const t = mapData[y][x]; if (t === TILE.BOSS_WALL) return false;
        return t !== TILE.WATER && t !== TILE.MOUNTAIN;
    }
    function openPanel(type) {
        document.getElementById('mobile-controls').style.display = 'none';
        if(type === 'casino') {
            document.getElementById('casino-panel').style.display = 'block'; currentState = STATE.MINIGAME; backToMenu();
        } else if(type === 'shop') {
            document.getElementById('shop-panel').style.display = 'block'; currentState = STATE.DIALOG; renderShop();
        }
    }
    function closePanel() {
        document.querySelectorAll('.game-panel').forEach(el => el.style.display = 'none');
        currentState = STATE.EXPLORE; document.getElementById('mobile-controls').style.removeProperty('display');
    }

    // --- ìƒì  ì‹œìŠ¤í…œ ---
    const shopItems = [
        { id: 'sword1', name: 'ë…¹ìŠ¨ ê²€ (ê³µê²©ë ¥+10)', cost: 1000, type: 'atk', val: 10 },
        { id: 'sword2', name: 'ê¸°ì‚¬ì˜ ê²€ (ê³µê²©ë ¥+30)', cost: 5000, type: 'atk', val: 30 },
        { id: 'armor1', name: 'ê°€ì£½ ê°‘ì˜· (ì²´ë ¥+50)', cost: 1000, type: 'hp', val: 50 },
        { id: 'armor2', name: 'í™©ê¸ˆ ê°‘ì˜· (ì²´ë ¥+200)', cost: 8000, type: 'hp', val: 200 },
        { id: 'potion', name: 'ì²´ë ¥ íšŒë³µ', cost: 100, type: 'heal', val: 50 }
    ];
    function renderShop() {
        const c = document.getElementById('shop-items'); c.innerHTML = '';
        shopItems.forEach(i => {
            const d = document.createElement('div'); d.className = 'shop-item';
            d.innerHTML = `<span>${i.name}</span><button class="buy-btn" onclick="buyItem('${i.id}')">${i.cost}G</button>`;
            c.appendChild(d);
        });
    }
    window.buyItem = function(id) {
        const i = shopItems.find(x => x.id === id);
        if(player.gold < i.cost) { alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }
        player.gold -= i.cost;
        if(i.type === 'atk') { player.atk += i.val; player.hasSword = true; alert("ê³µê²©ë ¥ ì¦ê°€!"); }
        else if(i.type === 'hp') { player.maxHp += i.val; player.hp += i.val; player.hasArmor = true; alert("ì²´ë ¥ ì¦ê°€!"); }
        else if(i.type === 'heal') { player.hp = Math.min(player.hp + i.val, player.maxHp); alert("ì²´ë ¥ íšŒë³µ."); }
        updateUI(); spawnParticles(canvas.width/2/TILE_SIZE + camera.x/TILE_SIZE, canvas.height/2/TILE_SIZE + camera.y/TILE_SIZE, 'white', 20);
    }

    window.saveGame = function() {
        if(currentState !== STATE.EXPLORE) return;
        localStorage.setItem('skeletonRPG_final', JSON.stringify({ gold: player.gold, hp: player.hp, maxHp: player.maxHp, atk: player.atk, hasSword: player.hasSword, hasArmor: player.hasArmor }));
        alert("ì €ì¥ ì™„ë£Œ!");
    };
    window.loadGame = function() {
        const s = localStorage.getItem('skeletonRPG_final');
        if(!s) return;
        const d = JSON.parse(s);
        player.gold = d.gold; player.hp = d.hp; player.maxHp = d.maxHp; player.atk = d.atk;
        player.hasSword = d.hasSword; player.hasArmor = d.hasArmor;
        player.x = MAP_SIZE/2; player.y = MAP_SIZE/2; updateUI(); updateCamera();
    };
    function showDialog(t) { 
        const d = document.getElementById('dialog-box'); d.innerText = t; d.style.display = 'block'; 
        setTimeout(() => d.style.display='none', 2000);
    }

    // --- ì…ë ¥ ë¦¬ìŠ¤ë„ˆ ---
    window.addEventListener('keydown', (e) => {
        if (currentState === STATE.MENU || currentState === STATE.MINIGAME) return;
        let dx=0, dy=0;
        if (e.key === 'ArrowUp') dy=-1; if (e.key === 'ArrowDown') dy=1;
        if (e.key === 'ArrowLeft') dx=-1; if (e.key === 'ArrowRight') dx=1;
        if (dx||dy) handleInput(dx,dy);
        if (e.key === ' ') checkInteraction();
    });
    let moveInterval = null;
    function setupTouchButton(id, dx, dy) {
        const btn = document.getElementById(id);
        const start = (e) => { e.preventDefault(); btn.classList.add('pressed'); handleInput(dx,dy); moveInterval=setInterval(()=>handleInput(dx,dy),150); };
        const end = (e) => { e.preventDefault(); btn.classList.remove('pressed'); clearInterval(moveInterval); };
        btn.addEventListener('touchstart', start, {passive:false}); btn.addEventListener('touchend', end, {passive:false});
        btn.addEventListener('mousedown', start); btn.addEventListener('mouseup', end);
    }
    setupTouchButton('btn-up',0,-1); setupTouchButton('btn-down',0,1);
    setupTouchButton('btn-left',-1,0); setupTouchButton('btn-right',1,0);
    document.getElementById('action-btn').addEventListener('touchstart', (e)=>{e.preventDefault(); checkInteraction();}, {passive:false});
    document.getElementById('action-btn').addEventListener('click', checkInteraction);

    // ==========================================
    // ì¹´ì§€ë…¸ ë¯¸ë‹ˆê²Œì„ í†µí•© ë¡œì§ (ë³µì›ë¨)
    // ==========================================
    
    // UI ìœ í‹¸
    window.backToMenu = function() {
        document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active'));
        document.getElementById('casino-menu').style.display = 'grid';
    };
    window.showGame = function(gameId) {
        document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active'));
        document.getElementById('casino-menu').style.display = 'none';
        document.getElementById('game-' + gameId).classList.add('active');
        document.querySelectorAll('.result-msg').forEach(el => el.innerText = '');
        
        // ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        if(gameId === 'racing') initRaceCanvas();
        if(gameId === 'roulette') initRoulette();
        if(gameId === 'blackjack') initBlackjack();
        if(gameId === 'slots') initSlots();
        if(gameId === 'sicbo') initSicBo();
    };
    function checkGold(amount) {
        if(player.gold < amount) { alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return false; }
        player.gold -= amount; updateUI(); return true;
    }

    // --- 1. ë¸”ë™ì­ (Canvas) ---
    const bjCanvas = document.getElementById('bj-canvas');
    const bjCtx = bjCanvas.getContext('2d');
    let bjState = { pHand: [], dHand: [] };

    function initBlackjack() {
        bjState = { pHand: [], dHand: [] };
        drawBjTable();
        document.getElementById('bj-controls').classList.remove('hidden');
        document.getElementById('bj-actions').classList.add('hidden');
    }
    function drawBjTable() {
        bjCtx.clearRect(0,0,300,200);
        bjCtx.fillStyle = '#aaa'; bjCtx.font = '14px Arial'; bjCtx.textAlign='center';
        bjCtx.fillText("ë”œëŸ¬", 150, 30); bjCtx.fillText("í”Œë ˆì´ì–´", 150, 150);
        bjState.dHand.forEach((c, i) => drawCard(150 + (i-bjState.dHand.length/2)*30, 50, c));
        bjState.pHand.forEach((c, i) => drawCard(150 + (i-bjState.pHand.length/2)*30, 110, c));
        if(bjState.pHand.length > 0) {
            bjCtx.fillStyle = '#fff';
            bjCtx.fillText(getScore(bjState.pHand), 150, 185);
            bjCtx.fillText(bjState.dHand.length === 1 ? "?" : getScore(bjState.dHand), 150, 20);
        }
    }
    function drawCard(x, y, val) {
        bjCtx.fillStyle = 'white'; bjCtx.fillRect(x-15, y-20, 30, 40);
        bjCtx.strokeStyle = '#333'; bjCtx.strokeRect(x-15, y-20, 30, 40);
        bjCtx.fillStyle = 'black'; bjCtx.font = 'bold 16px Arial'; bjCtx.fillText(val==='?'?'?':val, x, y+5);
    }
    function dealCardAnim(targetHand, val, cb) {
        let ax = 280, ay = 10, tx = 150 + (targetHand.length * 30 - 30), ty = targetHand === bjState.pHand ? 110 : 50;
        let t = 0;
        function loop() {
            t += 0.1; drawBjTable();
            let cx = ax + (tx - ax) * t, cy = ay + (ty - ay) * t;
            drawCard(cx, cy, val);
            if(t < 1) requestAnimationFrame(loop);
            else { targetHand.push(val); drawBjTable(); if(cb) cb(); }
        }
        loop();
    }
    window.startBlackjack = function() {
        if(!checkGold(100)) return;
        document.getElementById('bj-controls').classList.add('hidden');
        bjState.pHand = []; bjState.dHand = [];
        dealCardAnim(bjState.pHand, rCard(), () => {
            dealCardAnim(bjState.dHand, rCard(), () => {
                dealCardAnim(bjState.pHand, rCard(), () => {
                    document.getElementById('bj-actions').classList.remove('hidden');
                });
            });
        });
    };
    window.bjHit = function() {
        document.getElementById('bj-actions').classList.add('hidden');
        dealCardAnim(bjState.pHand, rCard(), () => {
            if(getScore(bjState.pHand) > 21) endBj(false, "ë²„ìŠ¤íŠ¸! (21 ì´ˆê³¼)");
            else document.getElementById('bj-actions').classList.remove('hidden');
        });
    };
    window.bjStand = function() {
        document.getElementById('bj-actions').classList.add('hidden');
        function dlLoop() {
            if(getScore(bjState.dHand) < 17) {
                dealCardAnim(bjState.dHand, rCard(), () => setTimeout(dlLoop, 500));
            } else finishBj();
        }
        dlLoop();
    };
    function rCard() { return Math.floor(Math.random()*10)+2; }
    function getScore(hand) { return hand.reduce((a,b)=>a+(b==='?'?0:b),0); }
    function finishBj() {
        let p = getScore(bjState.pHand), d = getScore(bjState.dHand);
        if(d > 21) endBj(true, "ë”œëŸ¬ ë²„ìŠ¤íŠ¸! ìŠ¹ë¦¬!"); else if(p > d) endBj(true, "ìŠ¹ë¦¬!");
        else if(p === d) { player.gold += 100; endBj(false, "ë¬´ìŠ¹ë¶€"); } else endBj(false, "íŒ¨ë°°");
    }
    function endBj(win, msg) {
        document.getElementById('bj-result').innerText = msg;
        if(win) { player.gold += 200; updateUI(); }
        setTimeout(() => { document.getElementById('bj-controls').classList.remove('hidden'); document.getElementById('bj-actions').classList.add('hidden'); }, 2000);
    }

    // --- 2. ë£°ë › (Canvas) ---
    const rCanvas = document.getElementById('roulette-canvas');
    const rCtx = rCanvas.getContext('2d');
    let rSpinning = false;
    function initRoulette() { drawRouletteWheel(0); document.getElementById('roulette-btns').style.display = 'block'; }
    function drawRouletteWheel(rotation) {
        rCtx.clearRect(0, 0, 300, 300); rCtx.save(); rCtx.translate(150, 150); rCtx.rotate(rotation);
        for (let i = 0; i < 12; i++) {
            rCtx.beginPath(); rCtx.arc(0, 0, 140, i * Math.PI/6, (i + 1) * Math.PI/6); rCtx.lineTo(0, 0);
            rCtx.fillStyle = i % 2 === 0 ? '#e74c3c' : '#2c3e50'; rCtx.fill(); rCtx.stroke();
            rCtx.save(); rCtx.rotate(i * Math.PI/6 + Math.PI/12); rCtx.translate(110, 0); rCtx.rotate(Math.PI / 2);
            rCtx.fillStyle = '#fff'; rCtx.font = 'bold 20px Arial'; rCtx.textAlign = 'center'; rCtx.fillText(i + 1, 0, 5); rCtx.restore();
        }
        rCtx.restore();
        rCtx.beginPath(); rCtx.moveTo(150, 10); rCtx.lineTo(140, -10); rCtx.lineTo(160, -10); rCtx.fillStyle = 'gold'; rCtx.fill();
    }
    window.startRoulette = function(type) {
        if(rSpinning) return; if(!checkGold(100)) return;
        rSpinning = true; document.getElementById('roulette-btns').style.display = 'none';
        let speed = 0.5, decel = 0.005, rot = Math.random() * 6.28;
        function anim() {
            if (speed > 0) { rot += speed; speed -= decel; if(speed < 0) speed = 0; drawRouletteWheel(rot); requestAnimationFrame(anim); }
            else { rSpinning = false; calcRoulette(rot, type); }
        }
        anim();
    }
    function calcRoulette(rot, type) {
        let angle = rot % (Math.PI * 2);
        let pointerAngle = (Math.PI * 1.5 - angle) % (Math.PI * 2);
        if(pointerAngle < 0) pointerAngle += Math.PI * 2;
        const res = Math.floor(pointerAngle / (Math.PI / 6)) + 1;
        let win = false, multi = 0;
        if(type === 'odd' && res % 2 !== 0) { win = true; multi = 2; }
        else if(type === 'even' && res % 2 === 0) { win = true; multi = 2; }
        else if(type === 'lucky7' && res === 7) { win = true; multi = 10; }
        const msg = document.getElementById('roulette-result');
        if(win) { player.gold += 100 * multi; msg.innerText = `ë‹¹ì²¨! ${res} (+${100*multi}G)`; msg.style.color = 'lime'; }
        else { msg.innerText = `ê½! ${res}`; msg.style.color = 'red'; }
        updateUI(); document.getElementById('roulette-btns').style.display = 'block';
    }

    // --- 3. ìŠ¬ë¡¯ë¨¸ì‹  (Canvas) ---
    const sCanvas = document.getElementById('slot-canvas');
    const sCtx = sCanvas.getContext('2d');
    const syms = ['ğŸ’','ğŸ‹','ğŸ‡','ğŸ’','7ï¸âƒ£'];
    let sReels = [0, 0, 0];
    function initSlots() { sReels = [Math.random()*400, Math.random()*400, Math.random()*400]; drawSlots(sReels); }
    function drawSlots(offsets) {
        sCtx.clearRect(0,0,300,150); sCtx.fillStyle = '#111'; sCtx.fillRect(10,10,280,130);
        for(let i=0; i<3; i++) {
            sCtx.save(); sCtx.beginPath(); sCtx.rect(20 + i*90, 20, 80, 110); sCtx.clip();
            let sy = offsets[i] % 400;
            for(let j=0; j<10; j++) {
                let symbol = syms[j % 5]; let yPos = (j * 80) + sy - 200;
                sCtx.font = '50px Arial'; sCtx.textAlign = 'center'; sCtx.textBaseline = 'middle'; sCtx.fillText(symbol, 60 + i*90, yPos);
            }
            sCtx.restore();
            sCtx.strokeStyle = 'gold'; sCtx.lineWidth = 3; sCtx.strokeRect(20 + i*90, 20, 80, 110);
        }
        sCtx.strokeStyle = 'rgba(255,0,0,0.7)'; sCtx.lineWidth = 2;
        sCtx.beginPath(); sCtx.moveTo(10, 75); sCtx.lineTo(290, 75); sCtx.stroke();
    }
    window.spinSlots = function() {
        if(!checkGold(50)) return;
        document.getElementById('slot-spin-btn').disabled = true;
        let results = [Math.floor(Math.random()*5), Math.floor(Math.random()*5), Math.floor(Math.random()*5)];
        let targetOffsets = [], currentReels = [...sReels];
        for(let i=0; i<3; i++) {
            let alignVal = (275 - results[i] * 80) % 400; if(alignVal < 0) alignVal += 400;
            let minSpin = (5 + i * 3) * 400;
            let nextTarget = currentReels[i] + minSpin;
            let diff = alignVal - (nextTarget % 400); if(diff < 0) diff += 400;
            targetOffsets[i] = nextTarget + diff;
        }
        let startTime = null;
        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            let progress = timestamp - startTime, finishedCount = 0;
            for(let i=0; i<3; i++) {
                let duration = 1000 + (i * 1000);
                if (progress < duration) {
                    let p = progress / duration;
                    let ease = 1 - Math.pow(1 - p, 3);
                    sReels[i] = currentReels[i] + (targetOffsets[i] - currentReels[i]) * ease;
                } else { sReels[i] = targetOffsets[i]; finishedCount++; }
            }
            drawSlots(sReels);
            if(finishedCount < 3) requestAnimationFrame(animate);
            else { checkSlotWin(results); document.getElementById('slot-spin-btn').disabled = false; }
        }
        requestAnimationFrame(animate);
    };
    function checkSlotWin(resIdx) {
        let r = resIdx.map(idx => syms[idx]);
        let prize = 0;
        if(r[0]==='7ï¸âƒ£' && r[1]==='7ï¸âƒ£' && r[2]==='7ï¸âƒ£') prize=2500;
        else if(r[0]===r[1] && r[1]===r[2]) prize=500;
        else if(r[0]===r[1] || r[1]===r[2] || r[0]===r[2]) prize=100;
        const msg = document.getElementById('slot-result');
        if(prize>0) { player.gold+=prize; msg.innerText = `ì¶•í•˜! ${r.join('')} (+${prize}G)`; msg.style.color='gold'; }
        else { msg.innerText = `ê½! ${r.join('')}`; msg.style.color='#ccc'; }
        updateUI();
    }

    // --- 4. ê²½ë§ˆ (Canvas) ---
    const rcCanvas = document.getElementById('race-canvas');
    const rcCtx = rcCanvas.getContext('2d');
    function initRaceCanvas() {
        rcCtx.clearRect(0,0,350,200); rcCtx.fillStyle = '#2e7d32'; rcCtx.fillRect(0,0,350,200);
        rcCtx.strokeStyle = 'white'; rcCtx.setLineDash([5, 5]);
        for(let i=1; i<4; i++) { rcCtx.beginPath(); rcCtx.moveTo(0, i*50); rcCtx.lineTo(350, i*50); rcCtx.stroke(); }
        rcCtx.setLineDash([]); rcCtx.fillStyle = 'red'; rcCtx.fillRect(320, 0, 5, 200);
        for(let i=0; i<4; i++) drawHorse(10, i*50 + 35, i+1);
        document.getElementById('race-btns').style.display = 'block';
    }
    function drawHorse(x, y, num) {
        rcCtx.save(); rcCtx.translate(x, y); rcCtx.scale(-1, 1);
        rcCtx.font = '30px Arial'; rcCtx.fillText("ğŸ", -15, 0); rcCtx.restore();
        rcCtx.fillStyle = 'white'; rcCtx.font = '12px Arial'; rcCtx.fillText(num, x-5, y+5);
    }
    window.startRace = function(pick) {
        if(!checkGold(100)) return;
        document.getElementById('race-btns').style.display = 'none';
        let horses = [{x:10, spd:0}, {x:10, spd:0}, {x:10, spd:0}, {x:10, spd:0}];
        let timer = setInterval(() => {
            rcCtx.fillStyle = '#2e7d32'; rcCtx.fillRect(0,0,350,200);
            rcCtx.strokeStyle = 'white'; rcCtx.setLineDash([5, 5]);
            for(let i=1; i<4; i++) { rcCtx.beginPath(); rcCtx.moveTo(0, i*50); rcCtx.lineTo(350, i*50); rcCtx.stroke(); }
            rcCtx.setLineDash([]); rcCtx.fillStyle = 'red'; rcCtx.fillRect(320, 0, 5, 200);
            let winner = null;
            horses.forEach((h, i) => {
                h.spd += (Math.random()-0.4); if(h.spd < 1) h.spd = 1; h.x += h.spd;
                let hop = Math.sin(Date.now()/50 + i) * 3;
                drawHorse(h.x, i*50 + 35 + hop, i+1);
                if(h.x >= 320 && !winner) winner = i+1;
            });
            if(winner) {
                clearInterval(timer);
                const msg = document.getElementById('race-result');
                if(winner === pick) { player.gold+=400; msg.innerText="ìš°ìŠ¹! (+400G)"; msg.style.color='lime'; }
                else { msg.innerText=`íŒ¨ë°°.. ${winner}ë²ˆ ìš°ìŠ¹`; msg.style.color='red'; }
                updateUI(); setTimeout(()=>document.getElementById('race-btns').style.display='block', 2000);
            }
        }, 30);
    };

    // --- 5. ë‹¤ì´ì‚¬ì´ (Canvas) ---
    const scCanvas = document.getElementById('sicbo-canvas');
    const scCtx = scCanvas.getContext('2d');
    function initSicBo() {
        scCtx.clearRect(0,0,300,200); scCtx.beginPath(); scCtx.arc(150, 100, 80, 0, 6.28);
        scCtx.fillStyle = 'rgba(0,0,0,0.3)'; scCtx.fill(); scCtx.strokeStyle = '#888'; scCtx.lineWidth=5; scCtx.stroke();
        drawDice(130, 100, 1); drawDice(170, 100, 2); drawDice(150, 80, 3);
        document.getElementById('sicbo-btns').style.display = 'block';
    }
    function drawDice(x, y, num, angle=0) {
        scCtx.save(); scCtx.translate(x, y); scCtx.rotate(angle);
        scCtx.fillStyle = 'white'; scCtx.fillRect(-15,-15,30,30); scCtx.strokeRect(-15,-15,30,30);
        scCtx.fillStyle = 'black'; scCtx.font = '20px Arial'; scCtx.textAlign = 'center';
        scCtx.fillText(['âš€','âš','âš‚','âšƒ','âš„','âš…'][num-1], 0, 8); scCtx.restore();
    }
    window.playSicBo = function(pick) {
        if(!checkGold(200)) return;
        document.getElementById('sicbo-btns').style.display = 'none';
        let dice = [{x:150,y:100,vx:0,vy:0}, {x:150,y:100,vx:0,vy:0}, {x:150,y:100,vx:0,vy:0}];
        dice.forEach(d => { d.vx = (Math.random()-0.5)*20; d.vy = (Math.random()-0.5)*20; });
        let frames = 0;
        function loop() {
            scCtx.clearRect(0,0,300,200); scCtx.beginPath(); scCtx.arc(150, 100, 80, 0, 6.28);
            scCtx.fillStyle = 'rgba(0,0,0,0.3)'; scCtx.fill(); scCtx.stroke();
            dice.forEach(d => {
                d.x += d.vx; d.y += d.vy;
                if(Math.sqrt((d.x-150)**2 + (d.y-100)**2) > 70) { d.vx *= -0.8; d.vy *= -0.8; d.x = 150 + (d.x-150)*0.9; d.y = 100 + (d.y-100)*0.9; }
                d.vx *= 0.95; d.vy *= 0.95;
                drawDice(d.x, d.y, Math.floor(Math.random()*6)+1, frames/5);
            });
            frames++;
            if(frames < 60) requestAnimationFrame(loop);
            else {
                let finalVals = [0,0,0].map(() => Math.floor(Math.random()*6)+1);
                scCtx.clearRect(0,0,300,200); scCtx.beginPath(); scCtx.arc(150, 100, 80, 0, 6.28);
                scCtx.fillStyle = 'rgba(0,0,0,0.3)'; scCtx.fill(); scCtx.stroke();
                drawDice(120, 100, finalVals[0]); drawDice(180, 100, finalVals[1]); drawDice(150, 70, finalVals[2]);
                checkSicBo(pick, finalVals);
            }
        }
        loop();
    };
    function checkSicBo(pick, vals) {
        let sum = vals.reduce((a,b)=>a+b,0);
        let res = (sum>=4 && sum<=10) ? 'small' : 'big';
        if(vals[0]===vals[1] && vals[1]===vals[2]) res = 'triple';
        const msg = document.getElementById('sicbo-result');
        if(pick===res) { player.gold+=400; msg.innerText="ì ì¤‘! (+400G)"; msg.style.color='lime'; }
        else { msg.innerText="ì‹¤íŒ¨.."; msg.style.color='red'; }
        updateUI(); document.getElementById('sicbo-btns').style.display = 'block';
    }

</script>
</body>
</html>
